unit UFrmBelShop;
  // DtEdt_GeraOCDataDocto.
  // EdtGeraOCBuscaDocto.

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, StrUtils,

  IBCustomDataSet, IBDatabase, IBQuery, IBStoredProc, DB, DBClient, DBXpress,
  Series, TeeProcs, TeEngine, Chart, DbChart, // Graficos
  Math, DateUtils, ShellAPI,

  // FastReport
  fr_DSet, FR_DBSet, FR_Class, FR_E_RTF,  FR_E_CSV,FR_E_TXT,
  FR_E_HTM, FR_E_HTML2, frOLEExl, frexpimg, frRtfExp,

  cxGraphics, cxControls, cxLookAndFeels, cxLookAndFeelPainters, cxContainer,
  cxEdit, dxSkinsCore, dxSkinBlack, dxSkinBlue, dxSkinCaramel, dxSkinCoffee,
  dxSkinDarkRoom, dxSkinDarkSide, dxSkinFoggy, dxSkinGlassOceans,
  dxSkiniMaginary, dxSkinLilian, dxSkinLiquidSky, dxSkinLondonLiquidSky,
  dxSkinMcSkin, dxSkinMoneyTwins, dxSkinOffice2007Black,
  dxSkinOffice2007Blue, dxSkinOffice2007Green, dxSkinOffice2007Pink,
  dxSkinOffice2007Silver, dxSkinOffice2010Black, dxSkinOffice2010Blue,
  dxSkinOffice2010Silver, dxSkinPumpkin, dxSkinSeven, dxSkinSharp,
  dxSkinSilver, dxSkinSpringTime, dxSkinStardust, dxSkinSummer2008,
  dxSkinsDefaultPainters, dxSkinValentine, dxSkinXmas2008Blue,
  dxSkinsdxStatusBarPainter, Menus, dxSkinscxPCPainter, AppEvnts,
  cxLocalization, JvGradientCaption, cxRadioGroup, cxGroupBox, cxPC,
  DBCtrls, StdCtrls, cxSpinEdit, cxButtons, jpeg, ComCtrls, RXCtrls,
  ExtCtrls, dxStatusBar, JvXPCheckCtrls, JvExStdCtrls, JvEdit,
  JvValidateEdit, ToolEdit, JvCheckBox, cxTextEdit, cxMaskEdit,
  cxDropDownEdit, cxCalendar, DBGridJul, JvRadioButton, CurrEdit, Grids,
  DBGrids, Mask, JvExControls, JvXPCore, JvXPButtons, Buttons,
  JvBehaviorLabel, dxGDIPlusClasses, JvGradient, cxProgressBar, Clipbrd;
  // Ultimo: Clipbrd

type
  TFrmBelShop = class(TForm)
    MainMenu1: TMainMenu;
    MenuUsuarios: TMenuItem;
    SubMenuProtUsuariosUsuarios: TMenuItem;
    SubMenuProtUsuariosAlteraoBancodeDadosDML: TMenuItem;
    N9: TMenuItem;
    SubMenuProtUsuariosBackupRestaure: TMenuItem;
    N10: TMenuItem;
    MenuFinanceiro: TMenuItem;
    MenuCalculadora: TMenuItem;
    MenuVersao: TMenuItem;
    MenuSAIR: TMenuItem;
    Image1: TImage;
    MenuCompras: TMenuItem;
    SubMenuComprasCurvaABC: TMenuItem;
    N1: TMenuItem;
    SubMenuComprasOrdensdeCompra: TMenuItem;
    SubMenuProtUsuariosPermissesdeAcesso: TMenuItem;
    PopM_UsuSenha: TPopupMenu;
    Senha1: TMenuItem;
    PC_Principal: TPageControl;
    Ts_ConexaoEmpresas: TTabSheet;
    Ts_Usuario: TTabSheet;
    Ts_UsuarioManut: TTabSheet;
    Ts_OrdemCompra: TTabSheet;
    PopM_Auditoria: TPopupMenu;
    N4: TMenuItem;
    SubMenuComprasContaCorreteForn: TMenuItem;
    SubMenuComprasGeraOC: TMenuItem;
    SubMenuComprasConsultaOC: TMenuItem;
    Ts_ConsultaOC: TTabSheet;
    LB_DML: TLabel;
    N6: TMenuItem;
    SubMenuFinanComprPlanFinanceira: TMenuItem;
    Ts_FinanComprPlanFinan: TTabSheet;
    PopM_FinanPlanFInanceira: TPopupMenu;
    PopM_PlanFinanceiraSalvar: TMenuItem;
    N7: TMenuItem;
    PopM_PlanFinanceiraSintetico: TMenuItem;
    PopM_PlanFinanceiraAnalitico: TMenuItem;
    Ts_CurvaABCEndereco: TTabSheet;
    PC_CurvaABCEnderecamentos: TPageControl;
    Ts_CurvaABCEndMantencao: TTabSheet;
    Ts_CurvaABCEndCurvaABC: TTabSheet;
    N8: TMenuItem;
    SubMenuFinanPlanodeContasComprov200: TMenuItem;
    Ts_FinanPlanoContasCompr200: TTabSheet;
    Mem_Salvar: TMemo;
    Memo2: TMemo;
    Memo3: TMemo;
    N11: TMenuItem;
    SubMenuFinanObjetivos: TMenuItem;
    Ts_FinanObjetivos: TTabSheet;
    PC_FinanObjetivos: TPageControl;
    Ts_FinanObjetivosManut: TTabSheet;
    Ts_FinanObjetivosResultadosDias: TTabSheet;
    N12: TMenuItem;
    SubMenuFinanControleFeriadosAno1: TMenuItem;
    Ts_FinanFeriadosAno: TTabSheet;
    SubMenuComprasEstoqueFisicoFinanceiro: TMenuItem;
    Ts_EstoqueFisicoFinan: TTabSheet;
    PC_EstoqueFisicoFinan: TPageControl;
    Ts_EstFisFinaFiltros: TTabSheet;
    Ts_EstFisFinaResutadoFisicoFinan: TTabSheet;
    Ts_FinanObjetivosGraficos: TTabSheet;
    Panel93: TPanel;
    Bt_FinanObjetivosGraficoSalvar: TJvXPButton;
    Bt_FinanObjetivosGraficoVoltar: TJvXPButton;
    Pan_FinanObjetivosGraficoTpArquivo: TPanel;
    Label118: TLabel;
    Rb_FinanObjetivosGraficoTpBMP: TJvRadioButton;
    Rb_FinanObjetivosGraficoTpWMF: TJvRadioButton;
    Rb_FinanObjetivosGraficoTpClipboard: TJvRadioButton;
    Ts_FinanObjetivosResultadosMeses: TTabSheet;
    Ts_CurvaABCEnderecamentos: TTabSheet;
    EdtVersao: TJvBehaviorLabel;
    Mem_Odir: TMemo;
    Ts_FinanAuditoria: TTabSheet;
    SubMenuFinanAuditoria: TMenuItem;
    Ts_FinanObjetivosResultadosAuditorias: TTabSheet;
    CorCaptionForm: TJvGradientCaption;
    Ts_MovtoComprovForn: TTabSheet;
    SubMenuFinanAuditoriaManutencao: TMenuItem;
    SubMenuFinanAuditoriaAnalise: TMenuItem;
    Ts_EstFisFinaResutadoGiroEstoque: TTabSheet;
    SubMenuComprasMovtoComprovFornecedor: TMenuItem;
    Ts_FinanFechaCaixa: TTabSheet;
    SubMenuFinanFechamentoCaixa: TMenuItem;
    Ts_FinanFechaDiario: TTabSheet;
    N15: TMenuItem;
    SubMenuFinanFechamentoDiarioLojas: TMenuItem;
    SBt_Sair: TSpeedButton;
    N16: TMenuItem;
    SubMenuFinanMargemLucro: TMenuItem;
    Ts_FinanMargemLucro: TTabSheet;
    Panel126: TPanel;
    Gb_FinanMLPeriodo: TGroupBox;
    Pan_FinanMLPeriodo: TPanel;
    Gb_FinanMLLojas: TGroupBox;
    Pan_FinanMLLojas: TPanel;
    TS_Filtros: TTabSheet;
    PC_Filtros: TPageControl;
    TS_FiltroFornecedor: TTabSheet;
    TS_FiltroProdutos: TTabSheet;
    TS_FiltroGrupos: TTabSheet;
    TS_FiltroAplicacao: TTabSheet;
    TS_FiltroFamiliaPreco: TTabSheet;
    TS_FiltroGrupoST: TTabSheet;
    Gb_FiltroFornecedor: TGroupBox;
    Label188: TLabel;
    EdtFiltroCodForn: TCurrencyEdit;
    Bt_FiltroBuscaForn: TJvXPButton;
    Dbg_FiltroFornecedores: TDBGridJul;
    Gb_FiltroProduto: TGroupBox;
    EdtFiltroCodProduto: TCurrencyEdit;
    Bt_FiltroBuscaProdtudo: TJvXPButton;
    Dbg_FiltroProduto: TDBGridJul;
    Gb_FiltroGrupos: TGroupBox;
    EdtFiltroCodGrupo: TCurrencyEdit;
    Bt_FiltroBuscaGrupo: TJvXPButton;
    Gb_FiltroSubGrupos: TGroupBox;
    Panel32: TPanel;
    Dbg_FiltroSubGruposProdutos: TDBGridJul;
    EdtFiltroCodSubGrupo: TCurrencyEdit;
    Bt_FiltroBuscaSubGrupo: TJvXPButton;
    Gb_OCAplicacao: TGroupBox;
    EdtOCCodAplicacao: TCurrencyEdit;
    Bt_OCBuscaAplicacao: TJvXPButton;
    Dbg_OCAplicacao: TDBGridJul;
    Gb_OCFamiliaPrecos: TGroupBox;
    EdtOCCodFamiliaPrecos: TCurrencyEdit;
    Bt_OCBuscaFamiliaPrecos: TJvXPButton;
    Dbg_OCFamiliaPrecos: TDBGridJul;
    Gb_FiltroGruposST: TGroupBox;
    EdtFiltroCodGrupoST: TCurrencyEdit;
    Bt_FiltroBuscaGrupoST: TJvXPButton;
    Dbg_FiltroGrupoST: TDBGridJul;
    Painel_FiltroOC: TPanel;
    Gb_CalculoCurvaABC: TGroupBox;
    Ckb_CalculoCurvaTodas: TJvXPCheckbox;
    Ckb_CalculoCurvaA: TJvXPCheckbox;
    Ckb_CalculoCurvaB: TJvXPCheckbox;
    Ckb_CalculoCurvaC: TJvXPCheckbox;
    Ckb_CalculoCurvaD: TJvXPCheckbox;
    Gb_CalculoTpCurvaABC: TGroupBox;
    Rb_CalculoTpCurvaABCMix: TJvRadioButton;
    Rb_CalculoTpCurvaABCMpms: TJvRadioButton;
    Rb_CalculoTpCurvaABCLoja: TJvRadioButton;
    Gb_CalculoApresCurva: TGroupBox;
    Lb_CalculoApresCurva: TLabel;
    Rb_CalculoApresCurvaEstCom: TJvRadioButton;
    Rb_CalculoApresCurvaEstSem: TJvRadioButton;
    Ckb_CalculoApresCurvaFora: TJvXPCheckbox;
    Rb_CalculoApresCurvaEstAmbos: TJvRadioButton;
    Label_MovtoComprovForn: TLabel;
    TS_FiltroComprovantes: TTabSheet;
    Gb_FiltroComprov: TGroupBox;
    EdtFiltroCodComprov: TCurrencyEdit;
    Bt_FiltroBuscaComprov: TJvXPButton;
    Dbg_FiltroComprov: TDBGridJul;
    Panel81: TPanel;
    Bt_EstFisFinanFechar: TJvXPButton;
    Pan_EstFisFinanGiroTransf: TPanel;
    Label87: TLabel;
    Ckb_EstFisFinanGiroTransf: TJvXPCheckbox;
    Bt_EstFisFinanGiroEstoques: TJvXPButton;
    Pan_EstFisFinanSaldo: TPanel;
    Label86: TLabel;
    Rb_EstFisFinanSqlSaldoTodos: TRadioButton;
    Rb_EstFisFinanSqlSaldoCom: TRadioButton;
    Rb_EstFisFinanSqlSaldoSem: TRadioButton;
    Bt_EstFisFinanBuscaEstoques: TJvXPButton;
    Panel114: TPanel;
    Panel83: TPanel;
    Gb_EstFisFinanListaPreco: TGroupBox;
    EdtEstFisFinanCodListaPreco: TCurrencyEdit;
    EdtEstFisFinanListaPreco: TEdit;
    Bt_EstFisFinanBuscaListaPreco: TJvXPButton;
    Gb_EstFisFinanSituacaoProd: TGroupBox;
    Cbx_EstFisFinanSituacaoProd: TComboBox;
    Gb_EstFisFinanCurvaABC: TGroupBox;
    Ckb_EstFisFinanCurvaTodas: TJvXPCheckbox;
    Ckb_EstFisFinanCurvaA: TJvXPCheckbox;
    Ckb_EstFisFinanCurvaB: TJvXPCheckbox;
    Ckb_EstFisFinanCurvaC: TJvXPCheckbox;
    Ckb_EstFisFinanCurvaD: TJvXPCheckbox;
    Ckb_EstFisFinanCurvaE: TJvXPCheckbox;
    Label3: TLabel;
    Painel_FiltroNaoCompra: TPanel;
    Gb_CalculoUtilizarProdNaoCompra: TGroupBox;
    Label190: TLabel;
    Ckb_FiltroProdNaoCompra: TJvXPCheckbox;
    Label4: TLabel;
    Label5: TLabel;
    Label6: TLabel;
    Label14: TLabel;
    Ts_AudComprasVendas: TTabSheet;
    SubMenuFinanAuditoriaCompVendas: TMenuItem;
    N3: TMenuItem;
    SubMenuFinanBanExtConc: TMenuItem;
    SubMenuFinanBancos: TMenuItem;
    SubMenuFinanConciliaPagtos: TMenuItem;
    SubMenuFinanExtratos: TMenuItem;
    MenuSalao: TMenuItem;
    SubMenuSalaoCadastros: TMenuItem;
    N5: TMenuItem;
    SubMenuPlanilhaPagtos: TMenuItem;
    SubMenuSalaoProfissionais: TMenuItem;
    SubMenuSalaoHabilidadesServicos: TMenuItem;
    SubMenuFaltasReposicoesCDLojas: TMenuItem;
    SubMenuSalaoMetas: TMenuItem;
    MenuSistema: TMenuItem;
    SubMenuParametros: TMenuItem;
    N14: TMenuItem;
    SubMenuEmpConexoesSair: TMenuItem;
    N17: TMenuItem;
    SubMenuEmpresasConexoes: TMenuItem;
    Trad_Localizer: TcxLocalizer;
    SubMenuSalaoMovimentosDebitosRH: TMenuItem;
    OdirPanApres: TPanel;
    N2: TMenuItem;
    SubMenuControledeKitz: TMenuItem;
    SubMenuSolicitacaoCompraLoja: TMenuItem;
    SubMenuParmetrosdeLojas: TMenuItem;
    Pan_ConEmpresasDados: TPanel;
    Label17: TLabel;
    Label21: TLabel;
    Label38: TLabel;
    Label49: TLabel;
    Label50: TLabel;
    Label45: TLabel;
    Label51: TLabel;
    Label52: TLabel;
    Label53: TLabel;
    Label55: TLabel;
    Label56: TLabel;
    Label57: TLabel;
    Label200: TLabel;
    Label193: TLabel;
    Label201: TLabel;
    Dbe_ConEmpresasRazaoSocial: TDBEdit;
    Panel21: TPanel;
    Bt_ConEmpresasDML: TJvXPButton;
    Bt_ConEmpresasVoltar: TJvXPButton;
    Dbcb_ConEmpresasAtivo: TDBComboBox;
    Dbe_ConEmpresasInscrEstadual: TDBEdit;
    Dbe_ConEmpresasComplemento: TDBEdit;
    Dbe_ConEmpresasBairro: TDBEdit;
    Dbe_ConEmpresasNumero: TDBEdit;
    Dbe_ConEmpresasEndereco: TDBEdit;
    Dbe_ConEmpresasUF: TDBEdit;
    EdtConEmpresasEstado: TEdit;
    Bt_ConEmpresasBuscaMunicipio: TJvXPButton;
    Bt_ConEmpresasBuscaEstado: TJvXPButton;
    Dbcb_ConEmpresasTipo: TDBComboBox;
    Me_ConEmpresasCNPJ: TMaskEdit;
    Dbe_ConEmpresasMunicipio: TDBEdit;
    Me_ConEmpresasCEP: TMaskEdit;
    Panel9: TPanel;
    Gb_ConEmpresasUsuInclui: TGroupBox;
    Label12: TLabel;
    Dbe_ConEmpresasDataInclui: TDBEdit;
    EdtConEmpresasUsuInclui: TEdit;
    Gb_ConEmpresasUsuAltera: TGroupBox;
    Label13: TLabel;
    Dbe_ConEmpresasDataAltera: TDBEdit;
    EdtConEmpresasUsuAltera: TEdit;
    Gb_ConEmpresasConexao: TGroupBox;
    Label19: TLabel;
    Label20: TLabel;
    Dbe_ConEmpresasBaseDados: TDBEdit;
    Dbe_ConEmpresasPastaBD: TDBEdit;
    Gb_ConEmpresasEnderecoIP: TGroupBox;
    Dbe_ConEmpresasIP: TDBEdit;
    Gb_ConEmpresasEnderecoIPExterno: TGroupBox;
    Dbe_ConEmpresasIPExterno: TDBEdit;
    Dbe_ConEmpresasCodLP: TDBEdit;
    Dbe_ConEmpresasNumSindicato: TDBEdit;
    Dbe_ConEmpresasNumAlvaraMun: TDBEdit;
    Panel16: TPanel;
    Bt_ConEmpresasFechar: TJvXPButton;
    Bt_ConEmpresasNovo: TJvXPButton;
    Bt_ConEmpresasDetalhar: TJvXPButton;
    Gb_UsuFiltro: TGroupBox;
    Label7: TLabel;
    Label8: TLabel;
    EdtUsuFiltroNome: TEdit;
    EdtUsuFiltroLogin: TEdit;
    Bt_UsuPesq: TJvXPButton;
    Bt_UsuNovaPesq: TJvXPButton;
    GB_UsuLocalizar: TGroupBox;
    Bt_UsuLocaliza: TJvXPButton;
    EdtUsuLocaliza: TEdit;
    Rb_UsuLocalizaNome: TRadioButton;
    Rb_UsuLocalizaLogin: TRadioButton;
    GB_UsuAtivo: TGroupBox;
    Rb_UsuAtivoSim: TRadioButton;
    Rb_UsuAtivoNao: TRadioButton;
    Rb_UsuAtivoAmbos: TRadioButton;
    Panel5: TPanel;
    Bt_UsuFecha: TJvXPButton;
    Bt_UsuNovo: TJvXPButton;
    Bt_UsuDetalhar: TJvXPButton;
    Bt_UsuExcluir: TJvXPButton;
    Panel7: TPanel;
    Bt_UsuManutVoltar: TJvXPButton;
    Bt_UsuManutSalvar: TJvXPButton;
    Mem_Conexoes: TMemo;
    SubMenuSalaoPlanoSaude: TMenuItem;
    Gb_ConsultaOCOrdensCompra: TGroupBox;
    Pan_ConsultaOCInfo: TPanel;
    Label60: TLabel;
    Label65: TLabel;
    Bevel10: TBevel;
    Bevel11: TBevel;
    Bevel12: TBevel;
    DbeConsultaOCItensOCs: TDBEdit;
    DbeConsultaOCQtdOCs: TDBEdit;
    Dbg_ConsultaOCOrdensCompra: TDBGridJul;
    Pan_ConsultaOC: TPanel;
    Gb_ConsultaOCPeriodo: TGroupBox;
    Label46: TLabel;
    Label47: TLabel;
    DtEdt_ConsultaOCDtInicio: TcxDateEdit;
    DtEdt_ConsultaOCDtFim: TcxDateEdit;
    Gb_ConsultaOCFornecedor: TGroupBox;
    Bt_ConsultaOCBuscaFornecedor: TJvXPButton;
    EdtConsultaOCDesFornecedor: TEdit;
    EdtConsultaOCCodFornecedor: TCurrencyEdit;
    Bt_ConsultaOCBuscaOCs: TJvXPButton;
    Gb_ConsultaOCNumOC: TGroupBox;
    EdtConsultaOCNumOC: TCurrencyEdit;
    Gb_ConsultaOCNumDocto: TGroupBox;
    EdtConsultaOCNumDocto: TCurrencyEdit;
    Gb_ConsultaOCEmpresa: TGroupBox;
    Clbx_ConsultaOCEmpresas: TRxCheckListBox;
    Ckb_ConsultaOCSelectEmpresas: TCheckBox;
    Panel44: TPanel;
    Bt_ConsultaOCFechar: TJvXPButton;
    Bt_ConsultaOCImprime: TJvXPButton;
    Pan_ConsultaNFePrincpal: TPanel;
    Bt_ConsultaNFeFechar: TJvXPButton;
    Pan_ConsultaNFe: TPanel;
    Bt_ConsultaNFeBuscaOCs: TJvXPButton;
    Panel105: TPanel;
    Gb_ConsultaNFePeriodo: TGroupBox;
    Label181: TLabel;
    DtEdt_ConsultaNFeDtFim: TcxDateEdit;
    Gb_ConsultaNFeApres: TGroupBox;
    Rb_ConsultaNFeApresAnalitica: TJvRadioButton;
    Rb_ConsultaNFeApresSintetica: TJvRadioButton;
    Gb_ConsultaNFeTpMovto: TGroupBox;
    Rb_ConsultaNFeTpMovtoAmbos: TJvRadioButton;
    Rb_ConsultaNFeTpMovtoEnt: TJvRadioButton;
    Rb_ConsultaNFeTpMovtoSai: TJvRadioButton;
    Gb_ConsultaNFeParticipacao: TGroupBox;
    Ckb_ConsultaNFeParticipacao: TJvXPCheckbox;
    Gb_ConsultaNfeSituacaoProd: TGroupBox;
    Cbx_ConsultaNfeSituacaoProd: TComboBox;
    PC_CurvaABCFornEnd: TPageControl;
    Ts_CurvaABCFiltros: TTabSheet;
    Gb_CurvaABCEndSolicitacao: TGroupBox;
    EdtCurvaABCEndCodLista: TCurrencyEdit;
    EdtCurvaABCEndDesLista: TEdit;
    Bt_CurvaABCEndBuscaLista: TJvXPButton;
    Panel66: TPanel;
    Bt_CurvaABCEndFechar: TJvXPButton;
    Bt_CurvaABCEndCalculoCurvaABC: TJvXPButton;
    Ts_CurvaABCMixProd: TTabSheet;
    N13: TMenuItem;
    PC_FinanMargemLucro: TPageControl;
    Ts_FinanMLFiltros: TTabSheet;
    Panel131: TPanel;
    Label202: TLabel;
    Bt_FinanMLFiltrosFechar: TJvXPButton;
    Bt_FinanMLBuscar: TJvXPButton;
    Rb_MLTpCalculoMarkUp: TcxRadioButton;
    Rb_MLTpCalculoMargem: TcxRadioButton;
    Ts_FinanMLFat: TTabSheet;
    Dbg_FinanMargemLucro: TDBGrid;
    Panel125: TPanel;
    Bt_FinanMLVoltar: TJvXPButton;
    Bt_FinanMLSalvaClipboard: TJvXPButton;
    Bt_FinanMLSalvaCSV: TJvXPButton;
    Bt_FinanMLFormulas: TJvXPButton;
    Bt_FinanMLTamCol: TJvXPButton;
    Ts_FinanMLBonif: TTabSheet;
    Dbg_FinanMargemLucroBonif: TDBGrid;
    Panel128: TPanel;
    Bt_FinanMLBSalvaClipboard: TJvXPButton;
    Bt_FinanMLBSalvaCSV: TJvXPButton;
    Bt_FinanMLBVoltar: TJvXPButton;
    Ts_FinanMLFinal: TTabSheet;
    Dbg_FinanMLResultado: TDBGrid;
    Dbg_FinanMLResFinal: TDBGrid;
    Panel130: TPanel;
    Bt_FinanMLRSalvaClipboard: TJvXPButton;
    Bt_FinanMLRFSalvaCSV: TJvXPButton;
    Bt_FinanMLRFVoltar: TJvXPButton;
    Bt_FinanMLRFSalvaClipboard: TJvXPButton;
    Ts_FinanMLForn: TTabSheet;
    Splitter5: TSplitter;
    Panel1: TPanel;
    Bt_FinanMLFValtar: TJvXPButton;
    Bt_FinanMLFSintetico: TJvXPButton;
    Bt_FinanMLFGraficos: TJvXPButton;
    Bt_FinanMLFSalvaClipboard: TJvXPButton;
    Bt_FinanMLScrollSalvaClipboard: TJvXPButton;
    Bt_FinanMLFSalvaCSV: TJvXPButton;
    Bt_FinanMLFFormulas: TJvXPButton;
    Dbg_FinanMLForn: TDBGrid;
    Pan_FinanMargemLucroFornFat: TPanel;
    Pan_FinanMargemLucroFornBAP: TPanel;
    Dbg_FinanMargemLucroScroll: TDBGrid;
    Pan_FinanFechaDiarioSolic: TPanel;
    Label195: TLabel;
    Label197: TLabel;
    EdtFinanFechaDiarioCodLoja: TCurrencyEdit;
    Bt_FinanFechaDiarioBuscaLoja: TJvXPButton;
    EdtFinanFechaDiarioDesLoja: TEdit;
    DtEdtFinanFechaDiarioData: TcxDateEdit;
    Panel124: TPanel;
    Bt_FinanFechaDiarioFechar: TJvXPButton;
    PC_FinanFechaDiario: TcxPageControl;
    Ts_FinanFechaDiarioLancto: TcxTabSheet;
    Gb_FinanFechaDiarioMovtos: TcxGroupBox;
    Dbg_FinanFechaDiarioMovtos: TDBGrid;
    Gb_FinanFechaDiarioTotais: TcxGroupBox;
    Dbg_FinanFechaDiarioTotais: TDBGrid;
    Pan_FinanFechaDiarioManut: TPanel;
    Gb_FinanFechaDiarioSelecionado: TcxGroupBox;
    Bt_FinanFechaDiarioAlterar: TJvXPButton;
    Bt_FinanFechaDiarioExcluir: TJvXPButton;
    Gb_FinanFechaDiarioVlrRecebido: TcxGroupBox;
    Bt_FinanFechaDiarioVlrRecebido: TJvXPButton;
    Gb_FinanFechaDiarioDeposito: TcxGroupBox;
    Bt_FinanFechaDiarioDeposito: TJvXPButton;
    Gb_FinanFechaDiarioPagto: TcxGroupBox;
    Bt_FinanFechaDiarioPagto: TJvXPButton;
    Gb_FinanFechaDiarioDML: TcxGroupBox;
    Bt_FinanFechaDiarioConfirmar: TJvXPButton;
    Bt_FinanFechaDiarioAbandonar: TJvXPButton;
    Gb_FinanFechaDiarioManut: TcxGroupBox;
    Gb_FinanFechaDiarioTipoMovto: TGroupBox;
    Lb_FinanFechaDiarioTipoMovto: TLabel;
    Gb_FinanFechaDiarioNumDocto: TGroupBox;
    EdtFinanFechaDiarioNumDocto: TCurrencyEdit;
    Gb_FinanFechaDiarioDesDocto: TGroupBox;
    EdtFinanFechaDiarioDesDocto: TEdit;
    Gb_FinanFechaDiarioNumNota: TGroupBox;
    EdtFinanFechaDiarioNumNota: TCurrencyEdit;
    Gb_DtFinanFechaDiarioDtaVenc: TGroupBox;
    DtEdtFinanFechaDiarioDtaVenc: TcxDateEdit;
    Gb_FinanFechaDiarioVlrDocto: TGroupBox;
    EdtFinanFechaDiarioVlrDocto: TCurrencyEdit;
    Gb_FinanFechaDiarioRealizado: TGroupBox;
    Ckb_FinanFechaDiarioRealizado: TJvCheckBox;
    Gb_FinanFechaDiarioVlrRealizado: TGroupBox;
    EdtFinanFechaDiarioVlrRealizado: TCurrencyEdit;
    Pan_FinanFechaCaixaSolic: TPanel;
    Label158: TLabel;
    Label194: TLabel;
    EdtFinanFechaCaixaCodLoja: TCurrencyEdit;
    Bt_FinanFechaCaixaBuscaLoja: TJvXPButton;
    EdtFinanFechaCaixaDesLoja: TEdit;
    DtEdtFinanFechaCaixaData: TcxDateEdit;
    Pan_FinanFechaCaixaSituacao: TPanel;
    Pan_FinanFechaCaixa: TPanel;
    Gb_FinanFechaCaixaLancamentos: TGroupBox;
    Dbg_FinanFechaCaixaDoctos: TDBGrid;
    Dbg_FinanFechaCaixaTotal: TDBGrid;
    StatusBar5: TStatusBar;
    Pan_FinanFechaCaixaTop: TPanel;
    Gb_FinanFechaCaixaDocto: TGroupBox;
    Label196: TLabel;
    Ckb_FinanFechaCaixaSomar: TJvCheckBox;
    EdtFinanFechaCaixaCodDocto: TCurrencyEdit;
    Bt_FinanFechaCaixaBuscaDocto: TJvXPButton;
    EdtFinanFechaCaixaDesDocto: TEdit;
    EdtFinanFechaCaixaVlrDocto: TCurrencyEdit;
    Panel121: TPanel;
    Bt_FinanFechaCaixaFechar: TJvXPButton;
    Bt_FinanFechaCaixaVerifica: TJvXPButton;
    Bt_FinanFechaCaixaSituacao: TJvXPButton;
    Bt_FinanFechaCaixaAnalise: TJvXPButton;
    PC_FinanAuditoria: TPageControl;
    Ts_FinanAuditoriaManut: TTabSheet;
    Pan_FinanAuditoriaManutSolic: TPanel;
    Label136: TLabel;
    Label137: TLabel;
    Label178: TLabel;
    EdtFinanAuditoriaManutCodLoja: TCurrencyEdit;
    Bt_FinanAuditoriaManutBuscaLoja: TJvXPButton;
    EdtFinanAuditoriaManutDesLoja: TEdit;
    DtEdtFinanAuditoriaManutData: TcxDateEdit;
    Bt_FinanAuditoriaManutBuscaAuditoria: TJvXPButton;
    Gb_FinanAuditoriaManut: TGroupBox;
    Gb_FinanAuditoriaManutEstoques: TGroupBox;
    Pan_FinanAuditoriaManutEstoques: TPanel;
    Label140: TLabel;
    Label141: TLabel;
    Label142: TLabel;
    Label143: TLabel;
    Dbe_FinanAuditoriaManutQtdEstInicial: TDBEdit;
    Dbe_FinanAuditoriaManutVlrNegReal: TDBEdit;
    Dbe_FinanAuditoriaManutVlrEstLoja: TDBEdit;
    Dbe_FinanAuditoriaManutVlrEstInicial: TDBEdit;
    Gb_FinanAuditoriaManutContagem: TGroupBox;
    Pan_FinanAuditoriaManutContagem: TPanel;
    Label144: TLabel;
    Label145: TLabel;
    Label146: TLabel;
    Label149: TLabel;
    Label152: TLabel;
    Label153: TLabel;
    Label150: TLabel;
    Label147: TLabel;
    Label148: TLabel;
    Label151: TLabel;
    Label154: TLabel;
    Label160: TLabel;
    Label161: TLabel;
    Label162: TLabel;
    Dbe_FinanAuditoriaManutQtdCodOK: TDBEdit;
    Dbe_FinanAuditoriaManutQtdCodContados: TDBEdit;
    Dbe_FinanAuditoriaManutQtdCodEntradas: TDBEdit;
    Dbe_FinanAuditoriaManutQtdCodSaidas: TDBEdit;
    Dbe_FinanAuditoriaManutQtdCodNaoContados: TDBEdit;
    Dbe_FinanAuditoriaManutVlrCodEntradas: TDBEdit;
    Dbe_FinanAuditoriaManutVlrCodSaidas: TDBEdit;
    Dbe_FinanAuditoriaManutVlrCodNaoContados: TDBEdit;
    Dbe_FinanAuditoriaManutPerCodNaoContados: TDBEdit;
    Dbe_FinanAuditoriaManutPerCodSaidas: TDBEdit;
    Dbe_FinanAuditoriaManutPerCodEntradas: TDBEdit;
    Gb_FinanAuditoriaManutResultados: TGroupBox;
    Gb_FinanAuditoriaManutResulProd: TGroupBox;
    Label163: TLabel;
    Label164: TLabel;
    Label165: TLabel;
    Label166: TLabel;
    Label167: TLabel;
    Label168: TLabel;
    Label171: TLabel;
    Label172: TLabel;
    Label170: TLabel;
    Label175: TLabel;
    Label177: TLabel;
    Label169: TLabel;
    Label180: TLabel;
    Dbe_FinanAuditoriaManutQtdProdNaoEncont: TDBEdit;
    Dbe_FinanAuditoriaManutQtdProdFechada: TDBEdit;
    Dbe_FinanAuditoriaManutQtdProdNaoFechada: TDBEdit;
    Dbe_FinanAuditoriaManutPerProdNaoFechados: TDBEdit;
    Dbe_FinanAuditoriaManutPerProdFechados: TDBEdit;
    Dbe_FinanAuditoriaManutPerProdNaoEncont: TDBEdit;
    Dbe_FinanAuditoriaManutPerProdFechadosEncont: TDBEdit;
    Dbe_FinanAuditoriaManutPerProdNaoFechadosEncont: TDBEdit;
    Dbe_FinanAuditoriaManutQtdCodContadosRes: TDBEdit;
    Dbe_FinanAuditoriaManutQtdProdNaoResolvidos: TDBEdit;
    Dbe_FinanAuditoriaManutPerProdNaoResolvidos: TDBEdit;
    Edt_FinanAuditoriaManutQtdCodGeral: TCurrencyEdit;
    Dbe_FinanAuditoriaManutPerProdNaoResolvidosEncont: TDBEdit;
    Gb_FinanAuditoriaManutResulFinan: TGroupBox;
    Lb_PerdaSomaFinal: TLabel;
    Label156: TLabel;
    Label138: TLabel;
    Label157: TLabel;
    Label139: TLabel;
    Label159: TLabel;
    Label173: TLabel;
    Label174: TLabel;
    Label179: TLabel;
    Label176: TLabel;
    Dbe_FinanAuditoriaManutPerAdmissivel: TDBEdit;
    Dbe_FinanAuditoriaManutVlrAdmissEquivalente: TDBEdit;
    Dbe_FinanAuditoriaManutPerPerdaFinal: TDBEdit;
    Dbe_FinanAuditoriaManutVlrPerdaEquivalente: TDBEdit;
    Dbe_FinanAuditoriaManutPerObjPerAdmiss: TDBEdit;
    Dbe_FinanAuditoriaManutPerObjVlrAdmiss: TDBEdit;
    Pan_FinanAuditoriaManutEstFinal: TPanel;
    Label155: TLabel;
    Dbe_FinanAuditoriaManutVlrEstFinal: TDBEdit;
    Panel99: TPanel;
    Bt_FinanAuditoriaManutSalvar: TJvXPButton;
    Bt_FinanAuditoriaManutAbandonar: TJvXPButton;
    DBNav_FInainAuditoriaManut: TDBNavigator;
    Panel100: TPanel;
    Bt_FinanAuditoriaManutExcluir: TJvXPButton;
    Panel98: TPanel;
    Bt_FinanAuditoriaManutFechar: TJvXPButton;
    Ts_FinanAuditoriaAnalises: TTabSheet;
    Pan_FinanAuditoriaAnalisesSolic: TPanel;
    Label182: TLabel;
    Label184: TLabel;
    EdtFinanAuditoriaAnaliseCodLoja: TCurrencyEdit;
    Bt_FinanAuditoriaAnaliseBuscaLoja: TJvXPButton;
    EdtFinanAuditoriaAnaliseDesLoja: TEdit;
    Bt_FinanAuditoriaAnaliseBuscaAuditoria: TJvXPButton;
    Gb_FinanAuditoriaAnalises: TGroupBox;
    Dbg_FinanAuditoriaAnalise: TDBGrid;
    Panel107: TPanel;
    Bt_FinanAuditoriaAnaliseFechar: TJvXPButton;
    Bt_FinanAuditoriaAnaliseSalvar: TJvXPButton;
    Bt_FinanAuditoriaAnaliseExcluir: TJvXPButton;
    Pan_FinanFeriadosAnoInformacoes: TPanel;
    Gb_FinanFeriadosAnoInfFeriado: TGroupBox;
    Label111: TLabel;
    Label112: TLabel;
    EdtFinanFeriadosAnoDiaFeriado: TCurrencyEdit;
    EdtFinanFeriadosAnoDesFeriado: TEdit;
    Bt_FinanFeriadosAnoSalvar: TJvXPButton;
    Bt_FinanFeriadosAnoAbandonar: TJvXPButton;
    Gb_FinanFeriadosAnoMesAno: TGroupBox;
    Label110: TLabel;
    EdtFinanFeriadosAnoAno: TCurrencyEdit;
    Cbx_FinanFeriadosAnoMes: TComboBox;
    Gb_FinanFeriadosAnoDatasFeriado: TGroupBox;
    Dbg_FinanFeriadosAnoDatasFeriado: TDBGrid;
    StatusBar1: TStatusBar;
    Panel75: TPanel;
    Bt_FinanFeriadosAnoFechar: TJvXPButton;
    Dbg_EstFisFinanEmpresa: TDBGrid;
    Dbg_EstFisFinanLojas: TDBGrid;
    Pan_EstFisFinaResutadoGiroFisicoFinan: TPanel;
    Label84: TLabel;
    Bt_EstFisFinanSalvarEmpresa: TJvXPButton;
    Bt_EstFisFinanVoltar: TJvXPButton;
    Bt_EstFisFinanSalvarLojas: TJvXPButton;
    Rb_EstFisFinanSaldoTodos: TRadioButton;
    Rb_EstFisFinanSaldoCom: TRadioButton;
    Rb_EstFisFinanSaldoSem: TRadioButton;
    Splitter2: TSplitter;
    Dbg_EstFisFinanGiroEstoque: TDBGrid;
    Pan_EstFisFinaResutadoGiroEstoque: TPanel;
    Bt_EstFisFinanGiroEstoqueSalvar: TJvXPButton;
    Dbg_CurvaABCEndCurvaABC: TDBGrid;
    Splitter3: TSplitter;
    Dbg_CurvaABCEndCurvaABCForn: TDBGrid;
    Pan_CurvaABCEndABC: TPanel;
    Bt_CurvaABCEndDistrEndereco: TJvXPButton;
    Bt_CurvaABCEndVoltar: TJvXPButton;
    Gb_CurvaABCEndEnderecamentos: TGroupBox;
    Label125: TLabel;
    Label126: TLabel;
    Label127: TLabel;
    Label124: TLabel;
    Cbx_CurvaABCEndZona: TComboBox;
    Cbx_CurvaABCEndCorredor: TComboBox;
    Cbx_CurvaABCEndPrateleira: TComboBox;
    Bt_CurvaABCEndLocalizaProd: TJvXPButton;
    EdtCurvaABCEndDescProd: TEdit;
    EdtCurvaABCEndCodProd: TEdit;
    Gb_CurvaABCEndEstatistica: TGroupBox;
    Label128: TLabel;
    Label129: TLabel;
    Label130: TLabel;
    Label131: TLabel;
    Label132: TLabel;
    Label133: TLabel;
    Label134: TLabel;
    Label135: TLabel;
    EdtCurvaABCEndTotGavetas: TCurrencyEdit;
    EdtCurvaABCEndTotGavA: TCurrencyEdit;
    EdtCurvaABCEndTotGavB: TCurrencyEdit;
    EdtCurvaABCEndTotGavC: TCurrencyEdit;
    EdtCurvaABCEndTotGavLivres: TCurrencyEdit;
    EdtCurvaABCEndTotGavLivresA: TCurrencyEdit;
    EdtCurvaABCEndTotGavLivresB: TCurrencyEdit;
    EdtCurvaABCEndTotGavLivresC: TCurrencyEdit;
    Dbg_CurvaABCEndEnderecamento: TDBGridJul;
    Pan_CurvaABCEndEndereca: TPanel;
    PC_FinanComprPlanFinan: TPageControl;
    Ts_FinanComprPlanFinanRelacao: TTabSheet;
    Ts_FinanComprPlanFinanManutComprov: TTabSheet;
    Ts_FinanComprPlanFinanPlanilhaFinanceira: TTabSheet;
    Pan_FinanPlanFinanceira: TPanel;
    Bt_FinanPlanFinanceiraVoltar: TJvXPButton;
    Bt_FinanPlanFinanceiraTamColunas: TJvXPButton;
    Bt_FinanPlanFinanceiraCalcular: TJvXPButton;
    EdtFinanPlanFinanceiraPeriodo: TEdit;
    Bt_FinanPlanDemonsResultados: TJvXPButton;
    Dbg_FinanPlanFinanceira: TDBGrid;
    dxStatusBar2: TdxStatusBar;
    Ts_FinanComprPlanFinanManutGrFinanceiro: TTabSheet;
    Ts_FinanComprPlanFinanDemonsResultados: TTabSheet;
    Pan_CklbFinanFechaCaixa: TPanel;
    Cklb_FinanFechaCaixa: TRxCheckListBox;
    Sbt_FinanMLResFinal: TSpeedButton;
    Pan_FinanMLRegs: TPanel;
    ApplicationEvents1: TApplicationEvents;
    Pna_FinanPlanoContasCP200: TPanel;
    Bt_FinanPlanoContasCP200Calcular: TJvXPButton;
    EdtFinanPlanoContasCP200Periodo: TEdit;
    Dbg_FinanPlanoContasCompr200: TDBGrid;
    Panel70: TPanel;
    Bt_FinanPlanoContasCP200Fechar: TJvXPButton;
    Bt_FinanPlanoContasCP200Salvar: TJvXPButton;
    Pan_FinanPlanoContasCP200TamColunas: TPanel;
    Label89: TLabel;
    Label90: TLabel;
    Bt_FinanPlanoContasCP200TamColunas: TJvXPButton;
    EdtFinanPlanoContasCP200TamColunasNaoFixadas: TCurrencyEdit;
    EdtFinanPlanoContasCP200TamColunas1: TCurrencyEdit;
    Pan_FinanObjetivosGrafico: TPanel;
    Label115: TLabel;
    Label114: TLabel;
    Cbx_FinanObjetivosGraficoObjetivos: TComboBox;
    Gb_FinanObjetivosGraficoTpGrafico: TGroupBox;
    Rb_FinanObjetivosGraficoTpBarras: TJvRadioButton;
    Rb_FinanObjetivosGraficoTpLinha: TJvRadioButton;
    Rb_FinanObjetivosGraficoTpPizza: TJvRadioButton;
    Gb_FinanObjetivosGraficoMouse: TGroupBox;
    Ckb_FinanObjetivosGraficoMouse: TJvCheckBox;
    Cbx_FinanObjetivosGraficoEmpresas: TComboBox;
    Pan_FinanObjetivosGrafico3D: TPanel;
    Label113: TLabel;
    Label116: TLabel;
    Label117: TLabel;
    Ckb_FinanObjetivosGrafico3D: TJvCheckBox;
    Sb_FinanObjetivosGrafico3D: TScrollBar;
    Cbx_FinanObjetivosGraficoTpApres: TComboBox;
    Gb_FinanObjetivosGraficoValorVertical: TGroupBox;
    Ckb_FinanObjetivosGraficoValorVertical: TJvCheckBox;
    DbGrafico_FinanObjetivosGrafico: TDBChart;
    ScrollBar2: TScrollBar;
    Dbg_FinanObjetivosResultadosAuditoria: TDBGrid;
    StatusBar4: TStatusBar;
    Panel102: TPanel;
    Bt_FinanObjetivosResultAuditSalvar: TJvXPButton;
    Bt_FinanObjetivosResultAuditVoltar: TJvXPButton;
    Bt_FinanObjetivosResultAuditGraficos: TJvXPButton;
    Dbg_FinanObjetivosResultadosMeses: TDBGrid;
    StatusBar3: TStatusBar;
    Panel94: TPanel;
    Bt_FinanObjetivosResultMesesSalvar: TJvXPButton;
    Bt_FinanObjetivosResultMesesVoltar: TJvXPButton;
    Panel95: TPanel;
    Label119: TLabel;
    Label120: TLabel;
    Label121: TLabel;
    Label122: TLabel;
    Label123: TLabel;
    Bt_FinanObjetivosResultMesesTamColunas: TJvXPButton;
    EdtFinanObjetivosResultMesesTamNaoFixas: TCurrencyEdit;
    EdtFinanObjetivosResultMesesTamColuna1: TCurrencyEdit;
    EdtFinanObjetivosResultMesesTamColuna2: TCurrencyEdit;
    EdtFinanObjetivosResultMesesTamColuna3: TCurrencyEdit;
    EdtFinanObjetivosResultMesesTamColuna4: TCurrencyEdit;
    Bt_FinanObjetivosMesesGraficos: TJvXPButton;
    Dbg_FinanObjetivosResultadosDias: TDBGrid;
    StatusBar2: TStatusBar;
    Panel78: TPanel;
    Bt_FinanObjetivosResultDiasSalvar: TJvXPButton;
    Bt_FinanObjetivosResultDiasVoltar: TJvXPButton;
    Panel79: TPanel;
    Label92: TLabel;
    Label93: TLabel;
    Label94: TLabel;
    Label108: TLabel;
    Label109: TLabel;
    Bt_FinanObjetivosResultDiasTamColunas: TJvXPButton;
    EdtFinanObjetivosResultDiasTamNaoFixas: TCurrencyEdit;
    EdtFinanObjetivosResultDiasTamColuna1: TCurrencyEdit;
    EdtFinanObjetivosResultDiasTamColuna2: TCurrencyEdit;
    EdtFinanObjetivosResultDiasTamColuna3: TCurrencyEdit;
    EdtFinanObjetivosResultDiasTamColuna4: TCurrencyEdit;
    Bt_FinanObjetivosDiasGraficos: TJvXPButton;
    Pan_FinanObjetivosManutGrid: TPanel;
    Dbg_FinanObjetivosManut: TDBGridJul;
    dxStatusBar3: TdxStatusBar;
    Panel91: TPanel;
    Bt_FinanObjetivosMarcaTodos: TJvXPButton;
    Bt_FinanObjetivosDesMarcaTodos: TJvXPButton;
    Pan_FinanObjetivosManutencao: TPanel;
    Panel80: TPanel;
    Bt_FinanObjetivosManutSalvar: TJvXPButton;
    Bt_FinanObjetivosManutAbandonar: TJvXPButton;
    Gb_FinanObjetivosManutObjetivos: TGroupBox;
    Label91: TLabel;
    Label95: TLabel;
    Label96: TLabel;
    Label97: TLabel;
    Label98: TLabel;
    Label99: TLabel;
    Label100: TLabel;
    Label101: TLabel;
    Label102: TLabel;
    Label103: TLabel;
    Label104: TLabel;
    Label105: TLabel;
    Dbe_FinanObjetivosManutJan: TDBEdit;
    Dbe_FinanObjetivosManutFev: TDBEdit;
    Dbe_FinanObjetivosManutMar: TDBEdit;
    Dbe_FinanObjetivosManutAbr: TDBEdit;
    Dbe_FinanObjetivosManutMai: TDBEdit;
    Dbe_FinanObjetivosManutJun: TDBEdit;
    Dbe_FinanObjetivosManutJul: TDBEdit;
    Dbe_FinanObjetivosManutAgo: TDBEdit;
    Dbe_FinanObjetivosManutSet: TDBEdit;
    Dbe_FinanObjetivosManutOut: TDBEdit;
    Dbe_FinanObjetivosManutNov: TDBEdit;
    Dbe_FinanObjetivosManutDez: TDBEdit;
    Pan_FinanObjetivosManutObjetivos: TPanel;
    Bt_FinanObjetivosManutObjetivos: TJvXPButton;
    Bt_FinanObjetivosManutObjetivosSalvar: TJvXPButton;
    Bt_FinanObjetivosManutObjetivosAbandonar: TJvXPButton;
    Gb_FinanObjetivosManutEmpresas: TGroupBox;
    Dbg_FinanObjetivosManutEmpresas: TDBGrid;
    StBar_FinanObjetivosManutCalculaObjetivo: TStatusBar;
    Pan_FinanObjetivosManut: TPanel;
    Gb_FinanObjetivosManutDesObjetivo: TGroupBox;
    Dbe_FinanObjetivosManutDesObjetivo: TDBEdit;
    Gb_FinanObjetivosManutFormula: TGroupBox;
    Dbe_FinanObjetivosManutFormula: TDBEdit;
    Bt_FinanObjetivosManutFormulaComprovante: TJvXPButton;
    Bt_FinanObjetivosManutFormulaExcluir: TJvXPButton;
    Bt_FinanObjetivosManutFormulaSinalAbreParentes: TJvXPButton;
    Bt_FinanObjetivosManutFormulaSinalFechaParentes: TJvXPButton;
    Bt_FinanObjetivosManutFormulaSinalSubtrai: TJvXPButton;
    Bt_FinanObjetivosManutFormulaSinalSoma: TJvXPButton;
    Bt_FinanObjetivosManutFormulaSinalMultiplica: TJvXPButton;
    Bt_FinanObjetivosManutFormulaSinalDivide: TJvXPButton;
    Bt_FinanObjetivosManutFormulaTexto: TJvXPButton;
    Ckb_FinanObjetivosManutAuditoria: TJvXPCheckbox;
    Ckb_FinanObjetivosManutAvarias: TJvXPCheckbox;
    Ckb_FinanObjetivosManutNaoCompra: TJvXPCheckbox;
    Gb_FinanObjetivosManutVlrFixo: TGroupBox;
    Ckb_FinanObjetivosManutVlrFixo: TJvXPCheckbox;
    Gb_FinanObjetivosManutDecimais: TGroupBox;
    Dbe_FinanObjetivosManutDecimais: TDBEdit;
    Gb_FinanObjetivosManutOrdem: TGroupBox;
    Dbe_FinanObjetivosManutOrdem: TDBEdit;
    Gb_FinanObjetivosManutAtivo: TGroupBox;
    Ckb_FinanObjetivosManutAtivo: TJvXPCheckbox;
    Gb_FinanObjetivosManutTpOperacao: TGroupBox;
    Rb_FinanObjetivosManutTpOperacaoLoja: TJvRadioButton;
    Rb_FinanObjetivosManutTpOperacaoSalao: TJvRadioButton;
    Rb_FinanObjetivosManutTpOperacaoAmbos: TJvRadioButton;
    Gb_FinanObjetivosManutUlt12Meses: TGroupBox;
    Ckb_FinanObjetivosManutUlt12Meses: TJvXPCheckbox;
    Bt_FOSoma: TcxButton;
    Gb_FinanObjetivosManutAno: TGroupBox;
    EdtFinanObjetivosAno: TCurrencyEdit;
    Panel73: TPanel;
    Bt_FinanObjetivosAlterar: TJvXPButton;
    Bt_FinanObjetivosNovo: TJvXPButton;
    Bt_FinanObjetivosExcluir: TJvXPButton;
    Bt_FinanObjetivosFechar: TJvXPButton;
    Panel71: TPanel;
    Label106: TLabel;
    Label107: TLabel;
    Label18: TLabel;
    Cbx_FinanObjetivosGerarMes: TComboBox;
    Bt_FinanObjetivosGeraObjetivos: TJvXPButton;
    DtEdt_FinanObjetivosGerarUltDia: TcxDateEdit;
    EdtFinanObjetivosGerarAno: TcxSpinEdit;
    PC_OrdemCompra: TPageControl;
    Ts_OCBuscaProdutos: TTabSheet;
    Pan_OC: TPanel;
    Panel22: TPanel;
    Bt_OCFechar: TJvXPButton;
    Bt_OCBuscaProdutos: TJvXPButton;
    Bt_OCsLojas: TJvXPButton;
    Bt_OCsImportadas: TJvXPButton;
    Pan_CalculoOC: TPanel;
    GB_CalculoMeses: TGroupBox;
    Label22: TLabel;
    Label23: TLabel;
    Bevel1: TBevel;
    Label24: TLabel;
    Label25: TLabel;
    Label26: TLabel;
    Label27: TLabel;
    Label28: TLabel;
    Label29: TLabel;
    Bevel2: TBevel;
    Label30: TLabel;
    Label31: TLabel;
    Label32: TLabel;
    Label33: TLabel;
    Bevel3: TBevel;
    Label34: TLabel;
    Label40: TLabel;
    Label41: TLabel;
    Label42: TLabel;
    Bevel4: TBevel;
    Bevel13: TBevel;
    CB_Mes1: TComboBox;
    ME_Ano2: TMaskEdit;
    CB_Mes2: TComboBox;
    ME_Ano3: TMaskEdit;
    CB_Mes3: TComboBox;
    ME_Ano4: TMaskEdit;
    CB_Mes4: TComboBox;
    CB_Mes5: TComboBox;
    ME_Ano5: TMaskEdit;
    CB_Mes6: TComboBox;
    ME_Ano6: TMaskEdit;
    ME_Ano1: TMaskEdit;
    CB_Mes7: TComboBox;
    ME_Ano7: TMaskEdit;
    CB_Mes8: TComboBox;
    ME_Ano8: TMaskEdit;
    Ts_OCGeraOrdemCompra: TTabSheet;
    Ts_OCGeraEditaOrdemCompra: TTabSheet;
    Panel40: TPanel;
    Gb_GeraOCEditaDocto: TGroupBox;
    EdtGeraOCEditaDocto: TCurrencyEdit;
    DtEdt_GeraOCEditaDataDocto: TDateEdit;
    Gb_GeraOCEditaEmpresa: TGroupBox;
    Dbe_GeraOCEditaDesEmpresa: TDBEdit;
    Dbe_GeraOCEditaCodEmpresa: TDBEdit;
    Bt_GeraOCEditaLegendaCores: TJvXPButton;
    PC_GeraOCEditaApresentacao: TPageControl;
    Ts_GeraOCEditaGrid: TTabSheet;
    Splitter1: TSplitter;
    Dbg_GeraOCEditaGrid: TDBGridJul;
    dxStatusBar1: TdxStatusBar;
    Dbg_GeraOCEditaProdutos: TDBGrid;
    Panel43: TPanel;
    Label62: TLabel;
    Label63: TLabel;
    Label64: TLabel;
    Bevel7: TBevel;
    Bevel8: TBevel;
    Bevel9: TBevel;
    EdtGeraOCEditaTotalGeral: TCurrencyEdit;
    EdtGeraOCEditaTotalItens: TCurrencyEdit;
    EdtGeraOCEditaTotallQtd: TCurrencyEdit;
    Bt_GeraOCEditaVoltar: TJvXPButton;
    Rb_GeraOCEditaTodosItens: TRadioButton;
    Rb_GeraOCEditaComQtd: TRadioButton;
    Rb_GeraOCEditaSemQtd: TRadioButton;
    Dbg_Usuarios: TDBGrid;
    Gb_FinanManutComprovComprovante: TGroupBox;
    Dbe_FinanManutComprovCodComprovante: TDBEdit;
    Dbe_FinanManutComprovDesComprovante: TDBEdit;
    Gb_FinanManutComprovGrFinanceiro: TGroupBox;
    Dbe_FinanManutComprovCodGrFinanceiro: TDBEdit;
    EdtFinanManutComprovDesGrFinanceiro: TEdit;
    Bt_FinanManutComprovBuscaGrFinanceiro: TJvXPButton;
    Gb_FinanManutComprovPlanilha: TGroupBox;
    Ckb_FinanManutComprovPlanilha: TJvXPCheckbox;
    Gb_FinanManutComprovFormula: TGroupBox;
    Label67: TLabel;
    Dbe_FinanManutComprovFormula: TDBEdit;
    Dbe_FinanManutComprovFormulaNumDecimais: TDBEdit;
    Gb_FinanManutComprovSoma: TGroupBox;
    Dbe_FinanManutComprovSoma: TDBEdit;
    Gb_FinanManutComprovSubtrai: TGroupBox;
    Dbe_FinanManutComprovSubtrai: TDBEdit;
    Mem_FinanManutComprovOBS: TMemo;
    Panel50: TPanel;
    Bt_FinanManutComprovVoltar: TJvXPButton;
    Bt_FinanManutComprovSalvar: TJvXPButton;
    Gb_FinanManutComprovSomaGrupo: TGroupBox;
    Ckb_FinanManutComprovSomaGrupo: TJvXPCheckbox;
    Gb_FinanManutComprovAtivo: TGroupBox;
    Ckb_FinanManutComprovAtivo: TJvXPCheckbox;
    Panel48: TPanel;
    Bt_FinanComprovantesFechar: TJvXPButton;
    Bt_FinanComprovantesDetalhar: TJvXPButton;
    Bt_FinanComprPlanFinanPlanilha: TJvXPButton;
    Panel45: TPanel;
    Label58: TLabel;
    EdtFinanComprovantesLocalizar: TEdit;
    Bt_FinanComprovantesNovo: TJvXPButton;
    Dbg_FinanComprovantes: TDBGrid;
    PopM_OCRomaneio: TPopupMenu;
    PopM_OCRomaneioMarcarOCsAbertas: TMenuItem;
    N19: TMenuItem;
    PopM_OCRomaneioMarcarRomaneiosAbertos: TMenuItem;
    N20: TMenuItem;
    PopM_OCRomaneioMarcarRomaneiosFechados: TMenuItem;
    GB_UsuManut: TGroupBox;
    GB_UsuManutCodigo: TGroupBox;
    Dbe_UsuManutCodigo: TDBEdit;
    GB_UsuManutNome: TGroupBox;
    Dbe_UsuManutNome: TDBEdit;
    GB_UsuManutLogin: TGroupBox;
    Dbe_UsuManutLogin: TDBEdit;
    GB_UsuManutAdmin: TGroupBox;
    DBCB_UsuManutAdmin: TDBComboBox;
    GB_UsuManutAtivo: TGroupBox;
    DBCB_UsuManutAtivo: TDBComboBox;
    Bt_UsuManutSenha: TJvXPButton;
    Label37: TLabel;
    Gb_UsuManutSenha: TGroupBox;
    Label9: TLabel;
    Label10: TLabel;
    Label11: TLabel;
    EdtUsuManutSenhaAtual: TEdit;
    EdtUsuManutSenhaNova: TEdit;
    EdtUsuManutSenhaRepete: TEdit;
    Panel6: TPanel;
    Bt_UsuManutSenhaSalva: TJvXPButton;
    Dbe_UsuManutSenha: TDBEdit;
    Bt_UsuManutSenhaFecha: TJvXPButton;
    PC_FinanComprPlanFinanDemonsResultados: TPageControl;
    Ts_FinanComprPlanFinanManutDemonsResultados: TTabSheet;
    Pan_FinanDemonsResultVisao: TPanel;
    Gb_FinanDemonsResultVisao: TGroupBox;
    EdtFinanDemonsResultDesVisao: TEdit;
    Bt_FinanDemonsResultBuscaVisao: TJvXPButton;
    EdtFinanDemonsResultCodVisao: TCurrencyEdit;
    Bt_FinanDemonsResultCadVisao: TJvXPButton;
    Bt_FinanDemonsResultExcVisao: TJvXPButton;
    Panel62: TPanel;
    Bt_FinanDemonsResultGeraResult: TJvXPButton;
    Pan_FinanDemonsResultados: TPanel;
    Panel63: TPanel;
    Bt_FinanDemonsResultSalvar: TJvXPButton;
    Bt_FinanDemonsResultAbandonar: TJvXPButton;
    Gb_FinanDemonsResultDesDemonstrativo: TGroupBox;
    Dbe_FinanDemonsResultDesDemonstrativo: TDBEdit;
    Gb_FinanDemonsResultOrdem: TGroupBox;
    Dbe_FinanDemonsResultOrdem: TDBEdit;
    Gb_FinanDemonsResultFormula: TGroupBox;
    Label76: TLabel;
    Dbe_FinanDemonsResultFormula: TDBEdit;
    Bt_FinanDemonsResultBuscaGrFinanceiro: TJvXPButton;
    Gb_FinanDemonsResultDecimais: TGroupBox;
    Dbe_FinanDemonsResultDecimais: TDBEdit;
    Dbg_FinanDemonsResultado: TDBGrid;
    Panel58: TPanel;
    Bt_FinanDemonsResultAlterar: TJvXPButton;
    Bt_FinanDemonsResultNovo: TJvXPButton;
    Bt_FinanDemonsResultExcluir: TJvXPButton;
    Bt_FinanDemonsResultVoltar: TJvXPButton;
    Ts_FinanComprPlanFinanPlanDemonsResultados: TTabSheet;
    Dbg_FinanDemonsResultPlanDemons: TDBGrid;
    Panel61: TPanel;
    Bt_FinanDemonsResultPlanDemonsSalvar: TJvXPButton;
    Bt_FinanDemonsResultPlanDemonsVoltar: TJvXPButton;
    Pan_FinanDemonsResultPlanDemonsTamColunas: TPanel;
    Label78: TLabel;
    Label79: TLabel;
    Label80: TLabel;
    Bt_FinanDemonsResultPlanDemonsTamColunas: TJvXPButton;
    EdtFinanDemonsResultTamColunasNaoFixadas: TCurrencyEdit;
    EdtFinanDemonsResultTamColunas1: TCurrencyEdit;
    EdtFinanDemonsResultTamColunas2: TCurrencyEdit;
    Dbg_FinanGrFinanceiro: TDBGrid;
    Pan_FinanGrFinan: TPanel;
    Panel54: TPanel;
    Bt_FinanGrFinanSalvar: TJvXPButton;
    Bt_FinanGrFinanAbandonar: TJvXPButton;
    Gb_FinanGrFinanGrFinanceiro: TGroupBox;
    Dbe_FinanGrFinanGrFinanceiro: TDBEdit;
    Gb_FinanGrFinanAbrevPesquisa: TGroupBox;
    Dbe_FinanGrFinanAbrevPesquisa: TDBEdit;
    Gb_FinanGrFinanAtivo: TGroupBox;
    Ckb_FinanGrFinanAtivo: TJvXPCheckbox;
    Gb_FinanGrFinanNumOrdem: TGroupBox;
    Dbe_FinanGrFinanNumOrdem: TDBEdit;
    Pan_FinanVisualGrFinanceiro: TPanel;
    Label77: TLabel;
    Gb_FinanGrFinanUsuaSemPermissao: TGroupBox;
    Bt_FinanGrFinanUsuarioBusca: TJvXPButton;
    Bt_FinanGrFinanUsuarioExclui: TJvXPButton;
    Panel64: TPanel;
    EdtFinanGrFinanUsuarioCod: TCurrencyEdit;
    Dbg_FinanGrFinanUsuario: TDBGrid;
    Panel53: TPanel;
    Bt_FinanGrFinanAlterar: TJvXPButton;
    Bt_FinanGrFinanNovo: TJvXPButton;
    Bt_FinanGrFinanExcluir: TJvXPButton;
    Bt_FinanGrFinanVoltar: TJvXPButton;
    Panel33: TPanel;
    Gb_GeraOCDocto: TGroupBox;
    EdtGeraOCBuscaDocto: TCurrencyEdit;
    DtEdt_GeraOCDataDocto: TDateEdit;
    Bt_GeraOCBuscaDocto: TJvXPButton;
    Gb_GeraOCCalculaCompra: TGroupBox;
    Label48: TLabel;
    EdtGeraOCDias: TJvValidateEdit;
    Bt_GeraOCCalcular: TJvXPButton;
    Gb_GeraOCEstoqueTransito: TGroupBox;
    Label35: TLabel;
    Label36: TLabel;
    Ckb_GeraOCCalculoEstoque: TJvXPCheckbox;
    Ckb_GeraOCCalculoTransito: TJvXPCheckbox;
    PC_GeraOCProduto: TPageControl;
    Ts_GeraOCProdutos: TTabSheet;
    Dbg_GeraOCProdutos: TDBGridJul;
    PC_GeraOCFiliais: TPageControl;
    Ts_GeraOCFiliais: TTabSheet;
    Dbg_GeraOCFiliais: TDBGridJul;
    PC_GeraOCApresentacao: TPageControl;
    Ts_GeraOCGrid: TTabSheet;
    Dbg_GeraOCGrid: TDBGridJul;
    Ts_GeraOCOrdensCompra: TTabSheet;
    Panel35: TPanel;
    Label39: TLabel;
    Lab_ItensOC: TLabel;
    Lab_Qtds_OC: TLabel;
    Bevel5: TBevel;
    Bevel6: TBevel;
    EdtGeraOCTotalGeral: TCurrencyEdit;
    Bt_GeraOCGeraOC: TJvXPButton;
    Bt_GeraOCImpEditOC: TJvXPButton;
    DbeGeraOCTotalProdutos: TDBEdit;
    DbeGeraOCQtdOCs: TDBEdit;
    Bt_GeraOCGraficoImprime: TJvXPButton;
    Bt_GeraOCGraficoEdit: TJvXPButton;
    Bt_GeraOCDocSeparacao: TJvXPButton;
    Dbg_GeraOCTotalGeral: TDBGridJul;
    Sb_GeraOC: TdxStatusBar;
    PopM_OCRomaneioDesmarcarRomaneiosDesmarcar: TMenuItem;
    N21: TMenuItem;
    SubMenuFinanConciliacaoCaixa: TMenuItem;
    Panel3: TPanel;
    Panel4: TPanel;
    Button2: TButton;
    DtEdt_ConsultaNFeDtInicio: TcxDateEdit;
    EdtConsultaNFeVlr: TCurrencyEdit;
    Label59: TLabel;
    Label61: TLabel;
    EdtConsultaNFeDocto: TCurrencyEdit;
    PC_ConsultaMovtoCompr: TPageControl;
    TS_ConsultaNFeFiltros: TTabSheet;
    Ts_ConsultaNFeMovtoCompr: TTabSheet;
    Dbg_ConsultaNFeLojas: TDBGridJul;
    Dbg_ConsultaNFeEmpresa: TDBGridJul;
    Dbg_ConsultaNFeNotasLojas: TDBGridJul;
    SBar_ConsultaNFeNotasLojas: TStatusBar;
    PC_AudCompVend: TPageControl;
    Ts_AudCompVendFiltros: TTabSheet;
    Ts_AudCompVendMovtos: TTabSheet;
    Panel13: TPanel;
    Lb_AudAprocessar: TLabel;
    Lb_AudProcessados: TLabel;
    Label54: TLabel;
    Label191: TLabel;
    Bt_AudCompVendFechar: TJvXPButton;
    Bt_AudCompVendBuscaMovto: TJvXPButton;
    Dbg_AudCompVend: TDBGrid;
    Panel18: TPanel;
    Bt_AudCompVendVoltar: TJvXPButton;
    Bt_AudCompVendSalvaClipboard: TJvXPButton;
    Bt_AudCompVendSalvaCSV: TJvXPButton;
    SubMenuFinanVerificaExtratos: TMenuItem;
    SubMenuFinanExportImportArquivos: TMenuItem;
    SubMenuFinanExpImpArquivosProSoft1: TMenuItem;
    N22: TMenuItem;
    PopM_PlanFinanceiraMemoria: TMenuItem;
    Panel27: TPanel;
    Dbg_FiltroGruposProdutos: TDBGridJul;
    Dbg_ConEmpresas: TDBGrid;
    Gb_CalculoFiltroNome: TGroupBox;
    Label186: TLabel;
    Label203: TLabel;
    Label204: TLabel;
    Label205: TLabel;
    EdtCalculoFiltroNome1: TEdit;
    EdtCalculoFiltroNome4: TEdit;
    EdtCalculoFiltroNome3: TEdit;
    EdtCalculoFiltroNome2: TEdit;
    CorTelaForm: TJvGradient;
    SubMenuProtUsuariosPermAcessoSIDICOM: TMenuItem;
    N23: TMenuItem;
    Label66: TLabel;
    Label68: TLabel;
    Label69: TLabel;
    Dbe_ConEmpresasCodContabil: TDBEdit;
    N24: TMenuItem;
    Ckb_CalculoCurvaE: TJvXPCheckbox;
    Bt_CurvaABCEndSalvaProdClipboard: TJvXPButton;
    Bt_CurvaABCEndSalvaFornClipboard: TJvXPButton;
    SubMenuComprasEstoquesMinimoDemadas: TMenuItem;
    Dbg_CurvaABCMixProd: TDBGrid;
    Panel118: TPanel;
    Label88: TLabel;
    Panel87: TPanel;
    Gb_CurvaABCEndLimiteCurvaA: TGroupBox;
    Label81: TLabel;
    EdtCurvaABCEndLimiteCurvaA: TCurrencyEdit;
    Gb_CurvaABCEndLimiteCurvaB: TGroupBox;
    Label82: TLabel;
    EdtCurvaABCEndLimiteCurvaB: TCurrencyEdit;
    Gb_CurvaABCEndLimiteCurvaC: TGroupBox;
    Label83: TLabel;
    EdtCurvaABCEndLimiteCurvaC: TCurrencyEdit;
    Gb_CurvaABCEndTipoCalculo: TGroupBox;
    Rb_CurvaABCEndTipoCalculoUnidades: TJvRadioButton;
    Rb_CurvaABCEndTipoCalculoValores: TJvRadioButton;
    Gb_CurvaABCEndPeriodo: TGroupBox;
    Label85: TLabel;
    DtEdt_CurvaABCEndInicio: TcxDateEdit;
    DtEdt_CurvaABCEndFim: TcxDateEdit;
    Gb_CurvaABCEndLimiteCurvaD: TGroupBox;
    Label187: TLabel;
    EdtCurvaABCEndLimiteCurvaD: TCurrencyEdit;
    Gb_CurvaABCEndLimiteCurvaE: TGroupBox;
    Label189: TLabel;
    EdtCurvaABCEndLimiteCurvaE: TCurrencyEdit;
    Gb_CurvaABCEndSituacaoProd: TGroupBox;
    Cbx_CurvaABCEndSituacaoProd: TComboBox;
    Panel2: TPanel;
    Gb_CalculoListaPreco: TGroupBox;
    EdtOCCodListaPreco: TCurrencyEdit;
    EdtOCListaPreco: TEdit;
    Bt_OCBuscaListaPreco: TJvXPButton;
    Gb_CalculoProdNovos: TGroupBox;
    DtEdt_CalculoProdNovos: TcxDateEdit;
    Gb_EmpresaProc: TGroupBox;
    Label43: TLabel;
    Label44: TLabel;
    Lb_EmpAprocessar: TLabel;
    Lb_EmpProcessadas: TLabel;
    Panel8: TPanel;
    Edt_OCTotProdutos: TCurrencyEdit;
    Label70: TLabel;
    Gb_CalculoTransito: TGroupBox;
    DtEdt_CalculoTransito: TcxDateEdit;
    CkB_CalculoTransito: TJvCheckBox;
    Gb_GeraOCItem: TGroupBox;
    Dbe_GeraOCCodItem: TDBEdit;
    Dbe_GeraOCDescItem: TDBEdit;
    Dbe_GeraOCDescFilial: TDBEdit;
    Bt_GeraOCExcluir: TJvXPButton;
    PopM_GeraOC: TPopupMenu;
    PopM_GeraOCCalculaTransfernciasCD: TMenuItem;
    N25: TMenuItem;
    PopM_GeraOCExportaParaOutroDocto: TMenuItem;
    N26: TMenuItem;
    PopM_GeraOCImportaSolicitcoesLojas: TMenuItem;
    N27: TMenuItem;
    PopM_GeraOCVoltar1: TMenuItem;
    PopM_GeraOCLegendaCores: TMenuItem;
    PopM_GeraOCComparaPedidos: TMenuItem;
    N30: TMenuItem;
    PopM_GeraOCValorUnitario: TMenuItem;
    PopM_GeraOCPercDesconto: TMenuItem;
    PopM_GeraOCPercelDescMIX: TMenuItem;
    N31: TMenuItem;
    PopM_OCRomaneioVoltar: TMenuItem;
    N32: TMenuItem;
    N33: TMenuItem;
    N34: TMenuItem;
    N28: TMenuItem;
    PopM_GeraOCVerTransito: TMenuItem;
    PopM_GeraOCOCsOrigem: TMenuItem;
    Pan_GeraOCLojaUnica: TPanel;
    PopM_GeraOCNecessidadedeCompra: TMenuItem;
    PopM_GeraOCVoltar2: TMenuItem;
    N35: TMenuItem;
    PopM_OCRomaneioVoltar1: TMenuItem;
    N36: TMenuItem;
    N37: TMenuItem;
    N38: TMenuItem;
    Pan_ConsultaNFeOpcoes: TPanel;
    Bt_ConsultaNFeEmpresa: TJvXPButton;
    Bt_ConsultaNFeLojas: TJvXPButton;
    Bt_ConsultaNFeNotas: TJvXPButton;
    Bt_ConsultaNFeSalvarClipboard: TJvXPButton;
    Bt_ConsultaNFeSalvarCSV: TJvXPButton;
    Pan_ConsultaNFe_1: TPanel;
    Bt_ConEmpresasUsuWindows: TJvXPButton;
    MenuCentroDistr: TMenuItem;
    SubMenuCentroDistrReposicoesLojas: TMenuItem;
    MenuCentroDistrCentralTrocas: TMenuItem;
    N40: TMenuItem;
    SubMenuCentralTrocasNotasEntradaDevolucao: TMenuItem;
    N18: TMenuItem;
    SubMenuAtualizaTabelasSPED: TMenuItem;
    SubMenuVerificaImportacaoEstoques: TMenuItem;
    N42: TMenuItem;
    DiasInformados: TMenuItem;
    DiasEstocagemParametro: TMenuItem;
    Bt_GeraOCPreVisualizaOC: TJvXPButton;
    N43: TMenuItem;
    ZeraQuantidadeAComprar: TMenuItem;
    Gb_CalculoTpProc: TGroupBox;
    Rb_CalculoTpProcLocal: TJvRadioButton;
    Rb_CalculoTpProcLoja: TJvRadioButton;
    Img_Calculo: TImage;
    N41: TMenuItem;
    SubMenuSalaoRelatorios: TMenuItem;
    N44: TMenuItem;
    N45: TMenuItem;
    Ckb_EstFisFinanGiroEstoqueEmp: TJvCheckBox;
    MenuEstoques: TMenuItem;
    MenuEstoquesSimuladorEstoques: TMenuItem;
    SubMenuCentroDistAnaliseReposicoes: TMenuItem;
    Ckbx_ConsultaNFeApresParcela: TCheckBox;
    Label1: TLabel;
    EdtFinanObjetivosMeses: TCurrencyEdit;
    SubMenuFinanComissoes: TMenuItem;
    SubMenuComisVendedores: TMenuItem;
    N48: TMenuItem;
    ParametrosVendedores1: TMenuItem;
    Ts_ConsultaNFeProdutos: TTabSheet;
    Pan_ConsultaNFeProdutos: TPanel;
    Bt_ConsultaNFeProdSalvarClipboard: TJvXPButton;
    Bt_ConsultaNFeProdSalvarCSV: TJvXPButton;
    Ckbx_ConsultaNFeApresProduto: TCheckBox;
    Dbg_ConsultaNFeProdutos: TDBGrid;
    Dbg_ConsultaNFeProdLojas: TDBGrid;
    Panel10: TPanel;
    Ckbx_ConsultaNFeApresTotais: TJvXPCheckbox;
    Panel11: TPanel;
    Lab_CurvaABCEndTotalProdutos: TLabel;
    EdtCurvaABCEndTotalProdutos: TCurrencyEdit;
    EdtCurvaABCEndTotalProc: TCurrencyEdit;
    N49: TMenuItem;
    SubMenuCentroDistQtdCaixaCD: TMenuItem;
    Gb_Sidicom: TGroupBox;
    Dbe_ConEmpresasCodFilial: TDBEdit;
    Label16: TLabel;
    Label15: TLabel;
    Dbe_ConEmpresasCodEmp: TDBEdit;
    GroupBox1: TGroupBox;
    Label2: TLabel;
    Dbe_ConEmpresasCodLojaLinx: TDBEdit;
    EdtDta_ConEmpresasInicioLinx: TcxDateEdit;
    Label71: TLabel;
    Button1: TButton;
    Button3: TButton;
    Bt_AcertaPromocao: TButton;
    Label72: TLabel;
    EdtDta_ConEmpresasInventLinx: TcxDateEdit;
    Button4: TButton;
    N46: TMenuItem;
    N47: TMenuItem;
    SubMenuComprasGeraOCLinx: TMenuItem;
    N29: TMenuItem;
    Label73: TLabel;
    N51: TMenuItem;
    Label74: TLabel;
    Label75: TLabel;
    EdtFiltroCodProdLinx: TCurrencyEdit;
    Label183: TLabel;
    N39: TMenuItem;
    PrioridadesdeReposio1: TMenuItem;
    N50: TMenuItem;
    N52: TMenuItem;
    N53: TMenuItem;
    SubMenuFinanConciliaDepositos: TMenuItem;
    N54: TMenuItem;

    // Odir ====================================================================

    // EMPRESAS/LOJAS //////////////////////////////////////////////////////////
    Procedure LiberaCamposSidicom(bLibera: Boolean);
    ////////////////////////////////////////////////////////////////////////////

    // BANCO DE DADOS //////////////////////////////////////////////////////////
    Function  ConectaMatriz(bTestar: Boolean=False): Boolean;
    Function  ConectaMPMS(bTestar: Boolean=False): Boolean;

    Procedure CriaQueryIB(sDataBase, sTransaction: String; Var IBQ_Free: TIBQuery; bMatriz, bCriaIBQ: Boolean);
        // sDataBase    = Database a Conectar
        // sTransaction = Transaction a Conectar
        // IBQ_Free     = Nome do TIBQuery a Destruir e Reconstruir
        // bMatriz      = Se Conexo  Matriz (No Gera Sql Automaticamente)
        // bCriaIBQ     = Se Destruir e Reconstruir IBQuery

    Procedure StoredProcInicializa(Var IBSP: TIBStoredProc; sDataBase, sTransaction: String);
    ////////////////////////////////////////////////////////////////////////////

    // ACESSOS A USUARIOS //////////////////////////////////////////////////////
    Procedure ApresentaDataHoraVersao;
    Procedure InicializaUsuario(var Permissao: String);
    Procedure AcertaAcessos(var Perm: String);

    Procedure AcessoAdministrador(b:Boolean);
    Procedure PermissaoVisual(TabSh: TTabSheet);
    ////////////////////////////////////////////////////////////////////////////

    // CONTROLE DE TABSHEET ////////////////////////////////////////////////////
    Procedure SelecionaTabSheet(ts:TTabSheet);
    Procedure AbreFechaTabSheet(Fechar, Menu: Boolean);
    Procedure LiberaMenu(b: Boolean);
    Function  MandaFechar: Boolean; // Verifica se Existe TabSheet em Aberto

    // Torna TabSheets Visible = False
    // Colocar TabSheet.Tag=9999
    Procedure TabSheetInvisivel(Form: TForm);
    Procedure TabSheetVisivel(Form: TForm; sNomeTabSh: String);
    ////////////////////////////////////////////////////////////////////////////

    // DIVERSOS ////////////////////////////////////////////////////////////////
    Procedure ControleMenu(bControle: Boolean);

    Procedure SelecionaProdutos(bProd, bLike: Boolean);
                             // bProd = True - Seleciona Produto (Codigo)
                             // bLike = True - Seleciona Produto (Nome)
                             // Like Montado com Alias < pr. >
                             //      USAR: MySql:=MySql+f_Troca('pr.','p.',sgLikeProdutos);

    Procedure FechaTudo;

    Function NomeUfEstado(Cod_Uf: String): String;

    Procedure InicializaMeses;
    Procedure AtualizaNumeroDosMeses;

    Procedure AbreSolicitacoes(index: Integer);

    // Monta PrograssBar
    Procedure MontaProgressBar(bCria: Boolean; Form: TForm);

    // Desabilita e Habilita Scroll do Mouse no DBGrid
    Procedure DesabilitaScrollMouse(var Msg: TMsg; var Handled: Boolean);
    Procedure HabilitaScrollMouse(var Msg: TMsg; var Handled: Boolean);

    // Bloquear PrintScreen
    procedure AntiCopia(Sender: TObject; Var Done: Boolean);

    ////////////////////////////////////////////////////////////////////////////

    // ORDEM DE COMPRA /////////////////////////////////////////////////////////
    Function TotalRegistros(IBQ: TIBQuery; SqlSelect: String;
                            Sql1: String =''; Sql2: String =''; Sql3: String ='';
                            NomeParam1: String =''; VlrParam1 : String ='';
                            NomeParam2: String =''; VlrParam2 : String ='';
                            NomeParam3: String =''; VlrParam3 : String ='';
                            NomeParam4: String =''; VlrParam4 : String ='';
                            NomeParam5: String =''; VlrParam5 : String ='';
                            NomeParam6: String =''; VlrParam6 : String ='';
                            NomeParam7: String =''; VlrParam7 : String ='';
                            NomeParam8: String =''; VlrParam8 : String =''): Integer;

    Function  ConsisteBuscaProdutos: Boolean;

    Procedure BuscaMixLoja(sLoja: String);

    Function  BuscaProdutosAnalise: Boolean;
    Procedure MontaSelectFornecedores;

    Function  OCProcessaMatriz: Boolean; // Novo Calculo

    Procedure BuscaDemanda(Cbbx_Mes: TComboBox; Me_Ano: TMaskEdit; sCodProduto, sFilial: String;
                           Var Demanda: Currency; var iNrDias: Integer; Var iNrMeses: Integer; bConsulta: Boolean);

    Procedure MontaDemandasNovo(sFilial: String);


    Procedure MontaSelectFilial(Var IBQ: TIBQuery);
    Procedure CalculaFilial;
    Procedure CalculaFilialLocal;

    Function  OCProcessaFilial: Boolean; // Novo Calculo

    Procedure OCCalculaSugTransfExc(sNrDoc, sDtaDoc: String); // Calcula Sugestes / Transferencias / Estoque Excedente

    Procedure NomeMesesGrid;

    Procedure AlteraAComprar(IBQComprar: TIBQuery; sQual, sNumDoc, sDtaDocto: String);
                            // sQual:
                            //    Q  = Quantidade
                            //    P  = Preco Unitrio
                            //    DI = Percentual de Desconto Individual
                            //    DM = Percentual de Desconto no Mix

    Procedure CalculaTotaisOC(IBQComprar: TIBQuery);
    Procedure TotaisOC(sNrDoc: String);

    Procedure TotaisPedOC(Var svTotal_Valor: String; Var svTotal_Itens: String; Var svTotal_Qtd: String;
                          siNumDocto, siCodEmp, sSituacaoQtd: String; siNumOC: String = ''; sCodForn: String = '');
                          // sSituacaoQtd = 'T' Todos Itens
                          //                'C' Com Quantidade a Comprar
                          //                'S' Sem Quantidade a Comprar

    Procedure VerTransito(IBQ: TIBQuery; DS: TDataSource; bAltTrasito: Boolean);

    Procedure CriaFeriadosAno(iAno: Integer);

    Function  BuscaCodLista(sLoja: String): String;

    Function  LojaUnicaFornecedorImportar: Boolean;
    Function  GeraDoctoLojasUnicas: Boolean;
    ////////////////////////////////////////////////////////////////////////////


    // BUSCA MOVTOS DE COMPROVANTES- Antigo: NOTAS FISCAIS DE ENTRADA //////////
    Function  BuscaMovtosComprov: Boolean; // Antigo ApresentaNFe: Boolean;
    ////////////////////////////////////////////////////////////////////////////

    // PLANILHA FINANCEIRA /////////////////////////////////////////////////////
    Procedure CalculaPlanilhaFinanceira;
    Procedure PlanFinanceiraEmpresas;
    Function  PlanFinanceiraMesAno: String;
    Procedure PlanilhaFinanceiraCalculaFormula(sCampo: String);
    Procedure PlanilhaFinanceiraSomaSubtrai(sCampo: String);
    Procedure CalculaMesesIndividuais(sCodEmp: String);
    Procedure PlanilhaFinanceiraMovtos(sEmp, sComprov: String);
    Procedure PlanilhaFinanceiraRetiraComprovantes;
    Procedure DemonsResultadosCadastraVisao;
    Procedure DemonstrativosResultado(sCodVisao: String);
    Function  VerificaRegistroNaoVisivelTabela(iCodigo: Integer): Boolean;
    Procedure MontaPlanilhaDemonstrativoResultados;
    Procedure CalculaPlanDemonstrativoResultados;
    ////////////////////////////////////////////////////////////////////////////

    // CURVA ABC - ENDEREAMENTOS //////////////////////////////////////////////
    Function  CalculaCurvaABCEndereco: Boolean;

// OdirApagar BuscaEnderecamentos - 09/06/2017
//    Procedure BuscaEnderecamentos;

// OdirApagar EnderecamentoProduto - 09/06/2017
//    Function  EnderecamentoProduto: Boolean;

// OdirApagar AtualizaEnderecamentos - 09/06/2017
//    Procedure AtualizaEnderecamentos(bManter: Boolean);
// ====>>> Exclui TabSheet: Ts_CurvaABCEnderecamentos <<<================

// OdirApagar AtualizaProd_Endereco - 09/06/2017
//    Procedure AtualizaProd_Endereco(sCodLoja: String);
    ////////////////////////////////////////////////////////////////////////////

    // PLANILHA PLANO DE CONTAS (COMPROVANTE 200) //////////////////////////////
    Procedure PlanoContasEmpresasCP200;
    ////////////////////////////////////////////////////////////////////////////

    // OBJETIVOS / METAS ///////////////////////////////////////////////////////
    Procedure HabilitaDesabilitaManutencaoObjetivos(bTipo: Boolean);
                                                    // bTipo: True=Habilita False=Desabilita
    Procedure CalculaValoresObjetivo(sCodObj, sCodObj1, sCodObj2, sTipOper: String);

    // Objetivos Dias
    Procedure MontaPlanilhaObjetivosDias(sDiaSemanaMes: string;iNumDiasUteis: Integer; Var iIndicePlan: Integer);
    Procedure CaluclaObjetivosMetasDias;
    Procedure AtualizaValorObjetivosMetasDias;
    Procedure CaluclaResultadosObjetivosMetasDias;

    // Objetivos Meses
    Procedure MontaPlanilhaObjetivosMeses(Var iIndicePlanMeses: Integer);
    Procedure CaluclaObjetivosMetasMeses;
    Procedure CaluclaResultadosObjetivosMetasMeses;

      Procedure AtualizaValorObjetivosMetasMesesAuditoria;
      Procedure AtualizaValorObjetivosMetasMesesAvarias;

    Procedure AtualizaValorObjetivosMetasMesesOutros;
    Procedure AuditoriaTotalEmpresa;

    Procedure ApresentaMovtosObjetivos(TipCalculo: String);
                                      // TipCalculo= (D)ias (M)eses

    // Grficos
    Procedure FechaSeriesGraficos;
    Procedure ApresentaGraficoObjetivosMetas;
    Procedure GraficoObjetivos(DBGrafico: TDBChart; CDS: TClientDataSet; TipoGraf, Titulo, Descr, Valor: String);

    Procedure HabilitaDesabilitaLinha(CDS: TClientDataSet; sCol1, sConteudoCol1: String; bHabilita: Boolean=True);

    // LINX - MICRIVIX - Busca Vendas
    Function  BuscaMovtosVendasLINX(mMemo: TMemo; sTipo: String): Boolean;
                                               // sTipo= (D)Dias  (M)Meses

    ////////////////////////////////////////////////////////////////////////////

    // AUDITORIA ///////////////////////////////////////////////////////////////
    Procedure AutidoriaCriaNovaAuditoria;
    Procedure AuditoriaCorObjetivos;
    Procedure AuditoriaDBEdtBranco;
    Procedure AuditoriaTodasDatas;
    Procedure AuditoriaAnalise(sClausula: String);

    Procedure AuditoriaMontaSQLCompVend(sTp: String; IBQ: TIBQuery);
                                     // Stp= (C)ompras (V)endas
    ////////////////////////////////////////////////////////////////////////////

    // GIRO DE ESTOQUE /////////////////////////////////////////////////////////
    Procedure DadosEmpGiroEstoque;
    ////////////////////////////////////////////////////////////////////////////

    // FECHAMENTO DE CAIXA DIA /////////////////////////////////////////////////
    Function  FechaCaixaBuscaMovtoCaixaDia(sCodLoja, sDesLoja, sTipo: String): Boolean;
                                           // sTipo: (C)Fechamento do Caixa da Loja
                                           //        (D)Fechamento Diario da Loja
    Function  FechaCaixaPlanoContas(sData, sTipo: String): Boolean;
    Function  FechaCaixaTotalDebitos: Boolean;
    Function  FechaCaixaMovtosCreditos(sData, sTipo: String): Boolean;
    Function  FechaCaixaTotaisCaixaDia: Boolean;

    Procedure FechaCaixaAtualizaCaixaDia;
    Procedure FechaCaixaDiaHabilita(bFechado: Boolean);
    ////////////////////////////////////////////////////////////////////////////

    // FECHAMENTO DIARIO DE LOJAS //////////////////////////////////////////////
    Procedure FechaDiarioHabilita(bHabilita: Boolean);
    Procedure FechaDiarioTotais(sData: String);

    Procedure FechaDiarioComponentes(sCapiton: String);
    Function  FechaDiarioExecutaDML(sCapiton, sTipo: String): Boolean;
                                           // sTipo: (I)Inserir
                                           //        (A)Alterar
    ////////////////////////////////////////////////////////////////////////////

    // ORDENS DE COMPRA DAS LOJAS //////////////////////////////////////////////
    Procedure BuscaOCLojas;
    Procedure CalculoOCsImportadas;
    Procedure OCOrigemImportadas;
    Procedure ApresOCsImportadas;
    ////////////////////////////////////////////////////////////////////////////

    // MARGEM DE LUCRO /////////////////////////////////////////////////////////
    Function  CalculaMargemLucro(sCodLoja: String; iTpApres: Integer; bUsarPcMedioTE: Boolean): Boolean;
    Procedure MargemLucroEntradas(Stl: TStringList);
    Procedure CalculaTotaisMargens;
    Procedure CalculaMargemFinal(sCodLoja: String; cVlrVenda, cVlrCusto: Currency);
    ////////////////////////////////////////////////////////////////////////////

    // Odir ====================================================================

    procedure FormShow(Sender: TObject);
    procedure MenuSAIRClick(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure MenuCalculadoraClick(Sender: TObject);
    procedure MenuVersaoClick(Sender: TObject);
    procedure PC_PrincipalChange(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure SubMenuProtUsuariosUsuariosClick(Sender: TObject);
    procedure Bt_UsuFechaClick(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure Bt_UsuPesqClick(Sender: TObject);
    procedure Bt_UsuNovaPesqClick(Sender: TObject);
    procedure Rb_UsuLocalizaNomeClick(Sender: TObject);
    procedure Bt_UsuLocalizaClick(Sender: TObject);
    procedure Dbg_UsuariosDblClick(Sender: TObject);
    procedure Bt_UsuNovoClick(Sender: TObject);
    procedure Bt_UsuDetalharClick(Sender: TObject);
    procedure Bt_UsuExcluirClick(Sender: TObject);
    procedure Bt_UsuManutVoltarClick(Sender: TObject);
    procedure Bt_UsuManutSalvarClick(Sender: TObject);
    procedure Bt_UsuManutSenhaClick(Sender: TObject);
    procedure EdtUsuManutSenhaAtualExit(Sender: TObject);
    procedure EdtUsuManutSenhaRepeteExit(Sender: TObject);
    procedure Bt_UsuManutSenhaSalvaClick(Sender: TObject);
    procedure SubMenuProtUsuariosPermissesdeAcessoClick(Sender: TObject);
    procedure Rb_UsuAtivoSimClick(Sender: TObject);
    procedure PopM_UsuSenhaPopup(Sender: TObject);
    procedure Bt_ConEmpresasBuscaEstadoClick(Sender: TObject);
    procedure Bt_ConEmpresasBuscaMunicipioClick(Sender: TObject);
    procedure Bt_ConEmpresasNovoClick(Sender: TObject);
    procedure Bt_ConEmpresasDetalharClick(Sender: TObject);
    procedure Bt_ConEmpresasDMLClick(Sender: TObject);
    procedure Bt_ConEmpresasVoltarClick(Sender: TObject);
    procedure Dbg_ConEmpresasTitleClick(Column: TColumn);
    procedure PC_OrdemCompraChange(Sender: TObject);
    procedure Ckb_GeraOCCalculoTransitoClick(Sender: TObject);
    procedure PC_FiltrosChange(Sender: TObject);
    procedure Ckb_GeraOCCalculoEstoqueClick(Sender: TObject);
    procedure EdtFiltroCodFornExit(Sender: TObject);
    procedure EdtFiltroCodGrupoExit(Sender: TObject);
    procedure EdtFiltroCodSubGrupoExit(Sender: TObject);
    procedure Dbg_FiltroFornecedoresKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FiltroGruposProdutosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FiltroSubGruposProdutosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_OCBuscaProdutosClick(Sender: TObject);
    procedure EdtOCCodAplicacaoExit(Sender: TObject);
    procedure Dbg_OCAplicacaoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtOCCodFamiliaPrecosExit(Sender: TObject);
    procedure Dbg_OCFamiliaPrecosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtFiltroCodGrupoSTExit(Sender: TObject);
    procedure Dbg_FiltroGrupoSTKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtFiltroCodProdutoExit(Sender: TObject);
    procedure Dbg_FiltroProdutoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtOCCodListaPrecoExit(Sender: TObject);
    procedure PC_GeraOCProdutoChange(Sender: TObject);
    procedure EdtGeraOCBuscaDoctoExit(Sender: TObject);
    procedure PC_GeraOCFiliaisChange(Sender: TObject);
    procedure PC_GeraOCApresentacaoChange(Sender: TObject);
    procedure Dbg_GeraOCProdutosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_GeraOCFiliaisKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_GeraOCGridKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_GeraOCGridDrawColumnCell(Sender: TObject;
              const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_GeraOCCalcularClick(Sender: TObject);
    procedure EdtGeraOCBuscaDoctoChange(Sender: TObject);
    procedure Bt_GeraOCGeraOCClick(Sender: TObject);
    procedure Bt_GeraOCImpEditOCClick(Sender: TObject);
    procedure Dbg_GeraOCTotalGeralDblClick(Sender: TObject);
    procedure Ckb_FiltroProdNaoCompraClick(Sender: TObject);
    procedure EdtGeraOCBuscaDoctoEnter(Sender: TObject);
    procedure Dbg_GeraOCGridColEnter(Sender: TObject);
    procedure Dbg_GeraOCGridColExit(Sender: TObject);
    procedure PopM_AuditoriaPopup(Sender: TObject);
    procedure Ts_OCBuscaProdutosEnter(Sender: TObject);
    procedure Ts_OCGeraOrdemCompraExit(Sender: TObject);
    procedure SubMenuComprasContaCorreteFornClick(Sender: TObject);
    procedure Bt_GeraOCBuscaDoctoClick(Sender: TObject);
    procedure Bt_OCBuscaListaPrecoClick(Sender: TObject);
    procedure Bt_FiltroBuscaGrupoSTClick(Sender: TObject);
    procedure Bt_FiltroBuscaFornClick(Sender: TObject);
    procedure Bt_FiltroBuscaProdtudoClick(Sender: TObject);
    procedure Bt_FiltroBuscaGrupoClick(Sender: TObject);
    procedure Bt_FiltroBuscaSubGrupoClick(Sender: TObject);
    procedure Bt_OCBuscaAplicacaoClick(Sender: TObject);
    procedure Bt_OCBuscaFamiliaPrecosClick(Sender: TObject);
    procedure Dbg_GeraOCEditaGridKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure PC_GeraOCEditaApresentacaoChange(Sender: TObject);
    procedure Bt_GeraOCEditaVoltarClick(Sender: TObject);
    procedure Rb_GeraOCEditaTodosItensClick(Sender: TObject);
    procedure SubMenuComprasGeraOCClick(Sender: TObject);
    procedure SubMenuComprasConsultaOCClick(Sender: TObject);
    procedure Bt_ConsultaOCBuscaOCsClick(Sender: TObject);
    procedure DtEdt_ConsultaOCDtInicioEditing(Sender: TObject; var CanEdit: Boolean);
    procedure DtEdt_ConsultaOCDtFimEditing(Sender: TObject; var CanEdit: Boolean);
    procedure EdtConsultaOCCodFornecedorChange(Sender: TObject);
    procedure EdtConsultaOCCodFornecedorExit(Sender: TObject);
    procedure Bt_ConsultaOCBuscaFornecedorClick(Sender: TObject);
    procedure Bt_ConsultaOCImprimeClick(Sender: TObject);
    procedure Ckb_ConsultaOCSelectEmpresasClick(Sender: TObject);
    procedure EdtConsultaOCNumOCChange(Sender: TObject);
    procedure Clbx_ConsultaOCEmpresasClick(Sender: TObject);
    procedure SubMenuProtUsuariosAlteraoBancodeDadosDMLClick(Sender: TObject);
    procedure SubMenuProtUsuariosBackupRestaureClick(Sender: TObject);
    procedure SubMenuComprasCurvaABCClick(Sender: TObject);
    procedure Bt_PlanFinanFecharClick(Sender: TObject);
    procedure SubMenuFinanComprPlanFinanceiraClick(Sender: TObject);
    procedure PC_FinanComprPlanFinanChange(Sender: TObject);
    procedure Dbg_FinanComprovantesColEnter(Sender: TObject);
    procedure Dbg_FinanComprovantesTitleClick(Column: TColumn);
    procedure EdtFinanComprovantesLocalizarChange(Sender: TObject);
    procedure Bt_FinanComprovantesDetalharClick(Sender: TObject);
    procedure Bt_FinanManutComprovVoltarClick(Sender: TObject);
    procedure Ckb_FinanManutComprovPlanilhaClick(Sender: TObject);
    procedure Ckb_FinanManutComprovAtivoClick(Sender: TObject);
    procedure Bt_FinanManutComprovSalvarClick(Sender: TObject);
    procedure Bt_FinanManutComprovBuscaGrFinanceiroClick(Sender: TObject);
    procedure Dbe_FinanManutComprovCodGrFinanceiroExit(Sender: TObject);
    procedure Ts_FinanComprPlanFinanManutGrFinanceiroExit(Sender: TObject);
    procedure Ts_FinanComprPlanFinanManutGrFinanceiroEnter(Sender: TObject);
    procedure Btg_FinanGrupoFinanSalvarClick(Sender: TObject);
    procedure Bt_FinanGrFinanNovoClick(Sender: TObject);
    procedure Bt_FinanGrFinanAlterarClick(Sender: TObject);
    procedure Bt_FinanGrFinanSalvarClick(Sender: TObject);
    procedure Dbg_FinanGrFinanceiroTitleClick(Column: TColumn);
    procedure Bt_FinanGrFinanAbandonarClick(Sender: TObject);
    procedure Dbg_FinanGrFinanceiroDblClick(Sender: TObject);
    procedure Bt_FinanGrFinanExcluirClick(Sender: TObject);
    procedure Bt_FinanComprPlanFinanPlanilhaClick(Sender: TObject);
    procedure Bt_FinanPlanFinanceiraVoltarClick(Sender: TObject);
    procedure Dbg_FinanPlanFinanceiraColEnter(Sender: TObject);
    procedure Dbg_FinanPlanFinanceiraDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanPlanFinanceiraKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanPlanFinanceiraTempoCalculoVoltarClick(Sender: TObject);
    procedure Ckb_FinanManutComprovSomaGrupoClick(Sender: TObject);
    procedure Dbg_FinanPlanFinanceiraColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanPlanFinanceiraDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Bt_FinanPlanFinanceiraTamColunasClick(Sender: TObject);
    procedure Ckb_FinanGrFinanAtivoClick(Sender: TObject);
    procedure Bt_FinanGrFinanVoltarClick(Sender: TObject);
    procedure Dbe_FinanManutComprovFormulaExit(Sender: TObject);
    procedure Ckb_FinanManutComprovPlanilhaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FinanManutComprovSomaGrupoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FinanManutComprovAtivoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_GeraOCCalculoTransitoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_GeraOCCalculoEstoqueKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FinanGrFinanAtivoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_ConsultaOCSelectEmpresasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FiltroProdNaoCompraKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanComprovantesColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanComprovantesDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanComprovantesDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_FinanComprovantesKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanComprovantesNovoClick(Sender: TObject);
    procedure PopM_PlanFinanceiraSalvarClick(Sender: TObject);
    procedure PopM_PlanFinanceiraSinteticoClick(Sender: TObject);
    procedure PopM_PlanFinanceiraAnaliticoClick(Sender: TObject);
    procedure Bt_FinanPlanFinanceiraCalcularClick(Sender: TObject);
    procedure Bt_FinanDemonsResultBuscaGrFinanceiroClick(Sender: TObject);
    procedure PC_FinanComprPlanFinanDemonsResultadosChange(Sender: TObject);
    procedure Bt_FinanPlanDemonsResultadosClick(Sender: TObject);
    procedure Bt_FinanDemonsResultVoltarClick(Sender: TObject);
    procedure EdtFinanDemonsResultCodVisaoExit(Sender: TObject);
    procedure Bt_FinanDemonsResultCadVisaoClick(Sender: TObject);
    procedure Bt_FinanDemonsResultBuscaVisaoClick(Sender: TObject);
    procedure EdtFinanDemonsResultDesVisaoChange(Sender: TObject);
    procedure Bt_FinanDemonsResultNovoClick(Sender: TObject);
    procedure Bt_FinanDemonsResultAbandonarClick(Sender: TObject);
    procedure Bt_FinanDemonsResultAlterarClick(Sender: TObject);
    procedure Bt_FinanDemonsResultExcluirClick(Sender: TObject);
    procedure Bt_FinanDemonsResultSalvarClick(Sender: TObject);
    procedure EdtFinanGrFinanUsuarioCodExit(Sender: TObject);
    procedure Bt_FinanGrFinanUsuarioExcluiClick(Sender: TObject);
    procedure Bt_FinanGrFinanUsuarioIncluiTodosClick(Sender: TObject);
    procedure Bt_FinanGrFinanUsuarioExcluiTodosClick(Sender: TObject);
    procedure Bt_FinanGrFinanUsuarioBuscaClick(Sender: TObject);
    procedure Bt_FinanDemonsResultExcVisaoClick(Sender: TObject);
    procedure Bt_FinanDemonsResultGeraResultClick(Sender: TObject);
    procedure Dbg_FinanDemonsResultPlanDemonsColEnter(Sender: TObject);
    procedure Dbg_FinanDemonsResultPlanDemonsColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanDemonsResultPlanDemonsDrawColumnCell(
      Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanDemonsResultPlanDemonsDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Bt_FinanDemonsResultPlanDemonsVoltarClick(Sender: TObject);
    procedure Bt_FinanDemonsResultPlanDemonsSalvarClick(Sender: TObject);
    procedure Bt_FinanDemonsResultPlanDemonsTamColunasClick(Sender: TObject);
    procedure PC_CurvaABCEnderecamentosChange(Sender: TObject);
    procedure Bt_CurvaABCEndCalculoCurvaABCClick(Sender: TObject);
    procedure Bt_CurvaABCEndVoltarClick(Sender: TObject);
    procedure Rb_CurvaABCEndTipoCalculoUnidadesClick(Sender: TObject);
    procedure Dbg_FinanDemonsResultPlanDemonsKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanPlanoContasCP200FecharClick(Sender: TObject);
    procedure SubMenuFinanPlanodeContasComprov200Click(Sender: TObject);
    procedure Dbg_FinanPlanoContasCompr200ColEnter(Sender: TObject);
    procedure Dbg_FinanPlanoContasCompr200ColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanPlanoContasCompr200DrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_FinanPlanoContasCompr200KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanPlanoContasCompr200DrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_FinanPlanoContasCP200CalcularClick(Sender: TObject);
    procedure Bt_FinanPlanoContasCP200SalvarClick(Sender: TObject);
    procedure Bt_FinanPlanoContasCP200TamColunasClick(Sender: TObject);
    procedure SubMenuFinanObjetivosClick(Sender: TObject);
    procedure PC_FinanObjetivosChange(Sender: TObject);
    procedure Bt_FinanObjetivosFecharClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutAtivoClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutVlrFixoClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutVlrFixoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FinanObjetivosManutAtivoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanObjetivosNovoClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutAbandonarClick(Sender: TObject);
    procedure Bt_FinanObjetivosAlterarClick(Sender: TObject);
    procedure Bt_FinanObjetivosExcluirClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutSalvarClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutObjetivosClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutObjetivosAbandonarClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutObjetivosSalvarClick(Sender: TObject);
    procedure EdtFinanObjetivosAnoExit(Sender: TObject);
    procedure Dbe_FinanObjetivosManutDesObjetivoChange(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaSinalAbreParentesClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaExcluirClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaSinalFechaParentesClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaSinalSomaClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaSinalSubtraiClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaSinalMultiplicaClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaSinalDivideClick(Sender: TObject);
    procedure Bt_FinanObjetivosManutFormulaComprovanteClick(Sender: TObject);
    procedure Bt_FinanObjetivosGeraObjetivosClick(Sender: TObject);
    procedure Cbx_FinanObjetivosGerarMesExit(Sender: TObject);
    procedure EdtFinanObjetivosGerarAnoExit(Sender: TObject);
    procedure Dbg_FinanObjetivosResultadosDiasColEnter(Sender: TObject);
    procedure Dbg_FinanObjetivosResultadosDiasColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanObjetivosResultadosDiasDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanObjetivosResultadosDiasKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanObjetivosManutFormulaTextoClick(Sender: TObject);
    procedure Bt_FinanObjetivosResultDiasSalvarClick(Sender: TObject);
    procedure Bt_FinanObjetivosResultDiasTamColunasClick(Sender: TObject);
    procedure SubMenuFinanControleFeriadosAno1Click(Sender: TObject);
    procedure Bt_FinanFeriadosAnoFecharClick(Sender: TObject);
    procedure Cbx_FinanFeriadosAnoMesExit(Sender: TObject);
    procedure EdtFinanFeriadosAnoAnoExit(Sender: TObject);
    procedure EdtFinanFeriadosAnoDiaFeriadoExit(Sender: TObject);
    procedure Dbg_FinanFeriadosAnoDatasFeriadoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanFeriadosAnoDatasFeriadoDblClick(Sender: TObject);
    procedure Bt_FinanFeriadosAnoAbandonarClick(Sender: TObject);
    procedure Bt_FinanFeriadosAnoSalvarClick(Sender: TObject);
    procedure Cbx_FinanFeriadosAnoMesSelect(Sender: TObject);
    procedure Dbg_FinanObjetivosResultadosDiasDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Cbx_FinanObjetivosGerarMesChange(Sender: TObject);
    procedure DtEdt_FinanObjetivosGerarUltDiaExit(Sender: TObject);
    procedure SubMenuComprasEstoqueFisicoFinanceiroClick(Sender: TObject);
    procedure PC_EstoqueFisicoFinanChange(Sender: TObject);
    procedure EdtEstFisFinanCodListaPrecoExit(Sender: TObject);
    procedure Bt_EstFisFinanBuscaListaPrecoClick(Sender: TObject);
    procedure Bt_EstFisFinanVoltarClick(Sender: TObject);
    procedure Bt_EstFisFinanBuscaEstoquesClick(Sender: TObject);
    procedure Bt_EstFisFinanSalvarEmpresaClick(Sender: TObject);
    procedure Dbg_EstFisFinanEmpresaColEnter(Sender: TObject);
    procedure Dbg_EstFisFinanLojasColEnter(Sender: TObject);
    procedure Dbg_EstFisFinanEmpresaColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_EstFisFinanLojasColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_EstFisFinanEmpresaDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_EstFisFinanLojasDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_EstFisFinanEmpresaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_EstFisFinanLojasKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_EstFisFinanEmpresaDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_EstFisFinanLojasDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_EstFisFinanSalvarLojasClick(Sender: TObject);
    procedure PC_CurvaABCFornEndChange(Sender: TObject);
    procedure Bt_CurvaABCEndDistrEnderecoClick(Sender: TObject);
    procedure Dbg_FinanObjetivosManutEmpresasKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanObjetivosGraficoVoltarClick(Sender: TObject);
    procedure Bt_FinanObjetivosDiasGraficosClick(Sender: TObject);
    procedure Cbx_FinanObjetivosGraficoObjetivosChange(Sender: TObject);
    procedure Rb_FinanObjetivosGraficoTpBarrasClick(Sender: TObject);
    procedure Ckb_FinanObjetivosGraficoMouseClick(Sender: TObject);
    procedure DbGrafico_FinanObjetivosGraficoMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
    procedure Sb_FinanObjetivosGrafico3DChange(Sender: TObject);
    procedure Ckb_FinanObjetivosGrafico3DClick(Sender: TObject);
    procedure Bt_FinanObjetivosGraficoSalvarClick(Sender: TObject);
    procedure Cbx_FinanObjetivosGraficoTpApresChange(Sender: TObject);
    procedure Ckb_FinanObjetivosGraficoValorVerticalClick(Sender: TObject);
    procedure Cbx_FinanObjetivosGraficoTpApresClick(Sender: TObject);
    procedure Dbg_FinanObjetivosManutDblClick(Sender: TObject);
    procedure Dbg_FinanObjetivosManutTitleClick(Column: TColumn);
    procedure Dbg_FinanObjetivosManutDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Rb_FinanObjetivosManutTpOperacaoLojaClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutAuditoriaClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutAuditoriaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanObjetivosResultadosDiasCellClick(Column: TColumn);
    procedure Bt_FinanObjetivosMarcaTodosClick(Sender: TObject);
    procedure Bt_FinanObjetivosDesMarcaTodosClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutAvariasClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutAvariasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanObjetivosResultadosMesesCellClick(Column: TColumn);
    procedure Dbg_FinanObjetivosResultadosMesesColEnter(Sender: TObject);
    procedure Dbg_FinanObjetivosResultadosMesesColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanObjetivosResultadosMesesDrawColumnCell(Sender: TObject;
              const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanObjetivosResultadosMesesDrawDataCell(
      Sender: TObject; const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_FinanObjetivosResultadosMesesKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanObjetivosResultMesesSalvarClick(Sender: TObject);
    procedure Bt_FinanObjetivosResultMesesTamColunasClick(Sender: TObject);
    procedure Bt_FinanObjetivosResultMesesVoltarClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutNaoCompraClick(Sender: TObject);
    procedure Cbx_CurvaABCEndZonaChange(Sender: TObject);
    procedure Bt_CurvaABCEndLocalizaProdClick(Sender: TObject);
    procedure EdtCurvaABCEndCodProdExit(Sender: TObject);
    procedure Image1DblClick(Sender: TObject);
    procedure EdtVersaoStop(Sender: TObject);
    procedure Dbg_GeraOCFiliaisDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_FinanAuditoriaManutFecharClick(Sender: TObject);
    procedure PC_FinanAuditoriaChange(Sender: TObject);
    procedure EdtFinanAuditoriaManutCodLojaChange(Sender: TObject);
    procedure EdtFinanAuditoriaManutCodLojaExit(Sender: TObject);
    procedure Bt_FinanAuditoriaManutBuscaLojaClick(Sender: TObject);
    procedure DtEdtFinanAuditoriaDataPropertiesEditValueChanged(Sender: TObject);
    procedure Bt_FinanAuditoriaManutAbandonarClick(Sender: TObject);
    procedure Dbe_FinanAuditoriaManutVlrNegRealExit(Sender: TObject);
    procedure Dbe_FinanAuditoriaManutVlrEstInicialExit(Sender: TObject);
    procedure DtEdtFinanAuditoriaManutDataExit(Sender: TObject);
    procedure Dbe_FinanAuditoriaManutQtdEstInicialExit(Sender: TObject);
    procedure Bt_FinanAuditoriaManutSalvarClick(Sender: TObject);
    procedure Dbe_FinanAuditoriaManutPerAdmissivelExit(Sender: TObject);
    procedure Bt_FinanAuditoriaManutBuscaAuditoriaClick(Sender: TObject);
    procedure DtEdtFinanAuditoriaManutDataKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DBNav_FInainAuditoriaManutClick(Sender: TObject; Button: TNavigateBtn);
    procedure Dbe_FinanAuditoriaManutVlrNegRealChange(Sender: TObject);
    procedure Bt_FinanObjetivosResultAuditSalvarClick(Sender: TObject);
    procedure Dbg_FinanObjetivosResultadosAuditoriaDrawColumnCell(Sender: TObject;
              const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_FinanObjetivosResultAuditVoltarClick(Sender: TObject);
    procedure Bt_FinanAuditoriaManutExcluirClick(Sender: TObject);
    procedure Bt_GeraOCRecalculoLojaClick(Sender: TObject);
    procedure Bt_ConsultaNFeEmpresaClick(Sender: TObject);
    procedure Bt_ConsultaNFeLojasClick(Sender: TObject);
    procedure Bt_ConsultaNFeNotasClick(Sender: TObject);
    procedure Bt_ConsultaNFeBuscaOCsClick(Sender: TObject);
    procedure DtEdt_ConsultaNFeDtFimEditing(Sender: TObject; var CanEdit: Boolean);
    procedure Dbg_ConsultaNFeNotasLojasDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_ConsultaNFeSalvarClipboardClick(Sender: TObject);
    procedure Bt_ConsultaNFeSalvarCSVClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutUlt12MesesClick(Sender: TObject);
    procedure Ckb_FinanObjetivosManutUlt12MesesKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure EdtFinanObjetivosGerarAnoClick(Sender: TObject);
    procedure EdtFinanObjetivosGerarAnoEditing(Sender: TObject; var CanEdit: Boolean);
    procedure EdtFinanObjetivosGerarAnoDblClick(Sender: TObject);
    procedure SubMenuFinanAuditoriaManutencaoClick(Sender: TObject);
    procedure SubMenuFinanAuditoriaAnaliseClick(Sender: TObject);
    procedure EdtFinanAuditoriaAnaliseCodLojaExit(Sender: TObject);
    procedure Bt_FinanAuditoriaAnaliseBuscaAuditoriaClick(Sender: TObject);
    procedure Bt_FinanAuditoriaAnaliseBuscaLojaClick(Sender: TObject);
    procedure Dbg_FinanAuditoriaAnaliseDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_FinanAuditoriaAnaliseFecharClick(Sender: TObject);
    procedure Bt_FinanAuditoriaAnaliseSalvarClick(Sender: TObject);
    procedure Bt_FinanAuditoriaAnaliseExcluirClick(Sender: TObject);
    procedure Bt_FinanObjetivosResultDiasVoltarClick(Sender: TObject);
    procedure Ckb_CalculoCurvaTodasClick(Sender: TObject);
    procedure Ckb_CalculoCurvaTodasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_CalculoCurvaAClick(Sender: TObject);
    procedure Ckb_CalculoCurvaAKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_CalculoCurvaBKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_CalculoCurvaBClick(Sender: TObject);
    procedure Ckb_CalculoCurvaCClick(Sender: TObject);
    procedure Ckb_CalculoCurvaCKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_CalculoCurvaDClick(Sender: TObject);
    procedure Ckb_CalculoCurvaDKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_CalculoCurvaEClick(Sender: TObject);
    procedure Ckb_CalculoCurvaEKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_EstFisFinanCurvaTodasClick(Sender: TObject);
    procedure Ckb_EstFisFinanCurvaTodasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_EstFisFinanCurvaAClick(Sender: TObject);
    procedure Ckb_EstFisFinanCurvaAKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_EstFisFinanCurvaBClick(Sender: TObject);
    procedure Ckb_EstFisFinanCurvaBKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_EstFisFinanCurvaCClick(Sender: TObject);
    procedure Ckb_EstFisFinanCurvaCKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_EstFisFinanCurvaDClick(Sender: TObject);
    procedure Ckb_EstFisFinanCurvaDKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_EstFisFinanCurvaEClick(Sender: TObject);
    procedure Ckb_EstFisFinanCurvaEKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_EstFisFinanGiroEstoquesClick(Sender: TObject);
    procedure Dbg_EstFisFinanGiroEstoqueDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_EstFisFinanGiroEstoqueSalvarClick(Sender: TObject);
    procedure Rb_EstFisFinanSaldoTodosClick(Sender: TObject);
    procedure Rb_EstFisFinanSqlSaldoTodosClick(Sender: TObject);
    procedure Ckb_EstFisFinanGiroTransfClick(Sender: TObject);
    procedure Ckb_EstFisFinanGiroTransfKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Rb_EstFisFinanSqlSaldoTodosKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_CurvaABCMixProdDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_CurvaABCMixProdKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure SubMenuComprasMovtoComprovFornecedorClick(Sender: TObject);
    procedure Rb_CalculoTpCurvaABCLojaClick(Sender: TObject);
    procedure Rb_CalculoTpCurvaABCMixClick(Sender: TObject);
    procedure Ckb_CalculoApresCurvaForaClick(Sender: TObject);
    procedure Dbg_GeraOCEditaGridDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure EdtFiltroCodComprovExit(Sender: TObject);
    procedure Bt_FiltroBuscaComprovClick(Sender: TObject);
    procedure Dbg_FiltroComprovKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Rb_ConsultaNFeApresAnaliticaClick(Sender: TObject);
    procedure Rb_ConsultaNFeTpMovtoAmbosClick(Sender: TObject);
    procedure Ckb_ConsultaNFeParticipacaoClick(Sender: TObject);
    procedure Ckb_ConsultaNFeParticipacaoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure SubMenuFinanFechamentoCaixaClick(Sender: TObject);
    procedure Bt_FinanFechaCaixaFecharClick(Sender: TObject);
    procedure EdtFinanFechaCaixaCodLojaChange(Sender: TObject);
    procedure EdtFinanFechaCaixaCodLojaExit(Sender: TObject);
    procedure Bt_FinanFechaCaixaBuscaLojaClick(Sender: TObject);
    procedure DtEdtFinanFechaCaixaDataExit(Sender: TObject);
    procedure DtEdtFinanFechaCaixaDataKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure DtEdtFinanFechaCaixaDataEnter(Sender: TObject);
    procedure EdtFinanFechaCaixaCodDoctoExit(Sender: TObject);
    procedure Bt_FinanFechaCaixaBuscaDoctoClick(Sender: TObject);
    procedure Dbg_FinanFechaCaixaDoctosDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure EdtFinanFechaCaixaVlrDoctoExit(Sender: TObject);
    procedure EdtFinanFechaCaixaCodDoctoChange(Sender: TObject);
    procedure Dbg_FinanFechaCaixaDoctosDblClick(Sender: TObject);
    procedure Dbg_FinanFechaCaixaTotalDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure DtEdtFinanFechaCaixaDataPropertiesChange(Sender: TObject);
    procedure SubMenuFinanFechamentoDiarioLojasClick(Sender: TObject);
    procedure PC_FinanFechaDiarioChange(Sender: TObject);
    procedure Bt_FinanFechaDiarioFecharClick(Sender: TObject);
    procedure EdtFinanFechaDiarioCodLojaExit(Sender: TObject);
    procedure EdtFinanFechaDiarioCodLojaChange(Sender: TObject);
    procedure Bt_FinanFechaDiarioBuscaLojaClick(Sender: TObject);
    procedure DtEdtFinanFechaDiarioDataPropertiesChange(Sender: TObject);
    procedure DtEdtFinanFechaDiarioDataPropertiesCloseUp(Sender: TObject);
    procedure DtEdtFinanFechaDiarioDataEnter(Sender: TObject);
    procedure DtEdtFinanFechaDiarioDataExit(Sender: TObject);
    procedure DtEdtFinanFechaDiarioDataKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanFechaDiarioTotaisDrawColumnCell(Sender: TObject; const Rect: TRect;
      DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_FinanFechaDiarioPagtoClick(Sender: TObject);
    procedure Bt_FinanFechaDiarioDepositoClick(Sender: TObject);
    procedure Bt_FinanFechaDiarioVlrRecebidoClick(Sender: TObject);
    procedure BT_FinanFechaDiarioConfirmarClick(Sender: TObject);
    procedure Bt_FinanFechaDiarioAbandonarClick(Sender: TObject);
    procedure Bt_FinanFechaDiarioExcluirClick(Sender: TObject);
    procedure Bt_FinanFechaDiarioAlterarClick(Sender: TObject);
    procedure Ckb_FinanFechaDiarioRealizadoClick(Sender: TObject);
    procedure SBt_SairClick(Sender: TObject);
    procedure Ckb_FinanFechaDiarioRealizadoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Gb_FinanFechaDiarioManutExit(Sender: TObject);
    procedure Bt_FinanFechaCaixaVerificaClick(Sender: TObject);
    procedure Ckb_FinanFechaCaixaSomarClick(Sender: TObject);
    procedure Bt_FinanFechaCaixaSituacaoClick(Sender: TObject);
    procedure Bt_FinanFechaCaixaAnaliseClick(Sender: TObject);
    procedure EdtCurvaABCEndCodListaExit(Sender: TObject);
    procedure Bt_CurvaABCEndBuscaListaClick(Sender: TObject);
    procedure Dbg_CurvaABCEndCurvaABCDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_OCsLojasClick(Sender: TObject);
    procedure SubMenuFinanMargemLucroClick(Sender: TObject);
    procedure Bt_FinanMLVoltarClick(Sender: TObject);
    procedure Bt_FinanMLBuscarClick(Sender: TObject);
    procedure Dbg_FinanMargemLucroColEnter(Sender: TObject);
    procedure Dbg_FinanMargemLucroColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanMargemLucroDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanMargemLucroDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_FinanMargemLucroKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanMLSalvaClipboardClick(Sender: TObject);
    procedure Bt_FinanMLSalvaCSVClick(Sender: TObject);
    procedure Dbg_FinanMargemLucroTitleClick(Column: TColumn);
    procedure PC_FinanMargemLucroChange(Sender: TObject);
    procedure Bt_FinanMLRFVoltarClick(Sender: TObject);
    procedure Bt_FinanMLBVoltarClick(Sender: TObject);
    procedure Dbg_FinanMargemLucroBonifColEnter(Sender: TObject);
    procedure Dbg_FinanMargemLucroBonifColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanMargemLucroBonifDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_FinanMargemLucroBonifKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanMargemLucroBonifDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_FinanMLBSalvaClipboardClick(Sender: TObject);
    procedure Bt_FinanMLBSalvaCSVClick(Sender: TObject);
    procedure Bt_FinanMLRSalvaClipboardClick(Sender: TObject);
    procedure Bt_FinanMLRFSalvaCSVClick(Sender: TObject);
    procedure Dbe_ConEmpresasCodLPExit(Sender: TObject);
    procedure Dbg_FinanMLResultadoDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanMLResFinalDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Bt_FinanMLFiltrosFecharClick(Sender: TObject);
    procedure Bt_FinanMLRFSalvaClipboardClick(Sender: TObject);
    procedure Bt_FOSomaClick(Sender: TObject);
    procedure Rb_MLTpCalculoMarkUpClick(Sender: TObject);
    procedure Rb_MLTpCalculoMarkUpKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanMLFValtarClick(Sender: TObject);
    procedure Dbg_FinanMLFornCellClick(Column: TColumn);
    procedure Dbg_FinanMLFornColEnter(Sender: TObject);
    procedure Dbg_FinanMLFornColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanMLFornDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanMLFornDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_FinanMLFornKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanMLFornTitleClick(Column: TColumn);
    procedure Bt_FinanMLFSinteticoClick(Sender: TObject);
    procedure Bt_FinanMLFSalvaClipboardClick(Sender: TObject);
    procedure Bt_FinanMLScrollSalvaClipboardClick(Sender: TObject);
    procedure Bt_FinanMLFSalvaCSVClick(Sender: TObject);
    procedure Bt_FinanMLFormulasClick(Sender: TObject);
    procedure Bt_FinanMLFFormulasClick(Sender: TObject);
    procedure Bt_FinanMLFGraficosClick(Sender: TObject);
    procedure Rb_FinanObjetivosGraficoTpBarrasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FinanObjetivosGraficoValorVerticalKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FinanObjetivosGraficoMouseKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Ckb_FinanObjetivosGrafico3DKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Rb_FinanObjetivosGraficoTpBMPClick(Sender: TObject);
    procedure Rb_FinanObjetivosGraficoTpBMPKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanMargemLucroScrollCellClick(Column: TColumn);
    procedure Dbg_FinanMargemLucroScrollColEnter(Sender: TObject);
    procedure Dbg_FinanMargemLucroScrollColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
    procedure Dbg_FinanMargemLucroScrollDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
    procedure Dbg_FinanMargemLucroScrollDrawDataCell(Sender: TObject;
      const Rect: TRect; Field: TField; State: TGridDrawState);
    procedure Dbg_FinanMargemLucroScrollKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Dbg_FinanMargemLucroScrollTitleClick(Column: TColumn);
    procedure FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_FinanMLTamColClick(Sender: TObject);
    procedure Rb_CalculoApresCurvaEstComClick(Sender: TObject);
    procedure Rb_CalculoApresCurvaEstComKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Rb_CalculoTpCurvaABCMixKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_AudCompVendFecharClick(Sender: TObject);
    procedure SubMenuFinanAuditoriaCompVendasClick(Sender: TObject);
    procedure Bt_AudCompVendBuscaMovtoClick(Sender: TObject);
    procedure Bt_AudCompVendVoltarClick(Sender: TObject);
    procedure Bt_AudCompVendSalvaClipboardClick(Sender: TObject);
    procedure Bt_AudCompVendSalvaCSVClick(Sender: TObject);
    procedure Bt_FinanConciliacaoFecharClick(Sender: TObject);
    procedure SubMenuFinanBancosClick(Sender: TObject);
    procedure SubMenuFinanConciliaPagtosClick(Sender: TObject);
    procedure SubMenuFinanExtratosClick(Sender: TObject);
    procedure SubMenuFaltasReposicoesCDLojasClick(Sender: TObject);
    procedure SubMenuSalaoProfissionaisClick(Sender: TObject);
    procedure SubMenuSalaoHabilidadesServicosClick(Sender: TObject);
    procedure SubMenuSalaoMetasClick(Sender: TObject);
    procedure SubMenuPlanilhaPagtosClick(Sender: TObject);
    procedure Rb_UsuAtivoSimKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Rb_UsuAtivoNaoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Rb_UsuAtivoAmbosKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure Bt_OCsImportadasClick(Sender: TObject);
    procedure SubMenuParametrosClick(Sender: TObject);
    procedure Dbg_ConEmpresasEnter(Sender: TObject);
    procedure Dbg_ConEmpresasExit(Sender: TObject);
    procedure Dbg_GeraOCProdutosExit(Sender: TObject);
    procedure Dbg_GeraOCProdutosEnter(Sender: TObject);
    procedure Dbg_GeraOCEditaProdutosExit(Sender: TObject);
    procedure Dbg_GeraOCEditaProdutosEnter(Sender: TObject);
    procedure Dbg_EstFisFinanEmpresaEnter(Sender: TObject);
    procedure Dbg_EstFisFinanEmpresaExit(Sender: TObject);
    procedure Dbg_FinanGrFinanceiroExit(Sender: TObject);
    procedure Dbg_FinanGrFinanceiroEnter(Sender: TObject);
    procedure Dbg_FinanDemonsResultadoEnter(Sender: TObject);
    procedure Dbg_FinanDemonsResultadoExit(Sender: TObject);
    procedure Dbg_FinanObjetivosManutExit(Sender: TObject);
    procedure Dbg_FinanObjetivosManutEnter(Sender: TObject);
    procedure Dbg_FinanObjetivosManutEmpresasEnter(Sender: TObject);
    procedure Dbg_FinanObjetivosManutEmpresasExit(Sender: TObject);
    procedure Dbg_FinanMLFornEnter(Sender: TObject);
    procedure Dbg_FinanMLFornExit(Sender: TObject);
    procedure Dbg_FiltroGruposProdutosExit(Sender: TObject);
    procedure Dbg_FiltroGruposProdutosEnter(Sender: TObject);
    procedure SubMenuEmpConexoesSairClick(Sender: TObject);
    procedure SubMenuEmpresasConexoesClick(Sender: TObject);
    procedure SubMenuSalaoMovimentosDebitosRHClick(Sender: TObject);
    procedure SubMenuControledeKitzClick(Sender: TObject);
    procedure SubMenuSolicitacaoCompraLojaClick(Sender: TObject);
    procedure Ckb_CalculoApresCurvaForaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure SubMenuParmetrosdeLojasClick(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure Panel5DblClick(Sender: TObject);
    procedure SubMenuSalaoPlanoSaudeClick(Sender: TObject);
    procedure Sbt_FinanMLResFinalClick(Sender: TObject);
    procedure Dbg_FinanMLResultadoDblClick(Sender: TObject);
    procedure ApplicationEvents1Message(var Msg: tagMSG;
      var Handled: Boolean);
    procedure Dbg_FinanMargemLucroEnter(Sender: TObject);
    procedure Bt_GeraOCDocSeparacaoClick(Sender: TObject);
    procedure Dbg_GeraOCTotalGeralDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn;
      State: TGridDrawState);
    procedure PopM_OCRomaneioMarcarOCsAbertasClick(Sender: TObject);
    procedure PopM_OCRomaneioMarcarRomaneiosAbertosClick(Sender: TObject);
    procedure PopM_OCRomaneioMarcarRomaneiosFechadosClick(Sender: TObject);
    procedure PopM_OCRomaneioDesmarcarRomaneiosDesmarcarClick(
      Sender: TObject);
    procedure SubMenuFinanConciliacaoCaixaClick(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure DtEdt_ConsultaNFeDtInicioEditing(Sender: TObject;
      var CanEdit: Boolean);
    procedure Dbg_ConsultaNFeNotasLojasKeyDown(Sender: TObject;
      var Key: Word; Shift: TShiftState);
    procedure PC_ConsultaMovtoComprChange(Sender: TObject);
    procedure PC_AudCompVendChange(Sender: TObject);
    procedure SubMenuFinanVerificaExtratosClick(Sender: TObject);
    procedure SubMenuFinanExpImpArquivosProSoft1Click(Sender: TObject);
    procedure PopM_PlanFinanceiraMemoriaClick(Sender: TObject);
    procedure SubMenuProtUsuariosPermAcessoSIDICOMClick(Sender: TObject);
    procedure Rb_ConsultaNFeTpMovtoAmbosKeyUp(Sender: TObject;
      var Key: Word; Shift: TShiftState);
    procedure Rb_CurvaABCEndTipoCalculoUnidadesKeyUp(Sender: TObject;
      var Key: Word; Shift: TShiftState);
    procedure Bt_CurvaABCEndSalvaProdClipboardClick(Sender: TObject);
    procedure SubMenuComprasEstoquesMinimoDemadasClick(Sender: TObject);
    procedure Rb_GeraOCEditaTodosItensKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure CkB_CalculoTransitoClick(Sender: TObject);
    procedure CkB_CalculoTransitoKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure Dbg_FinanDemonsResultadoDblClick(Sender: TObject);
    procedure Bt_GeraOCExcluirClick(Sender: TObject);
    procedure PopM_GeraOCVoltar1Click(Sender: TObject);
    procedure PopM_GeraOCLegendaCoresClick(Sender: TObject);
    procedure PopM_GeraOCCalculaTransfernciasCDClick(Sender: TObject);
    procedure PopM_GeraOCExportaParaOutroDoctoClick(Sender: TObject);
    procedure PopM_GeraOCImportaSolicitcoesLojasClick(Sender: TObject);
    procedure PopM_GeraOCComparaPedidosClick(Sender: TObject);
    procedure PopM_GeraOCValorUnitarioClick(Sender: TObject);
    procedure PopM_GeraOCPercDescontoClick(Sender: TObject);
    procedure PopM_GeraOCPercelDescMIXClick(Sender: TObject);
    procedure PopM_GeraOCVerTransitoClick(Sender: TObject);
    procedure PopM_GeraOCOCsOrigemClick(Sender: TObject);
    procedure Bt_ConEmpresasUsuWindowsClick(Sender: TObject);
    procedure SubMenuMenuGerenciaContasPagarClick(Sender: TObject);
    procedure SubMenuMenuGerenciaContasReceberClick(Sender: TObject);
    procedure SubMenuCentroDistrReposicoesLojasClick(Sender: TObject);
    procedure SubMenuCentralTrocasNotasEntradaDevolucaoClick(Sender: TObject);
    procedure SubMenuAtualizaTabelasSPEDClick(Sender: TObject);
    procedure SubMenuVerificaImportacaoEstoquesClick(Sender: TObject);
    procedure DiasInformadosClick(Sender: TObject);
    procedure DiasEstocagemParametroClick(Sender: TObject);
    procedure Bt_GeraOCPreVisualizaOCClick(Sender: TObject);
    procedure ZeraQuantidadeAComprarClick(Sender: TObject);
    procedure Rb_CalculoTpProcLocalKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure Rb_CalculoTpProcLocalClick(Sender: TObject);
    procedure SubMenuSalaoRelatoriosClick(Sender: TObject);
    procedure Ckb_EstFisFinanGiroEstoqueEmpClick(Sender: TObject);
    procedure Ckb_EstFisFinanGiroEstoqueEmpKeyUp(Sender: TObject;
      var Key: Word; Shift: TShiftState);
    procedure MenuEstoquesSimuladorEstoquesClick(Sender: TObject);
    procedure SubMenuCentroDistAnaliseReposicoesClick(Sender: TObject);
    procedure Ckbx_ConsultaNFeApresParcelaClick(Sender: TObject);
    procedure Ckbx_ConsultaNFeApresParcelaKeyUp(Sender: TObject;
      var Key: Word; Shift: TShiftState);
    procedure SubMenuComisVendedoresClick(Sender: TObject);
    procedure ParametrosVendedores1Click(Sender: TObject);
    procedure Dbg_ConsultaNFeProdutosDrawColumnCell(Sender: TObject;
      const Rect: TRect; DataCol: Integer; Column: TColumn;
      State: TGridDrawState);
    procedure Ckbx_ConsultaNFeApresTotaisClick(Sender: TObject);
    procedure Ckbx_ConsultaNFeApresTotaisKeyUp(Sender: TObject;
      var Key: Word; Shift: TShiftState);
    procedure SubMenuCentroDistQtdCaixaCDClick(Sender: TObject);
    procedure Dbe_ConEmpresasCodLojaLinxKeyPress(Sender: TObject;
      var Key: Char);
    procedure EdtDta_ConEmpresasInicioLinxPropertiesChange(
      Sender: TObject);
    procedure Dbe_ConEmpresasCodLojaLinxExit(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure Dbg_FinanObjetivosManutEmpresasDrawColumnCell(
      Sender: TObject; const Rect: TRect; DataCol: Integer;
      Column: TColumn; State: TGridDrawState);
    procedure Ckb_FinanObjetivosManutNaoCompraKeyUp(Sender: TObject;
      var Key: Word; Shift: TShiftState);
    procedure Bt_AcertaPromocaoClick(Sender: TObject);
    procedure Button4Click(Sender: TObject);
    procedure SubMenuComprasGeraOCLinxClick(Sender: TObject);
    procedure EdtFiltroCodProdLinxExit(Sender: TObject);
    procedure PrioridadesdeReposio1Click(Sender: TObject);
    procedure Dbg_GeraOCProdutosKeyUp(Sender: TObject; var Key: Word;
      Shift: TShiftState);
    procedure SubMenuFinanConciliaDepositosClick(Sender: TObject);
  private
    { Private declarations }
    // Rolagem no Grid com Mouse
    procedure AppEventsMessage(var Msg: TMsg; var Handled: Boolean);
  public
    { Public declarations }
    sEmpTelefone, sEmpCcontato, sEmpEmail,
    sFornEndereco, sFornCidade, sFornEstado, sFornCodCep, sFornFone1,
    sFornFoneFax, sFornEmail, sFornContato: String;

    // Querys para Consulta
    IBQ_CountReg        : TIBQuery;
    IBQ_ConsultaFilial  : TIBQuery;
    IBQ_Consulta        : TIBQuery;
    IBQ_Matriz          : TIBQuery;
    IBQ_MPMS            : TIBQuery;
    IBQ_ConsultaMatriz  : TIBQuery;

//    IBSP_Geral         : TIBStoredProc;
    Array_Usuarios: array of Integer; // Usado para Usuros Sem Permissao de Visualizao
    Array_Campos: array of String; // Usado para calulo de Formula na Planilha Financeira
    Array_Valores: Array of Currency;

    gCDS_V_Geral: TClientDataSet;
    gDS: TDataSource;

    // Grafico Objetivos
    OldX,OldY:Longint;
    CrossHairColor:TColor;
    CrossHairStyle:TPenStyle;
  end;

type
   THackDBGrid = class(TDBGrid);
   TDBNewNavigator = class (TDBNavigator);
   grid = class(Tdbgrid);

   TAccessDBGrid = class(TCustomGrid); // DBGRID Com Titulo de 2 Linhas

Const
  ArrayObjetivos: array[1..8] of string =
  ('QTD_COMPROV', 'TICKET_MEDIO', 'TOT_BRUTO', 'TOT_DESC_ITEM', 'TOT_DESPESAS', 'TOT_FRETE', 'TOT_ITENS', 'TOT_NOTA');

var
  FrmBelShop: TFrmBelShop;

  pgProgBar: TcxProgressBar;

  sgPastaExecutavel: String; // Pasta e Executvel
  // sPath_Local: String; // Somente a Pasta do Executel (DMBelShop)

  sgParamAplicativo: String;

  sgCodListaPrePadrao, sgDesListaPrePadrao: String;
  sgLojasNConectadas: String;
  sgCodListaPreco, sgDesListaPreco: String;

  // UFrmSelectEmpProcessamento;
  sgOutrasEmpresa,       // Usar (...) - Incluir Outras Empresas Separadas por <,> - '('99', '50')'
  sgEmpresaNao: String;  // Usar (...) - No Apresenta Empresas Separadas por <,>  - '('02', '09')'
  bgSelectSoLinx: Boolean; // S Apresenta Lojas Linx

  bgOnActivate, // Se Ja Executou o Evento do Form OnActivate  
  bgConexaoLocal, // Se Conexo com o Servidor do Banco MPMS  Local - Verifica a Existencia do Arquivo "ConexaoExterna.ini"
  bgAuditoria, bgCor, bgSiga,
  bgProcessar: Boolean;

  cgVlrAcumulado1, cgVlrAcumulado2, cgVlrAcumulado3: Currency;
  igTotInteiro: Integer;
  igTpApres: Integer; // Tipo de Apresentao

  sgDataHoraAplicativo: String;
  sgCodigo: String;

  TD : TTransactionDesc; // Ponteiro de Transao
  TD1: TTransactionDesc; // Ponteiro de Transao

  bEnterTab: Boolean;

  OrderGrid: String;    // Ordenar Grid

  // Variaveis para Busca de Estrutura de Tabela ===============================
  Campos        : String;   // Campos para Insert
  ValuesCampos  : String;   // Valores para Insert
  // OBS: Alterar Nome das Variaveis se Necessario

  wgDiaH, wgMesH, wgAnoH: Word;

  // Demandas Normal
  bgDemandaNovo: Boolean; // Se True Apresenta Demanda de Vendas para Loja 99
  igNrDias, igNrMeses, igTotMeses: Integer;
  cgOutras_Demandas: Currency; // Guarda Todas as Demandas Menos Mes Atual
  cgTotal_Demandas: Currency; // Guarda Todas as Demandas

  // Demandas Ano
  igNrDiasAno: Integer; // Numero de Dias Uteis no Ano
  cgDemAno, cgDemAnoDia: Currency;
  sgDtaIniAno, sgDtaFimAno: String;

  // Meses e Anos para Demanda //////
  sMes1, sMes2, sMes3, sMes4, sMes5, sMes6, sMes7, sMes8: String;
  sAno1, sAno2, sAno3, sAno4, sAno5, sAno6, sAno7, sAno8: String;
  bDem1, bDem2, bDem3, bDem4, bDem5, bDem6, bDem7, bDem8: Boolean; // Se Demanda J Foi Gravada

  sgDtaLimTransf: String; // Guarda Data Limite Para Transferencia
  /////////////////////////

  Des_Login  : String;
  Cod_Usuario: String;
  Des_Usuario: String;
  bgInd_Admin: Boolean;

  PermissoesAtual: String;
  PermissoesAcesso: String;

  igTagPermissao: Integer;

  MyKey: Char;
  bgSair: Boolean;

  iNrConexoesOK, iNrConexoes: Integer;

  bConexaoOK: Boolean;

  // Verifica se Processa Todas as Empresas
  bgTodasEmpresas: Boolean;
  igNrEmpProc: Integer;
  sgEmpresas: String;

  pPainel: TPanel;

  IBSP_Geral         : TIBStoredProc;

  // Sqls para IBQuery //////////////
  MySqlDML, MySqlSelect, MySqlOrderBy, MySqlOrderGrup: String;
  MySqlClausula1, MySqlClausula2, MySqlClausula3, MySqlClausula4: String;
  sParametros: String;
  ///////////////////////////////////////////

  iNrRegistros:Integer;

  sCodMatriz, sCodFilial: String;

  sgNumSeq: String;
  sgDescricao: String;

  bgProcCurva: Boolean; // False = Produto MPMS ser Excluido
                        // No Pertence a Curva Mas fica na Emp 99 para Verificar se  Curva Solicitada na Loja
                        // Para Filial: True = Processa Produto
              
  // Critica para Ataualizao de Curva ABC
  bgUsaFornecedores: Boolean; // Seu Utiliza Seleo de Fornecedor
  sCbx_SituacaoProd: String; // Deve ser sempre Index =2 (Ativo/No Compra)

  iNumSeqDoc: Integer;
  sNumDoc, sgDtaDoc: String;

  sgProdutos, sgLikeProdutos, sgFornecedores, sgCompradores,
  sgGrupos, sgSubGrupos,
  sgAplicacoes, sgFamiliaPrecos, sgGruposST: String;
  sgCurvas: String;

  sgCodEmp, sgDesLoja: String; // Usado, Tambm, para Editar Pedido de Ordem de Compra

  sgMesAnoPlanFinanceira: String;

  sgCodLojas, sgDtaInicio, sgDtaFim, sgPeriodo, sgPeriodo1: String;

  // Series de Graficos
  gsBarra: TBarSeries;
  gsLinha: TLineSeries;
  gsPizza: TPieSeries;

  sOdirTXT: String;

  // Loja Unica
  cgPerPadrao: Currency;
  sgFornLojas, sgDemandas: String; // Importa Solicitaes
  sgInsertOC_Meses: String; // Insere OC_COMPRAR_MESES

  bgECommerce: Boolean;

  // Variaveis de Retorno do FrmSolicitacoes
  bFinanPlanFinanceiraUsarMesAno: Boolean;
  sCbx_FinanPlanFinanceiraMes1, sEdtFinanPlanFinanceiraAno1, sCbx_FinanPlanFinanceiraMes2, sEdtFinanPlanFinanceiraAno2: String;
  dDtEdt_FinanPlanFinanceiraPeriodoDtaInicio, dDtEdt_FinanPlanFinanceiraPeriodoDtaFim: TDate;

  // Lojas Linx =========================
  sgParametroLinx,
  sgVlrLinx, sgVlrSalaoLinx,
  sgDtaComecoLinx,
  sgDtaIncioLinx, sgDtaFimLinx: String;

  igCodLojaLinx: Integer;

  bgSoLinx: Boolean;

  bgLinxChamada: Boolean;
  //=====================================

implementation

uses DK_Procs1, UPermissao, UDMBelShop,
     UPesquisa, UDMConexoes, UPesquisaIB, UDMVirtual, UDMRelatorio,
     UFrmAuditoria, UFrmSelectEmpProcessamento,
     UFrmOCObservacao, UVerTransito, UFrmPlanFinanApresComrprovantes,
     UFrmPeriodoApropriacao, UFrmObjetivosFormula, UFrmFinanObjetivosMovtos,
     UFrmSolicitacoes, UFrmGrafico, UFrmAcessosUsuario, UFrmBancoExtratos,
     UFrmSalao, UFrmGeraPedidosComprasLojas,
     UDMLojaUnica, UFrmConciliacaoCaixa,
     UDMCentralTrocas, UFrmCentralTrocas,
     UFrmEstoques, UEntrada, UDMSidicom,
     UFrmFaltasCDLojas, UFrmControleKits, UFrmControleEstoques,
     UFrmFluxFornecedor, UFrmComissaoVendedor, UDMLinx, RTLConsts, UFrmOCLinx,
  UFrmPrioridadesReposicao;

{$R *.dfm}
{$R C:\Projetos\BelShop\Botoes\Botoes.res }

//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// ODIR INICIO >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// OBJETIVOS - METAS - LINX - MICRIVIX - Busca Vendas >>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.BuscaMovtosVendasLINX(mMemo: TMemo; sTipo: String): Boolean;
Var
  sSelect, MySql: String;
Begin
  // sTipo= (D)Dias
  //        (M)Meses

  Result:=True;

  MySql:=' SELECT';

  If sTipo='D' Then
   MySql:=
    MySql+' CAST(LPAD(EXTRACT(DAY FROM mv.data_documento), 2, ''0'') AS VARCHAR(2)) Dia,';

  If sTipo='M' Then
   MySql:=
    MySql+' CAST(LPAD(EXTRACT(MONTH FROM mv.data_documento), 2, ''0'') AS VARCHAR(2))||''/''||'+
          ' CAST(LPAD(EXTRACT(YEAR  FROM mv.data_documento), 4, ''0'') AS VARCHAR(4)) MesAno,';

  MySql:=
   MySql+' COALESCE((COUNT(DISTINCT'+
         '                 CASE'+
         '                   WHEN mv.operacao = ''S'' THEN'+
         '                     mv.documento'+
         '                 END) - '+
         '           COUNT(DISTINCT'+
         '                 CASE'+
         '                   WHEN mv.operacao = ''DS'' THEN'+
         '                     mv.documento'+
         '                 END))'+
         ' , 0) Qtd_Comprov,'+

         ' COALESCE((COUNT(CASE'+
         '                   WHEN mv.operacao = ''S'' THEN'+
         '                     mv.cod_produto'+
         '                 END) - '+
         '           COUNT(CASE'+
         '                   WHEN mv.operacao = ''DS'' THEN'+
         '                     mv.cod_produto'+
         '                 END))'+
         ' , 0) Tot_Itens,'+

         ' CAST(CASE'+
         '        WHEN ((SUM(COALESCE(mv.valor_total, 0.00))) <> 0) AND'+
         '             ((COUNT(DISTINCT CASE WHEN mv.operacao = ''S''  THEN mv.documento END) - '+
         '              (COUNT(DISTINCT CASE WHEN mv.operacao = ''DS'' THEN mv.documento END)))) <> 0 THEN'+
         '                      COALESCE(((SUM(COALESCE(mv.valor_total, 0))) / '+
         '                               ((COUNT(DISTINCT CASE WHEN mv.operacao = ''S''  THEN mv.documento END) - '+
         '                                 COUNT(DISTINCT CASE WHEN mv.operacao = ''DS'' THEN mv.documento END)))), 0.00)'+
         '        ELSE'+
         '          0'+
         '        END'+
         ' AS NUMERIC(12,2)) Ticket_Medio,'+

         ' Cast(SUM(decode(mv.operacao,''S'',COALESCE(mv.desconto, 0.00),''DS'',-COALESCE(mv.desconto, 0.00))) as numeric(12,2)) Tot_Desc_Item,'+
         ' Cast(SUM(decode(mv.operacao,''S'',COALESCE(mv.quantidade, 0.00) * COALESCE(mv.preco_unitario, 0.00),''DS'',-COALESCE(mv.quantidade, 0.00) * COALESCE(mv.preco_unitario, 0.00))) as numeric(12,2)) Tot_Bruto,'+
         ' Cast(SUM(decode(mv.operacao,''S'',COALESCE(mv.valor_total, 0.00),''DS'',-COALESCE(mv.valor_total, 0.00))) as numeric(12,2)) Tot_Nota,'+
         ' Cast(SUM(decode(mv.operacao,''S'',COALESCE(mv.frete, 0.00),''DS'',-COALESCE(mv.frete, 0.00))) as numeric(12,2)) Tot_Frete,'+

         ' 0.00 Tot_Despesas'+

         ' FROM LINXMOVIMENTO mv'+

         ' WHERE ((mv.operacao=''S'')  and (mv.tipo_transacao=''V'')'+ // Sadas Vendas
         '        or'+
         '        (mv.operacao=''DS'') and (mv.tipo_transacao is null)'+ // Entradas Devolues
         '       )'+
         ' AND   mv.cancelado = ''N'''+
         ' AND   mv.excluido = ''N'''+
//odirapagar - 22/05/2017
//         ' AND   mv.soma_relatorio = ''S'''+
         ' AND   mv.data_lancamento BETWEEN '+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaIncioLinx)))+' AND '+
                                              QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaFimLinx)))+
         ' AND   mv.Empresa='+IntToStr(igCodLojaLinx); // Loja Linx

   If sTipo='D' Then
    MySql:=
     MySql+' GROUP BY 1';

   If sTipo='M' Then
    MySql:=
     MySql+' GROUP BY'+
           ' CAST(LPAD(EXTRACT(YEAR  FROM mv.data_documento), 4, ''0'') AS VARCHAR(4)),'+
           ' CAST(LPAD(EXTRACT(MONTH FROM mv.data_documento), 2, ''0'') AS VARCHAR(2))';

  MySql:=
   MySql+' ORDER BY 1';
  DMLinx.CDS_Busca.Close;
  DMLinx.SDS_Busca.CommandText:=MySql;
  DMLinx.CDS_Busca.Open;

  DMLinx.CDS_Busca.DisableControls;
  While Not DMLinx.CDS_Busca.Eof do
  Begin

    If DMLinx.CDS_Busca.RecNo=1 Then
     Begin
       sSelect:=' SELECT ';
     End
    Else
     Begin
       sSelect:=' UNION SELECT ';
     End; // If DMLinx.CDS_Busca.RecNo=1 Then

    If sTipo='D' Then
     sSelect:=
      sSelect+QuotedStr(DMLinx.CDS_Busca.FieldByName('DIA').AsString)+' DIA, '; // DIA

    If sTipo='M' Then
     sSelect:=
      sSelect+QuotedStr(DMLinx.CDS_Busca.FieldByName('MESANO').AsString)+' MESANO, '; // MESANO

    sSelect:=
     sSelect+DMLinx.CDS_Busca.FieldByName('QTD_COMPROV').AsString+' QTD_COMPROV, '+ // QTD_COMPROV
             DMLinx.CDS_Busca.FieldByName('TOT_ITENS').AsString+' TOT_ITENS, '+ // TOT_ITENS
             f_Troca(',','.',DMLinx.CDS_Busca.FieldByName('TICKET_MEDIO').AsString)+' TICKET_MEDIO, '+ // TICKET_MEDIO
             f_Troca(',','.',DMLinx.CDS_Busca.FieldByName('TOT_DESC_ITEM').AsString)+' TOT_DESC_ITEM, '+ // TOT_DESC_ITEM
             f_Troca(',','.',DMLinx.CDS_Busca.FieldByName('TOT_BRUTO').AsString)+' TOT_BRUTO, '+ // TOT_BRUTO
             f_Troca(',','.',DMLinx.CDS_Busca.FieldByName('TOT_NOTA').AsString)+' TOT_NOTA, '+ // TOT_NOTA
             f_Troca(',','.',DMLinx.CDS_Busca.FieldByName('TOT_FRETE').AsString)+' TOT_FRETE, '+ // TOT_FRETE
             f_Troca(',','.',DMLinx.CDS_Busca.FieldByName('TOT_DESPESAS').AsString)+' TOT_DESPESAS'+ // TOT_DESPESAS
             ' FROM RDB$DATABASE';

    mMemo.Lines.Add(sSelect);

    DMLinx.CDS_Busca.Next;
  End; // While Not DMLinx.CDS_Busca.Eof do
  DMLinx.CDS_Busca.EnableControls;
  DMLinx.CDS_Busca.Close;

End; // OBJETIVOS - METAS - LINX - MICRIVIX - Busca Vendas >>>>>>>>>>>>>>>>>>>>>

// DIVERSOS - Controel de Apresentao do Menu >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.ControleMenu(bControle: Boolean);
Var
  i: Integer;
Begin
  For i:=0 to MainMenu1.Items.Count-1 do
  Begin
    If (MainMenu1.Items.Items[i].Name<>'MenuVersao') and
       (MainMenu1.Items.Items[i].Name<>'MenuCalculadora') Then
     MainMenu1.Items.Items[i].Enabled:=bControle
  End; // For i:=0 to MainMenu1.Items.Count-1 do

  SBt_Sair.Enabled:=bControle;

End; // DIVERSOS - Controel de Apresentao do Menu >>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Calcula Sugestes / Transferencias / Estoque Excedente >>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.OCCalculaSugTransfExc(sNrDoc, sDtaDoc: String);
Var
  MySql: String;
  cQtdSugerida: Currency; // EST_MINIMO - cQtdSugerida Se Zero Utiliza Qtd_Sugerida
Begin

  OdirPanApres.Caption:='AGUARDE !! Gerando Sugestes de Compras...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
  OdirPanApres.Visible:=True;
  Refresh;

  Try
    sDtaDoc:=DateToStr(StrToDateTime(sDtaDoc));
  Except
    Try
      sDtaDoc:=DateToStr(StrToDateTime(f_Troca('.','/',f_Troca('-','/',sDtaDoc))));
    Except
      sDtaDoc:=DateToStr(StrToDateTime(f_Troca('/','.',f_Troca('-','.',sDtaDoc))));
    End;
  End;

  Try // IBQ_OC_ComprarAdd
   If Not DMBelShop.IBT_BelShop.Active Then
   Begin
     DMBelShop.IBT_BelShop.StartTransaction;
   End;

    // Calcula Matriz ==========================================================
    MontaProgressBar(True, FrmBelShop);

    // Busca Pedido -------------------------------------------------
    MySql:=' SELECT *'+
           ' FROM  OC_COMPRAR OC'+
           ' WHERE oc.num_documento='+sNrDoc+
           ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDoc)))+
           ' AND   oc.ind_oc_gerada=''N'''+
           ' ORDER BY oc.Des_Item';
    DMBelShop.IBQ_OC_ComprarAdd.Close;
    DMBelShop.IBQ_OC_ComprarAdd.SQL.Clear;
    DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(MySql);
    DMBelShop.IBQ_OC_ComprarAdd.Open;

    DMBelShop.IBQ_OC_ComprarAdd.Last;
    pgProgBar.Properties.Max:=DMBelShop.IBQ_OC_ComprarAdd.RecordCount;
    pgProgBar.Position:=0;
    DMBelShop.IBQ_OC_ComprarAdd.First;
    While not DMBelShop.IBQ_OC_ComprarAdd.Eof do
    Begin
      Application.ProcessMessages;
      pgProgBar.Position:=DMBelShop.IBQ_OC_ComprarAdd.RecNo;

      cQtdSugerida:=-1;

      DMBelShop.IBQ_OC_ComprarAdd.Edit;

      // QTD_SUGERIDA
      DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency:=RoundTo(
             (DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_MEDIA_DIA').AsCurrency*
              DMBelShop.IBQ_OC_ComprarAdd.FieldByName('DIAS_ESTOCAGEM').AsInteger),0);

      // Analisa Estoque Minimo
      If DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency<DMBelShop.IBQ_OC_ComprarAdd.FieldByName('EST_MINIMO').AsCurrency Then
      Begin
        cQtdSugerida:=DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency;

        DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency:=
               DMBelShop.IBQ_OC_ComprarAdd.FieldByName('EST_MINIMO').AsCurrency;
      End;

      DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency:=RoundTo(
         (DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency-
          DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_DISPONIVEL').AsCurrency),0);

      If DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency<0 Then
      Begin
        DMBelShop.IBQ_OC_ComprarAdd.FieldByName('IND_QTD_ACIMA').AsCurrency:=Abs(
              DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency);

        DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency:=0;
      End;

      // QTD_SUGERIDA_ANO
      DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA_ANO').AsCurrency:=RoundTo(
               (DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_DEMANDA_DIA').AsCurrency*
                DMBelShop.IBQ_OC_ComprarAdd.FieldByName('DIAS_ESTOCAGEM').AsInteger),0);

      If DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA_ANO').AsCurrency<
         DMBelShop.IBQ_OC_ComprarAdd.FieldByName('EST_MINIMO').AsCurrency Then
       DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA_ANO').AsCurrency:=
               DMBelShop.IBQ_OC_ComprarAdd.FieldByName('EST_MINIMO').AsCurrency;

      DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA_ANO').AsCurrency:=
         DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA_ANO').AsCurrency-
           DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_DISPONIVEL').AsCurrency;

      If DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA_ANO').AsCurrency<0 Then
       DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA_ANO').AsCurrency:=0;

      // QTD_ACOMPRAR
      If cQtdSugerida<0 Then // No Processa Pelo estoque Minimo
       DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_ACOMPRAR').AsCurrency:=
              DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_SUGERIDA').AsCurrency
      Else
       DMBelShop.IBQ_OC_ComprarAdd.FieldByName('QTD_ACOMPRAR').AsCurrency:=cQtdSugerida;

      DMBelShop.IBQ_OC_ComprarAdd.Post;

      DMBelShop.IBQ_OC_ComprarAdd.Next;
    End; // While not DMBelShop.IBQ_OC_ComprarAdd.Eof do

    // Atualiza Transacao ======================================================
    DMBelShop.IBQ_OC_ComprarAdd.ApplyUpdates;
    DMBelShop.IBT_BelShop.CommitRetaining;
    DMBelShop.IBT_BelShop.Commit;

    DMBelShop.IBQ_OC_ComprarAdd.Close;

    // Atualiza OC_COMPRAR_DOCS ================================================
    OC_COMPRAR_DOCS('I', sNrDoc, 'BelShop');

    // Atualiza Totais ----------------------------------
    DMBelShop.Doc_CalculaValores(sNrDoc, sDtaDoc);

    MontaProgressBar(False, FrmBelShop);
    OdirPanApres.Visible:=False;
  Except // Try // IBQ_OC_ComprarAdd
    On e : Exception do
    Begin
      // Abandona Transacao ====================================================
      OdirPanApres.Visible:=False;
      MontaProgressBar(False, FrmBelShop);
      DMBelShop.IBT_BelShop.Rollback;

      Screen.Cursor:=crDefault;

      DMBelShop.IBQ_OC_ComprarAdd.Close;

      msg('Erro na Gerao das Sugestes de Compra !!'+cr+cr+'Filial: '+sCodMatriz +' !!','A');
      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // On e : Exception do
  End; // Try // IBQ_OC_ComprarAdd
End; // Calcula Sugestes / Transferencias / Estoque Excedente >>>>>>>>>>>>>>>>>

// Monta Demandas para Novo Calculo do Compras >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MontaDemandasNovo(sFilial: String);
Var
  sDta, MySql: String;
  dDta: TDateTime;
  sCase, sIN, sCaseDiasMeses: String;
Begin
  // Monta Scripts para Buscar Demandas ======================================
  dDta:=DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);
  sCaseDiasMeses:=' When (Cast(lpad(extract(month from dem.dta_ref),2,''0'') as varchar(2))||''/''||'+
                  '       Cast(lpad(extract(Year from dem.dta_ref),4,''0'') as varchar(4)))='+
                  '      (Cast(lpad(extract(month from current_date),2,''0'') as varchar(2))||''/''||'+
                  '       Cast(lpad(extract(Year from current_date),4,''0'') as varchar(4))) Then '+
                  IntToStr(DiasUteisBelShop(PrimUltDia(dDta,'P'), dDta, False, True));

  sDta:='';
  If StrToIntDef(sMes1,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes1+'.'+ME_Ano1.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem1''';

    dDta:=EncodeDate(StrToInt(ME_Ano1.Text), StrToInt(sMes1), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  If StrToIntDef(sMes2,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes2+'.'+ME_Ano2.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem2''' ;

    dDta:=EncodeDate(StrToInt(ME_Ano2.Text), StrToInt(sMes2), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  If StrToIntDef(sMes3,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes3+'.'+ME_Ano3.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem3''';

    dDta:=EncodeDate(StrToInt(ME_Ano3.Text), StrToInt(sMes3), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  If StrToIntDef(sMes4,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes4+'.'+ME_Ano4.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem4''';

    dDta:=EncodeDate(StrToInt(ME_Ano4.Text), StrToInt(sMes4), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  If StrToIntDef(sMes5,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes5+'.'+ME_Ano5.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem5''';

    dDta:=EncodeDate(StrToInt(ME_Ano5.Text), StrToInt(sMes5), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  If StrToIntDef(sMes6,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes6+'.'+ME_Ano6.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem6''';

    dDta:=EncodeDate(StrToInt(ME_Ano6.Text), StrToInt(sMes6), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  If StrToIntDef(sMes7,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes7+'.'+ME_Ano7.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem7''';

    dDta:=EncodeDate(StrToInt(ME_Ano7.Text), StrToInt(sMes7), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  If StrToIntDef(sMes8,0)<>0 Then
  Begin
    sDta:=QuotedStr('01.'+sMes8+'.'+ME_Ano8.Text);

    sCase:=
     sCase+' When dem.dta_ref = '+sDta+' Then ''Dem8''';

    dDta:=EncodeDate(StrToInt(ME_Ano8.Text), StrToInt(sMes8), 1);
    sCaseDiasMeses:=
     sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

    If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
  End;

  sIN:='('+sIN+')';

  // Busca Demandas ==========================================================
  MySql:=' Select pr.codproduto, dem.dta_ref,'+
         ' Case '+sCase+' End Demanda,'+
         ' Case '+sCaseDiasMeses+' End Num_Dias,';

         If (sFilial<>'99') And (Trim(sFilial)<>'') Then
          MySql:=
           MySql+' Coalesce(Dem.quant_ref,0) dem'
         Else
          MySql:=
           MySql+' SUM(Coalesce(Dem.quant_ref,0)) dem';

  MySql:=
   MySql+' From MOVTOS_EMPRESAS Dem, PRODUTO pr'+
         ' Where dem.codproduto=pr.codproduto';

         sgEmpresas:=sgEmpresas;
         If bgECommerce Then
          MySql:=
           MySql+' And   Dem.codfilial='+QuotedStr('99')
         Else If (sFilial<>'99') And (Trim(sFilial)<>'') Then
          MySql:=
           MySql+' And   Dem.codfilial='+QuotedStr(sFilial);

  MySql:=
   MySql+' And   Dem.ind_tipo=''DM'''+
         ' And   Dem.dta_ref in '+sIN;

         // Produtos No Compra -------------------------------------
         If Not Ckb_FiltroProdNaoCompra.Checked Then
          MySql:=
           MySql+' AND Coalesce(pr.situacaopro,0)=0'
         Else
          MySql:=
           MySql+' AND Coalesce(pr.situacaopro,0) in (0,3)';

         // Produtos Codigos e/ou Produtos Like ---------------------
         If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
          MySql:=
           MySql+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
         Else If Trim(sgProdutos)<>'' Then
          MySql:=
           MySql+' AND pr.CodProduto in ('+sgProdutos+')'
         Else If Trim(sgLikeProdutos)<>'' Then
          MySql:=
           MySql+' AND '+sgLikeProdutos;

         // Fornecedores --------------------------------------------
         If Trim(sgFornecedores)<>'' Then
          MySql:=
           MySql+' AND pr.principalfor in ('+sgFornecedores+')'
         Else
          MySql:=
           MySql+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

         If (sFilial='99') Or (bgECommerce) Then
          MySql:=
           MySql+' Group by 1,2';

  MySql:=
   MySql+' UNION';

  MySql:=
   MySql+' SELECT p.codproduto, p.datainclusao dta_ref, ''ANO'' Demanda,'+
         IntToStr(igNrDiasAno)+' Num_Dias,'+
         ' SUM(COALESCE(dm.quant_ref,0)) dem'+
         ' FROM MOVTOS_EMPRESAS dm, PRODUTO p'+
         ' WHERE dm.codproduto=p.codproduto'+
         ' And   Dm.ind_tipo=''DM'''+
         ' And   Dm.dta_ref Between '+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaIniAno)))+
                                     ' AND '+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaFimAno)));

         If bgECommerce Then
          MySql:=
           MySql+' And   Dm.codfilial='+QuotedStr('99')
         Else If (sFilial<>'99') And (Trim(sFilial)<>'') Then
          MySql:=
           MySql+' And   Dm.codfilial='+QuotedStr(sFilial);

         // Produtos No Compra -------------------------------------
         If Not Ckb_FiltroProdNaoCompra.Checked Then
          MySql:=
           MySql+' AND Coalesce(p.situacaopro,0)=0'
         Else
          MySql:=
           MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';

         // Produtos Codigos e/ou Produtos Like ---------------------
         If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
          MySql:=
           MySql+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.',sgLikeProdutos)+')'
         Else If Trim(sgProdutos)<>'' Then
          MySql:=
           MySql+' AND p.CodProduto in ('+sgProdutos+')'
         Else If Trim(sgLikeProdutos)<>'' Then
          MySql:=
           MySql+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

         // Fornecedores --------------------------------------------
         If Trim(sgFornecedores)<>'' Then
          MySql:=
           MySql+' AND p.principalfor in ('+sgFornecedores+')'
         Else
          MySql:=
           MySql+' AND p.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

  MySql:=
   MySql+' GROUP BY 1, 2'+
         ' ORDER BY 1, 2';
  DMBelShop.CDS_DemandasNovo.Close;
  DMBelShop.CDS_DemandasNovo.Filtered:=False;
  DMBelShop.CDS_DemandasNovo.Filter:='';
  DMBelShop.SDS_DemandasNovo.CommandText:=MySql;
  DMBelShop.CDS_DemandasNovo.Open;
End; // Monta Demandas para Novo Calculo do Compras >>>>>>>>>>>>>>>>>>>>>>>>>>>>

// EMPRESAS/LOJAS - Campos SIDICOM /////////////////////////////////////////////
Procedure TFrmBelShop.LiberaCamposSidicom(bLibera: Boolean);
Var
  cCorComponente: TColor;
  cCorFonte: TColor;
Begin

  cCorFonte:=clWindowText;
  cCorComponente:=clWindow;
  If Not bLibera Then
  Begin
    cCorFonte:=clRed;
    cCorComponente:=$00E8E8FF;
  End; // If Not bLibera Then

  Dbe_ConEmpresasRazaoSocial.ReadOnly:=not bLibera;
  Me_ConEmpresasCNPJ.ReadOnly:=not bLibera;
  Dbe_ConEmpresasInscrEstadual.ReadOnly:=not bLibera;
  Dbe_ConEmpresasEndereco.ReadOnly:=not bLibera;
  Dbe_ConEmpresasNumero.ReadOnly:=not bLibera;
  Dbe_ConEmpresasComplemento.ReadOnly:=not bLibera;
  Dbe_ConEmpresasBairro.ReadOnly:=not bLibera;
  Me_ConEmpresasCEP.ReadOnly:=not bLibera;

  Bt_ConEmpresasBuscaEstado.Enabled:=bLibera;
  Bt_ConEmpresasBuscaMunicipio.Enabled:=bLibera;

  Dbe_ConEmpresasRazaoSocial.Color:=cCorComponente;
  Me_ConEmpresasCNPJ.Color:=cCorComponente;
  Dbe_ConEmpresasInscrEstadual.Color:=cCorComponente;
  Dbe_ConEmpresasEndereco.Color:=cCorComponente;
  Dbe_ConEmpresasNumero.Color:=cCorComponente;
  Dbe_ConEmpresasComplemento.Color:=cCorComponente;
  Dbe_ConEmpresasBairro.Color:=cCorComponente;
  Me_ConEmpresasCEP.Color:=cCorComponente;

  Dbe_ConEmpresasRazaoSocial.Font.Color:=cCorFonte;
  Me_ConEmpresasCNPJ.Font.Color:=cCorFonte;
  Dbe_ConEmpresasInscrEstadual.Font.Color:=cCorFonte;
  Dbe_ConEmpresasEndereco.Font.Color:=cCorFonte;
  Dbe_ConEmpresasNumero.Font.Color:=cCorFonte;
  Dbe_ConEmpresasComplemento.Font.Color:=cCorFonte;
  Dbe_ConEmpresasBairro.Font.Color:=cCorFonte;
  Me_ConEmpresasCEP.Font.Color:=cCorFonte;
End;

// DIVERSOS - Seleciona Produtos TS_Filtros >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.SelecionaProdutos(bProd, bLike: Boolean);
Begin
  // bProd = True - Seleciona Produto (Codigo)
  // bLike = True - Seleciona Produto (Nome)
  // Like Montado com Alias < pr. >
  //       USAR: MySql:=MySql+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

  // Seleo Produtos ==========================================================
  sgProdutos:='';
  If bProd Then
  Begin
    If Not DMVirtual.CDS_V_Produtos.IsEmpty Then
    Begin

      DMVirtual.CDS_V_Produtos.First;
      While Not DMVirtual.CDS_V_Produtos.Eof do
      Begin
        Refresh;

        If sgProdutos='' Then
         sgProdutos:=QuotedStr(DMVirtual.CDS_V_ProdutosCod_Produto.AsString)
        Else
         sgProdutos:=sgProdutos+', '+
                          QuotedStr(DMVirtual.CDS_V_ProdutosCod_Produto.AsString);

        DMVirtual.CDS_V_Produtos.Next;
      End; // While Not DMVirtual.CDS_V_Produtos.Eof do
      DMVirtual.CDS_V_Produtos.First;

    End; // If Not DMVirtual.CDS_V_Produtos.IsEmpty Then
  End; // If bProd Then

  // Like Produtos =============================================================
  sgLikeProdutos:='';
  If bLike Then
  Begin
    If Trim(EdtCalculoFiltroNome1.Text)<>'' Then
     sgLikeProdutos:=' pr.apresentacao like ''%'+Trim(EdtCalculoFiltroNome1.Text)+'%''';

    If (Trim(EdtCalculoFiltroNome2.Text)<>'') And (sgLikeProdutos='') Then
     sgLikeProdutos:=' pr.apresentacao like ''%'+Trim(EdtCalculoFiltroNome2.Text)+'%'''
    Else If (Trim(EdtCalculoFiltroNome2.Text)<>'') Then
     sgLikeProdutos:=sgLikeProdutos+' OR pr.apresentacao like ''%'+Trim(EdtCalculoFiltroNome2.Text)+'%''';

    If (Trim(EdtCalculoFiltroNome3.Text)<>'') And (sgLikeProdutos='') Then
     sgLikeProdutos:=' pr.apresentacao like ''%'+Trim(EdtCalculoFiltroNome3.Text)+'%'''
    Else If (Trim(EdtCalculoFiltroNome3.Text)<>'') Then
     sgLikeProdutos:=sgLikeProdutos+' OR pr.apresentacao like ''%'+Trim(EdtCalculoFiltroNome3.Text)+'%''';

    If (Trim(EdtCalculoFiltroNome4.Text)<>'') And (sgLikeProdutos='') Then
     sgLikeProdutos:=' pr.apresentacao like ''%'+Trim(EdtCalculoFiltroNome4.Text)+'%'''
    Else If (Trim(EdtCalculoFiltroNome4.Text)<>'') Then
     sgLikeProdutos:=sgLikeProdutos+' OR pr.apresentacao like ''%'+Trim(EdtCalculoFiltroNome4.Text)+'%''';

    If sgLikeProdutos<>'' Then
     sgLikeProdutos:='('+sgLikeProdutos+')';
  End; // If bLike Then
End; // DIVERSOS - Seleciona Produtos TS_Filtros >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Loja Unica - Busca Fornecedores a Importar >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.LojaUnicaFornecedorImportar: Boolean;
Var
  MySql: String;
  sDemAnterior, sDemAtual: String;
Begin
  Result:=False;

  MySql:=' SELECT DISTINCT ''NAO'' PROC, ol.cod_fornecedor, fo.nomefornecedor,'+
         ' ''Bel_''||ol.cod_empresa Cod_Loja, Cast(ol.Dta_Documento As Date) Dta_Solicitacao,'+
         ' ml.mes1 dem_mes1,'+
         ' ml.mes2 dem_mes2,'+
         ' ml.mes3 dem_mes3,'+
         ' ml.mes4 dem_mes4,'+
         ' ml.mes5 dem_mes5,'+
         ' ml.mes6 dem_mes6,'+
         ' ml.mes7 dem_mes7,'+
         ' ml.mes8 dem_mes8,'+
         ' ''S'' ESTE'+

         ' FROM oc_comprar_lojas ol, fornecedor fo, oc_comprar_meses_lojas ml'+

         ' WHERE ol.cod_fornecedor=fo.codfornecedor'+
         ' AND   ol.num_documento=ml.num_documento'+
         ' AND   ol.cod_empresa=ml.cod_loja'+
         ' AND   ol.ind_oc_gerada='+QuotedStr('N')+
         ' ORDER BY 2';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  If Trim(DMBelShop.CDS_Busca.FieldByName('cod_fornecedor').AsString)='' Then
  Begin
    DMBelShop.CDS_Busca.Close;
    sgMensagem:='Sem Fornecedor a Importar !!';
    Exit;
  End;

  // ClientDataSet Virtual de Fornecedores de Lojas ============================
  Try
    DMLojaUnica.CDS_V_SolicitFornLojas.CreateDataSet;
    DMLojaUnica.CDS_V_SolicitFornLojas.Open;
  Except
    DMLojaUnica.CDS_V_SolicitFornLojas.EmptyDataSet;
    DMLojaUnica.CDS_V_SolicitFornLojas.Open;
  End;

  // Insere Fornecedores de Lojas ==============================================
  DMLojaUnica.CDS_V_SolicitFornLojas.Data:=DMBelShop.CDS_Busca.Data;

  // Mostra Fornecedortes distintos ============================================
  DMLojaUnica.CDS_V_SolicitFornLojas.Filter:='';
  DMLojaUnica.CDS_V_SolicitFornLojas.Filtered:=False;

  sgCodigo:='';
  sDemAnterior:='';
  sDemAtual:='';
  DMLojaUnica.CDS_V_SolicitFornLojas.First;
  While Not DMLojaUnica.CDS_V_SolicitFornLojas.Eof do
  Begin
    sDemAtual:=DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES1.AsString+
               DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES2.AsString+
               DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES3.AsString+
               DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES4.AsString+
               DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES5.AsString+
               DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES6.AsString+
               DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES7.AsString+
               DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES8.AsString;

    If (sgCodigo=DMLojaUnica.CDS_V_SolicitFornLojasCOD_FORNECEDOR.AsString) and (sDemAnterior=sDemAtual) Then
    Begin
      DMLojaUnica.CDS_V_SolicitFornLojas.Edit;
      DMLojaUnica.CDS_V_SolicitFornLojasESTE.AsString:='N';
      DMLojaUnica.CDS_V_SolicitFornLojas.Post;
    End; // If sgCodigo=DMLojaUnica.CDS_V_SolicitFornLojasCOD_FORNECEDOR.AsString Then

    sgCodigo:=DMLojaUnica.CDS_V_SolicitFornLojasCOD_FORNECEDOR.AsString;

    sDemAnterior:=DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES1.AsString+
                  DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES2.AsString+
                  DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES3.AsString+
                  DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES4.AsString+
                  DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES5.AsString+
                  DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES6.AsString+
                  DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES7.AsString+
                  DMLojaUnica.CDS_V_SolicitFornLojasDEM_MES8.AsString;

    DMLojaUnica.CDS_V_SolicitFornLojas.Next;
  End; // While Not DMLojaUnica.CDS_V_SolicitFornLojas.Eof do

  DMLojaUnica.CDS_V_SolicitFornLojas.Filter:='ESTE='+QuotedStr('S');
  DMLojaUnica.CDS_V_SolicitFornLojas.Filtered:=True;
  DMLojaUnica.CDS_V_SolicitFornLojas.First;

  Result:=True;
End; // Loja Unica - Busca Fornecedores a Importar >>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Gera Docto para OC das Lojas Unicas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.GeraDoctoLojasUnicas: Boolean;
Var
  MySql: String;
Begin
  Result:=True;

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Busca Numero de Documento ===============================================
    MySql:=' SELECT GEN_ID(GEN_NUM_DOC_CALCULO,1) Codigo'+
           ' FROM RDB$DATABASE';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;
    sNumDoc:=DMBelShop.CDS_Busca.FieldByName('Codigo').AsString;
    DMBelShop.CDS_Busca.Close;

    // Zera Numerador para Num_Seq =============================================
    MySql:=' ALTER SEQUENCE GEN_NUMSEQ_LOJAS RESTART WITH 0';
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Insere Novo Docto OC_COMPRAR ============================================
    MySql:=' INSERT INTO OC_COMPRAR'+
           ' SELECT'+
           ' GEN_ID(GEN_NUMSEQ_LOJAS,1), '+sNumDoc+' NUM_DOCUMENTO, current_timestamp DTA_DOCUMENTO, ol.IND_OC_GERADA,'+
           ' ol.DTA_OC_GERADA, ol.NUM_OC_GERADA, ol.OBS_OC, ol.COD_EMPRESA, ol.DES_EMPRESA,'+
           ' ol.COD_ITEM, ol.DES_ITEM, ol.QTD_SUGERIDA, ol.QTD_ACOMPRAR, ol.QTD_SALDO, ol.QTD_TRANSITO,'+
           ' ol.QTD_DISPONIVEL, ol.QTD_MEDIA_MES, ol.QTD_MEDIA_DIA, ol.QTD_DEM_MES1, ol.QTD_DEM_MES2,'+
           ' ol.QTD_DEM_MES3, ol.QTD_DEM_MES4, ol.QTD_DEM_MES5, ol.QTD_DEM_MES6, ol.QTD_DEM_MES7,'+
           ' ol.QTD_DEM_MES8, ol.UNI_COMPRA, ol.UNI_VENDA, ol.COD_BARRAS, ol.COD_GRUPO, ol.DES_GRUPO,'+
           ' ol.COD_SUBGRUPO, ol.DES_SUBGRUPO, ol.DES_GENERICO, ol.COD_APLICACAO, ol.DES_APLICACAO,'+
           ' ol.COD_REFERENCIA, ol.CLA_CURVA_ABC, ol.COD_FAMILIA_PRECO, ol.DES_FAMILIA_PRECO,'+
           ' ol.DTA_ULT_COMPRA, ol.COD_FOR_ULT_COMPRA, ol.DES_FOR_ULT_COMPRA, ol.QTD_ULT_COMPRA,'+
           ' ol.VLR_UNI_ULT_COMPRA, ol.VLR_TOT_ULT_COMPRA, ol.VLR_UNI_COMPRA, ol.PER_DESCONTO,'+
           ' ol.DTA_ULT_VENDA, ol.COD_CLI_ULT_VENDA, ol.DES_CLI_ULT_VENDA, ol.QTD_ULT_VENDA, ol.VLR_UNI_ULT_VENDA,'+
           ' ol.VLR_TOT_ULT_VENDA, ol.VLR_UNI_VENDA, ol.COD_LISTA_VENDA, ol.DES_LISTA_VENDA, ol.COD_LISTA_COMPRA,'+
           ' ol.DES_LISTA_COMPRA, ol.VLR_CUSTO_MEDIO, ol.VLR_TOT_VENDA, ol.VLR_TOT_COMPRA, ol.VLR_BRUTO,'+
           ' ol.VLR_DESCONTOS, ol.VLR_DESPESAS, ol.VLR_FRETE, ol.IND_SOMA_IPI_BASE_ICMS,'+
           ' ol.IND_SOMA_FRETE_BASE_ICMS, ol.IND_SOMA_DESPESA_BASE_ICMS, ol.IND_SOMA_IPI_BASE_ST,'+
           ' ol.IND_SOMA_FRETE_BASE_ST, ol.IND_SOMA_DESPESA_BASE_ST, ol.COD_SIT_TRIBUTARIA, ol.COD_IPI,'+
           ' ol.IND_IPI, ol.PER_IPI, ol.VLR_IPI, ol.COD_ICMS, ol.PER_REDUCAO_ICMS, ol.VLR_REDUCAO_ICMS,'+
           ' ol.VLR_BASE_ICMS, ol.PER_ICMS, ol.VLR_ICMS, ol.COD_GRUPO_ST, ol.DES_GRUPO_ST,'+
           ' ol.PER_MARGEM_ST, ol.IND_ST, ol.VLR_BASE_ST, ol.PER_ST, ol.VLR_ST, ol.PER_REPASSE,'+
           ' ol.VLR_REPASSE, ol.COD_COMPROVANTE_ICMS, ol.COD_REFERENCIA_FORN, ol.COD_FORNECEDOR,'+
           ' ol.DES_FORNECEDOR, ol.TIP_PESSOA, ol.DES_EMAIL, ol.QTD_NR_DIAS, ol.QTD_NR_MESES,'+
           ' ol.QTD_TOT_MESES, '+QuotedStr(Cod_Usuario)+' COD_COMPRADOR, ol.BLOB_TEXTO,'+
           ' ol.IND_TRANSF, ol.DTA_LIM_TRANSF, ol.QTD_TRANSF, ol.IND_USAR, ol.IND_QTD_ACIMA,'+
           ' ol.QTD_SUGERIDA_ANO, ol.QTD_TRANSF_PERIODO, ol.QTD_TRANSF_ANO, ol.EST_MINIMO,'+
           ' ol.DIAS_ESTOCAGEM, ol.QTD_DEMANDA_DIA, ol.QTD_DEMANDA_ANO, ol.QTD_DIAS_ANO,'+
           ' ol.DATAINCLUSAO, ol.ESTADO, ol.DATAALTERACAO, o.IND_TRANSF_CD, o.DOC_TRANSF_CD'+

           ' FROM OC_COMPRAR_LOJAS ol'+

           ' WHERE ol.ind_oc_gerada='+QuotedStr('N')+' '+
           sgFornLojas+ // Fornecedores com ou Sem Lojas de Lojas Unicas
           sgDemandas+  // Perodo de Demandas
           ' ORDER BY ol.COD_ITEM';
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Insere OC_COMPRAR_MESES =================================================
    sgInsertOC_Meses:=StringReplace(sgInsertOC_Meses, 'NumDoc', sNumDoc, [rfReplaceAll]);
    DMBelShop.SQLC.Execute(sgInsertOC_Meses,nil,nil);
    sgInsertOC_Meses:='';

    // Atualiza OC_COMPRAR_LOJAS Com Processado ================================
    MySql:=' UPDATE oc_comprar_lojas ol'+
           ' set ol.ind_oc_gerada='+QuotedStr('S')+
           ', ol.dta_oc_gerada=current_timestamp'+
           ', ol.num_oc_gerada='+QuotedStr(sNumDoc)+
           ' WHERE ol.ind_oc_gerada='+QuotedStr('N')+
           sgFornLojas+ // Fornecedores com ou Sem Lojas de Lojas Unicas
           sgDemandas;  // Perodo de Demandas
    DMBelShop.SQLC.Execute(MySql,nil,nil);
    sgFornLojas:='';
    sgDemandas:='';

    // Atualiza OC_COMPRAR_DOCS (Loja Unica) ===================================
    OC_COMPRAR_DOCS('I', sNumDoc);

    // Atualiza Transacao ======================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      Result:=False;

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      Exit;
    End; // on e : Exception do
  End; // Try
End; // Gera Docto para OC das Lojas Unicas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// DIVERSOS - Desbilita o Scroll do Mouse no DbGrid >>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.DesabilitaScrollMouse(var Msg: TMsg; var Handled: Boolean);
var
  i: SmallInt;
begin
  //NAO rolagem do scroll do mouse no DBGrid
  if Msg.message = WM_MOUSEWHEEL then
  begin
    Msg.message := WM_KEYDOWN;
    Msg.lParam := 0;

    i := HiWord(Msg.wParam);

    if i <> 0 then
    Handled := False;
  End;
End; // // DIVERSOS - Desbilita o Scroll do Mouse no DbGrid >>>>>>>>>>>>>>>>>>>>

// DIVERSOS - Habilita o Scroll do Mouse no DBGrid >>>>>>>>>>>>>>>>>>>>>>>>>>>>>
procedure TFrmBelShop.HabilitaScrollMouse(var Msg: TMsg; var Handled: Boolean);
var
  Sentido: SmallInt;
begin
  // primeiramente verificamos se  o evento a ser tratado...
  if Msg.message = WM_MOUSEWHEEL then
  if ActiveControl is TDBGrid then // *** <=== AQUI voc testa se classe  TDBGRID
  begin
    Msg.message := WM_KEYDOWN;
    Msg.lParam := 0;
    Sentido := HiWord(Msg.wParam);

    if Sentido > 0 then
     Msg.wParam := VK_UP
    else
     Msg.wParam := VK_DOWN;
  end;
end; // DIVERSOS - Habilita o Scroll do Mouse no DBGrid >>>>>>>>>>>>>>>>>>>>>>>>

// CONTROLE DE TABSHEET - Torna TabSheets Visivel no Form >>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.TabSheetVisivel(Form: TForm; sNomeTabSh: String);
Var
  i: Integer;
Begin
  // Torna TabSheets Visivel ===================================================
  For i:=0 to Form.ComponentCount-1 do
  Begin
    If Form.Components[i] is TTabSheet Then
    Begin
      If (Form.Components[i] as TTabSheet).Name=sNomeTabSh Then
      Begin
        (Form.Components[i] as TTabSheet).TabVisible:=True;
        Exit;
      End;
    End;
  End;
End; // CONTROLE DE TABSHEET - Torna TabSheets Visivel no Form >>>>>>>>>>>>>>>>>

// CONTROLE DE TABSHEET - Torna TabSheets Nao Visivel >>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.TabSheetInvisivel(Form: TForm);
Var
  i: Integer;
Begin
  // Colocar TabSheet.Tag=9999

  // Torna TabSheets Nao Visivel ===============================================
  For i:=0 to Form.ComponentCount-1 do
  Begin
    If Form.Components[i] is TTabSheet Then
     If (Form.Components[i] as TTabSheet).Tag=9999 Then
     (Form.Components[i] as TTabSheet).TabVisible:=False;

    If Form.Components[i] is TcxTabSheet Then
     If (Form.Components[i] as TcxTabSheet).Tag=9999 Then
     (Form.Components[i] as TcxTabSheet).TabVisible:=False;
  End;
End; // CONTROLE DE TABSHEET - Torna TabSheets Nao Visivel >>>>>>>>>>>>>>>>>>>>>

// DIVERSOS - Monta ProgressBar >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MontaProgressBar(bCria: Boolean; Form: TForm);
Begin
  If bCria Then
  Begin
    pgProgBar:=TcxProgressBar.Create(Self);
    pgProgBar.Parent:=Form;
    pgProgBar.Visible:=True;
    pgProgBar.Style.Font.Style:=[fsBold];
    pgProgBar.Left:=100;
    pgProgBar.Top:=302;
    pgProgBar.Width:=Form.ClientWidth-200;

    // Disabilita Formulario
    Form.Enabled:=False;
  End; // If bCria Then

  If Not bCria Then
  Begin
    FreeAndNil(pgProgBar);

    // Habilita Formulario
    Form.Enabled:=True;
  End;

  Application.ProcessMessages;

End; // DIVERSOS - Monta ProgressBar >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Margem de Lucro - Atualiza Entradas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MargemLucroEntradas(Stl: TStringList);
Var
  sCodLoja, sCodProd, sDtaAlteracao, sPrecoCusto,
  sQtdCompraTE, sQtdCompraPR, sQtdCompra: String;
Begin

  // Cria SQL para Buscar Precos de Ultima Compra ou Custo Medio ===============
  DMBelShop.SQLQuery1.Close;
  DMBelShop.SQLQuery1.SQL.Clear;
  DMBelShop.SQLQuery1.SQL.Add(Stl.Text);

  DMVirtual.CDS_V_MargemLucro.First;

  MontaProgressBar(True, FrmBelShop);
  pgProgBar.Properties.Max:=DMVirtual.CDS_V_MargemLucro.RecordCount;
  pgProgBar.Position:=0;

  DMVirtual.CDS_V_MargemLucro.DisableControls;
  While Not DMVirtual.CDS_V_MargemLucro.Eof do
  Begin
    Application.ProcessMessages;

    Pan_FinanMLRegs.Caption:='Reg: '+VarToStr(DMVirtual.CDS_V_MargemLucro.RecordCount)+' -> '+VarToStr(pgProgBar.Position);
    pgProgBar.Position:=DMVirtual.CDS_V_MargemLucro.RecNo;
    Refresh;

    if (Trim(DMVirtual.CDS_V_MargemLucroCODFILIAL.AsString)<>'') And (Trim(DMVirtual.CDS_V_MargemLucroCODPRODUTO.AsString)<>'') Then
    Begin
      // Busca Qunatidades de Entrada ==========================================
      DMBelShop.SQLQuery1.Close;
      DMBelShop.SQLQuery1.Params.ParamByName('CodProd').Value:=Trim(DMVirtual.CDS_V_MargemLucroCODPRODUTO.AsString);
      DMBelShop.SQLQuery1.Open;

      sCodLoja     :=DMBelShop.SQLQuery1.FieldByName('CodFilial').AsString;
      sCodProd     :=DMBelShop.SQLQuery1.FieldByName('CodProduto').AsString;
      sDtaAlteracao:=DMBelShop.SQLQuery1.FieldByName('DataAlteracao').AsString;

      sQtdCompraTE:=DMBelShop.SQLQuery1.FieldByName('Tot_Qtd_TE').AsString;
      If Trim(sQtdCompraTE)='' Then
       sQtdCompraTE:='0';

      sQtdCompraPR:=DMBelShop.SQLQuery1.FieldByName('Tot_Qtd_PR').AsString;
      If Trim(sQtdCompraPR)='' Then
       sQtdCompraPR:='0';

      sQtdCompra:=DMBelShop.SQLQuery1.FieldByName('Qtd_Total').AsString;
      If Trim(sQtdCompra)='' Then
       sQtdCompra:='0';

      DMBelShop.SQLQuery1.Close;

      // Busca Preo no Periodo ================================================
      DMBelShop.SQLQuery2.Close;
      DMBelShop.SQLQuery2.Params.ParamByName('CodProd').Value:=Trim(DMVirtual.CDS_V_MargemLucroCODPRODUTO.AsString);
      DMBelShop.SQLQuery2.Open;

      sPrecoCusto:=DMBelShop.SQLQuery2.FieldByName('PrecoCusto').AsString;
      If Trim(sPrecoCusto)='' Then
       sPrecoCusto:='0';

      DMBelShop.SQLQuery2.Close;

      // Busca Preo Sem Periodo ===============================================
      If (sPrecoCusto='0') Or (sDtaAlteracao='') Then
      Begin
        DMBelShop.SQLQuery3.Close;
        DMBelShop.SQLQuery3.Params.ParamByName('CodProd').Value:=Trim(DMVirtual.CDS_V_MargemLucroCODPRODUTO.AsString);
        DMBelShop.SQLQuery3.Open;

        If Trim(sPrecoCusto)='0' Then
         sPrecoCusto:=DMBelShop.SQLQuery3.FieldByName('PrecoCusto').AsString;

        If Trim(sPrecoCusto)='' Then
         sPrecoCusto:='0';

        If Trim(DMBelShop.SQLQuery3.FieldByName('DataAlteracao').AsString)<>'' Then
         sDtaAlteracao:=DMBelShop.SQLQuery3.FieldByName('DataAlteracao').AsString;

        DMBelShop.SQLQuery3.Close;
      End; // If sPrecoCusto='0' Then

      // Inicia Processamebto ==================================================
      If (Trim(sDtaAlteracao)<>'') Or ((Trim(sPrecoCusto)<>'0') And (Trim(sPrecoCusto)<>'')) Then
      Begin
        DMVirtual.CDS_V_MargemLucro.Edit;

        If Trim(sDtaAlteracao)<>'' Then
         DMVirtual.CDS_V_MargemLucroULT_ALTERACAO.AsString:=sDtaAlteracao;

        If Trim(sQtdCompra)<>'0' Then
        DMVirtual.CDS_V_MargemLucroTOT_QTD_COMPRA.AsCurrency:=StrToCurr(sQtdCompra);

        If Trim(sPrecoCusto)<>'0' Then
         DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency:=StrToCurr(sPrecoCusto);

        // MARGEM_1
        If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency<>0) Then
         Begin
           If Rb_MLTpCalculoMargem.Checked Then
            DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=RoundTo((((
                      DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency-
                      DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency)/
                      DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency)*100),-2)
           Else
            DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=RoundTo((((
                DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency/
                DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency)*100)-100),-2);
         End
        Else If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency=0) Then
         Begin
           DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=100.00;
         End
        Else // If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and ..,
         Begin
           DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=0.00;
         End; // If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and

        // MARGEM_2
        If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency<>0) Then
         Begin
           DMVirtual.CDS_V_MargemLucro_MARGEM_2.AsCurrency:=RoundTo((((
                 DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency/
                 DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency)*100)-100),-2)
         End
        Else If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency=0) Then
         Begin
           DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=100.00;
         End
        Else
         Begin
           DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=0.00;
         End;

        // VALOR DA MARGEM
        DMVirtual.CDS_V_MargemLucroVALOR_MARGEM.AsCurrency:=
                               DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency-
                               DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency;

        // MarK-Up
        If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency<>0) Then
         Begin
           DMVirtual.CDS_V_MargemLucroPER_MARKUP.AsCurrency:=RoundTo((((
                      DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency-
                      DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency)/
                      DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency)*100),-2)
         End
        Else If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency=0) Then
         Begin
           DMVirtual.CDS_V_MargemLucroPER_MARKUP.AsCurrency:=100.00;
         End
        Else
         Begin
           DMVirtual.CDS_V_MargemLucroPER_MARKUP.AsCurrency:=0.00;
         End;

        // VLR_VENDA_PC
        DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC.AsCurrency:=
                            DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                               DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency;

        // % LUCRO
        If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency<>0) Then
         Begin
           DMVirtual.CDS_V_MargemLucroLucro.AsCurrency:=RoundTo((((
                     DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                     DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency)-
                     (DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                      DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency))/
                     (DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                      DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency)*100),-2)
         End
        Else If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency=0) Then
         Begin
           DMVirtual.CDS_V_MargemLucroLucro.AsCurrency:=100.00;
         End
        Else
         Begin
           DMVirtual.CDS_V_MargemLucroLucro.AsCurrency:=0.00;
         End;

        // VLR_VENDA_PC_BAP
        DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency:=
                            DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                            DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency;

        // PER_LUCRO_FINAL
        If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency<>0) Then
         Begin
           DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=RoundTo((((
                     DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                     DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency)-
                     (DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                      DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency))/
                     (DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                      DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency)*100),-2)
         End
        Else If (DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency<>0) and (DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency=0) Then
         Begin
           DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=100.00;
         End
        Else
         Begin
           DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=0.00;
         End;

        // VLR_MARGEM_TOTAL
        DMVirtual.CDS_V_MargemLucroVLR_MARGEM_TOTAL.AsCurrency:=(RoundTo((
                  DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                  DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency),-2))-
                  (RoundTo((DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency*
                  DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency),-2));

         // VLR_MARGEM_FINAL
        DMVirtual.CDS_V_MargemLucroVLR_MARGEM_FINAL.AsCurrency:=
                         DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency-
                         DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency;

        DMVirtual.CDS_V_MargemLucro.Post;
      End; //       If (Trim(sDtaAlteracao)<>'') Or ((Trim(sPrecoCusto)<>'0') And (Trim(sPrecoCusto)<>'')) Then
    End; // if (Trim(DMVirtual.CDS_V_MargemLucroCODFILIAL.AsString)<>'') And (Trim(DMVirtual.CDS_V_MargemLucroCODPRODUTO.AsString)<>'') Then

    DMVirtual.CDS_V_MargemLucro.Next;
  End; // While Not DMVirtual.CDS_V_MargemLucro.Eof do
  DMVirtual.CDS_V_MargemLucro.EnableControls;
  DMVirtual.CDS_V_MargemLucro.First;

  MontaProgressBar(False, FrmBelShop);

End; // Margem de Lucro - Atualiza Entradas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Bloquear PrintScreen
procedure TFrmBelShop.AntiCopia(Sender: TObject; Var Done: Boolean);
begin
// Na clusula Uses do form principal deve-se colocar a referncia: ClipBrd.
// No create do form vc coloca: Application.OnIdle := AntiCopia;

  Try
    if Not bgInd_Admin Then
    Begin
      if GetAsyncKeyState(VK_SNAPSHOT) <> 0 then
        ClipBoard.Clear
      else
       Exit;

      Done := True;
    End;
  Except
  End;
end;

// Busca Lista de Preco da Loja ////////////////////////////////////////////////
Function TFrmBelShop.BuscaCodLista(sLoja: String): String;
Var
  MySql: String;
Begin
  MySql:=' SELECT e.cod_listaPre'+
         ' FROM EMP_CONEXOES e'+
         ' WHERE e.Cod_Filial='+QuotedStr(sLoja);
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;
  Result:=DMBelShop.CDS_BuscaRapida.FieldByName('Cod_ListaPre').AsString;
  DMBelShop.CDS_BuscaRapida.Close;

  If Trim(Result)='' Then
  Begin
    MySql:=' SELECT e.cod_listaPre'+
           ' FROM EMP_CONEXOES e'+
           ' WHERE e.Cod_Filial=''99''';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    Result:=DMBelShop.CDS_BuscaRapida.FieldByName('Cod_ListaPre').AsString;
    DMBelShop.CDS_BuscaRapida.Close;
  End;

End; // Busca Lista de Preco da Loja ///////////////////////////////////////////

// Margem de Lucro - Calcula Totais das Margens ////////////////////////////////
Procedure TFrmBelShop.CalculaTotaisMargens;
Var
  cVlr_Tot_Custo, cVlr_Tot_Venda: Currency;
Begin
  MontaProgressBar(True, FrmBelShop);
  pgProgBar.Properties.Max:=DMVirtual.CDS_V_MargemLucro.RecordCount;
  pgProgBar.Position:=0;

  // Calcula Totais ============================================================
  DMVirtual.CDS_V_MargemLucro.DisableControls;
  DMVirtual.CDS_V_MargemLucro.First;

  cVlr_Tot_Custo:=StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString);
  cVlr_Tot_Venda:=StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString);
  While Not DMVirtual.CDS_V_MargemLucro.Eof do
  Begin
    Application.ProcessMessages;

    pgProgBar.Position:=DMVirtual.CDS_V_MargemLucro.RecNo;
    Refresh;

    DMVirtual.CDS_V_MargemLucro.Edit;

    DMVirtual.CDS_V_MargemLucroPartCusto.AsCurrency:=RoundTo(((
                        DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency*100)/
                        cVlr_Tot_Custo),-2);

    DMVirtual.CDS_V_MargemLucroPartVenda.AsCurrency:=RoundTo(((
                        DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency*100)/
                        cVlr_Tot_Venda),-2);

    DMVirtual.CDS_V_MargemLucro.Post;

    DMVirtual.CDS_V_MargemLucro.Next;
  End; // While Not DMVirtual.CDS_V_MargemLucro.Eof do
  DMVirtual.CDS_V_MargemLucro.EnableControls;
  MontaProgressBar(False, FrmBelShop);

  // Insere Totais ==============================================================
  DMVirtual.CDS_V_MargemLucro.Append;
  DMVirtual.CDS_V_MargemLucroCODFILIAL.AsString:='99';
  DMVirtual.CDS_V_MargemLucroCODPRODUTO.AsString:='';
  DMVirtual.CDS_V_MargemLucroAPRESENTACAO.AsString:='TOTAL-'+sgTitulo;

  DMVirtual.CDS_V_MargemLucroTOT_QTD_COMPRA.AsCurrency:=
               StrToCurr(DMVirtual.CDS_V_MargemLucroAG_TOT_QTD_COMPRA.AsString);

  DMVirtual.CDS_V_MargemLucroPRECOCUSTO.AsCurrency:=
                   StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString);

  DMVirtual.CDS_V_MargemLucroTOT_QTD_VENDA.AsCurrency:=
                StrToCurr(DMVirtual.CDS_V_MargemLucroAG_TOT_QTD_VENDA.AsString);

  DMVirtual.CDS_V_MargemLucroPRECOVENDA.AsCurrency:=
                   StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString);

  If Rb_MLTpCalculoMargem.Checked Then
   Begin
    DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=RoundTo((((
         StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString)-
         StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString))/
         StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString))*100),-2);
   End
  Else
   Begin
    If StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString)<>0 Then
     DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=RoundTo((((
          StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString)*100)/
          StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString))-100),-2)
    Else
     DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency:=100.00;
   End;

  DMVirtual.CDS_V_MargemLucro_MARGEM_2.AsCurrency:=RoundTo((((
                   StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString)/
    StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString))*100)-100),-2);

  DMVirtual.CDS_V_MargemLucroVALOR_MARGEM.AsCurrency:=RoundTo((
              StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString)-
              StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString)),-2);

  DMVirtual.CDS_V_MargemLucroPER_MARKUP.AsCurrency:=RoundTo((((
                   StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOVENDA.AsString)-
                  StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString))/
         StrToCurr(DMVirtual.CDS_V_MargemLucroAG_PRECOCUSTO.AsString))*100),-2);

  DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency:=
                 StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString);

  DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC.AsCurrency:=
                 StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC.AsString);

  DMVirtual.CDS_V_MargemLucroPartCusto.AsCurrency:=100.00;
  DMVirtual.CDS_V_MargemLucroPartVenda.AsCurrency:=100.00;

  If Rb_MLTpCalculoMargem.Checked Then
   Begin
    DMVirtual.CDS_V_MargemLucroLucro.AsCurrency:=RoundTo((((
       StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString)-
       StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC.AsString))/
       StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString))*100),-2);
    End
  Else
    Begin
      If StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC.AsString)<>0 Then
       DMVirtual.CDS_V_MargemLucroLucro.AsCurrency:=RoundTo((((
        StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString)*100)/
        StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC.AsString))-100),-2)
      Else
       DMVirtual.CDS_V_MargemLucroLucro.AsCurrency:=100.00;
    End;

  DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency:=
                      StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_BAP.AsString);

  DMVirtual.CDS_V_MargemLucroPER_BAP_VENDA.AsCurrency:=RoundTo(((
                 StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_BAP.AsString)*100)/
            StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString)),-2);

  DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency:=
             StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC_BAP.AsString);

  DMVirtual.CDS_V_MargemLucroVLR_MARGEM_TOTAL.AsCurrency:=
             StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_MARGEM_TOTAL.AsString);

  DMVirtual.CDS_V_MargemLucroVLR_MARGEM_FINAL.AsCurrency:=
             StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_MARGEM_FINAL.AsString);

  If Rb_MLTpCalculoMargem.Checked Then
   Begin
    DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=RoundTo((((
       StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString)-
       StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC_BAP.AsString))/
       StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString))*100),-2);
   End
  Else
   Begin
     If StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC_BAP.AsString)<>0 Then
      DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=RoundTo((((
            StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PV.AsString)*100)/
            StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_VENDA_PC_BAP.AsString))-100),-2)
     Else
      DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=100.00;
   End;

  DMVirtual.CDS_V_MargemLucroULT_ALTERACAO.AsString:='  /  /    ';
  DMVirtual.CDS_V_MargemLucroCODFORNECEDOR.AsString:='';
  DMVirtual.CDS_V_MargemLucroNOMEFORNECEDOR.AsString:='Perodo de '+sgDtaInicio+' a '+sgDtaFim;
  DMVirtual.CDS_V_MargemLucroNUMSEQ.AsInteger:=9999;
  DMVirtual.CDS_V_MargemLucro.Post;

End; // Margem de Lucro - Calcula Totais das Margens ///////////////////////////

// Margem de Lucro - Calcula Margem de Lucro  Final ////////////////////////////
Procedure TFrmBelShop.CalculaMargemFinal(sCodLoja: String; cVlrVenda, cVlrCusto: Currency);
Var
  MySql: String;
  bSiga: Boolean;
  i: Integer;
  cVlrTotSemLink: Currency;
Begin

  // Apresentacao ==============================================================
  If Not bgTodasEmpresas Then
   OdirPanApres.Caption:='AGUARDE !! Busca Movimento Bonif/Ajustes/Perdas da Loja: BEL_'+sCodLoja
  Else
   OdirPanApres.Caption:='AGUARDE !! Busca Movimento Bonif/Ajustes/Perdas da Loja: Todas';

  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // INICIA PROCESSAMENTO ======================================================

  //==========================================================================
  // (AP) Ajustes de Estoques e Transferencias de Avarias e Perdas ===========
  //==========================================================================
  If igNrEmpProc=1 Then
   MySql:=' SELECT nt.codfilial, Coalesce(nt.codproduto,''SEM'') codproduto,'
  Else
   MySql:=' SELECT ''00'' codfilial, Coalesce(nt.codproduto,''SEM'') codproduto,';

  MySql:=
    MySql+' pr.apresentacao, nt.codfornecedor codcomprovante,'+
          ' nt.cod_situacao Ent_SAI,'+
          ' SUM(nt.quant_ref) Qtd_Total,'+
          ' SUM(nt.valbruto) Tot_Valbruto,'+
          ' SUM(nt.valdesconto) Tot_valdesconto,'+
          ' SUM(Cast(REPLACE (nt.des_situacao,'','' ,''.'') as Numeric(12,2))) Tot_valipi,'+
          ' SUM(nt.valsubstituicao) Tot_valsubstituicao,'+
          ' SUM(nt.preco) Tot_valrepasse,'+
          ' SUM(nt.vlr_total_ref) Tot_valtotal,'+
          ' cp.nomecomprovante, pr.principalfor, pr.nomefornecedor'+

          ' FROM movtos_empresas nt, produto pr, comprv cp'+
          ' WHERE  nt.codproduto=pr.codproduto'+
          ' AND    nt.codfornecedor=cp.codcomprovante'+
          ' AND    cp.codloja=nt.codfilial'+
          ' AND    nt.ind_tipo=''AP''';

          // Produtos Codigos e/ou Produtos Like ---------------------
          If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
           MySql:=
            MySql+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
          Else If Trim(sgProdutos)<>'' Then
           MySql:=
            MySql+' AND pr.CodProduto in ('+sgProdutos+')'
          Else If Trim(sgLikeProdutos)<>'' Then
           MySql:=
            MySql+' AND '+sgLikeProdutos;

          // Fornecedores --------------------------------------------
          If Trim(sgFornecedores)<>'' Then
           MySql:=MySql+' AND pr.principalfor in ('+sgFornecedores+')'
          Else
           MySql:=MySql+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

          // Grupos e SubGrupos --------------------------------------
          If Trim(sgGrupos)<>'' Then
           MySql:=MySql+' AND '+sgGrupos;

          If Not bgTodasEmpresas Then
           MySql:=MySql+' AND    nt.codfilial in ('+sCodLoja+')';

  MySql:=
    MySql+' AND    nt.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

   If igNrEmpProc=1 Then
    MySql:=MySql+' GROUP BY 1,2,3,4,5,13,14,15'
   Else
    MySql:=MySql+' GROUP BY 2,3,4,5,13,14,15';

  MySql:=
   MySql+' Having SUM(nt.vlr_total_ref)>0';

  //==========================================================================
  // (BF) Bonificaes =======================================================
  //==========================================================================
  MySqlClausula1:=' UNION';

  If igNrEmpProc=1 Then
   MySqlClausula1:=MySqlClausula1+' SELECT nt.codfilial, Coalesce(nt.codproduto,''SEM'') codproduto,'
  Else
   MySqlClausula1:=MySqlClausula1+' SELECT ''00'' codfilial, Coalesce(nt.codproduto,''SEM'') codproduto,';

  MySqlClausula1:=
   MySqlClausula1+' pr.apresentacao, nt.codfornecedor codcomprovante,'+
                  ' Case'+
                  '    When nt.cod_situacao<>''E'' Then'+
                  '       ''E'''+
                  '     Else'+
                  '       nt.cod_situacao'+
                  ' End Ent_SAI,'+
                  ' SUM(nt.quant_ref) Qtd_Total,'+
                  ' SUM(nt.valbruto) Tot_Valbruto,'+
                  ' SUM(nt.valdesconto) Tot_valdesconto,'+
                  ' SUM(Cast(REPLACE (nt.des_situacao,'','' ,''.'') as Numeric(12,2))) Tot_valipi,'+
                  ' SUM(nt.valsubstituicao) Tot_valsubstituicao,'+
                  ' SUM(nt.preco) Tot_valrepasse,'+
                  ' SUM(nt.vlr_total_ref) Tot_valtotal,'+
                  ' cp.nomecomprovante, pr.principalfor, pr.nomefornecedor'+

                  ' FROM movtos_empresas nt, produto pr, comprv cp'+
                  ' WHERE nt.codproduto=pr.codproduto'+
                  ' AND   nt.codfornecedor=cp.codcomprovante'+
                  ' AND   cp.codloja=nt.codfilial'+
                  ' AND   nt.ind_tipo=''BF''';

                  // Produtos Codigos e/ou Produtos Like ---------------------
                  If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                   MySqlClausula1:=
                    MySqlClausula1+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
                  Else If Trim(sgProdutos)<>'' Then
                   MySqlClausula1:=
                    MySqlClausula1+' AND pr.CodProduto in ('+sgProdutos+')'
                  Else If Trim(sgLikeProdutos)<>'' Then
                   MySqlClausula1:=
                    MySqlClausula1+' AND '+sgLikeProdutos;

                  // Fornecedores --------------------------------------------
                  If Trim(sgFornecedores)<>'' Then
                   MySqlClausula1:=MySqlClausula1+' AND pr.principalfor in ('+sgFornecedores+')'
                  Else
                   MySqlClausula1:=MySqlClausula1+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

                  // Grupos e SubGrupos --------------------------------------
                  If Trim(sgGrupos)<>'' Then
                   MySqlClausula1:=MySqlClausula1+' AND '+sgGrupos;

                  If Not bgTodasEmpresas Then
                   MySqlClausula1:=MySqlClausula1+' AND   nt.codfilial in ('+sCodLoja+')';

   MySqlClausula1:=
   MySqlClausula1+' AND   nt.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

   If igNrEmpProc=1 Then
    MySqlClausula1:=MySqlClausula1+' GROUP BY 1,2,3,4,5,13,14,15'
   Else
    MySqlClausula1:=MySqlClausula1+' GROUP BY 2,3,4,5,13,14,15';

   MySqlClausula1:=
   MySqlClausula1+' having SUM(nt.vlr_total_ref) >0';

  //==========================================================================
  // (DF) Desconto Financeiro ================================================
  //==========================================================================
  MySqlClausula2:=' UNION';

  If igNrEmpProc=1 Then
   MySqlClausula2:=MySqlClausula2+' SELECT nt.codfilial, Coalesce(pr.codproduto,''SEM'') codproduto,'
  Else
   MySqlClausula2:=MySqlClausula2+' SELECT ''00'' codfilial, Coalesce(pr.codproduto,''SEM'') codproduto,';

  MySqlClausula2:=
   MySqlClausula2+' Coalesce(pr.apresentacao,''PRODUTO SemLink com Docto de Origem'') apresentacao,'+
                  ' nt.codfornecedor codcomprovante,'+
                  ' nt.cod_situacao Ent_SAI,'+
                  ' SUM(COALESCE(nt.quant_ref,0)) Qtd_Total,'+

// Alterado Conforme Peidod do Renato em 05/08/2014
//                  ' SUM(COALESCE(nt.valbruto,0)) Tot_Valbruto,'+
//                  ' SUM(COALESCE(nt.valdesconto,0)) Tot_valdesconto,'+
                  ' SUM(COALESCE(nt.valdesconto,0)) Tot_Valbruto,'+
                  ' 0 Tot_valdesconto,'+

                  ' SUM(Cast(REPLACE (nt.des_situacao,'','',''.'') as Numeric(12,2))) Tot_valipi,'+
                  ' SUM(COALESCE(nt.valsubstituicao,0)) Tot_valsubstituicao,'+
                  ' SUM(COALESCE(nt.preco,0)) Tot_valrepasse,'+

// Alterado Conforme Peidod do Renato em 05/08/2014
//                  ' SUM(COALESCE(nt.vlr_total_ref,0)) Tot_valtotal,'+
                  ' SUM(COALESCE(nt.valdesconto,0)) Tot_valtotal,'+

                  ' nt.nomefornecedor nomecomprovante,'+
                  ' Case'+
                  '   When Coalesce(pr.codproduto,''SEM'')<>''SEM'' Then'+
                  '     pr.principalfor'+
                  '   Else'+
                  '     fo.codfornecedor'+
                  ' End principalfor,'+
                  ' Case'+
                  '   When Coalesce(pr.codproduto,''SEM'')<>''SEM'' Then'+
                  '     pr.nomefornecedor'+
                  '   Else'+
                  '     fo.nomefornecedor||''-SemLink'''+
                  ' End nomefornecedor'+

                  ' FROM movtos_empresas nt'+
                  '   LEFT JOIN produto pr   on pr.codproduto=nt.codproduto'+
                  '   LEFT JOIN fornecedor fo  on fo.codfornecedor=lpad(nt.num_ref, 6, ''000000'')'+
                  ' WHERE nt.ind_tipo=''DF''';

                  // Produtos Codigos e/ou Produtos Like ---------------------
                  If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                   MySqlClausula2:=
                    MySqlClausula2+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
                  Else If Trim(sgProdutos)<>'' Then
                   MySqlClausula2:=
                    MySqlClausula2+' AND pr.CodProduto in ('+sgProdutos+')'
                  Else If Trim(sgLikeProdutos)<>'' Then
                   MySqlClausula2:=
                    MySqlClausula2+' AND '+sgLikeProdutos;

                  // Fornecedores --------------------------------------------
                  If Trim(sgFornecedores)<>'' Then
                   MySqlClausula2:=MySqlClausula2+' AND pr.principalfor in ('+sgFornecedores+')'
                  Else
                   MySqlClausula2:=MySqlClausula2+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

                  // Grupos e SubGrupos --------------------------------------
                  If Trim(sgGrupos)<>'' Then
                   MySqlClausula2:=MySqlClausula2+' AND '+sgGrupos;

                  If Not bgTodasEmpresas Then
                   MySqlClausula2:=MySqlClausula2+' AND   nt.codfilial in ('+sCodLoja+')';
  MySqlClausula2:=
   MySqlClausula2+' AND   nt.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

  If igNrEmpProc=1 Then
   MySqlClausula2:=MySqlClausula2+' GROUP BY 1,2,3,4,5,13,14,15'
  Else
   MySqlClausula2:=MySqlClausula2+' GROUP BY 2,3,4,5,13,14,15';

  MySqlClausula2:=
   MySqlClausula2+' HAVING SUM(nt.vlr_total_ref) >0';

  //==========================================================================
  // (PS) Pagamento de Substituio Tributria ===============================
  //==========================================================================
  MySqlClausula3:=' UNION';

  If igNrEmpProc=1 Then
   MySqlClausula3:=MySqlClausula3+' SELECT nt.codfilial, Coalesce(pr.codproduto,''SEM'') codproduto,'
  Else
   MySqlClausula3:=MySqlClausula3+' SELECT ''00'' codfilial, Coalesce(pr.codproduto,''SEM'') codproduto,';

  MySqlClausula3:=
   MySqlClausula3+' Coalesce(pr.apresentacao,''PRODUTO SemLink com Docto de Origem'') apresentacao,'+
                  ' nt.codfornecedor codcomprovante,'+
                  ' nt.cod_situacao Ent_SAI,'+
                  ' SUM(COALESCE(nt.quant_ref,0)) Qtd_Total,'+
                  ' SUM(COALESCE(nt.valbruto,0)) Tot_Valbruto,'+
                  ' SUM(COALESCE(nt.valdesconto,0)) Tot_valdesconto,'+
                  ' SUM(Cast(REPLACE (nt.des_situacao,'','' ,''.'') as Numeric(12,2))) Tot_valipi,'+
                  ' SUM(nt.valsubstituicao) Tot_valsubstituicao,'+
                  ' SUM(nt.preco) Tot_valrepasse,'+
                  ' SUM(nt.vlr_total_ref) Tot_valtotal,'+
                  ' nt.nomefornecedor nomecomprovante,'+
                  ' Case'+
                  '   When Coalesce(pr.codproduto,''SEM'')<>''SEM'' Then'+
                  '     pr.principalfor'+
                  '   Else'+
                  '     fo.codfornecedor'+
                  ' End principalfor,'+
                  ' Case'+
                  '   When Coalesce(pr.codproduto,''SEM'')<>''SEM'' Then'+
                  '     pr.nomefornecedor'+
                  '   Else'+
                  '     fo.nomefornecedor||''-SemLink'''+
                  ' End nomefornecedor'+

                  ' FROM movtos_empresas nt'+
                  '   LEFT JOIN produto pr   on pr.codproduto=nt.codproduto'+
                  '   LEFT JOIN fornecedor fo  on fo.codfornecedor=lpad(nt.num_ref, 6, ''000000'')'+
                  ' WHERE nt.ind_tipo=''PS''';

                  // Produtos Codigos e/ou Produtos Like ---------------------
                  If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                   MySqlClausula3:=
                    MySqlClausula3+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
                  Else If Trim(sgProdutos)<>'' Then
                   MySqlClausula3:=
                    MySqlClausula3+' AND pr.CodProduto in ('+sgProdutos+')'
                  Else If Trim(sgLikeProdutos)<>'' Then
                   MySqlClausula3:=
                    MySqlClausula3+' AND '+sgLikeProdutos;

                  // Fornecedores --------------------------------------------
                  If Trim(sgFornecedores)<>'' Then
                   MySqlClausula3:=MySqlClausula3+' AND pr.principalfor in ('+sgFornecedores+')'
                  Else
                   MySqlClausula3:=MySqlClausula3+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';
          
                  // Grupos e SubGrupos --------------------------------------
                  If Trim(sgGrupos)<>'' Then
                   MySqlClausula3:=MySqlClausula3+' AND '+sgGrupos;

                  If Not bgTodasEmpresas Then
                   MySqlClausula3:=MySqlClausula3+' AND   nt.codfilial in ('+sCodLoja+')';

  MySqlClausula3:=
   MySqlClausula3+' AND   nt.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

  If igNrEmpProc=1 Then 
   MySqlClausula3:=MySqlClausula3+' GROUP BY 1,2,3,4,5,13,14,15'
  Else
   MySqlClausula3:=MySqlClausula3+' GROUP BY 2,3,4,5,13,14,15';

  MySqlClausula3:=
   MySqlClausula3+' having SUM(nt.vlr_total_ref) >0';

  //==========================================================================
  // (VC) Valor Contabil =====================================================
  //==========================================================================
  MySqlClausula4:=' UNION';

  If igNrEmpProc=1 Then
   MySqlClausula4:=MySqlClausula4+' SELECT nt.codfilial, Coalesce(pr.codproduto,''SEM'') codproduto,'
  Else
   MySqlClausula4:=MySqlClausula4+' SELECT ''00'' codfilial, Coalesce(pr.codproduto,''SEM'') codproduto,';

  MySqlClausula4:=
   MySqlClausula4+' Coalesce(pr.apresentacao,''PRODUTO SemLink com Docto de Origem'') apresentacao,'+
                  ' nt.codfornecedor codcomprovante,'+
                  ' nt.cod_situacao Ent_SAI,'+
                  ' SUM(COALESCE(nt.quant_ref,0)) Qtd_Total,'+
                  ' SUM(COALESCE(nt.valbruto,0)) Tot_Valbruto,'+
                  ' SUM(COALESCE(nt.valdesconto,0)) Tot_valdesconto,'+
                  ' SUM(Cast(REPLACE (nt.des_situacao,'','' ,''.'') as Numeric(12,2))) Tot_valipi,'+
                  ' SUM(nt.valsubstituicao) Tot_valsubstituicao,'+
                  ' SUM(nt.preco) Tot_valrepasse,'+
                  ' SUM(nt.vlr_total_ref) Tot_valtotal,'+
                  ' nt.nomefornecedor nomecomprovante,'+
                  ' Case'+
                  '   When Coalesce(pr.codproduto,''SEM'')<>''SEM'' Then'+
                  '     pr.principalfor'+
                  '   Else'+
                  '     fo.codfornecedor'+
                  ' End principalfor,'+
                  ' Case'+
                  '   When Coalesce(pr.codproduto,''SEM'')<>''SEM'' Then'+
                  '     pr.nomefornecedor'+
                  '   Else'+
                  '     fo.nomefornecedor||''-SemLink'''+
                  ' End nomefornecedor'+

                  ' FROM movtos_empresas nt'+
                  '   LEFT JOIN produto pr     on pr.codproduto=nt.codproduto'+
                  '   LEFT JOIN fornecedor fo  on fo.codfornecedor=lpad(nt.num_ref, 6, ''000000'')'+
                  ' WHERE nt.ind_tipo=''VC''';

                  // Produtos Codigos e/ou Produtos Like ---------------------
                  If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                   MySqlClausula4:=
                    MySqlClausula4+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
                  Else If Trim(sgProdutos)<>'' Then
                   MySqlClausula4:=
                    MySqlClausula4+' AND pr.CodProduto in ('+sgProdutos+')'
                  Else If Trim(sgLikeProdutos)<>'' Then
                   MySqlClausula4:=
                    MySqlClausula4+' AND '+sgLikeProdutos;

                  // Fornecedores --------------------------------------------
                  If Trim(sgFornecedores)<>'' Then
                   MySqlClausula4:=MySqlClausula4+' AND pr.principalfor in ('+sgFornecedores+')'
                  Else
                   MySqlClausula4:=MySqlClausula4+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

                  // Grupos e SubGrupos --------------------------------------
                  If Trim(sgGrupos)<>'' Then
                   MySqlClausula4:=MySqlClausula4+' AND '+sgGrupos;

                  If Not bgTodasEmpresas Then
                   MySqlClausula4:=MySqlClausula4+' AND nt.codfilial in ('+sCodLoja+')';

  MySqlClausula4:=
   MySqlClausula4+' AND   nt.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

  If igNrEmpProc=1 Then
   MySqlClausula4:=MySqlClausula4+' GROUP BY 1,2,3,4,5,13,14,15'
  Else
   MySqlClausula4:=MySqlClausula4+' GROUP BY 2,3,4,5,13,14,15';

  MySqlClausula4:=
   MySqlClausula4+' having SUM(nt.vlr_total_ref) >0'+

                  // ORDENA TUDO ----------------------------------
                  ' ORDER BY 1,3,5,4';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql+MySqlClausula1+MySqlClausula2+MySqlClausula3+MySqlClausula4;
  DMBelShop.CDS_Busca.Open;

  // Processamento ===========================================================
  If Not DMBelShop.CDS_Busca.IsEmpty Then
  Begin
    DMVirtual.CDS_V_MargLucroBonif.Append;
    DMVirtual.CDS_V_MargLucroBonifAPRESENTACAO.AsString:='Perodo de '+sgDtaInicio+' a '+sgDtaFim;
    DMVirtual.CDS_V_MargLucroBonif.Post;

    DMVirtual.CDS_V_MargLucroBonif.Append;
    DMVirtual.CDS_V_MargLucroBonifAPRESENTACAO.AsString:='';
    DMVirtual.CDS_V_MargLucroBonif.Post;

    DMVirtual.CDS_V_MargLucroBonifRes.Append;
    DMVirtual.CDS_V_MargLucroBonifResDESCOMPROVANTE.AsString:='Perodo de '+sgDtaInicio+' a '+sgDtaFim;
    DMVirtual.CDS_V_MargLucroBonifRes.Post;

    DMVirtual.CDS_V_MargLucroBonifRes.Append;
    DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString:='';
    DMVirtual.CDS_V_MargLucroBonifRes.Post;

    MontaProgressBar(True, FrmBelShop);
    pgProgBar.Properties.Max:=DMBelShop.CDS_Busca.RecordCount;

    DMVirtual.CDS_V_MargLucroBonif.DisableControls;
    PC_FinanMargemLucro.TabIndex:=2;
    cVlrTotSemLink:=0;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin
      Application.ProcessMessages;

      pgProgBar.Position:=DMBelShop.CDS_Busca.RecNo;
      Refresh;

      if DMVirtual.CDS_V_MargemLucro.Locate('CODFILIAL;CODPRODUTO',
             VarArrayOf([DMBelShop.CDS_Busca.FieldByName('CODFILIAL').AsString,
             Trim(DMBelShop.CDS_Busca.FieldByName('CodProduto').AsString)]),[]) Then
      Begin
        // ===================================================================
        // Atualiza BAP em Vendas Faturamento
        // Dbg_FinanMargemLucro
        // DMVirtual.CDS_V_MargemLucro
        // ===================================================================
        DMVirtual.CDS_V_MargemLucro.Edit;
        If DMBelShop.CDS_Busca.FieldByName('ENT_SAI').AsString='E' Then
        Begin
           DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency:=
                     DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency+
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency;
        End;

        If DMBelShop.CDS_Busca.FieldByName('ENT_SAI').AsString='S' Then
        Begin
          DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency:=
                     DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency-
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency;
        End;

        If DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency<>0 Then
         DMVirtual.CDS_V_MargemLucroPER_BAP_VENDA.AsCurrency:=RoundTo(
                        ((DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency*100)/
                         DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency),-2)
        Else
         DMVirtual.CDS_V_MargemLucroPER_BAP_VENDA.AsCurrency:=0.00;

        DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency:=
                             DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC.AsCurrency-
                             DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency;

        DMVirtual.CDS_V_MargemLucroVLR_MARGEM_FINAL.AsCurrency:=
                         DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency-
                         DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency;

        If Rb_MLTpCalculoMargem.Checked Then
         Begin
           If DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency<>0 Then
            DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=RoundTo((((
                   DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency-
                   DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency)/
                    DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency)*100),-2)
           Else
            DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=0.00;

         End
        Else // If Rb_MLTpCalculoMargem.Checked Then
         Begin
           If DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency<>0 Then
            Begin
              DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=RoundTo((((
              DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency*100)/
              DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency)-100),-2)
            End
           Else
            Begin
              DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=100.00;
            End;
         End; // If Rb_MLTpCalculoMargem.Checked Then

        DMVirtual.CDS_V_MargemLucro.Post;

        // ===================================================================
        // Insert Itens de Resultado
        // Dbg_FinanMLResultado
        // DMVirtual.CDS_V_MargLucroBonifRes
        // ===================================================================
        if Not DMVirtual.CDS_V_MargLucroBonifRes.Locate('LOJA;CODCOMPROVANTE',
             VarArrayOf([DMBelShop.CDS_Busca.FieldByName('CODFILIAL').AsString,
             Trim(DMBelShop.CDS_Busca.FieldByName('CODCOMPROVANTE').AsString)]),[]) Then
         Begin
           DMVirtual.CDS_V_MargLucroBonifRes.Append;
           DMVirtual.CDS_V_MargLucroBonifResLOJA.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('CODFILIAL').AsString;
           DMVirtual.CDS_V_MargLucroBonifResCODCOMPROVANTE.AsString:=
               Trim(DMBelShop.CDS_Busca.FieldByName('CODCOMPROVANTE').AsString);
           DMVirtual.CDS_V_MargLucroBonifResDESCOMPROVANTE.AsString:=
                    DMBelShop.CDS_Busca.FieldByName('NOMECOMPROVANTE').AsString;

           If Trim(DMBelShop.CDS_Busca.FieldByName('ENT_SAI').AsString)='S' Then
            DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString:='Sada'
           Else
            DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString:='Entrada';

           DMVirtual.CDS_V_MargLucroBonifResQTD_TOTAL.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('QTD_TOTAL').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALBRUTO.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALBRUTO').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALDESCONTO.AsString:=
                    DMBelShop.CDS_Busca.FieldByName('TOT_VALDESCONTO').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALIPI.AsString:=
                         DMBelShop.CDS_Busca.FieldByName('TOT_VALIPI').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALSUBSTITUICAO.AsString:=
                DMBelShop.CDS_Busca.FieldByName('TOT_VALSUBSTITUICAO').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALREPASSE.AsString:=
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALREPASSE').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALRETIDO.AsCurrency:=0;
         End
        Else
         Begin
           DMVirtual.CDS_V_MargLucroBonifRes.Edit;
           DMVirtual.CDS_V_MargLucroBonifResQTD_TOTAL.AsCurrency:=
                        DMVirtual.CDS_V_MargLucroBonifResQTD_TOTAL.AsCurrency+
                        DMBelShop.CDS_Busca.FieldByName('QTD_TOTAL').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALBRUTO.AsCurrency:=
                     DMVirtual.CDS_V_MargLucroBonifResTOT_VALBRUTO.AsCurrency+
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALBRUTO').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALDESCONTO.AsCurrency:=
                  DMVirtual.CDS_V_MargLucroBonifResTOT_VALDESCONTO.AsCurrency+
                  DMBelShop.CDS_Busca.FieldByName('TOT_VALDESCONTO').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALIPI.AsCurrency:=
                       DMVirtual.CDS_V_MargLucroBonifResTOT_VALIPI.AsCurrency+
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALIPI').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALSUBSTITUICAO.AsCurrency:=
              DMVirtual.CDS_V_MargLucroBonifResTOT_VALSUBSTITUICAO.AsCurrency+
              DMBelShop.CDS_Busca.FieldByName('TOT_VALSUBSTITUICAO').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALREPASSE.AsCurrency:=
                   DMVirtual.CDS_V_MargLucroBonifResTOT_VALREPASSE.AsCurrency+
                   DMBelShop.CDS_Busca.FieldByName('TOT_VALREPASSE').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency:=
                     DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency+
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency;
         End; // if Not DMVirtual.CDS_V_MargLucroBonifRes.Locate('CODCOMPROVANTE',Trim(DMBelShop.CDS_Busca.FieldByName('CODCOMPROVANTE').AsString),[]) Then
         DMVirtual.CDS_V_MargLucroBonifRes.Post;

        // ===================================================================
        // Insert Itens de BAP Bonificacao/Ajuste/Perda
        // Dbg_FinanMargemLucroBonif
        // DMVirtual.CDS_V_MargLucroBonif
        // ===================================================================
        DMVirtual.CDS_V_MargLucroBonif.Append;
        DMVirtual.CDS_V_MargLucroBonifCODFILIAL.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('CODFILIAL').AsString;
        DMVirtual.CDS_V_MargLucroBonifCODPRODUTO.AsString:=
                   Trim(DMBelShop.CDS_Busca.FieldByName('CodProduto').AsString);
        DMVirtual.CDS_V_MargLucroBonifAPRESENTACAO.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('APRESENTACAO').AsString;
        DMVirtual.CDS_V_MargLucroBonifCODCOMPROVANTE.AsString:=
               Trim(DMBelShop.CDS_Busca.FieldByName('CODCOMPROVANTE').AsString);
        DMVirtual.CDS_V_MargLucroBonifENT_SAI.AsString:=
                            DMBelShop.CDS_Busca.FieldByName('ENT_SAI').AsString;
        DMVirtual.CDS_V_MargLucroBonifQTD_TOTAL.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('QTD_TOTAL').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALBRUTO.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALBRUTO').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALDESCONTO.AsString:=
                    DMBelShop.CDS_Busca.FieldByName('TOT_VALDESCONTO').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALIPI.AsString:=
                         DMBelShop.CDS_Busca.FieldByName('TOT_VALIPI').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALSUBSTITUICAO.AsString:=
                DMBelShop.CDS_Busca.FieldByName('TOT_VALSUBSTITUICAO').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALREPASSE.AsString:=
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALREPASSE').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALTOTAL.AsCurrency:=RoundTo(
                 DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency,-2);
        DMVirtual.CDS_V_MargLucroBonifNOMECOMPROVANTE.AsString:=
                    DMBelShop.CDS_Busca.FieldByName('NOMECOMPROVANTE').AsString;
        DMVirtual.CDS_V_MargLucroBonifPRINCIPALFOR.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('PRINCIPALFOR').AsString;
        DMVirtual.CDS_V_MargLucroBonifNOMEFORNECEDOR.AsString:=
                     DMBelShop.CDS_Busca.FieldByName('NOMEFORNECEDOR').AsString;
        DMVirtual.CDS_V_MargLucroBonif.Post;

      End; // if DMVirtual.CDS_V_MargemLucro.Locate('CODFILIAL;CODPRODUTO',...

      // Lancamentos SEM Correspondencia com ChaveNf
      If Trim(DMBelShop.CDS_Busca.FieldByName('CodProduto').AsString)='SEM' Then
      Begin
        // ===================================================================
        // Insert Itens de BAP Bonificacao/Ajuste/Perda
        // Dbg_FinanMargemLucroBonif
        // DMVirtual.CDS_V_MargLucroBonif
        // ===================================================================
        DMVirtual.CDS_V_MargLucroBonif.Append;
        DMVirtual.CDS_V_MargLucroBonifCODFILIAL.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('CODFILIAL').AsString;
        DMVirtual.CDS_V_MargLucroBonifCODPRODUTO.AsString:=
                   Trim(DMBelShop.CDS_Busca.FieldByName('CodProduto').AsString);
        DMVirtual.CDS_V_MargLucroBonifAPRESENTACAO.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('APRESENTACAO').AsString;
        DMVirtual.CDS_V_MargLucroBonifCODCOMPROVANTE.AsInteger:=
                  DMBelShop.CDS_Busca.FieldByName('CODCOMPROVANTE').AsInteger+1;
        DMVirtual.CDS_V_MargLucroBonifENT_SAI.AsString:=
                            DMBelShop.CDS_Busca.FieldByName('ENT_SAI').AsString;
        DMVirtual.CDS_V_MargLucroBonifQTD_TOTAL.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('QTD_TOTAL').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALBRUTO.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALBRUTO').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALDESCONTO.AsString:=
                    DMBelShop.CDS_Busca.FieldByName('TOT_VALDESCONTO').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALIPI.AsString:=
                         DMBelShop.CDS_Busca.FieldByName('TOT_VALIPI').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALSUBSTITUICAO.AsString:=
                DMBelShop.CDS_Busca.FieldByName('TOT_VALSUBSTITUICAO').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALREPASSE.AsString:=
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALREPASSE').AsString;
        DMVirtual.CDS_V_MargLucroBonifTOT_VALTOTAL.AsCurrency:=RoundTo(
                 DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency,-2);
        DMVirtual.CDS_V_MargLucroBonifNOMECOMPROVANTE.AsString:=
                    DMBelShop.CDS_Busca.FieldByName('NOMECOMPROVANTE').AsString;
        DMVirtual.CDS_V_MargLucroBonifPRINCIPALFOR.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('PRINCIPALFOR').AsString;
        DMVirtual.CDS_V_MargLucroBonifNOMEFORNECEDOR.AsString:=
                     DMBelShop.CDS_Busca.FieldByName('NOMEFORNECEDOR').AsString;
        DMVirtual.CDS_V_MargLucroBonif.Post;

        // ===================================================================
        // Insert Itens de Resultado Sem Link
        // Dbg_FinanMLResultado
        // DMVirtual.CDS_V_MargLucroBonifRes
        // ===================================================================
        if Not DMVirtual.CDS_V_MargLucroBonifRes.Locate('LOJA;CODCOMPROVANTE',
             VarArrayOf([DMBelShop.CDS_Busca.FieldByName('CODFILIAL').AsString,
             DMBelShop.CDS_Busca.FieldByName('CODCOMPROVANTE').AsInteger+1]),[]) Then
         Begin
           DMVirtual.CDS_V_MargLucroBonifRes.Append;
           DMVirtual.CDS_V_MargLucroBonifResLOJA.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('CODFILIAL').AsString;
           DMVirtual.CDS_V_MargLucroBonifResCODCOMPROVANTE.AsInteger:=
                  DMBelShop.CDS_Busca.FieldByName('CODCOMPROVANTE').AsInteger+1;
           DMVirtual.CDS_V_MargLucroBonifResDESCOMPROVANTE.AsString:=
              Trim(DMBelShop.CDS_Busca.FieldByName('NOMECOMPROVANTE').AsString)+'-SemLink';

           If Trim(DMBelShop.CDS_Busca.FieldByName('ENT_SAI').AsString)='S' Then
            Begin
              cVlrTotSemLink:=cVlrTotSemLink-DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency;
              DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString:='Sada'
            End
           Else
            Begin
              cVlrTotSemLink:=cVlrTotSemLink+DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency;
              DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString:='Entrada';
            End;

           DMVirtual.CDS_V_MargLucroBonifResQTD_TOTAL.AsString:=
                          DMBelShop.CDS_Busca.FieldByName('QTD_TOTAL').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALBRUTO.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALBRUTO').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALDESCONTO.AsString:=
                    DMBelShop.CDS_Busca.FieldByName('TOT_VALDESCONTO').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALIPI.AsString:=
                         DMBelShop.CDS_Busca.FieldByName('TOT_VALIPI').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALSUBSTITUICAO.AsString:=
                DMBelShop.CDS_Busca.FieldByName('TOT_VALSUBSTITUICAO').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALREPASSE.AsString:=
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALREPASSE').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsString;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALRETIDO.AsCurrency:=0;
         End
        Else // if Not DMVirtual.CDS_V_MargLucroBonifRes.Locate('LOJA;CODCOMPROVANTE',...
         Begin
           DMVirtual.CDS_V_MargLucroBonifRes.Edit;
           DMVirtual.CDS_V_MargLucroBonifResQTD_TOTAL.AsCurrency:=
                        DMVirtual.CDS_V_MargLucroBonifResQTD_TOTAL.AsCurrency+
                        DMBelShop.CDS_Busca.FieldByName('QTD_TOTAL').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALBRUTO.AsCurrency:=
                     DMVirtual.CDS_V_MargLucroBonifResTOT_VALBRUTO.AsCurrency+
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALBRUTO').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALDESCONTO.AsCurrency:=
                  DMVirtual.CDS_V_MargLucroBonifResTOT_VALDESCONTO.AsCurrency+
                  DMBelShop.CDS_Busca.FieldByName('TOT_VALDESCONTO').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALIPI.AsCurrency:=
                       DMVirtual.CDS_V_MargLucroBonifResTOT_VALIPI.AsCurrency+
                       DMBelShop.CDS_Busca.FieldByName('TOT_VALIPI').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALSUBSTITUICAO.AsCurrency:=
              DMVirtual.CDS_V_MargLucroBonifResTOT_VALSUBSTITUICAO.AsCurrency+
              DMBelShop.CDS_Busca.FieldByName('TOT_VALSUBSTITUICAO').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALREPASSE.AsCurrency:=
                   DMVirtual.CDS_V_MargLucroBonifResTOT_VALREPASSE.AsCurrency+
                   DMBelShop.CDS_Busca.FieldByName('TOT_VALREPASSE').AsCurrency;
           DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency:=
                     DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency+
                     DMBelShop.CDS_Busca.FieldByName('TOT_VALTOTAL').AsCurrency;
         End;
        DMVirtual.CDS_V_MargLucroBonifRes.Post;

      End; // If Trim(DMBelShop.CDS_Busca.FieldByName('CodProduto').AsString)='SEM' Then

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    MontaProgressBar(False, FrmBelShop);

  End; // If Not DMBelShop.DMBelShop.CDS_Busca.IsEmpty Then
  DMVirtual.CDS_V_MargLucroBonif.EnableControls;
  DMVirtual.CDS_V_MargLucroBonif.First;

  // Atualiza Data da Ultima Alterao de Preo ==============================
  If (igTpApres=0) or (igTpApres=1) or (igTpApres=4) or (igTpApres=5) Then
  Begin
    OdirPanApres.Caption:='AGUARDE !! Atualizando Data da Ultima Alterao da Lista de Preos...';
    Refresh;

    DMVirtual.CDS_V_MargemLucro.DisableControls;
    DMVirtual.CDS_V_MargemLucro.First;

    MontaProgressBar(True, FrmBelShop);
    pgProgBar.Properties.Max:=DMVirtual.CDS_V_MargemLucro.RecordCount;
    While not DMVirtual.CDS_V_MargemLucro.Eof do
    Begin
      Application.ProcessMessages;

      pgProgBar.Position:=DMVirtual.CDS_V_MargemLucro.RecNo;
      Refresh;

      If (DMVirtual.CDS_V_MargemLucroCODFILIAL.AsString<>'99') and (Trim(DMVirtual.CDS_V_MargemLucroULT_ALTERACAO.AsString)='/  /')Then
      Begin
        MySql:=' SELECT l.dataalteracao'+
               ' FROM LISTAPRE l'+
               ' WHERE l.codlista='+QuotedStr(BuscaCodLista(DMVirtual.CDS_V_MargemLucroCODFILIAL.AsString))+
               ' AND l.codproduto='+QuotedStr(DMVirtual.CDS_V_MargemLucroCODPRODUTO.AsString);
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;

        If Trim(DMBelShop.CDS_BuscaRapida.FieldBYName('dataalteracao').AsString)<>'' Then
        Begin
          DMVirtual.CDS_V_MargemLucro.Edit;

          DMVirtual.CDS_V_MargemLucroULT_ALTERACAO.AsString:=
                DMBelShop.CDS_BuscaRapida.FieldBYName('dataalteracao').AsString;

          DMVirtual.CDS_V_MargemLucro.Post;
        End; // If (DMVirtual.CDS_V_MargemLucroCODFILIAL.AsString<>'99') and (Trim(DMVirtual.CDS_V_MargemLucroULT_ALTERACAO.AsString)='/  /')Then
        DMBelShop.CDS_BuscaRapida.Close;

      End; //If DMVirtual.CDS_V_MargemLucroCODFILIAL.AsString<>'99' Then

      DMVirtual.CDS_V_MargemLucro.Next;
    End; // While not DMVirtual.CDS_V_MargemLucro.Eof do
    MontaProgressBar(False, FrmBelShop);

  End; // If (iTpApres=0) or (iTpApres=1) or (iTpApres=4) or (iTpApres=5) Then

  // =========================================================================
  // Atualiza Total BAP em Vendas Faturamento
  // Dbg_FinanMargemLucro
  // DMVirtual.CDS_V_MargemLucro
  // =========================================================================
  if DMVirtual.CDS_V_MargemLucro.Locate('CODFILIAL','99',[]) Then
  Begin
    DMVirtual.CDS_V_MargemLucro.Edit;
    DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency:=
                      StrToCurr(DMVirtual.CDS_V_MargemLucroAG_VLR_BAP.AsString);

    DMVirtual.CDS_V_MargemLucroPER_BAP_VENDA.AsCurrency:=RoundTo(((
                        DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency*100)/
                        DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency),-2);

    DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency:=
                             DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC.AsCurrency-
                             DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency;

    DMVirtual.CDS_V_MargemLucroVLR_MARGEM_FINAL.AsCurrency:=
                         DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency-
                         DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency;

    If Rb_MLTpCalculoMargem.Checked Then
     Begin
       DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=RoundTo((((
                   DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency-
                   DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency)/
                   DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency)*100),-2);
     End
    Else
     Begin
       If DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency<>0 Then
        DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=RoundTo((((
                DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency*100)/
                DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC_BAP.AsCurrency)-100),-2)
       Else
        DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency:=100.00;
     End;

    DMVirtual.CDS_V_MargemLucro.Post;
  End; // if DMVirtual.CDS_V_MargemLucro.Locate('CODFILIAL','99',[]) Then

  // =========================================================================
  // Calcular Resultado Final
  // Dbg_FinanMLResFinal
  // DMVirtual.CDS_V_MargLucroFinal
  // =========================================================================
  DMVirtual.CDS_V_MargLucroFinal.Append;
  DMVirtual.CDS_V_MargLucroFinalDesc_Tipo.AsString:='Perodo de '+sgDtaInicio+' a '+sgDtaFim;
  DMVirtual.CDS_V_MargLucroFinal.Post;

  DMVirtual.CDS_V_MargLucroFinal.Append;
  DMVirtual.CDS_V_MargLucroFinalDesc_Tipo.AsString:='';
  DMVirtual.CDS_V_MargLucroFinal.Post;

  DMVirtual.CDS_V_MargLucroFinal.Append;

  If igNrEmpProc=1 Then
   DMVirtual.CDS_V_MargLucroFinalLoja.AsString:=f_Troca('''','',sCodLoja)
  Else
   DMVirtual.CDS_V_MargLucroFinalLoja.AsString:='00';

  DMVirtual.CDS_V_MargLucroFinalDesc_Tipo.AsString:='Total Faturamento';
  DMVirtual.CDS_V_MargLucroFinalTot_Vendas.AsCurrency:=
                           DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency;
  DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency:=
                           DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC.AsCurrency;
  DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency:=
                                  DMVirtual.CDS_V_MargemLucroLucro.AsCurrency;
  DMVirtual.CDS_V_MargLucroFinal.Post;

  DMVirtual.CDS_V_MargLucroFinal.Append;

  If igNrEmpProc=1 Then
   DMVirtual.CDS_V_MargLucroFinalLoja.AsString:=f_Troca('''','',sCodLoja)
  Else
   DMVirtual.CDS_V_MargLucroFinalLoja.AsString:='00';

  DMVirtual.CDS_V_MargLucroFinalDesc_Tipo.AsString:='Total Bonif/Ajustes/Perdas';
  DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency:=
                 DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency+cVlrTotSemLink;
  DMVirtual.CDS_V_MargLucroFinal.Post;

  DMVirtual.CDS_V_MargLucroFinal.Append;

  If igNrEmpProc=1 Then
   DMVirtual.CDS_V_MargLucroFinalLoja.AsString:=f_Troca('''','',sCodLoja)
  Else
   DMVirtual.CDS_V_MargLucroFinalLoja.AsString:='00';

  DMVirtual.CDS_V_MargLucroFinalDesc_Tipo.AsString:='Total Final';
  DMVirtual.CDS_V_MargLucroFinalTot_Vendas.AsCurrency:=
                           DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency;
  DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency:=
                           DMVirtual.CDS_V_MargemLucroVLR_VENDA_PC.AsCurrency-
                (DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency+cVlrTotSemLink);

  If Rb_MLTpCalculoMargem.Checked Then
   Begin
     DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency:=((
                        DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency-
                        DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency)/
                        DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency)*100;
   End
  Else
   Begin
     If DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency<>0 Then
      DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency:=(((
                       DMVirtual.CDS_V_MargemLucroVLR_VENDA_PV.AsCurrency*100)/
                       DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency)-100)
     Else
      DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency:=100.00;
   End;

  DMVirtual.CDS_V_MargLucroFinal.Post;

  DMVirtual.CDS_V_MargemLucro.EnableControls;

  // Ordena DMVirtual.CDS_V_MargemLucro=======================================
  OrderGrid:='Crescente';
  Dbg_FinanMargemLucroTitleClick(Dbg_FinanMargemLucro.Columns[15]);

  DMVirtual.CDS_V_MargemLucro.First;
  DMVirtual.CDS_V_MargLucroBonifRes.First;
  DMVirtual.CDS_V_MargLucroFinal.First;
  DMBelShop.CDS_Busca.Close;

  OdirPanApres.Visible:=False;
  PC_FinanMargemLucro.TabIndex:=1;

End; // Margem de Lucro - Calcula Margem de Lucro  Final ///////////////////////

// Margem de Lucro - Calcula Margem de Lucro ///////////////////////////////////
Function TFrmBelShop.CalculaMargemLucro(sCodLoja: String; iTpApres: Integer; bUsarPcMedioTE: Boolean): Boolean;
Var
  Vlr_Venda_PV, Vlr_Venda_PC: Currency;
  sL1, sL11, sL2, sL3, sL4: TStringList;
  sDtaPCI, sDtaPCF: String;
Begin
  Result:=True;

  sL1:=TStringList.Create;
  sL11:=TStringList.Create;
  sL2:=TStringList.Create;
  sL3:=TStringList.Create;
  sL4:=TStringList.Create; // Entradas

  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Grupos e SubGrupos Selecionados ===========================================
  sgGrupos:='';
  sgSubGrupos:='';
  If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GruposProdutos.First;
    While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    Begin
      Refresh;

      If sgGrupos='' Then
       sgGrupos:='(pr.codgrupo='+
                     QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString)
      Else
       sgGrupos:=sgGrupos+' Or pr.codgrupo='+
                    QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString);

      If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
      Begin
        While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        Begin
          Refresh;

          If sgSubGrupos='' Then
           sgSubGrupos:=QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString)
          Else
           sgSubGrupos:=sgSubGrupos+', '+
              QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString);

          DMVirtual.CDS_V_SubGruposProdutos.Next;
        End; // While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        DMVirtual.CDS_V_SubGruposProdutos.First;

      End; // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then

      If sgSubGrupos<>'' Then
       sgGrupos:=sgGrupos+' and pr.codgruposub in ('+sgSubGrupos+')';

      sgSubGrupos:='';

      DMVirtual.CDS_V_GruposProdutos.Next;
    End; // While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    DMVirtual.CDS_V_GruposProdutos.First;

    If sgGrupos<>'' Then
     sgGrupos:=sgGrupos+')';

  End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then

  // Monta Select (Padro) =====================================================
  // 0 - P Custo Mdio / P Venda Mdia (CUSTO=PC+TE)
  // 1 - P Custo Mdio / P Venda Lista (CUSTO=PC+TE)
  // 4 - P Custo Ultima Compra / P Venda Media (CUSTO=UC+TE)
  // 5 - P Custo Ultima Compra / P Venda Lista   (CUSTO=UC+TE)
  If (iTpApres=0) or (iTpApres=1) or (iTpApres=4) or (iTpApres=5) Then
  Begin
    sL1.Text:=' SELECT prv.codfilial codfilial, prv.codproduto, prv.apresentacao,'+
              ' prv.codfornecedor, prv.nomefornecedor,'+
              ' 0.00 Tot_Qtd_Compra,'+

              ' prv.precocompra PrecoCusto,'+

              ' SUM(prv.Tot_Qtd_Venda) Tot_Qtd_Venda,'+
              ' prv.PrecoVenda,';

              If Rb_MLTpCalculoMargem.Checked Then
               Begin
                 sL1.Text:=sL1.Text+' CASE'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
                                    '     CAST(ROUND(((prv.PrecoVenda-prv.precocompra)/prv.PrecoVenda)*100,2) AS NUMERIC(12,2))'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)=0) THEN'+
                                    '     100.00'+
                                    '   ELSE'+
                                    '     0.00'+
                                    ' END "%_MARGEM_1=((PV-PC)/PV)*100",';
               End
              Else
               Begin
                 sL1.Text:=sL1.Text+' CASE'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
                                    '     CAST(ROUND(((prv.PrecoVenda/prv.precocompra)*100)-100,2) AS NUMERIC(12,2))'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)=0) THEN'+
                                    '     100.00'+
                                    '   ELSE'+
                                    '     0.00'+
                                    ' END "%_MARGEM_1=((PV-PC)/PV)*100",';
               End; // If Rb_MLTpCalculoMargem.Checked Then

    sL1.Text:=
     sL1.Text+' CASE'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
              '     CAST(ROUND(((prv.PrecoVenda/prv.precocompra)*100)-100,2) AS NUMERIC(12,2))'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)=0) THEN'+
              '     100.00'+
              '   ELSE'+
              '     0.00'+
              ' END "%_MARGEM_2=((PV/PC)*100)-100",'+

              ' (Coalesce(prv.PrecoVenda,0)-Coalesce(prv.precocompra,0)) "VALOR_MARGEM",'+

              ' CASE'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
              '     CAST(ROUND(((prv.PrecoVenda-prv.precocompra)/prv.precocompra)*100,2) AS NUMERIC(12,2))'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)=0) THEN'+
              '     100.00'+
              '   ELSE'+
              '     0.00'+
              ' END Per_MarkUp,'+

              ' CASE'+
              '   WHEN Coalesce(prv.PrecoVenda,0)<>0 THEN'+
              '     CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda),2) AS NUMERIC(12,2))'+
              '   ELSE'+
              '     0.00'+
              ' END Vlr_Venda_PV,'+

              ' CASE'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
              '     CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.precocompra),2) AS NUMERIC(12,2))'+
              '   ELSE'+
              '     0.00'+
              ' END Vlr_Venda_PC,';

              If Rb_MLTpCalculoMargem.Checked Then
               Begin
                 sL1.Text:=sL1.Text+' CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.precocompra))/(SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)*100),2) AS NUMERIC(12,2)) "% Lucro",';
               End
              Else
               Begin
                 sL1.Text:=sL1.Text+' CASE'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
                                    '     CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.precocompra))/(SUM(prv.Tot_Qtd_Venda)*prv.precocompra)*100),2) AS NUMERIC(12,2))'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)=0) THEN'+
                                    '     100.00'+
                                    '   ELSE'+
                                    '     0.00'+
                                    ' END "% Lucro",';
               End;

    sL11.Text:=' 0.00 "% Part Venda",'+
               ' 0.00 "% Part Custo",'+
               ' 9000 NumSeq, 0.00 VLR_BAP, 0.00 PER_BAP_VENDA,'+

               ' CASE'+
               '   WHEN Coalesce(prv.PrecoCompra,0)<>0 THEN'+
               '     CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.precocompra),2) AS NUMERIC(12,2))'+
               '   ELSE'+
               '     0'+
               ' END VLR_VENDA_PC_BAP,';

               If Rb_MLTpCalculoMargem.Checked Then
                Begin
                  sL11.Text:=sL11.Text+' CASE'+
                                       '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
                                       '     CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.precocompra))/(SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)*100),2) AS NUMERIC(12,2))'+
                                       '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)=0) THEN'+
                                       '     100.00'+
                                       '   ELSE'+
                                       '     0.00'+
                                       ' END PER_LUCRO_FINAL,';
                End
               Else
                Begin
                  sL11.Text:=sL11.Text+' CASE'+
                                       '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)<>0) THEN'+
                                       '     CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.precocompra))/(SUM(prv.Tot_Qtd_Venda)*prv.PrecoCompra)*100),2) AS NUMERIC(12,2))'+
                                       '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) AND (Coalesce(prv.PrecoCompra,0)=0) THEN'+
                                       '     100.00'+
                                       '   ELSE'+
                                       '     0.00'+
                                       ' END PER_LUCRO_FINAL,';
                End;

    sL11.Text:=
      sL11.Text+' ''  /  /    '' ULT_ALTERACAO,'+
                ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda),2) AS NUMERIC(12,2)))-'+
                ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoCompra),2) AS NUMERIC(12,2))) Vlr_Margem_Total,'+
                ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda),2) AS NUMERIC(12,2)))-'+
                ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoCompra),2) AS NUMERIC(12,2))) Vlr_Margem_Final';
  End; // If (iTpApres=0) or (iTpApres=1) or (iTpApres=4) or (iTpApres=5) Then

  // 2 - P Custo Lista / P Venda Mdia
  // 3 - P Custo Lista / P Venda Lista
  If (iTpApres=2) or (iTpApres=3) Then
  Begin
    sL1.Text:=' SELECT prv.codfilial codfilial, prv.codproduto, prv.apresentacao,'+
              ' prv.codfornecedor, prv.nomefornecedor,'+
              ' 0.00 Tot_Qtd_Compra,'+
              ' prv.PrecoCusto,'+
              ' SUM(prv.Tot_Qtd_Venda) Tot_Qtd_Venda,'+
              ' prv.PrecoVenda,';

              If Rb_MLTpCalculoMargem.Checked Then
               Begin
                 sL1.Text:=sL1.Text+' CASE'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)<>0) THEN'+
                                    '     CAST(ROUND(((prv.PrecoVenda-prv.PrecoCusto)/prv.PrecoVenda)*100,2) AS NUMERIC(12,2))'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)=0) THEN'+
                                    '     100.00'+
                                    '   ELSE'+
                                    '     0.00'+
                                    '   END "%_MARGEM_1=((PV-PC)/PV)*100",';
               End
              Else
               Begin
                 sL1.Text:=sL1.Text+' CASE'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)<>0) THEN'+
                                    '     CAST(ROUND(((prv.PrecoVenda/prv.PrecoCusto)*100)-100,2) AS NUMERIC(12,2))'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)=0) THEN'+
                                    '     100.00'+
                                    '   ELSE'+
                                    '     0.00'+
                                    '   END "%_MARGEM_1=((PV-PC)/PV)*100",';
               End; // If Rb_MLTpCalculoMargem.Checked Then

    sL1.Text:=
     sL1.Text+' CASE'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)<>0) THEN'+
              '     CAST(ROUND(((prv.PrecoVenda/prv.PrecoCusto)*100)-100,2) AS NUMERIC(12,2))'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)=0) THEN'+
              '     100.00'+
              '   ELSE'+
              '     0.00'+
              '   END "%_MARGEM_2=((PV/PC)*100)-100",'+
              ' (Coalesce(prv.PrecoVenda,0)-Coalesce(prv.PrecoCusto,0)) "VALOR_MARGEM",'+

              ' CASE'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)<>0) THEN'+
              '     CAST(ROUND(((prv.PrecoVenda-prv.PrecoCusto)/prv.PrecoCusto)*100,2) AS NUMERIC(12,2))'+
              '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)=0) THEN'+
              '     100.00'+
              '   ELSE'+
              '     0.00'+
              ' END Per_MarkUp,'+

              ' CASE'+
              '   WHEN Coalesce(prv.PrecoVenda,0)<>0 THEN'+
              '     CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda),2) AS NUMERIC(12,2))'+
              '   ELSE'+
              '     0.00'+
              ' END Vlr_Venda_PV,'+
       
              ' CASE'+
              '   WHEN Coalesce(prv.PrecoCusto,0)<>0 THEN'+
              '     CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto),2) AS NUMERIC(12,2))'+
              '   ELSE'+
              '     0.00'+
              ' END Vlr_Venda_PC,';

              If Rb_MLTpCalculoMargem.Checked Then
               Begin
                 sL1.Text:=sL1.Text+' CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto))/(SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)*100),2) AS NUMERIC(12,2)) "% Lucro",';
               End
              Else
               Begin
                 sL1.Text:=sL1.Text+' CASE'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)<>0) THEN'+
                                    '     CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto))/(SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto)*100),2) AS NUMERIC(12,2))'+
                                    '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)=0) THEN'+
                                    '     100.00'+
                                    '   ELSE'+
                                    '     0.00'+
                                    ' END "% Lucro",';
               End;

    sL11.Text:=' 0.00 "% Part Venda",'+
               ' 0.00 "% Part Custo",'+
               ' 9000 NumSeq, 0.00 VLR_BAP, 0.00 PER_BAP_VENDA,'+

               ' CASE'+
               '   WHEN (Coalesce(prv.PrecoCusto,0)<>0) THEN'+
               '     CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto),2) AS NUMERIC(12,2))'+
               '   ELSE'+
               '     0.00'+
               ' END VLR_VENDA_PC_BAP,';

               If Rb_MLTpCalculoMargem.Checked Then
                Begin
                  sL11.Text:=sL11.Text+' CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto))/(SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)*100),2) AS NUMERIC(12,2)) PER_LUCRO_FINAL,';
                End
               Else
                Begin
                  sL11.Text:=sL11.Text+' CASE'+
                                       '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)<>0) THEN'+
                                       '     CAST(ROUND((((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda)-(SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto))/(SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto)*100),2) AS NUMERIC(12,2))'+
                                       '   WHEN (Coalesce(prv.PrecoVenda,0)<>0) and (Coalesce(prv.PrecoCusto,0)=0) THEN'+
                                       '     100.00'+
                                       '   ELSE'+
                                       '     0.00'+
                                       ' END PER_LUCRO_FINAL,';
                End;

    sL11.Text:=
     sL11.Text+' (Cast(lpad(extract(day from prv.dataalteracao),2,''0'') as varchar(2))||''.''||'+
               '  Cast(lpad(extract(month from prv.dataalteracao),2,''0'') as varchar(2))||''.''||'+
               '  Cast(lpad(extract(Year from prv.dataalteracao),4,''0'') as varchar(4))) ULT_ALTERACAO,'+

               ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda),2) AS NUMERIC(12,2)))-'+
               ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto),2) AS NUMERIC(12,2))) Vlr_Margem_Total,'+

               ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoVenda),2) AS NUMERIC(12,2)))-'+
               ' (CAST(ROUND((SUM(prv.Tot_Qtd_Venda)*prv.PrecoCusto),2) AS NUMERIC(12,2))) Vlr_Margem_Final';
  End; // If (iTpApres=2) or (iTpApres=3) Then

  //===============================================
  // Preo Medio: Custo e Venda (CUSTO=PC+TE)
  //===============================================
  // 0 - P Custo Mdio / P Venda Mdia (CUSTO=PC+TE)
  If iTpApres=0 Then
  Begin
    If igNrEmpProc=1 Then
     sL2.Text:=' FROM (SELECT pv.codfilial, pv.codproduto, pr.apresentacao,'
    Else
     sL2.Text:=' FROM (SELECT ''00'' codfilial, pv.codproduto, pr.apresentacao,';

    sL2.Text:=
     sL2.Text+' pr.principalfor codfornecedor, pr.nomefornecedor,'+
              ' lp.precocompra,'+
              ' SUM(pv.quant_ref) Tot_Qtd_Venda,'+
              ' SUM(pv.preco) Tot_VlrTotal,'+

              ' CASE'+
              '   WHEN SUM(COALESCE(pv.quant_ref,0))=0 THEN'+
              '     SUM(pv.preco)'+
              '   ELSE'+
              '     CAST(ROUND( SUM(pv.preco)/SUM(pv.quant_ref),2) AS NUMERIC(12,2))'+
              ' END PrecoVenda'+

              ' FROM MOVTOS_EMPRESAS pv, produto pr, listapre lp'+
              ' WHERE pv.codproduto=pr.codproduto'+
              ' AND   pv.codproduto=lp.codproduto'+
              ' AND   pv.ind_tipo=''DM''';

              If (igNrEmpProc=1) And (sCodLoja<>'99') And (Trim(sCodLoja)<>'') Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))+
                                  ' AND   pv.codfilial='+sCodLoja
              Else If (igNrEmpProc=1) Or (bgTodasEmpresas)Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))
              Else
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))+
                                  ' AND   pv.codfilial in ('+sCodLoja+')';

    sL2.Text:=
     sL2.Text+' AND   pv.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL2.Text:=
                sL2.Text+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL2.Text:=sL2.Text+' AND pr.principalfor in ('+sgFornecedores+')'
              Else
               sL2.Text:=sL2.Text+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

              // Grupos e SubGrupos --------------------------------------
              If Trim(sgGrupos)<>'' Then
               sL2.Text:=sL2.Text+' AND '+sgGrupos;

    If igNrEmpProc=1 Then
     sL2.Text:=sL2.Text+' GROUP BY 1, 2, 3, 4, 5, 6'
    Else
     sL2.Text:=sL2.Text+' GROUP BY 2, 3, 4, 5, 6';

    sL2.Text:=
     sL2.Text+' HAVING (SUM(pv.quant_ref)<>0  AND SUM(pv.preco)<>0)) Prv';

    sL3.Text:=
     sL3.Text+' GROUP BY prv.codfilial, prv.codproduto, prv.apresentacao,'+
              '          prv.codfornecedor, prv.nomefornecedor,'+
              '          prv.precocompra, prv.PrecoVenda';
  End; // If iTpApres=0 Then

  //===================================================
  // P Custo Mdio / P Venda Lista (CUSTO=PC+TE)
  //===================================================
  // 1 - P Custo Mdio / P Venda Lista (CUSTO=PC+TE)
  If iTpApres=1 Then
  Begin
    If igNrEmpProc=1 Then
     sL2.Text:=' FROM (SELECT pv.codfilial, pv.codproduto, pr.apresentacao,'
    Else
     sL2.Text:=' FROM (SELECT ''00'' codfilial, pv.codproduto, pr.apresentacao,';

    sL2.Text:=
     sL2.Text+' pr.principalfor codfornecedor, pr.nomefornecedor,'+
              ' lp.precocompra,'+
              ' SUM(pv.quant_ref) Tot_Qtd_Venda,'+
              ' ROUND(lp.precovenda*SUM(pv.quant_ref),2) Tot_VlrTotal,'+

              ' CAST(lp.precovenda AS NUMERIC(12,2)) PrecoVenda'+

              ' FROM MOVTOS_EMPRESAS pv, produto pr, listapre lp'+
              ' WHERE pv.codproduto=pr.codproduto'+
              ' AND   pv.codproduto=lp.codproduto'+
              ' AND   pv.ind_tipo=''DM''';

              If (igNrEmpProc=1) And (sCodLoja<>'99') And (Trim(sCodLoja)<>'') Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))+
                                  ' AND   pv.codfilial='+sCodLoja
              Else If (igNrEmpProc=1) Or (bgTodasEmpresas)Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))
              Else
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))+
                                  ' AND   pv.codfilial in ('+sCodLoja+')';

    sL2.Text:=
     sL2.Text+' AND   pv.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL2.Text:=
                sL2.Text+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL2.Text:=sL2.Text+' AND pr.principalfor in ('+sgFornecedores+')'
              Else
               sL2.Text:=sL2.Text+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

              // Grupos e SubGrupos --------------------------------------
              If Trim(sgGrupos)<>'' Then
               sL2.Text:=sL2.Text+' AND '+sgGrupos;

    If igNrEmpProc=1 Then
     sL2.Text:=sL2.Text+' GROUP BY pv.codfilial, pv.codproduto,'
    Else
     sL2.Text:=sL2.Text+' GROUP BY pv.codproduto,';

    sL2.Text:=
     sL2.Text+' pr.apresentacao,'+
              ' pr.principalfor, pr.nomefornecedor, lp.precovenda, lp.precocompra'+
              ' HAVING (SUM(pv.quant_ref)<>0  AND SUM(pv.preco)<>0)'+
              ') Prv';

    sL3.Text:=
     sL3.Text+' GROUP BY prv.codfilial, prv.codproduto, prv.apresentacao,'+
              '          prv.codfornecedor, prv.nomefornecedor,'+
              ' prv.precocompra, prv.PrecoVenda';
  End; // If iTpApres=1 Then

  //===============================================
  // Custo: Lista - Preo Medio Venda
  //===============================================
  // 2 - P Custo Lista / P Venda Mdia
  If iTpApres=2 Then
  Begin
    If igNrEmpProc=1 Then
     sL2.Text:=' FROM (SELECT pv.codfilial, pv.codproduto, pr.apresentacao,'
    Else
     sL2.Text:=' FROM (SELECT ''00'' codfilial, pv.codproduto, pr.apresentacao,';

    sL2.Text:=
     sL2.Text+' pr.principalfor codfornecedor, pr.nomefornecedor,'+
              ' CAST(lp.precocompra AS NUMERIC(12,2)) PrecoCusto,'+
              ' lp.dataalteracao,'+
              ' SUM(pv.quant_ref) Tot_Qtd_Venda,'+
              ' SUM(pv.preco) Tot_VlrTotal,'+
              ' CAST(ROUND( SUM(pv.preco)/SUM(pv.quant_ref),2) AS NUMERIC(12,2)) PrecoVenda'+

              ' FROM MOVTOS_EMPRESAS pv, produto pr, listapre lp'+

              ' WHERE pv.codproduto=pr.codproduto'+
              ' AND   pv.codproduto=lp.codproduto'+
              ' AND   pv.ind_tipo=''DM''';

              If (igNrEmpProc=1) And (sCodLoja<>'99') And (Trim(sCodLoja)<>'') Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))+
                                  ' AND   pv.codfilial='+sCodLoja
              Else If (igNrEmpProc=1) Or (bgTodasEmpresas)Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))
              Else
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))+
                                  ' AND   pv.codfilial in ('+sCodLoja+')';

    sL2.Text:=
     sL2.Text+' AND   pv.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL2.Text:=
                sL2.Text+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL2.Text:=sL2.Text+' AND pr.principalfor in ('+sgFornecedores+')'
              Else
               sL2.Text:=sL2.Text+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

              // Grupos e SubGrupos --------------------------------------
              If Trim(sgGrupos)<>'' Then
               sL2.Text:=sL2.Text+' AND '+sgGrupos;

    If igNrEmpProc=1 Then
     sL3.Text:=sL3.Text+' GROUP BY 1, 2, 3, 4, 5, 6, 7'
    Else
     sL3.Text:=sL3.Text+' GROUP BY 2, 3, 4, 5, 6, 7';

    sL3.Text:=
     sL3.Text+' HAVING (SUM(pv.quant_ref)<>0  AND SUM(pv.preco)<>0) ) Prv'+
              ' GROUP BY 1,2,3,4,5,7,9,24';

  End; // If iTpApres=2 Then

  //===============================================
  // P Custo Lista / P Venda Lista
  //===============================================
  // 3 - P Custo Lista / P Venda Lista
  If iTpApres=3 Then
  Begin
    If igNrEmpProc=1 Then
     sL2.Text:=' FROM (SELECT pv.codfilial, pv.codproduto, pr.apresentacao,'
    Else
     sL2.Text:=' FROM (SELECT ''00'' codfilial, pv.codproduto, pr.apresentacao,';

    sL2.Text:=
     sL2.Text+' pr.principalfor codfornecedor, pr.nomefornecedor,'+
              ' CAST(coalesce(lp.precocompra,0) AS NUMERIC(12,2)) PrecoCusto,'+
              ' lp.dataalteracao,'+
              ' SUM(pv.quant_ref) Tot_Qtd_Venda,'+
              ' ROUND(SUM(coalesce(lp.precovenda,0)*coalesce(pv.quant_ref,0)),2) Tot_VlrTotal,'+
              ' CAST(coalesce(lp.precovenda,0) AS NUMERIC(12,2)) PrecoVenda'+

              ' FROM MOVTOS_EMPRESAS pv, produto pr, listapre lp'+

              ' WHERE pv.codproduto=pr.codproduto'+
              ' AND   pv.codproduto=lp.codproduto'+
              ' AND   pv.ind_tipo=''DM''';

              If (igNrEmpProc=1) And (sCodLoja<>'99') And (Trim(sCodLoja)<>'') Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))+
                                  ' AND   pv.codfilial='+sCodLoja
              Else If (igNrEmpProc=1) Or (bgTodasEmpresas)Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))
              Else
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))+
                                  ' AND   pv.codfilial in ('+sCodLoja+')';

    sL2.Text:=
     sL2.Text+' AND   pv.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL2.Text:=
                sL2.Text+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL2.Text:=sL2.Text+' AND pr.principalfor in ('+sgFornecedores+')'
              Else
               sL2.Text:=sL2.Text+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

              // Grupos e SubGrupos --------------------------------------
              If Trim(sgGrupos)<>'' Then
               sL2.Text:=sL2.Text+' AND '+sgGrupos;

    If igNrEmpProc=1 Then
     sL3.Text:=sL3.Text+' GROUP BY 1, 2, 3, 4, 5, 6, 7, 10'
    Else
     sL3.Text:=sL3.Text+' GROUP BY 2, 3, 4, 5, 6, 7, 10';

    sL3.Text:=
     sL3.Text+' HAVING (SUM(pv.quant_ref)<>0  AND SUM(pv.preco)<>0) ) Prv'+
              ' GROUP BY 1,2,3,4,5,7,9, 24';
  End; // If iTpApres=3 Then

  //===========================================================
  // P Custo Ultima Compra / P Venda Media (CUSTO=UC+TE)
  //===========================================================
  // 4 - P Custo Ultima Compra / P Venda Media (CUSTO=UC+TE)
  If iTpApres=4 Then
  Begin
    If igNrEmpProc=1 Then
     sL2.Text:=' FROM (SELECT pv.codfilial, pv.codproduto, pr.apresentacao,'
    Else
     sL2.Text:=' FROM (SELECT ''00'' codfilial, pv.codproduto, pr.apresentacao,';

    sL2.Text:=
     sL2.Text+' pr.principalfor codfornecedor, pr.nomefornecedor,'+
              ' lp.precocompra,'+
              ' SUM(pv.quant_ref) Tot_Qtd_Venda,'+
              ' SUM(pv.preco) Tot_VlrTotal,'+

              ' CASE'+
              '   WHEN SUM(COALESCE(pv.quant_ref,0))=0 THEN'+
              '     SUM(pv.preco)'+
              '   ELSE'+
              '     CAST(ROUND( SUM(pv.preco)/SUM(pv.quant_ref),2) AS NUMERIC(12,2))'+
              ' END PrecoVenda'+

              ' FROM MOVTOS_EMPRESAS pv, produto pr, listapre lp'+

              ' WHERE pv.codproduto=pr.codproduto'+
              ' AND   pv.codproduto=lp.codproduto'+
              ' AND   pv.ind_tipo=''DM''';

              If (igNrEmpProc=1) And (sCodLoja<>'99') And (Trim(sCodLoja)<>'') Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))+
                                  ' AND   pv.codfilial='+sCodLoja
              Else If (igNrEmpProc=1) Or (bgTodasEmpresas)Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))
              Else
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))+
                                  ' AND   pv.codfilial in ('+sCodLoja+')';

    sL2.Text:=
     sL2.Text+' AND   pv.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL2.Text:=
                sL2.Text+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL2.Text:=sL2.Text+' AND pr.principalfor in ('+sgFornecedores+')'
              Else
               sL2.Text:=sL2.Text+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

              // Grupos e SubGrupos --------------------------------------
              If Trim(sgGrupos)<>'' Then
               sL2.Text:=sL2.Text+' AND '+sgGrupos;

    If igNrEmpProc=1 Then
     sL2.Text:=sL2.Text+' GROUP BY 1, 2, 3, 4, 5, 6'
    Else
     sL2.Text:=sL2.Text+' GROUP BY 2, 3, 4, 5, 6';

    sL2.Text:=
     sL2.Text+' HAVING (SUM(pv.quant_ref)<>0  AND SUM(pv.preco)<>0)) Prv';

    sL3.Text:=
     sL3.Text+' GROUP BY prv.codfilial, prv.codproduto, prv.apresentacao,'+
              '          prv.codfornecedor, prv.nomefornecedor,'+
              '          prv.precocompra,  prv.PrecoVenda';
  End; // If iTpApres=4 Then

  //=============================================================
  // P Custo Ultima Compra / P Venda Lista   (CUSTO=UC+TE)
  //=============================================================
  // 5 - P Custo Ultima Compra / P Venda Lista   (CUSTO=UC+TE)
  If iTpApres=5 Then
  Begin
    If igNrEmpProc=1 Then
     sL2.Text:=' FROM (SELECT pv.codfilial, pv.codproduto, pr.apresentacao,'
    Else
     sL2.Text:=' FROM (SELECT ''00'' codfilial, pv.codproduto, pr.apresentacao,';

    sL2.Text:=
     sL2.Text+' pr.principalfor codfornecedor, pr.nomefornecedor,'+
              ' lp.precocompra,'+
              ' SUM(pv.quant_ref) Tot_Qtd_Venda,'+
              ' CAST(ROUND(SUM(pv.quant_ref)*lp.precovenda,2) AS NUMERIC(12,2)) Tot_VlrTotal,'+
              ' CAST(lp.precovenda AS NUMERIC(12,2)) PrecoVenda'+

              ' FROM MOVTOS_EMPRESAS pv, produto pr, listapre lp'+

              ' WHERE pv.codproduto=pr.codproduto'+
              ' AND   pv.codproduto=lp.codproduto'+
              ' AND   pv.ind_tipo=''DM''';

              If (igNrEmpProc=1) And (sCodLoja<>'99') And (Trim(sCodLoja)<>'') Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))+
                                  ' AND   pv.codfilial='+sCodLoja
              Else If (igNrEmpProc=1) Or (bgTodasEmpresas)Then
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))
              Else
               sL2.Text:=sL2.Text+' AND   lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')))+
                                  ' AND   pv.codfilial in ('+sCodLoja+')';

    sL2.Text:=
     sL2.Text+' AND   pv.dta_ref BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim); // Periodo

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL2.Text:=
                sL2.Text+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL2.Text:=
                sL2.Text+' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL2.Text:=sL2.Text+' AND pr.principalfor in ('+sgFornecedores+')'
              Else
               sL2.Text:=sL2.Text+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

              // Grupos e SubGrupos --------------------------------------
              If Trim(sgGrupos)<>'' Then
               sL2.Text:=sL2.Text+' AND '+sgGrupos;

    If igNrEmpProc=1 Then
     sL2.Text:=sL2.Text+' GROUP BY pv.codfilial, pv.codproduto,'
    Else
     sL2.Text:=sL2.Text+' GROUP BY pv.codproduto,';

    sL2.Text:=
     sL2.Text+' pr.apresentacao, pr.principalfor, pr.nomefornecedor,'+
              ' lp.precovenda, lp.PrecoCompra'+
              ' HAVING (SUM(pv.quant_ref)<>0  AND SUM(pv.preco)<>0)) Prv';

    sL3.Text:=
     sL3.Text+' GROUP BY prv.codfilial, prv.codproduto, prv.apresentacao,'+
              '          prv.codfornecedor, prv.nomefornecedor,'+
              '          prv.PrecoCompra, prv.PrecoVenda';
  End; // If iTpApres=5 Then

  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=sL1.Text+sL11.Text+sL2.Text+sL3.Text;
  DMBelShop.CDS_BuscaRapida.Open;

  FreeAndNil(sL1);
  FreeAndNil(sL11);
  FreeAndNil(sL2);
  FreeAndNil(sL3);

  If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('codproduto').AsString)='' Then
  Begin
    FreeAndNil(sL4);
    DMBelShop.CDS_BuscaRapida.Close;
    Result:=False;
    Exit;
  End;

  // Transfere Dados para Outro ClientDatSet
  DMVirtual.CDS_V_MargemLucro.Data:=DMBelShop.CDS_BuscaRapida.Data;
  DMBelShop.CDS_BuscaRapida.Close;

  // Entradas para Tipos = 0, 1 ================================================
  // 0 - P Custo Mdio / P Venda Mdia (CUSTO=PC+TE)
  // 1 - P Custo Mdio / P Venda Lista (CUSTO=PC+TE)
  If (iTpApres=0) or (iTpApres=1) Then
  Begin
    sDtaPCI:='01'+Copy(sgDtaI,3,8);
    sDtaPCF:='01'+Copy(sgDtaF,3,8);

    If igNrEmpProc=1 Then
     sL4.Text:='SELECT pc.codfilial, pc.codproduto, lp.dataalteracao,'
    Else
     sL4.Text:='SELECT ''00'' codfilial, pc.codproduto, lp.dataalteracao,';

    sL4.Text:=
     sL4.Text+' SUM(COALESCE(pc.quant_ref,0)) Qtd_Total,';

              if bUsarPcMedioTE Then // Custo Medio nas Transferencias
               Begin
                 sL4.Text:=
                  sL4.Text+' SUM(CASE'+
                           '    WHEN pc.ind_tipo=''TE'' THEN'+
                           '      COALESCE(pc.quant_ref,0)'+
                           '    ELSE'+
                           '      0'+
                           ' END) Tot_Qtd_TE,'+

                           ' SUM(CASE'+
                           '    WHEN pc.ind_tipo=''PC'' THEN'+
                           '      COALESCE(pc.quant_ref,0)'+
                           '    ELSE'+
                           '      0'+
                           ' END) Tot_Qtd_PR';
               End
              Else // Custo Normal das Transferencias
               Begin
                 sL4.Text:=
                  sL4.Text+' SUM(decode(pc.ind_tipo,''TE'',COALESCE(pc.preco,0),''PC'',COALESCE(pc.vlr_total_ref,0))) Tot_VlrTotal,'+
                           ' CAST(ROUND((SUM(decode(pc.ind_tipo,''TE'',COALESCE(pc.preco,0),''PC'',COALESCE(pc.vlr_total_ref,0)))/SUM(pc.quant_ref)),2) AS NUMERIC(12,2)) PrecoCusto';
               End; // if bUsarPcMedioTE Then // Custo Medio nas Transferencias

    sL4.Text:=
     sL4.Text+' FROM MOVTOS_EMPRESAS pc'+
              '        Left Join LISTAPRE lp  ON lp.codproduto=pc.codproduto';

              If igNrEmpProc=1 Then
               sL4.Text:=sL4.Text+'                              AND lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))
              Else
               sL4.Text:=sL4.Text+'                              AND lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')));

    sL4.Text:=
     sL4.Text+' WHERE pc.ind_tipo IN (''PC'', ''TE'')';

              If igNrEmpProc=1 Then
               sL4.Text:=sL4.Text+' AND   pc.codfilial='+sCodLoja
              Else if Not bgTodasEmpresas Then
               sL4.Text:=sL4.Text+' AND   pc.codfilial in ('+sCodLoja+')';

    sL4.Text:=
     sL4.Text+' AND   pc.dta_ref BETWEEN '+QuotedStr(sDtaPCI)+' AND '+QuotedStr(sDtaPCF)+ // Periodo Ano
              ' AND   pc.codproduto=:CodProd';

    If igNrEmpProc=1 Then
     sL4.Text:=sL4.Text+' GROUP BY 1, 2, 3'
    Else
     sL4.Text:=sL4.Text+' GROUP BY 2, 3';

    // Busca Ultimo Preo de Custo Mdio do Periodo
    MySqlDML:=' SELECT CAST((SUM(COALESCE(pc.vlr_total_ref,0))/SUM(COALESCE(pc.quant_ref,0))) AS NUMERIC(12,2)) PrecoCusto'+
              ' FROM MOVTOS_EMPRESAS pc'+
              ' WHERE pc.ind_tipo='+QuotedStr('PC');

              If igNrEmpProc=1 Then
               MySqlDML:=MySqlDML+' AND   pc.codfilial='+sCodLoja
              Else if Not bgTodasEmpresas Then
               MySqlDML:=MySqlDML+' AND   pc.codfilial in ('+sCodLoja+')';

    MySqlDML:=
     MySqlDML+' AND   pc.dta_ref BETWEEN '+QuotedStr(sDtaPCI)+' AND '+QuotedStr(sDtaPCF)+ // Periodo Ano
              ' AND   pc.codproduto=:CodProd';
    DMBelShop.SQLQuery2.Close;
    DMBelShop.SQLQuery2.SQL.Clear;
    DMBelShop.SQLQuery2.SQL.Add(MySqlDML);

    // Busca Ultimo Preo de Custo Mdio
    MySqlDML:=' SELECT FIRST 1 CAST((COALESCE(pc.vlr_total_ref,0)/COALESCE(pc.quant_ref,0)) AS NUMERIC(12,2)) PrecoCusto,'+
              ' lp.dataalteracao'+

              ' FROM movtos_empresas pc'+
              '     LEFT JOIN listapre lp  ON lp.codproduto=pc.codproduto'+
              '                           AND lp.precocompra<=pc.preco';

              If igNrEmpProc=1 Then
               MySqlDML:=MySqlDML+'                AND lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))
              Else
               MySqlDML:=MySqlDML+'                AND lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')));

    MySqlDML:=
     MySqlDML+' WHERE pc.codproduto=:CodProd'+
              ' AND   pc.ind_tipo='+QuotedStr('PC')+
              ' ORDER BY pc.dta_ref DESC';
    DMBelShop.SQLQuery3.Close;
    DMBelShop.SQLQuery3.SQL.Clear;
    DMBelShop.SQLQuery3.SQL.Add(MySqlDML);
  End; // If (iTpApres=0) or (iTpApres=1) Then

  // Entradas para Tipos = 4, 5 ================================================
  // 4 - P Custo Ultima Compra / P Venda Media (CUSTO=UC+TE)
  // 5 - P Custo Ultima Compra / P Venda Lista   (CUSTO=UC+TE)
  If (iTpApres=4) or (iTpApres=5) Then
  Begin
    If igNrEmpProc=1 Then
     sL4.Text:='SELECT uc.codfilial, uc.codproduto, lp.dataalteracao,'
    Else
     sL4.Text:='SELECT ''00'' codfilial, uc.codproduto, lp.dataalteracao,';

    sL4.Text:=
     sL4.Text+' SUM(COALESCE(uc.quant_ref,0)) Qtd_Total,';

              if bUsarPcMedioTE Then // Custo Ultima Compra nas Transferencias
               Begin
                 sL4.Text:=
                  sL4.Text+' SUM(CASE'+
                           '   WHEN uc.ind_tipo=''TE'' THEN'+
                           '      COALESCE(uc.quant_ref,0)'+
                           '    ELSE'+
                           '      0'+
                           ' END) Tot_Qtd_TE,'+

                           ' SUM(CASE'+
                           '    WHEN uc.ind_tipo=''UC'' THEN'+
                           '      COALESCE(uc.quant_ref,0)'+
                           '    ELSE'+
                           '      0'+
                           ' END) Tot_Qtd_PR';
               End
              Else // Custo Normal das Transferencias
               Begin
                 sL4.Text:=
                  sL4.Text+' SUM(decode(pc.ind_tipo,''TE'',COALESCE(pc.preco,0),''UC'','+
                           '            ((COALESCE(pc.valbruto,0)-COALESCE(pc.valdesconto,0))+'+
                           '             (Cast(REPLACE (COALESCE(pc.des_situacao,0),'','' ,''.'') as Numeric(12,2))+'+
                           '              COALESCE(pc.valsubstituicao,0))))) Tot_VlrTotal,'+

                           ' CAST(ROUND((SUM(decode(pc.ind_tipo,''TE'',COALESCE(pc.preco,0),''UC'','+
                           '            ((COALESCE(pc.valbruto,0)-COALESCE(pc.valdesconto,0))+'+
                           '             (Cast(REPLACE (COALESCE(pc.des_situacao,0),'','' ,''.'') as Numeric(12,2))+'+
                           '              COALESCE(pc.valsubstituicao,0)))))/SUM(pc.quant_ref)),2) AS NUMERIC(12,2)) PrecoCusto';
               End; // if bUsarPcMedioTE Then // Custo Ultima Compra nas Transferencias

    sL4.Text:=
     sL4.Text+' FROM MOVTOS_EMPRESAS uc'+
              '        Left Join LISTAPRE lp  ON lp.codproduto=uc.codproduto';

              If igNrEmpProc=1 Then
               sL4.Text:=sL4.Text+'                              AND lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))
              Else
               sL4.Text:=sL4.Text+'                              AND lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')));

    sL4.Text:=
     sL4.Text+'  WHERE uc.ind_tipo IN (''UC'', ''TE'')';

              If igNrEmpProc=1 Then
               sL4.Text:=sL4.Text+' AND   uc.codfilial='+sCodLoja
              Else if Not bgTodasEmpresas Then
               sL4.Text:=sL4.Text+' AND   uc.codfilial in ('+sCodLoja+')';

    sL4.Text:=
     sL4.Text+' AND   uc.dta_ref BETWEEN '+QuotedStr(sgDtaI)+' AND '+QuotedStr(sgDtaF)+ // Periodo Ano
              ' AND   uc.codproduto=:CodProd';

              If igNrEmpProc=1 Then
               sL4.Text:=sL4.Text+' GROUP BY 1, 2, 3'
              Else
               sL4.Text:=sL4.Text+' GROUP BY 2, 3';

    // Busca Preo de Custo ltima Compra do Periodo
    MySqlDML:=' SELECT FIRST 1'+
              ' CASE'+
              '  WHEN (COALESCE(lp.precocompra,0)<=(CASE  WHEN COALESCE(uc.valbruto,0)<>0 THEN'+
              '                                      CAST(((COALESCE(uc.valbruto,0)-COALESCE(uc.valdesconto,0)+COALESCE(uc.valsubstituicao,0))/COALESCE(uc.quant_ref,0))AS NUMERIC(12,2))'+
              '                                    ELSE'+
              '                                     COALESCE(uc.preco,0)'+
              '                                    END)) AND (COALESCE(lp.precocompra,0)<>0) THEN'+
              '     lp.precocompra'+
              '   WHEN COALESCE(uc.valbruto,0)<>0 THEN'+
              '     CAST(((COALESCE(uc.valbruto,0)-COALESCE(uc.valdesconto,0)+COALESCE(uc.valsubstituicao,0))/COALESCE(uc.quant_ref,0)) AS NUMERIC(12,2))'+
              '   ELSE'+
              '     COALESCE(uc.preco,0)'+
              ' END PrecoCusto'+

              ' FROM MOVTOS_EMPRESAS uc'+
              '   LEFT JOIN listapre lp  ON lp.codproduto=uc.codproduto';

              If igNrEmpProc=1 Then
               MySqlDML:=MySqlDML+'              AND lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))
              Else
               MySqlDML:=MySqlDML+'              AND lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')));

              MySqlDML:=MySqlDML+' WHERE uc.ind_tipo='+QuotedStr('UC');

              If igNrEmpProc=1 Then
               MySqlDML:=MySqlDML+' AND   uc.codfilial='+sCodLoja
              Else if Not bgTodasEmpresas Then
               MySqlDML:=MySqlDML+' AND   uc.codfilial in ('+sCodLoja+')';

    MySqlDML:=
     MySqlDML+' AND   uc.dta_ref BETWEEN '+QuotedStr(sgDtaI)+' AND '+QuotedStr(sgDtaF)+ // Periodo Ano
              ' AND   uc.codproduto=:CodProd'+
              ' ORDER BY uc.dta_ref DESC';
    DMBelShop.SQLQuery2.Close;
    DMBelShop.SQLQuery2.SQL.Clear;
    DMBelShop.SQLQuery2.SQL.Add(MySqlDML);

    // Busca Preo de Custo ltima Compra
    MySqlDML:=' SELECT FIRST 1'+
              ' CASE'+
              '    WHEN COALESCE(uc.valbruto,0)<>0 THEN'+
              '      CAST(((COALESCE(uc.valbruto,0)-COALESCE(uc.valdesconto,0)+COALESCE(uc.valsubstituicao,0))/COALESCE(uc.quant_ref,0))AS NUMERIC(12,2))'+
              '    ELSE'+
              '      COALESCE(uc.preco,0)'+
              ' END PrecoCusto,'+
              ' lp.dataalteracao'+

              ' FROM movtos_empresas uc'+
              '   LEFT JOIN listapre lp  ON lp.codproduto=uc.codproduto'+
              '                          AND lp.precocompra<=uc.preco';

              If igNrEmpProc=1 Then
               MySqlDML:=MySqlDML+'              AND lp.codlista='+QuotedStr(BuscaCodLista(sCodLoja))
              Else
               MySqlDML:=MySqlDML+'              AND lp.codlista='+QuotedStr(BuscaCodLista(QuotedStr('99')));
    MySqlDML:=
     MySqlDML+' WHERE uc.codproduto=:CodProd'+
              ' AND   uc.ind_tipo='+QuotedStr('UC')+
              ' ORDER BY uc.dta_ref DESC';
    DMBelShop.SQLQuery3.Close;
    DMBelShop.SQLQuery3.SQL.Clear;
    DMBelShop.SQLQuery3.SQL.Add(MySqlDML);
  End; // If (iTpApres=4) or (iTpApres=5) Then

  // Atualiza Entradas
  If Trim(sL4.Text)<>'' Then
   MargemLucroEntradas(sL4);

  FreeAndNil(sL4);
                                                    
  // Calcula Totais das Margens ================================================
  CalculaTotaisMargens;

  // Resultado Final da Margem de Lucro ========================================
  CalculaMargemFinal(sCodLoja, Vlr_Venda_PV, Vlr_Venda_PC);
End; // Margem de Lucro - Calcula Margem de Lucro //////////////////////////////

// Ordens de Compra das Lojas - Apresenta OCs Importadas ///////////////////////
Procedure TFrmBelShop.ApresOCsImportadas;
Var
  MySql: String;
Begin
  bgSiga:=False;
  FrmPeriodoApropriacao:=TFrmPeriodoApropriacao.Create(Self);
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Text:=
                      DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Text   :=
                      DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmPeriodoApropriacao.ShowModal;

  sgDtaI:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Date);
  sgDtaF:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Date);
  FreeAndNil(FrmPeriodoApropriacao);

  sgDtaI:=f_Troca('/','.',sgDtaI);
  sgDtaI:=f_Troca('-','.',sgDtaI);
  sgDtaF:=f_Troca('/','.',sgDtaF);
  sgDtaF:=f_Troca('-','.',sgDtaF);

  // Verifica se Prossegue Processamento =======================================
  If Not bgSiga Then
   Exit;

  Screen.Cursor:=crAppStart;
  MySql:=' SELECT DISTINCT'+
         ' ''Bel_''||i.cod_loja Loja, i.num_oc_importada,'+
         ' o.num_documento Num_Docto_Gerado, CAST(o.dta_documento AS DATE) Dta_Docto'+
         ' FROM OC_COMPRAR o, OC_IMPORTADAS i'+
         ' WHERE i.cod_loja=o.cod_empresa'+
         ' AND i.num_documento=o.num_documento'+
         ' AND CAST(o.dta_documento AS DATE) BETWEEN '+QuotedStr(sgDtaI)+' AND '+QuotedStr(sgDtaF)+
         ' ORDER BY 1,2,3';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;
  Screen.Cursor:=crDefault;

  If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Loja').AsString)='' Then
  Begin
    msg('Sem Ordem de Compra Importada'+cr+'no Perodo Solicitado !!', 'A');
    DMBelShop.CDS_BuscaRapida.Close;
    Exit;
  End;

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(7);

  FrmSolicitacoes.Caption:='Ordens de Compras Importadas';
  FrmSolicitacoes.Ts_MargemLucroFormulas.Caption:='Relao de Ordens de Compras Importadas';

  FrmSolicitacoes.EditorMargemLucro.Lines.Clear;
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('Ordens de Compras Importadas no Perodo de '+sgDtaI+' a '+sgDtaF);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('  Loja  N OC Importada  N Docto Gerado  Data do Docto');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('======'+BrancosEsquerda('===============',17)+
                                              BrancosEsquerda('===============',17)+
                                              BrancosEsquerda('=============',15));

  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    FrmSolicitacoes.EditorMargemLucro.Lines.Add(
                DMBelShop.CDS_BuscaRapida.FieldByName('Loja').AsString+
                BrancosEsquerda(DMBelShop.CDS_BuscaRapida.FieldByName('Num_OC_Importada').AsString,17)+
                BrancosEsquerda(DMBelShop.CDS_BuscaRapida.FieldByName('Num_Docto_Gerado').AsString,17)+
                BrancosEsquerda(DMBelShop.CDS_BuscaRapida.FieldByName('Dta_Docto').AsString,15));

    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('=======================================================');

  FrmSolicitacoes.ShowModal;
  FreeAndNil(FrmSolicitacoes);

End; // Ordens de Compra das Lojas - Apresenta OCs Importadas //////////////////

// Ordens de Compra das Lojas - Apresenta OC Importada /////////////////////////
Procedure TFrmBelShop.OCOrigemImportadas;
Var
  s, MySql: String;
Begin
  If Not DMBelShop.IBQ_AComprar.IsEmpty Then
  Begin
    MySql:=' SELECT i.num_oc_importada'+
           ' FROM oc_importadas i'+
           ' WHERE i.cod_loja='+QuotedStr(DMBelShop.IBQ_AComprarCOD_EMPRESA.AsString)+
           ' AND i.num_documento='+EdtGeraOCBuscaDocto.Text+
           ' AND i.cod_item='+QuotedStr(DMBelShop.IBQ_AComprarCOD_ITEM.AsString)+
           ' ORDER BY i.num_oc_importada';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If DMBelShop.CDS_BuscaRapida.IsEmpty Then
     msg('Sem Oc de Origem !!','A');

    s:='';
    While Not DMBelShop.CDS_BuscaRapida.Eof do
    Begin
      If s='' Then
       s:=DMBelShop.CDS_BuscaRapida.FieldBYName('num_oc_importada').AsString
      Else
       s:=s+', '+DMBelShop.CDS_BuscaRapida.FieldBYName('num_oc_importada').AsString;

      DMBelShop.CDS_BuscaRapida.Next;
    End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
    DMBelShop.CDS_BuscaRapida.Close;

    If Trim(s)<>'' Then
    Begin
      msg('N da(s) OC(s) de Orgem da Loja: Bel_'+DMBelShop.IBQ_AComprarCOD_EMPRESA.AsString+cr+s,'A');
    End;
  End; // If Not DMBelShop.IBQ_AComprar.IsEmpty Then
End; // Ordens de Compra das Lojas - Apresenta OC Importada ////////////////////

// Ordens de Compra das Lojas - Calcula OCs Importadas ////////////////////////
Procedure TFrmBelShop.CalculoOCsImportadas;
Var
  MySql: String;
  cDemanda, cMediaMes: Currency; // Busca Demanda
  bUsarCurva: Boolean; // Se produto esta na Faixa da Curva ABC Solicitada
Begin
  // Substitui Valores ---------------------------------------------------------
  ValuesCampos:=f_Troca(' NUM_SEQ ',' '+QuotedStr(IntToStr(iNumSeqDoc))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' NUM_DOCUMENTO ',' '+QuotedStr(sNumDoc)+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' DTA_DOCUMENTO ',' '+QuotedStr(DateTimeToStr(
           DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)))+' ',ValuesCampos);
  sgDtaDoc:=DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  Try
    sgDtaDoc:=DateToStr(StrToDateTime(sgDtaDoc));
  Except
    Try
      sgDtaDoc:=DateToStr(StrToDateTime(f_Troca('.','/',f_Troca('-','/',sgDtaDoc))));
    Except
      sgDtaDoc:=DateToStr(StrToDateTime(f_Troca('/','.',f_Troca('-','.',sgDtaDoc))));
    End;
  End;

  ValuesCampos:=f_Troca(' IND_OC_GERADA ',' '+QuotedStr('N')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DTA_OC_GERADA ',' NULL ',ValuesCampos);
  ValuesCampos:=f_Troca(' NUM_OC_GERADA ',' NULL ',ValuesCampos);
  ValuesCampos:=f_Troca(' OBS_OC ',' '+QuotedStr(
                     IBQ_ConsultaFilial.FieldByName('Observacao').AsString)+' ',
                                                                  ValuesCampos);
//  QuotedStr('Calculado em: '+
//                DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+
//                                         ' por '+Des_Usuario)+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' COD_EMPRESA ',' '+QuotedStr(sgCodEmp)+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DES_EMPRESA ',' '+QuotedStr(Trim(sgDesLoja))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' COD_ITEM ',' '+QuotedStr(
                 IBQ_ConsultaFilial.FieldByName('COD_ITEM').AsString)+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DES_ITEM ',' '+QuotedStr(Trim(
                IBQ_ConsultaFilial.FieldByName('DES_ITEM').AsString))+' ',ValuesCampos);

  If Trim(IBQ_ConsultaFilial.FieldByName('CODAUXILIAR').AsString)<>'' Then
   ValuesCampos:=f_Troca(' COD_REFERENCIA_FORN ',' '+QuotedStr(Trim(
              Copy(IBQ_ConsultaFilial.FieldByName('CODAUXILIAR').AsString,1,30)))+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' COD_REFERENCIA_FORN ',' NULL ',ValuesCampos);

  // Cruva ABC
  DMBelShop.SDS_BuscaCurva.Close;
  DMBelShop.SDS_BuscaCurva.ParamByName('CodLoja').AsString:=sgCodEmp;
  DMBelShop.SDS_BuscaCurva.ParamByName('CodProd').AsString:=IBQ_ConsultaFilial.FieldByName('COD_ITEM').AsString;
  DMBelShop.SDS_BuscaCurva.Open;
  If Trim(DMBelShop.SDS_BuscaCurva.FieldByName('IND_CURVA_QTD').AsString)='' Then
   ValuesCampos:=f_Troca(' CLA_CURVA_ABC ',' '+QuotedStr('E')+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' CLA_CURVA_ABC ',' '+QuotedStr(
          Trim(DMBelShop.SDS_BuscaCurva.FieldByName('IND_CURVA_QTD').AsString))+
                                                              ' ',ValuesCampos);
  DMBelShop.SDS_BuscaCurva.Close;

  ValuesCampos:=f_Troca(' COD_BARRAS ',' '+QuotedStr(Trim(
                IBQ_ConsultaFilial.FieldByName('CODBARRA').AsString))+' ',ValuesCampos);

  If Trim(IBQ_ConsultaFilial.FieldByName('CODGRUPO').AsString)<>'' Then
   ValuesCampos:=f_Troca(' COD_GRUPO ',' '+QuotedStr(
                  IBQ_ConsultaFilial.FieldByName('CODGRUPO').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' COD_GRUPO ',' NULL ',ValuesCampos);

  ValuesCampos:=f_Troca(' DES_GRUPO ',' '+QuotedStr(Trim(
               IBQ_ConsultaFilial.FieldByName('NOMEGRUPO').AsString))+' ',ValuesCampos);

  If Trim(IBQ_ConsultaFilial.FieldByName('CODSUBGRUPO').AsString)<>'' Then
   ValuesCampos:=f_Troca(' COD_SUBGRUPO ',' '+QuotedStr(
               IBQ_ConsultaFilial.FieldByName('CODSUBGRUPO').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' COD_SUBGRUPO ',' NULL ',ValuesCampos);

  ValuesCampos:=f_Troca(' DES_SUBGRUPO ',' '+QuotedStr(Trim(
            IBQ_ConsultaFilial.FieldByName('NOMESUBGRUPO').AsString))+' ',ValuesCampos);

  If Trim(IBQ_ConsultaFilial.FieldByName('CODFAMILIAPRECO').AsString)<>'' Then
   ValuesCampos:=f_Troca(' COD_FAMILIA_PRECO ',' '+QuotedStr(
           IBQ_ConsultaFilial.FieldByName('CODFAMILIAPRECO').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' COD_FAMILIA_PRECO ',' NULL ',ValuesCampos);

  ValuesCampos:=f_Troca(' DES_FAMILIA_PRECO ',' '+QuotedStr(Trim(
        IBQ_ConsultaFilial.FieldByName('NOMEFAMILIAPRECO').AsString))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' DES_GENERICO ',' '+QuotedStr(Trim(
            IBQ_ConsultaFilial.FieldByName('NOMEGENERICO').AsString))+' ',ValuesCampos);

  If Trim(IBQ_ConsultaFilial.FieldByName('CODAPLICACAO').AsString)<>'' Then
   ValuesCampos:=f_Troca(' COD_APLICACAO ',' '+QuotedStr(
              IBQ_ConsultaFilial.FieldByName('CODAPLICACAO').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' COD_APLICACAO ',' NULL ',ValuesCampos);

  ValuesCampos:=f_Troca(' DES_APLICACAO ',' '+QuotedStr(Trim(
           IBQ_ConsultaFilial.FieldByName('NOMEAPLICACAO').AsString))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' COD_REFERENCIA ',' '+QuotedStr(Trim(
              Copy(IBQ_ConsultaFilial.FieldByName('REFERENCIA').AsString,1,30)))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' COD_FORNECEDOR ',' '+QuotedStr(
            IBQ_ConsultaFilial.FieldByName('CODFORNECEDOR').AsString)+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DES_FORNECEDOR ',' '+QuotedStr(Trim(
          IBQ_ConsultaFilial.FieldByName('NOMEFORNECEDOR').AsString))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' TIP_PESSOA ',' '+QuotedStr(
                   IBQ_ConsultaFilial.FieldByName('PESSOA').AsString)+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DES_EMAIL ',' '+QuotedStr(Trim(
                   IBQ_ConsultaFilial.FieldByName('EMAIL').AsString))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' COD_GRUPO_ST ',' '+QuotedStr(
                 IBQ_ConsultaFilial.FieldByName('GRUPO_ST').AsString)+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DES_GRUPO_ST ',' '+QuotedStr(Trim(
            IBQ_ConsultaFilial.FieldByName('DES_GRUPO_ST').AsString))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' UNI_COMPRA ',' '+QuotedStr(IntToStr(StrToIntDef(
                   Trim(IBQ_ConsultaFilial.FieldByName('UNI_COMPRA').AsString),1)))+' ',
                                                                  ValuesCampos);
  ValuesCampos:=f_Troca(' UNI_VENDA ',' '+QuotedStr(IntToStr(StrToIntDef(
                    Trim(IBQ_ConsultaFilial.FieldByName('UNI_VENDA').AsString),1)))+' ',
                                                                  ValuesCampos);

  ValuesCampos:=f_Troca(' VLR_CUSTO_MEDIO ',' '+QuotedStr(
               IBQ_ConsultaFilial.FieldByName('CUSTOMEDIO').AsString)+' ',ValuesCampos);

  // Ultima Compra -------------------------------------------------------------
  MySql:=' select m.codproduto, m.dta_ref, pr.principalfor codfornecedor, pr.nomefornecedor,'+
         ' m.quant_ref, m.preco, m.vlr_total_ref'+
         ' from movtos_empresas m, Produto pr'+
         ' where m.codproduto=pr.codproduto'+
         ' AND   m.ind_tipo='+QuotedStr('UC')+
         ' and   m.codfilial='+QuotedStr(sgCodEmp)+
         ' and   m.codproduto='+QuotedStr(IBQ_ConsultaFilial.FieldByName('Cod_Item').AsString)+
         ' order by m.dta_ref desc';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('CodProduto').AsString)<>'' Then
   Begin
     ValuesCampos:=f_Troca(' DTA_ULT_COMPRA ',' '+QuotedStr(
                     DMBelShop.CDS_BuscaRapida.FieldByName('DTA_REF').AsString)+
                                                              ' ',ValuesCampos);
     ValuesCampos:=f_Troca(' COD_FOR_ULT_COMPRA ',' '+QuotedStr(
               DMBelShop.CDS_BuscaRapida.FieldByName('CODFORNECEDOR').AsString)+
                                                              ' ',ValuesCampos);
     ValuesCampos:=f_Troca(' DES_FOR_ULT_COMPRA ',' '+QuotedStr(Trim(
             DMBelShop.CDS_BuscaRapida.FieldByName('NOMEFORNECEDOR').AsString))+
                                                              ' ',ValuesCampos);
     ValuesCampos:=f_Troca(' QTD_ULT_COMPRA ',' '+QuotedStr(f_Troca('-','',
                  DMBelShop.CDS_BuscaRapida.FieldByName('QUANT_REF').AsString))+
                                                              ' ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_UNI_ULT_COMPRA ',' '+QuotedStr(
                       DMBelShop.CDS_BuscaRapida.FieldByName('PRECO').AsString)+
                                                              ' ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_TOT_ULT_COMPRA ',' '+QuotedStr(
               DMBelShop.CDS_BuscaRapida.FieldByName('VLR_TOTAL_REF').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('CodProduto').AsString)<>'' Then
   Begin
     ValuesCampos:=f_Troca(' DTA_ULT_COMPRA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' COD_FOR_ULT_COMPRA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' DES_FOR_ULT_COMPRA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' QTD_ULT_COMPRA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_UNI_ULT_COMPRA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_TOT_ULT_COMPRA ',' NULL ',ValuesCampos);
   End;  // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('CodProduto').AsString)<>'' Then
  DMBelShop.CDS_BuscaRapida.Close;

//OPSS_Normal
//  // Ultima Venda --------------------------------------------------------------
//  MySql:='select m.codcliente, c.nomecliente,'+
//         ' m.datadocumento, p.quantatendida, p.PRECO, p.VALTOTAL'+
//
//         ' from mcli m, mclipro p,  cliente c, estoque e'+
//
//         ' where m.chavenf=p.chavenf'+
//         ' and m.codcliente=c.codCliente'+
//         ' and m.codfilial = e.codfilial'+
//         ' and p.codproduto = e.codproduto'+
//         ' and m.datadocumento = e.datavenda'+
//
//         ' and p.CHAVENFPRO>'''''+
//         ' and p.entradasaida=''S'''+
//         ' and p.somouestoque=''S'''+
//         ' and p.codproduto = '+
//         QuotedStr(IBQ_ConsultaFilial.FieldByName('Cod_Item').AsString)+
//         ' and m.codfilial = '+QuotedStr(sgCodEmp);
//  IBQ_ConsultaMatriz.Close;
//  IBQ_ConsultaMatriz.SQL.Clear;
//  IBQ_ConsultaMatriz.SQL.Add(MySql);
//  IBQ_ConsultaMatriz.Open;
//
//  If Trim(IBQ_ConsultaMatriz.FieldByName('codcliente').AsString)<>'' Then
//   Begin
//     ValuesCampos:=f_Troca(' DTA_ULT_VENDA ',' '+QuotedStr(
//                      IBQ_ConsultaMatriz.FieldByName('DataDocumento').AsString)+
//                                                              ' ',ValuesCampos);
//     ValuesCampos:=f_Troca(' COD_CLI_ULT_VENDA ',' '+QuotedStr(
//                         IBQ_ConsultaMatriz.FieldByName('CodCliente').AsString)+
//                                                              ' ',ValuesCampos);
//     ValuesCampos:=f_Troca(' DES_CLI_ULT_VENDA ',' '+QuotedStr(Trim(
//                       IBQ_ConsultaMatriz.FieldByName('NomeCliente').AsString))+
//                                                              ' ',ValuesCampos);
//     ValuesCampos:=f_Troca(' QTD_ULT_VENDA ',' '+QuotedStr(
//                      IBQ_ConsultaMatriz.FieldByName('QuantAtendida').AsString)+
//                                                              ' ',ValuesCampos);
//     ValuesCampos:=f_Troca(' VLR_UNI_ULT_VENDA ',' '+QuotedStr(
//                              IBQ_ConsultaMatriz.FieldByName('Preco').AsString)+
//                                                              ' ',ValuesCampos);
//     ValuesCampos:=f_Troca(' VLR_TOT_ULT_VENDA ',' '+QuotedStr(
//                           IBQ_ConsultaMatriz.FieldByName('ValTotal').AsString)+
//                                                              ' ',ValuesCampos);
//   End
//  Else // If Trim(IBQ_ConsultaMatriz.FieldByName('codcliente').AsString)<>'' Then
//   Begin
     ValuesCampos:=f_Troca(' DTA_ULT_VENDA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' COD_CLI_ULT_VENDA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' DES_CLI_ULT_VENDA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' QTD_ULT_VENDA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_UNI_ULT_VENDA ',' NULL ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_TOT_ULT_VENDA ',' NULL ',ValuesCampos);
//OPSS_Normal
//   End;
//  IBQ_ConsultaMatriz.Close;

  // Lista de Precos -----------------------------------------------------------
  ValuesCampos:=f_Troca(' COD_LISTA_VENDA ',' '+QuotedStr(sgCodListaPreco)+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DES_LISTA_VENDA ',' '+QuotedStr(Trim(sgDesListaPreco))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' COD_LISTA_COMPRA ',' '+QuotedStr(sgCodListaPreco)+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DES_LISTA_COMPRA ',' '+QuotedStr(Trim(sgDesListaPreco))+' ',ValuesCampos);

  // Preo de Venda e Compra ---------------------------------------------------
  MySql:='select lpi.codlista, lpi.codproduto, lpi.precocompra,'+
         ' lpi.precovenda, lpi.margem, lpi.desconto, lpi.descontomax,'+
         ' lpi.acrecimolista'+

         ' FROM lista lp, listapre lpi'+

         ' Where lpi.codlista=lp.codlista'+

         ' and lpi.desativado=0'+
         ' and lp.desativada=''N'''+

         ' and lpi.codlista = '+QuotedStr(sgCodListaPreco)+
         ' and lpi.codproduto = '+
         QuotedStr(IBQ_ConsultaFilial.FieldByName('Cod_Item').AsString);
  IBQ_ConsultaMatriz.Close;
  IBQ_ConsultaMatriz.SQL.Clear;
  IBQ_ConsultaMatriz.SQL.Add(MySql);
  IBQ_ConsultaMatriz.Open;

  If Trim(IBQ_ConsultaMatriz.FieldByName('CodLista').AsString)<>'' Then
   Begin
     ValuesCampos:=f_Troca(' VLR_UNI_VENDA ',' '+QuotedStr(
                         IBQ_ConsultaMatriz.FieldByName('PrecoVenda').AsString)+
                                                              ' ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_UNI_COMPRA ',' '+QuotedStr(
                        IBQ_ConsultaMatriz.FieldByName('PrecoCompra').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else // If Trim(IBQ_ConsultaMatriz.FieldByName('CodLista').AsString)<>'' Then
   Begin
     ValuesCampos:=f_Troca(' VLR_UNI_VENDA ',' NULL ',ValuesCampos);

     ValuesCampos:=f_Troca(' VLR_UNI_COMPRA ',' '+QuotedStr(
                              IBQ_ConsultaFilial.FieldByName('Preco').AsString)+
                                                              ' ',ValuesCampos);
   End; // If Trim(IBQ_ConsultaMatriz.FieldByName('CodLista').AsString)<>'' Then
  IBQ_ConsultaMatriz.Close;

  // Saldo e Disponivel --------------------------------------------------------
  ValuesCampos:=f_Troca(' QTD_SALDO ',' '+QuotedStr(
                IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsString)+' ',ValuesCampos);

  // Busca Transito e Acerta Saldo Disponvel ---------------------
  MySql:='select m.codproduto, sum(coalesce(m.quant_ref,0)) Qtd_Transito'+
         ' from movtos_empresas m'+
         ' where m.ind_tipo=''TR'''+
         ' and m.codfilial='+QuotedStr(sgCodEmp)+
         ' and m.codproduto='+QuotedStr(IBQ_ConsultaFilial.FieldByName('Cod_Item').AsString)+
         ' group by m.codproduto';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  If DMBelShop.CDS_BuscaRapida.FieldByName('QTD_TRANSITO').AsCurrency>0 Then
   Begin
     ValuesCampos:=f_Troca(' QTD_TRANSITO ',' '+QuotedStr(
              DMBelShop.CDS_BuscaRapida.FieldByName('QTD_TRANSITO').AsString)+
                                                            ' ',ValuesCampos);
     ValuesCampos:=f_Troca(' QTD_DISPONIVEL ',' '+QuotedStr(CurrToStr(
                               IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency+
           DMBelShop.CDS_BuscaRapida.FieldByName('QTD_TRANSITO').AsCurrency))+
                                                            ' ',ValuesCampos);
   End
  Else // If DMBelShop.CDS_BuscaRapida.FieldByName('QTD_TRANSITO').AsCurrency>0 Then
   Begin
     ValuesCampos:=f_Troca(' QTD_TRANSITO ',' 0 ',ValuesCampos);
     ValuesCampos:=f_Troca(' QTD_DISPONIVEL ',' '+QuotedStr(
                                IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsString)+
                                                            ' ',ValuesCampos);
   End; // If DMBelShop.CDS_BuscaRapida.FieldByName('QTD_TRANSITO').AsCurrency>0 Then
  DMBelShop.CDS_BuscaRapida.Close;

  // Inicializa Variaveis de Demanda -------------------------------------------
  igNrDias:=0;
  igNrMeses:=0;
  igTotMeses:=igTotMeses;
  cgOutras_Demandas:=0;
  cgTotal_Demandas:=0;

  BuscaDemanda(CB_Mes1, ME_Ano1, IBQ_ConsultaFilial.FieldByName('Cod_Item').AsString,
               IBQ_ConsultaFilial.FieldByName('Cod_Empresa').AsString, cDemanda, igNrDias, igNrMeses, True);

  // Numero de Meses Total =====================================================
  igTotMeses:=igTotMeses+1;

  If Trim(DMBelShop.CDS_Demandas.FieldByName('Dem1').AsString)<>'' Then
   Begin
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem1').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES1 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem1').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else // If Trim(DMBelShop.CDS_Demandas.FieldByName('Dem1').AsString)<>'' Then
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES1 ',' 0 ',ValuesCampos);
   End; // If Trim(DMBelShop.CDS_Demandas.FieldByName('Dem1').AsString)<>'' Then

  // Demanda Mes 2 -------------------------------------------------------
  If (StrToIntDef(sMes2,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem2').AsString)<>'') Then
   Begin
     cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES2 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem2').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES2 ',' 0 ',ValuesCampos);
   End; // If (StrToIntDef(sMes2,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem2').AsString)<>'') Then

  // Demanda Mes 3 -------------------------------------------------------
  If (StrToIntDef(sMes3,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem3').AsString)<>'') Then
   Begin
     cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES3 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem3').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES3 ',' 0 ',ValuesCampos);
   End; // If (StrToIntDef(sMes3,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem3').AsString)<>'') Then

  // Demanda Mes 4 -------------------------------------------------------
  If (StrToIntDef(sMes4,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem4').AsString)<>'') Then
   Begin
     cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES4 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem4').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES4 ',' 0 ',ValuesCampos);
   End; // If (StrToIntDef(sMes4,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem4').AsString)<>'') Then

  // Demanda Mes 5 -------------------------------------------------------
  If (StrToIntDef(sMes5,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem5').AsString)<>'') Then
   Begin
     cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES5 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem5').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES5 ',' 0 ',ValuesCampos);
   End; // If (StrToIntDef(sMes5,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem5').AsString)<>'') Then

  // Demanda Mes 6 -------------------------------------------------------
  If (StrToIntDef(sMes6,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem6').AsString)<>'') Then
   Begin
     cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES6 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem6').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else // If (StrToIntDef(sMes6,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem6').AsString)<>'') Then
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES6 ',' 0 ',ValuesCampos);
   End;

  // Demanda Mes 7 -------------------------------------------------------
  If (StrToIntDef(sMes7,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem7').AsString)<>'') Then
   Begin
     cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES7 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem7').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES7 ',' 0 ',ValuesCampos);
   End; // If (StrToIntDef(sMes7,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem7').AsString)<>'') Then

  // Demanda Mes 8 -------------------------------------------------------
  If (StrToIntDef(sMes8,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem8').AsString)<>'') Then
   Begin
     cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
     cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
     ValuesCampos:=f_Troca(' QTD_DEM_MES8 ',' '+QuotedStr(
                           DMBelShop.CDS_Demandas.FieldByName('Dem8').AsString)+
                                                              ' ',ValuesCampos);
   End
  Else
   Begin
     ValuesCampos:=f_Troca(' QTD_DEM_MES8 ',' 0 ',ValuesCampos);
   End; // If (StrToIntDef(sMes8,0)<>0) and (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem7').AsString)<>'') Then

  DMBelShop.CDS_Demandas.Close;

  // Totais Dias para Mes 2 ----------------------------------------------------
  If CB_Mes2.Text<>'NAO USAR' Then
  Begin
    // Numero de Meses Total =====================================================
     igTotMeses:=igTotMeses+1;
  End; // If CB_Mes2.Text<>'NAO USAR' Then

  // Totais Dias para Mes 3 ----------------------------------------------------
  If CB_Mes3.Text<>'NAO USAR' Then
  Begin
    // Numero de Meses Total =====================================================
     igTotMeses:=igTotMeses+1;
  End; // If CB_Mes3.Text<>'NAO USAR' Then

  // Totais Dias para Mes 4 ----------------------------------------------------
  If CB_Mes4.Text<>'NAO USAR' Then
  Begin
    // Numero de Meses Total =====================================================
     igTotMeses:=igTotMeses+1;
  End; // If CB_Mes4.Text<>'NAO USAR' Then

  // Totais Dias para Mes 5 ----------------------------------------------------
  If CB_Mes5.Text<>'NAO USAR' Then
  Begin
    // Numero de Meses Total =====================================================
     igTotMeses:=igTotMeses+1;
  End; // If CB_Mes5.Text<>'NAO USAR' Then

  // Totais Dias para Mes 6 ----------------------------------------------------
  If CB_Mes6.Text<>'NAO USAR' Then
  Begin
    // Numero de Meses Total =====================================================
     igTotMeses:=igTotMeses+1;
  End; // If CB_Mes6.Text<>'NAO USAR' Then

  // Totais Dias para Mes 7 ----------------------------------------------------
  If CB_Mes7.Text<>'NAO USAR' Then
  Begin
    // Numero de Meses Total =====================================================
     igTotMeses:=igTotMeses+1;
  End; // If CB_Mes7.Text<>'NAO USAR' Then

  // Totais Dias para Mes 8 ----------------------------------------------------
  If CB_Mes8.Text<>'NAO USAR' Then
  Begin
    // Numero de Meses Total =====================================================
     igTotMeses:=igTotMeses+1;
  End; // If CB_Mes8.Text<>'NAO USAR' Then

  ValuesCampos:=f_Troca(' QTD_NR_DIAS ',' '+QuotedStr(IntToStr(igNrDias))+
                                                              ' ',ValuesCampos);
  ValuesCampos:=f_Troca(' QTD_NR_MESES ',' '+QuotedStr(IntToStr(igNrMeses))+
                                                              ' ',ValuesCampos);
  ValuesCampos:=f_Troca(' QTD_TOT_MESES ',' '+QuotedStr(IntToStr(igTotMeses))+
                                                              ' ',ValuesCampos);
  // Calulo das Medias ---------------------------------------------------------
  If igNrMeses<igTotMeses Then
   Begin
     If igNrMeses<>0 Then
      cMediaMes:=RoundTo((cgOutras_Demandas/igNrMeses),-4)
     Else    
      cMediaMes:=0;
   End
  Else
   Begin
     cMediaMes:=RoundTo((cgTotal_Demandas/igTotMeses),-4);
   End; // If igNrMeses<igTotMeses Then
  ValuesCampos:=f_Troca(' QTD_MEDIA_MES ',' '+QuotedStr(CurrToStr(cMediaMes))+' ',ValuesCampos);

  If igNrDias<>0 Then      
   ValuesCampos:=f_Troca(' QTD_MEDIA_DIA ',' '+QuotedStr(
           CurrToStr(RoundTo((cgTotal_Demandas/igNrDias),-4)))+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' QTD_MEDIA_DIA ',' '+QuotedStr('0')+' ',ValuesCampos);

  // Informa Quantidade a Transferir -------------------------------------
  If Not bUsarCurva Then
   Begin
     If IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency>cMediaMes Then 
      cMediaMes:=RoundTo((IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency-cMediaMes),0)
     Else
      cMediaMes:=0;
   End
  Else
   Begin
     cMediaMes:=0;
   End;
  ValuesCampos:=f_Troca(' QTD_TRANSF ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' IND_QTD_ACIMA ',' '+QuotedStr('0')+' ',ValuesCampos);

  // Quandidades Sugerida para Compra ------------------------------------------
  ValuesCampos:=f_Troca(' QTD_ACOMPRAR ',' '+QuotedStr(Trim(
      IBQ_ConsultaFilial.FieldByName('QUANTIDADE').AsString))+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' QTD_SUGERIDA ',' 0 ',ValuesCampos);
  ValuesCampos:=f_Troca(' PER_DESCONTO ',' 0 ',ValuesCampos);

  // Valores de Compra ---------------------------------------------------------
  ValuesCampos:=f_Troca(' VLR_BRUTO ',' 0 ',ValuesCampos);
  ValuesCampos:=f_Troca(' VLR_DESCONTOS ',' 0 ',ValuesCampos);

  ValuesCampos:=f_Troca(' VLR_DESPESAS ',' 0 ',ValuesCampos);
  ValuesCampos:=f_Troca(' VLR_FRETE ',' 0 ',ValuesCampos);
  ValuesCampos:=f_Troca(' VLR_TOT_VENDA ',' 0 ',ValuesCampos);
  ValuesCampos:=f_Troca(' VLR_TOT_COMPRA ',' 0 ',ValuesCampos);

  // Impostos (ICMS) -----------------------------------------------------------
  ValuesCampos:=f_Troca(' COD_ICMS ',' '+QuotedStr(
             IBQ_ConsultaFilial.FieldByName('CODICMCOMPRA').AsString)+' ',ValuesCampos);

  MySql:='select CODICM, SITTRIBUTARIA, ALIQUOTA, REDUCAO, SOMAIPIBASE,'+
         ' SOMAFRETEBASE, SOMADESPESABASE, SUBSTITUICAO, SUBSTVALPER,'+
         ' SUBSTMARGEM, SUBSTALIQUOTA, SOMAIPIBASESUBST, ALIQREPASSE,'+
         ' SOMAFRETEBASEST, SOMADESPESABASEST'+

         ' from tabelaicms'+

         ' Where CODCOMPROVANTE=''012'''+  // Sempre 012 = Ordem de Compra
         ' and CLIOUFOR=''F'''+
         ' and CODICM='+QuotedStr(IBQ_ConsultaFilial.FieldByName('CodIcmCompra').AsString)+
         ' and CODESTADO='+QuotedStr(IBQ_ConsultaFilial.FieldByName('Estado').AsString)+
         ' and REVENDACONSUMOFJ='+QuotedStr(IBQ_ConsultaFilial.FieldByName('Pessoa').AsString);
  IBQ_ConsultaMatriz.Close;
  IBQ_ConsultaMatriz.SQL.Clear;
  IBQ_ConsultaMatriz.SQL.Add(MySql);
  IBQ_ConsultaMatriz.Open;
                              
  ValuesCampos:=f_Troca(' COD_SIT_TRIBUTARIA ',' '+QuotedStr(
                IBQ_ConsultaMatriz.FieldByName('SITTRIBUTARIA').AsString)+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SOMAIPIBASE').AsString)<>'' Then
   ValuesCampos:=f_Troca(' IND_SOMA_IPI_BASE_ICMS ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SOMAIPIBASE').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_SOMA_IPI_BASE_ICMS ',' '+QuotedStr('N')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SOMAFRETEBASE').AsString)<>'' Then
   ValuesCampos:=f_Troca(' IND_SOMA_FRETE_BASE_ICMS ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SOMAFRETEBASE').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_SOMA_FRETE_BASE_ICMS ',' '+QuotedStr('N')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SOMADESPESABASE').AsString)<>'' Then
   ValuesCampos:=f_Troca(' IND_SOMA_DESPESA_BASE_ICMS ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SOMADESPESABASE').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_SOMA_DESPESA_BASE_ICMS ',' '+QuotedStr('N')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SOMAIPIBASESUBST').AsString)<>'' Then
   ValuesCampos:=f_Troca(' IND_SOMA_IPI_BASE_ST ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SOMAIPIBASESUBST').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_SOMA_IPI_BASE_ST ',' '+QuotedStr('N')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SOMAFRETEBASEST').AsString)<>'' Then
   ValuesCampos:=f_Troca(' IND_SOMA_FRETE_BASE_ST ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SOMAFRETEBASEST').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_SOMA_FRETE_BASE_ST ',' '+QuotedStr('N')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SOMADESPESABASEST').AsString)<>'' Then
   ValuesCampos:=f_Troca(' IND_SOMA_DESPESA_BASE_ST ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SOMADESPESABASEST').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_SOMA_DESPESA_BASE_ST ',' '+QuotedStr('N')+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' VLR_BASE_ICMS ',' '+QuotedStr('0')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('REDUCAO').AsString)<>'' Then
   ValuesCampos:=f_Troca(' PER_REDUCAO_ICMS ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('REDUCAO').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' PER_REDUCAO_ICMS ',' '+QuotedStr('0')+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' VLR_REDUCAO_ICMS ',' '+QuotedStr('0')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('ALIQUOTA').AsString)<>'' Then
   ValuesCampos:=f_Troca(' PER_ICMS ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('ALIQUOTA').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' PER_ICMS ',' '+QuotedStr('0')+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' VLR_ICMS ',' '+QuotedStr('0')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SUBSTMARGEM').AsString)<>'' Then
   ValuesCampos:=f_Troca(' PER_MARGEM_ST ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SUBSTMARGEM').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' PER_MARGEM_ST ',' '+QuotedStr('0')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SUBSTVALPER').AsString)<>'' Then
   ValuesCampos:=f_Troca(' IND_ST ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SUBSTVALPER').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_ST ',' '+QuotedStr('P')+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' VLR_BASE_ST ',' '+QuotedStr('0')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('SUBSTALIQUOTA').AsString)<>'' Then
   ValuesCampos:=f_Troca(' PER_ST ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('SUBSTALIQUOTA').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' PER_ST ',' '+QuotedStr('0')+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' VLR_ST ',' '+QuotedStr('0')+' ',ValuesCampos);

  If Trim(IBQ_ConsultaMatriz.FieldByName('ALIQREPASSE').AsString)<>'' Then
   ValuesCampos:=f_Troca(' PER_REPASSE ',' '+QuotedStr(
                 IBQ_ConsultaMatriz.FieldByName('ALIQREPASSE').AsString)+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' PER_REPASSE ',' '+QuotedStr('0')+' ',ValuesCampos);

  IBQ_ConsultaMatriz.Close;
   
  ValuesCampos:=f_Troca(' VLR_REPASSE ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' COD_COMPROVANTE_ICMS ',' '+QuotedStr('012')+' ',ValuesCampos);

  // Impostos (IPI) ------------------------------------------------------------
  ValuesCampos:=f_Troca(' COD_IPI ',' '+QuotedStr(
             IBQ_ConsultaFilial.FieldByName('CODIPICOMPRA').AsString)+' ',ValuesCampos);

  If Trim(IBQ_ConsultaFilial.FieldByName('CODIPICOMPRA').AsString)<>'' Then
   Begin
     MySql:='select CODIPI, ALIQUOTA, IPIPERCOUVALOR'+
            ' from ipis'+
            ' where codipi='+
            QuotedStr(IBQ_ConsultaFilial.FieldByName('CODIPICOMPRA').AsString);
     IBQ_ConsultaMatriz.Close;
     IBQ_ConsultaMatriz.SQL.Clear;
     IBQ_ConsultaMatriz.SQL.Add(MySql);
     IBQ_ConsultaMatriz.Open;

     If Trim(IBQ_ConsultaMatriz.FieldByName('IPIPERCOUVALOR').AsString)<>'' Then
      ValuesCampos:=f_Troca(' IND_IPI ',' '+QuotedStr(
                    IBQ_ConsultaMatriz.FieldByName('IPIPERCOUVALOR').AsString)+' ',ValuesCampos)
     Else
      ValuesCampos:=f_Troca(' IND_IPI ',' '+QuotedStr('P')+' ',ValuesCampos);

     If Trim(IBQ_ConsultaMatriz.FieldByName('ALIQUOTA').AsString)<>'' Then
      ValuesCampos:=f_Troca(' PER_IPI ',' '+QuotedStr(
                    IBQ_ConsultaMatriz.FieldByName('ALIQUOTA').AsString)+' ',ValuesCampos)
     Else
      ValuesCampos:=f_Troca(' PER_IPI ',' '+QuotedStr('0')+' ',ValuesCampos);

     IBQ_ConsultaMatriz.Close;

     ValuesCampos:=f_Troca(' VLR_IPI ',' '+QuotedStr('0')+' ',ValuesCampos);
   End
  Else
   Begin
     ValuesCampos:=f_Troca(' IND_IPI ',' '+QuotedStr('P')+' ',ValuesCampos);
     ValuesCampos:=f_Troca(' PER_IPI ',' '+QuotedStr('0')+' ',ValuesCampos);
     ValuesCampos:=f_Troca(' VLR_IPI ',' '+QuotedStr('0')+' ',ValuesCampos);
   End;

  ValuesCampos:=f_Troca(' COD_COMPRADOR ',' '+Cod_Usuario+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' BLOB_TEXTO ',' '+QuotedStr(
       'Aberturta do Aplicativo: '+sgDataHoraAplicativo)+'|| ascii_char(13) ||'+
       QuotedStr('Calculado em: '+DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+
                                         ' por '+Des_Usuario)+' ',ValuesCampos);

  // Analise Possibilidade de Transferencia ------------------------------------
  If IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency>0 Then
   Begin
     If sgDtaLimTransf<>'' Then
      Begin
        ValuesCampos:=f_Troca(' DTA_LIM_TRANSF ',' '+QuotedStr(sgDtaLimTransf)+' ',ValuesCampos);

        MySql:=' Select first 1 m.codfilial'+
               ' From movtos_empresas m'+
               ' Where m.ind_tipo=''DM'''+
               ' And m.CodFilial='+QuotedStr(sgCodEmp)+
               ' And m.codproduto='+QuotedStr(IBQ_ConsultaFilial.FieldByName('COD_ITEM').AsString)+
               ' and m.DTA_REF>'+QuotedStr(sgDtaLimTransf);
        DMBelShop.SDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.SDS_BuscaRapida.Open;

        If Trim(DMBelShop.SDS_BuscaRapida.FieldByName('CodFilial').AsString)='' Then
         ValuesCampos:=f_Troca(' IND_TRANSF ',' '+QuotedStr('S')+' ',ValuesCampos)
        Else
         ValuesCampos:=f_Troca(' IND_TRANSF ',' '+QuotedStr('N')+' ',ValuesCampos);

        DMBelShop.SDS_BuscaRapida.Close;
      End
     Else // If sgDtaLimTransf<>'' Then
      Begin
        ValuesCampos:=f_Troca(' DTA_LIM_TRANSF ',' NULL ',ValuesCampos);
        ValuesCampos:=f_Troca(' IND_TRANSF ',' '+QuotedStr('N')+' ',ValuesCampos);
      End; // If sgDtaLimTransf<>'' Then
   End
  Else // If IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency>0 Then
   Begin
     If sgDtaLimTransf<>'' Then
      ValuesCampos:=f_Troca(' DTA_LIM_TRANSF ',' '+QuotedStr(sgDtaLimTransf)+' ',ValuesCampos)
     Else
      ValuesCampos:=f_Troca(' DTA_LIM_TRANSF ',' NULL ',ValuesCampos);

     ValuesCampos:=f_Troca(' IND_TRANSF ',' '+QuotedStr('N')+' ',ValuesCampos);
   End; // If IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency>0 Then

  If bUsarCurva Then
   ValuesCampos:=f_Troca(' IND_USAR ',' '+QuotedStr('SIM')+' ',ValuesCampos)
  Else
   ValuesCampos:=f_Troca(' IND_USAR ',' '+QuotedStr('NAO')+' ',ValuesCampos);

  ValuesCampos:=f_Troca(' IND_QTD_ACIMA ',' '+QuotedStr('0')+' ',ValuesCampos);

  // Campos do Novo Calculo Por Demanda 1 Ano ==================================
  ValuesCampos:=f_Troca(' QTD_SUGERIDA_ANO ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' QTD_TRANSF_PERIODO ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' QTD_TRANSF_ANO ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' EST_MINIMO ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DIAS_ESTOCAGEM ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' QTD_DEMANDA_DIA ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' QTD_DEMANDA_ANO ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' QTD_DIAS_ANO ',' '+QuotedStr('0')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DATAINCLUSAO ',' NULL ',ValuesCampos);
  ValuesCampos:=f_Troca(' ESTADO ',' NULL ',ValuesCampos);
  ValuesCampos:=f_Troca(' DATAALTERACAO ',' NULL ',ValuesCampos);
  ValuesCampos:=f_Troca(' IND_TRANSF_CD ',' '+QuotedStr('N')+' ',ValuesCampos);
  ValuesCampos:=f_Troca(' DOC_TRANSF_CD ',' NULL ',ValuesCampos);
End; // Ordens de Compra das Lojas - Calcula OCs Importadas ////////////////////
          
// Ordens de Compra das Lojas - Busca OCs nas Loajs ////////////////////////////
Procedure TFrmBelShop.BuscaOCLojas;
Var
  MySql, MySqlBusca: String;
  bProcOK, bProcessa, bSiga: Boolean;
  i: Integer;
begin
  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Grupos e SubGrupos Selecionados ===========================================
  sgGrupos:='';
  sgSubGrupos:='';
  If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GruposProdutos.First;
    While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    Begin
      Refresh;

      If sgGrupos='' Then
       sgGrupos:='(gr.codgrupo='+
                     QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString)
      Else
       sgGrupos:=sgGrupos+' Or gr.codgrupo='+
                    QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString);

      If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
      Begin
        While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        Begin
          Refresh;

          If sgSubGrupos='' Then
           sgSubGrupos:=QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString)
          Else
           sgSubGrupos:=sgSubGrupos+', '+
              QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString);

          DMVirtual.CDS_V_SubGruposProdutos.Next;
        End; // While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        DMVirtual.CDS_V_SubGruposProdutos.First;

      End; // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then

      If sgSubGrupos<>'' Then
       sgGrupos:=sgGrupos+' and pr.codgruposub in ('+sgSubGrupos+')';

      sgSubGrupos:='';

      DMVirtual.CDS_V_GruposProdutos.Next;
    End; // While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    DMVirtual.CDS_V_GruposProdutos.First;

    If sgGrupos<>'' Then
     sgGrupos:=sgGrupos+')';

  End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then

  // Aplicacoes Selecionadas ===================================================
  sgAplicacoes:='';
  If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then
  Begin

    DMVirtual.CDS_V_Aplicacao.First;
    While Not DMVirtual.CDS_V_Aplicacao.Eof do
    Begin
      Refresh;

      If sgAplicacoes='' Then
       sgAplicacoes:=QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString)
      Else
       sgAplicacoes:=sgAplicacoes+', '+
                     QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString);

      DMVirtual.CDS_V_Aplicacao.Next;
    End; // While Not DMVirtual.CDS_V_Aplicacao.Eof do
    DMVirtual.CDS_V_Aplicacao.First;

  End; // If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then

  // Familias Preos Selecionadas ==============================================
  sgFamiliaPrecos:='';
  If Not DMVirtual.CDS_V_FamiliaPrecos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_FamiliaPrecos.First;
    While Not DMVirtual.CDS_V_FamiliaPrecos.Eof do
    Begin
      Refresh;

      If sgFamiliaPrecos='' Then
       sgFamiliaPrecos:=
               QuotedStr(DMVirtual.CDS_V_FamiliaPrecosCod_FamiliaPreco.AsString)
      Else
       sgFamiliaPrecos:=sgFamiliaPrecos+', '+
              QuotedStr(DMVirtual.CDS_V_FamiliaPrecosCod_FamiliaPreco.AsString);

      DMVirtual.CDS_V_FamiliaPrecos.Next;
    End; // While Not DMVirtual.CDS_V_FamiliaPrecos.Eof do
    DMVirtual.CDS_V_FamiliaPrecos.First;

  End; // If Not DMVirtual.CDS_V_FamiliaPrecos.IsEmpty Then

  // Grupos ST =================================================================
  sgGruposST:='';
  If Not DMVirtual.CDS_V_GrupoST.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GrupoST.First;
    While Not DMVirtual.CDS_V_GrupoST.Eof do
    Begin
      Refresh;

      If sgGruposST='' Then
       sgGruposST:=QuotedStr(DMVirtual.CDS_V_GrupoSTCod_GrupoST.AsString)
      Else
       sgGruposST:=sgGruposST+', '+
                         QuotedStr(DMVirtual.CDS_V_GrupoSTCod_GrupoST.AsString);

      DMVirtual.CDS_V_GrupoST.Next;
    End; // While Not DMVirtual.CDS_V_GrupoST.Eof do
    DMVirtual.CDS_V_GrupoST.First;

  End; // If Not DMVirtual.CDS_V_GrupoST.IsEmpty Then

  // Monta Sql =================================================================
  MySqlBusca:=' SELECT oc.codoc, fi.codfilial COD_EMPRESA, cl.nomecliente Des_Empresa,'+
              ' pr.codproduto COD_ITEM, pr.apresentacao des_item, pr.referencia,'+
              ' pr.datainclusao, pr.codicmcompra, pr.codipicompra, pf.codauxiliar, it.preco,'+
              ' COALESCE(it.quantidade,0) quantidade,'+
              ' COALESCE(es.customedio,0) customedio,'+
              ' COALESCE(es.saldoatual,0) Qtd_Saldo,'+
              ' COALESCE(pf.unidadecaixa,1) uni_compra,'+
              ' COALESCE(pr.unidadeestoque,1) uni_venda,'+
              ' pr.codbarra, pr.codgruposub, gr.codgrupo, gr.nomegrupo, gs.codsubgrupo, gs.nomesubgrupo,'+
              ' pr.classeabc, pr.codfamiliapreco, fp.nomefamiliapreco, pr.nomegenerico, pr.codaplicacao,'+
              ' ap.nomeaplicacao, fo.codfornecedor, fo.nomefornecedor, fo.pessoa, fo.email,'+
              ' fo.estado, pr.grupostmva Grupo_ST, oc.observacao,'+
              ' CASE pr.grupostmva'+
              '   WHEN  0 THEN ''No usa'''+
              '   WHEN  1 THEN ''Autopeas'''+
              '   WHEN  2 THEN ''Rao'''+
              '   WHEN  3 THEN ''Colches'''+
              '   WHEN  4 THEN ''Cosmticos'''+
              '   WHEN  5 THEN ''Arroz beneficiado'''+
              '   WHEN  6 THEN ''Correias de Transmisso e Rolamentos'''+
              '   WHEN  7 THEN ''Tintas e Vernizes'''+
              '   WHEN  8 THEN ''Sucos de Frutas e Bebidas no Alcolicas'''+
              '   WHEN  9 THEN ''Ferramentas'''+
              '   WHEN 10 THEN ''Materiais Eltricos'''+
              '   WHEN 11 THEN ''Mat. Construo, Acabamento, Bricolagem ou Adorno'''+
              '   WHEN 12 THEN ''Bicicletas'''+
              '   WHEN 13 THEN ''Brinquedos'''+
              '   WHEN 14 THEN ''Material de Limpeza'''+
              '   WHEN 15 THEN ''Produtos Alimentcios'''+
              '   WHEN 16 THEN ''Artefatos de Uso Domstico'''+
              '   WHEN 17 THEN ''Bebidas Quentes'''+
              '   WHEN 18 THEN ''Artigos de Papelaria'''+
              '   WHEN 19 THEN ''Instrumentos Musicais'''+
              '   WHEN 20 THEN ''Prod. Eletronicos, Eletroeletronicos, Eletrodomsticos'''+
              ' END Des_Grupo_ST'+

              ' FROM ordem oc'+
              '      LEFT JOIN ordemite it  ON oc.codoc=it.codoc'+
              '      LEFT JOIN produto  pr  ON it.codproduto=pr.codproduto'+
              '      LEFT JOIN estoque  es  ON pr.codproduto=es.codproduto'+
              '                            AND es.codfilial = :CodLoja'+
              '      LEFT JOIN filial fi    ON fi.codfilial=oc.codfilial'+
              '      LEFT JOIN cliente cl   ON fi.codnocliente=cl.codcliente'+
              '      LEFT JOIN gruposub gs  ON pr.codgruposub=gs.codgruposub'+
              '      LEFT JOIN grupo gr     ON gr.codgrupo=gs.codgrupo'+
              '      LEFT JOIN aplica ap    ON pr.codaplicacao=ap.codaplicacao'+
              '      LEFT JOIN forneced fo  ON pr.principalfor=fo.codfornecedor'+
              '      LEFT JOIN familiap fp  ON pr.codfamiliapreco=fp.codfamiliapreco'+
              '      LEFT JOIN produfor pf  ON pf.CHAVEFORPRO=pr.principalfor||pr.codproduto'+

              ' WHERE oc.situacao < 2'+
              ' AND oc.datapedido BETWEEN '+QuotedStr(sgDtaInicio)+' AND '+QuotedStr(sgDtaFim)+
              ' AND oc.codfilial=:CodLoja';

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               MySqlBusca:=
                MySqlBusca+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               MySqlBusca:=
                MySqlBusca+' and pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               MySqlBusca:=
                MySqlBusca+' AND '+sgLikeProdutos;

              If Trim(sgFornecedores)<>'' Then
               MySqlBusca:=MySqlBusca+' AND oc.codfornecedor in ('+sgFornecedores+')';

              // Grupos e SubGrupos --------------------------------------
              If Trim(sgGrupos)<>'' Then
               MySqlBusca:=MySqlBusca+' and '+sgGrupos;

              // Aplicacoes ----------------------------------------------
              If Trim(sgAplicacoes)<>'' Then
               MySqlBusca:=MySqlBusca+' and pr.CodAplicacao in ('+sgAplicacoes+')';

              // Familias Preos -----------------------------------------
              If Trim(sgFamiliaPrecos)<>'' Then
               MySqlBusca:=MySqlBusca+' and pr.CodFamiliaPreco in ('+sgFamiliaPrecos+')';

              // Grupos ST -----------------------------------------------
              If Trim(sgGruposST)<>'' Then
               MySqlBusca:=MySqlBusca+' and pr.grupostmva in ('+sgGruposST+')';

              MySqlBusca:=MySqlBusca+' AND pr.codproduto is not null'+
                                     ' AND ((oc.codcomprador IS NULL) OR (oc.codcomprador=''''))'+
                                     ' ORDER BY 1, 4';

  // Busca de Estrutura de Tabela ==============================================
  CamposTableInterFire(DMBelShop.SQLQuery1,'OC_COMPRAR',Campos);

  // Inicializa Variaveis ======================================================
  sNumDoc:='';
  iNumSeqDoc:=0;

  // Inicia Processamento ======================================================
  sgLojasNConectadas:='';
  bProcOK:=False;

  Screen.Cursor:=crAppStart;
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      sgCodEmp     :=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      igCodLojaLinx:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsInteger;
      sgDesLoja    :=DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;

      // Lista de Preco da Loja ------------------------------------------------
      sgCodListaPreco:=FormatFloat('0000',EdtOCCodListaPreco.AsInteger);
      sgDesListaPreco:=EdtOCListaPreco.Text;
      If (Trim(DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsString)<>'') and
         (FormatFloat('0000',DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsInteger)<>FormatFloat('0000',EdtOCCodListaPreco.AsInteger)) Then
      Begin
        sgCodListaPreco:=FormatFloat('0000',DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsInteger);

        sgDesListaPreco:='';

        // Busca Lista de Precos ===============================================
        MySql:=' Select lp.nomelista'+
               ' from lista lp'+
               ' where lp.codlista='+QuotedStr(sgCodListaPreco);
        IBQ_MPMS.Close;
        IBQ_MPMS.SQL.Clear;
        IBQ_MPMS.SQL.Add(MySql);
        IBQ_MPMS.Open;

        If Trim(IBQ_MPMS.FieldByName('nomelista').AsString)<>'' Then
         sgDesListaPreco:=IBQ_MPMS.FieldByName('nomelista').AsString;

        IBQ_MPMS.Close;
      End; // If (Trim(DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsString)<>'') and

      Lb_EmpAprocessar.Caption:='0';
      Lb_EmpProcessadas.Caption:='0';

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: '+sgCodEmp+' - '+sgDesLoja;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Conecta Empresa =======================================================
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else
       Begin
         Refresh;
         bSiga:=False;

         If sgLojasNConectadas='' Then
          sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
         Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
          sgLojasNConectadas:=
           sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then

      // Inicia Processamento ==================================================
      If bSiga Then // Empresa Conectada
      Begin
        // Cria Query da Empresa ------------------------------------
        CriaQueryIB('IBDB_'+sgCodEmp,'IBT_'+sgCodEmp,IBQ_ConsultaFilial, True, True);

        // Busca Comprovantes ---------------------------------------
        IBQ_ConsultaFilial.SQL.Clear;
        IBQ_ConsultaFilial.SQL.Add(MySqlBusca);
        IBQ_ConsultaFilial.ParamByName('CodLoja').AsString:=sgCodEmp;

        // Abre Query -----------------------------------------------
        i:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            IBQ_ConsultaFilial.Open;
            bSiga:=True;
          Except
            Inc(i);
          End; // Try

          If i>10 Then
          Begin
            If sgLojasNConectadas='' Then
             sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
            Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
             sgLojasNConectadas:=
              sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

            Break;
          End; // If i>10 Then
        End; // While Not bSiga do

        // Processamento =======================================================
        If bSiga Then // Query Executada
        Begin
          IBQ_ConsultaFilial.Last;
          iNrRegistros:=IBQ_ConsultaFilial.RecordCount;
          IBQ_ConsultaFilial.First;

          MontaProgressBar(True, FrmBelShop);

          pgProgBar.Properties.Max:=iNrRegistros;
          pgProgBar.Position:=0;

          Edt_OCTotProdutos.Value:=iNrRegistros;

          // Monta Transacao ===================================================
          TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
          TD.IsolationLevel:=xilREADCOMMITTED;
          DMBelShop.SQLC.StartTransaction(TD);
          Try
            Screen.Cursor:=crAppStart;
            DateSeparator:='.';
            DecimalSeparator:='.';

            While Not IBQ_ConsultaFilial.Eof do
            Begin
              Application.ProcessMessages;

              pgProgBar.Position:=IBQ_ConsultaFilial.RecNo;
              Refresh;

              // Verifica se OC e Item Ja Foram Importada -----------
              bProcessa:=True;
              MySql:=' SELECT first 1 i.num_oc_importada'+
                     ' FROM oc_importadas i'+
                     ' WHERE i.cod_loja='+QuotedStr(sgCodEmp)+
                     ' AND i.num_oc_importada='+IBQ_ConsultaFilial.FieldByName('codoc').AsString+
                     ' And i.Cod_Item='+QuotedStr(IBQ_ConsultaFilial.FieldByName('COD_ITEM').AsString);
              DMBelShop.CDS_BuscaRapida.Close;
              DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
              DMBelShop.CDS_BuscaRapida.Open;

              bProcessa:=False;
              If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('num_oc_importada').AsString)='' Then
               bProcessa:=True;

              DMBelShop.CDS_BuscaRapida.Close;

              If bProcessa Then
              Begin
                If sNumDoc='' Then
                Begin
                  // Busca Numero de Documento =================================
                  MySql:=' SELECT GEN_ID(GEN_NUM_DOC_CALCULO,1) Codigo'+
                         ' FROM RDB$DATABASE';
                  DMBelShop.CDS_Busca.Close;
                  DMBelShop.SDS_Busca.CommandText:=MySql;
                  DMBelShop.CDS_Busca.Open;
                  sNumDoc:=DMBelShop.CDS_Busca.FieldByName('Codigo').AsString;
                  DMBelShop.CDS_Busca.Close;

                  // Atualiza Numero dos Meses =================================
                  AtualizaNumeroDosMeses;
                End; // If sNumDoc<>'' Then

                Inc(iNumSeqDoc);

                // Atualiza Variavel de Valores de Campos -----------
                ValuesCampos:=Campos;

                // Calcula OCs Importadas ---------------------------
                CalculoOCsImportadas;

                // Grava Produto ------------------------------------
                MySql:='Insert into OC_COMPRAR ('+Campos+')'+
                       ' Values ('+ValuesCampos+')';
                DMBelShop.SQLC.Execute(MySql,nil,nil);
                bProcOK:=True;

                // Atualiza Totais ----------------------------------
                MySql:=' UPDATE OC_COMPRAR'+
                       ' Set VLR_DESCONTOS=((QTD_ACOMPRAR*VLR_UNI_COMPRA)*(PER_DESCONTO/100))'+
                       ', VLR_BRUTO=(QTD_ACOMPRAR*VLR_UNI_COMPRA)-VLR_DESCONTOS'+
                       ', VLR_BASE_ICMS=VLR_BRUTO'+
                       ', VLR_ICMS=Cast(((VLR_BASE_ICMS*PER_ICMS)/100) as Numeric(12,2))'+
                       ', VLR_IPI=Cast(((VLR_BRUTO*PER_IPI)/100) as Numeric(12,2))'+
                       ', VLR_BASE_ST=VLR_BRUTO+(Cast(((VLR_BRUTO*PER_MARGEM_ST)/100) as Numeric(12,2)))'+
                       ', VLR_ST=(Cast(((VLR_BASE_ST*PER_ST)/100) as Numeric(12,2))-VLR_ICMS)'+
                       ', VLR_TOT_COMPRA=VLR_BRUTO+VLR_ST+VLR_IPI'+

                       ' Where Num_Documento='+sNumDoc+
                       ' And   Cast(dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)))+
                       ' And   Cod_Item='+QuotedStr(IBQ_ConsultaFilial.FieldByName('COD_ITEM').AsString);
                DMBelShop.SQLC.Execute(MySql,nil,nil);

                // Guarda OC Importada ------------------------------
                MySql:='Insert into OC_IMPORTADAS (COD_LOJA, NUM_DOCUMENTO, NUM_OC_IMPORTADA, COD_ITEM)'+
                       ' Values ('+
                       QuotedStr(sgCodEmp)+', '+
                       QuotedStr(sNumDoc)+', '+
                       IBQ_ConsultaFilial.FieldByName('codoc').AsString+', '+
                       QuotedStr(IBQ_ConsultaFilial.FieldByName('Cod_Item').AsString)+')';
                DMBelShop.SQLC.Execute(MySql,nil,nil);
              End; // If bProcessa Then

              IBQ_ConsultaFilial.Next;
            End; // While Not IBQ_ConsultaFilial.Eof do
            IBQ_ConsultaFilial.Close;

            // Atualiza OC_COMPRAR_DOCS ========================================
            If bProcOK Then
            Begin
             OC_COMPRAR_DOCS('I', sNumDoc, 'OC(s) Importada(s):');
            End;

            MontaProgressBar(False, FrmBelShop);

            // Fecha Transacao =================================================
            DMBelShop.SQLC.Commit(TD);

            DateSeparator:='/';
            DecimalSeparator:=',';
            Screen.Cursor:=crDefault;

          Except
            on e : Exception do
            Begin
              MontaProgressBar(False, FrmBelShop);
              bProcOK:=False;

              DMBelShop.SQLC.Rollback(TD);

              DateSeparator:='/';
              DecimalSeparator:=',';
              Screen.Cursor:=crDefault;

              MessageBox(Handle, pChar(sgCodEmp+#13+e.message), 'Erro', MB_ICONERROR);
            End; // on e : Exception do
          End; // Try

        End; // If bSiga Then // Query Executada
      End; // If bSiga Then // Empresa Conectada

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');

      Lb_EmpProcessadas.Caption:=IntToStr(StrToInt(Lb_EmpProcessadas.Caption)+1);

    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  Screen.Cursor:=crDefault;

  OdirPanApres.Visible:=False;
  Edt_OCTotProdutos.Value:=0;

  Lb_EmpAprocessar.Caption:='0';
  Lb_EmpProcessadas.Caption:='0';
  Refresh;

  If bProcOK Then
   Begin
     msg('Busca de Ordem de Compra'+cr+'Efetuada com SUCESSO !!','A');

     // Busca Totais das OCs ======================================================
     TotaisOC(sNumDoc);

     bSiga:=False;
     DMBelShop.IBDB_BelShop.Connected:=False;
     While Not bSiga do
     Begin
       Try
         DMBelShop.IBDB_BelShop.Connected:=True;
         bSiga:=True;
       Except
       End;
     End; // While Not b do

     PC_OrdemCompra.TabIndex:=1;
     PC_OrdemCompraChange(Self);

     EdtGeraOCBuscaDocto.Value:=StrToInt(sNumDoc);
     EdtGeraOCBuscaDoctoExit(Self);
   End
  Else // If bProcOK Then
   Begin
     Screen.Cursor:=crDefault;
     msg('Nenhuma Ordem de Compra Encontrada !!','A');
   End; //  // If bProcOK Then

  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

End; // Ordens de Compra das Lojas - Busca OCs nas Loajs ///////////////////////

// Fechamento Diario de Lojas - Executa DML >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.FechaDiarioExecutaDML(sCapiton, sTipo: String): Boolean;
Var
  MySql: String;
  sDta, sDtaVenc, sIndRealizado: String;
Begin
  // sTipo: (I)Inserir (A)Alterar

  Result:=False;

  // Acerta Data ===============================================================
  sDta:=f_Troca('/','.',DtEdtFinanFechaDiarioData.Text);
  sDta:=f_Troca('-','.',sDta);

  sDtaVenc:=f_Troca('/','.',DtEdtFinanFechaDiarioDtaVenc.Text);
  sDtaVenc:=f_Troca('-','.',sDtaVenc);

  sIndRealizado:='NAO';
  If Ckb_FinanFechaDiarioRealizado.Checked Then
   sIndRealizado:='SIM';
  
  // Cria Num_Seq ==============================================================
  If sgNumSeq='0' Then
  Begin
    MySql:=' SELECT Coalesce(max(d.num_seq)+1 ,1) NumSeq'+
           ' FROM FIN_FECHAMENTO_DIARIO d';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sgNumSeq:=DMBelShop.CDS_BuscaRapida.FieldByName('NumSeq').AsString;
    If sgNumSeq='' Then
     sgNumSeq:='1';
    DMBelShop.CDS_BuscaRapida.Close;
  End;

  // Monta Clausulas de Insert =================================================
  If sTipo='I' Then
  Begin
    MySql:=' Insert Into FIN_FECHAMENTO_DIARIO';

    // Define Campos ------------------------------------------------
    MySql:=MySql+' ('+
                 ' NUM_SEQ, TIP_DOCTO, COD_LOJA, DTA_DIA,'+
                 ' VLR_DOCTO, IND_REALIZADO, VLR_REALIZADO, VLR_DIFERENCA,'+
                 ' USU_INCLUI';

    If (sCapiton='Pagamentos') Or (sCapiton='Depsito') Then
     MySql:=MySql+', NUM_DOCTO, DES_DOCTO';

    If sCapiton='Pagamentos' Then
     MySql:=MySql+', NUM_NOTA, DTA_VENCIMENTO';

    MySql:=MySql+')'; 

    // Define Valores -----------------------------------------------
    MySql:=MySql+' Values ('+
                 QuotedStr(sgNumSeq)+', '+ // Num_Seq
                 IntToStr(Lb_FinanFechaDiarioTipoMovto.Tag)+', '+ // Tip_Docto
                 QuotedStr(sCodFilial)+', '+ // Cod_Loja
                 QuotedStr(sdta); // Dta_Dia

    // Vlr_docto
    If sCapiton='Pagamentos' Then
     MySql:=MySql+', '+QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrDocto.Value)));
     
    If (sCapiton='Depsito') Or (sCapiton='Vlr Recebido') Then
     MySql:=MySql+', '+QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrRealizado.Value)));

    // Ind_Realizado 
    MySql:=MySql+', '+QuotedStr(sIndRealizado)+', '+
                 QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrRealizado.Value)));

    // Vlr_Diferenca
    If sCapiton='Pagamentos' Then
    Begin
      If sIndRealizado='SIM' Then
       MySql:=MySql+', '+QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrRealizado.Value-EdtFinanFechaDiarioVlrDocto.Value)))
      Else
       MySql:=MySql+', 0';
    End;
     
    If (sCapiton='Depsito') Or (sCapiton='Vlr Recebido') Then
     MySql:=MySql+', 0'; 

    // Usu_Inclui 
    MySql:=MySql+', '+QuotedStr(Cod_Usuario);

    // Num_Docto, Des_Docto
    If (sCapiton='Pagamentos') Or (sCapiton='Depsito') Then
     MySql:=MySql+', '+
                 QuotedStr(EdtFinanFechaDiarioNumDocto.Text)+', '+
                 QuotedStr(EdtFinanFechaDiarioDesDocto.Text);

    // Num_noa
    If sCapiton='Pagamentos' Then
     MySql:=MySql+', '+QuotedStr(EdtFinanFechaDiarioNumNota.Text)+', '+
                       QuotedStr(sDtaVenc);

    MySql:=MySql+')'; 
  End; // If sTipo='I' Then
  
  // Monta Clausulas de Update =================================================
  If sTipo='A' Then 
  Begin
    MySql:=' Update FIN_FECHAMENTO_DIARIO';

    // Define Campos ------------------------------------------------
    MySql:=MySql+' Set IND_REALIZADO='+QuotedStr(sIndRealizado)+', '+
                 ' VLR_REALIZADO='+QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrRealizado.Value)))+', '+
                 ' USU_ALTERA='+QuotedStr(Cod_Usuario)+', '+
                 ' DTA_ALTERA=Current_Date';


    If (sCapiton='Pagamentos') Or (sCapiton='Depsito') Then
     MySql:=MySql+', NUM_DOCTO='+QuotedStr(EdtFinanFechaDiarioNumDocto.Text)+
                  ', DES_DOCTO='+QuotedStr(EdtFinanFechaDiarioDesDocto.Text);


    If sCapiton='Pagamentos' Then
     MySql:=MySql+', NUM_NOTA='+QuotedStr(EdtFinanFechaDiarioNumNota.Text)+
                  ', DTA_VENCIMENTO='+QuotedStr(sDtaVenc);

    If sCapiton='Pagamentos' Then
     MySql:=MySql+', VLR_DOCTO='+QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrDocto.Value)));
     
    If (sCapiton='Depsito') Or (sCapiton='Vlr Recebido') Then
     MySql:=MySql+', VLR_DOCTO='+QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrRealizado.Value)));

    If sCapiton='Pagamentos' Then
    Begin
      If sIndRealizado='SIM' Then
       MySql:=MySql+', VLR_DIFERENCA='+QuotedStr(f_Troca(',','.',VarToStr(EdtFinanFechaDiarioVlrRealizado.Value-
                                                                          EdtFinanFechaDiarioVlrDocto.Value)))
      Else
       MySql:=MySql+', VLR_DIFERENCA=0';
    End; // If sCapiton='Pagamentos' Then

    MySql:=MySql+' Where Num_Seq='+sgNumSeq; 
  End;

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    Result:=True;

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';

      MontaProgressBar(False, FrmBelShop);
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try 
  
End; // Fechamento Diario de Lojas - Executa DML >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Fechamento Diario de Lojas - Atualiza Componenetes >>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.FechaDiarioComponentes(sCapiton: String);
Var
  bMDL: Boolean;
Begin

  bMDL:=False;

  Gb_FinanFechaDiarioNumDocto.Visible:=False;
  edtFinanFechaDiarioNumDocto.Clear;
  Gb_FinanFechaDiarioDesDocto.Visible:=False;
  edtFinanFechaDiarioDesDocto.Clear;
  Gb_FinanFechaDiarioNumNota.Visible:=False;
  EdtFinanFechaDiarioNumNota.Clear;
  Gb_DtFinanFechaDiarioDtaVenc.Visible:=False;
  DtedtFinanFechaDiarioDtaVenc.Clear;
  Gb_FinanFechaDiarioVlrDocto.Visible:=False;
  EdtFinanFechaDiarioVlrDocto.Clear;
  Gb_FinanFechaDiarioRealizado.Visible:=False;
  Ckb_FinanFechaDiarioRealizado.Checked:=False;
  Ckb_FinanFechaDiarioRealizadoClick(Self);
  Gb_FinanFechaDiarioVlrRealizado.Visible:=False;
  EdtFinanFechaDiarioVlrRealizado.Clear;
  Refresh;
  
  If sCapiton='Pagamentos' Then
  Begin
    Gb_FinanFechaDiarioVlrRealizado.Visible:=True;

    Gb_FinanFechaDiarioRealizado.Visible:=True;
    Ckb_FinanFechaDiarioRealizadoClick(Self);

    Gb_FinanFechaDiarioVlrDocto.Visible:=True;
    Gb_DtFinanFechaDiarioDtaVenc.Visible:=True;
    Gb_FinanFechaDiarioNumNota.Visible:=True;
    Gb_FinanFechaDiarioDesDocto.Visible:=True;
    Gb_FinanFechaDiarioNumDocto.Visible:=True;

    EdtFinanFechaDiarioNumDocto.SetFocus; 

    bMDL:=True;
  End; // If sCapiton='Pagamentos' Then

  If sCapiton='Depsito' Then  
  Begin
    Gb_FinanFechaDiarioVlrRealizado.Visible:=True;

    Gb_FinanFechaDiarioRealizado.Visible:=True;
    Ckb_FinanFechaDiarioRealizadoClick(Self);

    Gb_FinanFechaDiarioDesDocto.Visible:=True;
    Gb_FinanFechaDiarioNumDocto.Visible:=True;

    EdtFinanFechaDiarioNumDocto.SetFocus; 

    bMDL:=True;
  End; // If sCapiton='Depsito' Then  

  If sCapiton='Vlr Recebido' Then  
  Begin
    Gb_FinanFechaDiarioVlrRealizado.Visible:=True;

    Gb_FinanFechaDiarioRealizado.Visible:=True;
    Ckb_FinanFechaDiarioRealizadoClick(Self);

    Ckb_FinanFechaDiarioRealizado.SetFocus;

    bMDL:=True;
  End; // If sCapiton='Vlr Recebido' Then  

  
  If bMDL Then
   Begin
     Bt_FinanFechaDiarioPagto.Enabled:=False;
     Bt_FinanFechaDiarioDeposito.Enabled:=False;
     Bt_FinanFechaDiarioVlrRecebido.Enabled:=False;

     Bt_FinanFechaDiarioAlterar.Enabled:=False;
     Bt_FinanFechaDiarioExcluir.Enabled:=False;

     BT_FinanFechaDiarioConfirmar.Enabled:=True;
     BT_FinanFechaDiarioAbandonar.Enabled:=True;

     Gb_FinanFechaDiarioMovtos.Enabled:=False;
     Gb_FinanFechaDiarioTotais.Enabled:=False;

   End
  Else
   Begin
     Bt_FinanFechaDiarioPagto.Enabled:=True;
     Bt_FinanFechaDiarioDeposito.Enabled:=True;
     Bt_FinanFechaDiarioVlrRecebido.Enabled:=True;
     Bt_FinanFechaDiarioVlrRecebido.Enabled:=True;

     Bt_FinanFechaDiarioAlterar.Enabled:=True;
     Bt_FinanFechaDiarioExcluir.Enabled:=True;

     BT_FinanFechaDiarioConfirmar.Enabled:=False;
     BT_FinanFechaDiarioAbandonar.Enabled:=False;

     Gb_FinanFechaDiarioMovtos.Enabled:=True;
     Gb_FinanFechaDiarioTotais.Enabled:=True;
   End

End; // Fechamento Diario de Lojas - Atualiza Componenetes >>>>>>>>>>>>>>>>>>>>>

// Fechamento Diario de Lojas - Calcular Totais >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.FechaDiarioTotais(sData: String);
Var
  MySql: String;
  sNumSeq, sVlrTotal: String;
Begin
  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart; 
    DateSeparator:='.';
    DecimalSeparator:='.';
    
    // Total Realizado ===========================================================
    MySql:=' SELECT SUM(COALESCE(d.vlr_Realizado,0)) Vlr_Total'+
           ' FROM FIN_FECHAMENTO_DIARIO d'+
           ' WHERE d.tip_docto<90'+
           ' AND d.ind_realizado=''SIM'''+
           ' and d.cod_loja='+QuotedStr(sCodFilial)+
           ' and d.dta_dia='+QuotedStr(sData);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sVlrTotal:=DMBelShop.CDS_BuscaRapida.FieldByName('Vlr_Total').AsString;

    If Trim(sVlrTotal)='' Then
     sVlrTotal:='0';

    DMBelShop.CDS_BuscaRapida.Close;
  
    // Busca Total Realizado  ====================================================
    MySql:=' SELECT d.num_seq'+
           ' FROM FIN_FECHAMENTO_DIARIO d'+
           ' WHERE d.num_docto=909090'+
           ' and d.cod_loja='+QuotedStr(sCodFilial)+
           ' and d.dta_dia='+QuotedStr(sData);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sNumSeq:=DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsString;
    DMBelShop.CDS_BuscaRapida.Close;

    If sNumSeq='' Then
     Begin
       MySql:=' Insert into FIN_FECHAMENTO_DIARIO'+
              ' (NUM_SEQ, TIP_DOCTO, COD_LOJA, DTA_DIA, NUM_DOCTO, DES_DOCTO,'+
              ' VLR_DOCTO, IND_REALIZADO, VLR_REALIZADO, VLR_DIFERENCA, USU_INCLUI)'+

              ' Values((select Coalesce(max(d.num_seq)+1 ,1) from fin_fechamento_diario d), '+
              '90, '+
              QuotedStr(sCodFilial)+', '+
              QuotedStr(sData)+', '+
              QuotedStr('909090')+', '+
              QuotedStr('TOTAL REALIZADOS')+', '+
              QuotedStr(sVlrTotal)+', '+
              '''SIM'', 0, 0,'+QuotedStr(Cod_Usuario)+')';
             DMBelShop.SQLC.Execute(MySql,nil,nil);
     End
    Else // If sNumSeq<>'' Then
     Begin
       MySql:=' Update FIN_FECHAMENTO_DIARIO'+
              ' Set VLR_DOCTO='+QuotedStr(sVlrTotal)+
              ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
              ' where NUM_SEQ='+sNumSeq;
       DMBelShop.SQLC.Execute(MySql,nil,nil);
     End; // If sNumDoc<>'' Then

    // Busca Total de Diferena ==================================================
    // Total Realizado ===========================================================
    MySql:=' SELECT (COALESCE(d.vlr_docto,0)-COALESCE(dd.Vlr,0)) Vlr_Diferenca'+
           ' FROM fin_fechamento_diario d,'+
           ' (SELECT d1.cod_loja, d1.dta_dia, COALESCE(d1.vlr_docto,0) Vlr'+
           '  FROM fin_fechamento_diario d1'+
           '  WHERE d1.tip_docto = 95'+
           ' ) dd'+
           ' WHERE d.tip_docto = 90'+
           ' AND d.cod_loja='+QuotedStr(sCodFilial)+
           ' AND d.dta_dia='+QuotedStr(sData)+
           ' AND d.cod_loja=dd.cod_loja'+
           ' AND d.dta_dia=dd.dta_dia';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sVlrTotal:=DMBelShop.CDS_BuscaRapida.FieldByName('Vlr_Diferenca').AsString;

    If Trim(sVlrTotal)='' Then
     sVlrTotal:='0';

    DMBelShop.CDS_BuscaRapida.Close;

    MySql:=' SELECT d.num_seq'+
           ' FROM FIN_FECHAMENTO_DIARIO d'+
           ' WHERE d.num_docto=999999'+
           ' and d.cod_loja='+QuotedStr(sCodFilial)+
           ' and d.dta_dia='+QuotedStr(sData);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sNumSeq:=DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsString;
    DMBelShop.CDS_BuscaRapida.Close;

    If sNumSeq='' Then
     Begin
       MySql:=' Insert into FIN_FECHAMENTO_DIARIO'+
              ' (NUM_SEQ, TIP_DOCTO, COD_LOJA, DTA_DIA, NUM_DOCTO, DES_DOCTO,'+
              ' VLR_DOCTO, IND_REALIZADO, VLR_REALIZADO, VLR_DIFERENCA, USU_INCLUI)'+
                                            
              ' Values((select Coalesce(max(d.num_seq)+1 ,1) from fin_fechamento_diario d), '+
              '99, '+
              QuotedStr(sCodFilial)+', '+
              QuotedStr(sData)+', '+
              QuotedStr('999999')+', '+
              QuotedStr('FECHAMENTO DO DIA')+', '+
              QuotedStr(sVlrTotal)+', '+
              '''SIM'', 0, 0,'+QuotedStr(Cod_Usuario)+')';
             DMBelShop.SQLC.Execute(MySql,nil,nil);
     End
    Else // If sNumSeq<>'' Then
     Begin
       MySql:=' Update FIN_FECHAMENTO_DIARIO'+
              ' Set VLR_DOCTO='+QuotedStr(sVlrTotal)+
              ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
              ' where NUM_SEQ='+sNumSeq;
       DMBelShop.SQLC.Execute(MySql,nil,nil);
     End; // If sNumDoc<>'' Then

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      MontaProgressBar(False, FrmBelShop);
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try 
     
End; // Fechamento Diario de Lojas - Calcular Totais >>>>>>>>>>>>>>>>>>>>>>>>>>>

// Fechamento Diario de Lojas - Habilita Componentes >>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.FechaDiarioHabilita(bHabilita: Boolean);
Begin
  Pan_FinanFechaDiarioManut.Enabled:=bHabilita;
  Gb_FinanFechaDiarioManut.Enabled :=bHabilita;
  Gb_FinanFechaDiarioMovtos.Enabled:=bHabilita;
  Gb_FinanFechaDiarioTotais.Enabled:=bHabilita;
End; // Fechamento Diario de Lojas - Habilita Componentes >>>>>>>>>>>>>>>>>>>>>>

// Fechamento de Caixa Dia - Habilita Caixa Aberta/Fechada >>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.FechaCaixaDiaHabilita(bFechado: Boolean);
Begin

  Pan_FinanFechaCaixa.Enabled:=True;
  Bt_FinanFechaCaixaSituacao.Enabled:=True;

  Pan_FinanFechaCaixaSituacao.Caption:='';
  Pan_FinanFechaCaixaSituacao.Font.Color:=clWhite;

  Pan_FinanFechaCaixaTop.Enabled:=Not bFechado;
  Gb_FinanFechaCaixaDocto.Enabled:=Not bFechado;

  Dbg_FinanFechaCaixaDoctos.ReadOnly:=Not bFechado;
  Dbg_FinanFechaCaixaTotal.ReadOnly:=Not bFechado;

  If bFechado Then
   Begin
     Pan_FinanFechaCaixaSituacao.Caption:='Caixa Fechado';
     Pan_FinanFechaCaixaSituacao.Color:=clBlue;
     Bt_FinanFechaCaixaSituacao.Caption:='Abrir Caixa';
   End
  Else
   Begin
     Pan_FinanFechaCaixaSituacao.Caption:='Caixa Aberto';
     Pan_FinanFechaCaixaSituacao.Color:=clRed;
     Bt_FinanFechaCaixaSituacao.Caption:='Fechar Caixa';
   End;
End; // Fechamento de Caixa Dia - Habilita Caixa Aberta/Fechada >>>>>>>>>>>>>>>>

// Fechamento de Caixa Dia - Busca Plano de Contas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.FechaCaixaPlanoContas(sData, sTipo: String): Boolean;
Var
  MySql: String;
  i: Integer;
  sDta: String;
Begin
  Result:=False;
  
  sDta:=f_Troca('/', '.',sData);
  sDta:=f_Troca('-', '.',sDta);

  MySql:=' Select co.codconta, Trim(pl.nomedaconta) nomedaconta'+
         ' From CAIXACONTA co, CAIXAPLANO pl'+
         ' Where co.codcontaplano=pl.codcontaplano';

         If sTipo='D' Then
          MySql:=MySql+' And Upper(pl.nomedaconta) like '+QuotedStr('%DINHEI%')
         Else
          MySql:=MySql+' order by 2';
  IBQ_ConsultaFilial.Close;
  IBQ_ConsultaFilial.SQL.Clear;
  IBQ_ConsultaFilial.SQL.Add(MySql);

  // Abre Query ---------------------------------------------------
  i:=0;
  bgSiga:=False;
  While Not bgSiga do
  Begin
    Try
      IBQ_ConsultaFilial.Open;
      bgSiga:=True;
    Except
      Inc(i);
    End; // Try

    If i>10 Then
    Begin
      IBQ_ConsultaFilial.Close;
      OdirPanApres.Visible:=False;
      msg('Conexo Perdida !!'+cr+'Loja: '+sCodFilial+' !!','A');
      Break;
    End; // If i>10 Then
  End; // While Not bSiga do

  // Atualiza Contas ===========================================================
  If bgSiga Then // Query Executada
  Begin
  
    // Verifica se Transao esta Ativa
    If DMBelShop.SQLC.InTransaction Then
     DMBelShop.SQLC.Rollback(TD);

    // Monta Transacao =========================================================
    TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);
    Try
      Screen.Cursor:=crAppStart;
      DateSeparator:='.';
      DecimalSeparator:='.';

      // Fechamento do Caixa da Loja --------------------------------
      If sTipo='C' Then
      Begin
        MySql:=' SELECT cx.cod_credito'+
               ' FROM FIN_FECHAMENTO_CAIXA cx'+
               ' where cx.cod_loja='+QuotedStr(sCodFilial)+
               ' and cx.dta_caixa='+QuotedStr(sDta);
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;

        While Not IBQ_ConsultaFilial.Eof do
        Begin
          Refresh;

          If not DMBelShop.CDS_BuscaRapida.Locate('cod_credito',IBQ_ConsultaFilial.FieldByName('codconta').AsInteger,[]) Then
           Begin
             MySql:=' Insert into FIN_FECHAMENTO_CAIXA'+
                    ' (NUM_SEQ, COD_LOJA, DTA_CAIXA, COD_CREDITO, DES_CREDITO, NUM_DOCTO,'+
                    '  VLR_CREDITO, VLR_INFORMADO, VLR_DIFERENCA, IND_INFORMADO, USU_INCLUI)'+
                    ' Values('+
                    '1, '+
                    QuotedStr(sCodFilial)+', '+
                    QuotedStr(sDta)+', '+
                    IBQ_ConsultaFilial.FieldByName('codconta').AsString+', '+
                    QuotedStr(Trim(IBQ_ConsultaFilial.FieldByName('nomedaconta').AsString))+', '+
                    '0, 0, 0, 0, ''NAO'', '+QuotedStr(Cod_Usuario)+')';
           End
          Else // If not DMBelShop.CDS_BuscaRapida.Locate('cod_credito',IBQ_ConsultaFilial.FieldByName('codconta').AsInteger,[]) Then
           Begin
             MySql:=' Update FIN_FECHAMENTO_CAIXA cx'+
                    ' Set cx.Vlr_Credito=0'+
                    ', DES_CREDITO='+QuotedStr(Trim(IBQ_ConsultaFilial.FieldByName('nomedaconta').AsString))+
                    ' where cx.cod_loja='+QuotedStr(sCodFilial)+
                    ' and cx.dta_caixa='+QuotedStr(sDta)+
                    ' And cx.Cod_Credito='+IBQ_ConsultaFilial.FieldByName('codconta').AsString;
           End;  // If not DMBelShop.CDS_BuscaRapida.Locate('cod_credito',IBQ_ConsultaFilial.FieldByName('codconta').AsInteger,[]) Then
          DMBelShop.SQLC.Execute(MySql,nil,nil);

          IBQ_ConsultaFilial.Next;
        End; // While Not IBQ_ConsultaFilial.Eof do
        DMBelShop.CDS_BuscaRapida.Close;

      End; // If sTipo='C' Then  

      // Fechamento Diario da Loja ----------------------------------
      If sTipo='D' Then
      Begin
        MySql:=' SELECT d.Num_Seq'+
               ' FROM FIN_FECHAMENTO_DIARIO d'+
               ' WHERE d.tip_docto=95'+
               ' AND d.cod_loja='+QuotedStr(sCodFilial)+
               ' AND d.dta_dia='+QuotedStr(sDta);
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;

        If DMBelShop.CDS_BuscaRapida.IsEmpty Then
        Begin
          Refresh;

          MySql:=' Insert into FIN_FECHAMENTO_DIARIO'+
                 ' (NUM_SEQ, TIP_DOCTO, COD_LOJA, DTA_DIA, NUM_DOCTO, DES_DOCTO,'+
                 ' VLR_DOCTO, IND_REALIZADO, VLR_REALIZADO, VLR_DIFERENCA, USU_INCLUI)'+

                 ' Values((select Coalesce(max(d.num_seq)+1 ,1) from fin_fechamento_diario d), '+
                 '95, '+
                 QuotedStr(sCodFilial)+', '+
                 QuotedStr(sDta)+', '+
                 IBQ_ConsultaFilial.FieldByName('codconta').AsString+', '+
                 QuotedStr(IBQ_ConsultaFilial.FieldByName('nomedaconta').AsString)+', '+
                 ' 0, ''SIM'', 0, 0,'+QuotedStr(Cod_Usuario)+')';
           DMBelShop.SQLC.Execute(MySql,nil,nil);
        End; // If Not IBQ_ConsultaFilial.IsEmpty Then
        DMBelShop.CDS_BuscaRapida.Close;

      End; // If sTipo='D' Then

      // Atualiza Transacao =======================================
      DMBelShop.SQLC.Commit(TD);
        
      Result:=True;
      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

    Except
      on e : Exception do
      Begin
        // Abandona Transacao =====================================
        DMBelShop.SQLC.Rollback(TD);

        DateSeparator:='/';
        DecimalSeparator:=',';
        Screen.Cursor:=crDefault;
        MontaProgressBar(False, FrmBelShop);
        OdirPanApres.Visible:=False;

        bgSiga:=False;

        MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      End; // on e : Exception do
    End; // Try 
      
  End; // If bSiga Then // Query Executada
End; // Fechamento de Caixa Dia - Busca Plano de Contas >>>>>>>>>>>>>>>>>>>>>>>>

// Fechamento de Caixa Dia - Busca Total de Dditos >>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.FechaCaixaTotalDebitos: Boolean;
Var
  MySql: String;
  i: Integer;
  sDta: String;
  sTotDebitos: String;
Begin
  Result:=False;
  
  sDta:=f_Troca('/', '.',DtEdtFinanFechaCaixaData.Text);
  sDta:=f_Troca('-', '.',sDta);

  MySql:=' Select sum(Coalesce(m.totnota,0)) Tot_Debitos'+
         ' From mcli m, comprv c'+
         ' Where m.codcomprovante=c.codcomprovante'+
         ' And m.codcomprovante in (''002'', ''007'')'+
         ' And m.codfilial='+QuotedStr(sCodFilial)+
         ' And m.datacomprovante='+QuotedStr(sDta);
  IBQ_ConsultaFilial.Close;
  IBQ_ConsultaFilial.SQL.Clear;
  IBQ_ConsultaFilial.SQL.Add(MySql);

  // Abre Query ---------------------------------------------------
  i:=0;
  bgSiga:=False;
  While Not bgSiga do
  Begin
    Try
      IBQ_ConsultaFilial.Open;
      bgSiga:=True;
    Except
      Inc(i);
    End; // Try

    If i>10 Then
    Begin
      IBQ_ConsultaFilial.Close;
      OdirPanApres.Visible:=False;
      msg('Conexo Perdida !!'+cr+'Loja: '+sCodFilial+' !!','A');
      Break;
    End; // If i>10 Then
  End; // While Not bSiga do

  // Atualiza COntas =========================================================
  If bgSiga Then // Query Executada
  Begin
     sTotDebitos:=IBQ_ConsultaFilial.FieldByName('Tot_Debitos').AsString;
     If sTotDebitos='' Then
      sTotDebitos:='0';
  
    // Verifica se Transao esta Ativa
    If DMBelShop.SQLC.InTransaction Then
     DMBelShop.SQLC.Rollback(TD);

    // Monta Transacao ===========================================================
    TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);
    Try
      Screen.Cursor:=crAppStart;
      DateSeparator:='.';
      DecimalSeparator:='.';

      MySql:=' SELECT cx.cod_credito'+
             ' FROM FIN_FECHAMENTO_CAIXA cx'+
             ' where cx.Cod_Credito=''9999'''+
             ' And cx.cod_loja='+QuotedStr(sCodFilial)+
             ' And cx.dta_caixa='+QuotedStr(sDta);
      DMBelShop.CDS_BuscaRapida.Close;
      DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
      DMBelShop.CDS_BuscaRapida.Open;

      If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('cod_credito').AsString)='' Then
       Begin
         MySql:=' Insert into FIN_FECHAMENTO_CAIXA'+
                ' (NUM_SEQ, COD_LOJA, DTA_CAIXA, COD_CREDITO, DES_CREDITO, NUM_DOCTO,'+
                '  VLR_CREDITO, VLR_INFORMADO, VLR_DIFERENCA, IND_INFORMADO,'+
                '  IND_FECHADO, USU_INCLUI)'+
                ' Values('+
                '9999, '+
                QuotedStr(sCodFilial)+', '+
                QuotedStr(sDta)+', '+
                '''9999'', ''Dbitos/Crbitos do Dia'', Null,'+
                QuotedStr(f_Troca(',','.',sTotDebitos))+', '+
                ' 0, 0, ''NAO'', ''NAO'', '+QuotedStr(Cod_Usuario)+')';
         DMBelShop.SQLC.Execute(MySql,nil,nil);
       End
      Else // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('cod_credito').AsString)='' Then
       Begin
         MySql:=' Update FIN_FECHAMENTO_CAIXA cx'+
                ' Set cx.VLR_CREDITO='+QuotedStr(f_Troca(',','.', sTotDebitos))+
                ', cx.vlr_diferenca=cx.vlr_informado-cx.vlr_credito'+
                ' Where cx.Cod_Loja='+QuotedStr(sCodFilial)+
                ' And cx.Dta_Caixa='+QuotedStr(sDta)+
                ' And cx.Cod_Credito=''9999''';
         DMBelShop.SQLC.Execute(MySql,nil,nil);
       End; // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('cod_credito').AsString)='' Then

      DMBelShop.CDS_BuscaRapida.Close;
        
      // Atualiza Transacao =======================================
      DMBelShop.SQLC.Commit(TD);
        
      Result:=True;
      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

    Except
      on e : Exception do
      Begin
        // Abandona Transacao =====================================
        DMBelShop.SQLC.Rollback(TD);

        DateSeparator:='/';
        DecimalSeparator:=',';
        MontaProgressBar(False, FrmBelShop);
        OdirPanApres.Visible:=False;
        Screen.Cursor:=crDefault;

        bgSiga:=False;

        MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      End; // on e : Exception do
    End; // Try 
      
  End; // If bSiga Then // Query Executada
End; // // Fechamento de Caixa Dia - Busca Total de Dditos >>>>>>>>>>>>>>>>>>>>

// Fechamento de Caixa Dia - Busca Movtos de Crditos >>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.FechaCaixaMovtosCreditos(sData, sTipo: String): Boolean;
Var
  MySql: String;
  i: Integer;
  sDta, sCodDinheiro, sVlrTotal: String;
Begin

  Result:=False;
  
  sDta:=f_Troca('/', '.',sData);
  sDta:=f_Troca('-', '.',sDta);

  If sTipo='D' Then
  Begin
    // Busca Cdgio do Plano de Contas Dinheiro
    MySql:=' SELECT d.num_seq, d.num_docto'+
           ' FROM FIN_FECHAMENTO_DIARIO d'+
           ' WHERE d.tip_docto=95'+
           ' AND d.cod_loja='+QuotedStr(sCodFilial)+
           ' AND d.dta_dia='+QuotedStr(sDta);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sCodDinheiro:=Trim(DMBelShop.CDS_BuscaRapida.FieldByName('num_docto').AsString);
    
    If sCodDinheiro='' Then
     sCodDinheiro:='0';
  End; // If sTipo='D' Then

  MySql:=' Select cx.codconta, Trim(pl.nomedaconta) Nome,'+
         ' mov.numero,'+
         ' Sum(Coalesce(mov.totnota,0)) Vlr_Total'+

         ' From MCLI mov, MCLICAIXA cx, CAIXACONTA co, CAIXAPLANO pl'+

         ' Where mov.chavenf=cx.chavenf'+
         ' And cx.codconta=co.codconta'+
         ' And co.codcontaplano=pl.codcontaplano'+

         ' And mov.codcomprovante=''200'''+
         ' And mov.codfilial='+QuotedStr(sCodFilial)+
         ' And mov.datacomprovante='+QuotedStr(sDta);

         If sTipo='D' Then
          MySql:=MySql+' and cx.codconta='+sCodDinheiro;
          
         MySql:=MySql+' Group By 1, 2, 3'+

         ' UNION'+ // <<<<

         ' Select pg.codconta, Trim(plg.nomedaconta) Nome,'+
         ' mpg.numero,'+
         ' Sum(Coalesce(cx.totnota,0)) Vlr_Total'+

         ' From mcli mpg, MCLIPAGO cx, MCLIPAGOCAIXA pg, CAIXACONTA ct, CAIXAPLANO plg'+

         ' Where mpg.chavenf=cx.chavenf'+
         ' and cx.chavenfprestacao=pg.chavenfprestacao'+
         ' And pg.codconta=ct.codconta'+
         ' And ct.codcontaplano=plg.codcontaplano'+

         ' And cx.codcomprovante=''200'''+
         ' And cx.codfilial='+QuotedStr(sCodFilial)+
         ' And cx.datacomprovante='+QuotedStr(sDta);

         If sTipo='D' Then
          MySql:=MySql+' and pg.codconta='+sCodDinheiro;
          
         MySql:=MySql+' Group By 1, 2, 3';

         If sTipo='C' Then
          MySql:=MySql+' order by 4';
  IBQ_ConsultaFilial.Close;
  IBQ_ConsultaFilial.SQL.Clear;
  IBQ_ConsultaFilial.SQL.Add(MySql);

  // Abre Query ---------------------------------------------------
  i:=0;
  bgSiga:=False;
  While Not bgSiga do
  Begin
    Try
      IBQ_ConsultaFilial.Open;
      bgSiga:=True;
    Except
      Inc(i);
    End; // Try

    If i>10 Then
    Begin
      IBQ_ConsultaFilial.Close;
      OdirPanApres.Visible:=False;
      msg('Conexo Perdida !!'+cr+'Loja: '+sCodFilial+' !!','A');
      Break;
    End; // If i>10 Then
  End; // While Not bSiga do

  // Atualiza COntas =========================================================
  If bgSiga Then // Query Executada
  Begin
  
    // Verifica se Transao esta Ativa
    If DMBelShop.SQLC.InTransaction Then
     DMBelShop.SQLC.Rollback(TD);

    // Monta Transacao ===========================================================
    TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);
    Try
      Screen.Cursor:=crAppStart;
      DateSeparator:='.';
      DecimalSeparator:='.';

      // Fechamento do Caixa da Loja --------------------------------
      If sTipo='C' Then
      Begin
        MySql:=' SELECT cx.cod_credito'+
               ' FROM FIN_FECHAMENTO_CAIXA cx'+
               ' where cx.cod_loja='+QuotedStr(sCodFilial)+
               ' and cx.dta_caixa='+QuotedStr(sDta);
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;

        While Not IBQ_ConsultaFilial.Eof do
        Begin
          Refresh;

          sVlrTotal:=Trim(f_Troca(',','.',IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsString));
          If sVlrTotal='' Then
           sVlrTotal:='0';
        
          If not DMBelShop.CDS_BuscaRapida.Locate('cod_credito',IBQ_ConsultaFilial.FieldByName('codconta').AsInteger,[]) Then
           Begin
             MySql:=' Insert into FIN_FECHAMENTO_CAIXA'+
                    ' (NUM_SEQ, COD_LOJA, DTA_CAIXA, COD_CREDITO, DES_CREDITO, NUM_DOCTO,'+
                    '  VLR_CREDITO, VLR_INFORMADO, VLR_DIFERENCA, IND_INFORMADO, USU_INCLUI)'+
                    ' Values('+
                    '1, '+
                    QuotedStr(sCodFilial)+', '+
                    QuotedStr(sDta)+', '+
                    IBQ_ConsultaFilial.FieldByName('codconta').AsString+', '+
                    QuotedStr(Trim(IBQ_ConsultaFilial.FieldByName('Nome').AsString))+', '+
                    QuotedStr(IBQ_ConsultaFilial.FieldByName('Numero').AsString)+', '+
                    QuotedStr(sVlrTotal)+', '+
                    '0, 0, ''NAO'', '+QuotedStr(Cod_Usuario)+')';
           End // If not DMBelShop.CDS_BuscaRapida.Locate('cod_credito',IBQ_ConsultaFilial.FieldByName('codconta').AsInteger,[]) Then
          Else
           Begin
             MySql:=' Update FIN_FECHAMENTO_CAIXA'+
                    ' Set DES_CREDITO='+
                    QuotedStr(Trim(IBQ_ConsultaFilial.FieldByName('Nome').AsString))+
                    ', NUM_DOCTO='+QuotedStr(IBQ_ConsultaFilial.FieldByName('Numero').AsString)+
                    ', VLR_CREDITO='+QuotedStr(sVlrTotal)+
                    ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
                    ' where COD_LOJA='+QuotedStr(sCodFilial)+
                    ' and DTA_CAIXA='+QuotedStr(sDta)+
                    ' and COD_CREDITO='+IBQ_ConsultaFilial.FieldByName('codconta').AsString;
           End; // If not DMBelShop.CDS_BuscaRapida.Locate('cod_credito',IBQ_ConsultaFilial.FieldByName('codconta').AsInteger,[]) Then
          DMBelShop.SQLC.Execute(MySql,nil,nil);

          IBQ_ConsultaFilial.Next;
        End; // While Not IBQ_ConsultaFilial.Eof do
        DMBelShop.CDS_BuscaRapida.Close;
      End; // If sTipo='C' Then

      // Fechamento Diario da Loja ----------------------------------
      If sTipo='D' Then
      Begin
        If sCodDinheiro<>'' Then
        Begin
          sVlrTotal:=Trim(f_Troca(',','.',IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsString));
          If sVlrTotal='' Then
           sVlrTotal:='0';

         MySql:=' Update FIN_FECHAMENTO_DIARIO'+
                ' Set VLR_DOCTO='+QuotedStr(sVlrTotal)+
                ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
                ' where NUM_SEQ='+DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsString;
         DMBelShop.SQLC.Execute(MySql,nil,nil);
        End; // If sCodDinheiro<>'' Then
        
        DMBelShop.CDS_BuscaRapida.Close;
      End; // If sTipo='D' Then

      // Atualiza Transacao =======================================
      DMBelShop.SQLC.Commit(TD);

      Result:=True;
      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

    Except
      on e : Exception do
      Begin
        // Abandona Transacao =====================================
        DMBelShop.SQLC.Rollback(TD);

        DateSeparator:='/';
        DecimalSeparator:=',';
        OdirPanApres.Visible:=False;
        MontaProgressBar(False, FrmBelShop);
        Screen.Cursor:=crDefault;

        bgSiga:=False;

        MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      End; // on e : Exception do
    End; // Try 
      
  End; // If bSiga Then // Query Executada
End; // Fechamento de Caixa Dia - Busca Movtos de Crditos >>>>>>>>>>>>>>>>>>>>>

// Fechamento de Caixa Dia - Totais Caixa do Dia da Loja >>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.FechaCaixaTotaisCaixaDia: Boolean;
Var
  MySql: String;
  sDta: String;
Begin
  Result:=False;

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart; 
    DateSeparator:='.';
    DecimalSeparator:='.';

    sDta:=f_Troca('/', '.',DtEdtFinanFechaCaixaData.Text);
    sDta:=f_Troca('-', '.',sDta);

    // Acerta Diferenas --------------------------------------------
    MySql:=' update FIN_FECHAMENTO_CAIXA cx'+
           ' set cx.vlr_diferenca=cx.vlr_informado-cx.vlr_credito'+
           ' where cx.cod_credito<9989'+
           ' and cx.cod_loja='+QuotedStr(sCodFilial)+
           ' and cx.dta_caixa='+QuotedStr(sDta);
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Totais ----------------------------------------------
    MySql:=' SELECT sum(cx.vlr_credito) Tot_Cred,'+
           ' sum(cx.VLR_INFORMADO) Tot_Inf,'+
           ' sum(cx.VLR_DIFERENCA) Tot_Dif'+

           ' FROM FIN_FECHAMENTO_CAIXA cx'+

           ' WHERE cx.cod_Credito<9989'+
           ' And cx.cod_loja='+QuotedStr(FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger))+
           ' And cx.dta_caixa='+QuotedStr(sDta);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    // Atualiza Total Geral -----------------------------------------
    MySql:=' Update FIN_FECHAMENTO_CAIXA cx'+
           ' Set VLR_INFORMADO='+QuotedStr(DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Cred').AsString)+
           ', VLR_DIFERENCA='+DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Cred').AsString+'-VLR_CREDITO';

           If Trim(DMBelShop.CDS_FechaCaixaUSU_INCLUI.AsString)='' Then
            MySql:=MySql+', USU_INCLUI='+QuotedStr(Cod_Usuario)+
                         ', DTA_INCLUI=Current_Date'
           Else
            MySql:=MySql+', USU_ALTERA='+QuotedStr(Cod_Usuario)+
                         ', DTA_ALTERA=Current_Date';
           
           MySql:=MySql+' where cx.cod_loja='+QuotedStr(
                         FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger))+
                        ' and cx.dta_caixa='+QuotedStr(sDta)+
                        ' and cx.cod_credito=9999';
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Total Movtos -------------------------------------------------
    MySql:=' SELECT cx.cod_credito'+
           ' FROM FIN_FECHAMENTO_CAIXA cx'+
           ' where cx.Cod_Credito=''9998'''+
           ' And cx.cod_loja='+QuotedStr(sCodFilial)+
           ' And cx.dta_caixa='+QuotedStr(sDta);
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    If Trim(DMBelShop.CDS_Busca.FieldByName('cod_credito').AsString)='' Then
     Begin
       MySql:=' Insert into FIN_FECHAMENTO_CAIXA'+
              ' (NUM_SEQ, COD_LOJA, DTA_CAIXA, COD_CREDITO, DES_CREDITO, NUM_DOCTO,'+
              '  VLR_CREDITO, VLR_INFORMADO, VLR_DIFERENCA, IND_INFORMADO, USU_INCLUI)'+
              ' Values('+
              '9998, '+
              QuotedStr(sCodFilial)+', '+
              QuotedStr(sDta)+', '+
              '''9998'', ''Totais Fechamento de Caxia do Dia'', Null,'+
              QuotedStr(f_Troca(',','.',DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Cred').AsString))+', '+
              QuotedStr(f_Troca(',','.',DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Inf').AsString))+', '+
              QuotedStr(f_Troca(',','.',DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Dif').AsString))+', '+
              ' ''NAO'', '+QuotedStr(Cod_Usuario)+')';
       DMBelShop.SQLC.Execute(MySql,nil,nil);
     End
    Else // If Trim(DMBelShop.CDS_Busca.FieldByName('cod_credito').AsString)='' Then
     Begin
       MySql:=' Update FIN_FECHAMENTO_CAIXA cx'+
              ' Set VLR_CREDITO='+QuotedStr(DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Cred').AsString)+
              ', VLR_INFORMADO='+QuotedStr(DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Inf').AsString)+
              ', VLR_DIFERENCA='+QuotedStr(DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Dif').AsString);

              If Trim(DMBelShop.CDS_FechaCaixaUSU_INCLUI.AsString)='' Then
               MySql:=MySql+', USU_INCLUI='+QuotedStr(Cod_Usuario)+
                            ', DTA_INCLUI=Current_Date'
              Else
               MySql:=MySql+', USU_ALTERA='+QuotedStr(Cod_Usuario)+
                            ', DTA_ALTERA=Current_Date';

              MySql:=MySql+' where cx.cod_loja='+QuotedStr(FormatFloat('00',
                                          EdtFinanFechaCaixaCodLoja.AsInteger))+
                           ' and cx.dta_caixa='+QuotedStr(sDta)+
                           ' and cx.cod_credito=9998';
       DMBelShop.SQLC.Execute(MySql,nil,nil);
     End; // If Trim(DMBelShop.CDS_Busca.FieldByName('cod_credito').AsString)='' Then

    DMBelShop.CDS_Busca.Close;
    DMBelShop.CDS_BuscaRapida.Close;

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    Result:=True;
    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      OdirPanApres.Visible:=False;
      MontaProgressBar(False, FrmBelShop);
      Screen.Cursor:=crDefault;

      bgSiga:=False;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try 
End; // // Fechamento de Caixa Dia - Totais Caixa do Dia da Loja >>>>>>>>>>>>>>>

// Fechamento de Caixa Dia - Busca Movtos do Caixa do Dia da Loja >>>>>>>>>>>>>>
Function TFrmBelShop.FechaCaixaBuscaMovtoCaixaDia(sCodLoja, sDesLoja, sTipo: String): Boolean;
Begin
// sTipo: (C)Fechamento do Caixa da Loja
//        (D)Fechamento Diario da Loja

  Result:=False;
  sCodFilial:=FormatFloat('00',StrToInt(sCodLoja));

  // Apresentacao ==============================================================
  OdirPanApres.Caption:='AGUARDE !! Busca Movimento do Caixa da Loja: '+sCodFilial+' - '+sDesLoja;
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Conecta Empresa individual ================================================
  If ConexaoEmpIndividual('IBDB_'+sCodFilial, 'IBT_'+sCodFilial, 'A') Then
   Begin
     bgSiga:=True;
   End
  Else // If ConexaoEmpIndividual('IBDB_'+sCodFilial, 'IBT_'+sCodFilial, 'A') Then
   Begin
     Refresh;
     bgSiga:=False;
   End; // If ConexaoEmpIndividual('IBDB_'+sCodFilial, 'IBT_'+sCodFilial, 'A') Then

  If not bgSiga Then
  Begin
    msg('ERRO na Conexo da Loja: Bel_'+sCodFilial,'A');
    OdirPanApres.Visible:=False;
    Exit;
  End;
    
  // Inicia Processamento ======================================================
  If bgSiga Then // Empresa Conectada
  Begin
    // Cria Query da Empresa ----------------------------------------
    CriaQueryIB('IBDB_'+sCodFilial,'IBT_'+sCodFilial,IBQ_ConsultaFilial, True, True);

    // Fechamento de Caixa Dia - Busca Plano de Contas --------------
    If sTipo='C' Then
     Begin
       If Not FechaCaixaPlanoContas(DtEdtFinanFechaCaixaData.Text, 'C') Then
       Begin
         Exit;
       End;
     End
    Else If sTipo='D' Then
     Begin
       If Not FechaCaixaPlanoContas(DtEdtFinanFechaDiarioData.Text, 'D') Then
       Begin
         Exit;
       End;
     End;

    // Fechamento de Caixa Dia - Busca Total de Dditos -------------
    If bgSiga Then
    Begin
      If sTipo='C' Then
      Begin
        If Not FechaCaixaTotalDebitos Then
        Begin
          Exit;
        End;
      End;
    End;

    // Fechamento de Caixa Dia - Busca Movtos de Crditos -----------
    If bgSiga Then
    Begin
      If sTipo='C' Then
       Begin
         If Not FechaCaixaMovtosCreditos(DtEdtFinanFechaCaixaData.Text, 'C') Then
         Begin
           Exit;
         End;
       End
      Else If sTipo='D' Then
       Begin
         If Not FechaCaixaMovtosCreditos(DtEdtFinanFechaDiarioData.Text, 'D') Then
         Begin
           Exit;
         End;
         Result:=True;
       End;
    End;

    // Acerta Totais do Caixo do Dia --------------------------------
    If bgSiga Then
    Begin
      If sTipo='C' Then
      Begin
        If Not FechaCaixaTotaisCaixaDia Then
        Begin
          Exit;
        End;
        Result:=True;
      End;
    End;
  End; //If bSiga Then // Empresa Conectada

  // Fecha Conexo =========================================================
  ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');

  OdirPanApres.Visible:=False;

End; // Fechamento de Caixa Dia - Busca Movtos do Caixa do Dia da Loja >>>>>>>>>

// Fechamento de Caixa Dia >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.FechaCaixaAtualizaCaixaDia;
Var
  MySql, sDta: String;
  i: Integer;
Begin

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart; 
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Atualiza Credito ---------------------------------------------
    i:=DMBelShop.CDS_FechaCaixaCOD_CREDITO.AsInteger;
    sDta:=f_Troca('/','.',DtEdtFinanFechaCaixaData.Text);
    sDta:=f_Troca('-','.',sDta);
    MySql:=' Update FIN_FECHAMENTO_CAIXA cx';

           If Ckb_FinanFechaCaixaSomar.Checked Then
            MySql:=MySql+' Set VLR_INFORMADO=VLR_INFORMADO+'+
                    f_Troca(',','.',VarToStr(EdtFinanFechaCaixaVlrDocto.Value))
           Else
            MySql:=MySql+' Set VLR_INFORMADO='+
                    f_Troca(',','.',VarToStr(EdtFinanFechaCaixaVlrDocto.Value));

           MySql:=MySql+', IND_INFORMADO=''SIM''';

           If Trim(DMBelShop.CDS_FechaCaixaUSU_INCLUI.AsString)='' Then
            MySql:=MySql+', USU_INCLUI='+QuotedStr(Cod_Usuario)+
                         ', DTA_INCLUI=Current_Date'
           Else
            MySql:=MySql+', USU_ALTERA='+QuotedStr(Cod_Usuario)+
                         ', DTA_ALTERA=Current_Date';
           
           MySql:=MySql+' where cx.cod_loja='+QuotedStr(
                         FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger))+
                        ' and cx.dta_caixa='+QuotedStr(sDta)+
                        ' and cx.cod_credito='+DMBelShop.CDS_FechaCaixaCOD_CREDITO.AsString;
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Transacao ===========================================
    DMBelShop.SQLC.Commit(TD);
    DateSeparator:='/';
    DecimalSeparator:=',';

    Screen.Cursor:=crDefault;

    // Atualiza Totais ----------------------------------------------
    FechaCaixaTotaisCaixaDia;

    // Reapresenta Creditos -----------------------------------------
    DMBelShop.CDS_FechaCaixa.DisableControls;

    DMBelShop.CDS_FechaCaixaTotais.Close;
    DMBelShop.CDS_FechaCaixaTotais.Open;

    DMBelShop.CDS_FechaCaixa.Close;
    DMBelShop.CDS_FechaCaixa.Open;
    DMBelShop.CDS_FechaCaixa.Locate('Cod_Credito',i,[]);

    If (DMBelShop.CDS_FechaCaixaVLR_CREDITO.AsCurrency=0) and (DMBelShop.CDS_FechaCaixaVLR_INFORMADO.AsCurrency=0) Then
    Begin
      MySql:=' Update FIN_FECHAMENTO_CAIXA cx'+
             ' Set IND_INFORMADO=''NAO'''+
             ' where cx.cod_loja='+QuotedStr(FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger))+
             ' and cx.dta_caixa='+QuotedStr(sDta)+
             ' and cx.cod_credito='+DMBelShop.CDS_FechaCaixaCOD_CREDITO.AsString;
      DMBelShop.SQLC.Execute(MySql,nil,nil);
    End;

    DMBelShop.CDS_FechaCaixa.Close;
    DMBelShop.CDS_FechaCaixa.Open;
    DMBelShop.CDS_FechaCaixa.Locate('Cod_Credito',i,[]);
    DMBelShop.CDS_FechaCaixa.EnableControls;
  Except
    on e : Exception do
    Begin
      // Abandona Transacao =========================================
      DMBelShop.SQLC.Rollback(TD);
      DateSeparator:='/';
      DecimalSeparator:=',';
      MontaProgressBar(False, FrmBelShop);

      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

End; // Fechamento de Caixa Dia >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// OdirApagar INICIO - AtualizaProd_Endereco - 09/06/2017
//// Curva ABC - Endereamentos - Atualiza Enderecamento do CD >>>>>>>>>>>>>>>>>>>
//Procedure TFrmBelShop.AtualizaProd_Endereco(sCodLoja: String);
//Var
//  MySql: String;
//Begin
//  // Monta Transacao ===========================================================
//  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
//  TD.IsolationLevel:=xilREADCOMMITTED;
//  DMBelShop.SQLC.StartTransaction(TD);
//  Try
//    Screen.Cursor:=crAppStart;
//    DateSeparator:='.';
//    DecimalSeparator:='.';
//
//    MySql:=' SELECT en.codfilial COD_LOJA, en.codproduto COD_ITEM,'+
//           ' CASE'+
//           '   WHEN ((TRIM(en.zonaendereco)='''') OR (en.zonaendereco=NULL)) THEN'+
//           '     ''0'''+
//           '   ELSE'+
//           '     en.zonaendereco'+
//           ' END zonaendereco,'+
//           ' CASE'+
//           '   WHEN ((TRIM(en.corredor)='''') OR (en.corredor=NULL)) THEN'+
//           '     ''000'''+
//           '   ELSE'+
//           '     en.corredor'+
//           ' END CORREDOR,'+
//           ' CASE'+
//           '   WHEN ((TRIM(en.prateleira)='''') OR (en.prateleira=NULL)) THEN'+
//           '     ''000'''+
//           '   ELSE'+
//           '     en.prateleira'+
//           ' END PRATELEIRA,'+
//           ' CASE'+
//           '   WHEN ((TRIM(en.gaveta)='''') OR (en.gaveta=NULL)) THEN'+
//           '     ''0000'''+
//           '   ELSE'+
//           '     en.gaveta'+
//           ' END GAVETA'+
//           ' FROM estoque en'+
//           ' WHERE en.codfilial='+QuotedStr(sCodLoja);
//    IBQ_MPMS.Close;
//    IBQ_MPMS.SQL.Clear;
//    IBQ_MPMS.SQL.Add(MySql);
//    IBQ_MPMS.Open;
//
//    If not IBQ_MPMS.IsEmpty Then
//    Begin
//      MySql:=' DELETE FROM PROD_ENDERECO pe'+
//             ' WHERE pe.cod_loja='+QuotedStr(sCodLoja);
//      DMBelShop.SQLC.Execute(MySql,nil,nil);
//
//      While not IBQ_MPMS.Eof do
//      Begin
//        MySql:=' INSERT INTO PROD_ENDERECO'+
//               ' (COD_LOJA, COD_ITEM, ZONAENDERECO, CORREDOR, PRATELEIRA, GAVETA)'+
//               ' Values('+
//               QuotedStr(IBQ_MPMS.FieldByName('COD_LOJA').AsString)+', '+
//               QuotedStr(IBQ_MPMS.FieldByName('COD_ITEM').AsString)+', '+
//               QuotedStr(IBQ_MPMS.FieldByName('ZONAENDERECO').AsString)+', '+
//               QuotedStr(IBQ_MPMS.FieldByName('CORREDOR').AsString)+', '+
//               QuotedStr(IBQ_MPMS.FieldByName('PRATELEIRA').AsString)+', '+
//               QuotedStr(IBQ_MPMS.FieldByName('GAVETA').AsString)+')';
//        DMBelShop.SQLC.Execute(MySql,nil,nil);
//
//        IBQ_MPMS.Next;
//      End;
//      DMBelShop.CDS_Busca.Close
//    End; // If not IBQ_MPMS.IsEmpty Then
//    IBQ_MPMS.Close;
//
//    // Atualiza Transacao =======================================
//    DMBelShop.SQLC.Commit(TD);
//
//    DateSeparator:='/';
//    DecimalSeparator:=',';
//    Screen.Cursor:=crDefault;
//
//  Except
//    on e : Exception do
//    Begin
//      // Abandona Transacao =====================================
//      DMBelShop.SQLC.Rollback(TD);
//
//      DateSeparator:='/';
//      DecimalSeparator:=',';
//      Screen.Cursor:=crDefault;
//
//      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
//      Exit;
//    End; // on e : Exception do
//  End; // Try
//End; // // Curva ABC - Endereamentos - Atualiza Enderecamento do CD >>>>>>>>>>>
// OdirApagar FIM - AtualizaProd_Endereco - 09/06/2017

// Ordem de Compra - Busca Curva ABC por Mix de Loja >>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.BuscaMixLoja(sLoja: String);
Var
  MySql: String;
Begin
  MySql:=' Select m.ind_curva_a, m.ind_curva_b, m.ind_curva_c, m.ind_curva_d, m.ind_curva_e'+
         ' From emp_mix_produtos m'+
         ' Where m.cod_loja='+QuotedStr(sLoja);
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  sgCurvas:='';

  If DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_A').AsString='SIM' Then
   sgCurvas:=QuotedStr('A');

  If DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_B').AsString='SIM' Then
  Begin
    If sgCurvas='' Then
     sgCurvas:=QuotedStr('B')
    Else
     sgCurvas:=sgCurvas+', '+QuotedStr('B');
  End;

  If DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_C').AsString='SIM' Then
  Begin
    If sgCurvas='' Then
     sgCurvas:=QuotedStr('C')
    Else
     sgCurvas:=sgCurvas+', '+QuotedStr('C');
  End;

  If DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_D').AsString='SIM' Then
  Begin
    If sgCurvas='' Then
     sgCurvas:=QuotedStr('D')
    Else
     sgCurvas:=sgCurvas+', '+QuotedStr('D');
  End;

  If DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_E').AsString='SIM' Then
  Begin
    If sgCurvas='' Then
     sgCurvas:=QuotedStr('E')
    Else
     sgCurvas:=sgCurvas+', '+QuotedStr('E');
  End;

  DMBelShop.CDS_BuscaRapida.Close;

End; // Ordem de Compra - Busca Curva ABC por Mix de Loja >>>>>>>>>>>>>>>>>>>>>>

// Giro de Estoque -  Busca Dados da Empresas para Giro de Estoque >>>>>>>>>>>>>
Procedure TFrmBelShop.DadosEmpGiroEstoque;
Var
  MySql, SqlVendas: String;
  sAnoMesInicio, sAnoMesFim: String;
  bSiga: Boolean;
  i: Integer;
  sDtI, sDtF: String;
  cVendas, cGiro: Currency;
Begin

  // Monta Ano Mes para CodAnoMes Tabela Estoques ==============================
  sAnoMesInicio:=Copy(sgDtaInicio,7,4)+ Copy(sgDtaInicio,4,2);
  sAnoMesFim   :=Copy(sgDtaFim,7,4)+ Copy(sgDtaFim,4,2);

  sDtI:=f_Troca('/','.',sgDtaInicio);
  sDtI:=f_Troca('-','.',sDtI);
  sDtF:=f_Troca('/','.',sgDtaFim);
  sDtF:=f_Troca('-','.',sDtF);

  // Monta Query Vendas do Periodo =============================================
  SqlVendas:=' SELECT sum(m.quant_ref) Vendas'+
             ' FROM MOVTOS_EMPRESAS m'+
             ' WHERE m.codfilial=:CodLoja'+
             ' AND m.codproduto=:CodProd'+
             ' AND m.dta_ref between '+QuotedStr(sDtI)+' and '+QuotedStr(sDtF);

             If Ckb_EstFisFinanGiroTransf.Checked Then
              SqlVendas:=SqlVendas+' AND m.ind_tipo in (''DM'', ''TS'')'
             Else
              SqlVendas:=SqlVendas+' AND m.ind_tipo='+QuotedStr('DM');

  // Processa Empresas =========================================================
  sgLojasNConectadas:='';
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sgCodEmp+' - '+
                                 DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Conecta Empresa =======================================================
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         Refresh;
         bSiga:=False;

         If sgLojasNConectadas='' Then
          sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
         Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
          sgLojasNConectadas:=
           sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then

      // Inicia Processamento ==================================================
      If bSiga Then // Empresa Conectada
      Begin
        // Cria Query da Empresa ------------------------------------
        CriaQueryIB('IBDB_'+sgCodEmp,'IBT_'+sgCodEmp,IBQ_ConsultaFilial, True, True);


        MySql:=' Select p.codproduto, Coalesce(p.classeabc,''C'') classeabc,'+
               ' Coalesce(estI.codanomesI, '+QuotedStr(sAnoMesInicio)+') CodAnoMesI,'+
               ' Cast(Round(Coalesce(estI.SaldoI,0),2) as Numeric(12,2)) SaldoI,'+
               ' Coalesce(estF.CodAnoMesF,'+QuotedStr(sAnoMesFim)+') CodAnoMesF,'+
               ' Cast(Round(Coalesce(estF.SaldoF,0),2) as Numeric(12,2)) SaldoF,'+
               ' Cast(Round(((Coalesce(estI.SaldoI,0)+Coalesce(estF.SaldoF,0))/2),2) as Numeric(12,2)) Est_Medio,'+
               ' Case Coalesce(p.situacaopro,0)'+
               '   when 0 Then ''Ativo'''+
               '   when 3 Then ''No Compra'''+
               ' End SituacaoPro'+

               ' From PRODUTO p'+
               '  Left Join (Select es.codproduto, es.codanomes codanomesI,'+
               '                    COALESCE(es.saldoatual,0) SaldoI'+
               '             From estoqmes es'+
               '             Where es.codanomes='+QuotedStr(sAnoMesInicio)+
               '             And es.codfilial='+QuotedStr(sgCodEmp)+') EstI'+
               '       on estI.codproduto=p.codproduto'+

               '  Left Join (Select es.codproduto, es.codanomes codanomesF,'+
               '                    COALESCE(es.saldoatual,0) SaldoF'+
               '            From estoqmes es'+
               '            Where es.codanomes='+QuotedStr(sAnoMesFim)+
               '            And es.codfilial='+QuotedStr(sgCodEmp)+') EstF'+
               '       on estF.codproduto=p.codproduto';

               // Situacao dos Produtos -----------------------------
               If Cbx_EstFisFinanSituacaoProd.ItemIndex=0 Then
                MySql:=MySql+' Where Coalesce(p.situacaopro,0)=0';

               If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then
                MySql:=MySql+' Where Coalesce(p.situacaopro,3)=3';

               If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then
                MySql:=MySql+' Where Coalesce(p.situacaopro,0) in (0,3)';

               // Curva ABC dos Produtos ----------------------------------
               If Trim(sgCurvas)<>'' Then
                MySql:=MySql+' and p.classeabc in ('+sgCurvas+')';

               // Produtos Codigos e/ou Produtos Like ---------------------
               If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                MySql:=
                 MySql+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.',sgLikeProdutos)+')'
               Else If Trim(sgProdutos)<>'' Then
                MySql:=
                 MySql+' AND p.CodProduto in ('+sgProdutos+')'
               Else If Trim(sgLikeProdutos)<>'' Then
                MySql:=
                 MySql+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

               // Fornecedores -------------------------------------
               If Trim(sgFornecedores)<>'' Then
                MySql:=MySql+' and p.principalfor in ('+sgFornecedores+')';

               // Grupos e SubGrupos --------------------------------
               If Trim(sgGrupos)<>'' Then
                MySql:=MySql+' and '+sgGrupos;

               MySql:=MySql+' order by p.codproduto';
        IBQ_ConsultaFilial.Close;
        IBQ_ConsultaFilial.SQL.Clear;
        IBQ_ConsultaFilial.SQL.Add(MySql);

        // Abre Query ---------------------------------------------
        i:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            IBQ_ConsultaFilial.Open;
            bSiga:=True;
          Except
            Inc(i);
          End; // Try

          If i>10 Then
          Begin
            IBQ_ConsultaFilial.Close;

            If sgLojasNConectadas='' Then 
             sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
            Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
             sgLojasNConectadas:=
              sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
          End; // If i>10 Then
        End; // While Not bSiga do

        // Processamento =======================================================
        If bSiga Then // Query Executada
        Begin
          While Not IBQ_ConsultaFilial.Eof do
          Begin
            Refresh;

            If DMVirtual.CDS_V_GiroEstoque.Locate('LOJA_PESQUISA;PROD_PESQUISA', VarArrayOf([sgCodEmp,Trim(IBQ_ConsultaFilial.FieldByName('CodProduto').AsString)]),[]) Then
            Begin
              // Vendas =================================================
              DMBelShop.SDS_BuscaRapida.Close;
              DMBelShop.SDS_BuscaRapida.CommandText:=SqlVendas;
              DMBelShop.SDS_BuscaRapida.Params.ParamByName('CodLoja').Value:=sgCodEmp;
              DMBelShop.SDS_BuscaRapida.Params.ParamByName('CodProd').Value:=
                          IBQ_ConsultaFilial.FieldByName('codproduto').AsString;
              DMBelShop.SDS_BuscaRapida.Open;
              cVendas:=0;
              If Trim(DMBelShop.SDS_BuscaRapida.FieldByName('Vendas').AsString)<>'' Then
               cVendas:=DMBelShop.SDS_BuscaRapida.FieldByName('Vendas').CurValue;
              DMBelShop.SDS_BuscaRapida.Open;

              // Atualiza Produto da Empresa ===================================
              DMVirtual.CDS_V_GiroEstoque.Edit;

              MySql:=' SELECT coalesce(c.ind_curva,''E'') Curva'+
                     ' FROM ES_FINAN_CURVA_ABC c'+
                     ' WHERE c.cod_produto='+QuotedStr(IBQ_ConsultaFilial.FieldByName('codproduto').AsString)+
                     ' AND   c.cod_loja='+QuotedStr(sgCodEmp);
              DMBelShop.CDS_Busca1.Close;
              DMBelShop.SDS_Busca1.CommandText:=MySql;
              DMBelShop.CDS_Busca1.Open;
              DMVirtual.CDS_V_GiroEstoqueIND_CURVA.AsString:=
                             DMBelShop.CDS_Busca1.FieldByName('Curva').AsString;
              DMBelShop.CDS_Busca1.Close;

              DMVirtual.CDS_V_GiroEstoqueIND_SITUACAO.AsString:=
                         IBQ_ConsultaFilial.FieldByName('SituacaoPro').AsString;
              DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency:=
                            IBQ_ConsultaFilial.FieldByName('SaldoI').AsCurrency;
              DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency:=
                            IBQ_ConsultaFilial.FieldByName('SaldoF').AsCurrency;
              DMVirtual.CDS_V_GiroEstoqueMEDIA_ESTOQUE.AsCurrency:=
                         IBQ_ConsultaFilial.FieldByName('Est_Medio').AsCurrency;

              DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency:=cVendas;

              // Calcula Giro de Estoque e Tempo Medio =========================
              If IBQ_ConsultaFilial.FieldByName('Est_Medio').AsCurrency<>0 Then
              Begin
                cGiro:=RoundTo((cVendas/IBQ_ConsultaFilial.FieldByName('Est_Medio').AsCurrency),-2);
                DMVirtual.CDS_V_GiroEstoqueGIRO_ESTOQUE.AsCurrency:=cGiro;

                // Calcula Tempo Medio do Giro de Estoque =================
                If cGiro<>0 Then
                Begin
                  i:=DaysBetween(StrToDate(sgDtaInicio), StrToDate(sgDtaFim));
                  DMVirtual.CDS_V_GiroEstoqueTEMPO_MEDIO.AsCurrency:=RoundTo((i/cGiro),-2);
                End; // If IBQ_ConsultaFilial.FieldByName('Est_Medio').AsCurrency<>0 Then
                DMVirtual.CDS_V_GiroEstoque.Post;
              End; // If IBQ_ConsultaFilial.FieldByName('Est_Medio').AsCurrency<>0 Then

            End; // If DMVirtual.CDS_V_GiroEstoque.Locate('LOJA_PESQUISA;PROD_PESQUISA', VarArrayOf([sgCodEmp,IBQ_ConsultaFilial.FieldByName('codproduto').AsString]),[]) Then

            IBQ_ConsultaFilial.Next;
          End; // While Not IBQ_ConsultaFilial.Eof do
        End; // If bSiga Then // Query Executada
      End; //If bSiga Then // Empresa Conectada

      // Apresenta o Processamento ------------------------------------
      OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
      Refresh;

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  // Limpa Produtos no Encontrados nas Empresas ===============================

  // Apresenta Lojas No Conectadas ============================================
  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

End; // Giro de Estoque -  Busca Dados da Empresas para Giro de Estoque >>>>>>>>

// Auditoria - Monta Sql de Compras e Vendas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AuditoriaMontaSQLCompVend(sTp: String; IBQ: TIBQuery);
Var
  sL1, sL2, sL3, sL4: TStringList;
Begin

  sL1:=TStringList.Create;
  sL2:=TStringList.Create;
  sL3:=TStringList.Create;
  sL4:=TStringList.Create; // Entradas

  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Compras ===================================================================
  If sTp='C' Then
  Begin
    sL1.Text:=' SELECT ''Bel_''||m.CODFILIAL Cod_Loja, pr.CODPRODUTO, pr.apresentacao Desc_Produto,'+
              ' CASE Coalesce(pr.situacaopro,0)'+
              '   WHEN 0 THEN ''Ativo'''+
              '   WHEN 1 THEN ''Bloqueado'''+
              '   WHEN 2 THEN ''Excluido'''+
              '   WHEN 3 THEN ''No Compra'''+
              '   WHEN 4 THEN ''No Venda'''+
              ' END situacaopro,'+
              ' Coalesce(pr.codmercosulncm,'''') NCM,'+
              ' cast(Coalesce(m.CODFISCAL,0) as integer) codfiscal,'+
              ' Cast(Coalesce(p.CODFISCALPRO,0) as integer) codfiscalpro,'+
              ' CASE p.ENTRADASAIDA   WHEN ''E'' THEN ''COMPRA''   ELSE ''VENDA'' END COMPRA_VENDA,'+
              ' '''' NAOSOMAESTOQUE, '''' SOMOUESTOQUE,'+
              ' SUM(Coalesce(p.QUANT,0)) QUANTIDADE,'+
              ' SUM(Coalesce(p.VALBRUTO,0)) Vlr_Bruto,'+
              ' SUM(Coalesce(p.DESCONTO1,0)+Coalesce(p.DESCONTO2,0)+Coalesce(p.DESCONTO3,0)+Coalesce(p.DESCONTO4,0)) Per_Desconto,'+
              ' SUM(Coalesce(p.VALDESCONTO,0)) Vlr_DESC_ITEM,'+
              ' 0.00 VLR_DESCONTO_RS,'+
              // --===== Despesas
              ' CASE p.SOMADESPESABASEICM   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMADESPESABASEICM,'+
              ' CASE p.SOMADESPESABASEIPI   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMADESPESABASEIPI,'+
              ' CASE p.SOMADESPESABASEST    WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMADESPESABASEST,'+
              ' SUM(Coalesce(p.VALDESPESAS,0)) Vlr_DESPESAS,'+
              // --===== Valor Total
              ' SUM(Coalesce(p.VALTOTAL,0)) Vlr_TOTAL,'+
              ' SUM(Coalesce(p.VALARREDONDA,0)) Vlr_ARREDONDA,'+
              // --===== ICMS
              ' '''' RS_ICM_SN,'+
              ' CASE m.ISENTOICM   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_ICM,'+
              ' Coalesce(p.CST_ICMS,'''') CST_ICMS,'+
              ' SUM(Coalesce(p.VALBASEICM,0)) Vlr_BASEICM,'+
              ' 0.00 ALIQICMORIGEM,'+
              ' Coalesce(p.ALIQICM,0) ALIQICM,'+
              ' SUM(Coalesce(p.VALICM,0)) Vlr_ICM,'+
              ' Coalesce(p.ALIQICMREDUCAO,0) ALIQICMREDUCAO,'+
              ' SUM(Coalesce(p.VALREDUCAOICM,0)) Vlr_REDUCAOICM,'+
              ' SUM(Coalesce(p.VALISENTOICM,0)) Vlr_ISENTOICM,'+
              ' SUM(Coalesce(p.VALOUTROSICM,0)) Vlr_OUTROSICM,';

              // --====>> IPI
    sL2.Text:=' CASE m.ISENTOIPI        WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_IPI, '+
              ' CASE p.SOMAIPIBASEICM   WHEN ''S'' THEN ''SIM''   ELSE ''NO'' END SOMAIPIBASEICM,'+
              ' CASE p.SOMAIPIBASESUBST WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAIPIBASESUBST,'+
              ' '''' IPI_PERC_OU_VALOR,'+
              ' CASE p.IPISOMATOTAL_SN  WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END IPISOMATOTAL_SN,'+
              ' Coalesce(p.CST_IPI,'''') CST_IPI,'+
              ' SUM(Coalesce(p.VALBASEIPI,0)) Vlr_BASEIPI,'+
              ' Coalesce(p.ALIQIPI,0) ALIQIPI,'+
              ' SUM(Coalesce(p.VALIPI,0)) Vlr_IPI,'+
              ' SUM(Coalesce(p.VALISENTOIPI,0)) Vlr_ISENTOIPI,'+
              ' SUM(Coalesce(p.VALOUTROSIPI,0)) Vlr_OUTROSIPI,'+
              ' SUM(Coalesce(p.IPIREDUCAO,0)) IPIREDUCAO,'+
              // --===== ST
              ' CASE p.SUBSTITUICAOSN   WHEN ''S'' THEN ''SIM''   ELSE ''NO'' END SUBSTITUICAO_S_N,'+
              ' CASE m.ISENTOSUBST      WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_SUBST,'+
              ' '''' SOMASTBASEPISCOFINS, '''' SUBST_VAL_PER,'+
              ' Coalesce(p.SUBSTMARGEM,0) SUBSTMARGEM,'+
              ' SUM(Coalesce(p.VALBASESUBST,0)) Vlr_BASESUBST,'+
              ' Coalesce(p.SUBSTALIQ,0) SUBSTALIQ,'+
              ' SUM(Coalesce(p.VALSUBSTITUICAO,0)) Vlr_SUBSTITUICAO,'+
              ' SUM(Coalesce(p.SUBSTDESCONTO,0)) SUBSTDESCONTO,'+
              // --===== Pis Cofins
              ' CASE m.ISENTOPISCOFINS   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_PISCOFINS,'+
              ' SUM(Coalesce(p.VALBASEPISCOFINS,0)) Vlr_BASEPISCOFINS,'+
              ' Coalesce(p.CST_PIS,'''') CST_PIS,'+
              ' Coalesce(p.ALIQPIS,0) ALIQPIS,'+
              ' SUM(Coalesce(p.VALPIS,0)) Vlr_PIS,'+
              ' Coalesce(p.CST_COFINS,'''') CST_COFINS,'+
              ' Coalesce(p.ALIQCOFINS,0) ALIQCOFINS,'+
              ' SUM(Coalesce(p.VALCOFINS,0)) Vlr_COFINS,'+
              ' SUM(Coalesce(p.VALBASEPIS_ST,0)) Vlr_BASEPIS_ST,'+
              ' Coalesce(p.MARGEM_PIS,0) MARGEM_PIS,'+
              ' SUM(Coalesce(p.VALPIS_ST,0)) Vlr_PIS_ST,'+
              ' SUM(Coalesce(p.VALBASECOFINS_ST,0)) Vlr_BASECOFINS_ST,'+
              ' Coalesce(p.MARGEM_COFINS,0) MARGEM_COFINS,'+
              ' SUM(Coalesce(p.VALCOFINS_ST,0)) Vlr_COFINS_ST,';

              // --===== Repasse
    sL3.Text:=' Coalesce(p.ALIQREPASSE,0) ALIQREPASSE,'+
              ' SUM(Coalesce(p.VALREPASSE,0)) VLR_REPASSE,'+
              // --===== Frete
              ' CASE p.SOMAFRETEBASEICM WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAFRETEBASEICM,'+
              ' CASE p.SOMAFRETEBASEIPI WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAFRETEBASEIPI,'+
              ' CASE p.SOMAFRETEBASEST  WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAFRETEBASEST,'+
              ' 0.00 VLR_FRETE,'+
              ' SUM(Coalesce(p.VALFRETEINCLUSO,0)) Vlr_FRETE_INCLUSO,'+
              ' SUM(Coalesce(p.VALFRETENAO,0)) Vlr_FRETENAO,'+
              ' SUM(Coalesce(p.VALSEGURO,0)) Vlr_SEGURO,'+
              // --===== ISS
              ' Coalesce(p.ALIQISS,0) ALIQISS,'+
              ' SUM(Coalesce(p.VALISS,0)) Vlr_ISS,'+
              // --===== Importacao
              ' SUM(Coalesce(p.VALBASEII,0)) Vlr_BASEII,'+
              ' Coalesce(p.ALIQII,0) ALIQII,'+
              ' SUM(Coalesce(p.VALII,0)) Vlr_II,'+
              // --===== Bonificao
              ' SUM(Coalesce(p.VALBONIFICADO,0)) Vlr_BONIFICADO,'+
              ' SUM(Coalesce(p.COMP_VALTOTBONIFICADO,0)) COMP_VALTOTBONIFICADO,'+
              // --===== SIMPLES ESTADUAL
              ' '''' SIMPLESESTADUAL'+

              ' FROM mfor m, mforpro p, produto pr'+
              ' WHERE m.chavenf=p.chavenf'+
              ' AND   p.codproduto=pr.codproduto'+
              ' AND   m.codcomprovante IN (''010'', ''012'')'+
              ' AND   p.entradasaida = ''E''';

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL4.Text:=' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL4.Text:=' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL4.Text:=' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL4.Text:=sL4.Text+' and pr.principalfor in ('+sgFornecedores+')';

    sL4.Text:=
     sL4.Text+' AND   m.dataentrada Between '+QuotedStr(sgDtaInicio)+' and '+QuotedStr(sgDtaFim)+
              ' AND   m.codfilial = '+QuotedStr(sgCodEmp)+

              ' GROUP BY 1,2,3,4,5,6,7,8,16,17,18,23,24,27,29,33,34,35,37,38,40,45,46,49,51,54,56,57,59,60,63,66,68,70,71,72,77,80';
  End; // If sTp='C' Then

  // Vendas ====================================================================
  If sTp='V' Then
  Begin
    sL1.Text:=' SELECT ''Bel_''||m.codfilial Cod_Loja, pr.codproduto, pr.apresentacao Desc_Produto,'+
              ' CASE Coalesce(pr.situacaopro,0)'+
              '   WHEN 0 THEN ''Ativo'''+
              '   WHEN 1 THEN ''Bloqueado'''+
              '   WHEN 2 THEN ''Excluido'''+
              '   WHEN 3 THEN ''No Compra'''+
              '   WHEN 4 THEN ''No Venda'''+
              ' END situacaopro,'+
              ' COALESCE(pr.codmercosulncm,'''') NCM,'+
              ' CAST(COALESCE(m.codfiscal,0) AS INTEGER) codfiscal,'+
              ' CAST(COALESCE(mp.codfiscalpro,0) AS INTEGER) codfiscalpro,'+
              ' CASE mp.ENTRADASAIDA   WHEN ''E'' THEN ''COMPRA''   ELSE ''VENDA'' END COMPRA_VENDA,'+
              ' CASE m.NAOSOMAESTOQUE  WHEN ''N'' THEN ''NO''   ELSE ''SIM''END NAOSOMAESTOQUE,'+
              ' CASE mp.SOMOUESTOQUE   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMOUESTOQUE,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.quantatendida,0),''007'','+
              '                                                                  CASE WHEN COALESCE(mp.quantatendida,0)>0 THEN -mp.quantatendida'+
              '                                                                       ELSE COALESCE(mp.quantatendida,0) END)) QUANTIDADE,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALBRUTO,0),''007'','+
              '                                                             CASE WHEN COALESCE(mp.VALBRUTO,0)>0 THEN -mp.VALBRUTO'+
              '                                                                  ELSE COALESCE(mp.VALBRUTO,0) END)) Vlr_BRUTO,'+
              ' SUM(COALESCE(mp.DESCONTO1,0)+COALESCE(mp.DESCONTO2,0)+COALESCE(mp.DESCONTO3,0)+COALESCE(mp.DESCONTO4,0)) Per_Desconto,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALDESCITEM,0),''007'','+
              '                                                                CASE WHEN COALESCE(mp.VALDESCITEM,0)>0 THEN -mp.VALDESCITEM'+
              '                                                                    ELSE COALESCE(mp.VALDESCITEM,0) END)) Vlr_DESC_ITEM,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALDESCONTORS,0),''007'','+
              '                                                                  CASE WHEN COALESCE(mp.VALDESCONTORS,0)>0 THEN -mp.VALDESCONTORS'+
              '                                                                       ELSE COALESCE(mp.VALDESCONTORS,0) END)) Vlr_DESCONTO_RS,'+
              // --===== Despesas
              ' CASE mp.SOMADESPESABASEICM WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMADESPESABASEICM,'+
              ' CASE mp.SOMADESPESABASEIPI WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMADESPESABASEIPI,'+
              ' CASE mp.SOMADESPESABASEST  WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMADESPESABASEST,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALDESPESAS,0),''007'','+
              '                                                                CASE WHEN COALESCE(mp.VALDESPESAS,0)>0 THEN -mp.VALDESPESAS'+
              '                                                                     ELSE COALESCE(mp.VALDESPESAS,0) END)) Vlr_DESPESAS,'+
              // --===== Valor Total
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALTOTAL,0),''007'','+
              '                                                             CASE WHEN COALESCE(mp.VALTOTAL,0)>0 THEN -mp.VALTOTAL'+
              '                                                                  ELSE COALESCE(mp.VALTOTAL,0) END)) Vlr_TOTAL,'+
              ' 0.00 VLR_ARREDONDA,'+
              // --===== ICMS
              ' CASE m.RSICMSN   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END RS_ICM_SN,'+
              ' CASE m.ISENTOICM WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_ICM,'+
              ' COALESCE(mp.CST_ICMS,'''') CST_ICMS,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALBASEICM,0),''007'','+
              '                                                               CASE WHEN COALESCE(mp.VALBASEICM,0)>0 THEN -mp.VALBASEICM'+
              '                                                                    ELSE COALESCE(mp.VALBASEICM,0) END)) Vlr_BASEICM,'+
              ' COALESCE(mp.ALIQICMORIGEM,0) ALIQICMORIGEM,'+
              ' COALESCE(mp.ALIQICM,0) ALIQICM,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALICM,0),''007'','+
              '                                                           CASE WHEN COALESCE(mp.VALICM,0)>0 THEN -mp.VALICM'+
              '                                                                ELSE COALESCE(mp.VALICM,0) END)) Vlr_ICM,'+
              ' COALESCE(mp.ALIQICMREDUCAO,0) ALIQICMREDUCAO,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALREDUCAOICM,0),''007'','+
              '                                                                  CASE WHEN COALESCE(mp.VALREDUCAOICM,0)>0 THEN -mp.VALREDUCAOICM'+
              '                                                                       ELSE COALESCE(mp.VALREDUCAOICM,0) END)) Vlr_REDUCAOICM,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALISENTOICM,0),''007'','+
              '                                                                 CASE WHEN COALESCE(mp.VALISENTOICM,0)>0 THEN -mp.VALISENTOICM'+
              '                                                                      ELSE COALESCE(mp.VALISENTOICM,0) END)) Vlr_ISENTOICM,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALOUTROSICM,0),''007'','+
              '                                                                 CASE WHEN COALESCE(mp.VALOUTROSICM,0)>0 THEN -mp.VALOUTROSICM'+
              '                                                                      ELSE COALESCE(mp.VALOUTROSICM,0) END)) Vlr_OUTROSICM,';

              // --===== IPI
    sL2.Text:=' CASE m.ISENTOIPI         WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_IPI,'+
              ' CASE mp.SOMAIPIBASEICM   WHEN ''S'' THEN ''SIM''   ELSE ''NO'' END SOMAIPIBASEICM,'+
              ' CASE mp.SOMAIPIBASESUBST WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAIPIBASESUBST,'+
              ' COALESCE(mp.IPIPERCOUVALOR,'''') IPI_PERC_OU_VALOR,'+
              ' '''' IPISOMATOTAL_SN,'+
              ' COALESCE(mp.CST_IPI,'''') CST_IPI,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALBASEIPI,0),''007'','+
              '                                                               CASE WHEN COALESCE(mp.VALBASEIPI,0)>0 THEN -mp.VALBASEIPI'+
              '                                                                    ELSE COALESCE(mp.VALBASEIPI,0) END)) Vlr_BASEIPI,'+
              ' COALESCE(mp.ALIQIPI,0) ALIQIPI,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALIPI,0),''007'','+
              '                                                           CASE WHEN COALESCE(mp.VALIPI,0)>0 THEN -mp.VALIPI'+
              '                                                                ELSE COALESCE(mp.VALIPI,0) END)) Vlr_IPI,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALISENTOIPI,0),''007'','+
              '                                                                 CASE WHEN COALESCE(mp.VALISENTOIPI,0)>0 THEN -mp.VALISENTOIPI'+
              '                                                                      ELSE COALESCE(mp.VALISENTOIPI,0) END)) Vlr_ISENTOIPI,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALOUTROSIPI,0),''007'','+
              '                                                                 CASE WHEN COALESCE(mp.VALOUTROSIPI,0)>0 THEN -mp.VALOUTROSIPI'+
              '                                                                      ELSE COALESCE(mp.VALOUTROSIPI,0) END)) Vlr_OUTROSIPI,'+
              ' 0.00 IPIREDUCAO,'+
              // --===== ST
              ' CASE mp.SUBSTITUICAOSN      WHEN ''S'' THEN ''SIM''   ELSE ''NO'' END SUBSTITUICAO_S_N,'+
              ' CASE m.ISENTOSUBST          WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_SUBST,'+
              ' CASE mp.SOMASTBASEPISCOFINS WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMASTBASEPISCOFINS,'+
              ' COALESCE(mp.SUBSTVALPER,'''') SUBST_VAL_PER,'+
              ' COALESCE(mp.SUBSTMARGEM,0) SUBSTMARGEM,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALBASESUBST,0),''007'','+
              '                                                                 CASE WHEN COALESCE(mp.VALBASESUBST,0)>0 THEN -mp.VALBASESUBST'+
              '                                                                      ELSE COALESCE(mp.VALBASESUBST,0) END)) Vlr_BASESUBST,'+
              ' COALESCE(mp.SUBSTALIQ,0) SUBSTALIQ,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALSUBSTITUICAO,0),''007'','+
              '                                                                    CASE WHEN COALESCE(mp.VALSUBSTITUICAO,0)>0 THEN -mp.VALSUBSTITUICAO'+
              '                                                                         ELSE COALESCE(mp.VALSUBSTITUICAO,0) END)) Vlr_SUBSTITUICAO,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.SUBSTDESCONTO,0),''007'','+
              '                                                                  CASE WHEN COALESCE(mp.SUBSTDESCONTO,0)>0 THEN -mp.SUBSTDESCONTO'+
              '                                                                       ELSE COALESCE(mp.SUBSTDESCONTO,0) END)) SUBSTDESCONTO,'+
              // --===== PisCofins
              ' CASE m.ISENTOPISCOFINS   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END ISENTO_PISCOFINS,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALBASEPISCOFINS,0),''007'','+
              '                                                                     CASE WHEN COALESCE(mp.VALBASEPISCOFINS,0)>0 THEN -mp.VALBASEPISCOFINS'+
              '                                                                          ELSE COALESCE(mp.VALBASEPISCOFINS,0) END)) Vlr_BASEPISCOFINS,'+
              ' COALESCE(mp.CST_PIS,'''') CST_PIS,'+
              ' COALESCE(mp.ALIQPIS,0) ALIQPIS,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALPIS,0),''007'','+
              '                                                           CASE WHEN COALESCE(mp.VALPIS,0)>0 THEN -mp.VALPIS'+
              '                                                                ELSE COALESCE(mp.VALPIS,0) END)) Vlr_PIS,'+
              ' COALESCE(mp.CST_COFINS,'''') CST_COFINS,'+
              ' COALESCE(mp.ALIQCOFINS,0) ALIQCOFINS,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALCOFINS,0),''007'','+
              '                                                              CASE WHEN COALESCE(mp.VALCOFINS,0)>0 THEN -mp.VALCOFINS'+
              '                                                                   ELSE COALESCE(mp.VALCOFINS,0) END)) Vlr_COFINS,'+
              ' 0.00 Vlr_BASEPIS_ST,'+
              ' 0.00 MARGEM_PIS,'+
              ' 0.00 Vlr_PIS_ST,'+
              ' 0.00 Vlr_BASECOFINS_ST,'+
              ' 0.00 MARGEM_COFINS,'+
              ' 0.00 Vlr_COFINS_ST,';

              // --===== Repasse
    sL3.Text:=' COALESCE(mp.ALIQREPASSE,0) ALIQREPASSE,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALREPASSE,0),''007'','+
              '                                                               CASE WHEN COALESCE(mp.VALREPASSE,0)>0 THEN -mp.VALREPASSE'+
              '                                                                    ELSE COALESCE(mp.VALREPASSE,0) END)) Vlr_REPASSE,'+
              // --===== Frete
              ' CASE mp.SOMAFRETEBASEICM   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAFRETEBASEICM,'+
              ' CASE mp.SOMAFRETEBASEIPI   WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAFRETEBASEIPI,'+
              ' CASE mp.SOMAFRETEBASEST    WHEN ''N'' THEN ''NO''   ELSE ''SIM'' END SOMAFRETEBASEST,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALFRETE,0),''007'','+
              '                                                             CASE WHEN COALESCE(mp.VALFRETE,0)>0 THEN -mp.VALFRETE'+
              '                                                                  ELSE COALESCE(mp.VALFRETE,0) END)) Vlr_FRETE,'+
              ' 0.00 Vlr_FRETE_INCLUSO,'+
              ' 0.00 Vlr_FRETENAO,'+
              ' 0.00 Vlr_SEGURO,'+
              // --===== ISS
              ' COALESCE(mp.ALIQISS,0) ALIQISS,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALISS,0),''007'','+
              '                                                           CASE WHEN COALESCE(mp.VALISS,0)>0 THEN -mp.VALISS'+
              '                                                                ELSE COALESCE(mp.VALISS,0) END)) Vlr_ISS,'+
              // --===== Importacao
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALBASEII,0),''007'','+
              '                                                              CASE WHEN COALESCE(mp.VALBASEII,0)>0 THEN -mp.VALBASEII'+
              '                                                                   ELSE COALESCE(mp.VALBASEII,0) END)) Vlr_BASEII,'+
              ' COALESCE(mp.ALIQII,0) ALIQII,'+
              ' SUM(decode(m.codcomprovante,''002'',COALESCE(mp.VALII,0),''007'','+
              '                                                          CASE WHEN COALESCE(mp.VALII,0)>0 THEN -mp.VALII'+
              '                                                               ELSE COALESCE(mp.VALII,0) END)) Vlr_II,'+
              // --===== Bonificao
              ' 0.00 Vlr_BONIFICADO,'+
              ' 0.00 COMP_VALTOTBONIFICADO,'+
              // --===== SIMPLES ESTADUAL
              ' CASE m.SIMPLESESTADUAL   WHEN 0 THEN ''NO''   ELSE ''SIM'' END SIMPLESESTADUAL'+
        
              ' FROM MCLI m, MCLIPRO mp, PRODUTO pr'+
              ' WHERE m.chavenf=mp.chavenf'+
              ' AND   mp.codproduto=pr.codproduto'+
              ' AND   m.codcomprovante IN (''002'',''007'')';

              // Produtos Codigos e/ou Produtos Like ---------------------
              If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
               sL4.Text:=' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
              Else If Trim(sgProdutos)<>'' Then
               sL4.Text:=' AND pr.CodProduto in ('+sgProdutos+')'
              Else If Trim(sgLikeProdutos)<>'' Then
               sL4.Text:=' AND '+sgLikeProdutos;

              // Fornecedores --------------------------------------------
              If Trim(sgFornecedores)<>'' Then
               sL4.Text:=sL4.Text+' and pr.principalfor in ('+sgFornecedores+')';

    sL4.Text:=
     sL4.Text+' AND   m.codfilial = '+QuotedStr(sgCodEmp)+
              ' AND   m.datacomprovante Between '+QuotedStr(sgDtaInicio)+' and '+QuotedStr(sgDtaFim)+

              ' GROUP BY 1,2,3,4,5,6,7,8,9,10,16,17,18,22,23,24,26,27,29,33,34,35,36,38,40,45,46,47,48,49,51,54,56,57,59,60,68,70,71,72,77,80,84';
  End; // If sTp='V' Then

  IBQ.SQL.Clear;
  IBQ.SQL.Add('Select Count(total.Cod_Loja) TotReg'+
              ' From ('+sL1.Text+sL2.Text+sL3.Text+sL4.Text+
              ') Total');
  IBQ.Open;

  Try
   iNrRegistros:=IBQ.FieldByName('TotReg').AsInteger;
  Except
   iNrRegistros:=0;
  End;
  IBQ.Close;

  IBQ.SQL.Clear;
  IBQ.SQL.Add(sL1.Text+sL2.Text+sL3.Text+sL4.Text);

  FreeAndNil(sL1);
  FreeAndNil(sL2);
  FreeAndNil(sL3);
  FreeAndNil(sL4);

End; // Auditoria - Monta Sql de Compras e Vendas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Auditoria - Apresenta Auditorias para Analise >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AuditoriaAnalise(sClausula: String);
Var
  MySql: String;
Begin
  sgDtaInicio:=DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  MySql:=' Select au.cod_loja, em.razao_social, au.dta_auditoria,'+
         ' au.per_admissivel, au.vlr_admiss_equivalente,'+
         ' au.per_perda_final, au.vlr_perda_equivalente,'+
         ' au.per_obj_per_admissivel,'+
         ' au.per_obj_vlr_admissivel,'+
         ' Case'+
         '   When (au.per_perda_final<-0.80) or (au.per_perda_final>0.80) Then'+
         '   ''V'''+
         '   Else'+
         '   ''A'''+
         ' end CorPer'+

         ' From AUDITORIAS au, EMP_CONEXOES em'+

         ' Where au.cod_loja=em.cod_filial'+
         ' and ('+sClausula+')'+

         ' UNION'+

         ' Select 999 cod_loja, ''TOTAL EMPRESA'' razao_social, Cast('+QuotedStr(sgDtaInicio)+' as Date) dta_auditoria,'+
         ' (Sum(au.per_admissivel)/Count(au.cod_loja)) per_admissivel,'+
         ' (Sum(au.vlr_admiss_equivalente)) vlr_admiss_equivalente,'+
         ' Cast((Round(((Sum(au.vlr_perda_equivalente)*100)/Sum(au.vlr_est_inicial)),2)) as Numeric(12,2)) per_perda_final,'+
         ' (Sum(au.vlr_perda_equivalente)) vlr_perda_equivalente,'+
         ' Cast((Round(((Round(((Sum(au.vlr_perda_equivalente)*100)/Sum(au.vlr_est_inicial)),2))*100)/'+
         '             (Sum(au.per_admissivel)/Count(au.cod_loja)),2)) as Numeric(12,2)) per_obj_per_admissivel,'+
         ' Cast((Round((Sum(au.vlr_perda_equivalente))*100/(Sum(au.vlr_admiss_equivalente)),2)) as Numeric(12,2)) per_obj_vlr_admissivel,'+
         ' Case'+
         '   When ((Round(((Sum(au.vlr_perda_equivalente)*100)/Sum(au.vlr_est_inicial)),2))<-0.80) or ((Round(((Sum(au.vlr_perda_equivalente)*100)/Sum(au.vlr_est_inicial)),2))>0.80) Then'+
         '   ''V'''+
         '   Else'+
         '   ''A'''+
         ' end CorPer'+

         ' From auditorias au, emp_conexoes em'+

         ' where au.cod_loja=em.cod_filial'+
         ' and ('+sClausula+')'+

         ' Group by 1,2,3'+
         ' order by 1, 3';
  DMBelShop.CDS_AuditoriaAnalise.Close;
  DMBelShop.SDS_AuditoriaAnalise.CommandText:=MySql;
  DMBelShop.CDS_AuditoriaAnalise.Open;
  
End; // Auditoria - Apresenta Auditorias para Analise >>>>>>>>>>>>>>>>>>>>>>>>>>

// Objetivos/Metas - Habilita / Desabilita LInha >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.HabilitaDesabilitaLinha(CDS: TClientDataSet;sCol1, sConteudoCol1: String; bHabilita: Boolean=True);
Begin

  While Not CDS.Eof do
  Begin
    Refresh;

    If CDS.FieldByName(sCol1).AsString=sConteudoCol1 Then
    Begin
      CDS.Edit;
      
      If bHabilita Then
       CDS.FieldByName('VISIVEL').AsString:='S'
      Else
       CDS.FieldByName('VISIVEL').AsString:='N';
       
      CDS.Post;
    End;
    
    CDS.Next;
  End; // While Not CDS.Eof do
  CDS.First;
  
End; // Objetivos/Metas - Habilita / Desabilita LInha >>>>>>>>>>>>>>>>>>>>>>>>>>

// BUSCA MOVTOS DE COMPROVANTES- Antigo: NOTAS FISCAIS DE ENTRADA //////////
Function TFrmBelShop.BuscaMovtosComprov: Boolean; // Antigo ApresentaNFe: Boolean;
Var
  MySql, MySqlProd,
  sFiltroEnt, MySqlEnt, sWhereEnt,
  sFiltroSai, MySqlSai, sWhereSai,
  sProdEnt, sProdSai: String;

  sDti, sDtf: String;
  cVlrEmpresa, cVlrLoja,
  cQtdsEmpresa, cQtdsLoja: Currency;

  iItensEmpresa, iItensLoja: Integer;
  iTotNFeEmpresa, iTotNFeLoja: Integer;
  i, iCodForn, iOrdem: Integer;

  bSiga: Boolean;
  sComprov: String;

  CDS_: TClientDataSet;
Begin
  Result:=True;

  sgLojasNConectadas:='';
  DMVirtual.bgNFeProdutos:=True; // Se Executa o Evento: TDMVirtual.CDS_V_NFeProdutosAfterScroll(DataSet: TDataSet);

  // Seleciona Empresa =========================================================
  sgOutrasEmpresa:='(50,99)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;
  FrmSelectEmpProcessamento.iNrEmpProc:=0;
  FrmSelectEmpProcessamento.ShowModal;

  // Verifica se Existe Empresa a Processar ====================================
  If FrmSelectEmpProcessamento.iNrEmpProc=0 Then
  Begin
    FreeAndNil(FrmSelectEmpProcessamento);
    Result:=False;
    Exit;
  End; // If FrmSelectEmpProcessamento.iNrEmpProc=1 Then
  FreeAndNil(FrmSelectEmpProcessamento);

  // Acerta Perodo ============================================================
  sDti:=DateToStr(DtEdt_ConsultaNFeDtInicio.Date);
  sDti:=f_Troca('/','.',sDti);
  sDti:=f_Troca('-','.',sDti);
  sDtf:=DateToStr(DtEdt_ConsultaNFeDtFim.Date);
  sDtf:=f_Troca('/','.',sDtf);
  sDtf:=f_Troca('-','.',sDtf);

  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Comprovantes Selecionados =====================================================
  sComprov:='';
  If Not DMVirtual.CDS_V_Comprovantes.IsEmpty Then
  Begin

    DMVirtual.CDS_V_Comprovantes.First;
    While Not DMVirtual.CDS_V_Comprovantes.Eof do
    Begin
      Refresh;

      If sComprov='' Then
       sComprov:=QuotedStr(FormatFloat('000',DMVirtual.CDS_V_ComprovantesCOD_COMPROV.AsInteger))
      Else
       sComprov:=sComprov+', '+QuotedStr(FormatFloat('000',DMVirtual.CDS_V_ComprovantesCOD_COMPROV.AsInteger));

      DMVirtual.CDS_V_Comprovantes.Next;
    End; // While Not DMVirtual.CDS_V_Comprovantes.Eof do
    DMVirtual.CDS_V_Comprovantes.First;

  End; // If Not DMVirtual.CDS_V_Comprovantes.IsEmpty Then

  // Grupos e SubGrupos Selecionados ===========================================
  sgGrupos:='';
  sgSubGrupos:='';
  If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GruposProdutos.First;
    While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    Begin
      Refresh;

      If sgGrupos='' Then
       sgGrupos:='(gr.codgrupo='+
                     QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString)
      Else
       sgGrupos:=sgGrupos+' Or gr.codgrupo='+
                    QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString);

      If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
      Begin
        While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        Begin
          Refresh;

          If sgSubGrupos='' Then
           sgSubGrupos:=QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString)
          Else
           sgSubGrupos:=sgSubGrupos+', '+
              QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString);

          DMVirtual.CDS_V_SubGruposProdutos.Next;
        End; // While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        DMVirtual.CDS_V_SubGruposProdutos.First;

      End; // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then

      If sgSubGrupos<>'' Then
       sgGrupos:=sgGrupos+' and pr.codgruposub in ('+sgSubGrupos+')';

      sgSubGrupos:='';

      DMVirtual.CDS_V_GruposProdutos.Next;
    End; // While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    DMVirtual.CDS_V_GruposProdutos.First;

    If sgGrupos<>'' Then
     sgGrupos:=sgGrupos+')';

  End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then

  // Aplicacoes Selecionadas ===================================================
  sgAplicacoes:='';
  If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then
  Begin

    DMVirtual.CDS_V_Aplicacao.First;
    While Not DMVirtual.CDS_V_Aplicacao.Eof do
    Begin
      Refresh;

      If sgAplicacoes='' Then
       sgAplicacoes:=QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString)
      Else
       sgAplicacoes:=sgAplicacoes+', '+
                     QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString);

      DMVirtual.CDS_V_Aplicacao.Next;
    End; // While Not DMVirtual.CDS_V_Aplicacao.Eof do
    DMVirtual.CDS_V_Aplicacao.First;

  End; // If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then

  // Cria ClientDataSet para Totais por Comprovante ============================
  If CDS_ <> nil then
  Begin
    FreeAndNil(CDS_);
  End;

  CDS_:=TClientDataSet.Create(CDS_);
  CDS_.FieldDefs.Clear;
  CDS_.FieldDefs.Add('Cod_Comp',ftInteger);
  CDS_.FieldDefs.Add('Des_Comp',ftString,50);
  CDS_.FieldDefs.Add('Qtd_Docs',ftInteger);
  CDS_.FieldDefs.Add('Tot_Qtds',ftCurrency);
  CDS_.FieldDefs.Add('Qtd_Itens',ftInteger);
  CDS_.FieldDefs.Add('Vlr_Total',ftCurrency);
  CDS_.FieldDefs.Add('Qtd_Docs_Emp',ftInteger);
  CDS_.FieldDefs.Add('Tot_Qtds_Emp',ftCurrency);
  CDS_.FieldDefs.Add('Qtd_Itens_Emp',ftInteger);
  CDS_.FieldDefs.Add('Vlr_Total_Emp',ftCurrency);
  CDS_.CreateDataSet;

  // Monta Sql de Movimentos de Entradas =======================================
  sFiltroEnt:='';
  sWhereEnt :='';
  MySqlEnt:=' Select moe.codcomprovante, moe.numero, moe.serie,'+
            ' moe.datacomprovante datadocumento,'+
            ' moe.dataentrada,'+
            ' sum(mpe.quant) totqtd,'+

            ' sum(CASE'+
            '       WHEN mpe.quant<1 THEN'+
            '         -1'+
            '       ELSE'+
            '         1'+
            '     END'+
            ' ) totitens,'+
            ' CASE'+
            '   WHEN SUM(COALESCE(mpe.valtotal,0))<>0 THEN'+
            '     SUM(COALESCE(mpe.valtotal,0))'+
            '   ELSE'+
            '     SUM(COALESCE(moe.totnota,0))'+
            ' END totnota,'+

            ' cpe.nomecomprovante,'+
            ' moe.codfornecedor, foe.nomefornecedor';

  sWhereEnt:='  From MFOR moe'+
             '      LEFT JOIN COMPRV   cpe ON cpe.codcomprovante=moe.codcomprovante'+
             '      LEFT JOIN FORNECED foe ON foe.codfornecedor=moe.codfornecedor'+
             '      LEFT JOIN MFORPRO  mpe ON mpe.CHAVENF=moe.CHAVENF'+
             '      LEFT JOIN PRODUTO  pe  ON pe.codproduto=mpe.CodProduto'+
             '      LEFT JOIN gruposub gse ON gse.codgruposub=pe.codgruposub'+
             '      LEFT JOIN grupo    gre ON gre.codgrupo=gse.codgrupo'+

             ' Where moe.dataentrada Between '+QuotedStr(sDti)+' And '+QuotedStr(sDtf)+
             ' And   moe.codfilial = :CodLoja';

            // Numero do Docto
            If EdtConsultaNFeDocto.Value<>0 Then
             sFiltroEnt:=
              sFiltroEnt+' AND moe.numero='+QuotedStr(VarToStr(EdtConsultaNFeDocto.Value));

            // Valor do Docto
            If EdtConsultaNFeVlr.Value<>0 Then
             sFiltroEnt:=
              sFiltroEnt+' AND CAST(moe.totnota as Numeric(12,2))='+QuotedStr(f_Troca(',','.',VarToStr(EdtConsultaNFeVlr.Value)));

            // Situacao dos Produtos
            If Cbx_ConsultaNfeSituacaoProd.ItemIndex=0 Then
             sFiltroEnt:=
              sFiltroEnt+' AND COALESCE(pe.situacaopro,0)=0';

            If Cbx_ConsultaNfeSituacaoProd.ItemIndex=1 Then
             sFiltroEnt:=
              sFiltroEnt+' AND COALESCE(pe.situacaopro,3)=3';

            If Cbx_ConsultaNfeSituacaoProd.ItemIndex=2 Then
             sFiltroEnt:=
              sFiltroEnt+' AND COALESCE(pe.situacaopro,0) in (0,3)';

            If Trim(sComprov)<>'' Then
             sFiltroEnt:=
              sFiltroEnt+' AND moe.codcomprovante in ('+sComprov+')';

            If Trim(sgFornecedores)<>''  Then
             sFiltroEnt:=
              sFiltroEnt+' AND moe.codfornecedor in ('+sgFornecedores+')';

            // Produtos Codigos e/ou Produtos Like ---------------------
            If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
             sFiltroEnt:=
              sFiltroEnt+' AND (pe.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','pe.',sgLikeProdutos)+')'
            Else If Trim(sgProdutos)<>'' Then
             sFiltroEnt:=
              sFiltroEnt+' AND pe.CodProduto in ('+sgProdutos+')'
            Else If Trim(sgLikeProdutos)<>'' Then
             sFiltroEnt:=
              sFiltroEnt+' AND '+f_Troca('pr.','pe.',sgLikeProdutos);

            // Grupos e SubGrupos --------------------------------------
            If Trim(sgGrupos)<>'' Then
             sFiltroEnt:=
              sFiltroEnt+' AND '+f_Troca('pr.','pe.',f_Troca('gr.','gre.',sgGrupos));

            // Aplicacoes ----------------------------------------------
            If Trim(sgAplicacoes)<>'' Then
             sFiltroEnt:=
              sFiltroEnt+' AND pe.CodAplicacao in ('+sgAplicacoes+')';

            sFiltroEnt:=
             sFiltroEnt+' GROUP BY 1, 2, 3, 4, 5, 9, 10, 11';

  // Monta Sql de Movimentos de Saidas =========================================
  sFiltroSai:='';
  sWhereSai :='';
  MySqlSai:=' SELECT mos.codcomprovante, mos.numero, mos.serie,'+
            ' mos.datacomprovante datadocumento, mos.datadocumento dataentrada,'+
            ' SUM(mps.quantatendida) totqtd,'+

            ' sum(CASE'+
            '       WHEN mps.quantatendida<1 THEN'+
            '         -1'+
            '       ELSE'+
            '         1'+
            '     END'+
            ' ) totitens,'+
            ' SUM(mps.valtotal) totnota,'+
            ' cps.nomecomprovante,'+
            ' CASE'+
            '   WHEN fos.codfornecedor is NULL THEN'+
            '     ''999999'''+
            '   ELSE'+
            '     fos.codfornecedor'+
            ' END codfornecedor,'+
            ' CASE'+
            '   WHEN fos.nomefornecedor is NULL THEN'+
            '     ''SEM FORNECEDOR INFORMADO'''+
            '   ELSE'+
            '     fos.nomefornecedor'+
            ' END nomefornecedor';

  sWhereSai:=' FROM MCLI mos'+
             '      LEFT JOIN COMPRV   cps ON cps.codcomprovante=mos.codcomprovante'+
             '      LEFT JOIN MCLIPRO  mps ON mps.CHAVENF=mos.CHAVENF'+
             '      LEFT JOIN PRODUTO  ps  ON ps.codproduto=mps.codproduto'+
             '      LEFT JOIN FORNECED fos ON fos.codfornecedor=ps.principalfor'+
             '      LEFT JOIN gruposub gss ON gss.codgruposub=ps.codgruposub'+
             '      LEFT JOIN grupo    grs ON grs.codgrupo=gss.codgrupo'+

             ' WHERE mos.datadocumento Between '+QuotedStr(sDti)+' And '+QuotedStr(sDtf)+
             ' AND mos.codfilial = :CodLoja';

            // Numero do Docto
            If EdtConsultaNFeDocto.Value<>0 Then
             sFiltroSai:=
              sFiltroSai+' AND mos.numero='+QuotedStr(VarToStr(EdtConsultaNFeDocto.Value));

            // Valor do Docto
            If EdtConsultaNFeVlr.Value<>0 Then
             sFiltroSai:=
              sFiltroSai+' AND CAST(mos.totnota as Numeric(12,2))='+QuotedStr(f_Troca(',','.',VarToStr(EdtConsultaNFeVlr.Value)));

            // Situacao dos Produtos
            If Cbx_ConsultaNfeSituacaoProd.ItemIndex=0 Then
             sFiltroSai:=
              sFiltroSai+' AND COALESCE(ps.situacaopro,0)=0';

            If Cbx_ConsultaNfeSituacaoProd.ItemIndex=1 Then
             sFiltroSai:=
              sFiltroSai+' AND COALESCE(ps.situacaopro,3)=3';

            If Cbx_ConsultaNfeSituacaoProd.ItemIndex=2 Then
             sFiltroSai:=
              sFiltroSai+' AND COALESCE(ps.situacaopro,0) in (0,3)';

            If Trim(sComprov)<>'' Then
             sFiltroSai:=
              sFiltroSai+' AND mos.codcomprovante in ('+sComprov+')';

            If Trim(sgFornecedores)<>''  Then
             sFiltroSai:=
              sFiltroSai+' AND ps.principalfor in ('+sgFornecedores+')';

            // Produtos Codigos e/ou Produtos Like ---------------------
            If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
             sFiltroSai:=
              sFiltroSai+' AND (ps.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','ps.',sgLikeProdutos)+')'
            Else If Trim(sgProdutos)<>'' Then
             sFiltroSai:=
              sFiltroSai+' AND ps.CodProduto in ('+sgProdutos+')'
            Else If Trim(sgLikeProdutos)<>'' Then
             sFiltroSai:=
              sFiltroSai+' AND '+f_Troca('pr.','ps.', sgLikeProdutos);

            // Grupos e SubGrupos --------------------------------------
            If Trim(sgGrupos)<>'' Then
             sFiltroSai:=
              sFiltroSai+' AND '+f_Troca('pr.','ps.',f_Troca('gr.','grs.',sgGrupos));

            // Aplicacoes ----------------------------------------------
            If Trim(sgAplicacoes)<>'' Then
             sFiltroSai:=
              sFiltroSai+' AND ps.CodAplicacao in ('+sgAplicacoes+')';

            sFiltroSai:=
             sFiltroSai+' GROUP BY 1, 2, 3, 4, 5, 9, 10, 11';

  // Monta Clausulas com Filtros ===============================================
  MySqlEnt:=MySqlEnt+sWhereEnt+sFiltroEnt;
  MySqlSai:=MySqlSai+sWhereSai+sFiltroSai;

  // Executa UNION Conforme Solicitado =========================================
  If Rb_ConsultaNFeTpMovtoAmbos.Checked Then
   Begin
     MySql:=MySqlEnt+' UNION '+MySqlSai;
   End
  Else If Rb_ConsultaNFeTpMovtoEnt.Checked Then
   Begin
     MySql:=MySqlEnt;
   End
  Else // If Rb_ConsultaNFeTpMovtoSai.Checked Then
   Begin
     MySql:=MySqlSai;
   End; // If Rb_ConsultaNFeTpMovtoAmbos.Checked Then
  MySql:=
   MySql+' ORDER BY 10, 4, 1';

  // Manta SQL para Busca Resultado de Produtos ================================
  If Ckbx_ConsultaNFeApresProduto.Checked Then
  Begin
    // Produtos de Entrada --------------------------------------
    sProdEnt:=' SELECT moe.codfilial Cod_Loja, ''TOTAIS'' Cod_Prod,'+
              ' ''-> LOJA: Bel_''||moe.codfilial Des_Prod,'+
              ' cpe.codcomprovante Cod_Comprv, cpe.nomecomprovante Des_Comprv,'+
              ' Cast(SUM(coalesce(mpe.quant,0)) as Integer) Qtd_Total,'+
              'Cast(SUM(coalesce(mpe.valtotal,0)) as Numeric(12,2)) Vlr_Total'+
              sWhereEnt+
              sFiltroEnt+

              ' UNION '+

              ' SELECT moe.codfilial Cod_Loja, mpe.codproduto Cod_Prod,'+
              ' pe.apresentacao Des_Prod,'+
              ' cpe.codcomprovante Cod_Comprv, cpe.nomecomprovante Des_Comprv,'+
              ' Cast(SUM(coalesce(mpe.quant,0)) as Integer) Qtd_Total,'+
              ' Cast(SUM(coalesce(mpe.valtotal,0)) as Numeric(12,2)) Vlr_Total'+
              sWhereEnt+
              sFiltroEnt;

    // Produtosa de Saida ---------------------------------------
    sProdSai:=' SELECT mos.codfilial Cod_Loja, ''TOTAIS'' Cod_Prod,'+
              ' ''-> LOJA: Bel_''||mos.codfilial Des_Prod,'+
              ' cps.codcomprovante Cod_Comprv, cps.nomecomprovante Des_Comprv,'+
              ' Cast(SUM(coalesce(mps.quantatendida,0)) as Integer) Qtd_Total,'+
              ' Cast(SUM(coalesce(mps.valtotal,0)) as Numeric(12,2)) Vlr_Total'+
              sWhereSai+
              sFiltroSai+

              ' UNION '+

              ' SELECT mos.codfilial Cod_Loja, mps.codproduto Cod_Prod,'+
              ' ps.apresentacao Des_Prod,'+
              ' cps.codcomprovante Cod_Comprv, cps.nomecomprovante Des_Comprv,'+
              ' Cast(SUM(coalesce(mps.quantatendida,0)) as Integer) Qtd_Total,'+
              ' Cast(SUM(coalesce(mps.valtotal,0)) as Numeric(12,2)) Vlr_Total'+
              sWhereSai+
              sFiltroSai;

    // Executa UNION Conforme Solicitado ===============================
    If Rb_ConsultaNFeTpMovtoAmbos.Checked Then
     Begin
       MySqlProd:=sProdEnt+' UNION '+sProdSai;
     End
    Else If Rb_ConsultaNFeTpMovtoEnt.Checked Then
     Begin
       MySqlProd:=sProdEnt;
     End
    Else // If Rb_ConsultaNFeTpMovtoSai.Checked Then
     Begin
       MySqlProd:=sProdSai;
     End; // If Rb_ConsultaNFeTpMovtoAmbos.Checked Then

    // Troca GROUP BY e Coloca ORDER BY
    MySqlProd:=f_Troca('GROUP BY 1, 2, 3, 4, 5, 9, 10, 11','GROUP BY 1, 2, 3, 4, 5',AnsiUpperCase(MySqlProd));
    MySqlProd:=
     MySqlProd+' ORDER BY 3,5 ';
  End; // If Ckbx_ConsultaNFeApresProduto.Checked Then

  // Inicia Processamento ======================================================
  sgCodLojas:='';
  cVlrEmpresa:=0;
  cQtdsEmpresa:=0;
  iItensEmpresa:=0;
  iTotNFeEmpresa:=0;
  iOrdem:=0;
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

      If sgCodLojas='' Then
       sgCodLojas:=QuotedStr(sgCodEmp)
      Else
       sgCodLojas:=sgCodLojas+','+QuotedStr(sgCodEmp);

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sgCodEmp+' - '+
                                 DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Conecta Empresa =======================================================
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else
       Begin
         Refresh;

         If sgLojasNConectadas='' Then
          sgLojasNConectadas:='Bel_'+sgCodEmp
         Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sgCodEmp) then
          sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sgCodEmp;

         bSiga:=False;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then

      // Inicia Processamento ==================================================
      If bSiga Then // Empresa Conectada
      Begin
        // Cria Query Busca Movimentos ------------------------------
        CriaQueryIB('IBDB_'+sgCodEmp,'IBT_'+sgCodEmp,IBQ_ConsultaFilial, True, True);

        // Cria Query Busca Parcelas --------------------------------
        CriaQueryIB('IBDB_'+sgCodEmp,'IBT_'+sgCodEmp,IBQ_ConsultaLoja, True, True);

        // Abre Query -----------------------------------------------
        i:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            // Busca Movimentos --------------------------------------
            IBQ_ConsultaFilial.Close;
            IBQ_ConsultaFilial.SQL.Clear;
            IBQ_ConsultaFilial.SQL.Add(MySql);
            IBQ_ConsultaFilial.Params.ParamByName('CodLoja').AsString:=sgCodEmp;
            IBQ_ConsultaFilial.Open;

            // Busca Parcelas ----------------------------------------
            If Ckbx_ConsultaNFeApresParcela.Checked Then
            Begin
              MySqlSelect:=' SELECT m.codfornecedor, m.codcomprovante, m.numero,'+
                           '        m.numprestacao, m.datavencimento, m.totnota'+
                           ' FROM MFORPAGA m'+
                           ' WHERE m.datavencimento BETWEEN '+QuotedStr(sDti)+' And '+QuotedStr(sDtf)+
                           ' AND   m.codfilial='+QuotedStr(sgCodEmp);

                           If Trim(sComprov)<>'' Then
                            MySqlSelect:=
                             MySqlSelect+' AND m.codcomprovante in ('+sComprov+')';

              MySqlSelect:=
               MySqlSelect+' UNION'+

                           ' SELECT m.codfornecedor, m.codcomprovante, m.numero,'+
                           '        m.numprestacao, m.datavencimento, m.totnota'+
                           ' FROM MFORPAGO m'+
                           ' WHERE m.datavencimento BETWEEN '+QuotedStr(sDti)+' And '+QuotedStr(sDtf)+
                           ' AND   m.codfilial='+QuotedStr(sgCodEmp);

                           If Trim(sComprov)<>'' Then
                            MySqlSelect:=
                             MySqlSelect+' AND m.codcomprovante in ('+sComprov+')';

              MySqlSelect:=
               MySqlSelect+' ORDER BY 1,2,3,4';
              IBQ_ConsultaLoja.SQL.Clear;
              IBQ_ConsultaLoja.SQL.Add(MySqlSelect);
              IBQ_ConsultaLoja.Open;
            End; // If Ckbx_ConsultaNFeApresParcela.Checked Then

            bSiga:=True;
          Except
            Inc(i);
          End; // Try

          If i>2 Then
          Begin
            If sgLojasNConectadas='' Then
             sgLojasNConectadas:='Bel_'+sgCodEmp
            Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sgCodEmp) then
             sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sgCodEmp;
            Break;
          End; // If i>10 Then
        End; // While Not bSiga do

        // Processamento =======================================================
        If bSiga Then // Query Executada
        Begin
          Screen.Cursor:=crAppStart;

          // Inicializa CDS_ ===================================================
          CDS_.First;
          While Not CDS_.Eof do
          Begin
            CDS_.Edit;
            CDS_.FieldByName('Qtd_Docs').AsInteger:=0;
            CDS_.FieldByName('Tot_Qtds').AsCurrency:=0;
            CDS_.FieldByName('Qtd_Itens').AsInteger:=0;
            CDS_.FieldByName('Vlr_Total').AsCurrency:=0;
            CDS_.Post;

            CDS_.Next;
          End; // While Not CDS_.Eof do

          // Inicia Processamento ==============================================
          cVlrLoja:=0;
          cQtdsLoja:=0;
          iItensLoja:=0;
          iTotNFeLoja:=0;
          iCodForn:=0;
          i:=0;

          // Cabecalho da Loja =================================================
          DMVirtual.CDS_V_NFe.Insert;
          DMVirtual.CDS_V_NFeCOD_LOJA.AsString:=sgCodEmp;
          DMVirtual.CDS_V_NFeDES_LOJA.AsString:=DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
          Inc(iOrdem);
          DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
          DMVirtual.CDS_V_NFe.Post;

          While Not IBQ_ConsultaFilial.Eof do
          Begin
            Refresh;

            // Acumula Variaveis -----------------------------------------------
            Inc(iTotNFeEmpresa);
            Inc(iTotNFeLoja);

            cVlrEmpresa:=cVlrEmpresa+IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency;
            iItensEmpresa:=iItensEmpresa+IBQ_ConsultaFilial.FieldByName('totitens').AsInteger;
            cQtdsEmpresa:=cQtdsEmpresa+IBQ_ConsultaFilial.FieldByName('totqtd').AsCurrency;

            cVlrLoja:=cVlrLoja+IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency;
            iItensLoja:=iItensLoja+IBQ_ConsultaFilial.FieldByName('totitens').AsInteger;
            cQtdsLoja:=cQtdsLoja+IBQ_ConsultaFilial.FieldByName('totqtd').AsCurrency;

            // Grava Documentos -------------------------------------
            DMVirtual.CDS_V_NFe.Insert;
            DMVirtual.CDS_V_NFeCOD_LOJA.AsString:=sgCodEmp;

            If iCodForn<>IBQ_ConsultaFilial.FieldByName('codfornecedor').AsInteger Then
              DMVirtual.CDS_V_NFeDES_FORNECEDOR.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('NomeFornecedor').AsString);

            DMVirtual.CDS_V_NFeCOD_FORNECEDOR.AsString:=FormatFloat('000000',IBQ_ConsultaFilial.FieldByName('codfornecedor').AsInteger);
            DMVirtual.CDS_V_NFeCOD_COMPROV.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('codcomprovante').AsString);
            DMVirtual.CDS_V_NFeNUM_NOTA.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('numero').AsString);
            DMVirtual.CDS_V_NFeDES_SERIE.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('serie').AsString);
            DMVirtual.CDS_V_NFeDTA_NOTA.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('datadocumento').AsString);
            DMVirtual.CDS_V_NFeDTA_ENTRADA.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('dataentrada').AsString);
            DMVirtual.CDS_V_NFeTOT_QTDS.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('totqtd').AsString);
            DMVirtual.CDS_V_NFeTOT_ITENS.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('totitens').AsString);
            DMVirtual.CDS_V_NFeVLR_NOTA.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('totnota').AsString);
            DMVirtual.CDS_V_NFeDES_COMPROV.AsString:=Trim(IBQ_ConsultaFilial.FieldByName('nomecomprovante').AsString);
            Inc(iOrdem);
            DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
            DMVirtual.CDS_V_NFe.Post;

            // Grava Parcelas - INICIO =========================================
            If Ckbx_ConsultaNFeApresParcela.Checked Then
            Begin
              If IBQ_ConsultaLoja.Locate('CODFORNECEDOR; CODCOMPROVANTE; NUMERO',VarArrayOf(
                                         [FormatFloat('000000',IBQ_ConsultaFilial.FieldByName('codfornecedor').AsInteger),
                                          Trim(IBQ_ConsultaFilial.FieldByName('codcomprovante').AsString),
                                          Trim(IBQ_ConsultaFilial.FieldByName('numero').AsString)]),[]) Then
              Begin
                If IBQ_ConsultaLoja.FieldByName('totnota').AsCurrency<>IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency Then
                Begin
                  While Not IBQ_ConsultaLoja.Eof do
                  Begin
                    DMVirtual.CDS_V_NFe.Insert;
                    DMVirtual.CDS_V_NFeCOD_LOJA.AsString:=sgCodEmp;

                    DMVirtual.CDS_V_NFeCOD_FORNECEDOR.AsString:=FormatFloat('000000',IBQ_ConsultaFilial.FieldByName('codfornecedor').AsInteger);
                    DMVirtual.CDS_V_NFeNUM_NOTA.AsString:=IBQ_ConsultaFilial.FieldByName('numero').AsString;
                    DMVirtual.CDS_V_NFeDTA_ENTRADA.AsString:=Trim(IBQ_ConsultaLoja.FieldByName('datavencimento').AsString);
                    DMVirtual.CDS_V_NFeVLR_NOTA.AsString:=Trim(IBQ_ConsultaLoja.FieldByName('totnota').AsString);
                    DMVirtual.CDS_V_NFeDES_COMPROV.AsString:='Prestao:'+Trim(IBQ_ConsultaLoja.FieldByName('numprestacao').AsString);
                    Inc(iOrdem);
                    DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
                    DMVirtual.CDS_V_NFe.Post;

                    IBQ_ConsultaLoja.Next;

                    If Trim(IBQ_ConsultaFilial.FieldByName('numero').AsString)<>Trim(IBQ_ConsultaLoja.FieldByName('numero').AsString) Then
                     Break;
                  End; // While Not IBQ_ConsultaLoja.Eof do
                End; // If IBQ_ConsultaLoja.FieldByName('totnota').AsCurrency<>IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency Then
              End; // If IBQ_ConsultaLoja.Locate('CODFORNECEDOR; CODCOMPROVANTE; NUMERO; NUMPRESTACAO',VarArrayOf(
            End; // If Ckbx_ConsultaNFeApresParcela.Checked Then
            // Grava Parcelas - FIM ============================================

            // Guarda Total do Comprovante =====================================
            If Ckb_ConsultaNFeParticipacao.Checked Then
            Begin
              If CDS_.Locate('Cod_Comp',IBQ_ConsultaFilial.FieldByName('codcomprovante').AsInteger,[]) Then
               Begin
                 CDS_.Edit;
                 CDS_.FieldByName('Qtd_Docs').AsInteger:=
                                       CDS_.FieldByName('Qtd_Docs').AsInteger+1;
                 CDS_.FieldByName('Tot_Qtds').AsCurrency:=
                                        CDS_.FieldByName('Tot_Qtds').AsCurrency+
                            IBQ_ConsultaFilial.FieldByName('totqtd').AsCurrency;
                 CDS_.FieldByName('Qtd_Itens').AsInteger:=
                                        CDS_.FieldByName('Qtd_Itens').AsInteger+
                           IBQ_ConsultaFilial.FieldByName('totitens').AsInteger;
                 CDS_.FieldByName('Vlr_Total').AsCurrency:=
                                       CDS_.FieldByName('Vlr_Total').AsCurrency+
                           IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency;
                 CDS_.FieldByName('Qtd_Docs_Emp').AsInteger:=
                                   CDS_.FieldByName('Qtd_Docs_Emp').AsInteger+1;
                 CDS_.FieldByName('Tot_Qtds_Emp').AsCurrency:=
                                    CDS_.FieldByName('Tot_Qtds_Emp').AsCurrency+
                            IBQ_ConsultaFilial.FieldByName('totqtd').AsCurrency;
                 CDS_.FieldByName('Qtd_Itens_Emp').AsInteger:=
                                    CDS_.FieldByName('Qtd_Itens_Emp').AsInteger+
                           IBQ_ConsultaFilial.FieldByName('totitens').AsInteger;
                 CDS_.FieldByName('Vlr_Total_Emp').AsCurrency:=
                                   CDS_.FieldByName('Vlr_Total_Emp').AsCurrency+
                           IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency;
               End
              Else
               Begin
                 CDS_.Insert;
                 CDS_.FieldByName('Cod_Comp').AsInteger:=
                     IBQ_ConsultaFilial.FieldByName('codcomprovante').AsInteger;
                 CDS_.FieldByName('Des_Comp').AsString:=
                     IBQ_ConsultaFilial.FieldByName('nomecomprovante').AsString;

                 CDS_.FieldByName('Qtd_Docs').AsInteger:=1;

                 CDS_.FieldByName('Tot_Qtds').AsCurrency:=
                            IBQ_ConsultaFilial.FieldByName('totqtd').AsCurrency;

                 CDS_.FieldByName('Qtd_Itens').AsInteger:=
                           IBQ_ConsultaFilial.FieldByName('totitens').AsInteger;
                 CDS_.FieldByName('Vlr_Total').AsCurrency:=
                           IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency;

                 CDS_.FieldByName('Qtd_Docs_Emp').AsInteger:=1;

                 CDS_.FieldByName('Tot_Qtds_Emp').AsCurrency:=
                            IBQ_ConsultaFilial.FieldByName('totqtd').AsCurrency;

                 CDS_.FieldByName('Qtd_Itens_Emp').AsInteger:=
                           IBQ_ConsultaFilial.FieldByName('totitens').AsInteger;
                 CDS_.FieldByName('Vlr_Total_Emp').AsCurrency:=
                           IBQ_ConsultaFilial.FieldByName('totnota').AsCurrency;
               End;
               CDS_.Post;
            End; // If Ckb_ConsultaNFeParticipacao.Checked Then

            Inc(i);
            iCodForn:=IBQ_ConsultaFilial.FieldByName('codfornecedor').AsInteger;
            IBQ_ConsultaFilial.Next;
          End; // While Not IBQ_ConsultaFilial.Eof do
          IBQ_ConsultaFilial.Close;
          IBQ_ConsultaLoja.Close;

          // Grava Totais por Comprovantes Por Loja ----------------------------
          If Ckb_ConsultaNFeParticipacao.Checked Then
          Begin
            CDS_.First;
            While Not CDS_.Eof do
            Begin
              If CDS_.FieldByName('Qtd_Docs').AsInteger<>0 Then
              Begin
                DMVirtual.CDS_V_NFe.Insert;
                DMVirtual.CDS_V_NFeCOD_LOJA.AsString:=sgCodEmp;
                DMVirtual.CDS_V_NFeDES_LOJA.AsString:='Participao Comprovante';
                DMVirtual.CDS_V_NFeCOD_FORNECEDOR.AsString:=CDS_.FieldByName('Cod_Comp').AsString;
                DMVirtual.CDS_V_NFeDES_FORNECEDOR.AsString:=CDS_.FieldByName('Des_Comp').AsString;

                DMVirtual.CDS_V_NFeCOD_COMPROV.AsString:=CurrToStr(RoundTo((
                  (CDS_.FieldByName('Vlr_Total').AsCurrency*100)/cVlrLoja),-2))+'%';

                DMVirtual.CDS_V_NFeNUM_NOTA.AsString:=CDS_.FieldByName('Qtd_Docs').AsString;
                DMVirtual.CDS_V_NFeTOT_QTDS.AsString:=CDS_.FieldByName('Tot_Qtds').AsString;
                DMVirtual.CDS_V_NFeTOT_ITENS.AsString:=CDS_.FieldByName('Qtd_Itens').AsString;
                DMVirtual.CDS_V_NFeVLR_NOTA.AsCurrency:=CDS_.FieldByName('Vlr_Total').AsCurrency;

                Inc(iOrdem);
                DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
                DMVirtual.CDS_V_NFe.Post;
              End; // If CDS_.FieldByName('Qtd_Docs').AsInteger<>0 Then

              CDS_.Next;
            End; // While Not CDS_.Eof do
          End; // If Ckb_ConsultaNFeParticipacao.Checked Then

          // Grava Total de Loja -----------------------------------------------
          DMVirtual.CDS_V_NFe.Insert;
          DMVirtual.CDS_V_NFeCOD_LOJA.AsString:=sgCodEmp;
          DMVirtual.CDS_V_NFeDES_LOJA.AsString:=DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;

          DMVirtual.CDS_V_NFeDES_FORNECEDOR.AsString:='Total da LOJA';

          DMVirtual.CDS_V_NFeNUM_NOTA.AsInteger:=iTotNFeLoja;
          DMVirtual.CDS_V_NFeTOT_QTDS.AsCurrency:=cQtdsLoja;
          DMVirtual.CDS_V_NFeTOT_ITENS.AsInteger:=iItensLoja;
          DMVirtual.CDS_V_NFeVLR_NOTA.AsCurrency:=cVlrLoja;
          Inc(iOrdem);
          DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
          DMVirtual.CDS_V_NFe.Post;

          // Linha em Branco ---------------------------------------------------
          DMVirtual.CDS_V_NFe.Insert;
          DMVirtual.CDS_V_NFeCOD_LOJA.AsString:='';
          Inc(iOrdem);
          DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
          DMVirtual.CDS_V_NFe.Post;

          // Busca Resultado de Produtos ===========================================
          If Ckbx_ConsultaNFeApresProduto.Checked Then
          Begin
            IBQ_ConsultaFilial.Close;
            IBQ_ConsultaFilial.SQL.Clear;
            IBQ_ConsultaFilial.SQL.Add(MySqlProd);
            IBQ_ConsultaFilial.Params.ParamByName('CodLoja').AsString:=sgCodEmp;
            IBQ_ConsultaFilial.Open;

            While not IBQ_ConsultaFilial.Eof do
            Begin
              DMVirtual.CDS_V_NFeProdutos.Insert;
              For i:=0 to IBQ_ConsultaFilial.FieldCount-1 do
               DMVirtual.CDS_V_NFeProdutos.Fields[i].Assign(IBQ_ConsultaFilial.Fields[i]);

              DMVirtual.CDS_V_NFeProdutos.Post;

              IBQ_ConsultaFilial.Next;
            End;
            IBQ_ConsultaFilial.Close;
          End; // If Ckbx_ConsultaNFeApresProduto.Checked Then

          Screen.Cursor:=crDefault;
        End; // If bSiga Then // Query Executada
      End; // If bSiga Then // Empresa Conectada

      // Fecha Conexo ---------------------------------------------------------
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  If (Ckbx_ConsultaNFeApresProduto.Checked) And (Trim(sgCodLojas)<>'') Then
  Begin
    MySql:=' SELECT ''Bel_''||e.cod_filial cod_loja, e.razao_social'+
           ' FROM EMP_CONEXOES e'+
           ' WHERE e.cod_filial IN ('+sgCodLojas+')'+
           ' ORDER BY 1';
    DMVirtual.CDS_SelectLoja.Close;
    DMVirtual.SDS_SelectLoja.CommandText:=MySql;
    DMVirtual.CDS_SelectLoja.Open;
  End; // If (Ckbx_ConsultaNFeApresProduto.Checked) And (Trim(sgCodLojas)<>'') Then

  // Grava Total de Empresa ====================================================
  DMVirtual.CDS_V_NFe.Insert;
  DMVirtual.CDS_V_NFeCOD_LOJA.AsString:='9999';
  DMVirtual.CDS_V_NFeDES_LOJA.AsString:='Total da EMPRESA';

  DMVirtual.CDS_V_NFeNUM_NOTA.AsInteger:=iTotNFeEmpresa;
  DMVirtual.CDS_V_NFeTOT_QTDS.AsCurrency:=cQtdsEmpresa;
  DMVirtual.CDS_V_NFeTOT_ITENS.AsInteger:=iItensEmpresa;
  DMVirtual.CDS_V_NFeVLR_NOTA.AsCurrency:=cVlrEmpresa;
  Inc(iOrdem);
  DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_NFe.Post;

  // Grava Totais por Comprovantes da Empresa ==================================
  If Ckb_ConsultaNFeParticipacao.Checked Then
  Begin
    CDS_.First;
    While Not CDS_.Eof do
    Begin
      If CDS_.FieldByName('Qtd_Docs_Emp').AsInteger<>0 Then
      Begin
        DMVirtual.CDS_V_NFe.Insert;
        DMVirtual.CDS_V_NFeCOD_LOJA.AsString:='9999';
        DMVirtual.CDS_V_NFeCOD_FORNECEDOR.AsString:=CDS_.FieldByName('Cod_Comp').AsString;
        DMVirtual.CDS_V_NFeDES_FORNECEDOR.AsString:=CDS_.FieldByName('Des_Comp').AsString;
        DMVirtual.CDS_V_NFeDES_LOJA.AsString:=CDS_.FieldByName('Des_Comp').AsString;

        DMVirtual.CDS_V_NFeCOD_COMPROV.AsString:=CurrToStr(RoundTo(((
              CDS_.FieldByName('Vlr_Total_Emp').AsCurrency*100)/cVlrEmpresa),-2))+'%';

        DMVirtual.CDS_V_NFeNUM_NOTA.AsString:=CDS_.FieldByName('Qtd_Docs_Emp').AsString;
        DMVirtual.CDS_V_NFeTOT_QTDS.AsString:=CDS_.FieldByName('Tot_Qtds_Emp').AsString;
        DMVirtual.CDS_V_NFeTOT_ITENS.AsString:=CDS_.FieldByName('Qtd_Itens_Emp').AsString;
        DMVirtual.CDS_V_NFeVLR_NOTA.AsCurrency:=CDS_.FieldByName('Vlr_Total_Emp').AsCurrency;

        Inc(iOrdem);
        DMVirtual.CDS_V_NFeORDEM.AsInteger:=iOrdem;
        DMVirtual.CDS_V_NFe.Post;
      End; // If CDS_.FieldByName('Qtd_Docs_Emp').AsInteger<>0 Then

      CDS_.Next;
    End; // While Not CDS_.Eof do
  End; // If Ckb_ConsultaNFeParticipacao.Checked Then

  If CDS_ <> nil then
  Begin
    FreeAndNil(CDS_);
  End;

  OdirPanApres.Visible:=False;
  Refresh;
  msg('Processamento Efetuado com SUCESSO','A');

  // Apresenta Lojas No Conectadas ============================================
  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

End; // NOTAS FISCAIS DE ENTRADA - Busca NFe >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// DIVERSOS - Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) >>>>>
Procedure TFrmBelShop.AbreSolicitacoes(index: Integer);
Var
  i: Integer;
  TS: TTabSheet;
Begin

  For i:=0 to FrmSolicitacoes.PC_Principal.ControlCount-1 do
  Begin
    FrmSolicitacoes.PC_Principal.TabIndex:=i;

    TS:=FrmSolicitacoes.PC_Principal.ActivePage;

    ts.TabVisible:=False;
    If TS.PageIndex=index Then
     ts.TabVisible:=True;
  End; // For i:=0 to FrmSolicitacoes.PC_Principal.ControlCount-1 do

End; // DIVERSOS - Abre Form de Solicitaes >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Objetivos/Metas - Apresenta TOTAL Geral da Empresa >>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AuditoriaTotalEmpresa;
Var
  i: Integer;
  s: String;
  cPerRealizado, cPerPercentual: Currency;
Begin

  If igTotInteiro=0 Then
   Exit;

  // Ordem de Apresentao =====================================================
  DMVirtual.CDS_V_ObjetivosAuditorias.Last;
  If DMVirtual.CDS_V_ObjetivosAuditorias.RecNo<1 Then
   i:=1
  Else
   i:=DMVirtual.CDS_V_ObjetivosAuditorias.RecNo+1;

  // Linha Em Branco --------------------------------------------
  DMVirtual.CDS_V_ObjetivosAuditorias.Insert;
  DMVirtual.CDS_V_ObjetivosAuditoriasORDEM.AsInteger:=i;
  DMVirtual.CDS_V_ObjetivosAuditorias.Post;

  // Percentual Total Admissivel ----------------------------------
  s:=CurrToStr(RoundTo((cgVlrAcumulado1/igTotInteiro),-2));
  s:=ZerosCentavos(s,2);
  cgVlrAcumulado1:=StrToCurr(s);
    
  // Percentual Total Realizado -----------------------------------
  cPerRealizado:=RoundTo(((cgVlrAcumulado2*100)/cgVlrAcumulado3),-2);

  // Percentual Total Sobre oAdmissivel ---------------------------
  cPerPercentual:=RoundTo(((cPerRealizado*100)/cgVlrAcumulado1),-2);

  inc(i);

  DMVirtual.CDS_V_ObjetivosAuditorias.Append;
  DMVirtual.CDS_V_ObjetivosAuditoriasORDEM.AsInteger:=i;
  DMVirtual.CDS_V_ObjetivosAuditoriasDES_LOJA.AsString:='TOTAL DA EMPRESA';
  DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString:=
                    DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  DMVirtual.CDS_V_ObjetivosAuditoriasLIMITE_OBJETIVO.AsString:=s+' a -'+s;
  DMVirtual.CDS_V_ObjetivosAuditoriasREALIZADO.AsCurrency:=cPerRealizado;
  DMVirtual.CDS_V_ObjetivosAuditoriasPERCENTUAL.AsCurrency:=cPerPercentual;

  If (cPerPercentual>=-100) and (cPerPercentual<=100) Then 
   DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString:='A'
  Else
   DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString:='V';
  
  DMVirtual.CDS_V_ObjetivosAuditorias.Post;

End; // Objetivos/Metas - Apresenta TOTAL Geral da Empresa >>>>>>>>>>>>>>>>>>>>>

// Auditoria - Busca as Datas de Todas as Auditorias >>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AuditoriaTodasDatas;
Var
  MySql: String;
Begin
  MySql:=' Select au.Dta_Auditoria'+
         ' From  AUDITORIAS au'+
         ' Where au.Cod_Loja='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger))+
         ' Order by au.Dta_Auditoria';
  DMBelShop.CDS_AuditoriaDatas.Close;
  DMBelShop.SDS_AuditoriaDatas.CommandText:=MySql;
  DMBelShop.CDS_AuditoriaDatas.Open;

  MySql:=DateToStr(DtEdtFinanAuditoriaManutData.Date);
  DMBelShop.CDS_AuditoriaDatas.Locate('Dta_Auditoria',MySql,[]);

End; // Auditoria - Busca as Datas de Todas as Auditorias >>>>>>>>>>>>>>>>>>>>>>

// Acerta DBEdts em Branco >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AuditoriaDBEdtBranco;
Begin
  If Trim(Dbe_FinanAuditoriaManutVlrNegReal.Text)    ='' Then Dbe_FinanAuditoriaManutVlrNegReal.Text    :='0';
  If Trim(Dbe_FinanAuditoriaManutVlrEstLoja.Text)    ='' Then Dbe_FinanAuditoriaManutVlrEstLoja.Text    :='0';
  If Trim(Dbe_FinanAuditoriaManutVlrEstInicial.Text) ='' Then Dbe_FinanAuditoriaManutVlrEstInicial.Text :='0';
  If Trim(Dbe_FinanAuditoriaManutQtdEstInicial.Text) ='' Then Dbe_FinanAuditoriaManutQtdEstInicial.Text :='0';


  If Trim(Dbe_FinanAuditoriaManutQtdCodContados.Text)='' Then Dbe_FinanAuditoriaManutQtdCodContados.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutQtdCodOK.Text)      ='' Then Dbe_FinanAuditoriaManutQtdCodOK.Text      :='0';

  If Trim(Dbe_FinanAuditoriaManutQtdCodEntradas.Text)='' Then Dbe_FinanAuditoriaManutQtdCodEntradas.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutPerCodEntradas.Text)='' Then Dbe_FinanAuditoriaManutPerCodEntradas.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutVlrCodEntradas.Text)='' Then Dbe_FinanAuditoriaManutVlrCodEntradas.Text:='0';
  
  If Trim(Dbe_FinanAuditoriaManutQtdCodSaidas.Text)='' Then Dbe_FinanAuditoriaManutQtdCodSaidas.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutPerCodSaidas.Text)='' Then Dbe_FinanAuditoriaManutPerCodSaidas.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutVlrCodSaidas.Text)='' Then Dbe_FinanAuditoriaManutVlrCodSaidas.Text:='0';

  If Trim(Dbe_FinanAuditoriaManutQtdCodNaoContados.Text)='' Then Dbe_FinanAuditoriaManutQtdCodNaoContados.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutPerCodNaoContados.Text)='' Then Dbe_FinanAuditoriaManutPerCodNaoContados.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutVlrCodNaoContados.Text)='' Then Dbe_FinanAuditoriaManutVlrCodNaoContados.Text:='0';
  
  If Trim(Dbe_FinanAuditoriaManutVlrEstFinal.Text) ='' Then Dbe_FinanAuditoriaManutVlrEstFinal.Text:='0';
  
  If Trim(Dbe_FinanAuditoriaManutPerAdmissivel.Text)       ='' Then Dbe_FinanAuditoriaManutPerAdmissivel.Text       :='0';
  If Trim(Dbe_FinanAuditoriaManutVlrAdmissEquivalente.Text)='' Then Dbe_FinanAuditoriaManutVlrAdmissEquivalente.Text:='0';

  
  If Trim(Dbe_FinanAuditoriaManutPerPerdaFinal.Text)      ='' Then Dbe_FinanAuditoriaManutPerPerdaFinal.Text      :='0';
  If Trim(Dbe_FinanAuditoriaManutVlrPerdaEquivalente.Text)='' Then Dbe_FinanAuditoriaManutVlrPerdaEquivalente.Text:='0';
  
  
  If Trim(Dbe_FinanAuditoriaManutPerObjPerAdmiss.Text)='' Then Dbe_FinanAuditoriaManutPerObjPerAdmiss.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutPerObjVlrAdmiss.Text)='' Then Dbe_FinanAuditoriaManutPerObjVlrAdmiss.Text:='0';
  

  If Trim(Edt_FinanAuditoriaManutQtdCodGeral.Text)      ='' Then Edt_FinanAuditoriaManutQtdCodGeral.Text      :='0';
  If Trim(Dbe_FinanAuditoriaManutQtdCodContadosRes.Text)='' Then Dbe_FinanAuditoriaManutQtdCodContadosRes.Text:='0';
  
  
  If Trim(Dbe_FinanAuditoriaManutQtdProdFechada.Text)       ='' Then Dbe_FinanAuditoriaManutQtdProdFechada.Text       :='0';
  If Trim(Dbe_FinanAuditoriaManutPerProdFechados.Text)      ='' Then Dbe_FinanAuditoriaManutPerProdFechados.Text      :='0';
  If Trim(Dbe_FinanAuditoriaManutPerProdFechadosEncont.Text)='' Then Dbe_FinanAuditoriaManutPerProdFechadosEncont.Text:='0';
  
  If Trim(Dbe_FinanAuditoriaManutQtdProdNaoFechada.Text)       ='' Then Dbe_FinanAuditoriaManutQtdProdNaoFechada.Text       :='0';
  If Trim(Dbe_FinanAuditoriaManutPerProdNaoFechados.Text)      ='' Then Dbe_FinanAuditoriaManutPerProdNaoFechados.Text      :='0';
  If Trim(Dbe_FinanAuditoriaManutPerProdNaoFechadosEncont.Text)='' Then Dbe_FinanAuditoriaManutPerProdNaoFechadosEncont.Text:='0';
  
  If Trim(Dbe_FinanAuditoriaManutQtdProdNaoResolvidos.Text)      ='' Then Dbe_FinanAuditoriaManutQtdProdNaoResolvidos.Text      :='0';
  If Trim(Dbe_FinanAuditoriaManutPerProdNaoResolvidos.Text)      ='' Then Dbe_FinanAuditoriaManutPerProdNaoResolvidos.Text      :='0';
  If Trim(Dbe_FinanAuditoriaManutPerProdNaoResolvidosEncont.Text)='' Then Dbe_FinanAuditoriaManutPerProdNaoResolvidosEncont.Text:='0';
  
  If Trim(Dbe_FinanAuditoriaManutQtdProdNaoEncont.Text)='' Then Dbe_FinanAuditoriaManutQtdProdNaoEncont.Text:='0';
  If Trim(Dbe_FinanAuditoriaManutPerProdNaoEncont.Text)='' Then Dbe_FinanAuditoriaManutPerProdNaoEncont.Text:='0';

End; // Acerta DBEdts em Branco >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Auditoria - Altera Cor do Obetivo >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AuditoriaCorObjetivos;
Var
  cVlrObj: Currency;
Begin

  cVlrObj:=abs(DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsCurrency);
  If ((DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency>(cVlrObj*-1)) and
     (DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency<(cVlrObj))) Or 
     (DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency=0) Then
   Begin
     Dbe_FinanAuditoriaManutPerPerdaFinal.Color:=clBlue;
     Dbe_FinanAuditoriaManutVlrPerdaEquivalente.Color:=clBlue;
     Dbe_FinanAuditoriaManutPerObjPerAdmiss.Color:=clBlue;
     Dbe_FinanAuditoriaManutPerObjVlrAdmiss.Color:=clBlue;
   End
  Else
   Begin
     Dbe_FinanAuditoriaManutPerPerdaFinal.Color:=clRed;
     Dbe_FinanAuditoriaManutVlrPerdaEquivalente.Color:=clRed;
     Dbe_FinanAuditoriaManutPerObjPerAdmiss.Color:=clRed;
     Dbe_FinanAuditoriaManutPerObjVlrAdmiss.Color:=clRed;
   End;

  If DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency>=0 Then
   Lb_PerdaSomaFinal.Caption:='Soma Final: .....................................................................'
  Else
   Lb_PerdaSomaFinal.Caption:='Perda Final: .....................................................................';
   
  // Total Geral de Produtos --------------------------------------
  Edt_FinanAuditoriaManutQtdCodGeral.AsInteger:=
                             DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger+
                         DMBelShop.CDS_AuditoriasQTD_COD_NAO_CONTADOS.AsInteger;
   
End; // Auditoria - Altera Cor do Obetivo >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Auditoria - Cria Nova Auditoria >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AutidoriaCriaNovaAuditoria;
Begin
  DMBelShop.CDS_AuditoriasCOD_LOJA.AsString:=FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger);
  DMBelShop.CDS_AuditoriasDTA_AUDITORIA.AsDateTime:=DtEdtFinanAuditoriaManutData.Date;

  DMBelShop.CDS_AuditoriasVLR_EST_NEG_REAL.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasVLR_EST_LOJA.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasQTD_EST_INICIAL.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasQTD_COD_OK.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasQTD_COD_ENTRADAS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasVLR_COD_ENTRADAS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_COD_ENTRADAS.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasQTD_COD_SAIDAS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasVLR_COD_SAIDAS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_COD_SAIDAS.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasQTD_COD_NAO_CONTADOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasVLR_COD_NAO_CONTADOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_COD_NAO_CONTADOS.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasVLR_EST_FINAL.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasVLR_ADMISS_EQUIVALENTE.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasVLR_PERDA_EQUIVALENTE.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasPER_OBJ_PER_ADMISSIVEL.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_OBJ_VLR_ADMISSIVEL.AsCurrency:=0;
  
  DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS_ENCONT.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasQTD_PROD_NAO_FECHADOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS_ENCONT.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasQTD_PROD_NAO_RESOLVIDOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS.AsCurrency:=0;
  DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsCurrency:=0;

  DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsCurrency:=0;

End; // Auditoria - Cria Nova Auditoria >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Apresenta Movtos de Objetivos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.ApresentaMovtosObjetivos(TipCalculo: String);
Var
  i: Integer;
Begin

  // Libera DMVirtual.DMVirtual.CDS_V_ObjetivosMovtos ==========================
  For i:=0 to DMVirtual.CDS_V_ObjetivosMovtos.Fields.Count-1 do
  Begin
    DMVirtual.CDS_V_ObjetivosMovtos.Fields[i].Visible:=False;
    If DMVirtual.CDS_V_ObjetivosMovtos.Fields[i].FieldName='DATA' Then
     DMVirtual.CDS_V_ObjetivosMovtos.Fields[i].Visible:=True;

    If (TipCalculo='D') and ((i in [5..12])) then
    Begin
      DMVirtual.CDS_V_ObjetivosMovtos.Fields[i].Visible:=True;
    End; 

    If (TipCalculo='M') and ((i in [13..14])) then
    Begin
      DMVirtual.CDS_V_ObjetivosMovtos.Fields[i].Visible:=True;
    End; 

    If DMVirtual.CDS_V_ObjetivosMovtos.Fields[i].FieldName='TICKET_MEDIO' Then
     DMVirtual.CDS_V_ObjetivosMovtos.Fields[i].Visible:=False;
  End; // For i:=0 to DMVirtual.CDS_V_ObjetivosMovtos.Fields.Count-1 do

  // Filtra DMVirtual.CDS_V_ObjetivosMovtos ====================================
  If TipCalculo='D' Then
  Begin
    DMVirtual.CDS_V_ObjetivosMovtos.Filtered:=False;
    DMVirtual.CDS_V_ObjetivosMovtos.Filter:=
        'COD_FILIAL='+DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString+
        ' AND COD_OBJETIVO='+DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString+
        ' AND DATA='+QuotedStr(Dbg_FinanObjetivosResultadosDias.Columns[Dbg_FinanObjetivosResultadosDias.SelectedIndex].Title.Caption)+
        ' AND TIP_CALCULO='+QuotedStr(TipCalculo);
    DMVirtual.CDS_V_ObjetivosMovtos.Filtered:=True;
  End; // If TipCalculo='D' Then

  If TipCalculo='M' Then
  Begin
    DMVirtual.CDS_V_ObjetivosMovtos.Filtered:=False;
    DMVirtual.CDS_V_ObjetivosMovtos.Filter:=
       'COD_FILIAL='+DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString+
       ' AND COD_OBJETIVO='+DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString+
       ' AND DATA='+QuotedStr(Dbg_FinanObjetivosResultadosMeses.Columns[Dbg_FinanObjetivosResultadosMeses.SelectedIndex].Title.Caption)+
       ' AND TIP_CALCULO='+QuotedStr(TipCalculo);
       
    DMVirtual.CDS_V_ObjetivosMovtos.Filtered:=True;
  End; // If TipCalculo='D' Then

  If Not DMVirtual.CDS_V_ObjetivosMovtos.IsEmpty Then
  Begin
    FrmFinanObjetivosMovtos:=TFrmFinanObjetivosMovtos.Create(Self);
    FrmFinanObjetivosMovtos.EdtFinanObjetivosMovtosObjetivo.Text:=
                             DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString+' - '+
                                   DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;

    If TipCalculo='D' Then
     FrmFinanObjetivosMovtos.EdtFinanObjetivosMovtosLoja.Text:='Bel_'+
                                  DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString;

    If TipCalculo='M' Then
     FrmFinanObjetivosMovtos.EdtFinanObjetivosMovtosLoja.Text:='Bel_'+
                                 DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString;

    FrmFinanObjetivosMovtos.ShowModal;

    FreeAndNil(FrmFinanObjetivosMovtos);
  End;
                   
End; // Apresenta Movtos de Objetivos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Apresenta Data/Hora da Versao do Sistema e o usurio Corrente >>>>>>>>>>>>>>> 
Procedure TFrmBelShop.ApresentaDataHoraVersao;
Var
  s: String;
Begin
  s:=Des_Login;
  If AnsiUpperCase(Des_Login)='ODIR' Then
   s:=s+'/Administrador';

  If AnsiUpperCase(Des_Login)='RENATO' Then
   s:=s+'/Diretoria';

  EdtVersao.Transparent:=False;
  EdtVersao.Caption:=cr+'Data/Hora ltima Alterao do Sistema:'+cr+Copy(DateTimeToStr(FileDateToDateTime(
                     FileAge(IncludeTrailingPathDelimiter(ExtractFilePath(Application.ExeName))+
                     ExtractFileName(Application.ExeName)))),1,19)+cr+cr+
                     'Login do Usurio Atual:'+cr+s;
  EdtVersao.BehaviorOptions.Active:=Not EdtVersao.BehaviorOptions.Active;
 
End;

// OdirApagar Inicio AtualizaEnderecamentos - 09/06/2017
//// Atualiza Endereamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//Procedure TFrmBelShop.AtualizaEnderecamentos(bManter: Boolean);
//Var
//  MySql, sCurvaABC: String;
//  bCurvaA, bCurvaB, bCurvaC: Boolean;
//  iRecGaveta: Integer;
//Begin
//
//  DMBelShop.CDS_Enderecamento.Close;
//  Cbx_CurvaABCEndZona.ItemIndex:=-1;
//  Cbx_CurvaABCEndCorredor.ItemIndex:=-1;
//  Cbx_CurvaABCEndPrateleira.ItemIndex:=-1;
//  EdtCurvaABCEndCodProd.Clear;
//  EdtCurvaABCEndDescProd.Clear;
//
//  // Monta Transacao ===========================================================
//  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
//  TD.IsolationLevel:=xilREADCOMMITTED;
//  DMBelShop.SQLC.StartTransaction(TD);
//  Try
//    Screen.Cursor:=crAppStart;
//    DateSeparator:='.';
//    DecimalSeparator:='.';
//
//    bCurvaA:=True;
//    bCurvaB:=True;
//    bCurvaC:=True;
//    iRecGaveta:=50;
//    DMVirtual.CDS_V_CurvaABCEndereco.First;
//    While Not DMVirtual.CDS_V_CurvaABCEndereco.Eof do
//    Begin
//      Refresh;
//
//      If Trim(DMVirtual.CDS_V_CurvaABCEnderecoCOD_PRODUTO.AsString)<>'' Then
//      Begin
//        // Verifica se Tem Enderecamento Livre da Curva para Processar =========
//        bgProcessar:=True;
//        If (Not bCurvaA) and (DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='A') Then
//         bgProcessar:=False;
//
//        If (Not bCurvaB) and (DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='B') Then
//         bgProcessar:=False;
//
//        If (Not bCurvaC) and (DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='C') Then
//         bgProcessar:=False;
//
//        If bgProcessar Then
//        Begin
//          // Veriica se Manten Enderecamento do SIDICOM ========================
//          bgSiga:=True;
//          If (DMVirtual.CDS_V_CurvaABCEnderecoDES_ZONA.AsInteger<>0) And
//             (DMVirtual.CDS_V_CurvaABCEnderecoDES_CORREDOR.AsInteger<>0) And
//             (DMVirtual.CDS_V_CurvaABCEnderecoDES_PRATELEIRA.AsInteger<>0) And
//             (DMVirtual.CDS_V_CurvaABCEnderecoDES_GAVETA.AsInteger<>0) And (bManter) Then
//          Begin
//            bgSiga:=False
//          End;
//
//          // Processa Enderecamentos ===========================================
//          If bgSiga Then
//          Begin
//            // Apaga Enderecamento Anterior ==================================
//            MySql:=' Update CE_ENDERECAMENTOS e'+
//                   ' set e.cod_produto=null,'+
//                   ' e.des_produto=null,'+
//                   ' e.cod_fornecedor=null,'+
//                   ' e.des_fornecedor=null'+
//                   ' where e.cod_produto = '+
//                   QuotedStr(DMVirtual.CDS_V_CurvaABCEnderecoCOD_PRODUTO.AsString);
//            DMBelShop.SQLC.Execute(MySql,nil,nil);
//
//            // Busca Gavetas Livre da Curva ====================================
//            sCurvaABC:=DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString;
//            MySql:=' Select *'+
//                   ' From CE_ENDERECAMENTOS e'+
//                   ' Where e.cod_produto is null'+
//                   ' and e.tip_curvaabc='+QuotedStr(sCurvaABC)+
//                   ' Order by e.cod_zona, e.cod_corredor, e.cod_prateleira,'+
//                   ' e.cod_gaveta';
//            DMBelShop.CDS_Busca.Close;
//            DMBelShop.SDS_Busca.CommandText:=MySql;
//            DMBelShop.CDS_Busca.Open;
//
//            If Trim(DMBelShop.CDS_Busca.FieldByName('cod_zona').AsString)='' Then
//            Begin
//              msg('Sem Endereo Disponvel Para Curva '+sCurvaABC+cr+cr+'Tecle <OK> Para Continuar...','A');
//              If sCurvaABC='A' Then bCurvaA:=False;
//              If sCurvaABC='B' Then bCurvaB:=False;
//              If sCurvaABC='C' Then bCurvaC:=False;
//              DMBelShop.CDS_Busca.Close;
//              bgSiga:=False;
//            End;
//
//            // Cria Enderecamento ==============================================
//            If bgSiga Then
//            Begin
//              iRecGaveta:=DMBelShop.CDS_Busca.RecordCount;
//              iRecGaveta:=StrToInt(sorteia(1,iRecGaveta));
//
//              // Grava Enderecamento ===========================================
//              DMBelShop.CDS_Busca.RecNo:=iRecGaveta;
//
//              DMVirtual.CDS_V_CurvaABCEndereco.Edit;
//              DMVirtual.CDS_V_CurvaABCEnderecoDES_ZONA.AsString:=
//                           DMBelShop.CDS_Busca.FieldByName('Cod_Zona').AsString;
//              DMVirtual.CDS_V_CurvaABCEnderecoDES_CORREDOR.AsString:=
//                       DMBelShop.CDS_Busca.FieldByName('Cod_Corredor').AsString;
//              DMVirtual.CDS_V_CurvaABCEnderecoDES_PRATELEIRA.AsString:=
//                     DMBelShop.CDS_Busca.FieldByName('Cod_Prateleira').AsString;
//              DMVirtual.CDS_V_CurvaABCEnderecoDES_GAVETA.AsString:=
//                         DMBelShop.CDS_Busca.FieldByName('Cod_Gaveta').AsString;
//              DMVirtual.CDS_V_CurvaABCEndereco.Post;
//
//              // Insere Novo Enderecamento =====================================
//              MySql:=' Update CE_ENDERECAMENTOS e'+
//                     ' set e.cod_produto='+
//                     QuotedStr(DMVirtual.CDS_V_CurvaABCEnderecoCOD_PRODUTO.AsString)+','+
//                     ' e.des_produto='+
//                     QuotedStr(DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString)+','+
//                     ' e.cod_fornecedor='+
//                     QuotedStr(DMVirtual.CDS_V_CurvaABCEnderecoCOD_FORNECEDOR.AsString)+','+
//                     ' e.des_fornecedor='+
//                     QuotedStr(DMVirtual.CDS_V_CurvaABCEnderecoDES_FORNECEDOR.AsString)+
//                     ' where e.cod_zona='+
//                     QuotedStr(DMBelShop.CDS_Busca.FieldByName('Cod_Zona').AsString)+
//                     ' and e.cod_corredor='+
//                     QuotedStr(DMBelShop.CDS_Busca.FieldByName('Cod_Corredor').AsString)+
//                     ' and e.cod_prateleira='+
//                     QuotedStr(DMBelShop.CDS_Busca.FieldByName('Cod_Prateleira').AsString)+
//                     ' and e.cod_gaveta='+
//                     QuotedStr(DMBelShop.CDS_Busca.FieldByName('Cod_Gaveta').AsString);
//              DMBelShop.SQLC.Execute(MySql,nil,nil);
//            End; // If bgSiga Then // Cria Enderecamento
//
//            DMBelShop.CDS_Busca.Close;
//          End; // If Siga Then // Cria Enderecamento
//        End; // If bgProcessar Then
//      End; // If Trim(DMVirtual.CDS_V_CurvaABCEnderecoCOD_PRODUTO.AsString)<>'' Then
//
//      DMVirtual.CDS_V_CurvaABCEndereco.Next;
//    End ; // While Not DMVirtual.CDS_V_CurvaABCEndereco.Eof do
//    DMVirtual.CDS_V_CurvaABCEndereco.First;
//
//    // Atualiza Transacao =======================================
//    DMBelShop.SQLC.Commit(TD);
//
//    DateSeparator:='/';
//    DecimalSeparator:=',';
//    Screen.Cursor:=crDefault;
//
//    msg('Endereamentos Efetuados com SUCESSO !!','A');
//
//  Except
//    on e : Exception do
//    Begin
//      // Abandona Transacao =====================================
//      DMBelShop.SQLC.Rollback(TD);
//
//      DateSeparator:='/';
//      DecimalSeparator:=',';
//      MontaProgressBar(False, FrmBelShop);
//
//      Screen.Cursor:=crDefault;
//
//      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
//
//      DMVirtual.CDS_V_CurvaABCEndereco.First;
//      While Not DMVirtual.CDS_V_CurvaABCEndereco.Eof do
//      Begin
//        DMVirtual.CDS_V_CurvaABCEndereco.Edit;
//        DMVirtual.CDS_V_CurvaABCEnderecoDES_ZONA.AsString:=DMVirtual.CDS_V_CurvaABCEnderecoDES_ZONA.OldValue;
//        DMVirtual.CDS_V_CurvaABCEnderecoDES_CORREDOR.AsString:=DMVirtual.CDS_V_CurvaABCEnderecoDES_CORREDOR.OldValue;
//        DMVirtual.CDS_V_CurvaABCEnderecoDES_PRATELEIRA.AsString:=DMVirtual.CDS_V_CurvaABCEnderecoDES_PRATELEIRA.OldValue;
//        DMVirtual.CDS_V_CurvaABCEnderecoDES_GAVETA.AsString:=DMVirtual.CDS_V_CurvaABCEnderecoDES_GAVETA.OldValue;
//        DMVirtual.CDS_V_CurvaABCEndereco.Post;
//
//        DMVirtual.CDS_V_CurvaABCEndereco.Next;
//      End ; // While Not DMVirtual.CDS_V_CurvaABCEndereco.Eof do
//      DMVirtual.CDS_V_CurvaABCEndereco.First;
//
//    End; // on e : Exception do
//  End; // Try
//
//End; // Atualiza Endereamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// OdirApagar FIM AtualizaEnderecamentos - 09/06/2017

// OdirApagar INICIO - EnderecamentoProduto - 09/06/2017
// Apresenta Enderecamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//Function TFrmBelShop.EnderecamentoProduto:Boolean;
//Var
//  sCodProd: String;
//  MySql: String;
//  i: Integer;
//begin
//  Result:=True;
//
//  Cbx_CurvaABCEndZona.ItemIndex:=-1;
//  Cbx_CurvaABCEndCorredor.ItemIndex:=-1;
//  Cbx_CurvaABCEndPrateleira.ItemIndex:=-1;
//
//  DMBelShop.CDS_Enderecamento.Close;
//
//  sCodProd:=EdtCurvaABCEndCodProd.Text;
//  MySql:=' Select e.Cod_Produto, z.des_zona, c.des_corredor, p.des_prateleira'+
//         ' from CE_ENDERECAMENTOS e,'+
//         ' ce_zona_enderecos z, ce_corredores c, ce_prateleiras p'+
//         ' where e.cod_zona=z.cod_zona'+
//         ' and e.cod_corredor=c.cod_corredor'+
//         ' and e.cod_prateleira=p.cod_prateleira';
//
//         If Trim(sCodProd)<>'' Then
//          MySql:=MySql+' and e.cod_produto='+QuotedStr(sCodProd);
//  DMBelShop.CDS_Busca.Close;
//  DMBelShop.SDS_Busca.CommandText:=MySql;
//  DMBelShop.CDS_Busca.Open;
//
//  If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Produto').AsString)='' Then
//  Begin
//    Result:=False;
//    DMBelShop.CDS_Busca.Close;
//    Exit;
//  End;
//
//  For i:=0 to Cbx_CurvaABCEndZona.Items.Count-1 do
//  Begin
//    If Cbx_CurvaABCEndZona.Items[i]=DMBelShop.CDS_Busca.FieldByName('des_zona').AsString Then
//    Begin
//      Cbx_CurvaABCEndZona.ItemIndex:=i;
//      Break;
//    End;
//  End; // For i:=0 to Cbx_CurvaABCEndZona.Items.Count-1 do
//
//  For i:=0 to Cbx_CurvaABCEndCorredor.Items.Count-1 do
//  Begin
//    If Cbx_CurvaABCEndCorredor.Items[i]=DMBelShop.CDS_Busca.FieldByName('des_corredor').AsString Then
//    Begin
//      Cbx_CurvaABCEndCorredor.ItemIndex:=i;
//      Break;
//    End;
//  End; // For i:=0 to Cbx_CurvaABCEndCorredor.Items.Count-1 do
//
//  For i:=0 to Cbx_CurvaABCEndPrateleira.Items.Count-1 do
//  Begin
//    If Cbx_CurvaABCEndPrateleira.Items[i]=DMBelShop.CDS_Busca.FieldByName('des_prateleira').AsString Then
//    Begin
//      Cbx_CurvaABCEndPrateleira.ItemIndex:=i;
//      Break;
//    End;
//  End; // For i:=0 to Cbx_CurvaABCEndPrateleira.Items.Count-1 do
//
//  DMBelShop.CDS_Busca.Close;
//
//End;// Apresenta Enderecamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// OdirApagar FIM - EnderecamentoProduto - 09/06/2017

// OdirApagar Inicio - BuscaEnderecamentos - 09/06/2017
//// Busca Enderecamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//Procedure TFrmBelShop.BuscaEnderecamentos;
//Var
//  MySql: String;
//begin
//  // Busca Enderecamentos de Zonas =============================================
//  MySql:=' Select z.Cod_Zona, z.Des_Zona'+
//         ' From CE_ZONA_ENDERECOS z'+
//         ' Order By z.Cod_Zona';
//  DMBelShop.CDS_Busca.Close;
//  DMBelShop.SDS_Busca.CommandText:=MySql;
//  DMBelShop.CDS_Busca.Open;
//
//  Cbx_CurvaABCEndZona.Items.Clear;
//  Cbx_CurvaABCEndZona.ItemIndex:=-1;
//  While Not DMBelShop.CDS_Busca.Eof do
//  Begin
//    Cbx_CurvaABCEndZona.Items.Add(DMBelShop.CDS_Busca.FieldByName('Des_Zona').AsString);
//
//    DMBelShop.CDS_Busca.Next;
//  End; // While Not DMBelShop.CDS_Busca.Eof do
//  DMBelShop.CDS_Busca.Close;
//
//  // Busca Enderecamentos de Corredores ========================================
//  MySql:=' Select z.Cod_Corredor, z.Des_Corredor'+
//         ' From CE_CORREDORES z'+
//         ' Order By z.Cod_Corredor';
//  DMBelShop.CDS_Busca.Close;
//  DMBelShop.SDS_Busca.CommandText:=MySql;
//  DMBelShop.CDS_Busca.Open;
//
//  Cbx_CurvaABCEndCorredor.Items.Clear;
//  Cbx_CurvaABCEndCorredor.ItemIndex:=-1;
//  While Not DMBelShop.CDS_Busca.Eof do
//  Begin
//    Cbx_CurvaABCEndCorredor.Items.Add(DMBelShop.CDS_Busca.FieldByName('Des_Corredor').AsString);
//
//    DMBelShop.CDS_Busca.Next;
//  End; // While Not DMBelShop.CDS_Busca.Eof do
//  DMBelShop.CDS_Busca.Close;
//
//  // Busca Enderecamentos de Prateleiras =======================================
//  MySql:=' Select z.Cod_Prateleira, z.Des_Prateleira'+
//         ' From CE_PRATELEIRAS z'+
//         ' Order By z.Cod_Prateleira';
//  DMBelShop.CDS_Busca.Close;
//  DMBelShop.SDS_Busca.CommandText:=MySql;
//  DMBelShop.CDS_Busca.Open;
//
//  Cbx_CurvaABCEndPrateleira.Items.Clear;
//  Cbx_CurvaABCEndPrateleira.ItemIndex:=-1;
//  While Not DMBelShop.CDS_Busca.Eof do
//  Begin
//    Cbx_CurvaABCEndPrateleira.Items.Add(DMBelShop.CDS_Busca.FieldByName('Des_Prateleira').AsString);
//
//    DMBelShop.CDS_Busca.Next;
//  End; // While Not DMBelShop.CDS_Busca.Eof do
//  DMBelShop.CDS_Busca.Close;
//End; // Busca Enderecamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// OdirApagar FIM - BuscaEnderecamentos - 09/06/2017

// Calcula Resultado dos Objetivos por Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CaluclaResultadosObjetivosMetasMeses;
Var
  i: Integer;
  s: String;
  Array_Objetivos: Array of Currency;
  Array_Realizados: Array of Currency;

  Array_ObjetivosTotal: Array of Currency;
  Array_RealizadosTotal: Array of Currency;
  Array_MesesTotal: Array of Currency;

  cValorTotalRealizado: Currency;
Begin
  // Inicializa Arrays =========================================================
  Array_Objetivos:=nil;
  SetLength(Array_Objetivos,14);
  Array_Realizados:=nil;
  SetLength(Array_Realizados,14);

  Array_ObjetivosTotal:=nil;
  SetLength(Array_ObjetivosTotal,14);
  Array_RealizadosTotal:=nil;
  SetLength(Array_RealizadosTotal,14);
  Array_MesesTotal:=nil;
  SetLength(Array_MesesTotal,14);

  // Inicializa Arrays de Totais ===============================================
  For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
   Array_ObjetivosTotal[i]:=0;

  For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
   Array_RealizadosTotal[i]:=0;

  For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
   Array_MesesTotal[i]:=0;

  // Efetua os Calculos dos Objetivos ==========================================
  DMVirtual.CDS_V_ObjetivosMeses.First;
  While Not DMVirtual.CDS_V_ObjetivosMeses.Eof do
  Begin
    Refresh;

    If DMVirtual.CDS_V_ObjetivosMesesTipo.AsString='Objetivo' Then
    Begin
      // Verifica se tem Valores Realizados -------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Next;
      cValorTotalRealizado:=0;

      For i:=6 to EdtFinanObjetivosMeses.AsInteger+5 do
      Begin
        cValorTotalRealizado:=cValorTotalRealizado+
                                 DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value;
      End;

      If cValorTotalRealizado<>0 Then
      Begin
        DMVirtual.CDS_V_ObjetivosMeses.Prior;

        // Guarda Objetivos Totais ----------------------------------
        For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           Array_ObjetivosTotal[i]:=Array_ObjetivosTotal[i]+
              DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency
          Else
           Array_ObjetivosTotal[i]:=Array_ObjetivosTotal[i]+
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency;

        End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do

        // Guarda Objetivos -----------------------------------------
        For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           Array_Objetivos[i]:=
             DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency
          Else
           Array_Objetivos[i]:=
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency;
        End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do

        // Guarda Realizados ----------------------------------------
        DMVirtual.CDS_V_ObjetivosMeses.Next;
        For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           Array_Realizados[i]:=
              DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency
          Else
           Array_Realizados[i]:=
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency;
        End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do

        // Guarda Realizados Totais ---------------------------------
        For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           Array_RealizadosTotal[i]:=Array_RealizadosTotal[i]+
              DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency
          Else
           Array_RealizadosTotal[i]:=Array_RealizadosTotal[i]+
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency;
        End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do

        // Calcula Resultado em Valores -----------------------------
        DMVirtual.CDS_V_ObjetivosMeses.Next;
        DMVirtual.CDS_V_ObjetivosMeses.Edit;
        For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=
                                          Array_Realizados[i]-Array_Objetivos[i]
          Else
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=
                                          Array_Realizados[i]-Array_Objetivos[i];
        End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        DMVirtual.CDS_V_ObjetivosMeses.Post;

        // Calcula Resultado em Percentual --------------------------
        DMVirtual.CDS_V_ObjetivosMeses.Next;
        DMVirtual.CDS_V_ObjetivosMeses.Edit;
        For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           Begin
             DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=0;

             If Array_Objetivos[i]<>0 Then
              DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=
                                RoundTo(((Array_Realizados[i]-Array_Objetivos[i])/
                                                      Array_Objetivos[i])*100,-2);
           End
          Else // If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           Begin
             DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=0;

             If Array_Objetivos[i]<>0 Then
              DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=
                                  RoundTo(((Array_Realizados[i]-Array_Objetivos[i])/
                                                        Array_Objetivos[i])*100,-2);
           End; // If i<EdtFinanObjetivosMeses.AsInteger+1 Then
        End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        DMVirtual.CDS_V_ObjetivosMeses.Post;

        // Calcula Meses Totais ------------------------------------
        DMVirtual.CDS_V_ObjetivosMeses.Next;
        For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          If i<EdtFinanObjetivosMeses.AsInteger+1 Then
           Array_MesesTotal[i]:=Array_MesesTotal[i]+
              DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency
          Else
           Array_MesesTotal[i]:=Array_MesesTotal[i]+
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency;
        End; // For i:=1 to 13 do
      End; // If cValorTotalRealizado<>0 Then
    End; // If DMVirtual.CDS_V_ObjetivosMesesTipo.AsString='Objetivo' Then

    DMVirtual.CDS_V_ObjetivosMeses.Next;

    // Totais da Empresa --------------------------------------------
    If (DMVirtual.CDS_V_ObjetivosMesesDes_Empresa.AsString='Empresa') Then
    Begin
      // Guarda Objetivos Totais ------------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Edit;

      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      Begin
        If Array_ObjetivosTotal[i]<>0 Then
         DMVirtual.CDS_V_ObjetivosMesesVlr_Objetivo.AsCurrency:=Array_ObjetivosTotal[i];
      End;
      DMVirtual.CDS_V_ObjetivosMeses.Post;
    End;

    If (DMVirtual.CDS_V_ObjetivosMesesTipo.AsString='Objetivo') and (DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString='9999') Then
    Begin
      // Guarda Objetivos Totais ------------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Edit;
      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        If i<EdtFinanObjetivosMeses.AsInteger+1 Then
         Begin
          DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=Array_ObjetivosTotal[i];
         End
        Else // If i<EdtFinanObjetivosMeses.AsInteger+1 Then
         Begin
          DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=Array_ObjetivosTotal[i];
         End // If i<EdtFinanObjetivosMeses.AsInteger+1 Then

      End; // If i<EdtFinanObjetivosMeses.AsInteger+1 Then
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Guarda Realizados Totais -----------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Next;
      DMVirtual.CDS_V_ObjetivosMeses.Edit;
      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        If i<EdtFinanObjetivosMeses.AsInteger+1 Then
         DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=Array_RealizadosTotal[i]
        Else
         DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=Array_RealizadosTotal[i];
      End; // For i:=1 to 13 do
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Calcula Resultado em Valores -------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Next;
      DMVirtual.CDS_V_ObjetivosMeses.Edit;
      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        If i<EdtFinanObjetivosMeses.AsInteger+1 Then
         DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=
                                Array_RealizadosTotal[i]-Array_ObjetivosTotal[i]
        Else
         DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=
                               Array_RealizadosTotal[i]-Array_ObjetivosTotal[i];
      End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Calcula Resultado em Percentual ----------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Next;
      DMVirtual.CDS_V_ObjetivosMeses.Edit;
      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        If i<EdtFinanObjetivosMeses.AsInteger+1 Then
         Begin
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=0;
           If Array_ObjetivosTotal[i]<>0 Then
            DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=RoundTo(
                                    ((Array_RealizadosTotal[i]-Array_ObjetivosTotal[i])/
                                                       Array_ObjetivosTotal[i])*100,-2);
         End
        Else // If i<EdtFinanObjetivosMeses.AsInteger+1 Then
         Begin
           DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=0;
           If Array_ObjetivosTotal[i]<>0 Then
            DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=RoundTo(
                                      ((Array_RealizadosTotal[i]-Array_ObjetivosTotal[i])/
                                                         Array_ObjetivosTotal[i])*100,-2);
         End; // If i<EdtFinanObjetivosMeses.AsInteger+1 Then
      End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Guarda Meses Totais ------------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Next;
      DMVirtual.CDS_V_ObjetivosMeses.Edit;
      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        If i<EdtFinanObjetivosMeses.AsInteger+1 Then
         Begin
          DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).AsCurrency:=Array_MesesTotal[i];
         End
        Else
         Begin
          DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Empresa').AsCurrency:=Array_MesesTotal[i];
         End

      End; // For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Inicializa Arrays de Totais --------------------------------
      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
       Array_ObjetivosTotal[i]:=0;

      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
       Array_RealizadosTotal[i]:=0;

      For i:=1 to EdtFinanObjetivosMeses.AsInteger+1 do
       Array_MesesTotal[i]:=0;

      DMVirtual.CDS_V_ObjetivosMeses.Next;
    End; // If (DMVirtual.CDS_V_ObjetivosMesesTipo.AsString='Objetivo') and (DMVirtual.CDS_V_ObjetivosMesesDes_Empresa.AsString='Empresa') Then

  End; // While Not DMVirtual.CDS_V_ObjetivosMeses.Eof do

  DMVirtual.CDS_V_ObjetivosMeses.First;

End; // // Calcula Resultado dos Objetivos por Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>

// Objetivos/Metas Meses - Atualiza 12 Meses Outros >>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AtualizaValorObjetivosMetasMesesOutros;
Var
  MySql: String;
  iOrdemMov, iCodObj: Integer;
  iMes: Integer;

  sDesObj,
  sCampoSubst, sVlrSubst, sCampo: String;
  cVlrCalculado, cVlrAcumulado: Currency;
  bSiga: Boolean;

  b: Boolean;
  i, ii, iii, iLinx: Integer;
  s, sCodComprov: String;
  sMes: String;

  mMemLinx: TMemo;

Begin

  //(ODIRK3) - INICIO - AtualizaValorObjetivosMetasMesesOutros;
  //=========================================================//

  // Cria Componente Memo para Vendas Linx =====================================
  mMemLinx:=TMemo.Create(Self);
  mMemLinx.Visible:=False;
  mMemLinx.Parent:=FrmBelShop;
  mMemLinx.Width:=500;
  mMemLinx.Lines.Clear;

  // Busca Codigos de Comprovantes da Formula ---------------
  b:=True;
  Memo2.Lines.Clear;
  Memo2.Width:=500;
  s:=AnsiUpperCase(DMBelShop.CDS_ObjetivosDES_FORMULA.AsString);
  While b do
  Begin
    i:=pos('CP',AnsiUpperCase(s));
    iii:=6;
    sCodComprov:=copy(s,i,iii);

    If StrToIntDef(copy(sCodComprov,Length(sCodComprov),1), 999999)=999999 Then
    Begin
      iii:=5;
      sCodComprov:=copy(s,i,iii);
    End;
    sCodComprov:=copy(s,i+2,iii-2);

    If i>0 Then
    Begin
      bOK:=True;
      For ii:=0 to Memo2.Lines.Count-1 do
      Begin
        If Memo2.Lines[ii]=sCodComprov Then
        Begin
          bOK:=False;
          Break;
        End;
      End;

      If bOK Then
      Begin
        Memo2.Lines.Add(sCodComprov);
      End; // If bOK Then
      s:=(copy(s,i+iii, Length(s)));
    End; // If i>0 Then

    If i=0 Then
     Break;
  End; // While b do // Busca Codigos de Comprovantes da Formula

  // Busca Valores na Empresa ===============================
  // Array para Formulas =======================================================
  Array_Campos:=nil;
  SetLength(Array_Campos,205000);

  // Localiza Empresa na Planilha ==============================================
  iCodObj:=DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsInteger;
  sDesObj:=DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;
  if DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Realizado']),[]) Then
  Begin
    // Conecta Empresa =====================================================
    bSiga:=True;
//    If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then
//    Begin
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         If sgLojasNConectadas='' Then
          sgLojasNConectadas:=sDesObj+': Bel_'+sgCodEmp
         Else
          sgLojasNConectadas:=
           sgLojasNConectadas+cr+sDesObj+': Bel_'+sgCodEmp;

         bSiga:=False;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
//    End; // If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then

    // Inicia Processamento ================================================
    If bSiga Then // Empresa Conectada
    Begin
      DMLinx.CDS_Busca.Close;
      mMemLinx.Lines.Clear;

      // Cria Query da Empresa ----------------------------------
      CriaQueryIB('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, IBQ_ConsultaFilial, True, True);

      // Busca Comprovantes e Atualiza Planilha ============================
      For i:=0 to memo2.Lines.Count-1 do
      Begin
        //(ODIRK3) - AtualizaValorObjetivosMetasMesesOutros;
        //=================================================//

        // Movimentao Linx (Vendas)--------------------------------
        DMLinx.CDS_Busca.Close;
        mMemLinx.Lines.Clear;
        sgDtaFimLinx  :='';
        sgDtaIncioLinx:='';

        If (Memo2.Lines[i]='002') And (igCodLojaLinx<>0) And
           (Not Rb_FinanObjetivosManutTpOperacaoSalao.Checked) And
           (Not Ckb_FinanObjetivosManutNaoCompra.Checked) Then
        Begin
          // Acerta Perodo de Busca Linx =================================
          sgDtaI  :=sgDtaIniAno;
          sgDtaFim:=sgDtaFimAno;

          // Acerta Perodo de Busca Linx =================================
          if StrToDate(sgDtaFim)>=StrToDate(sgDtaComecoLinx) Then
          Begin
            If (StrToDate(sgDtaComecoLinx)<=StrToDate(sgDtaFim)) Then
            Begin
              If (StrToDate(sgDtaComecoLinx)<=StrToDate(sgDtaI)) Then
               Begin
                 sgDtaIncioLinx:=sgDtaI;
               End
              Else
               Begin
                 sgDtaIncioLinx:=sgDtaComecoLinx;
               End;

              sgDtaFimLinx:=sgDtaFim;
            End; // If (StrToDate(sDtaComecoLinx)<=StrToDate(sgDtaFim)) Then

            // Busca Movimentos de Vendas Linx ============================
            BuscaMovtosVendasLINX(mMemLinx, 'M');

          End; // if StrToDate(sgDtaFim)>StrToDate(sgDtaComecoLinx) Then
        End; // If Memo2.Lines[i]='002' ........ Then

        // Monta SQL Somente Loja Com SIDICOM ----------------------------------
        If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then
        Begin
          MySql:=' SELECT'+
                 ' MESANO,'+
                 ' SUM(QTD_COMPROV) QTD_COMPROV,'+
                 ' SUM(TOT_ITENS) TOT_ITENS,'+
                 ' SUM(TICKET_MEDIO) TICKET_MEDIO,'+
                 ' SUM(TOT_DESC_ITEM) TOT_DESC_ITEM,'+
                 ' SUM(TOT_BRUTO) TOT_BRUTO,'+
                 ' SUM(TOT_NOTA) TOT_NOTA,'+
                 ' SUM(TOT_FRETE) TOT_FRETE,'+
                 ' SUM(TOT_DESPESAS) TOT_DESPESAS'+
                 ' FROM'+

                 ' ('+
                 ' Select'+
                 ' Cast(lpad(extract(month from m.datacomprovante),2,''0'') as varchar(2))||''/''||'+
                 ' Cast(lpad(extract(year from m.datacomprovante),4,''0'') as varchar(4)) MesAno,';

                 If Memo2.Lines[i]='002' Then
                  Begin
                    MySql:=
                     MySql+' Coalesce((Count(distinct case When m.codcomprovante=''002'' then m.chavenf End)-'+
                           '           Count(distinct case When m.codcomprovante=''007'' then m.chavenf End)),0) QTD_COMPROV,'+

                           ' Coalesce((Count(case When m.codcomprovante=''002'' then mp.codproduto End)-'+
                           '           Count(case When m.codcomprovante=''007'' then mp.codproduto End)),0) TOT_ITENS,'+

                           ' Coalesce(('+
                           '           (Sum(Coalesce(mp.valtotal,0.00)))/'+
                           '           ((Count(distinct case When m.codcomprovante=''002'' then m.chavenf End)-'+
                           '             Count(distinct case When m.codcomprovante=''007'' then m.chavenf End)))'+
                           '          ),0.00) Ticket_Medio,';
                  End
                 Else // If Memo2.Lines[i]='002' Then
                  Begin
                    MySql:=
                     MySql+' Coalesce((Count(distinct case When m.codcomprovante='+QuotedStr(Memo2.Lines[i])+' then m.chavenf End)),0) QTD_COMPROV,'+

                           ' Coalesce((Count(case When m.codcomprovante='+QuotedStr(Memo2.Lines[i])+' then mp.codproduto End)),0) TOT_ITENS,'+

                           ' Coalesce((Sum(Coalesce(mp.valtotal,0.00)))/'+
                           '         (Count(distinct case When m.codcomprovante='+QuotedStr(Memo2.Lines[i])+' then m.chavenf End)),0.00) Ticket_Medio,';
                  End; // If Memo2.Lines[i]='002' Then

                 MySql:=
                  MySql+' Coalesce(Sum(Coalesce(mp.valdescitem,0.00)),0.00) TOT_DESC_ITEM,'+
                        ' Coalesce(Sum(Coalesce(mp.valbruto,0.00)),0.00) TOT_BRUTO,'+
                        ' Coalesce(Sum(Coalesce(mp.valtotal,0.00)),0.00) TOT_NOTA,'+
                        ' Coalesce(Sum(Coalesce(mp.valfrete,0.00)),0.00) TOT_FRETE,'+
                        ' Coalesce(Sum(Coalesce(mp.valdespesas,0.00)),0.00) TOT_DESPESAS'+

                        ' From MCLI m, MCLIPRO mp, PRODUTO p'+

                        ' Where m.chavenf=mp.chavenf'+
                        ' AND   mp.codproduto=p.codproduto';

                 If Rb_FinanObjetivosManutTpOperacaoLoja.Checked Then
                  MySql:=
                   MySql+' and p.principalfor not in (''000500'',''000883'')';

                 If Rb_FinanObjetivosManutTpOperacaoSalao.Checked Then
                  MySql:=
                   MySql+' and p.principalfor in (''000500'',''000883'')';

                 If Ckb_FinanObjetivosManutNaoCompra.Checked Then
                  MySql:=
                   MySql+' and Coalesce(p.situacaopro,1) in (1,3)';

                 MySql:=
                  MySql+' and m.codfilial='+QuotedStr(sgCodEmp);

                 If Memo2.Lines[i]='002' Then
                  MySql:=
                   MySql+' and m.codcomprovante in (''002'',''007'')'
                 Else
                  MySql:=
                   MySql+' and m.codcomprovante='+QuotedStr(Memo2.Lines[i]);

                 MySql:=
                  MySql+' and m.datacomprovante '+f_Troca('/','.',f_Troca('-','.',sgPeriodo));

                 MySql:=
                  MySql+' Group by 1';
        End; // If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then // Monta SQL Somente Loja Com SIDICOM ---

        // Ingrementa Dias do Linx =============================================
        If mMemLinx.Lines.Count>1 Then
        Begin
          For iLinx:=0 to mMemLinx.Lines.Count-1 do
          Begin
            If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45) Then // Monta SQL com Loja Somente LINX
             Begin
               MySql:=
                MySql+mMemLinx.Lines[iLinx];
             End
            Else If iLinx=0 Then // Monta SQL com Loja Somente LINX
             Begin
               MySql:=
                MySql+' UNION '+mMemLinx.Lines[iLinx];
             End
            Else
             Begin
               MySql:=
                MySql+mMemLinx.Lines[iLinx];
             End; // If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45) Then
          End; // For i:=0 to mMemo.Lines.Count-1 do
        End; // If mMemLinx.Lines.Count>1 Then

        If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then
        Begin
          MySql:=
           MySql+')'+
                 ' GROUP BY  1'+
                 ' ORDER BY 1';
        End; // If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then

        IBQ_ConsultaFilial.SQL.Clear;
        IBQ_ConsultaFilial.SQL.Add(MySql); //(ODIRK3)

        // Abre Query --------------------------------------------
        ii:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            IBQ_ConsultaFilial.Open;
            bSiga:=True;
          Except
            Inc(ii);
          End; // Try

          If ii>10 Then
          Begin
            If sgLojasNConectadas='' Then
             sgLojasNConectadas:=sDesObj+': Bel_'+sgCodEmp
            Else
             sgLojasNConectadas:=
              sgLojasNConectadas+cr+sDesObj+':  Bel_'+sgCodEmp;

            Break;
          End; // If ii>10 Then
        End; // While Not bSiga do

        // Processamento ===================================================
        If bSiga Then // Query Executada
        Begin
          // Posiciona TabSheet -------------------------------------
          PC_FinanObjetivos.TabIndex:=2;

          iOrdemMov:=0;
          iOrdemMov:=0;
          cVlrAcumulado:=0;
          cVlrCalculado:=0;
          DMVirtual.CDS_V_ObjetivosMeses.Edit;
          While Not IBQ_ConsultaFilial.Eof do
          Begin
            Refresh;

            // Insere Movimentos para Pesquisa ----------------------
            Inc(iOrdemMov);
            DMVirtual.CDS_V_ObjetivosMovtos.Insert;
            DMVirtual.CDS_V_ObjetivosMovtosORDEM.AsInteger:=iOrdemMov;
            DMVirtual.CDS_V_ObjetivosMovtosCOD_FILIAL.AsInteger:=DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsInteger;
            DMVirtual.CDS_V_ObjetivosMovtosCOD_OBJETIVO.AsInteger:=DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsInteger;
            DMVirtual.CDS_V_ObjetivosMovtosTIP_CALCULO.AsString:='M';
            DMVirtual.CDS_V_ObjetivosMovtosDATA.AsString:=IBQ_ConsultaFilial.FieldByName('MesAno').AsString;
            DMVirtual.CDS_V_ObjetivosMovtosQTD_COMPROV.AsCurrency:=IBQ_ConsultaFilial.FieldByName('QTD_COMPROV').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_ITENS.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_ITENS').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTICKET_MEDIO.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TICKET_MEDIO').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_DESC_ITENS.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_DESC_ITEM').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_BRUTO.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_BRUTO').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_NOTA.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_NOTA').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_FRETE.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_FRETE').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_DESPESAS.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_DESPESAS').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtos.Post;

            // Guarda Dia -------------------------------------------
            sMes:=f_Troca('/','',IBQ_ConsultaFilial.FieldByName('MesAno').AsString);
            sMes:=copy(sMes,3,4)+copy(sMes,1,2);
            iMes:=StrToInt(sMes);

            // Acerta Formula Com Valores ---------------------------
            sCampoSubst:='CP'+Memo2.Lines[i]+'.QTD_COMPROV';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('QTD_COMPROV').AsCurrency));

            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_ITENS';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_ITENS').AsCurrency));
            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESC_ITEM';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_DESC_ITEM').AsCurrency));
            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_BRUTO';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_BRUTO').AsCurrency));
            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_NOTA';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_NOTA').AsCurrency));
            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_FRETE';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_FRETE').AsCurrency));
            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESPESAS';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_DESPESAS').AsCurrency));
            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TICKET_MEDIO';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TICKET_MEDIO').AsCurrency));
            If Array_Campos[iMes]='' Then
             Array_Campos[iMes]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iMes]:=StringReplace(Array_Campos[iMes], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            IBQ_ConsultaFilial.Next;
          End; // While Not IBQ_ConsultaFilial.Eof do
        End; // If bSiga Then // Query Executada
      End; // For i:=0 to memo2.Lines.Count-1 do
                                                                                     
      // Acerta Campos das Formulas no Substituidos =======================
      sVlrSubst:='0';
      For i:=0 to memo2.Lines.Count-1 do
      Begin
        for ii:=Low(Array_Campos) to High(Array_Campos) do
        Begin
          If (Array_Campos[ii]<>'') Then
          Begin                                                                      
            sCampoSubst:='CP'+Memo2.Lines[i]+'.QTD_COMPROV';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);
            
            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_ITENS';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESC_ITEM';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_BRUTO';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_NOTA';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_FRETE';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESPESAS';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

          End; // If (Array_Campos[i]<>'') and
        End; // for i:=Low(Array_Campos) to High(Array_Campos) do
      End; // For i:=0 to memo2.Lines.Count-1 do

      // Calcula Formula e Atualiza Planilha de Objetivos ==================
      cVlrAcumulado:=0;
      For i:=Low(Array_Campos) to High(Array_Campos) do
      Begin
        If Array_Campos[i]<>'' Then
        Begin
          sCampo:=IntToStr(i);
          sCampo:=copy(sCampo,5,2)+'/'+copy(sCampo,1,4);

          sVlrSubst:=CalculaFormula(f_Troca(',','.',Array_Campos[i]), DMBelShop.CDS_ObjetivosNUM_DECIMAIS.AsInteger);
          sVlrSubst:=f_Troca('.',',',sVlrSubst);

          If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='NAO' Then
           cVlrAcumulado:=cVlrAcumulado+StrToCurr(sVlrSubst)
          Else
           cVlrAcumulado:=StrToCurr(sVlrSubst);

          // Loaliza Nome do Campo a Atualizar na Planilha --------
          For iii:=0 to DMVirtual.CDS_V_ObjetivosMeses.Fields.Count-1 do
          Begin
            If DMVirtual.CDS_V_ObjetivosMeses.Fields[iii].DisplayName=sCampo Then
            Begin
              sCampo:=DMVirtual.CDS_V_ObjetivosMeses.Fields[iii].FieldName;
              Break;
            End;
          End; // For i:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do

          // Atualiza Planilha ---------------------------------
          DMVirtual.CDS_V_ObjetivosMeses.Edit;
          DMVirtual.CDS_V_ObjetivosMeses.FieldByName(sCampo).AsCurrency:=cVlrAcumulado;

          If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='SIM' Then
           DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=cVlrAcumulado+
                          DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency
          Else
           DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=cVlrAcumulado;
             
          DMVirtual.CDS_V_ObjetivosMeses.Post;

          // Atualiza Valor Meses ------------------------------
          DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Ms']),[]);
          DMVirtual.CDS_V_ObjetivosMeses.Edit;
          DMVirtual.CDS_V_ObjetivosMeses.FieldByName(sCampo).AsCurrency:=StrToCurr(sVlrSubst);

          If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='SIM' Then
           DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=cVlrAcumulado+
                          DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency
          Else
           DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=cVlrAcumulado;

          DMVirtual.CDS_V_ObjetivosMeses.Post;

          // Retorno para o Objetivo da Loja -------------------
          DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Realizado']),[]);
        End; // If Array_Campos[i]<>'' Then
      End; // for i:=Low(Array_Campos) to High(Array_Campos) do // Calcula Formula e Atualiza Planilha de Objetivos

    End; //If bSiga Then // Empresa Conectada
  End; // if DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo',

  FreeAndNil(mMemLinx);

End; // Objetivos/Metas Meses - Atualiza 12 Meses Outros >>>>>>>>>>>>>>>>>>>>>>>

// Objetivos/Metas Meses - Atualiza Avarias >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AtualizaValorObjetivosMetasMesesAvarias;
Var
  MySql: String;
  iOrdemMov, iCodObj: Integer;
  i, ii: Integer;

  sDesObj,
  sCampo: String;
  cVlrCalculado, cVlrAcumulado: Currency;
  bSiga: Boolean;

  Array_MesesTotal: Array of Currency;
  sMes: String;
  iMes: Integer;
Begin
  //(ODIRK2) - INICIO - AtualizaValorObjetivosMetasMesesAvarias;
  //==========================================================//
  Array_MesesTotal:=nil;
  SetLength(Array_MesesTotal,205000);

  // Localiza Empresa na Planilha ==============================================
  iCodObj:= DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsInteger;
  sDesObj:= DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;
  if DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Realizado']),[]) Then
  Begin
    // Conecta Empresa =====================================================
    If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
     Begin
       bSiga:=True;
     End
    Else // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
     Begin
       If sgLojasNConectadas='' Then
        sgLojasNConectadas:=sDesObj+': Bel_'+sgCodEmp
       Else
        sgLojasNConectadas:=
         sgLojasNConectadas+cr+sDesObj+':  Bel_'+sgCodEmp;

       Refresh;
       bSiga:=False;
     End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then


    // Inicia Processamento ================================================
    If bSiga Then // Empresa Conectada
    Begin
      // Cria Query da Empresa --------------------------------------
      CriaQueryIB('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                  'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                  IBQ_ConsultaFilial, True, True);

      //(ODIRK2) - AtualizaValorObjetivosMetasMesesAvarias;
      //==================================================//
      // Busca Auditoria =======================================================
      MySql:=' Select'+
             ' Cast(lpad(extract(month from m.datacomprovante),2,''0'') as varchar(2))||''/''||'+
             ' Cast(lpad(extract(year  from m.datacomprovante),4,''0'') as varchar(4)) MesAno,'+

             ' Cast((Coalesce(Sum(case When m.codcomprovante=''015'' then'+
             '                          Coalesce(mp.valtotal,0.00) End),0.00))as numeric(12,2)) Tot_Comp_15,'+

             ' Cast(Coalesce(Sum(case When m.codcomprovante=''002'' then Coalesce(mp.valtotal,0.00) End),0.00)+'+
             '      Coalesce(Sum(case When m.codcomprovante=''007'' then Coalesce(mp.valtotal,0.00) End),0.00) as numeric(12,2)) Tot_Vendas,'+

             '  Cast(Coalesce(((Coalesce(Sum(case When m.codcomprovante=''015'' then Coalesce(mp.valtotal,0.00) End),0.00))*100)/'+
             '                 (Coalesce(Sum(case When m.codcomprovante=''002'' then Coalesce(mp.valtotal,0.00) End),0.00)+'+
             '                  Coalesce(Sum(case When m.codcomprovante=''007'' then Coalesce(mp.valtotal,0.00) End),0.00)'+
             '       ),0) as numeric(12,2)) Perc_Avarias'+

             ' From MCLI m, MCLIPRO mp';

              If not Rb_FinanObjetivosManutTpOperacaoAmbos.Checked Then
               MySql:=MySql+',PRODUTO p';

              MySql:=MySql+' Where m.chavenf=mp.chavenf';

              If not Rb_FinanObjetivosManutTpOperacaoAmbos.Checked Then
               MySql:=MySql+' and mp.codproduto=p.codproduto';

              If Rb_FinanObjetivosManutTpOperacaoLoja.Checked Then
               MySql:=MySql+' and p.principalfor not in (''000500'',''000883'')';

              If Rb_FinanObjetivosManutTpOperacaoSalao.Checked Then
               MySql:=MySql+' and p.principalfor in (''000500'',''000883'')';

              If Ckb_FinanObjetivosManutNaoCompra.Checked Then
               MySql:=MySql+' and Coalesce(p.situacaopro,1) in (1,3)';

              MySql:=MySql+' and m.codfilial='+QuotedStr(sgCodEmp)+
                           ' and ((m.codcomprovante in (''015'') and m.codcliente=''010050'')'+
                           '       or  (m.codcomprovante in (''002'',''007'')))'+
                           ' and m.datacomprovante '+f_Troca('/','.',f_Troca('-','.',sgPeriodo1))+

                           ' Group by'+
                           '    Cast(lpad(extract(year from m.datacomprovante),4,''0'') as varchar(4)),'+
                           '    Cast(lpad(extract(month from m.datacomprovante),2,''0'') as varchar(2))'+

                           ' Order by'+
                           '    Cast(lpad(extract(year  from m.datacomprovante),4,''0'') as varchar(4)),'+
                           '    Cast(lpad(extract(month from m.datacomprovante),2,''0'') as varchar(2))';
      IBQ_ConsultaFilial.SQL.Clear;
      IBQ_ConsultaFilial.SQL.Add(MySql); //(ODIRK2)
              
      // Abre Query --------------------------------------------
      ii:=0;
      bSiga:=False;
      While Not bSiga do
      Begin
        Try
          IBQ_ConsultaFilial.Open;
          bSiga:=True;
        Except
          Inc(ii);
        End; // Try

        If ii>10 Then
        Begin
          If sgLojasNConectadas='' Then
           sgLojasNConectadas:=sDesObj+': Bel_'+sgCodEmp
          Else
           sgLojasNConectadas:=
            sgLojasNConectadas+cr+sDesObj+':  Bel_'+sgCodEmp;
          Break;
        End; // If ii>10 Then
      End; // While Not bSiga do

      // Processamento =========================================================
      If bSiga Then // Query Executada
      Begin
        // Posiciona TabSheet ---------------------------------------
        PC_FinanObjetivos.TabIndex:=2;

        iOrdemMov:=0;
        cVlrAcumulado:=0;
        cVlrCalculado:=0;
        DMVirtual.CDS_V_ObjetivosMeses.Edit;
        While Not IBQ_ConsultaFilial.Eof do
        Begin
          Refresh;

          // Insere Movimentos para Pesquisa ----------------------
          Inc(iOrdemMov);      
          DMVirtual.CDS_V_ObjetivosMovtos.Insert;
          DMVirtual.CDS_V_ObjetivosMovtosORDEM.AsInteger:=iOrdemMov;
          DMVirtual.CDS_V_ObjetivosMovtosCOD_FILIAL.AsInteger:=DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsInteger;
          DMVirtual.CDS_V_ObjetivosMovtosCOD_OBJETIVO.AsInteger:=DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsInteger;
          DMVirtual.CDS_V_ObjetivosMovtosTIP_CALCULO.AsString:='M';
          DMVirtual.CDS_V_ObjetivosMovtosDATA.AsString:=IBQ_ConsultaFilial.FieldByName('MesAno').AsString;
          DMVirtual.CDS_V_ObjetivosMovtosTOT_COMP_15.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_COMP_15').AsCurrency;
          DMVirtual.CDS_V_ObjetivosMovtosTOT_VENDAS.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_VENDAS').AsCurrency;
          DMVirtual.CDS_V_ObjetivosMovtos.Post;

          // Anicializa Variaveis -----------------------------------
          sCampo:=IBQ_ConsultaFilial.FieldByName('MesAno').AsString;
          cVlrCalculado:=IBQ_ConsultaFilial.FieldByName('Perc_Avarias').AsCurrency;
          cVlrAcumulado:=cVlrAcumulado+cVlrCalculado;
          For ii:=6 to EdtFinanObjetivosMeses.AsInteger+5 do
          Begin
            If DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].DisplayLabel=sCampo Then
            Begin

            If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='SIM' Then
             Begin
               DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].AsCurrency:=cVlrCalculado;
               DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=cVlrCalculado+
                              DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency;
               Break;
             End
            Else
             Begin
               DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].AsCurrency:=cVlrAcumulado;
               DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=cVlrAcumulado;
               Break;
             End;
            End; // If DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].DisplayLabel=sCampo Then
          End; // For ii:=6 to EdtFinanObjetivosMeses.AsInteger+5 do

          // Guarda Valor Mes -----------------------------------------
          sMes:=f_Troca('/','',sCampo);
          sMes:=copy(sMes,3,4)+copy(sMes,1,2);
          iMes:=StrToInt(sMes);
          Array_MesesTotal[iMes]:=cVlrCalculado;

          IBQ_ConsultaFilial.Next;
        End; // While Not IBQ_ConsultaFilial.Eof do
        DMVirtual.CDS_V_ObjetivosMeses.Post;
        
      End; // If bSiga Then // Query Executada
    End; //If bSiga Then // Empresa Conectada
  End; // if DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Realizado']),[]) Then

  // Acerta Valores dos Meses ==================================================
  if DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Ms']),[]) Then
  Begin
    For i:=Low(Array_MesesTotal) to High(Array_MesesTotal) do
    Begin
      If Array_MesesTotal[i]<>0 Then
      Begin
        sCampo:=IntToStr(i);
        sCampo:=copy(sCampo,5,2)+'/'+copy(sCampo,1,4);

        // Loaliza Nome do Campo a Atualizar na Planilha --------
        For ii:=0 to DMVirtual.CDS_V_ObjetivosMeses.Fields.Count-1 do
        Begin
          If DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].DisplayName=sCampo Then
          Begin
            sCampo:=DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].FieldName;
            Break;
          End;
        End; // For i:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do

        // Atualiza Valor Meses ------------------------------
        DMVirtual.CDS_V_ObjetivosMeses.Edit;
        DMVirtual.CDS_V_ObjetivosMeses.FieldByName(sCampo).AsCurrency:=Array_MesesTotal[i];

//        If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='SIM' Then
         DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=Array_MesesTotal[i]+
                               DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency;
//        Else
//         DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=Array_MesesTotal[i];

        DMVirtual.CDS_V_ObjetivosMeses.Post;
      End; // If Array_Campos[i]<>'' Then
    End; // For i:=Low(Array_MesesTotal) to High(Array_MesesTotal) do
  End; // if DMVirtual.CDS_V_ObjetivosMeses.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Ms']),[]) Then

End; // Objetivos/Metas Meses - Atualiza Avarias >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Objetivos/Metas Meses - Atualiza Auditoria >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AtualizaValorObjetivosMetasMesesAuditoria;
Var
  MySql: String;
  i, iOrdem: Integer;
  cPerAdimssAcum, cVlrAdmissAcum, cVlrEstFinalAcum,
  cPerRealizado, cPerPercentual: Currency;
  s: String;
Begin

  MySql:=' Select FIRST 12'+
         ' au.COD_LOJA, emp.RAZAO_SOCIAL, au.DTA_AUDITORIA,'+
         ' au.PER_ADMISSIVEL,'+
         ' au.PER_ADMISSIVEL || '' a '' ||(au.PER_ADMISSIVEL*-1) Limite_Objetivo,'+
         ' au.PER_PERDA_FINAL REALIZADO,'+
         ' au.PER_OBJ_PER_ADMISSIVEL Percentual,'+
         ' Case'+
         '   When au.PER_OBJ_PER_ADMISSIVEL>=-100 and au.PER_OBJ_PER_ADMISSIVEL<=100 Then ''A'''+
         '   Else ''V'''+
         ' End Situacao,'+
         ' au.VLR_PERDA_EQUIVALENTE, au.VLR_EST_INICIAL'+

         ' From  AUDITORIAS au, EMP_CONEXOES emp'+

         ' Where au.cod_loja=emp.cod_filial'+
         ' and au.Cod_Loja='+QuotedStr(sgCodEmp)+

         ' Order by au.Dta_Auditoria desc';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.IndexFieldNames:='DTA_AUDITORIA';
    DMBelShop.CDS_BuscaRapida.Open;

    // Posiciona TabSheet e Busca Ordem de Apresentao ========================
    PC_FinanObjetivos.TabIndex:=3;

    DMVirtual.CDS_V_ObjetivosAuditorias.Last;
    If DMVirtual.CDS_V_ObjetivosAuditorias.RecNo<1 Then
     iOrdem:=1
    Else
     iOrdem:=DMVirtual.CDS_V_ObjetivosAuditorias.RecNo+1;

    // Loja COM e SEM Auditoria ================================================
    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Loja').AsString)<>'' Then
     Begin
       // Loja Com Auditoria =========================================

       // Linha Em Branco --------------------------------------------
       DMVirtual.CDS_V_ObjetivosAuditorias.Insert;
       DMVirtual.CDS_V_ObjetivosAuditoriasORDEM.AsInteger:=iOrdem;
       DMVirtual.CDS_V_ObjetivosAuditorias.Post;
     End
    Else // If Not DMBelShop.CDS_BuscaRapida.Eof do
     Begin
       // Loja Sem Auditoria =========================================
       MySql:=' Select emp.COD_FILIAL, emp.RAZAO_SOCIAL'+
              ' From  EMP_CONEXOES emp'+
              ' Where emp.cod_filial='+QuotedStr(sgCodEmp);
       DMBelShop.CDS_BuscaRapida.IndexFieldNames:='';
       DMBelShop.CDS_BuscaRapida.Close;
       DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
       DMBelShop.CDS_BuscaRapida.Open;

       // Linha Em Branco --------------------------------------------
       DMVirtual.CDS_V_ObjetivosAuditorias.Insert;
       DMVirtual.CDS_V_ObjetivosAuditoriasORDEM.AsInteger:=iOrdem;
       DMVirtual.CDS_V_ObjetivosAuditorias.Post;

       inc(iOrdem);

       // Insere Loja Sem Auditoria ===================================
       DMVirtual.CDS_V_ObjetivosAuditorias.Append;
       DMVirtual.CDS_V_ObjetivosAuditoriasORDEM.AsInteger:=iOrdem;

       DMVirtual.CDS_V_ObjetivosAuditoriasDES_OBJETIVO.AsString:='AUDITORIA';
       DMVirtual.CDS_V_ObjetivosAuditoriasDES_LOJA.AsString:=
                 DMBelShop.CDS_BuscaRapida.FieldByName('Razao_Social').AsString;

       DMVirtual.CDS_V_ObjetivosAuditoriasCOD_LOJA.AsString:=
                   DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Filial').AsString;
       DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString:=
                    DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
       DMVirtual.CDS_V_ObjetivosAuditoriasLIMITE_OBJETIVO.AsString:='Loja SEM Auditoria';
       DMVirtual.CDS_V_ObjetivosAuditoriasREALIZADO.AsCurrency:=0.00;
       DMVirtual.CDS_V_ObjetivosAuditoriasPERCENTUAL.AsCurrency:=0.00;
       DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString:='V';
       DMVirtual.CDS_V_ObjetivosAuditorias.Post;

       DMBelShop.CDS_BuscaRapida.Close;
       Exit;
     End; // If Not DMBelShop.CDS_BuscaRapida.Eof do

    // Gera Auditoria ==========================================================
    cPerAdimssAcum  :=0;
    cPerAdimssAcum  :=0;
    cVlrAdmissAcum  :=0;
    cVlrEstFinalAcum:=0;

    DMBelShop.CDS_BuscaRapida.Last;
    i:=DMBelShop.CDS_BuscaRapida.RecNo;

    DMBelShop.CDS_BuscaRapida.First;
    While Not DMBelShop.CDS_BuscaRapida.Eof do
    Begin
      Refresh;

      inc(iOrdem);

      DMVirtual.CDS_V_ObjetivosAuditorias.Append;
      DMVirtual.CDS_V_ObjetivosAuditoriasORDEM.AsInteger:=iOrdem;

      If DMBelShop.CDS_BuscaRapida.RecNo=1 Then
      Begin
        DMVirtual.CDS_V_ObjetivosAuditoriasDES_OBJETIVO.AsString:='AUDITORIA';
        DMVirtual.CDS_V_ObjetivosAuditoriasDES_LOJA.AsString:=
                 DMBelShop.CDS_BuscaRapida.FieldByName('Razao_Social').AsString;
      End;

      DMVirtual.CDS_V_ObjetivosAuditoriasCOD_LOJA.AsString:=
                     DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Loja').AsString;
      DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString:=
                DMBelShop.CDS_BuscaRapida.FieldByName('Dta_Auditoria').AsString;
      DMVirtual.CDS_V_ObjetivosAuditoriasLIMITE_OBJETIVO.AsString:=
              DMBelShop.CDS_BuscaRapida.FieldByName('Limite_Objetivo').AsString;
      DMVirtual.CDS_V_ObjetivosAuditoriasREALIZADO.AsString:=
                    DMBelShop.CDS_BuscaRapida.FieldByName('Realizado').AsString;
      DMVirtual.CDS_V_ObjetivosAuditoriasPERCENTUAL.AsString:=
                   DMBelShop.CDS_BuscaRapida.FieldByName('Percentual').AsString;
      DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString:=
                     DMBelShop.CDS_BuscaRapida.FieldByName('Situacao').AsString;

      DMVirtual.CDS_V_ObjetivosAuditorias.Post;

      // Acumulados para Totais da Empresa ----------------------------
      cPerAdimssAcum  :=cPerAdimssAcum+DMBelShop.CDS_BuscaRapida.FieldByName('Per_Admissivel').AsCurrency;
      cVlrAdmissAcum  :=cVlrAdmissAcum+DMBelShop.CDS_BuscaRapida.FieldByName('Vlr_Perda_Equivalente').AsCurrency;
      cVlrEstFinalAcum:=cVlrEstFinalAcum+DMBelShop.CDS_BuscaRapida.FieldByName('Vlr_Est_Inicial').AsCurrency;

      // Acumulados para Totais Geral da Empresa ----------------------
      cgVlrAcumulado1:=cgVlrAcumulado1+DMBelShop.CDS_BuscaRapida.FieldByName('Per_Admissivel').AsCurrency;
      cgVlrAcumulado2:=cgVlrAcumulado2+DMBelShop.CDS_BuscaRapida.FieldByName('Vlr_Perda_Equivalente').AsCurrency;
      cgVlrAcumulado3:=cgVlrAcumulado3+DMBelShop.CDS_BuscaRapida.FieldByName('Vlr_Est_Inicial').AsCurrency;
      igTotInteiro   :=igTotInteiro+1;

      DMBelShop.CDS_BuscaRapida.Next;
    End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
    DMBelShop.CDS_BuscaRapida.IndexFieldNames:='';
    DMBelShop.CDS_BuscaRapida.Close;

    // Total da Empresa ========================================================
    // Percentual Total Admissivel ----------------------------------
    s:=CurrToStr(RoundTo((cPerAdimssAcum/i),-2));
    s:=ZerosCentavos(s,2);
    cPerAdimssAcum:=StrToCurr(s);

    // Percentual Total Realizado -----------------------------------
    cPerRealizado:=RoundTo(((cVlrAdmissAcum*100)/cVlrEstFinalAcum),-2);

    // Percentual Total Sobre oAdmissivel ---------------------------
    cPerPercentual:=RoundTo(((cPerRealizado*100)/cPerAdimssAcum),-2);

    inc(iOrdem);

    DMVirtual.CDS_V_ObjetivosAuditorias.Append;
    DMVirtual.CDS_V_ObjetivosAuditoriasORDEM.AsInteger:=iOrdem;
    DMVirtual.CDS_V_ObjetivosAuditoriasCOD_LOJA.AsString:=sgCodEmp;
    DMVirtual.CDS_V_ObjetivosAuditoriasDES_LOJA.AsString:='TOTAL DA LOJA';
    DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString:=
                    DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
    DMVirtual.CDS_V_ObjetivosAuditoriasLIMITE_OBJETIVO.AsString:=s+' a -'+s;
    DMVirtual.CDS_V_ObjetivosAuditoriasREALIZADO.AsCurrency:=cPerRealizado;
    DMVirtual.CDS_V_ObjetivosAuditoriasPERCENTUAL.AsCurrency:=cPerPercentual;

    If (cPerPercentual>=-100) and (cPerPercentual<=100) Then
     DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString:='A'
    Else
     DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString:='V';

    DMVirtual.CDS_V_ObjetivosAuditorias.Post;

End; // Objetivos/Metas Meses - Atualiza Auditoria >>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Objetivos/Metas Meses - Calcula Objetivos/Metas das Empresa >>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CaluclaObjetivosMetasMeses;
Begin

  // Processa Empresas Selecionadas ============================================
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      igCodLojaLinx  :=DMBelShop.CDS_EmpProcessaCOD_LINX.AsInteger;
      sgDtaComecoLinx:=DMBelShop.CDS_EmpProcessaDTA_INICIO_LINX.AsString;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sgCodEmp+' - '+
                                 DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Processa Objetivos ====================================================
      DMBelShop.CDS_Objetivos.First;
      While Not DMBelShop.CDS_Objetivos.Eof do
      Begin
        Refresh;

        If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) Then
        Begin

          If Ckb_FinanObjetivosManutAuditoria.Checked Then // Calcula Valores na Empresa (Auditoria) --------------------
           Begin
             bgAuditoria:=True;
             AtualizaValorObjetivosMetasMesesAuditoria;
           End
          Else If Ckb_FinanObjetivosManutAvarias.Checked Then // Calcula Valores na Empresa (Avarias/Vencidos) ----------
           Begin
             AtualizaValorObjetivosMetasMesesAvarias;
           End
          Else If DMBelShop.CDS_ObjetivosULT_12_MESES.AsString='SIM' Then // Calcula Objetivos 12 Meses para Outros -----
           Begin
             AtualizaValorObjetivosMetasMesesOutros;
           End;

        End; // If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) and

        DMBelShop.CDS_Objetivos.Next;
      End; // While Not DMBelShop.CDS_Objetivos.Eof do

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    // Apresenta o Processamento ------------------------------------
    OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
    Refresh;

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do
  Memo2.Width:=50;

  // Auditoria Total Geral da Empresa ==========================================
  If bgAuditoria Then
   AuditoriaTotalEmpresa;
End; // Objetivos/Metas Meses - Calcula Objetivos/Metas das Empresa por Meses >>

// Monta Planilha de Objetivos por Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MontaPlanilhaObjetivosMeses(Var iIndicePlanMeses: Integer);
Var
  i: Integer;
  cVlrObjTotal, cVlrObjAcumula: Currency;
  cVlrObj1, cVlrObj2, cVlrObj3, cVlrObj4, cVlrObj5, cVlrObj6: Currency;
  cVlrObj7, cVlrObj8, cVlrObj9, cVlrObj10, cVlrObj11, cVlrObj12: Currency;
  MySql: string;
  sMes, sAno: String; 
Begin

  // Linha em Branco ----------------------------------------
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;

  // Insere Empresas ============================================
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Cabecalho do Objetivo ---------------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Insert;
      DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosMesesDes_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;

      cVlrObjTotal:=0;
      cVlrObjAcumula:=0;
      cVlrObj1:=0;
      cVlrObj2:=0;
      cVlrObj3:=0;
      cVlrObj4:=0;
      cVlrObj5:=0;
      cVlrObj6:=0;
      cVlrObj7:=0;
      cVlrObj8:=0;
      cVlrObj9:=0;
      cVlrObj10:=0;
      cVlrObj11:=0;
      cVlrObj12:=0;
      For i:=6 to EdtFinanObjetivosMeses.AsInteger+5 do
      Begin
        sMes:=Copy(DMVirtual.CDS_V_ObjetivosMeses.Fields[i].DisplayLabel,1,2);
        sAno:=Copy(DMVirtual.CDS_V_ObjetivosMeses.Fields[i].DisplayLabel,4,4);
        
        MySql:=' Select  coalesce(ob.obj_mes'+sMes+',0) Objetivo'+
               ' From FIN_OBJETIVOS_METAS ob'+
               ' where ob.cod_filial='+QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString)+
               ' And ob.cod_objetivo='+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString+
               ' And ob.des_ano='+sAno;
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;

        DMVirtual.CDS_V_ObjetivosMesesVlr_Objetivo.AsCurrency:=0;
        If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsString)<>'' Then
        Begin
          cVlrObjTotal:=cVlrObjTotal+DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;

          If i=6  Then cVlrObj1 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=7  Then cVlrObj2 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=8  Then cVlrObj3 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=9  Then cVlrObj4 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=10 Then cVlrObj5 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=11 Then cVlrObj6 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=12 Then cVlrObj7 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=13 Then cVlrObj8 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=14 Then cVlrObj9 :=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=15 Then cVlrObj10:=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=16 Then cVlrObj11:=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
          If i=17 Then cVlrObj12:=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
        End;
        DMBelShop.CDS_BuscaRapida.Close;
      End;

      DMVirtual.CDS_V_ObjetivosMesesVlr_Objetivo.AsCurrency:=cVlrObjTotal;
      DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Ult.12 Meses';
      DMVirtual.CDS_V_ObjetivosMesesDes_Empresa.AsString:='Bel_'+
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      inc(iIndicePlanMeses);
      DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
      DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Cria Linha de Objetivo ---------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Insert;
      DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:=
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Objetivo';

      // Acerta Valores do Objetivo -----------------------------
      For i:=6 to EdtFinanObjetivosMeses.AsInteger+5 do
      Begin
        If DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Visible Then
         Begin
          If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='NAO' Then
           Begin
             If i=6  Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj1;
             If i=7  Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj2;
             If i=8  Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj3;
             If i=9  Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj4;
             If i=10 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj5;
             If i=11 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj6;
             If i=12 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj7;
             If i=13 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj8;
             If i=14 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj9;
             If i=15 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj10;
             If i=16 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj11;
             If i=17 Then cVlrObjAcumula:=cVlrObjAcumula+cVlrObj12;
             DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObjAcumula;
           End
          Else // If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='NAO' Then
           Begin
             If i=6  Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj1;
             If i=7  Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj2;
             If i=8  Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj3;
             If i=9  Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj4;
             If i=10 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj5;
             If i=11 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj6;
             If i=12 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj7;
             If i=13 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj8;
             If i=14 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj9;
             If i=15 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj10;
             If i=16 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj11;
             If i=17 Then DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=cVlrObj12;
           End; // If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='NAO' Then
          End
        Else // If DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Visible Then
         Begin
           DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;
         End; // If DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Visible Then 
      End; // For i:=6 to EdtFinanObjetivosMeses.AsInteger+5 do // Acerta Valores do Objetivo

      DMVirtual.CDS_V_ObjetivosMesesVlr_Empresa.AsCurrency:=cVlrObjTotal;
      inc(iIndicePlanMeses);
      DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
      DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Cria Linha de Realizado --------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Insert;
      DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:=
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Realizado';

      For i:=6 to 18 do
       DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

      inc(iIndicePlanMeses);
      DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
      DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Cria Linha de Resultado ----------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Insert;
      DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:=
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Resultado';

      For i:=6 to 18 do
       DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

      inc(iIndicePlanMeses);
      DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
      DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Cria Linha de Percentual do Resultado ------------------
      DMVirtual.CDS_V_ObjetivosMeses.Insert;
      DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:=
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Percentual';

      For i:=6 to 18 do
       DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

      inc(iIndicePlanMeses);
      DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
      DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Cria Linha de Meses ------------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Insert;
      DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:=
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Ms';

      For i:=6 to 18 do
       DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

      inc(iIndicePlanMeses);
      DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
      DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosMeses.Post;

      // Linha em Branco ----------------------------------------
      DMVirtual.CDS_V_ObjetivosMeses.Insert;
      inc(iIndicePlanMeses);
      DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
      DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosMeses.Post;
          
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  // Total Empresa =============================================================
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosMesesDes_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosMesesDes_Empresa.AsString:='Empresa';
  DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Ult.12 Meses';

  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;
  
  // Cria Linha de Objetivo --------------------------------
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Objetivo';

  For i:=6 to 18 do
   DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;

  // Cria Linha de Realizado --------------------------------
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Realizado';

  For i:=6 to 18 do
   DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;

  // Cria Linha de Resultado ----------------------------
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Resultado';

  For i:=6 to 18 do
   DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;

  // Cria Linha de Percentual do Resultado ------------------
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Percentual';

  For i:=6 to 18 do
   DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;
  
  // Cria Linha de Meses ------------------------------------
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosMesesCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosMesesTipo.AsString:='Ms';

  For i:=6 to 18 do
   DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Value:=0;

  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;

  // Linha em Branco ----------------------------------------
  DMVirtual.CDS_V_ObjetivosMeses.Insert;
  inc(iIndicePlanMeses);
  DMVirtual.CDS_V_ObjetivosMesesINDICE.AsInteger:=iIndicePlanMeses;
  DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosMeses.Post;

End; // Monta Planilha de Objetivos por Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Monta Planilha de Objetivos por Dias >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MontaPlanilhaObjetivosDias(sDiaSemanaMes: string; iNumDiasUteis: Integer; Var iIndicePlan: Integer);
Var      
  i, iIndexUltDia: Integer;
  sVlrObjetivoDia: String;
  cVlrObjetivoDia, cVlrObjetivo: Currency;
  MySql: string;
Begin

  // Linha em Branco ----------------------------------------
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;

  // Insere Empresas ============================================
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Cabecalho do Objetivo ---------------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Insert;
      DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosDiasDes_Objetivo.AsString:=
                                   DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;

      sVlrObjetivoDia:='0';
      cVlrObjetivoDia:=0;
      cVlrObjetivo:=0;
      MySql:=' Select coalesce(ob.obj_mes'+sDiaSemanaMes+',0) Objetivo,'+
             '       Round((coalesce(ob.obj_mes'+sDiaSemanaMes+',0)/'+IntToStr(iNumDiasUteis)+'),2) Objetivo_Dia'+
             ' From FIN_OBJETIVOS_METAS ob'+
             ' where ob.cod_filial='+QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString)+
             ' And ob.cod_objetivo='+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString+
             ' And ob.des_ano='+VarToStr(EdtFinanObjetivosGerarAno.Value);
      DMBelShop.CDS_BuscaRapida.Close;
      DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
      DMBelShop.CDS_BuscaRapida.Open;
          
      DMVirtual.CDS_V_ObjetivosDiasVlr_Objetivo.AsCurrency:=0;
      If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsString)<>'' Then
      Begin
        sVlrObjetivoDia:=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo_Dia').AsString;
        cVlrObjetivo:=DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;

        DMVirtual.CDS_V_ObjetivosDiasVlr_Objetivo.AsCurrency:=
               DMBelShop.CDS_BuscaRapida.FieldByName('Objetivo').AsCurrency;
      End;
      DMBelShop.CDS_BuscaRapida.Close;

      DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:=
                               ShortMonthNames[strToInt(sDiaSemanaMes)]+'/'+
                                  VarToStr(EdtFinanObjetivosGerarAno.Value);
      DMVirtual.CDS_V_ObjetivosDiasDes_Empresa.AsString:='Bel_'+
                               DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      inc(iIndicePlan);
      DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
      DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosDias.Post;
         
      // Cria Linha de Objetivo ---------------------------------
      cVlrObjetivoDia:=StrToCurr(sVlrObjetivoDia);

      DMVirtual.CDS_V_ObjetivosDias.Insert;
      DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                               DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:=
                               DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Objetivo';

      // Verifica o Ultimo Dia do Mes no CDS_V_Objetivos ===================
      For i:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do
      Begin
        If DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible Then
         iIndexUltDia:=i; 
      End; // For i:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do

      // Acerta Valores do Objetivo -----------------------------
      For i:=6 to 36 do
      Begin
        If DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible Then
         Begin
           If i<iIndexUltDia Then
            Begin
              If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='NAO' Then
               DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=cVlrObjetivoDia
              Else
               DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=cVlrObjetivo;

               cVlrObjetivoDia:=cVlrObjetivoDia+StrToCurr(sVlrObjetivoDia);
            End
           Else // If i<36 Then
            Begin
              DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=cVlrObjetivo;
            End; //If i<36 Then
         End
        Else // If DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible Then
         Begin
           DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;
         End; // If DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible Then 
      End; // For i:=6 to 36 do // Acerta Valores do Objetivo
  
      inc(iIndicePlan);
      DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
      DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosDias.Post;
                                          
      // Cria Linha de Realizado --------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Insert;
      DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                               DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:=
                               DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Realizado';

      For i:=6 to 36 do
       DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

      inc(iIndicePlan);
      DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
      DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosDias.Post;

      // Cria Linha de Resultado ----------------------------
      DMVirtual.CDS_V_ObjetivosDias.Insert;
      DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                               DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:=
                               DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Resultado';

      For i:=6 to 36 do
       DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

      inc(iIndicePlan);
      DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
      DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosDias.Post;

      // Cria Linha de Percentual do Resultado ------------------
      DMVirtual.CDS_V_ObjetivosDias.Insert;
      DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                               DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:=
                               DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Percentual';

      For i:=6 to 36 do
       DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

      inc(iIndicePlan);
      DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
      DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosDias.Post;

      // Cria Linha de Diario ------------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Insert;
      DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                               DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
      DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:=
                               DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Dirio';

      For i:=6 to 36 do
       DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

      inc(iIndicePlan);
      DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
      DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosDias.Post;

      // Linha em Branco ----------------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Insert;
      inc(iIndicePlan);
      DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
      DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
      DMVirtual.CDS_V_ObjetivosDias.Post;
          
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
      
    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  // Total Empresa =============================================================
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                                 DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosDiasDes_Objetivo.AsString:=
                                 DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosDiasDes_Empresa.AsString:='Empresa';
  DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:=
                                   ShortMonthNames[strToInt(sDiaSemanaMes)]+'/'+
                                      VarToStr(EdtFinanObjetivosGerarAno.Value);

  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;
  
  // Cria Linha de Objetivo --------------------------------
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                                 DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Objetivo';

  For i:=6 to 36 do
   DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;

  // Cria Linha de Realizado --------------------------------
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                                 DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Realizado';

  For i:=6 to 36 do
   DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;

  // Cria Linha de Resultado ----------------------------
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                                 DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Resultado';

  For i:=6 to 36 do
   DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;

  // Cria Linha de Percentual do Resultado ------------------
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                                 DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Percentual';

  For i:=6 to 36 do
   DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;

  // Cria Linha de Diario -----------------------------------
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString:=
                                 DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString:='9999';
  DMVirtual.CDS_V_ObjetivosDiasTipo.AsString:='Dirio';

  For i:=6 to 36 do
   DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value:=0;

  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;

  // Linha em Branco ----------------------------------------
  DMVirtual.CDS_V_ObjetivosDias.Insert;
  inc(iIndicePlan);
  DMVirtual.CDS_V_ObjetivosDiasINDICE.AsInteger:=iIndicePlan;
  DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
  DMVirtual.CDS_V_ObjetivosDias.Post;
  
End; // // Monta Planilha de Objetivos por Dias >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Apresenta Grafico de Objetivos/Metas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.ApresentaGraficoObjetivosMetas;
Var
  i: Integer;
  sTipoGrafico: String;  
  sCodObjetivo, sTipoObjetivo, sMesObjetivo, sVlrObjetivo: String;
Begin
    // Cria Serie do Grafico ===================================================
    If Rb_FinanObjetivosGraficoTpBarras.Checked Then
    Begin
      gsBarra:=TBarSeries.Create(Self);
      sTipoGrafico:='B';
    End;

    If Rb_FinanObjetivosGraficoTpLinha.Checked Then
    Begin
      gsLinha:=TLineSeries.Create(Self);
      sTipoGrafico:='L';
    End;

    If Rb_FinanObjetivosGraficoTpPizza.Checked Then
    Begin
      gsPizza:=TPieSeries.Create(Self);
      sTipoGrafico:='P';
    End;

    // Busca Dados do Objetivo =================================================
    i:=pos(' - ',Cbx_FinanObjetivosGraficoObjetivos.Text);
    sCodObjetivo:=Trim(Copy(Cbx_FinanObjetivosGraficoObjetivos.Text,i+3,Length(Cbx_FinanObjetivosGraficoObjetivos.Text)));
    DMBelShop.CDS_Objetivos.Locate('COD_OBJETIVO',sCodObjetivo,[]);
    sTipoObjetivo:=DMBelShop.CDS_ObjetivosIND_FIXO.AsString;

    // Localiza Objetivo da Empresas ===========================================
    If Cbx_FinanObjetivosGraficoEmpresas.Text<>'Empresa' Then
     Begin
      i:=pos('_',Cbx_FinanObjetivosGraficoEmpresas.Text);
      sCodFilial:=Trim(Copy(Cbx_FinanObjetivosGraficoEmpresas.Text,i+1,Length(Cbx_FinanObjetivosGraficoEmpresas.Text)));
     End
    Else // If Cbx_FinanObjetivosGraficoEmpresas.Text<>'Empresa' Then
     Begin
       sCodFilial:='9999';
     End; // If Cbx_FinanObjetivosGraficoEmpresas.Text<>'Empresa' Then
    
    // Objetivos de Apresentao em Dias =======================================
    If (Not Ckb_FinanObjetivosManutAuditoria.Checked) and (Not Ckb_FinanObjetivosManutAvarias.Checked) and 
       (Not Ckb_FinanObjetivosManutUlt12Meses.Checked) Then
    Begin
      DMVirtual.CDS_V_ObjetivosDias.Locate('COD_OBJETIVO;COD_EMP;TIPO',
                           VarArrayOf([sCodObjetivo, sCodFilial, 'Objetivo']),[]);
      DMVirtual.CDS_V_ObjetivosDias.Prior;
      sMesObjetivo:=DMVirtual.CDS_V_ObjetivosDiasTipo.AsString;
      sVlrObjetivo:=DMVirtual.CDS_V_ObjetivosDiasVlr_Objetivo.AsString;
                         
      // Posiciona no Objetivo --------------------------------------
      If (Cbx_FinanObjetivosGraficoTpApres.Text='Percentual') Or (Cbx_FinanObjetivosGraficoTpApres.Text='Descrio/Percentual') Then
       DMVirtual.CDS_V_ObjetivosDias.Locate('COD_OBJETIVO;COD_EMP;TIPO',
                          VarArrayOf([sCodObjetivo, sCodFilial, 'Percentual']),[])
      Else
       DMVirtual.CDS_V_ObjetivosDias.Locate('COD_OBJETIVO;COD_EMP;TIPO',
                          VarArrayOf([sCodObjetivo, sCodFilial, 'Resultado']),[]);

      // Apresenta o Grafico ----------------------------------------
      GraficoObjetivos(DbGrafico_FinanObjetivosGrafico, DMVirtual.CDS_V_ObjetivosDias, sTipoGrafico, 
                       'Empresa: '+Cbx_FinanObjetivosGraficoEmpresas.Text+' - '+
                       Cbx_FinanObjetivosGraficoObjetivos.Text+' (Fixo='+sTipoObjetivo+')'+
                       ' - '+sMesObjetivo+' (Apresentao: '+Cbx_FinanObjetivosGraficoTpApres.Text+')','', '');
    End; // If (Not Ckb_FinanObjetivosManutAuditoria.Checked) and (Not Ckb_FinanObjetivosManutAvarias.Checked) Then

    // Objetivos de Apresentao em Meses ======================================
    If (Ckb_FinanObjetivosManutAvarias.Checked or Ckb_FinanObjetivosManutUlt12Meses.Checked) Then
    Begin
      DMVirtual.CDS_V_ObjetivosMeses.Locate('COD_OBJETIVO;COD_EMP;TIPO',
                           VarArrayOf([sCodObjetivo, sCodFilial, 'Objetivo']),[]);
      DMVirtual.CDS_V_ObjetivosMeses.Prior;
      sMesObjetivo:=DMVirtual.CDS_V_ObjetivosMesesTipo.AsString;
      sVlrObjetivo:=DMVirtual.CDS_V_ObjetivosMesesVlr_Objetivo.AsString;
                         
      // Posiciona no Objetivo --------------------------------------
      If (Cbx_FinanObjetivosGraficoTpApres.Text='Percentual') Or (Cbx_FinanObjetivosGraficoTpApres.Text='Descrio/Percentual') Then
       DMVirtual.CDS_V_ObjetivosMeses.Locate('COD_OBJETIVO;COD_EMP;TIPO',
                          VarArrayOf([sCodObjetivo, sCodFilial, 'Percentual']),[])
      Else
       DMVirtual.CDS_V_ObjetivosMeses.Locate('COD_OBJETIVO;COD_EMP;TIPO',
                          VarArrayOf([sCodObjetivo, sCodFilial, 'Resultado']),[]);
                       
      // Apresenta o Grafico ----------------------------------------
      GraficoObjetivos(DbGrafico_FinanObjetivosGrafico, DMVirtual.CDS_V_ObjetivosMeses, sTipoGrafico, 
                       'Empresa: '+Cbx_FinanObjetivosGraficoEmpresas.Text+' - '+
                       Cbx_FinanObjetivosGraficoObjetivos.Text+' (Fixo='+sTipoObjetivo+')'+
                       ' - '+sMesObjetivo+' (Apresentao: '+Cbx_FinanObjetivosGraficoTpApres.Text+')','', '');
    End; // If (Ckb_FinanObjetivosManutAuditoria.Checked) Or (Ckb_FinanObjetivosManutAvarias.Checked) Then

    // Objetivos de Apresentao Auditoria =====================================
    If Ckb_FinanObjetivosManutAuditoria.Checked Then
    Begin
      DMVirtual.CDS_V_ObjetivosAuditorias.Locate('COD_LOJA',sCodFilial,[]);
                         
      // Apresenta o Grafico ----------------------------------------
      GraficoObjetivos(DbGrafico_FinanObjetivosGrafico, DMVirtual.CDS_V_ObjetivosAuditorias, sTipoGrafico,
                       'Empresa: '+Cbx_FinanObjetivosGraficoEmpresas.Text+' - '+
                       Cbx_FinanObjetivosGraficoObjetivos.Text+' (Fixo='+sTipoObjetivo+')'+
                       ' - '+sMesObjetivo+' (Apresentao: '+Cbx_FinanObjetivosGraficoTpApres.Text+')','', '');
    End; // If (Ckb_FinanObjetivosManutAuditoria.Checked) Or (Ckb_FinanObjetivosManutAvarias.Checked) Then
    
End; // Apresenta Grafico de Objetivos/Metas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Fecha Series de Graficos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.FechaSeriesGraficos;
Begin
  // Series do Grafico de Objetivos ============================================
  Try
    If gsBarra<>nil Then
     FreeAndNil(gsBarra); 
  Except
  End;
    
  Try
    If gsLinha<>nil Then
     FreeAndNil(gsLinha); 
  Except
  End;

  Try
    If gsPizza<>nil Then
     FreeAndNil(gsPizza); 
  Except
  End;
End; // Fecha Series de Graficos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Gera Grafico de Objetivos ( TipoGraf=(B)arras (L)inha (P)izza ) >>>>>>>>>>>>>
Procedure TFrmBelShop.GraficoObjetivos(DBGrafico: TDBChart; CDS: TClientDataSet; TipoGraf, Titulo, Descr, Valor: String);
Var
  Cor: TColor;
  i: Integer;
  cVlrTipoAuditoria: Currency;
Begin

  // Acerta Grafico ============================================================
  DbGrafico_FinanObjetivosGrafico.SeriesList.Clear;
  DbGrafico_FinanObjetivosGrafico.AxisVisible:=True;

  // Cor e Largura da Lateral --------------------------------------------------
  DbGrafico_FinanObjetivosGrafico.LeftWall.Brush.Color:=clDefault;
  DbGrafico_FinanObjetivosGrafico.LeftWall.Brush.Style:=bsSolid;
  DbGrafico_FinanObjetivosGrafico.LeftWall.Color:=$0080FFFF;
  DbGrafico_FinanObjetivosGrafico.LeftWall.Pen.Width:=2;
  DbGrafico_FinanObjetivosGrafico.LeftWall.Dark3D:=True; // Lateral Solida

// odiraqui ////////////////////////////
//  DbGrafico_FinanObjetivosGrafico.LeftAxis.Automatic:=False;
//  DbGrafico_FinanObjetivosGrafico.LeftAxis.Maximum:=45;
//  DbGrafico_FinanObjetivosGrafico.LeftAxis.Minimum:=-30;
  ////////////////////////////////////////

  DbGrafico_FinanObjetivosGrafico.BottomWall.Brush.Color:=clDefault;
  DbGrafico_FinanObjetivosGrafico.BottomWall.Brush.Style:=bsSolid;
  DbGrafico_FinanObjetivosGrafico.BottomWall.Color:=$0080FFFF;
  DbGrafico_FinanObjetivosGrafico.BottomWall.Pen.Width:=2;
  DbGrafico_FinanObjetivosGrafico.BottomWall.Dark3D:=True; // Lateral Solida

  DbGrafico_FinanObjetivosGrafico.Color:=clAqua;
  DbGrafico_FinanObjetivosGrafico.View3DWalls:=True; // 3D nas Laterais

//  DbGrafico_FinanObjetivosGrafico.BottomAxis.MinorTicks.Visible:=True; // ??????
  
  // Linhas Laterais, Cho e Fundo ---------------------------------------------
  DbGrafico_FinanObjetivosGrafico.LeftAxis.Grid.Visible:=True;
  DbGrafico_FinanObjetivosGrafico.BottomAxis.Grid.Visible:=True;

  // 3D ------------------------------------------------------------------------
  DbGrafico_FinanObjetivosGrafico.View3D:=False;
  If Ckb_FinanObjetivosGrafico3D.Checked Then
  Begin
    DbGrafico_FinanObjetivosGrafico.View3D:=True;
    DbGrafico_FinanObjetivosGrafico.View3DOptions.Orthogonal:=True;
  End;

  // Titulo --------------------------------------------------------------------
  DbGrafico_FinanObjetivosGrafico.Title.Text.Clear;
  DbGrafico_FinanObjetivosGrafico.Title.Text.Add(Titulo);

  Sb_FinanObjetivosGrafico3D.Enabled:=Ckb_FinanObjetivosGrafico3D.Checked;

  // Movimento do Mouse ========================================================
  Ckb_FinanObjetivosGraficoMouseClick(self);

  // Cria Serie (Barras) =======================================================
  If TipoGraf='B' Then
  Begin
    gsBarra.ParentChart:=DbGrafico_FinanObjetivosGrafico;
    gsBarra.Clear;
    // gsBarra.Marks.Style:=smsLabelValue; // smsValue;
    gsBarra.Marks.Visible:=True;
    // gsBarra.Marks.Transparent:=True;
    // gsBarra.ColorEachPoint:=True;
    DbGrafico_FinanObjetivosGrafico.BottomAxis.MinorTicks.Visible:=True;

    // Sb_FinanObjetivosGraficoRotacao.Position:=DbGrafico_FinanObjetivosGrafico.View3DOptions.Rotation;
  End;

  // Cria Serie (Linha) ========================================================
  If TipoGraf='L' Then
  Begin
    gsLinha.ParentChart:=DbGrafico_FinanObjetivosGrafico;
    gsLinha.Clear;

    gsLinha.Pointer.Visible:=True;
    gsLinha.Pointer.VertSize:=2;
    gsLinha.Pointer.HorizSize:=2;

    gsLinha.Marks.Visible:=True;
    // gsLinha.Marks.Style:=smsLabelValue; // smsValue;
    // gsLinha.Marks.Transparent:=True;
    // gsLinha.ColorEachPoint:=True;
    
    If Ckb_FinanObjetivosGrafico3D.Checked Then
     gsLinha.LinePen.Width:=1
    Else
     gsLinha.LinePen.Width:=8;
     
    // DbGrafico_FinanObjetivosGrafico.LeftAxis.PosAxis:=100;
    // DbGrafico_FinanObjetivosGrafico.LeftAxis.CustomDraw(5,6, 8,true);
    // Sb_FinanObjetivosGraficoRotacao.Position:=DbGrafico_FinanObjetivosGrafico.View3DOptions.Rotation;
   End;

  // Cria Serie (Pizza) ========================================================
  If TipoGraf='P' Then
  Begin
    gsPizza.ParentChart:=DbGrafico_FinanObjetivosGrafico;
    gsPizza.Clear;
    // gsPizza.Marks.Style:=smsLabelValue; // smsValue; // smsLabel;
    gsPizza.Marks.Arrow.Color:=clBlack;
    gsPizza.Marks.Arrow.Width:=3;
    gsPizza.Marks.Visible:=True;
    // gsPizza.ColorEachPoint:=True;
    gsPizza.Circled:=False;

    // Sb_FinanObjetivosGraficoRotacao.Position:=DbGrafico_FinanObjetivosGrafico.View3DOptions.Elevation;
  End;

  // Grafico de Tipo de Apresentaoem Dias ====================================
  If (Not Ckb_FinanObjetivosManutAuditoria.Checked) and (Not Ckb_FinanObjetivosManutAvarias.Checked) and 
     (Not Ckb_FinanObjetivosManutUlt12Meses.Checked) Then
  Begin
    For i:=6 to 36 do
    Begin
      If DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible Then
      Begin
        If DMVirtual.CDS_V_ObjetivosDias.FieldByName(DMVirtual.CDS_V_ObjetivosDias.Fields[i].FieldName).AsCurrency<0 Then
         Cor:=clRed
        Else
         Cor:=clBlue;

        If TipoGraf='B' Then
         gsBarra.Add(DMVirtual.CDS_V_ObjetivosDias.FieldByName(DMVirtual.CDS_V_ObjetivosDias.Fields[i].FieldName).AsCurrency,
                     DMVirtual.CDS_V_ObjetivosDias.Fields[i].DisplayLabel,Cor);

        // Grava Series (Linha) -------------------------------------
        If TipoGraf='L' Then
         gsLinha.Add(DMVirtual.CDS_V_ObjetivosDias.FieldByName(DMVirtual.CDS_V_ObjetivosDias.Fields[i].FieldName).AsCurrency,
                     DMVirtual.CDS_V_ObjetivosDias.Fields[i].DisplayLabel,Cor);

        // Grava Series (Pizza) -------------------------------------
        If TipoGraf='P' Then
         gsPizza.Add(DMVirtual.CDS_V_ObjetivosDias.FieldByName(DMVirtual.CDS_V_ObjetivosDias.Fields[i].FieldName).AsCurrency,
                     DMVirtual.CDS_V_ObjetivosDias.Fields[i].DisplayLabel,Cor);
      End; // If DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible Then
    End; // For i:=6 to 36 do
  End; // If (Not Ckb_FinanObjetivosManutAuditoria.Checked) and (Not Ckb_FinanObjetivosManutAvarias.Checked) Then
  
  // Grafico de Tipo de Apresentaoem Meses ===================================
  If (Ckb_FinanObjetivosManutAvarias.Checked or Ckb_FinanObjetivosManutUlt12Meses.Checked) Then
  Begin
    For i:=6 to EdtFinanObjetivosMeses.AsInteger+5 do
    Begin
      If DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Visible Then
      Begin
        If DMVirtual.CDS_V_ObjetivosMeses.FieldByName(DMVirtual.CDS_V_ObjetivosMeses.Fields[i].FieldName).AsCurrency<0 Then
         Cor:=clRed
        Else
         Cor:=clBlue;

        If TipoGraf='B' Then
         gsBarra.Add(DMVirtual.CDS_V_ObjetivosMeses.FieldByName(DMVirtual.CDS_V_ObjetivosMeses.Fields[i].FieldName).AsCurrency,
                     DMVirtual.CDS_V_ObjetivosMeses.Fields[i].DisplayLabel,Cor);

        // Grava Series (Linha) -------------------------------------
        If TipoGraf='L' Then
         gsLinha.Add(DMVirtual.CDS_V_ObjetivosMeses.FieldByName(DMVirtual.CDS_V_ObjetivosMeses.Fields[i].FieldName).AsCurrency,
                     DMVirtual.CDS_V_ObjetivosMeses.Fields[i].DisplayLabel,Cor);

        // Grava Series (Pizza) -------------------------------------
        If TipoGraf='P' Then
         gsPizza.Add(DMVirtual.CDS_V_ObjetivosMeses.FieldByName(DMVirtual.CDS_V_ObjetivosMeses.Fields[i].FieldName).AsCurrency,
                     DMVirtual.CDS_V_ObjetivosMeses.Fields[i].DisplayLabel,Cor);
      End; // If DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Visible Then
    End; // For i:=6 to EdtFinanObjetivosMeses.AsInteger+5 do
  End; // If Ckb_FinanObjetivosManutAvarias.Checked Then

  // Grafico de Tipo de Apresentaoem Auditoria ===============================
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    If Cbx_FinanObjetivosGraficoEmpresas.Text='Empresa' Then
    Begin
      DMVirtual.CDS_V_ObjetivosAuditorias.Locate('DES_LOJA','TOTAL DA EMPRESA',[]);

      If DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString='V' Then
       Cor:=clRed
      Else
       Cor:=clBlue;

      cVlrTipoAuditoria:=DMVirtual.CDS_V_ObjetivosAuditoriasREALIZADO.AsCurrency; 
      If (Cbx_FinanObjetivosGraficoTpApres.ItemIndex=2) Or (Cbx_FinanObjetivosGraficoTpApres.ItemIndex=4)Then
       cVlrTipoAuditoria:=DMVirtual.CDS_V_ObjetivosAuditoriasPERCENTUAL.AsCurrency; 

      If TipoGraf='B' Then
       gsBarra.Add(cVlrTipoAuditoria, DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString,Cor);

      // Grava Series (Linha) -------------------------------------
      If TipoGraf='L' Then
       gsLinha.Add(cVlrTipoAuditoria, DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString,Cor);

      // Grava Series (Pizza) -------------------------------------
      If TipoGraf='P' Then
       gsPizza.Add(cVlrTipoAuditoria, DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString,Cor);
    End;

    If Cbx_FinanObjetivosGraficoEmpresas.Text<>'Empresa' Then
    Begin
      i:=DMVirtual.CDS_V_ObjetivosAuditoriasCOD_LOJA.AsInteger;
      While Not DMVirtual.CDS_V_ObjetivosAuditorias.Eof do
      Begin
        If Trim(DMVirtual.CDS_V_ObjetivosAuditoriasCOD_LOJA.AsString)='' Then
         Break;
       
        If i<>DMVirtual.CDS_V_ObjetivosAuditoriasCOD_LOJA.AsInteger Then
         Break;
       
        If DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString='V' Then
         Cor:=clRed
        Else
         Cor:=clBlue;

        cVlrTipoAuditoria:=DMVirtual.CDS_V_ObjetivosAuditoriasREALIZADO.AsCurrency; 
        If (Cbx_FinanObjetivosGraficoTpApres.ItemIndex=2) Or (Cbx_FinanObjetivosGraficoTpApres.ItemIndex=4)Then
         cVlrTipoAuditoria:=DMVirtual.CDS_V_ObjetivosAuditoriasPERCENTUAL.AsCurrency; 

        If TipoGraf='B' Then
         gsBarra.Add(cVlrTipoAuditoria, DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString,Cor);

        // Grava Series (Linha) -------------------------------------
        If TipoGraf='L' Then
         gsLinha.Add(cVlrTipoAuditoria, DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString,Cor);

        // Grava Series (Pizza) -------------------------------------
        If TipoGraf='P' Then
         gsPizza.Add(cVlrTipoAuditoria, DMVirtual.CDS_V_ObjetivosAuditoriasDTA_AUDITORIA.AsString,Cor);
                   
        DMVirtual.CDS_V_ObjetivosAuditorias.Next;
      End; // While Not DMVirtual.CDS_V_ObjetivosAuditorias.Eof do

    End; // If Cbx_FinanObjetivosGraficoEmpresas,Text<>'Empresa' Then

  End; // If Ckb_FinanObjetivosManutAuditoria.Checked Then

  Cbx_FinanObjetivosGraficoTpApresChange(Self);
  Ckb_FinanObjetivosGraficoValorVerticalClick(Self);

End; // Gera Grafico ( TipoGraf=(B)arras (L)inha (P)izza ) >>>>>>>>>>>>>>>>>>>>>

// Calcula Valores do Objetivo >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CalculaValoresObjetivo(sCodObj, sCodObj1, sCodObj2, sTipOper: String);
Var
  MySql, sCampo: String;
  i: Integer;
  
  Array_VlrObjetivo: Array of Currency;
Begin
  Array_VlrObjetivo:=nil;
  SetLength(Array_VlrObjetivo,13); 
 
  MySql:='select e.cod_filial'+
         ' from EMP_CONEXOES e'+
         ' where e.ind_ativo=''SIM'''+
         ' order by e.cod_filial';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;
         
  While Not DMBelShop.CDS_Busca.Eof do
  Begin
    Refresh;
    
    sCodFilial:=DMBelShop.CDS_Busca.FieldByName('COD_FILIAL').AsString;
      
    // Busca Valores do Objetivo 1 ===========================================
    For i:=1 to 12 do
     Array_VlrObjetivo[i]:=0;

    MySql:=' Select m.cod_filial,'+
           ' m.obj_mes01, m.obj_mes02, m.obj_mes03, m.obj_mes04, m.obj_mes05, m.obj_mes06,'+
           ' m.obj_mes07, m.obj_mes08, m.obj_mes09, m.obj_mes10, m.obj_mes11, m.obj_mes12'+

           ' From FIN_OBJETIVOS_METAS m'+

           ' where m.des_ano='+CurrToStr(EdtFinanObjetivosAno.Value)+
           ' and m.cod_objetivo='+sCodObj1+
           ' and m.cod_Filial='+QuotedStr(sCodFilial);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Loja').AsString)<>'' Then
    Begin
      For i:=1 to 12 do
      Begin
        If i<10 Then
         sCampo:='obj_mes0'+IntToStr(i)
        Else
         sCampo:='obj_mes'+IntToStr(i);

        If Trim(DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsString)<>'' Then
         Array_VlrObjetivo[i]:=DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsCurrency;

      End; // For i:=1 to 12 do
    End; // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Loja').AsString)<>'' Then
    DMBelShop.CDS_BuscaRapida.Close;

    // Busca Valores do Objetivo 2 ===========================================
    MySql:=' Select m.cod_filial,'+
           ' m.obj_mes01, m.obj_mes02, m.obj_mes03, m.obj_mes04, m.obj_mes05, m.obj_mes06,'+
           ' m.obj_mes07, m.obj_mes08, m.obj_mes09, m.obj_mes10, m.obj_mes11, m.obj_mes12'+

           ' From FIN_OBJETIVOS_METAS m'+

           ' where m.des_ano='+CurrToStr(EdtFinanObjetivosAno.Value)+
           ' and m.cod_objetivo='+sCodObj2+
           ' and m.cod_Filial='+QuotedStr(sCodFilial);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Filial').AsString)<>'' Then
    Begin
      For i:=1 to 12 do
      Begin
        If i<10 Then
         sCampo:='obj_mes0'+IntToStr(i)
        Else
         sCampo:='obj_mes'+IntToStr(i);

        If Trim(DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsString)<>'' Then
        Begin
          If (Array_VlrObjetivo[i]<>0) and (DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsCurrency<>0) Then
          Begin
            If sTipOper='+' Then
             Array_VlrObjetivo[i]:=Array_VlrObjetivo[i]+DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsCurrency;

            If sTipOper='-' Then
             Array_VlrObjetivo[i]:=Array_VlrObjetivo[i]-DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsCurrency;

            If sTipOper='*' Then
             Array_VlrObjetivo[i]:=Array_VlrObjetivo[i]*DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsCurrency;

            If sTipOper='/' Then
             Array_VlrObjetivo[i]:=Array_VlrObjetivo[i]/DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsCurrency;
          End;
        End; // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName(sCampo).AsString)<>'' Then
           
      End; // For i:=1 to 12 do
    End; // If Not DMBelShop.CDS_BuscaRapida.Eof do
    DMBelShop.CDS_BuscaRapida.Close;

    // Calcula Objetivo ======================================================
    DMBelShop.CDS_ObjetivosEmpresas.Locate('COD_FILIAL',sCodFilial,[]);

    If DMBelShop.CDS_ObjetivosMetas.IsEmpty Then
     Begin
       DMBelShop.CDS_ObjetivosMetas.Insert;
       DMBelShop.CDS_ObjetivosMetasCOD_FILIAL.AsString:=sCodFilial;
       DMBelShop.CDS_ObjetivosMetasCOD_OBJETIVO.AsString:=sCodObj;
       DMBelShop.CDS_ObjetivosMetasDES_ANO.AsInteger:=EdtFinanObjetivosAno.AsInteger;

       DMBelShop.CDS_ObjetivosMetasOBJ_MES01.AsCurrency:=Array_VlrObjetivo[1];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES02.AsCurrency:=Array_VlrObjetivo[2];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES03.AsCurrency:=Array_VlrObjetivo[3];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES04.AsCurrency:=Array_VlrObjetivo[4];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES05.AsCurrency:=Array_VlrObjetivo[5];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES06.AsCurrency:=Array_VlrObjetivo[6];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES07.AsCurrency:=Array_VlrObjetivo[7];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES08.AsCurrency:=Array_VlrObjetivo[8];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES09.AsCurrency:=Array_VlrObjetivo[9];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES10.AsCurrency:=Array_VlrObjetivo[10];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES11.AsCurrency:=Array_VlrObjetivo[11];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES12.AsCurrency:=Array_VlrObjetivo[12];
       DMBelShop.CDS_ObjetivosMetasUSU_INCLUI.AsString:=Cod_Usuario;
       DMBelShop.CDS_ObjetivosMetasDTA_INCLUI.AsString:=
                        DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
     End
    Else // If DMBelShop.CDS_ObjetivosMetas.IsEmpty Then
     Begin
       DMBelShop.CDS_ObjetivosMetas.Edit;
       DMBelShop.CDS_ObjetivosMetasOBJ_MES01.AsCurrency:=Array_VlrObjetivo[1];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES02.AsCurrency:=Array_VlrObjetivo[2];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES03.AsCurrency:=Array_VlrObjetivo[3];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES04.AsCurrency:=Array_VlrObjetivo[4];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES05.AsCurrency:=Array_VlrObjetivo[5];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES06.AsCurrency:=Array_VlrObjetivo[6];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES07.AsCurrency:=Array_VlrObjetivo[7];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES08.AsCurrency:=Array_VlrObjetivo[8];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES09.AsCurrency:=Array_VlrObjetivo[9];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES10.AsCurrency:=Array_VlrObjetivo[10];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES11.AsCurrency:=Array_VlrObjetivo[11];
       DMBelShop.CDS_ObjetivosMetasOBJ_MES12.AsCurrency:=Array_VlrObjetivo[12];
       DMBelShop.CDS_ObjetivosMetasUSU_ALTERA.AsString:=Cod_Usuario;
       DMBelShop.CDS_ObjetivosMetasDTA_ALTERA.AsString:=
                        DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
     End;

    Bt_FinanObjetivosManutObjetivosSalvarClick(Self);
    
    DMBelShop.CDS_Busca.Next;
  End; // While Not DMBelShop.CDS_Busca.Eof do
  DMBelShop.CDS_Busca.Close;

End; // Calcula Valores do Objetivo >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Calcula Resultado dos Objetivos por Dias >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CaluclaResultadosObjetivosMetasDias;                                 
Var
  i: Integer;
  s: String;
  Array_Objetivos: Array of Currency;
  Array_Realizados: Array of Currency;

  Array_ObjetivosTotal: Array of Currency;
  Array_RealizadosTotal: Array of Currency;
  Array_DiariosTotal: Array of Currency;
  
  cValorTotalRealizado: Currency;
Begin
  // Inicializa Arrays =========================================================
  Array_Objetivos:=nil;
  SetLength(Array_Objetivos,32); 
  Array_Realizados:=nil;
  SetLength(Array_Realizados,32); 

  Array_ObjetivosTotal:=nil;
  SetLength(Array_ObjetivosTotal,32); 
  Array_RealizadosTotal:=nil;
  SetLength(Array_RealizadosTotal,32); 
  Array_DiariosTotal:=nil;
  SetLength(Array_DiariosTotal,32);

  // Inicializa Arrays de Totais ===============================================
  For i:=1 to 31 do
   Array_ObjetivosTotal[i]:=0;
     
  For i:=1 to 31 do
   Array_RealizadosTotal[i]:=0;

  For i:=1 to 31 do
   Array_DiariosTotal[i]:=0;

  // Efetua os Calculos dos Objetivos ========================================== 
  DMVirtual.CDS_V_ObjetivosDias.First;
  While Not DMVirtual.CDS_V_ObjetivosDias.Eof do
  Begin
    Refresh;

    If DMVirtual.CDS_V_ObjetivosDiasTipo.AsString='Objetivo' Then
    Begin
      // Verifica se tem Valores Realizados -------------------------
      DMVirtual.CDS_V_ObjetivosDias.Next;
      cValorTotalRealizado:=0;
      For i:=6 to 36 do
      Begin
        cValorTotalRealizado:=cValorTotalRealizado+
                                  DMVirtual.CDS_V_ObjetivosDias.Fields[i].Value;
      End;

      If cValorTotalRealizado>0 Then
      Begin
        DMVirtual.CDS_V_ObjetivosDias.Prior;
      
        // Guarda Objetivos Totais ----------------------------------
        For i:=1 to 31 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;
         
          Array_ObjetivosTotal[i]:=Array_ObjetivosTotal[i]+
              DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency;
        End; // For i:=1 to 31 do

        // Guarda Objetivos -----------------------------------------
        For i:=1 to 31 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;
         
          Array_Objetivos[i]:=
              DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency;
        End; // For i:=1 to 31 do

        // Guarda Realizados ----------------------------------------
        DMVirtual.CDS_V_ObjetivosDias.Next; 
        For i:=1 to 31 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;
         
          Array_Realizados[i]:=
              DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency;
        End; // For i:=1 to 31 do

        // Guarda Realizados Totais ---------------------------------
        For i:=1 to 31 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;
         
          Array_RealizadosTotal[i]:=Array_RealizadosTotal[i]+
               DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency;
        End; // For i:=1 to 31 do

        // Calcula Resultado em Valores -----------------------------
        DMVirtual.CDS_V_ObjetivosDias.Next; 
        DMVirtual.CDS_V_ObjetivosDias.Edit;
        For i:=1 to 31 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=
                                         Array_Realizados[i]-Array_Objetivos[i];
        End; // For i:=1 to 31 do
        DMVirtual.CDS_V_ObjetivosDias.Post;
      
        // Calcula Resultado em Percentual ----------------------------
        DMVirtual.CDS_V_ObjetivosDias.Next; 
        DMVirtual.CDS_V_ObjetivosDias.Edit;
        For i:=1 to 31 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=0; 
          If Array_Objetivos[i]<>0 Then 
           DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=
                              RoundTo(((Array_Realizados[i]-Array_Objetivos[i])/
                                                    Array_Objetivos[i])*100,-2);
        End; // For i:=1 to 31 do
        DMVirtual.CDS_V_ObjetivosDias.Post;

        // Calcula Diarios Totais ------------------------------------
        DMVirtual.CDS_V_ObjetivosDias.Next; 
        For i:=1 to 31 do
        Begin
          s:=IntToStr(i);
          If i<10 Then
           s:='0'+s;

          Array_DiariosTotal[i]:= Array_DiariosTotal[i]+
              DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency;
        End; // For i:=1 to 31 do
      End; // If cValorTotalRealizado>0 Then
    End; // If DMVirtual.CDS_V_ObjetivosDiasTipo.AsString='Objetivo' Then
     
    DMVirtual.CDS_V_ObjetivosDias.Next;

    // Totais da Empresa --------------------------------------------
    If (DMVirtual.CDS_V_ObjetivosDiasDes_Empresa.AsString='Empresa') Then
    Begin
      // Guarda Objetivos Totais ------------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Edit;

      For i:=1 to 31 do
      Begin
        If Array_ObjetivosTotal[i]<>0 Then
         DMVirtual.CDS_V_ObjetivosDiasVlr_Objetivo.AsCurrency:=Array_ObjetivosTotal[i];
      End;
      DMVirtual.CDS_V_ObjetivosDias.Post;
    End;
    
    If (DMVirtual.CDS_V_ObjetivosDiasTipo.AsString='Objetivo') and (DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsString='9999') Then
    Begin
      // Guarda Objetivos Totais ------------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Edit;
      For i:=1 to 31 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=Array_ObjetivosTotal[i];
      End; // For i:=1 to 31 do
      DMVirtual.CDS_V_ObjetivosDias.Post;

      // Guarda Realizados Totais -----------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Next; 
      DMVirtual.CDS_V_ObjetivosDias.Edit;
      For i:=1 to 31 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;
         
        DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=Array_RealizadosTotal[i];
      End; // For i:=1 to 31 do
      DMVirtual.CDS_V_ObjetivosDias.Post;
      
      // Calcula Resultado em Valores -------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Next; 
      DMVirtual.CDS_V_ObjetivosDias.Edit;
      For i:=1 to 31 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=
                               Array_RealizadosTotal[i]-Array_ObjetivosTotal[i];
      End; // For i:=1 to 31 do
      DMVirtual.CDS_V_ObjetivosDias.Post;
      
      // Calcula Resultado em Percentual ----------------------------
      DMVirtual.CDS_V_ObjetivosDias.Next; 
      DMVirtual.CDS_V_ObjetivosDias.Edit;
      For i:=1 to 31 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;

        DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=0; 
        If Array_ObjetivosTotal[i]<>0 Then 
         DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=RoundTo(
                            ((Array_RealizadosTotal[i]-Array_ObjetivosTotal[i])/
                                               Array_ObjetivosTotal[i])*100,-2);
      End; // For i:=1 to 31 do
      DMVirtual.CDS_V_ObjetivosDias.Post;

      // Guarda Diarios Totais -------------------------------------
      DMVirtual.CDS_V_ObjetivosDias.Next; 
      DMVirtual.CDS_V_ObjetivosDias.Edit;
      For i:=1 to 31 do
      Begin
        s:=IntToStr(i);
        If i<10 Then
         s:='0'+s;
         
        DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).AsCurrency:=Array_DiariosTotal[i];
      End; // For i:=1 to 31 do
      DMVirtual.CDS_V_ObjetivosDias.Post;

      // Inicializa Arrays de Totais --------------------------------
      For i:=1 to 31 do
       Array_ObjetivosTotal[i]:=0;
     
      For i:=1 to 31 do
       Array_RealizadosTotal[i]:=0;

      For i:=1 to 31 do
       Array_DiariosTotal[i]:=0;

      DMVirtual.CDS_V_ObjetivosDias.Next; 
    End; // If (DMVirtual.CDS_V_ObjetivosDiasTipo.AsString='Objetivo') and (DMVirtual.CDS_V_ObjetivosDiasDes_Empresa.AsString='Empresa') Then
    
  End; // While Not DMVirtual.CDS_V_ObjetivosDias.Eof do

  DMVirtual.CDS_V_ObjetivosDias.First;
                                                  
End; // // Calcula Resultado dos Objetivos por Dia >>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Cria Feriados no Ano >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CriaFeriadosAno(iAno: Integer);
Var
  sDiaFeriado, sDescFeriado: String;
  MySql: String;
  i, ii: Integer;
  mMemo: TMemo;
Begin
  // Insere Feriados do Ano ==================================================
  mMemo:=TMemo.Create(Self);
  mMemo.Visible:=False;
  mMemo.Parent:=FrmBelShop;
  mMemo.Width:=500;
  mMemo.Lines.Clear;

  AnoFeriados(iAno, mMemo);

  For i:=0 to mMemo.Lines.Count-1 do
  Begin
    sDiaFeriado:=Copy(mMemo.Lines[i],1,10);
    sDiaFeriado:=f_Troca('-','.', sDiaFeriado);
    sDiaFeriado:=f_Troca('/','.', sDiaFeriado);

    ii:=pos(' - ',mMemo.Lines[i]);
    sDescFeriado:=Trim(Copy(mMemo.Lines[i],ii+3,Length(mMemo.Lines[i])));

    // Monta Transacao =======================================================
    TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);
    Try
      Screen.Cursor:=crAppStart;
      DateSeparator:='.';
      DecimalSeparator:='.';

      MySql:='UPDATE OR INSERT INTO FIN_FERIADOS_ANO (DTA_FERIADO, DES_FERIADO, IND_CALCULADO, IND_ATIVO)'+
             ' Values ('+
             QuotedStr(sDiaFeriado)+', '+
             QuotedStr(sDescFeriado)+', '+
             QuotedStr('SIM')+', '+
             QuotedStr('SIM')+')'+
             ' MATCHING (DTA_FERIADO)';
      DMBelShop.SQLC.Execute(MySql,nil,nil);

      // Fecha Transacao ===========================================================
      DMBelShop.SQLC.Commit(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

    Except
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;
    End; // Try // Monta Transacao

  End; // For i:=0 to mMemo.Lines.Count-1 do

  FreeAndNil(mMemo);

End; // Cria Feriados no Ano >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Objetivos/Metas Dias - Busca Valores das Empresas e Atualiza Planilha >>>>>>>
Procedure TFrmBelShop.AtualizaValorObjetivosMetasDias;
Var
  MySql: String;
  iOrdemMov, iCodObj: Integer;
  i, ii, iLinx: Integer;
  iDia: Integer;

  sDesObj,
  sCampoSubst, sVlrSubst, sCampo: String;
  cVlrAcumulado: Currency;
  bSiga: Boolean;

  mMemLinx: TMemo;
Begin
  //(ODIRK1) - INICIO - AtualizaValorObjetivosMetasDias;
  //=================================================//

  // Cria Componente Memo para Vendas Linx =====================================
  mMemLinx:=TMemo.Create(Self);
  mMemLinx.Visible:=False;
  mMemLinx.Parent:=FrmBelShop;
  mMemLinx.Width:=500;
  mMemLinx.Lines.Clear;

  // Array para Formulas =======================================================
  Array_Campos:=nil;
  SetLength(Array_Campos,32);

  // Localiza Empresa na Planilha ==============================================
  iCodObj:=DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsInteger;
  sDesObj:=DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString;
  if DMVirtual.CDS_V_ObjetivosDias.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Realizado']),[]) Then
  Begin
    // Conecta Empresa =========================================================
    bSiga:=True;
//    If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then
//    Begin
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         If sgLojasNConectadas='' Then
          sgLojasNConectadas:=sDesObj+': Bel_'+sgCodEmp
         Else
          sgLojasNConectadas:=
           sgLojasNConectadas+cr+sDesObj+': Bel_'+sgCodEmp;

         bSiga:=False;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
//    End; // If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then

    // Inicia Processamento ====================================================
    If bSiga Then // Empresa Conectada
    Begin
      DMLinx.CDS_Busca.Close;
      mMemLinx.Lines.Clear;

      // Cria Query da Empresa ----------------------------------
      CriaQueryIB('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, IBQ_ConsultaFilial, True, True);

      // Busca Comprovantes e Atualiza Planilha ============================
      For i:=0 to memo2.Lines.Count-1 do
      Begin
        //(ODIRK1) - AtualizaValorObjetivosMetasDias;
        //===========================================//

        // Movimentao Linx (Vendas)--------------------------------
        DMLinx.CDS_Busca.Close;
        mMemLinx.Lines.Clear;

        sgDtaFimLinx  :='';
        sgDtaIncioLinx:='';
        If (Memo2.Lines[i]='002') And (igCodLojaLinx<>0) And
           (Not Rb_FinanObjetivosManutTpOperacaoSalao.Checked) And
           (Not Ckb_FinanObjetivosManutNaoCompra.Checked) Then
        Begin
          if StrToDate(sgDtaFim)>=StrToDate(sgDtaComecoLinx) Then
          Begin
            If (StrToDate(sgDtaComecoLinx)<=StrToDate(sgDtaFim)) Then
            Begin
              If (StrToDate(sgDtaComecoLinx)<=StrToDate(sgDtaI)) Then
               Begin
                 sgDtaIncioLinx:=sgDtaI;
               End
              Else // If (StrToDate(sgDtaComecoLinx)<=StrToDate(sgDtaI)) Then
               Begin
                 sgDtaIncioLinx:=sgDtaComecoLinx;
               End; // If (StrToDate(sgDtaComecoLinx)<=StrToDate(sgDtaI)) Then

              sgDtaFimLinx:=sgDtaFim;
            End; // If (StrToDate(sDtaComecoLinx)<=StrToDate(sgDtaFim)) Then

            // Busca Movimentos de Vendas Linx ============================
            BuscaMovtosVendasLINX(mMemLinx, 'D');

          End; // if StrToDate(sgDtaFim)>StrToDate(sgDtaComecoLinx) Then
        End; // If Memo2.Lines[i]='002' ........ Then

        // Monta SQL Somente Loja Com SIDICOM ----------------------------------
        MySql:=' SELECT tot.DIA,'+
               ' SUM(tot.QTD_COMPROV) QTD_COMPROV,'+
               ' SUM(tot.TOT_ITENS)TOT_ITENS,'+
               ' SUM(tot.TICKET_MEDIO) TICKET_MEDIO,'+
               ' SUM(tot.TOT_DESC_ITEM) TOT_DESC_ITEM,'+
               ' SUM(tot.TOT_BRUTO) TOT_BRUTO,'+
               ' SUM(tot.TOT_NOTA) TOT_NOTA,'+
               ' SUM(tot.TOT_FRETE) TOT_FRETE,'+
               ' SUM(tot.TOT_DESPESAS) TOT_DESPESAS'+
               '  FROM'+
               ' (';

        If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then
        Begin
          MySql:=
           MySql+' Select'+
                 ' Cast(lpad(extract(day from m.datacomprovante),2,''0'') as varchar(2)) Dia,';

                 If Memo2.Lines[i]='002' Then
                  Begin
                    MySql:=
                     MySql+' Coalesce((Count(distinct case When m.codcomprovante=''002'' then m.chavenf End)-'+
                           '           Count(distinct case When m.codcomprovante=''007'' then m.chavenf End)),0) QTD_COMPROV,'+

                           ' Coalesce((Count(case When m.codcomprovante=''002'' then mp.codproduto End)-'+
                           '           Count(case When m.codcomprovante=''007'' then mp.codproduto End)),0) TOT_ITENS,'+

                           ' case'+
                           '   When ((Sum(Coalesce(mp.valtotal,0.00)))<>0) and'+
                           '        ((Count(distinct case When m.codcomprovante=''002'' then m.chavenf End)-'+
                           '         (Count(distinct case When m.codcomprovante=''007'' then m.chavenf End))))<>0 Then'+
                           '                  Coalesce(((Sum(Coalesce(mp.valtotal,0.00)))/'+
                           '                           ((Count(distinct case When m.codcomprovante=''002'' then m.chavenf End)-'+
                           '                             Count(distinct case When m.codcomprovante=''007'' then m.chavenf End)))),0)'+
                           '   Else 0'+
                           ' End Ticket_Medio,';

                  End
                 Else // If Memo2.Lines[i]='002' Then
                  Begin
                    MySql:=
                     MySql+' Coalesce((Count(distinct case When m.codcomprovante='+QuotedStr(Memo2.Lines[i])+' then m.chavenf End)),0) QTD_COMPROV,'+

                           ' Coalesce((Count(case When m.codcomprovante='+QuotedStr(Memo2.Lines[i])+' then mp.codproduto End)),0) TOT_ITENS,'+

                           ' case'+
                           '   When ((Sum(Coalesce(mp.valtotal,0.00)))<>0) and'+
                           '        ((Count(distinct case When m.codcomprovante='+QuotedStr(Memo2.Lines[i])+' then m.chavenf End)))<>0 Then'+
                           '                   Coalesce((Sum(Coalesce(mp.valtotal,0.00)))/'+
                           '                            (Count(distinct case When m.codcomprovante='+QuotedStr(Memo2.Lines[i])+' then m.chavenf End)),0)'+
                           '   Else 0'+
                           ' End Ticket_Medio,';
                  End; // If Memo2.Lines[i]='002' Then

          MySql:=
           MySql+' Coalesce(Sum(Coalesce(mp.valdescitem,0.00)),0) TOT_DESC_ITEM,'+
                 ' Coalesce(Sum(Coalesce(mp.valbruto,0.00)),0.00) TOT_BRUTO,'+
                 ' Coalesce(Sum(Coalesce(mp.valtotal,0.00)),0.00) TOT_NOTA,'+
                 ' Coalesce(Sum(Coalesce(mp.valfrete,0.00)),0.00) TOT_FRETE,'+
                 ' Coalesce(Sum(Coalesce(mp.valdespesas,0)),0.00) TOT_DESPESAS'+

                 ' from MCLI m, MCLIPRO mp, PRODUTO p'+

                 ' Where m.chavenf=mp.chavenf'+
                 ' AND  mp.codproduto=p.codproduto';

                 If Rb_FinanObjetivosManutTpOperacaoLoja.Checked Then
                  MySql:=
                   MySql+' and p.principalfor not in (''000500'',''000883'')';

                 If Rb_FinanObjetivosManutTpOperacaoSalao.Checked Then
                  MySql:=
                   MySql+' and p.principalfor in (''000500'',''000883'')';

                 If Ckb_FinanObjetivosManutNaoCompra.Checked Then
                  MySql:=
                   MySql+' and Coalesce(p.situacaopro,1) in (1,3)';

          MySql:=
           MySql+' and m.codfilial='+QuotedStr(sgCodEmp);

                 If Memo2.Lines[i]='002' Then
                  MySql:=
                   MySql+' and m.codcomprovante in (''002'',''007'')'
                 Else
                  MySql:=
                   MySql+' and m.codcomprovante='+QuotedStr(Memo2.Lines[i]);

                 MySql:=
                  MySql+' and m.datacomprovante '+f_Troca('/','.',f_Troca('-','.',sgPeriodo));

           MySql:=
            MySql+' Group by 1';

        End; // If (StrToInt(sgCodEmp)<18) or (StrToInt(sgCodEmp)>45)  Then // Monta SQL Somente Loja Com SIDICOM ---

        // Ingremente dias do Linx =============================================
        If mMemLinx.Lines.Count>1 Then
        Begin
          For iLinx:=0 to mMemLinx.Lines.Count-1 do
          Begin
            If (StrToInt(sgCodEmp)>=18) And (StrToInt(sgCodEmp)<=45)  Then // Monta SQL com Loja Somente LINX
             Begin
               MySql:=
                MySql+mMemLinx.Lines[iLinx];
             End
            Else If iLinx=0 Then // Monta SQL com Loja Somente LINX
             Begin
               MySql:=
                MySql+' UNION '+mMemLinx.Lines[iLinx];
             End
            Else
             Begin
               MySql:=
                MySql+mMemLinx.Lines[iLinx];
             End; // If (StrToInt(sgCodEmp)>=18) And (StrToInt(sgCodEmp)<=45)  Then
          End; // For i:=0 to mMemo.Lines.Count-1 do
        End; // If mMemLinx.Lines.Count>1 Then

        MySql:=
         MySql+' ) TOT'+
               ' Group by 1'+
               ' Order by 1';
        IBQ_ConsultaFilial.SQL.Clear;
        IBQ_ConsultaFilial.SQL.Add(MySql); //(ODIRK1)

        // Abre Query -----------------------------------------------
        ii:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            IBQ_ConsultaFilial.Open;
            bSiga:=True;
          Except
            Inc(ii);
          End; // Try

          If ii>2 Then
          Begin
            If sgLojasNConectadas='' Then
             sgLojasNConectadas:=sDesObj+': Bel_'+sgCodEmp
            Else
             sgLojasNConectadas:=
              sgLojasNConectadas+cr+sDesObj+': Bel_'+sgCodEmp;

            Break;
          End; // If ii>10 Then
        End; // While Not bSiga do

        // Processamento ===================================================
        If bSiga Then // Query Executada
        Begin
          // Posiciona TabSheet -------------------------------------
          PC_FinanObjetivos.TabIndex:=1;

          iOrdemMov:=0;
          While Not IBQ_ConsultaFilial.Eof do
          Begin
            Refresh;

            // Insere Movimentos para Pesquisa ----------------------
            Inc(iOrdemMov);
            DMVirtual.CDS_V_ObjetivosMovtos.Insert;
            DMVirtual.CDS_V_ObjetivosMovtosORDEM.AsInteger:=iOrdemMov;
            DMVirtual.CDS_V_ObjetivosMovtosCOD_FILIAL.AsInteger:=DMVirtual.CDS_V_ObjetivosDiasCod_Emp.AsInteger;
            DMVirtual.CDS_V_ObjetivosMovtosCOD_OBJETIVO.AsInteger:=DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsInteger;
            DMVirtual.CDS_V_ObjetivosMovtosTIP_CALCULO.AsString:='D';
            DMVirtual.CDS_V_ObjetivosMovtosDATA.AsString:='Dia_'+IBQ_ConsultaFilial.FieldByName('Dia').AsString;
            DMVirtual.CDS_V_ObjetivosMovtosQTD_COMPROV.AsCurrency:=IBQ_ConsultaFilial.FieldByName('QTD_COMPROV').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_ITENS.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_ITENS').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTICKET_MEDIO.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TICKET_MEDIO').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_DESC_ITENS.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_DESC_ITEM').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_BRUTO.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_BRUTO').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_NOTA.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_NOTA').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_FRETE.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_FRETE').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtosTOT_DESPESAS.AsCurrency:=IBQ_ConsultaFilial.FieldByName('TOT_DESPESAS').AsCurrency;
            DMVirtual.CDS_V_ObjetivosMovtos.Post;

            // Guarda Dia -------------------------------------------
            iDia:=IBQ_ConsultaFilial.FieldByName('Dia').AsInteger;

            // Acerta Formula Com Valores ---------------------------
            sCampoSubst:='CP'+Memo2.Lines[i]+'.QTD_COMPROV';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('QTD_COMPROV').AsCurrency));

            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_ITENS';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_ITENS').AsCurrency));
            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESC_ITEM';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_DESC_ITEM').AsCurrency));
            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_BRUTO';                                            
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_BRUTO').AsCurrency));
            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_NOTA';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_NOTA').AsCurrency));
            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_FRETE';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_FRETE').AsCurrency));
            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESPESAS';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TOT_DESPESAS').AsCurrency));
            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TICKET_MEDIO';
            sVlrSubst:=CurrToStr(Abs(IBQ_ConsultaFilial.FieldByName('TICKET_MEDIO').AsCurrency));
            If Array_Campos[iDia]='' Then
             Array_Campos[iDia]:=DMBelShop.CDS_ObjetivosDES_FORMULA.AsString;
            Array_Campos[iDia]:=StringReplace(Array_Campos[iDia], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            IBQ_ConsultaFilial.Next;
          End; // While Not IBQ_ConsultaFilial.Eof do
        End; // If bSiga Then // Query Executada
      End; // For i:=0 to memo2.Lines.Count-1 do

      // Acerta Campos das Formulas no Substituidos =======================
      sVlrSubst:='0';
      For i:=0 to memo2.Lines.Count-1 do
      Begin
        for ii:=Low(Array_Campos) to High(Array_Campos) do
        Begin
          If (Array_Campos[ii]<>'') Then
          Begin
            sCampoSubst:='CP'+Memo2.Lines[i]+'.QTD_COMPROV';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);
            
            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_ITENS';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESC_ITEM';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_BRUTO';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_NOTA';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_FRETE';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

            sCampoSubst:='CP'+Memo2.Lines[i]+'.TOT_DESPESAS';
            Array_Campos[ii]:=StringReplace(Array_Campos[ii], sCampoSubst, sVlrSubst, [rfReplaceAll]);

          End; // If (Array_Campos[i]<>'') and
        End; // for i:=Low(Array_Campos) to High(Array_Campos) do
      End; // For i:=0 to memo2.Lines.Count-1 do

      // Calcula Formula e Atualiza Planilha de Objetivos ==================
      cVlrAcumulado:=0;
      for i:=Low(Array_Campos) to High(Array_Campos) do
      Begin
        If i<>0 Then
        Begin
          sCampo:=IntToStr(i);
          If Length(sCampo)<2 Then
           sCampo:='0'+sCampo;
          sCampo:='Vlr_Dia'+sCampo;

          If (Array_Campos[i]<>'') Then
           Begin
             sVlrSubst:=CalculaFormula(f_Troca(',','.',Array_Campos[i]), DMBelShop.CDS_ObjetivosNUM_DECIMAIS.AsInteger);
             sVlrSubst:=f_Troca('.',',',sVlrSubst);
           End
          Else
           Begin
             sVlrSubst:='0';
           End; // If (Array_Campos[i]<>'') Then

          If DMBelShop.CDS_ObjetivosIND_FIXO.AsString='NAO' Then
           cVlrAcumulado:=cVlrAcumulado+StrToCurr(sVlrSubst)
          Else
           cVlrAcumulado:=StrToCurr(sVlrSubst);

          // Atualiza Planilha ---------------------------------
          DMVirtual.CDS_V_ObjetivosDias.Edit;
          DMVirtual.CDS_V_ObjetivosDias.FieldByName(sCampo).AsCurrency:=cVlrAcumulado;
          DMVirtual.CDS_V_ObjetivosDias.Post;

          // Atualiza Valor Diario -----------------------------
          DMVirtual.CDS_V_ObjetivosDias.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Dirio']),[]);
          DMVirtual.CDS_V_ObjetivosDias.Edit;
          DMVirtual.CDS_V_ObjetivosDias.FieldByName(sCampo).AsCurrency:=StrToCurr(sVlrSubst);
          DMVirtual.CDS_V_ObjetivosDias.Post;

          // Retorno para o Objetivo da Loja -------------------
          DMVirtual.CDS_V_ObjetivosDias.Locate('Cod_Objetivo; Cod_Emp; Tipo', VarArrayOf([iCodObj,sgCodEmp, 'Realizado']),[]);
        End; // If i<>0 Then
      End; // for i:=Low(Array_Campos) to High(Array_Campos) do // Calcula Formula e Atualiza Planilha de Objetivos

    End; //If bSiga Then // Empresa Conectada
  End; // if DMVirtual.CDS_V_ObjetivosDias.Locate('Cod_Objetivo; Cod_Emp; Tipo',

  FreeAndNil(mMemLinx);

End; // Objetivos/Metas Dias - Busca Valores das Empresas e Atualiza Planilha >>

// Objetivos/Metas Dias - Calcula Objetivos/Metas das Empresa por Dias >>>>>>>>>
Procedure TFrmBelShop.CaluclaObjetivosMetasDias;
Var
  b: Boolean;
  i, ii, iii: Integer;
  s, sCodComprov: String;
Begin

  // Processa Empresas Selecionadas ============================================
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      igCodLojaLinx  :=DMBelShop.CDS_EmpProcessaCOD_LINX.AsInteger;
      sgDtaComecoLinx:=DMBelShop.CDS_EmpProcessaDTA_INICIO_LINX.AsString;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sgCodEmp+' - '+
                                 DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Processa Objetivos ====================================================
      DMBelShop.CDS_Objetivos.First;
      While Not DMBelShop.CDS_Objetivos.Eof do
      Begin
        Refresh;

        If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) and
            ((Not Ckb_FinanObjetivosManutAuditoria.Checked) and (Not Ckb_FinanObjetivosManutAvarias.Checked)) Then
        Begin
          // Busca Codigos de Comprovantes da Formula ---------------
          b:=True;
          Memo2.Lines.Clear;
          Memo2.Width:=500;
          s:=AnsiUpperCase(DMBelShop.CDS_ObjetivosDES_FORMULA.AsString);
          While b do
          Begin
            i:=pos('CP',AnsiUpperCase(s));
            iii:=6;
            sCodComprov:=copy(s,i,iii);

            If StrToIntDef(copy(sCodComprov,Length(sCodComprov),1), 999999)=999999 Then
            Begin
              iii:=5;
              sCodComprov:=copy(s,i,iii);
            End;
            sCodComprov:=copy(s,i+2,iii-2);

            If i>0 Then
            Begin
              bOK:=True;
              For ii:=0 to Memo2.Lines.Count-1 do
              Begin
                If Memo2.Lines[ii]=sCodComprov Then
                Begin
                  bOK:=False;
                  Break;
                End;
              End;

              If bOK Then
              Begin
                Memo2.Lines.Add(sCodComprov);
              End; // If bOK Then
              s:=(copy(s,i+iii, Length(s)));
            End; // If i>0 Then

            If i=0 Then
             Break;
          End; // While b do // Busca Codigos de Comprovantes da Formula

          // Busca Valores na Empresa para Montar Formula ======================
          AtualizaValorObjetivosMetasDias;

        End; // If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM') and

        DMBelShop.CDS_Objetivos.Next;
      End; // While Not DMBelShop.CDS_Objetivos.Eof do

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    // Apresenta o Processamento ------------------------------------
    OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
    Refresh;

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do
  Memo2.Width:=50;

End; // Objetivos/Metas Dias - Calcula Objetivos/Metas das Empresa por Dias >>>>

// Objetivos/Metas - Habilita/Disabilita Manutencao de Objetivos >>>>>>>>>>>>>>>
Procedure TFrmBelShop.HabilitaDesabilitaManutencaoObjetivos(bTipo: Boolean);
Begin
  // bTipo = True  - Habilita
  //         False - Desabilita
  
  Bt_FinanObjetivosManutObjetivosSalvar.Enabled:=bTipo;
  Bt_FinanObjetivosManutObjetivosAbandonar.Enabled:=bTipo;

  Pan_FinanObjetivosManut.Enabled:=(not bTipo);
  EdtFinanObjetivosAno.Enabled:=(not bTipo);
  Bt_FinanObjetivosManutSalvar.Enabled:=(not bTipo);
  Bt_FinanObjetivosManutAbandonar.Enabled:=(not bTipo);
  Dbg_FinanObjetivosManutEmpresas.Enabled:=(not bTipo);

  Dbe_FinanObjetivosManutJan.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutFev.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutMar.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutAbr.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutMai.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutJun.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutJul.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutAgo.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutSet.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutOut.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutNov.ReadOnly:=(not bTipo);
  Dbe_FinanObjetivosManutDez.ReadOnly:=(not bTipo);
  
End; // Objetivos/Metas - Habilita/Disabilita Manutencao de Objetivos >>>>>>>>>>

// Planilha Plano de Contas - Comprovante 200 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.PlanoContasEmpresasCP200;
Var
  MySql: String;
  sCampo: String;
  s, ss: String;
  bSiga: Boolean;
  ii, i: Integer;
Begin

  // Monta Sql Comprovante 200 =================================================
  s :=f_Troca('/','.',sgDtaInicio);
  s :=f_Troca('-','.',s);
  ss:=f_Troca('/','.',sgDtaFim);
  ss:=f_Troca('-','.',ss);

  MySql:='Select 1 Controle, Substring(pl.nomedaconta from 4 for 40) nome,'+
         ' Sum(mov.totnota) Vlr_Total'+

         ' From MCLI mov, MCLICAIXA cx, CAIXACONTA co, CAIXAPLANO pl'+

         ' Where mov.chavenf=cx.chavenf'+
         ' And cx.codconta=co.codconta'+
         ' And co.codcontaplano=pl.codcontaplano'+
         ' And mov.codfilial=:CodFilial'+
         ' And mov.datacomprovante between '+QuotedStr(s)+' and '+QuotedStr(ss)+
         ' And mov.codcomprovante=''200'''+
         ' Group By 1, 2'+

         ' UNION'+

         ' Select 2 Controle, Substring(pl.nomedaconta from 4 for 40) Nome,'+
         ' Sum(cx.totnota) Vlr_Total'+
         ' From MCLIPAGO cx, MCLIPAGOCAIXA pg, CAIXACONTA ct, CAIXAPLANO pl'+
         ' Where cx.chavenfprestacao=pg.chavenfprestacao'+
         ' And pg.codconta=ct.codconta'+
         ' And ct.codcontaplano=pl.codcontaplano'+
         ' And cx.codfilial=:CodFilial'+
         ' And cx.datacomprovante between '+QuotedStr(s)+' and '+QuotedStr(ss)+
         ' And cx.codcomprovante=''200'''+
         ' Group By 1, 2'+

         ' Order By 1, 2';

  // Inicia Processamento ======================================================       
  sgLojasNConectadas:='';

  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

      // Monta Campo da Empresa ================================================
      sCampo:='Vlr_Empresa'+sgCodEmp;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sgCodEmp+' - '+
                                 DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Conecta Empresa =======================================================
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         Refresh;
         bSiga:=False;

         If sgLojasNConectadas='' Then
          sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
         Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
          sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then

      // Inicia Processamento ==================================================
      If bSiga Then // Empresa Conectada
      Begin
        // Cria Query da Empresa ------------------------------------
        CriaQueryIB('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                    'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                    IBQ_ConsultaFilial, True, True);

        // Busca Comprovantes ---------------------------------------
        IBQ_ConsultaFilial.SQL.Clear;
        IBQ_ConsultaFilial.SQL.Add(MySql);
        IBQ_ConsultaFilial.Params.ParamByName('CodFilial').Value:=sgCodEmp;

        // Abre Query -----------------------------------------------
        i:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            IBQ_ConsultaFilial.Open;
            bSiga:=True;
          Except
            Inc(i);
          End; // Try

          If i>10 Then
          Begin
            If sgLojasNConectadas='' Then
             sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
            Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
             sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
          End; // If i>10 Then
        End; // While Not bSiga do

        // Processamento =======================================================
        If bSiga Then // Query Executada
        Begin
          ii:=IBQ_ConsultaFilial.FieldByName('Controle').AsInteger;
          While Not IBQ_ConsultaFilial.Eof do
          Begin
            Refresh;

            s:=Trim(IBQ_ConsultaFilial.FieldByName('Nome').AsString);
            
            // Localiza Plano de Contas -----------------------------
            If DMVirtual.CDS_V_PlanoContasCompr200.Locate('Des_PlanoContas',s,[]) Then
             Begin
               DMVirtual.CDS_V_PlanoContasCompr200.Edit;
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName(sCampo).AsCurrency:=
                          DMVirtual.CDS_V_PlanoContasCompr200.FieldByName(sCampo).AsCurrency+
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;                             
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                          DMVirtual.CDS_V_PlanoContasCompr200.FieldByName('Vlr_Empresa_Total').AsCurrency+
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
               DMVirtual.CDS_V_PlanoContasCompr200.Post;
             End
            Else // If DMVirtual.CDS_V_PlanoContasCompr200.Locate('Des_PlanoContas',s,[]) Then
             Begin
               DMVirtual.CDS_V_PlanoContasCompr200.Append;

               For i:=1 to DMVirtual.CDS_V_PlanoContasCompr200.Fields.Count-1 do
                DMVirtual.CDS_V_PlanoContasCompr200.Fields[i].Value:=0;
               
               DMVirtual.CDS_V_PlanoContasCompr200Des_PlanoContas.AsString:=s;
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName(sCampo).AsCurrency:=
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;                             
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
               DMVirtual.CDS_V_PlanoContasCompr200.Post;
             End; // If DMVirtual.CDS_V_PlanoContasCompr200.Locate('Des_PlanoContas',s,[]) Then

             // Total do Ciomprovante 200 na Empresa 
            If DMVirtual.CDS_V_PlanoContasCompr200.Locate('Des_PlanoContas','-- TOTAL GERAL --',[]) Then
             Begin
               DMVirtual.CDS_V_PlanoContasCompr200.Edit;
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName(sCampo).AsCurrency:=
                          DMVirtual.CDS_V_PlanoContasCompr200.FieldByName(sCampo).AsCurrency+
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;                             
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                          DMVirtual.CDS_V_PlanoContasCompr200.FieldByName('Vlr_Empresa_Total').AsCurrency+
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
               DMVirtual.CDS_V_PlanoContasCompr200.Post;
             End
            Else // If DMVirtual.CDS_V_PlanoContasCompr200.Locate('Des_PlanoContas',s,[]) Then
             Begin                            
               DMVirtual.CDS_V_PlanoContasCompr200.Append;

               For i:=1 to DMVirtual.CDS_V_PlanoContasCompr200.Fields.Count-1 do
                DMVirtual.CDS_V_PlanoContasCompr200.Fields[i].Value:=0;
               
               DMVirtual.CDS_V_PlanoContasCompr200Des_PlanoContas.AsString:='-- TOTAL GERAL --';
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName(sCampo).AsCurrency:=
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
               DMVirtual.CDS_V_PlanoContasCompr200.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                          IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
               DMVirtual.CDS_V_PlanoContasCompr200.Post;
             End; // If DMVirtual.CDS_V_PlanoContasCompr200.Locate('Des_PlanoContas',s,[]) Then

            IBQ_ConsultaFilial.Next;
          End; // While Not IBQ_ConsultaFilial.Eof do
        End; // If bSiga Then // Query Executada
      End; //If bSiga Then // Empresa Conectada

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    
    DMVirtual.CDS_V_PlanoContasCompr200.First;
    
    // Apresenta o Processamento ------------------------------------
    OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
    Refresh;

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do
            
End; // Planilha Plano de Contas - Comprovante 200 >>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Planilha Financeira - Calcula Meses Individuais >>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CalculaMesesIndividuais(sCodEmp: String);
Var
  i, ii, iii: Integer;
  s, sMeses: String;
  MySql: String;
  bSiga: Boolean;
begin

  Memo3.Lines.Clear;
  Memo3.Width:=500;

  // Monta Meses Individais ====================================================
  If (Copy(sgMesAnoPlanFinanceira,1,20)=' And (m.comp_anomes=') Then
   Begin
     s:=sgMesAnoPlanFinanceira;
     s:=f_Troca(' And (m.comp_anomes=','',s);
     s:=f_Troca(' Or m.comp_anomes=','',s);
     s:=f_Troca(')','',s);
     s:=f_Troca('''','-',s);
     s:=Copy(s,2,Length(s));
     s:=Copy(s,1,Length(s)-1);
     s:=f_Troca('--',';',s);
     s:=s+';';

     ii:=0;
     For i:=length(s) downto 1 do
     Begin
       If s[i]=';' Then
        ii:=ii+1;
     End;
    
     If ii>=11 Then
      iii:=11
     Else
      iii:=ii-1;
     
     For i:=iii downto 0 do
     Begin
       sMeses:=Separa_String(s,ii-i);
       sMeses:=Copy(sMeses,7,4)+'/'+Copy(sMeses,4,2);

       If Length(sMeses)=6 Then
        sMeses:='0'+Copy(sMeses,6,1)+'/'+Copy(sMeses,1,4)
       Else
        sMeses:=Copy(sMeses,6,2)+'/'+Copy(sMeses,1,4);

        Memo3.Lines.Add(sMeses);
     End; // For i:=iii downto 0 do
   End // If (Copy(sgMesAnoPlanFinanceira,1,20)=' And (m.comp_anomes=') Then
  Else
   Begin
     MesesAnoPeirodo(FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaInicio.Date, FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaFim.Date, Memo3);
   End; // If (Copy(sgMesAnoPlanFinanceira,1,20)=' And (m.comp_anomes=') Then

  bSiga:=True;
  If Memo3.Lines.Count<2 Then
   bSiga:=False;

  // Calcula Valores Individuais dos Meses ===================================== 
  If bSiga Then
  Begin
    // Libera Colunas dos Meses ================================================
    iii:=0;
    For i:=0 to Memo3.Lines.Count-1 do
    Begin
      Inc(iii);
      If iii < 10 Then
       s:='0'+IntToStr(iii)
      Else
       s:=IntToStr(iii);

      For ii:=0 to DMVirtual.CDS_V_PlanFinanceira.Fields.Count-1 do
      Begin
        If DMVirtual.CDS_V_PlanFinanceira.Fields[ii].FieldName='Vlr_Mes'+s Then
        Begin                                                   
          DMVirtual.CDS_V_PlanFinanceira.Fields[ii].Visible:=True;
          DMVirtual.CDS_V_PlanFinanceira.Fields[ii].DisplayLabel:=Memo3.Lines[i];
          Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Title.Alignment:=taRightJustify;          
        End; // If DMVirtual.CDS_V_PlanFinanceira.Fields[ii].FieldName='Vlr_mes'+Copy(Memo3.Lines[i],1,2) Then
      End; // For ii:=0 to DMVirtual.CDS_V_PlanFinanceira.Fields.Count-1 do
    End; // For i:=0 to Memo3.Lines.Count-1 do
    
    // Busca Movtos Por Mes ====================================================
    MySql:=' Select m.codcomprovante,'+
           ' Cast(lpad(extract(month from m.datadocumento),2,''0'') as varchar(2))||''/''||'+
           ' Cast(lpad(extract(Year  from m.datadocumento),4,''0'') as varchar(4)) MesAno,'+
           ' Sum(m.totnota) Vlr_Total'+
           ' From MCLI m'+
           ' Where m.codfilial='+QuotedStr(sgCodEmp)+
           sgMesAnoPlanFinanceira+
           ' And m.chavenf<>'''''+

           ' And not exists'+
           ' (Select 1'+
           '  From mclipago mm'+
           '  Where mm.chavenf=m.chavenf'+
           '  And mm.codfilial=m.codfilial'+
           '  And mm.chavenf<>'''')'+
           ' Group By 1,2'+

           ' UNION'+ // Unio ===========================

           ' Select m1.codcomprovante,'+
           ' Cast(lpad(extract(month from m1.dataentrada ),2,''0'') as varchar(2))||''/''||'+
           ' Cast(lpad(extract(Year  from m1.dataentrada ),4,''0'') as varchar(4)) MesAno,'+
           ' Sum(m1.totnota) Vlr_Total'+
           ' From MFOR m1'+
           ' Where m1.codfilial='+QuotedStr(sgCodEmp)+
           f_Troca('m.','m1.',f_troca('datadocumento','dataentrada',sgMesAnoPlanFinanceira))+
           ' And m1.chavenf<>'''''+

           ' And Not Exists'+
           ' (Select 1'+
           '  From mforpago mm1'+
           '  Where mm1.chavenf=m1.chavenf'+
           '  And mm1.codfilial=m1.codfilial'+
           '  And mm1.chavenf<>'''')'+
           ' Group by 1,2'+

           ' UNION'+ // Unio ===========================

           ' Select p.codcomprovante,'+
           ' Cast(lpad(extract(month from p.datapagamento ),2,''0'') as varchar(2))||''/''||'+
           ' Cast(lpad(extract(Year  from p.datapagamento ),4,''0'') as varchar(4)) MesAno,'+
           ' Sum(p.totnota) Vlr_Total'+
           ' From mclipago p'+
           ' Where p.codfilial='+QuotedStr(sgCodEmp)+
           f_Troca('m.','p.',f_troca('datadocumento','datapagamento',sgMesAnoPlanFinanceira))+
           ' And p.chavenf<>'''''+
           ' Group By 1,2'+

           ' UNION'+ // Unio ===========================

           ' Select p1.codcomprovante,'+
           ' Cast(lpad(extract(month from p1.datapagamento ),2,''0'') as varchar(2))||''/''||'+
           ' Cast(lpad(extract(Year  from p1.datapagamento ),4,''0'') as varchar(4)) MesAno,'+
           ' Sum(p1.totnota) Vlr_Total'+
           ' From mforpago p1'+
           ' Where p1.codfilial='+QuotedStr(sgCodEmp)+
           f_Troca('m.','p1.',f_troca('datadocumento','datapagamento',sgMesAnoPlanFinanceira))+
           ' And p1.chavenf<>'''''+
           ' Group By 1,2'+

           ' order by 1, 2';
    IBQ_ConsultaFilial.SQL.Clear;
    IBQ_ConsultaFilial.SQL.Add(MySql);

    // Abre Query -----------------------------------------------
    i:=0;
    bSiga:=False;
    While Not bSiga do
    Begin
      Try
        IBQ_ConsultaFilial.Open;
        bSiga:=True;
      Except
        Inc(i);
      End; // Try

      If i>10 Then
      Begin
        msg('Conexo Perdida !!'+cr+'Filial: '+sCodFilial+cr+cr+'NO Ser Gerada !!','A');
        Break;
      End; // If i>10 Then
    End; // While Not bSiga do

    // Processamento ===========================================================
    If bSiga Then // Query Executada
    Begin
      While Not IBQ_ConsultaFilial.Eof do
      Begin
        Refresh;

        If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',IBQ_ConsultaFilial.FieldByNAme('CodComprovante').AsString,[]) Then
        Begin
          s:=IBQ_ConsultaFilial.FieldByNAme('MesAno').AsString;
          For ii:=0 to DMVirtual.CDS_V_PlanFinanceira.Fields.Count-1 do
          Begin
            If DMVirtual.CDS_V_PlanFinanceira.Fields[ii].DisplayLabel=s Then
            Begin
              s:=DMVirtual.CDS_V_PlanFinanceira.Fields[ii].FieldName;
              DMVirtual.CDS_V_PlanFinanceira.Edit;
              DMVirtual.CDS_V_PlanFinanceira.FieldByName(s).AsCurrency:=
                           IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
              DMVirtual.CDS_V_PlanFinanceira.Post;
            End; // If DMVirtual.CDS_V_PlanFinanceira.Fields[ii].DisplayLabel=s Then
          End; // For ii:=0 to DMVirtual.CDS_V_PlanFinanceira.Fields.Count-1 do
        End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',IBQ_ConsultaFilial.FieldByNAme('Cod_Comprovante').AsString,[]) Then
        IBQ_ConsultaFilial.Next;
      End; // While Not IBQ_ConsultaFilial.Eof do

      IBQ_ConsultaFilial.Close;
    End; // If bSiga Then // Query Executada

  End; // If bSiga Then  // Calcula Valores Individuais dos Meses

End; // Planilha Financeira - Calcula Meses Individuais >>>>>>>>>>>>>>>>>>>>>>>>

// Calcula Curva ABC e Endereamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.CalculaCurvaABCEndereco: Boolean;
Var
  MySql: String;

  sEmpresas, // Codigos das Lojas Sidicom
  sEmpLinx,  // Codigos das Lojas Linx
  sDtaI, sDtaF: String;

  i, iNrEmpProc, iTotCurvaA, iTotCurvaB, iTotCurvaC, iTotCurvaD, iTotCurvaE,
  iSeqOrdem, iSeqProd: Integer;

  cTotVlrDemandas, cTotQtdDemandas,
  cVlrAcum, cPerAcum, cTotalGeral,
  cPerCurvaA, cPerCurvaB, cPerCurvaC, cPerCurvaD, cPerCurvaE,
  cTotCurvaA, cTotCurvaB, cTotCurvaC, cTotCurvaD, cTotCurvaE: Currency;

  bCurvaA, bCurvaB, bCurvaC, bCurvaD,
  bIndexCriado: Boolean;

  bUsouCurvaA, bUsouCurvaB, bUsouCurvaC, bUsouCurvaD: Boolean;
Begin
  Result:=False;

  // Acerta Percentual das Curvas ==============================================
  cPerCurvaA:=EdtCurvaABCEndLimiteCurvaA.Value;
  cPerCurvaB:=cPerCurvaA+EdtCurvaABCEndLimiteCurvaB.Value;
  cPerCurvaC:=cPerCurvaB+EdtCurvaABCEndLimiteCurvaC.Value;
  cPerCurvaD:=cPerCurvaC+EdtCurvaABCEndLimiteCurvaD.Value;
  cPerCurvaE:=cPerCurvaD+EdtCurvaABCEndLimiteCurvaE.Value;

  // Cria Cadastro de Curva ABC e Endereamentos ===============================
  If DMVirtual.CDS_V_CurvaABCEndereco.Active Then
   DMVirtual.CDS_V_CurvaABCEndereco.Close;

  If Rb_CurvaABCEndTipoCalculoUnidades.Checked Then
   Begin
     DMVirtual.CDS_V_CurvaABCEndereco.Fields[4].DisplayLabel:='Qtd_Venda';
   End
  Else
   Begin
     DMVirtual.CDS_V_CurvaABCEndereco.Fields[4].DisplayLabel:='Vlr_Venda';
   End;

  // Cria ClientDataSet e Indice de Ordem ======================================
  DMVirtual.CDS_V_CurvaABCEndereco.CreateDataSet;
  bIndexCriado:=False;
  for i:=0 to DMVirtual.CDS_V_CurvaABCEndereco.IndexDefs.Count-1 do
   if DMVirtual.CDS_V_CurvaABCEndereco.IndexDefs[i].Name='ORDEM' Then
    bIndexCriado:=True;

  If not bIndexCriado Then
  With DMVirtual.CDS_V_CurvaABCEndereco.IndexDefs.AddIndexDef do
  Begin
    Name := 'ORDEM';
    Fields := 'VLR_REFERENCIA;PER_PARTICIPACAO;QTD_ESTOQUE';
    Options := [ixDescending];
  End;
  DMVirtual.CDS_V_CurvaABCEndereco.IndexName := 'ORDEM';
  DMVirtual.CDS_V_CurvaABCEndereco.Open;

  // Solicita Empresas =========================================================
  sgOutrasEmpresa:='(99)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;
  FrmSelectEmpProcessamento.Pan_SelectEmpProcECommerce.Visible:=True;

  FrmSelectEmpProcessamento.ShowModal;

  // Se Processa Produtos E-Commerce ===========================================
  bgECommerce:=FrmSelectEmpProcessamento.Ckb_SelectEmpProcECommerce.Checked;

  igNrEmpProc:=FrmSelectEmpProcessamento.iNrEmpProc;
  iNrEmpProc:=FrmSelectEmpProcessamento.iNrEmpProc;

  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Existe Empresa a Processar ====================================
  If DMBelShop.CDS_EmpProcessa.Eof Then
  Begin
    DMVirtual.CDS_V_CurvaABCEndereco.Close;
    EdtCurvaABCEndLimiteCurvaA.SetFocus;
    Exit;
  End;

  // Verifica se Processa Todas as Empresas ====================================
  sEmpresas:='';
  bgTodasEmpresas:=True;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       // Atualiza sEmpresa Sidicom ---------------------------------
       If sEmpresas='' Then
        sEmpresas:=QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString)
       Else
        sEmpresas:=sEmpresas+', '+QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);

       // Atualiza sEmpLinx Linx ------------------------------------
       If sEmpLinx='' Then
        sEmpLinx:=DMBelShop.CDS_EmpProcessaCOD_LINX.AsString
       Else
        sEmpLinx:=sEmpLinx+', '+DMBelShop.CDS_EmpProcessaCOD_LINX.AsString;
     End
    Else // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       bgTodasEmpresas:=False;
     End; // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; //   While Not DMBelShop.CDS_EmpProcessa.Eof do

  If Trim(sEmpresas)<>'' Then
   sEmpresas:='('+sEmpresas+')';

  If Trim(sEmpLinx)<>'' Then
   sEmpLinx:='('+sEmpLinx+')';

  // Apresenta o Processamento =================================================
  OdirPanApres.Caption:='AGUARDE !! Fase 1/4: Localizando Produtos e Demandas...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Acerta Perodo ============================================================
  sDtaI:='01.'+Copy(DtEdt_CurvaABCEndInicio.Text,4,2)+'.'+Copy(DtEdt_CurvaABCEndInicio.Text,7,4);
  sDtaF:='01.'+Copy(DtEdt_CurvaABCEndFim.Text,4,2)+'.'+Copy(DtEdt_CurvaABCEndFim.Text,7,4);

  // Busca Valor e Quantidade Total de Demandas ================================
  MySql:=' SELECT SUM(COALESCE(mt.quant_ref,0.00)) Tot_Qtd_Demanda,'+
         ' SUM(COALESCE(mt.preco,0.00)) Tot_Vlr_Demanda'+

         ' FROM MOVTOS_EMPRESAS mt, produto pt'+

         ' WHERE  mt.codproduto=pt.codproduto'+
         ' AND  mt.ind_tipo=''DM'''+
         ' AND  mt.dta_ref>='+QuotedStr(sDtaI)+
         ' AND  mt.dta_ref<='+QuotedStr(sDtaF);

         // Loja
         If Not bgTodasEmpresas Then
          MySql:=
           MySql+' AND   mt.codfilial IN '+sEmpresas;

         // Produtos Codigos e/ou Produtos Like ---------------------
         If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
          MySql:=
           MySql+' AND (pt.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','pt.',sgLikeProdutos)+')'
         Else If Trim(sgProdutos)<>'' Then
          MySql:=
           MySql+' AND pt.CodProduto in ('+sgProdutos+')'
         Else If Trim(sgLikeProdutos)<>'' Then
          MySql:=
           MySql+' AND '+f_Troca('pr.','pt.',sgLikeProdutos);

         // Fornecedore
         If Trim(sgFornecedores)<>'' Then
          MySql:=
           MySql+' AND   pt.principalfor IN ('+sgFornecedores+')'
         Else
          MySql:=
           MySql+' AND   pt.principalfor NOT IN (''010000'', ''000300'', ''000500'', ''001072'')';

         // Situacao dos Produtos
         If Cbx_CurvaABCEndSituacaoProd.ItemIndex=0 Then
          MySql:=
           MySql+' AND   Coalesce(pt.situacaopro,0)=0';

         If Cbx_CurvaABCEndSituacaoProd.ItemIndex=1 Then
          MySql:=
           MySql+' AND   Coalesce(pt.situacaopro,3)=3';

         If Cbx_CurvaABCEndSituacaoProd.ItemIndex=2 Then
          MySql:=
           MySql+' AND   Coalesce(pt.situacaopro,0) in (0,3)';

         // Grupos e SubGrupos --------------------------------
         If TRIM(sgGrupos)<>'' THEN
          MySql:=
            MySql+' AND '+f_Troca('p.','pt.',sgGrupos);

        If Trim(sgAplicacoes)<>'' Then
         MySql:=
          MySql+' AND pt.CodAplicacao in ('+sgAplicacoes+')';

        If bgECommerce Then
         MySql:=
          MySql+' AND pt.ecommerce_sn=''S''';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;
  cTotQtdDemandas:=DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Qtd_Demanda').AsCurrency;
  cTotVlrDemandas:=DMBelShop.CDS_BuscaRapida.FieldByName('Tot_Vlr_Demanda').AsCurrency;
  DMBelShop.CDS_BuscaRapida.Close;

  // Busca Produtos e Demandas =================================================
  MySql:=' SELECT'+
         ' 1 Seq, pr.codproduto cod_produto, pr.apresentacao Des_produto, ''E'' IND_CURVA,';

         If Rb_CurvaABCEndTipoCalculoUnidades.Checked Then
          Begin
            MySql:=
             MySql+' SUM(Coalesce(md.quant_ref,0,00)) VLR_REFERENCIA,'+
                   ' CASE'+
                   '   WHEN ((SUM(COALESCE(md.quant_ref,0.00))=0) or ('+f_Troca(',','.',CurrToStr(cTotQtdDemandas))+'=0)) THEN'+
                   '     0'+
                   '   ELSE'+
                   '     ROUND(((SUM(COALESCE(md.quant_ref,0.00))*100)/'+f_Troca(',','.',CurrToStr(cTotQtdDemandas))+'),4)'+
                   ' END PER_PARTICIPACAO,';
          End
         Else
          Begin
            MySql:=
             MySql+' SUM(COALESCE(md.preco,0.00)) VLR_REFERENCIA,'+
                   ' CASE'+
                   '   WHEN ((SUM(COALESCE(md.preco,0.00))=0) or ('+f_Troca(',','.',CurrToStr(cTotVlrDemandas))+'=0)) THEN'+
                   '     0'+
                   '   ELSE'+
                   '     ROUND(((SUM(COALESCE(md.preco,0.00))*100)/'+f_Troca(',','.',CurrToStr(cTotVlrDemandas))+'),4)'+
                   ' END PER_PARTICIPACAO,';
          End; // If Rb_CurvaABCEndTipoCalculoUnidades.Checked Then

  MySql:=
   MySql+' pr.datainclusao DTA_INCLUSAO,'+
         ' 0.00 QTD_ESTOQUE, 0.00 EST_IDEAL, 0.00 EST_MAXIMO,'+
         ' lp.precocompra VLR_PC_CUSTO, 0.00 VLR_TOTAL_CUSTO,'+
         ' lp.precovenda VLR_PC_VENDA, 0.00 VLR_TOTAL_VENDA,'+

         ' CASE'+
         '   WHEN (COALESCE(lp.precovenda,0.00)=0) OR (COALESCE(lp.precocompra,0.00)=0) THEN'+
         '     0'+
         '   ELSE'+
         '     CAST((((COALESCE(lp.precovenda,0.00)*100)/COALESCE(lp.precocompra,0.00))-100) AS NUMERIC(12,4))'+
         ' END PER_MARGEM,'+

         ' 0.00 VLR_MARGEM,'+
         ' 0 DES_ZONA, ''000'' DES_CORREDOR, ''000'' DES_PRATELEIRA, ''0000'' DES_GAVETA,'+

         ' CASE'+
         '   WHEN Coalesce(pr.situacaopro,0)=0 THEN ''Ativo'''+
         '   WHEN pr.situacaopro=1 THEN ''Bloqueado'''+
         '   WHEN pr.situacaopro=2 THEN ''Excluido'''+
         '   WHEN pr.situacaopro=3 THEN ''No Compra'''+
         '   WHEN pr.situacaopro=4 THEN ''No Venda'''+
         '   ELSE ''Sem Informao'''+
         ' END IND_SITUACAO,'+

         ' pr.PrincipalFor COD_FORNECEDOR, pr.nomefornecedor DES_FORNECEDOR,'+
         ' ''NAO'' IND_EMP_ATUALIZADA,'+
         ' SUM(COALESCE(md.quant_ref,0.00)) QTD_DEMANDA,'+
         ' 0 ORDENAR'+

         ' FROM MOVTOS_EMPRESAS md, PRODUTO pr, LISTAPRE lp'+

         ' WHERE md.codproduto=pr.codproduto'+
         ' AND   pr.codproduto=lp.codproduto'+
         ' AND   md.ind_tipo=''DM'''+
         ' AND   lp.codlista='+QuotedStr(FormatFloat('0000',EdtCurvaABCEndCodLista.AsInteger))+
         ' AND   md.dta_ref>='+QuotedStr(sDtaI)+
         ' AND   md.dta_ref<='+QuotedStr(sDtaF);

         // Loja
         If Not bgTodasEmpresas Then
          MySql:=
           MySql+' AND   md.codfilial IN '+sEmpresas;

         // Produtos Codigos e/ou Produtos Like ---------------------
         If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
          MySql:=
           MySql+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
         Else If Trim(sgProdutos)<>'' Then
          MySql:=
           MySql+' AND pr.CodProduto in ('+sgProdutos+')'
         Else If Trim(sgLikeProdutos)<>'' Then
          MySql:=
           MySql+' AND '+sgLikeProdutos;

         // Fornecedores
         If TRIM(sgFornecedores)<>'' Then
          MySql:=
           MySql+' AND   pr.principalfor IN ('+sgFornecedores+')'
         Else
          MySql:=
           MySql+' AND pr.principalfor NOT IN (''010000'', ''000300'', ''000500'', ''001072'')';

         // Situacao dos Produtos
         If Cbx_CurvaABCEndSituacaoProd.ItemIndex=0 Then
          MySql:=
           MySql+' AND   Coalesce(pr.situacaopro,0)=0';

         If Cbx_CurvaABCEndSituacaoProd.ItemIndex=1 Then
          MySql:=
           MySql+' AND   Coalesce(pr.situacaopro,3)=3';

         If Cbx_CurvaABCEndSituacaoProd.ItemIndex=2 Then
          MySql:=
           MySql+' AND   Coalesce(pr.situacaopro,0) in (0,3)';

         // Grupos e SubGrupos --------------------------------
         If Trim(sgGrupos)<>'' THEN
          MySql:=
            MySql+' AND '+f_Troca('p.','pr.',sgGrupos);

         If Trim(sgAplicacoes)<>'' Then
          MySql:=
           MySql+' AND pr.CodAplicacao in ('+sgAplicacoes+')';

        If bgECommerce Then
         MySql:=
          MySql+' AND pr.ecommerce_sn=''S''';

  MySql:=
   MySql+' GROUP BY 2,3,4,7,11,13,21,22,23'+
         ' ORDER BY 2, 4';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  // Insere Produtos Sem Movimentao mais Ativos ==============================
  OdirPanApres.Caption:='AGUARDE !! Fase 2/4: Analisando Produtos para Calculo da Curva ABC...';
  Refresh;

  MontaProgressBar(True, FrmBelShop);
  pgProgBar.Properties.Max:=DMBelShop.CDS_Busca.RecordCount;
  pgProgBar.Position:=0;
  DMBelShop.CDS_Busca.DisableControls;
  DMVirtual.CDS_V_CurvaABCEndereco.DisableControls;
  While not DMBelShop.CDS_Busca.Eof do
  Begin
    Application.ProcessMessages;

    If sgCodProd<>DMBelShop.CDS_Busca.FieldByName('cod_produto').AsString Then
    Begin
      DMVirtual.CDS_V_CurvaABCEndereco.Append;

      For i:=0 to DMBelShop.CDS_Busca.FieldCount-1 do
      Begin
        If i=3 Then
         DMVirtual.CDS_V_CurvaABCEndereco.Fields[i].AsString:='E'
        Else
         DMVirtual.CDS_V_CurvaABCEndereco.Fields[i].Assign(DMBelShop.CDS_Busca.Fields[i]);
      End;

      DMVirtual.CDS_V_CurvaABCEndereco.Post;
    End; // If sgCodProd<>DMBelShop.CDS_Busca.FieldByName('cod_produto').AsString Then

    pgProgBar.Position:=DMBelShop.CDS_Busca.RecNo;

    sgCodProd:=DMBelShop.CDS_Busca.FieldByName('cod_produto').AsString;

    DMBelShop.CDS_Busca.Next;
  End; // While not DMBelShop.CDS_Busca.Eof do
  DMBelShop.CDS_Busca.EnableControls;
  DMVirtual.CDS_V_CurvaABCEndereco.EnableControls;
  DMBelShop.CDS_Busca.Close;
  MontaProgressBar(False, FrmBelShop);

  // Busca Estoques ============================================================
  OdirPanApres.Caption:='AGUARDE !! Fase 3/4: Localizando Estoques...';
  Refresh;

  sgLojasNConectadas:='';

  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Fase 3/4: Localizando Estoques !! Loja: Bel_'+sgCodEmp;
      Refresh;

      // Inicia Processamento ==================================================
      MySql:=' SELECT 1 Seq,'+
             ' pr.codproduto cod_produto, pr.apresentacao Des_produto, ''E'' IND_CURVA,'+
             ' 0.00 VLR_REFERENCIA, 0.00 PER_PARTICIPACAO, pr.datainclusao DTA_INCLUSAO,'+
             ' cast(coalesce(es.saldoatual,0.00) as numeric(12,2)) QTD_ESTOQUE,'+
             ' Coalesce(es.estoqueideal,0) EST_IDEAL,'+
             ' Coalesce(es.estoquemaximo,999999999) EST_MAXIMO,'+
             ' lp.precocompra VLR_PC_CUSTO,'+
             ' ((cast(coalesce(es.saldoatual,0) as numeric(12,2)))*lp.precocompra) VLR_TOTAL_CUSTO,'+
             ' lp.precovenda VLR_PC_VENDA,'+
             ' ((cast(coalesce(es.saldoatual,0) as numeric(12,2)))*lp.precovenda) VLR_TOTAL_VENDA,'+
             ' CASE'+
             '   WHEN (COALESCE(lp.precovenda,0.00)=0) OR (COALESCE(lp.precocompra,0.00)=0) THEN'+
             '    0'+
             '   ELSE'+
             '    CAST((((COALESCE(lp.precovenda,0.00)*100)/COALESCE(lp.precocompra,0.00))-100) AS NUMERIC(12,4))'+
             ' END PER_MARGEM,'+

             ' ((cast(coalesce(es.saldoatual,0) as numeric(12,2)))*lp.precovenda)-'+
             ' ((cast(coalesce(es.saldoatual,0) as numeric(12,2)))*lp.precocompra) VLR_MARGEM,'+
             ' 0 DES_ZONA, ''000'' DES_CORREDOR, ''000'' DES_PRATELEIRA, ''0000'' DES_GAVETA,'+

             ' CASE'+
             '   WHEN Coalesce(pr.situacaopro,0)=0 THEN ''Ativo'''+
             '   WHEN pr.situacaopro=1 THEN ''Bloqueado'''+
             '   WHEN pr.situacaopro=2 THEN ''Excluido'''+
             '   WHEN pr.situacaopro=3 THEN ''No Compra'''+
             '   WHEN pr.situacaopro=4 THEN ''No Venda'''+
             '   ELSE ''Sem Informao'''+
             ' END IND_SITUACAO,'+

             ' pr.PrincipalFor COD_FORNECEDOR, pr.nomefornecedor  DES_FORNECEDOR,'+
             ' ''NAO'' IND_EMP_ATUALIZADA, 0.00 QTD_DEMANDA, 0 ORDENAR'+

             ' FROM PRODUTO pr, ESTOQUE es, LISTAPRE lp'+

             ' WHERE pr.codproduto=es.codproduto'+
             ' AND   pr.codproduto=lp.codproduto'+
             ' AND   lp.codlista='+QuotedStr(FormatFloat('0000',EdtCurvaABCEndCodLista.AsInteger))+
             ' AND   es.codfilial='+QuotedStr(sgCodEmp)+
             ' AND   COALESCE(es.saldoatual,0)>0';

             // Situao do Produto -------------------------------
             If Cbx_CurvaABCEndSituacaoProd.ItemIndex=0 Then
              MySql:=
               MySql+' AND Coalesce(pr.situacaopro,0)=0';

             If Cbx_CurvaABCEndSituacaoProd.ItemIndex=1 Then
              MySql:=
               MySql+' AND Coalesce(pr.situacaopro,3)=3';

             If Cbx_CurvaABCEndSituacaoProd.ItemIndex=2 Then
              MySql:=
               MySql+' AND Coalesce(pr.situacaopro,0) in (0,3)';

             // Produtos Codigos e/ou Produtos Like ---------------------
             If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
              MySql:=
               MySql+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
             Else If Trim(sgProdutos)<>'' Then
              MySql:=
               MySql+' AND pr.CodProduto in ('+sgProdutos+')'
             Else If Trim(sgLikeProdutos)<>'' Then
              MySql:=
               MySql+' AND '+sgLikeProdutos;

             // Fornecedores -------------------------------------
             If Trim(sgFornecedores)<>'' Then
              MySql:=
               MySql+' AND pr.principalfor in ('+sgFornecedores+')'
             Else
              MySql:=
               MySql+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

             // Grupos e SubGrupos --------------------------------
             If Trim(sgGrupos)<>'' THEN
              MySql:=
               MySql+' and '+f_Troca('p.','pr.',sgGrupos);

             If Trim(sgAplicacoes)<>'' Then
              MySql:=
               MySql+' and pr.CodAplicacao in ('+sgAplicacoes+')';

             If bgECommerce Then
              MySql:=
               MySql+' AND pr.ecommerce_sn=''S''';

      MySql:=
       MySql+' ORDER BY es.codproduto';
      DMBelShop.CDS_Busca1.Close;
      DMBelShop.SDS_Busca1.CommandText:=MySql;
      DMBelShop.CDS_Busca1.Open;

      MontaProgressBar(True, FrmBelShop);
      pgProgBar.Properties.Max:=DMBelShop.CDS_Busca1.RecordCount;
      pgProgBar.Position:=0;

      // Processamento =======================================================
      DMBelShop.CDS_Busca1.First;
      DMBelShop.CDS_Busca1.DisableControls;
      DMVirtual.CDS_V_CurvaABCEndereco.DisableControls;
      While Not DMBelShop.CDS_Busca1.Eof do
      Begin
        Application.ProcessMessages;

        pgProgBar.Position:=DMBelShop.CDS_Busca1.RecNo;
        Refresh;

        Refresh;
        If DMVirtual.CDS_V_CurvaABCEndereco.Locate('COD_PRODUTO', DMBelShop.CDS_Busca1.FieldByName('Cod_Produto').AsString,[]) Then
         Begin
           DMVirtual.CDS_V_CurvaABCEndereco.Edit;
           DMVirtual.CDS_V_CurvaABCEnderecoQTD_ESTOQUE.AsCurrency:=
                         DMVirtual.CDS_V_CurvaABCEnderecoQTD_ESTOQUE.AsCurrency+
                     DMBelShop.CDS_Busca1.FieldByName('QTD_ESTOQUE').AsCurrency;

           DMVirtual.CDS_V_CurvaABCEnderecoEST_IDEAL.AsCurrency:=
                           DMVirtual.CDS_V_CurvaABCEnderecoEST_IDEAL.AsCurrency+
                       DMBelShop.CDS_Busca1.FieldByName('EST_IDEAL').AsCurrency;

           DMVirtual.CDS_V_CurvaABCEnderecoEST_MAXIMO.AsCurrency:=
                      DMBelShop.CDS_Busca1.FieldByName('EST_MAXIMO').AsCurrency;

           DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_CUSTO.AsCurrency:=
                         DMVirtual.CDS_V_CurvaABCEnderecoQTD_ESTOQUE.AsCurrency*
                        DMVirtual.CDS_V_CurvaABCEnderecoVLR_PC_CUSTO.AsCurrency;

           DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_VENDA.AsCurrency:=
                         DMVirtual.CDS_V_CurvaABCEnderecoQTD_ESTOQUE.AsCurrency*
                        DMVirtual.CDS_V_CurvaABCEnderecoVLR_PC_VENDA.AsCurrency;

           DMVirtual.CDS_V_CurvaABCEnderecoVLR_MARGEM.AsCurrency:=
                     DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_VENDA.AsCurrency-
                     DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_CUSTO.AsCurrency;
         End
        Else // If DMVirtual.CDS_V_CurvaABCEndereco.Locate('COD_PRODUTO', DMBelShop.CDS_Busca1.FieldByName('Cod_Produto').AsString,[]) Then
         Begin
           DMVirtual.CDS_V_CurvaABCEndereco.Append;
           For i:=0 to DMBelShop.CDS_Busca1.FieldCount-1 do
           Begin
             DMVirtual.CDS_V_CurvaABCEndereco.Fields[i].Assign(DMBelShop.CDS_Busca1.Fields[i]);
           End;
         End;  // If DMVirtual.CDS_V_CurvaABCEndereco.Locate('COD_PRODUTO', DMBelShop.CDS_Busca1.FieldByName('Cod_Produto').AsString,[]) Then
        DMVirtual.CDS_V_CurvaABCEndereco.Post;

        DMBelShop.CDS_Busca1.Next;
      End; // While Not DMBelShop.CDS_Busca1.Eof do
      DMBelShop.CDS_Busca1.EnableControls;
      DMBelShop.CDS_Busca1.Close;
      DMVirtual.CDS_V_CurvaABCEndereco.EnableControls;
      MontaProgressBar(False, FrmBelShop);

      // Apresenta o Processamento ------------------------------------
      OdirPanApres.Caption:='AGUARDE !! Fase 3/4: Localizando Estoques...';
      Refresh;
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  // Efetua o Calculo da Curva ABC =============================================
  Application.ProcessMessages;

  If gCDS_V_Geral<>nil Then
  Begin
    FreeAndNil(gCDS_V_Geral);
    FreeAndNil(gDS);
  End;

  try
    gCDS_V_Geral:=TClientDataSet.Create(Self);
    gDS:=TDataSource.Create(Self);
  Except
    gCDS_V_Geral.EmptyDataSet;
  End;

  gCDS_V_Geral.FieldDefs.Clear;

  gCDS_V_Geral.FieldDefs.Add('Cod_Forn',ftString,6);
  gCDS_V_Geral.FieldDefs.Add('Fornecedor',ftString,60);
  gCDS_V_Geral.FieldDefs.Add('Curva_A',ftInteger);
  gCDS_V_Geral.FieldDefs.Add('Curva_B',ftInteger);
  gCDS_V_Geral.FieldDefs.Add('Curva_C',ftInteger);
  gCDS_V_Geral.FieldDefs.Add('Curva_D',ftInteger);
  gCDS_V_Geral.FieldDefs.Add('Curva_E',ftInteger);
  gCDS_V_Geral.FieldDefs.Add('Vlr_Referencia',ftFloat);
  gCDS_V_Geral.FieldDefs.Add('Qtd_Estoque',ftFloat);
  gCDS_V_Geral.FieldDefs.Add('Tot_Custo',ftFloat);
  gCDS_V_Geral.FieldDefs.Add('Tot_Venda',ftFloat);
  gCDS_V_Geral.FieldDefs.Add('Tot_Margem',ftFloat);
  gCDS_V_Geral.CreateDataSet;
  gCDS_V_Geral.Open;

 (gCDS_V_Geral.FieldByName('Vlr_Referencia') as TFloatField).DisplayFormat:='0.,00';
 (gCDS_V_Geral.FieldByName('Qtd_Estoque') as TFloatField).DisplayFormat:='0.,00';
 (gCDS_V_Geral.FieldByName('Tot_Custo') as TFloatField).DisplayFormat:='0.,00';
 (gCDS_V_Geral.FieldByName('Tot_Venda') as TFloatField).DisplayFormat:='0.,00';
 (gCDS_V_Geral.FieldByName('Tot_Margem') as TFloatField).DisplayFormat:='0.,00';

  If Rb_CurvaABCEndTipoCalculoUnidades.Checked Then
   gCDS_V_Geral.Fields[7].DisplayLabel:='Qtd_Venda'
  Else
   gCDS_V_Geral.Fields[7].DisplayLabel:='Vlr_Venda';

  gDS.DataSet:=gCDS_V_Geral;
  Dbg_CurvaABCEndCurvaABCForn.DataSource:=gDS;

  OdirPanApres.Caption:='AGUARDE !! Fase 4/4: Calculando Curva ABC...';
  Refresh;

  // Apresenta Total de Produtos ===============================================
  EdtCurvaABCEndTotalProdutos.AsInteger:=DMVirtual.CDS_V_CurvaABCEndereco.RecordCount;

  MontaProgressBar(True, FrmBelShop);
  pgProgBar.Properties.Max:=DMVirtual.CDS_V_CurvaABCEndereco.RecordCount;
  pgProgBar.Position:=0;

  // Inicializa Variaveis ======================================================
  iSeqProd:=0;
  iSeqOrdem:=12;

  cPerAcum:=0;

  iTotCurvaA:=0;
  iTotCurvaB:=0;
  iTotCurvaC:=0;
  iTotCurvaD:=0;
  iTotCurvaE:=0;

  cTotCurvaA:=0.00;
  cTotCurvaB:=0.00;
  cTotCurvaC:=0.00;
  cTotCurvaD:=0.00;
  cTotCurvaE:=0.00;

  bCurvaA:=False;
  bCurvaB:=False;
  bCurvaC:=False;
  bCurvaD:=False;

  // Inicia Processamento das Curva ============================================
  DMVirtual.CDS_V_CurvaABCEndereco.First;
  DMVirtual.CDS_V_CurvaABCEndereco.DisableControls;
  gCDS_V_Geral.DisableControls;
  While Not DMVirtual.CDS_V_CurvaABCEndereco.Eof do
  Begin
    Application.ProcessMessages;

    pgProgBar.Position:=DMVirtual.CDS_V_CurvaABCEndereco.RecNo;
    Refresh;

    Inc(iSeqProd);
    Inc(iSeqOrdem);

    DMVirtual.CDS_V_CurvaABCEndereco.Edit;
    DMVirtual.CDS_V_CurvaABCEnderecoSEQ.AsInteger:=iSeqProd;
    DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;

    If Trim(DMVirtual.CDS_V_CurvaABCEnderecoCOD_PRODUTO.AsString)<>'' Then
    Begin
      cPerAcum:=cPerAcum+DMVirtual.CDS_V_CurvaABCEnderecoPER_PARTICIPACAO.AsCurrency;

      // Curva "E" Qunando Vlr_Referencia = 0 ---------------------
      If DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency=0 Then
      Begin
        DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString:='E';
        Inc(iTotCurvaE);
      End
      Else // Curva "A" --------------------------------------------
      If (cPerAcum<=cPerCurvaA) Or (Not bUsouCurvaA) Then
      Begin
        bUsouCurvaA:=True;
        DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString:='A';
        cTotCurvaA:=cTotCurvaA+DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency;
        Inc(iTotCurvaA);
      End
      Else // Curva "B" ---------------------------------------------
      If (cPerAcum<=cPerCurvaB) Or (Not bUsouCurvaB) Then
      Begin
        bUsouCurvaB:=True;
        DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString:='B';
        cTotCurvaB:=cTotCurvaB+DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency;
        Inc(iTotCurvaB);
      End
      Else // Curva "C" ---------------------------------------------
      If (cPerAcum<=cPerCurvaC) Or (Not bUsouCurvaC) Then
      Begin
        bUsouCurvaC:=True;
        DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString:='C';
        cTotCurvaC:=cTotCurvaC+DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency;
        Inc(iTotCurvaC);
      End
      Else // Curva "D" ---------------------------------------------
      If (cPerAcum<=cPerCurvaD) Or (Not bUsouCurvaD) Then
      Begin
        bUsouCurvaD:=True;
        DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString:='D';
        cTotCurvaD:=cTotCurvaD+DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency;
        Inc(iTotCurvaD);
      End
      Else // Curva "E" ---------------------------------------------
      Begin
        DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString:='E';
        cTotCurvaE:=cTotCurvaE+DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency;
        Inc(iTotCurvaE);
      End;

      // Total por Fornecedor ==================================================
      If gCDS_V_Geral.Locate('Cod_Forn',DMVirtual.CDS_V_CurvaABCEnderecoCOD_FORNECEDOR.AsString,[]) Then
       Begin
         gCDS_V_Geral.Edit;

         If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='A' Then
          gCDS_V_Geral.FieldByName('Curva_A').AsInteger:=gCDS_V_Geral.FieldByName('Curva_A').AsInteger+1
         Else If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='B' Then
          gCDS_V_Geral.FieldByName('Curva_B').AsInteger:=gCDS_V_Geral.FieldByName('Curva_B').AsInteger+1
         Else If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='C' Then
          gCDS_V_Geral.FieldByName('Curva_C').AsInteger:=gCDS_V_Geral.FieldByName('Curva_C').AsInteger+1
         Else If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='D' Then
          gCDS_V_Geral.FieldByName('Curva_D').AsInteger:=gCDS_V_Geral.FieldByName('Curva_D').AsInteger+1
         Else
          gCDS_V_Geral.FieldByName('Curva_E').AsInteger:=gCDS_V_Geral.FieldByName('Curva_E').AsInteger+1;

         gCDS_V_Geral.FieldByName('Vlr_Referencia').AsCurrency:=
                          gCDS_V_Geral.FieldBYName('Vlr_Referencia').AsCurrency+
                      DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency;
         gCDS_V_Geral.FieldByName('Qtd_Estoque').AsCurrency:=
                             gCDS_V_Geral.FieldBYName('Qtd_Estoque').AsCurrency+
                         DMVirtual.CDS_V_CurvaABCEnderecoQTD_ESTOQUE.AsCurrency;
         gCDS_V_Geral.FieldByName('Tot_Custo').AsCurrency:=
                             gCDS_V_Geral.FieldBYName('Tot_Custo').AsCurrency+
                     DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_CUSTO.AsCurrency;
         gCDS_V_Geral.FieldByName('Tot_Venda').AsCurrency:=
                              gCDS_V_Geral.FieldBYName('Tot_Venda').AsCurrency+
                     DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_VENDA.AsCurrency;
         gCDS_V_Geral.FieldByName('Tot_Margem').AsCurrency:=
                              gCDS_V_Geral.FieldBYName('Tot_Margem').AsCurrency+
                          DMVirtual.CDS_V_CurvaABCEnderecoVLR_MARGEM.AsCurrency;
       End
      Else // If gCDS_V_Geral.Locate('Cod_Forn',DMVirtual.CDS_V_CurvaABCEnderecoCOD_FORNECEDOR.AsString,[]) Then
       Begin
         gCDS_V_Geral.Insert;
         gCDS_V_Geral.FieldByName('Cod_Forn').AsString:=
                        DMVirtual.CDS_V_CurvaABCEnderecoCOD_FORNECEDOR.AsString;
         gCDS_V_Geral.FieldByName('Fornecedor').AsString:=
                        DMVirtual.CDS_V_CurvaABCEnderecoDES_FORNECEDOR.AsString;

         gCDS_V_Geral.FieldByName('Curva_A').AsInteger:=0;
         gCDS_V_Geral.FieldByName('Curva_B').AsInteger:=0;
         gCDS_V_Geral.FieldByName('Curva_C').AsInteger:=0;
         gCDS_V_Geral.FieldByName('Curva_D').AsInteger:=0;
         gCDS_V_Geral.FieldByName('Curva_E').AsInteger:=0;
         If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='A' Then
          gCDS_V_Geral.FieldByName('Curva_A').AsInteger:=1
         Else If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='B' Then
          gCDS_V_Geral.FieldByName('Curva_B').AsInteger:=1
         Else If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='C' Then
          gCDS_V_Geral.FieldByName('Curva_C').AsInteger:=1
         Else If DMVirtual.CDS_V_CurvaABCEnderecoIND_CURVA.AsString='D' Then
          gCDS_V_Geral.FieldByName('Curva_D').AsInteger:=1
         Else
          gCDS_V_Geral.FieldByName('Curva_E').AsInteger:=1;

         gCDS_V_Geral.FieldByName('Vlr_Referencia').AsCurrency:=
                      DMVirtual.CDS_V_CurvaABCEnderecoVLR_REFERENCIA.AsCurrency;
         gCDS_V_Geral.FieldByName('Qtd_Estoque').AsCurrency:=
                         DMVirtual.CDS_V_CurvaABCEnderecoQTD_ESTOQUE.AsCurrency;
         gCDS_V_Geral.FieldByName('Tot_Custo').AsCurrency:=
                     DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_CUSTO.AsCurrency;
         gCDS_V_Geral.FieldByName('Tot_Venda').AsCurrency:=
                     DMVirtual.CDS_V_CurvaABCEnderecoVLR_TOTAL_VENDA.AsCurrency;
         gCDS_V_Geral.FieldByName('Tot_Margem').AsCurrency:=
                          DMVirtual.CDS_V_CurvaABCEnderecoVLR_MARGEM.AsCurrency;
       End; // If gCDS_V_Geral.Locate('Cod_Forn',DMVirtual.CDS_V_CurvaABCEnderecoCOD_FORNECEDOR.AsString,[]) Then
       gCDS_V_Geral.Post;
    End; // If Trim(DMVirtual.CDS_V_CurvaABCEnderecoCOD_PRODUTO.AsString)<>'' Then
    DMVirtual.CDS_V_CurvaABCEndereco.Post;

    DMVirtual.CDS_V_CurvaABCEndereco.Next;
  End; // While Not DMVirtual.CDS_V_CurvaABCEndereco.Eof do
  gCDS_V_Geral.EnableControls;
  DMVirtual.CDS_V_CurvaABCEndereco.EnableControls;
  DMVirtual.CDS_V_CurvaABCEndereco.First;
  MontaProgressBar(False, FrmBelShop);

  // Cria os Titulos ===========================================================
  iSeqOrdem:=0;
  DMVirtual.CDS_V_CurvaABCEndereco.IndexName := '';
  DMVirtual.CDS_V_CurvaABCEndereco.First;

  // Grava Cabecalho (Tipo de Curva) ===========================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  If Rb_CurvaABCEndTipoCalculoUnidades.Checked Then
   DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='CURVA ABC - Valor de Referncia: UNIDADES'
  Else
   DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='CURVA ABC - Valor de Referncia: VALORES';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  // Linha em Branco ===========================================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  // Grava Cabecalho (Empresas) ================================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  If Not bgTodasEmpresas Then
   DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Lojas Linx: '+sEmpLinx
  Else
   DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Lojas: Todas';

  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  // Linha em Branco ===========================================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  // Perodo ===================================================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Perodo de '+
                   DtEdt_CurvaABCEndInicio.Text+' a '+DtEdt_CurvaABCEndFim.Text;
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  // Linha em Branco ===========================================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  // Curva Calculadas ==========================================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Curva A: '+EdtCurvaABCEndLimiteCurvaA.Text+' %';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Curva B: '+EdtCurvaABCEndLimiteCurvaB.Text+' %';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Curva C: '+EdtCurvaABCEndLimiteCurvaC.Text+' %';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Curva D: '+EdtCurvaABCEndLimiteCurvaD.Text+' %';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='Curva E: '+EdtCurvaABCEndLimiteCurvaE.Text+' %';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  // Linha em Branco ===========================================================
  Inc(iSeqOrdem);
  DMVirtual.CDS_V_CurvaABCEndereco.Insert;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:='';
  DMVirtual.CDS_V_CurvaABCEnderecoORDENAR.AsInteger:=iSeqOrdem;
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  bIndexCriado:=False;
  for i:=0 to DMVirtual.CDS_V_CurvaABCEndereco.IndexDefs.Count-1 do
   if DMVirtual.CDS_V_CurvaABCEndereco.IndexDefs[i].Name='NovaORDEM' Then
    bIndexCriado:=True;

  If Not bIndexCriado Then
  With DMVirtual.CDS_V_CurvaABCEndereco.IndexDefs.AddIndexDef do
  Begin
    Name := 'NovaORDEM';
    Fields := 'ORDENAR';
    Options := [];
  End;
  DMVirtual.CDS_V_CurvaABCEndereco.IndexName := 'NovaORDEM';
  DMVirtual.CDS_V_CurvaABCEndereco.First;

  // Apresenta Totais por Curva ================================================
  DMVirtual.CDS_V_CurvaABCEndereco.Locate('DES_PRODUTO','Curva A: '+EdtCurvaABCEndLimiteCurvaA.Text+' %',[]);
  DMVirtual.CDS_V_CurvaABCEndereco.Edit;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:=
                           DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString+
                           ' - Qtd Produtos: '+IntToStr(iTotCurvaA)+
                           ' - Vlr Acumulado: '+CurrToStr(cTotCurvaA);
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  DMVirtual.CDS_V_CurvaABCEndereco.Locate('DES_PRODUTO','Curva B: '+EdtCurvaABCEndLimiteCurvaB.Text+' %',[]);
  DMVirtual.CDS_V_CurvaABCEndereco.Edit;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:=
                           DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString+
                           ' - Qtd Produtos: '+IntToStr(iTotCurvaB)+
                           ' - Vlr Acumulado: '+CurrToStr(cTotCurvaB);
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  DMVirtual.CDS_V_CurvaABCEndereco.Locate('DES_PRODUTO','Curva C: '+EdtCurvaABCEndLimiteCurvaC.Text+' %',[]);
  DMVirtual.CDS_V_CurvaABCEndereco.Edit;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:=
                           DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString+
                           ' - Qtd Produtos: '+IntToStr(iTotCurvaC)+
                           ' - Vlr Acumulado: '+CurrToStr(cTotCurvaC);
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  DMVirtual.CDS_V_CurvaABCEndereco.Locate('DES_PRODUTO','Curva D: '+EdtCurvaABCEndLimiteCurvaD.Text+' %',[]);
  DMVirtual.CDS_V_CurvaABCEndereco.Edit;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:=
                           DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString+
                           ' - Qtd Produtos: '+IntToStr(iTotCurvaD)+
                           ' - Vlr Acumulado: '+CurrToStr(cTotCurvaD);
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  DMVirtual.CDS_V_CurvaABCEndereco.Locate('DES_PRODUTO','Curva E: '+EdtCurvaABCEndLimiteCurvaE.Text+' %',[]);
  DMVirtual.CDS_V_CurvaABCEndereco.Edit;
  DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString:=
                           DMVirtual.CDS_V_CurvaABCEnderecoDES_PRODUTO.AsString+
                           ' - Qtd Produtos: '+IntToStr(iTotCurvaE)+
                           ' - Vlr Acumulado: '+CurrToStr(cTotCurvaE);
  DMVirtual.CDS_V_CurvaABCEndereco.Post;

  DMVirtual.CDS_V_CurvaABCEndereco.First;
  Result:=True;
  OdirPanApres.Visible:=False;

End; // Calcula Curva ABC e Endereamentos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Calcula Planiha Demonstrativo de Resultados >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CalculaPlanDemonstrativoResultados;
Var
  MySql: String;
  i, ii, iii: Integer;
  b: Boolean;
  sCampo, sCodDemonsResult: String;
  s, sCodComprov, sFormula, sVlrComprovante: String;
  iTipoPesquisa: Integer; // 1=Comprovante 2=Grupo Financeiro
  iTot_Compr: Integer;
Begin
             
  // Inicia Processamento ======================================================
  DMBelShop.CDS_Busca.First;
  While Not DMBelShop.CDS_Busca.Eof do
  Begin
    Refresh;

    sCodDemonsResult:=DMBelShop.CDS_Busca.FieldByName('Cod_Demonstrativo').AsString;

    // Busca Codigos de Comprovantes da Formula ---------------------
    b:=True;
    Memo2.Lines.Clear;
    Memo2.Width:=500;
    s:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('Des_Formula').AsString);
    While b do
    Begin
      i:=pos('CP',AnsiUpperCase(s));
      iii:=6;
      sCodComprov:=copy(s,i,iii);

      If StrToIntDef(copy(sCodComprov,Length(sCodComprov),1), 999999)=999999 Then
      Begin
        iii:=5;
        sCodComprov:=copy(s,i,iii);
      End;
      sCodComprov:=copy(s,i+2,iii-2);

      If i>0 Then
      Begin
        bOK:=True;
        For ii:=0 to Memo2.Lines.Count-1 do
        Begin
          If Memo2.Lines[ii]=sCodComprov Then
          Begin
            bOK:=False;
            Break;
          End;
        End;

        If bOK Then
        Begin
          Memo2.Lines.Add(sCodComprov);
          Inc(iTot_Compr);  // Total de Comprovantes
        End; // If bOK Then
        s:=(copy(s,i+iii, Length(s)));
      End; // If i>0 Then

      If i=0 Then
       Break;
    End; // While b do // Busca Codigos de Comprovantes da Formula
   
    // Busca Codigos de Grupos Financeiros --------------------------
    s:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('Des_Formula').AsString);
    MySql:='Select g.Des_Gr_Finan'+
           ' From FIN_GR_FINANCEIRO g'+
           ' Where g.Ind_Ativo=''SIM'''+
           ' Order By g.Des_Gr_Finan';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    While Not DMBelShop.CDS_BuscaRapida.Eof do
    Begin
      sCodComprov:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Gr_Finan').AsString;
      i:=pos('GR_'+sCodComprov,AnsiUpperCase(s));

      If i>0 Then
       Memo2.Lines.Add(sCodComprov);

      DMBelShop.CDS_BuscaRapida.Next;
    End; // While Not CDS_BuscaRapida.Eof do
    DMBelShop.CDS_BuscaRapida.Close;

    // Localiza Demonstrativo de Resultados ====================================
    DMVirtual.CDS_V_PlanDemonsResultados.Locate('Cod_Demonstrativo', sCodDemonsResult,[]);

    // Busca Campos a Atualizae por empresa
    For i:=2 to DMVirtual.CDS_V_PlanDemonsResultados.FieldCount-1 do
    Begin
      // Processa Somente Campos Visiveis ======================================
      If DMVirtual.CDS_V_PlanDemonsResultados.Fields[i].Visible Then
      Begin
        sCampo:=DMVirtual.CDS_V_PlanDemonsResultados.Fields[i].FieldName;
      
        // Monta Formula ===========================================================
        sFormula:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString);
        
        // Codigo Comprovantes e Grupos Financeiros
        For ii:=0 to Memo2.Lines.Count-1 do
        Begin
        Refresh;

          If Memo2.Lines[ii]<>'' Then
          Begin
            sCodComprov:=Memo2.Lines[ii];

            If StrToIntDef(sCodComprov,99999999)=99999999 Then
             iTipoPesquisa:=2
            Else
             iTipoPesquisa:=1;

            // Localiza o Comprovante ==========================================
            If iTipoPesquisa=1 Then
            Begin
              // Localiza Comprovante da Planilha Financeira ------------
              If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then
               Begin
                 sVlrComprovante:='0';

                 If Trim(DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsString)<>'' Then
                  sVlrComprovante:=DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsString;

                 // Acerta Valor Negativo -------------------------------
                 If StrToCurr(sVlrComprovante)<0 Then
                  sVlrComprovante:='('+sVlrComprovante+')';
              
                 sFormula:=StringReplace(sFormula, 'CP'+sCodComprov, sVlrComprovante, [rfReplaceAll]);
 
               End
              Else
               Begin
                 sFormula:=StringReplace(sFormula, 'CP'+sCodComprov, '0', [rfReplaceAll]);
               End;
            End; // If iTipoPesquisa=1 Then // Localiza o Comprovante 

            // Localiza o Grupo Financeiro =====================================
            If iTipoPesquisa=2 Then 
            Begin 
              // Localiza o Grupo Financeiro na Planilha Financeira -------
              If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',sCodComprov,[]) Then
               Begin
                 sVlrComprovante:='0';

                 If Trim(DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsString)<>'' Then
                  sVlrComprovante:=DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsString;

                 // Acerta Valor Negativo -------------------------------
                 If StrToCurr(sVlrComprovante)<0 Then 
                  sVlrComprovante:='('+sVlrComprovante+')';

                 sFormula:=StringReplace(sFormula, 'GR_'+sCodComprov, sVlrComprovante, [rfReplaceAll]);
 
               End
              Else
               Begin
                 sFormula:=StringReplace(sFormula, 'GR_'+sCodComprov, '0', [rfReplaceAll]);
               End;
            End; // If iTipoPesquisa=2 Then // Localiza o Grupo Financeiro
          End; // If Memo2.Lines[i]<>'' Then
        End; // For ii:=0 to Memo2.Lines.Count-1 do

        // Calcula Formula do Comprovante ======================================
        Try
          sVlrComprovante:=CalculaFormula(f_Troca(',','.',sFormula),
                     DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger);
        Except
          sVlrComprovante:='0';
        End;
        sVlrComprovante:=f_Troca('.',',',sVlrComprovante);

        // Grava Demonstrativo de Resultados ===================================
        DMVirtual.CDS_V_PlanDemonsResultados.Edit;
        DMVirtual.CDS_V_PlanDemonsResultados.FieldByName(sCampo).AsCurrency:=StrToCurr(sVlrComprovante);
        DMVirtual.CDS_V_PlanDemonsResultados.Post;

      End; // If DMVirtual.CDS_V_PlanDemonsResultados.Fields[i].Visible Then
    End; // For i:=2 to DMVirtual.CDS_V_PlanDemonsResultados.FieldCount-1 do
    
    DMBelShop.CDS_Busca.Next;
  End; // While Not DMBelShop.CDS_Busca.Eof do
  Memo2.Lines.Clear;
  Memo2.Width:=50;

End; // Calcula Planiha Demonstrativo de Resultados >>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Monta Planiha Demonstrativo de Resultados >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MontaPlanilhaDemonstrativoResultados;
Var
  i, iIndice: Integer;
  sCampo, MySql: String;
Begin

  Screen.Cursor:=crAppStart;

  // Apresenta o Processamento =================================================
  OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Apropria Comprovantes =====================================================
  MySql:='select dr.Cod_Demonstrativo, dr.Des_Demonstrativo, dr.Des_Formula, dr.Num_Decimais'+
         ' From FIN_DEMONS_RESULTADO dr'+
         ' Where dr.Cod_Visao='+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger)+
         ' order by dr.num_ordem';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;
                                      
  iIndice:=0;
  // Linhas Iniciais ===========================================================
  DMVirtual.CDS_V_PlanDemonsResultados.Append;
  DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:='';
  inc(iIndice);
  DMVirtual.CDS_V_PlanDemonsResultadosINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanDemonsResultados.Post;

  // Indica a Viso Utilizada ==================================================
  DMVirtual.CDS_V_PlanDemonsResultados.Append;
  DMVirtual.CDS_V_PlanDemonsResultadosCod_Demonstrativo.AsString:=
                         'Cod'+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger);
  DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:=
                                              EdtFinanDemonsResultDesVisao.Text;
  inc(iIndice);
  DMVirtual.CDS_V_PlanDemonsResultadosINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanDemonsResultados.Post;

  // Linha em Branco ===========================================================
  DMVirtual.CDS_V_PlanDemonsResultados.Append;
  DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:='';
  inc(iIndice);
  DMVirtual.CDS_V_PlanDemonsResultadosINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanDemonsResultados.Post;

  // Perodo ===================================================================
  DMVirtual.CDS_V_PlanDemonsResultados.Append;
  DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:='Perodo';
  inc(iIndice);
  DMVirtual.CDS_V_PlanDemonsResultadosINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanDemonsResultados.Post;

  DMVirtual.CDS_V_PlanDemonsResultados.Append;

  If bFinanPlanFinanceiraUsarMesAno Then
    DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:=
                                     Copy(sCbx_FinanPlanFinanceiraMes1,1,3)+'/'+sEdtFinanPlanFinanceiraAno1+' a '+
                                     Copy(sCbx_FinanPlanFinanceiraMes2,1,3)+'/'+sEdtFinanPlanFinanceiraAno2;

  If Not bFinanPlanFinanceiraUsarMesAno Then
    DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:=
                      DateToStr(dDtEdt_FinanPlanFinanceiraPeriodoDtaInicio)+
                      ' a '+
                      DateToStr(dDtEdt_FinanPlanFinanceiraPeriodoDtaFim);

  inc(iIndice);
  DMVirtual.CDS_V_PlanDemonsResultadosINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanDemonsResultados.Post;

  sgCodigo:='';
  DMBelShop.CDS_Busca.First;
  While Not DMBelShop.CDS_Busca.Eof do
  Begin
    Refresh;

    // Grava Demonstrativos de Resultado =======================================
    DMVirtual.CDS_V_PlanDemonsResultados.Append;
    DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:='';
    inc(iIndice);
    DMVirtual.CDS_V_PlanDemonsResultadosINDICE.AsInteger:=iIndice;
    DMVirtual.CDS_V_PlanDemonsResultados.Post;

    DMVirtual.CDS_V_PlanDemonsResultados.Append;
    DMVirtual.CDS_V_PlanDemonsResultadosCod_Demonstrativo.AsString:=
                   DMBelShop.CDS_Busca.FieldByName('Cod_Demonstrativo').AsString;
    DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString:=
                   DMBelShop.CDS_Busca.FieldByName('Des_Demonstrativo').AsString;

    // Empresas at 30 Sequencia Normal - 50, 98 e 99 Empresas Fora da Sequencia de Cdigo
    // (Odir Altera Nova Loja)
    // i:=1  o primeiro Nmero da Sequencia em CDS_V_PlanDemonsResultados.Vlr_Empresa??, ou seja, Vlr_Empresa01
    // 33  o Nmero  de Campos CDS_V_PlanDemonsResultados.Vlr_Empresa??
    For i:=1 to 33 do
    Begin
      If i=31 Then
       sCampo:='Vlr_Empresa50' // 50 Empresa Fora da Sequencia de Cdigo
      Else If i=32 Then
       sCampo:='Vlr_Empresa98' // 98 Empresa Fora da Sequencia de Cdigo
      Else If i=33 Then
       sCampo:='Vlr_Empresa99' // 99 Empresa Fora da Sequencia de Cdigo
      Else If i<10 Then
       sCampo:='Vlr_Empresa0'+IntToStr(i) // Empresas na Sequencia Normal de Cdigo
      Else
       sCampo:='Vlr_Empresa'+IntToStr(i); // Empresas na Sequencia Normal de Cdigo

      DMVirtual.CDS_V_PlanDemonsResultados.FieldByName(sCampo).AsCurrency:=0;
    End;
    DMVirtual.CDS_V_PlanDemonsResultadosVlr_Empresa_Total.AsCurrency:=0;
    inc(iIndice);
    DMVirtual.CDS_V_PlanDemonsResultadosINDICE.AsInteger:=iIndice;
    DMVirtual.CDS_V_PlanDemonsResultados.Post;

    DMBelShop.CDS_Busca.Next;
  End; // While Not DMBelShop.CDS_Busca.Eof do

  // Fixa Colunas ==============================================================
  THackDBGrid(Dbg_FinanDemonsResultPlanDemons).FixedCols:=3;
  
  // Calcula Demonstrtivos =====================================================            
  CalculaPlanDemonstrativoResultados;

  DMBelShop.CDS_Busca.Close;
  DMVirtual.CDS_V_PlanFinanceira.First;
  OdirPanApres.Visible:=False;

  // Posiciona do Grid =========================================================
  If Not DMVirtual.CDS_V_PlanDemonsResultados.Eof Then
  Begin
    DMVirtual.CDS_V_PlanDemonsResultados.First;
    
    // Posiciona no TabSheet ===================================================
    PC_FinanComprPlanFinanDemonsResultados.ActivePage:=Ts_FinanComprPlanFinanPlanDemonsResultados;
    Dbg_FinanDemonsResultPlanDemons.SelectedIndex:=2;
    Dbg_FinanDemonsResultPlanDemons.SetFocus;
  End; // If Not DMVirtual.CDS_V_PlanDemonsResultados.Eof do

  DMVirtual.CDS_V_PlanDemonsResultados.First;
  Screen.Cursor:=crDefault;
  OdirPanApres.Visible:=False;

  msg('Calculo da Planilha Demonstrativo de'+cr+'Resultados'+cr+cr+'Efetuado com SUCESSO !!','A');
                                                         
end; // Monta Planiha Demonstrativo de Resultados >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Verifica Visibilidade de Registro da Tabela >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.VerificaRegistroNaoVisivelTabela(iCodigo: Integer): Boolean;
Var
  i: Integer;
Begin
  Result:=True;
  for i:=Low(Array_Usuarios) to High(Array_Usuarios) do
  Begin
    If Array_Usuarios[i]=iCodigo Then
    Begin
      Result:=False;
    End;
  End; // for i:=Low(Array_Usuarios) to High(Array_Usuarios) do
End; // Verifica Visibilidade de Registro da Tabela >>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Acerta Permisso de Visualizao >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.PermissaoVisual(TabSh: TTabSheet);
Var
  MySql: String;
  SName: String;
  i: Integer;
Begin

  If bgInd_Admin Then
   Exit;

  // FrmBelShop ================================================================
  If TabSh.Name='Ts_FinanComprPlanFinan' Then
  Begin
    Bt_FinanComprovantesNovo.Visible:=False;
    Bt_FinanComprovantesDetalhar.Visible:=False;
    Bt_FinanGrFinanNovo.Visible:=False;
    Bt_FinanGrFinanAlterar.Visible:=False;
    Bt_FinanGrFinanExcluir.Visible:=False;
    Bt_FinanPlanDemonsResultados.Visible:=False;
    PopM_PlanFinanceiraSalvar.Visible:=False;
    Pan_FinanVisualGrFinanceiro.Visible:=False;
  End;

  // FrmSalao ==================================================================
  If FrmSalao<>nil Then
  Begin
    If TabSh.Name='Ts_ProfPagtos' Then
    Begin
      FrmSalao.Bt_PagtoGeraPlanilha.Visible:=False;
    End;

    If TabSh.Name='Ts_PagtoProfissionais' Then
    Begin
      FrmSalao.Bt_PagtoExcluirPlanilha.Visible:=False;
    End;

    // Profissionais e Cadastro de Comissoes (FrmSolicitacoes)
    If (TabSh.Name='Ts_Profissionais') And (FrmSolicitacoes<>nil) And ((SName='Comissao_Habilidade') Or (SName='Comissao_Servico')) Then
    Begin
      // Bloqueia Comisso Habilidade
      FrmSolicitacoes.EdtDesc9.Enabled:=False;
      FrmSolicitacoes.EdtDesc9.ReadOnly:=True;

      // Bloqueia Comisso Servio
      FrmSolicitacoes.EdtDesc10.Enabled:=False;
      FrmSolicitacoes.EdtDesc10.ReadOnly:=True;
    End
    Else If TabSh.Name='Ts_Profissionais' Then // Somente Profissionais
    Begin
      FrmSalao.Dbe_CadProfPerComissao.Enabled:=False;
      FrmSalao.Dbe_CadProfPerComissaoSupervisor.Enabled:=False;
      FrmSalao.Dbe_CadProfPerExtraAno.Enabled:=False;

      FrmSalao.Bt_LiberaConsistencias.Visible:=False;

      FrmSalao.Bt_CadProfServAlterarTodos.Enabled:=False;
      FrmSalao.EdtCadProfPerComissao.Enabled:=False;
    End;

    If TabSh.Name='Ts_ProfMovtosRH' Then
    Begin
      FrmSalao.OutLook_ProfMovtosRH.Pages[2].Buttons[0].Enabled:=False;
    End;

    If TabSh.Name='Ts_Habilidades' Then
    Begin
      FrmSalao.Splitter_Habilidades.Visible:=False;
      FrmSalao.Gb_Comissoes.Visible:=False;
    End;
  End; // If FrmSalao<>nil Then

  // FrmEstoques ===============================================================
  If FrmEstoques<>nil Then
  Begin
    If TabSh.Name='Ts_Estoques' Then
    Begin
      FrmEstoques.PopM_EstoquesReplicarEstMinLojas.Visible:=False;
    End;
  End; // If FrmEstoques<>nil Then

  MySql:='Select des_componente'+
         ' From PS_VISUAL_OBJETOS'+
         ' Where Des_Componente is not Null'+
         ' And cod_usuario='+Cod_Usuario+
         ' And DES_MODULO='+QuotedStr(TabSh.Name);
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  DMBelShop.CDS_BuscaRapida.DisableControls;
  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    Application.ProcessMessages;

    SName:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Componente').AsString;

    //==========================================================================
    // Formulario FrmBelShop ===================================================
    //==========================================================================
    for i:=0 to FrmBelShop.ComponentCount - 1 do
    Begin
      If FrmBelShop.components[i].Name=SName Then
      Begin
        If (FrmBelShop.Components[i] is TMenuItem) Then
        Begin
          (FrmBelShop.Components[i] as TMenuItem).Visible:=True;
          (FrmBelShop.Components[i] as TMenuItem).Enabled:=True;
        End
        Else If (FrmBelShop.Components[i] is TTabSheet) Then
        Begin
          (FrmBelShop.Components[i] as TTabSheet).TabVisible:=True;
          (FrmBelShop.Components[i] as TTabSheet).Enabled:=True;
        End
        Else If (FrmBelShop.Components[i] is TPageControl) Then
        Begin
          (FrmBelShop.Components[i] as TPageControl).Visible:=True;
          (FrmBelShop.Components[i] as TPageControl).Enabled:=True;
        End
        Else
         Begin
           TControl(FrmBelShop.Components[i]).Visible := True;
           TControl(FrmBelShop.Components[i]).Enabled := True;
         End;

        Break;
      End; // If FrmBelShop.components[i].Name=SName Then
    End; // for i:=0 to FrmBelShop.ComponentCount - 1 do

    //==========================================================================
    // Formulario FrmSalao =====================================================
    //==========================================================================
    If FrmSalao<>nil Then
    Begin
      for i:=0 to FrmSalao.ComponentCount - 1 do
      Begin
        If FrmSalao.components[i].Name=SName Then
        Begin
          If (FrmSalao.Components[i] is TMenuItem) Then
          Begin
            (FrmSalao.Components[i] as TMenuItem).Visible:=True;
            (FrmSalao.Components[i] as TMenuItem).Enabled:=True;
          End
          Else If (FrmSalao.Components[i] is TTabSheet) Then
          Begin
            (FrmSalao.Components[i] as TTabSheet).TabVisible:=True;
            (FrmSalao.Components[i] as TTabSheet).Enabled:=True;
          End
          Else If (FrmSalao.Components[i] is TPageControl) Then
          Begin
            (FrmSalao.Components[i] as TPageControl).Visible:=True;
            (FrmSalao.Components[i] as TPageControl).Enabled:=True;
          End
          Else
           Begin
             TControl(FrmSalao.Components[i]).Visible := True;
             TControl(FrmSalao.Components[i]).Enabled := True;
           End;

          Break;
        End; // If FrmSalao.components[i].Name=SName Then
      End; // for i:=0 to FrmSalao.ComponentCount - 1 do

      If SName='OutLook_ProfMovtosRH.Pages[2].Buttons[0]' Then
       FrmSalao.OutLook_ProfMovtosRH.Pages[2].Buttons[0].Enabled:=True;

      // FrmSolicitacoes - Habilidades / Servios - Comisses
      If FrmSolicitacoes<>nil Then
      Begin
        If SName='Comissao_Habilidade' Then
        Begin
          // Desbloqueia Comisso Habilidade
          FrmSolicitacoes.EdtDesc9.Enabled:=True;
          FrmSolicitacoes.EdtDesc9.ReadOnly:=False;
        End;

        If SName='Comissao_Servico' Then
        Begin
          // Desbloqueia Comisso Servio
          FrmSolicitacoes.EdtDesc10.Enabled:=True;
          FrmSolicitacoes.EdtDesc10.ReadOnly:=False;
        End
      End; // If FrmSolicitacoes<>nil Then
    End; // If FrmSalao<>nill Then

    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.CDS_BuscaRapida.EnableControls;

End; // Acerta Permisso de Visualizao >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Busca Demonstrativos de Resultado da Viso >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.DemonstrativosResultado(sCodVisao: String);
Var
  MySql: String;
Begin
  MySql:=' Select *'+
         ' From FIN_DEMONS_RESULTADO'+
         ' Where COD_VISAO='+sCodVisao+
         ' Order by Num_Ordem';
  DMBelShop.CDS_DemonsResultado.Close;
  DMBelShop.SDS_DemonsResultado.CommandText:=MySql;
  DMBelShop.CDS_DemonsResultado.Open;
End; // Busca Demonstrativos de Resultado da Viso >>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Cadastra Viso do Demonstrativo de Resultados >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.DemonsResultadosCadastraVisao;
Var
  s, MySql: String;
  bSiga, b: Boolean;
  sCodVisao: String;
Begin
  EdtFinanDemonsResultCodVisao.Value:=0;
  EdtFinanDemonsResultDesVisao.Clear;

  // Solicitao Nome da Viso ===================================================
  b:=True;
  s:='';
  While b do
  Begin
    If InputQuery('Descrio da Viso','',s) then
     Begin
       if Trim(s)='' then
       Begin
         msg('Favor Informar a Descrio !!','A');
       End
      Else // if Trim(s)='' then
       Begin
         // Verifica se Descriao J Existe ====================================
         s:=Trim(s);
         MySql:='Select t.Cod_Aux, t.Des_Aux'+
                ' From TAB_AUXILIAR t'+
                ' where t.tip_aux=1'+
                ' And t.Des_Aux='+QuotedStr(AnsiUpperCase(s));
         DMBelShop.CDS_BuscaRapida.Close;
         DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
         DMBelShop.CDS_BuscaRapida.Open;

         bSiga:=True;
         If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsString)<>'' Then
         Begin
           msg('Descrio J Existente'+cr+cr+'na Viso de Cdigo '+DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString+' !!','A');
           bSiga:=False;
         End;
         DMBelShop.CDS_BuscaRapida.Close;

         If bSiga Then
         Begin
           // Cadastra Viso =====================================================
           TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
           TD.IsolationLevel:=xilREADCOMMITTED;
           DMBelShop.SQLC.StartTransaction(TD);
           Try
             Screen.Cursor:=crAppStart;
             DateSeparator:='.';
             DecimalSeparator:='.';

             // Busca Cdigo da Viso ============================================
             MySql:='Select Coalesce(max(t.cod_aux)+1 ,1) Cod_Visao'+
                    ' From TAB_AUXILIAR t'+
                    ' where t.tip_aux=1';
             DMBelShop.CDS_BuscaRapida.Close;
             DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
             DMBelShop.CDS_BuscaRapida.Open;
             sCodVisao:=DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Visao').AsString;
             DMBelShop.CDS_BuscaRapida.Close;

             MySql:=' Insert Into TAB_AUXILIAR (TIP_AUX, COD_AUX, DES_AUX)'+
                    ' Values (1, '+QuotedStr(sCodVisao)+', '+QuotedStr(AnsiUpperCase(s))+')';
             DMBelShop.SQLC.Execute(MySql, nil, nil);

             // Fecha Transacao ===========================================================
             DMBelShop.SQLC.Commit(TD);

             DateSeparator:='/';
             DecimalSeparator:=',';
             Screen.Cursor:=crDefault;

             EdtFinanDemonsResultCodVisao.Value:=StrToInt(sCodVisao);
             EdtFinanDemonsResultDesVisao.Text:=AnsiUpperCase(s);
           Except
             on e : Exception do
             Begin
               DMBelShop.SQLC.Rollback(TD);

               DateSeparator:='/';
               DecimalSeparator:=',';
               Screen.Cursor:=crDefault;

               MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
             End; // on e : Exception do
           End; // Try

           Break;
         End; // If bSiga Then
       End // if Trim(s)='' then
     End
    Else // If InputQuery('Descrio da Viso','',s) then
     Begin
       Break;
     End; // If InputQuery('Descrio da Viso','',s) then
  End; // While b do

End; // Cadastra Viso do Demonstrativo de Resultados >>>>>>>>>>>>>>>>>>>>>>>>>>

// Rolagem no Grid com Mouse >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
procedure TFrmBelShop.AppEventsMessage(var Msg: TMsg; var Handled: Boolean);
var
  Sentido: SmallInt;
begin
 // primeiramente verificamos se  o evento a ser tratado...
 if Msg.message = WM_MOUSEWHEEL then
 Begin
   if ActiveControl is TDBGrid then   // <=== AQUI voc testa se classe  TDBGRID
   begin
     Msg.message := WM_KEYDOWN;
     Msg.lParam := 0;
     Sentido := HiWord(Msg.wParam);
     if Sentido > 0 then
      Msg.wParam := VK_UP
     else
      Msg.wParam := VK_DOWN;
   end; // if ActiveControl is TDBGrid then
 End; // if Msg.message = WM_MOUSEWHEEL then
end; // // Rolagem no Grid com Mouse >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Planilha FInanceira - Retira Comprovantes que no devem aparecer >>>>>>>>>>>>
Procedure TFrmBelShop.PlanilhaFinanceiraRetiraComprovantes;
Var
  MySql: String;
Begin
  MySql:='select c.cod_comprov'+
         ' from FIN_COMPROVANTES c'+
         ' where c.ind_planilha='+QuotedStr('NAO')+
         ' Order by c.cod_comprov';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  While Not DMBelShop.CDS_Busca.Eof do
  Begin
    Refresh;

    If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',DMBelShop.CDS_Busca.FieldByName('COD_COMPROV').AsString,[]) Then
     DMVirtual.CDS_V_PlanFinanceira.Delete;

    DMBelShop.CDS_Busca.Next;
  End; // While Not DMBelShop.CDS_Busca.Eof do
  DMBelShop.CDS_Busca.Close;
End; // Planilha FInanceira - Retira Comprovantes que no devem aparecer >>>>>>>

// Planilha FInanceira - Mostra Movtos do Comprovante da Empresa Selecionada >>>
Procedure TFrmBelShop.PlanilhaFinanceiraMovtos(sEmp, sComprov: String);
Var
  MySql: String;
  bSiga: Boolean;
  i: Integer;
Begin

  Screen.Cursor:=crAppStart;

  // Apresentacao ==============================================================
  OdirPanApres.Caption:='AGUARDE !! Localizando Comprovantes...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Monta Sql =================================================================
  MySql:=' Select m.datacomprovante, m.datadocumento, m.comp_anomes,'+
         ' m.codcliente Cod_Cli_For, c.nomecliente Nome_Cli_For,'+
         ' Cast(m.totnota as Numeric(12,2)) Vlr_Comprovante'+

         ' From MCLI m, CLIENTE c'+
         ' Where m.codcliente=c.codcliente'+
         ' and m.codfilial='+QuotedStr(sEmp)+
         sgMesAnoPlanFinanceira+
         ' And m.chavenf<>'''''+
         ' And m.codcomprovante='+QuotedStr(sComprov)+

         ' And not exists'+
         ' (Select 1'+
         '  From mclipago mm'+
         '  Where mm.chavenf=m.chavenf'+
         '  and mm.codfilial=m.codfilial'+
         '  And mm.chavenf<>'''')'+

         ' UNION'+ // Unio ===============================

         ' Select m1.datacomprovante, m1.dataentrada datadocumento,'+
         ' m1.comp_anomes, m1.codfornecedor Cod_Cli_For,'+
         ' f.nomefornecedor Nome_Cli_For,'+
         ' Cast(m1.totnota as Numeric(12,2)) '+

         ' from MFOR m1, FORNECED f'+
         '  where m1.codfornecedor=f.codfornecedor'+
         '  and m1.codfilial='+QuotedStr(sEmp)+
         f_Troca('m.','m1.',f_troca('datadocumento','dataentrada',sgMesAnoPlanFinanceira))+
         ' And m1.chavenf<>'''''+
         ' And m1.codcomprovante='+QuotedStr(sComprov)+

         ' And Not Exists'+
         ' (Select 1'+
         '  From mforpago mm1'+
         '  Where mm1.chavenf=m1.chavenf'+
         '  And mm1.codfilial=m1.codfilial'+
         '  And mm1.chavenf<>'''')'+

         ' UNION'+ // Unio ===============================

         ' Select p.datacomprovante, p.datapagamento datadocumento,'+
         ' Cast(lpad(extract(month from p.datapagamento ),2,''0'') as varchar(2))||''/''||'+
         ' Cast(lpad(extract(Year  from p.datapagamento ),4,''0'') as varchar(4)) MesAno,'+
         ' p.codcliente Cod_Cli_For, c.nomecliente Nome_Cli_For,'+
         ' Cast(p.totnota as Numeric(12,2)) Vlr_Comprovante'+

         ' From mclipago p, CLIENTE c'+
         ' Where p.codcliente=c.codcliente'+
         ' And p.codfilial='+QuotedStr(sgCodEmp)+
         f_Troca('m.','p.',f_troca('datadocumento','datapagamento',sgMesAnoPlanFinanceira))+
         ' And p.chavenf<>'''''+
         ' And p.codcomprovante='+QuotedStr(sComprov)+

         ' UNION'+ // Unio ===============================

         ' Select p1.datacomprovante, p1.datapagamento datadocumento,'+
         ' Cast(lpad(extract(month from p1.datapagamento ),2,''0'') as varchar(2))||''/''||'+
         ' Cast(lpad(extract(Year  from p1.datapagamento ),4,''0'') as varchar(4)) MesAno,'+
         ' p1.codfornecedor Cod_Cli_For, f.nomefornecedor Nome_Cli_For,'+
         ' Cast(p1.totnota as Numeric(12,2)) Vlr_Comprovante'+

         ' From mforpago p1, FORNECED f'+
         ' Where p1.codfornecedor=f.codfornecedor'+
         ' And p1.codfilial='+QuotedStr(sgCodEmp)+
         f_Troca('m.','p1.',f_troca('datadocumento','datapagamento',sgMesAnoPlanFinanceira))+
         ' And p1.chavenf<>'''''+
         ' And p1.codcomprovante='+QuotedStr(sComprov)+

         ' order by 1';

  // Conecta Empresa =======================================================
  If ConexaoEmpIndividual('IBDB_'+sEmp, 'IBT_'+sEmp, 'A') Then
   Begin
     bSiga:=True;
   End
  Else // ConexaoEmpIndividual('IBDB_'+sEmp, 'IBT_'+sEmp, 'A') Then
   Begin
     OdirPanApres.Visible:=False;
     Refresh;
     msg('Empresa: Bel_'+sEmp+' NO CONECTADA !!'+cr+cr+'Tente Novamente !!','A');
     bSiga:=False;
   End; // ConexaoEmpIndividual('IBDB_'+sEmp, 'IBT_'+sEmp, 'A') Then

  If bSiga Then // Empresa Conectada
  Begin
    // Cria Query da Empresa ------------------------------------
    CriaQueryIB('IBDB_'+sEmp, 'IBT_'+sEmp, IBQ_ConsultaFilial, True, True);

    // Busca Comprovantes ---------------------------------------
    IBQ_ConsultaFilial.SQL.Clear;
    IBQ_ConsultaFilial.SQL.Add(MySql);

    // Abre Query -----------------------------------------------
    i:=0;
    bSiga:=False;
    While Not bSiga do // Executa Query
    Begin
      Try
        IBQ_ConsultaFilial.Open;
        bSiga:=True;
      Except
        Inc(i);
      End; // Try

      If i>10 Then
      Begin
        OdirPanApres.Visible:=False;
        msg('Conexo Perdida !!'+cr+'Empresa: Bel_'+sEmp+cr+cr+'Tente Novamente !!','A');
        Break;
      End; // If i>10 Then
    End; // While Not bSiga do // Executa Query

    If (bSiga) Then // Apresenta Comprovantes
    Begin
      If IBQ_ConsultaFilial.IsEmpty Then
      Begin
        IBQ_ConsultaFilial.Close;
        ConexaoEmpIndividual('IBDB_'+sEmp, 'IBT_'+sEmp, 'F');
        Screen.Cursor:=crDefault;
        OdirPanApres.Visible:=False;
        msg('Comprovante SEM Movimento !!'+cr+cr+'ATENO para Comprovantes'+cr+'Calculados pelo Sistema !!','A');
        Dbg_FinanPlanFinanceira.SetFocus;
        Exit;
      End;

      // Cria ClientDataSet ====================================================
      try
        DMVirtual.CDS_V_ApresComprovantes.CreateDataSet;
        DMVirtual.CDS_V_ApresComprovantes.IndexFieldNames:='';
        DMVirtual.CDS_V_ApresComprovantes.Open;
      Except
        DMVirtual.CDS_V_ApresComprovantes.EmptyDataSet;
        DMVirtual.CDS_V_ApresComprovantes.IndexFieldNames:='';
        DMVirtual.CDS_V_ApresComprovantes.Open;
      End;

      While Not IBQ_ConsultaFilial.Eof do
      Begin
        Refresh;

        DMVirtual.CDS_V_ApresComprovantes.Append;
        DMVirtual.CDS_V_ApresComprovantesCOD_CLI_FOR.AsString:=
                         IBQ_ConsultaFilial.FieldByName('COD_CLI_FOR').AsString;
        DMVirtual.CDS_V_ApresComprovantesCOMP_ANOMES.AsString:=
                         IBQ_ConsultaFilial.FieldByName('COMP_ANOMES').AsString;
        DMVirtual.CDS_V_ApresComprovantesDATACOMPROVANTE.AsString:=
                     IBQ_ConsultaFilial.FieldByName('DATACOMPROVANTE').AsString;
        DMVirtual.CDS_V_ApresComprovantesDATADOCUMENTO.AsString:=
                       IBQ_ConsultaFilial.FieldByName('DATADOCUMENTO').AsString;
        DMVirtual.CDS_V_ApresComprovantesNOME_CLI_FOR.AsString:=
                        IBQ_ConsultaFilial.FieldByName('NOME_CLI_FOR').AsString;
        DMVirtual.CDS_V_ApresComprovantesVLR_COMPROVANTE.AsCurrency:=
                   IBQ_ConsultaFilial.FieldByName('VLR_COMPROVANTE').AsCurrency;
        DMVirtual.CDS_V_ApresComprovantes.Post;

        IBQ_ConsultaFilial.Next;
      End;
      DMVirtual.CDS_V_ApresComprovantes.First;
      IBQ_ConsultaFilial.Close;
      ConexaoEmpIndividual('IBDB_'+sEmp, 'IBT_'+sEmp, 'F');

      // Apresenta Comprovantes
      OdirPanApres.Visible:=False;

      FrmPlanFinanApresComrprovantes:=TFrmPlanFinanApresComrprovantes.Create(Self);
      FrmPlanFinanApresComrprovantes.EdtPlanFinanApresComprovEmpresa.Text:='Bel_'+sEmp;
      FrmPlanFinanApresComrprovantes.EdtPlanFinanApresComprovComprovante.Text:=
                   DMVirtual.CDS_V_PlanFinanceiraCod_Comprovante.AsString+' - '+
                   DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString;

      FrmPlanFinanApresComrprovantes.ShowModal;
      FreeAndNil(FrmPlanFinanApresComrprovantes);

      Dbg_FinanPlanFinanceira.SetFocus;
    End; // If bSiga Then // Apresenta Comprovantes
  End; // If bSiga Then // Empresa Conectada
  OdirPanApres.Visible:=False;
  Screen.Cursor:=crDefault;

End; // Planilha FInanceira - Mostra Movtos do Comprovante da Empresa Selecionada

// Planilha FInanceira - Calcula Comprovantes com Somar em e/ou Subtrair em >>>>
Procedure TFrmBelShop.PlanilhaFinanceiraSomaSubtrai(sCampo: String);
Var
  MySql: String;
  i: Integer;
  s, sCodComprov, sValor: String;
  sVlr01, sVlr02, sVlr03, sVlr04, sVlr05, sVlr06,sVlr07, sVlr08, sVlr09, sVlr10, sVlr11, sVlr12: String; // Valores por Mes
Begin

  MySql:='select c.cod_comprov, c.somar_em, c.subtrair_de'+

         ' from FIN_COMPROVANTES c'+

         ' where c.ind_ativo='+QuotedStr('SIM')+
         ' and ((Trim(c.somar_em)<>'''' and c.somar_em is not null)'+
         ' or'+
         ' (Trim(c.subtrair_de)<>'''' and c.subtrair_de is not null))'+
         ' Order by c.cod_comprov';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  // Calcula Soma e/ou Subtrai =================================================
  While Not DMBelShop.CDS_Busca.Eof do
  Begin
    Refresh;

    // Aguarda Valor a Somar nos Coprovantes ===================================
    sVlr01:=''; sVlr02:=''; sVlr03:=''; sVlr04:=''; sVlr05:=''; sVlr06:='';
    sVlr07:=''; sVlr08:=''; sVlr09:=''; sVlr10:=''; sVlr11:=''; sVlr12:='';
    sValor:='0';
    If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',DMBelShop.CDS_Busca.FieldByName('Cod_Comprov').AsString,[]) Then
    Begin
      sValor:=DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsString;

      // Aguarda Formulas por Mes ==============================================
      For i:=0 to Memo3.Lines.Count-1 do
      Begin                       
        If sVlr01='' Then sVlr01:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes01').AsString
        Else If sVlr02='' Then sVlr02:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes02').AsString
        Else If sVlr03='' Then sVlr03:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes03').AsString
        Else If sVlr04='' Then sVlr04:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes04').AsString
        Else If sVlr05='' Then sVlr05:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes05').AsString
        Else If sVlr06='' Then sVlr06:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes06').AsString
        Else If sVlr07='' Then sVlr07:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes07').AsString
        Else If sVlr08='' Then sVlr08:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes08').AsString
        Else If sVlr09='' Then sVlr09:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes09').AsString
        Else If sVlr10='' Then sVlr10:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes10').AsString
        Else If sVlr11='' Then sVlr11:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes11').AsString
        Else sVlr12:=DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes12').AsString;
      End; // For i:=0 to Memo3.Lines.Count-1 do
    End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',DMBelShop.CDS_Busca.FieldByName('Cod_Comprov').AsString,[]) Then

    If sValor<>'0' Then
    Begin
      // Somar em ==============================================================
      s:='';
      If Trim(DMBelShop.CDS_Busca.FieldByName('Somar_Em').AsString)<>'' Then
       s:=DMBelShop.CDS_Busca.FieldByName('Somar_Em').AsString;

      If s<>'' Then
      Begin
        For i:=1 to 1000 do
        Begin
          sCodComprov:=Separa_String(s, i, ',');

          If sCodComprov='' Then
           Break;

          MySql:='Select g.des_gr_finan, c.ind_soma_grupo'+
                 ' From FIN_COMPROVANTES c, FIN_GR_FINANCEIRO g'+
                 ' Where  c.cod_gr_finan=g.cod_gr_finan'+
                 ' and Cod_Comprov='+QuotedStr(sCodComprov);
          DMBelShop.CDS_BuscaRapida.Close;
          DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
          DMBelShop.CDS_BuscaRapida.Open;

          If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then
          Begin
            DMVirtual.CDS_V_PlanFinanceira.Edit;
            DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=
                      DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency+
                      StrToCurr(sValor);
            DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                      DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency+
                      StrToCurr(sValor);
                      
            // Atualiza Campos Mes Individual -----------------------------
            If sVlr01<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes01').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes01').AsCurrency+
                                                                                 StrToCurr(sVlr01);
            If sVlr02<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes02').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes02').AsCurrency+
                                                                                 StrToCurr(sVlr02);
            If sVlr03<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes03').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes03').AsCurrency+
                                                                                 StrToCurr(sVlr03);
            If sVlr04<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes04').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes04').AsCurrency+
                                                                                 StrToCurr(sVlr04);
            If sVlr05<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes05').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes05').AsCurrency+
                                                                                 StrToCurr(sVlr05);
            If sVlr06<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes06').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes06').AsCurrency+
                                                                                 StrToCurr(sVlr06);
            If sVlr07<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes07').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes07').AsCurrency+
                                                                                 StrToCurr(sVlr07);
            If sVlr08<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes08').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes08').AsCurrency+
                                                                                 StrToCurr(sVlr08);
            If sVlr09<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes09').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes09').AsCurrency+
                                                                                 StrToCurr(sVlr09);
            If sVlr10<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes10').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes10').AsCurrency+
                                                                                 StrToCurr(sVlr10);
            If sVlr11<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes11').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes11').AsCurrency+
                                                                                 StrToCurr(sVlr11);
            If sVlr12<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes12').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes12').AsCurrency+
                                                                                 StrToCurr(sVlr12);
            DMVirtual.CDS_V_PlanFinanceira.Post;

            If DMBelShop.CDS_BuscaRapida.FieldByName('ind_soma_grupo').AsString='SIM' Then
            Begin
              If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_BuscaRapida.FieldByName('des_gr_finan').AsString,[]) Then
              Begin
                DMVirtual.CDS_V_PlanFinanceira.Edit;
                DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=
                          DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency+
                          StrToCurr(sValor);
                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                          DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency+
                          StrToCurr(sValor);
                DMVirtual.CDS_V_PlanFinanceira.Post;
              End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_Busca.FieldByName('des_gr_finan').AsString,[]) Then
            End; // If DMBelShop.CDS_Busca.FieldByName('ind_soma_grupo').AsString='SIM' Then
          End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then
          DMBelShop.CDS_BuscaRapida.Close;
        End; // For i:=1 to 1000 do
      End; // If s<>'' Then

      // Subtraie de ===========================================================
      s:='';
      If Trim(DMBelShop.CDS_Busca.FieldByName('Subtrair_De').AsString)<>'' Then
       s:=DMBelShop.CDS_Busca.FieldByName('Subtrair_De').AsString;

      If s<>'' Then
      Begin
        For i:=1 to 1000 do
        Begin
          sCodComprov:=Separa_String(s, i, ',');

          If sCodComprov='' Then
           Break;

          MySql:='Select g.des_gr_finan, c.ind_soma_grupo'+
                 ' From FIN_COMPROVANTES c, FIN_GR_FINANCEIRO g'+
                 ' Where  c.cod_gr_finan=g.cod_gr_finan'+
                 ' and Cod_Comprov='+QuotedStr(sCodComprov);
          DMBelShop.CDS_BuscaRapida.Close;
          DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
          DMBelShop.CDS_BuscaRapida.Open;

          If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then
          Begin
            DMVirtual.CDS_V_PlanFinanceira.Edit;
            DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=
                      DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency-
                      StrToCurr(sValor);
            DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                      DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency-
                      StrToCurr(sValor);

            // Atualiza Campos Mes Individual -----------------------------
            If sVlr01<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes01').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes01').AsCurrency-
                                                                                 StrToCurr(sVlr01);
            If sVlr02<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes02').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes02').AsCurrency-
                                                                                 StrToCurr(sVlr02);
            If sVlr03<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes03').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes03').AsCurrency-
                                                                                 StrToCurr(sVlr03);
            If sVlr04<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes04').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes04').AsCurrency-
                                                                                 StrToCurr(sVlr04);
            If sVlr05<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes05').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes05').AsCurrency-
                                                                                 StrToCurr(sVlr05);
            If sVlr06<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes06').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes06').AsCurrency-
                                                                                 StrToCurr(sVlr06);
            If sVlr07<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes07').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes07').AsCurrency-
                                                                                 StrToCurr(sVlr07);
            If sVlr08<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes08').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes08').AsCurrency-
                                                                                 StrToCurr(sVlr08);
            If sVlr09<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes09').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes09').AsCurrency-
                                                                                 StrToCurr(sVlr09);
            If sVlr10<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes10').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes10').AsCurrency-
                                                                                 StrToCurr(sVlr10);
            If sVlr11<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes11').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes11').AsCurrency-
                                                                                 StrToCurr(sVlr11);
            If sVlr12<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes12').AsCurrency:=
                                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes12').AsCurrency-
                                                                                 StrToCurr(sVlr12);
            DMVirtual.CDS_V_PlanFinanceira.Post;

            If DMBelShop.CDS_BuscaRapida.FieldByName('ind_soma_grupo').AsString='SIM' Then
            Begin
              If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_BuscaRapida.FieldByName('des_gr_finan').AsString,[]) Then
              Begin
                DMVirtual.CDS_V_PlanFinanceira.Edit;
                DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=
                          DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency-
                          StrToCurr(sValor);
                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                          DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency-
                          StrToCurr(sValor);
                DMVirtual.CDS_V_PlanFinanceira.Post;
              End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_Busca.FieldByName('des_gr_finan').AsString,[]) Then
            End; // If DMBelShop.CDS_Busca.FieldByName('ind_soma_grupo').AsString='SIM' Then
          End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then
          DMBelShop.CDS_BuscaRapida.Close;
        End; // For i:=1 to 1000 do
      End; // If s<>'' Then
    End; // If sValor<>'0' Then

    DMBelShop.CDS_Busca.Next;
  End; // While Not DMBelShop.CDS_Busca.Eof do
  DMBelShop.CDS_Busca.Close;

  Memo3.Lines.Clear;
  Memo3.Width:=50;
  
End; // Planilha FInanceira - Calcula Comprovantes com Somar em e/ou Subtrair em >>>>

// Planilha FInanceira - Calcula Comprovantes com Formula >>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.PlanilhaFinanceiraCalculaFormula(sCampo: String);
Var
  MySql: String;
  i, ii, iii: Integer;
  b: Boolean;
  s, sCodComprov, sFormula, sFormulaTotal, sVlrComprovante, sVlrTotal: String;
  sF01, sF02, sF03, sF04, sF05, sF06, sF07, sF08, sF09, sF10, sF11, sF12: String; // Formulas por Mes
  iTot_Compr: Integer;
Begin

  MySql:='select g.des_gr_finan, c.cod_comprov,'+
         ' c.ind_soma_grupo, c.des_formula, c.num_decimais'+

         ' from FIN_COMPROVANTES c, FIN_GR_FINANCEIRO g'+

         ' where c.cod_gr_finan=g.cod_gr_finan'+
         ' and g.ind_ativo='+QuotedStr('SIM')+
         ' and Trim(c.des_formula)<>'''''+
         ' and c.des_formula is not null'+
         ' Order by g.des_gr_finan, c.cod_comprov';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;                            

  iTot_Compr:=0;
  sVlrTotal:='0';
  While Not DMBelShop.CDS_Busca.Eof do
  Begin
    Refresh;

    // Busca Codigos de Comprovantes da Formula ================================
    b:=True;
    Memo2.Lines.Clear;
    Memo2.Width:=500;
    s:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString);
    While b do
    Begin
      i:=pos('CP',AnsiUpperCase(s));
      iii:=6;
      sCodComprov:=copy(s,i,iii);

      If StrToIntDef(copy(sCodComprov,Length(sCodComprov),1), 999999)=999999 Then
      Begin
        iii:=5;
        sCodComprov:=copy(s,i,iii);
      End;
      sCodComprov:=copy(s,i+2,iii-2);

      If i>0 Then
      Begin
        bOK:=True;
        For ii:=0 to Memo2.Lines.Count-1 do
        Begin
          If Memo2.Lines[ii]=sCodComprov Then
          Begin
            bOK:=False;
            Break;
          End;
        End; // For ii:=0 to Memo2.Lines.Count-1 do

        If bOK Then
        Begin
          Memo2.Lines.Add(sCodComprov);
          Inc(iTot_Compr);  // Total de Comprovantes
        End; // If bOK Then
        s:=(copy(s,i+iii, Length(s)));
      End; // If i>0 Then

      If i=0 Then
       Break;
    End; // While b do

    // Aguarda Formulas por Mes ================================================
    sF01:=''; sF02:=''; sF03:=''; sF04:=''; sF05:=''; sF06:='';
    sF07:=''; sF08:=''; sF09:=''; sF10:=''; sF11:=''; sF12:='';
    For i:=0 to Memo3.Lines.Count-1 do
    Begin
      If sF01='' Then sF01:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF02='' Then sF02:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF03='' Then sF03:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF04='' Then sF04:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF05='' Then sF05:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF06='' Then sF06:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF07='' Then sF07:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF08='' Then sF08:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF09='' Then sF09:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF10='' Then sF10:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else If sF11='' Then sF11:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
      Else sF12:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString)
    End; // For i:=0 to Memo3.Lines.Count-1 do
   
    // Monta Formula ===========================================================
    sFormula     :=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString);
    sFormulaTotal:=AnsiUpperCase(DMBelShop.CDS_Busca.FieldByName('DES_FORMULA').AsString);
    sVlrTotal:='0';
    For i:=0 to Memo2.Lines.Count-1 do
    Begin
      Refresh;

      If Memo2.Lines[i]<>'' Then
      Begin
        sCodComprov:=Memo2.Lines[i];

        If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then
         Begin
           sVlrComprovante:='0';
           If Trim(DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsString)<>'' Then
            sVlrComprovante:=DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsString;

           for ii:=Low(Array_Campos) to High(Array_Campos) do 
           Begin
             If Array_Campos[ii]='' Then
              Break;
                                   
             If Trim(DMVirtual.CDS_V_PlanFinanceira.FieldByName(Array_Campos[ii]).AsString)<>'' Then
             Begin
               sVlrTotal:=CurrToStr(StrToCurr(sVlrTotal)+DMVirtual.CDS_V_PlanFinanceira.FieldByName(Array_Campos[ii]).AsCurrency);
             End;
           End; // for i:=Low(Array_Usuarios) to High(Array_Usuarios) do

         End
        Else // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then
         Begin
           sVlrComprovante:='0';
         End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',sCodComprov,[]) Then

        // Acerta Valor Negativo ===============================================
        If StrToCurr(sVlrComprovante)<0 Then 
         sVlrComprovante:='('+sVlrComprovante+')';

        If StrToCurr(sVlrTotal)<0 Then 
         sVlrTotal:='('+sVlrTotal+')';

        // Substitui nas Formulas ==============================================
        sFormula:=StringReplace(sFormula, 'CP'+sCodComprov, sVlrComprovante, [rfReplaceAll]);
        sFormulaTotal:=StringReplace(sFormulaTotal, 'CP'+sCodComprov, sVlrTotal, [rfReplaceAll] );
        sVlrTotal:='0';

        // Substitui nas Formulas por Mes ======================================
        If sF01<>'' Then
         sF01:=StringReplace(sF01, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes01').AsString, [rfReplaceAll]);
        If sF02<>'' Then
         sF02:=StringReplace(sF02, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes02').AsString, [rfReplaceAll]);
        If sF03<>'' Then
         sF03:=StringReplace(sF03, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes03').AsString, [rfReplaceAll]);
        If sF04<>'' Then
         sF04:=StringReplace(sF04, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes04').AsString, [rfReplaceAll]);
        If sF05<>'' Then
         sF05:=StringReplace(sF05, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes05').AsString, [rfReplaceAll]);
        If sF06<>'' Then
         sF06:=StringReplace(sF06, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes06').AsString, [rfReplaceAll]);
        If sF07<>'' Then
         sF07:=StringReplace(sF07, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes07').AsString, [rfReplaceAll]);
        If sF08<>'' Then
         sF08:=StringReplace(sF08, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes08').AsString, [rfReplaceAll]);
        If sF09<>'' Then
         sF09:=StringReplace(sF09, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes09').AsString, [rfReplaceAll]);
        If sF10<>'' Then
         sF10:=StringReplace(sF10, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes10').AsString, [rfReplaceAll]);
        If sF11<>'' Then
         sF11:=StringReplace(sF11, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes11').AsString, [rfReplaceAll]);
        If sF12<>'' Then
         sF12:=StringReplace(sF12, 'CP'+sCodComprov, DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes12').AsString, [rfReplaceAll]);

      End; // If Mem.Lines[i]<>'' Then
    End; // For i:=0 to Memo2.Lines.Count-1 do
    Memo2.Lines.Clear;

    // Calcula Formula do Comprovante ==========================================
    Try
      sVlrComprovante:=CalculaFormula(f_Troca(',','.',sFormula), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger);
    Except
      sVlrComprovante:='0';
    End;
    sVlrComprovante:=f_Troca('.',',',sVlrComprovante);

    // Calcula Formula do Total do Comprovante =================================
    Try
      sVlrTotal:=CalculaFormula(f_Troca(',','.',sFormulaTotal), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
    Except
      sVlrTotal:='0';
    End;
    sVlrTotal:=f_Troca('.',',',sVlrTotal);

    // =========================================================================
    // Calcula Formula Por Mes =================================================
    // =========================================================================
    If sF01<>'' Then
    Begin
      Try sF01:=CalculaFormula(f_Troca(',','.',sF01), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF01:='0';
      End; sF01:=f_Troca('.',',',sF01);
    End;

    If sF02<>'' Then 
    Begin
      Try sF02:=CalculaFormula(f_Troca(',','.',sF02), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF02:='0';
      End; sF02:=f_Troca('.',',',sF02);
    End;

    If sF03<>'' Then 
    Begin
      Try sF03:=CalculaFormula(f_Troca(',','.',sF03), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF03:='0';
      End; sF03:=f_Troca('.',',',sF03);
    End;

    If sF04<>'' Then 
    Begin
      Try sF04:=CalculaFormula(f_Troca(',','.',sF04), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF04:='0';
      End; sF04:=f_Troca('.',',',sF04);
    End;

    If sF05<>'' Then 
    Begin
      Try sF05:=CalculaFormula(f_Troca(',','.',sF05), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF05:='0';
      End; sF05:=f_Troca('.',',',sF05);
    End;

    If sF06<>'' Then 
    Begin
      Try sF06:=CalculaFormula(f_Troca(',','.',sF06), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF06:='0';
      End; sF06:=f_Troca('.',',',sF06);
    End;

    If sF07<>'' Then
    Begin
      Try sF07:=CalculaFormula(f_Troca(',','.',sF07), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF07:='0';
      End; sF07:=f_Troca('.',',',sF07);
    End;

    If sF08<>'' Then 
    Begin
      Try sF08:=CalculaFormula(f_Troca(',','.',sF08), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF08:='0';
      End; sF08:=f_Troca('.',',',sF08);
    End;

    If sF09<>'' Then 
    Begin
      Try sF09:=CalculaFormula(f_Troca(',','.',sF09), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF09:='0';
      End; sF09:=f_Troca('.',',',sF09);
    End;

    If sF10<>'' Then 
    Begin
      Try sF10:=CalculaFormula(f_Troca(',','.',sF10), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF10:='0';
      End; sF10:=f_Troca('.',',',sF10);
    End;

    If sF11<>'' Then 
    Begin
      Try sF11:=CalculaFormula(f_Troca(',','.',sF11), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF11:='0';
      End; sF11:=f_Troca('.',',',sF11);
    End;

    If sF12<>'' Then 
    Begin
      Try sF12:=CalculaFormula(f_Troca(',','.',sF12), DMBelShop.CDS_Busca.FieldByName('Num_Decimais').AsInteger)
      Except sF12:='0';
      End; sF12:=f_Troca('.',',',sF12);
    End;
    // =========================================================================
    // =========================================================================

    // Grava Comprovante e Totais da Empresa ===================================
    If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',DMBelShop.CDS_Busca.FieldByName('Cod_Comprov').AsString,[]) Then
    Begin
      // Gravar Comprovante -----------------------------------------
      DMVirtual.CDS_V_PlanFinanceira.Edit;
      DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=StrToCurr(sVlrComprovante);
      DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=StrToCurr(sVlrTotal);

      // Atualiza Campos Mes Individual -----------------------------
      If sF01<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes01').AsCurrency:=StrToCurr(sF01);
      If sF02<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes02').AsCurrency:=StrToCurr(sF02);
      If sF03<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes03').AsCurrency:=StrToCurr(sF03);
      If sF04<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes04').AsCurrency:=StrToCurr(sF04);
      If sF05<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes05').AsCurrency:=StrToCurr(sF05);
      If sF06<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes06').AsCurrency:=StrToCurr(sF06);
      If sF07<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes07').AsCurrency:=StrToCurr(sF07);
      If sF08<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes08').AsCurrency:=StrToCurr(sF08);
      If sF09<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes09').AsCurrency:=StrToCurr(sF09);
      If sF10<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes10').AsCurrency:=StrToCurr(sF10);
      If sF11<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes11').AsCurrency:=StrToCurr(sF11);
      If sF12<>'' Then DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Mes12').AsCurrency:=StrToCurr(sF12);

      DMVirtual.CDS_V_PlanFinanceira.Post;

      If DMBelShop.CDS_Busca.FieldByName('ind_soma_grupo').AsString='SIM' Then
      Begin
        If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_Busca.FieldByName('des_gr_finan').AsString,[]) Then
        Begin
          DMVirtual.CDS_V_PlanFinanceira.Edit;
          DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=
                    DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency+
                    StrToCurr(sVlrComprovante);
          DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                    DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency+
                    StrToCurr(sVlrTotal);
          DMVirtual.CDS_V_PlanFinanceira.Post;
        End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_Busca.FieldByName('des_gr_finan').AsString,[]) Then
      End; // If DMBelShop.CDS_Busca.FieldByName('ind_soma_grupo').AsString='SIM' Then

    End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',DMBelShop.CDS_Busca.FieldByName('Cod_Comprov').AsString,[]) Then

    DMBelShop.CDS_Busca.Next;
  End; // While Not DMBelShop.CDS_Busca.Eof do
  DMBelShop.CDS_Busca.Close;

  Memo2.Lines.Clear;
  Memo2.Width:=50;
End; // Planilha FInanceira - Calcula Comprovantes com Formula >>>>>>>>>>>>>>>>>

// Planilha FInanceira - Monta Mes/Ano para Pesquisa >>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.PlanFinanceiraMesAno: String;
Var
  dDtaInicial, dDtaFinal: TDateTime;
Begin
  Result:='';

  // Monta Data Inicial ========================================================
  If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Janeiro') Then
   dDtaInicial:=StrtoDateTime('01/01/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Fevereiro') Then
   dDtaInicial:=StrtoDateTime('01/02/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Maro')     Then
   dDtaInicial:=StrtoDateTime('01/03/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Abril')     Then
   dDtaInicial:=StrtoDateTime('01/04/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Maio')      Then
   dDtaInicial:=StrtoDateTime('01/05/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Junho')     Then
   dDtaInicial:=StrtoDateTime('01/06/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Julho')     Then
   dDtaInicial:=StrtoDateTime('01/07/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Agosto')    Then
   dDtaInicial:=StrtoDateTime('01/08/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Setembro')  Then
   dDtaInicial:=StrtoDateTime('01/09/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Outubro')   Then
   dDtaInicial:=StrtoDateTime('01/10/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Novembro')  Then
   dDtaInicial:=StrtoDateTime('01/11/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text)=AnsiUpperCase('Dezembro')  Then
   dDtaInicial:=StrtoDateTime('01/12/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text);

  // Monta Data Final ==========================================================
  If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Janeiro') Then
   dDtaFinal:=StrtoDateTime('01/01/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Fevereiro') Then
   dDtaFinal:=StrtoDateTime('01/02/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Maro')     Then
   dDtaFinal:=StrtoDateTime('01/03/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Abril')     Then
   dDtaFinal:=StrtoDateTime('01/04/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Maio')      Then
   dDtaFinal:=StrtoDateTime('01/05/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Junho')     Then
   dDtaFinal:=StrtoDateTime('01/06/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Julho')     Then
   dDtaFinal:=StrtoDateTime('01/07/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Agosto')    Then
   dDtaFinal:=StrtoDateTime('01/08/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Setembro')  Then
   dDtaFinal:=StrtoDateTime('01/09/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Outubro')   Then
   dDtaFinal:=StrtoDateTime('01/10/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Novembro')  Then
   dDtaFinal:=StrtoDateTime('01/11/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text)
  Else If AnsiUpperCase(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text)=AnsiUpperCase('Dezembro')  Then
   dDtaFinal:=StrtoDateTime('01/12/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text);

  If dDtaFinal<dDtaInicial Then
   Exit;

  While dDtaInicial<=dDtaFinal do
  Begin
    If Result<>'' Then
     Result:=Result+' Or m.comp_anomes='+QuotedStr(IntToStr(YearOf(dDtaInicial))+'/'+IntToStr(MonthOf(dDtaInicial)));

    If Result='' Then
     Result:=' And (m.comp_anomes='+QuotedStr(IntToStr(YearOf(dDtaInicial))+'/'+IntToStr(MonthOf(dDtaInicial)));

     dDtaInicial:=PrimeiroUltimoDia(dDtaInicial, 'U');
     dDtaInicial:=dDtaInicial+1;
  End;
  Result:=Result+')';

End; // Planilha FInanceira - Monta Mes/Ano para Pesquisa >>>>>>>>>>>>>>>>>>>>>>

// Calcula Planiha Financeira >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CalculaPlanilhaFinanceira;
Var
  i, iIndice: Integer;
  Cor: TColor;
  s, sCampo, MySql: String;
  hHrInicio, hHrFim: String;
Begin

  If sgMesAnoPlanFinanceira='' Then
   Exit;

  Dbg_FinanPlanFinanceira.SetFocus;

  Screen.Cursor:=crAppStart;

  // Seleciona Empresa =========================================================
  sgOutrasEmpresa:='(50,99)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;

  FrmSelectEmpProcessamento.ShowModal;
  iNrConexoes:=FrmSelectEmpProcessamento.iNrEmpProc;
  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Existe Empresa a Processar ====================================
  If DMBelShop.CDS_EmpProcessa.Eof Then
  Begin
    Dbg_FinanPlanFinanceira.SetFocus;
    Exit;
  End;

  // Cria ClientDataSet ========================================================
  try
    DMVirtual.CDS_V_PlanFinanceira.CreateDataSet;
    DMVirtual.CDS_V_PlanFinanceira.Open;
  Except
    DMVirtual.CDS_V_PlanFinanceira.EmptyDataSet;
    DMVirtual.CDS_V_PlanFinanceira.Open;
  End;
  DMVirtual.CDS_V_PlanFinanceira.Filtered:=False;
  DMVirtual.CDS_V_PlanFinanceira.Filter:='';

  // Guarda Hora de Inicio =====================================================
  hHrInicio:=TimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));

  // Apresenta o Processamento =================================================
  OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Acerta CDS_V_PlanFinanceira (Odir Altera Nova Loja) =======================
  For i:=3 to 50 do
  Begin
    DMVirtual.CDS_V_PlanFinanceira.Fields[i].Visible:=False;
    DMVirtual.CDS_V_PlanFinanceira.Fields[i].DisplayLabel:=DMVirtual.CDS_V_PlanFinanceira.Fields[i].FieldName;
  End; // For i:=3 to 50 do

  // Monta Planilha ============================================================
  Cor:=$00E1FFFF;
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Lojas Fora da Sequencia de Cdigo (Odir Altera Nova Loja)
      If DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsInteger=50 Then
       i:=33
      Else If DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsInteger=98 Then
       i:=34
      Else If DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsInteger=99 Then
       i:=35
      Else
       i:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsInteger+2;

      If Cor=$00E1FFFF Then
       Cor:=$00F2F9F9
      Else
       Cor:=$00E1FFFF;

      // Acerta Titulo no ClientDataSet ========================================
      DMVirtual.CDS_V_PlanFinanceira.Fields[i].Visible:=True;
      DMVirtual.CDS_V_PlanFinanceira.Fields[i].DisplayLabel:='Bel_'+
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

      // Libera e Acerta Cor da Coluna no Grid =================================
      Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Color:=Cor;
      Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Width:=85;
      Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Title.Alignment:=taRightJustify;
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do
  DMBelShop.CDS_EmpProcessa.First;

  // Acerta Coluna de Totais ===================================================
  If Cor=$00E1FFFF Then
   Cor:=$00F2F9F9
  Else
   Cor:=$00E1FFFF;

  // Acerta Titulo no ClientDataSet ============================================
  DMVirtual.CDS_V_PlanFinanceira.Fields[0].DisplayLabel:='';
  DMVirtual.CDS_V_PlanFinanceira.Fields[1].DisplayLabel:='';
  DMVirtual.CDS_V_PlanFinanceira.Fields[2].DisplayLabel:='';

  // Libera e Acerta Cor da Coluna no Grid =====================================
  Dbg_FinanPlanFinanceira.Columns[0].Width:=152;
  Dbg_FinanPlanFinanceira.Columns[1].Width:=40;
  Dbg_FinanPlanFinanceira.Columns[2].Width:=160;

  // Alterar em Caso de Nova Loja Fora de Sequencia (Odir Altera Nova Loja) ====
//  DMVirtual.CDS_V_PlanFinanceira.Fields[35].Visible:=True;
//  DMVirtual.CDS_V_PlanFinanceira.Fields[35].DisplayLabel:='EMPRESA';
  DMVirtual.CDS_V_PlanFinanceira.Fields[36].Visible:=True;
  DMVirtual.CDS_V_PlanFinanceira.Fields[36].DisplayLabel:='EMPRESA';

  Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Color:=Cor;
  Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Title.Alignment:=taRightJustify;
  Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Width:=90;
  Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.Columns.Count-1].Visible:=True;

  // Apropria Comprovantes =====================================================
  MySql:='SELECT g.num_ordem, g.cod_gr_finan, g.des_gr_finan, c.cod_comprov,'+
         ' c.des_comprov, c.ind_planilha, c.somar_em, c.subtrair_de'+
         ' FROM FIN_COMPROVANTES c, FIN_GR_FINANCEIRO g'+
         ' WHERE c.cod_gr_finan=g.cod_gr_finan'+
         ' and c.ind_ativo='+QuotedStr('SIM')+
         ' and g.ind_ativo='+QuotedStr('SIM')+
         ' ORDER BY g.num_ordem, c.des_comprov';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  iIndice:=0;
  // Linhas Iniciais ===========================================================
  DMVirtual.CDS_V_PlanFinanceira.Append;
  DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString:='';
  inc(iIndice);
  DMVirtual.CDS_V_PlanFinanceiraINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanFinanceiraVisivel.AsBoolean:=True;
  DMVirtual.CDS_V_PlanFinanceira.Post;

  // Perodo ===================================================================
  DMVirtual.CDS_V_PlanFinanceira.Append;
  DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString:='Perodo';
  inc(iIndice);
  DMVirtual.CDS_V_PlanFinanceiraINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanFinanceiraVisivel.AsBoolean:=True;
  DMVirtual.CDS_V_PlanFinanceira.Post;

  DMVirtual.CDS_V_PlanFinanceira.Append;

  If FrmSolicitacoes.Rb_FinanPlanFinanceiraUsarMesAno.Checked Then
    DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString:=
                                     Copy(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text,1,3)+
                                      '/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text+' a '+
                                     Copy(FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text,1,3)+
                                            '/'+FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text;

  If Not FrmSolicitacoes.Rb_FinanPlanFinanceiraUsarMesAno.Checked Then
    DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString:=
                      DateToStr(FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaInicio.Date)+
                      ' a '+
                      DateToStr(FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaFim.Date);

  inc(iIndice);
  DMVirtual.CDS_V_PlanFinanceiraINDICE.AsInteger:=iIndice;
  DMVirtual.CDS_V_PlanFinanceiraVisivel.AsBoolean:=True;
  DMVirtual.CDS_V_PlanFinanceira.Post;

  sgCodigo:='';
  DMBelShop.CDS_Busca.First;
  While Not DMBelShop.CDS_Busca.Eof do
  Begin
    Refresh;

    // Monta Array de Usuario que no visualizam Grupo Financeiro ==============
    MySql:='Select vo.cod_tabela'+
           ' From PS_VISUAL_OBJETOS vo'+
           ' Where vo.des_tabela=''FIN_GR_FINANCEIRO'''+
           ' And DES_MODULO =''Ts_FinanComprPlanFinan'''+
           ' And vo.cod_usuario='+Cod_Usuario+
           ' Order By vo.cod_tabela';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    // Inicializa Array de Usuarios ============================================
    Array_Usuarios := nil; // libera
     
    // Alocar Array de Usuarios ================================================
    i:=0;
    If DMBelShop.CDS_BuscaRapida.RecordCount>0 Then
    Begin
      SetLength(Array_Usuarios, DMBelShop.CDS_BuscaRapida.RecordCount); 

      While Not DMBelShop.CDS_BuscaRapida.Eof do
      Begin
        Array_Usuarios[i]:=
                  DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Tabela').AsInteger;
        Inc(i);
                  
        DMBelShop.CDS_BuscaRapida.Next;
      End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
    End; // If DMBelShop.CDS_BuscaRapida.RecordCount>0 Then
    DMBelShop.CDS_BuscaRapida.Close;

    // Grava Grupo Financeiro ==================================================
    If sgCodigo<>DMBelShop.CDS_Busca.FieldByName('cod_gr_finan').AsString Then
    Begin
      DMVirtual.CDS_V_PlanFinanceira.Append;
      DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString:='';
      inc(iIndice);
      DMVirtual.CDS_V_PlanFinanceiraINDICE.AsInteger:=iIndice;
      DMVirtual.CDS_V_PlanFinanceiraVisivel.AsBoolean:=VerificaRegistroNaoVisivelTabela(
                     DMBelShop.CDS_Busca.FieldByName('cod_gr_finan').AsInteger);
        
      DMVirtual.CDS_V_PlanFinanceira.Post;

      DMVirtual.CDS_V_PlanFinanceira.Append;
      DMVirtual.CDS_V_PlanFinanceiraTipo.AsString:=
                       DMBelShop.CDS_Busca.FieldByName('des_gr_finan').AsString;

      For i:=1 to 32 do // Empresas at 30 Sequencia Normal - 50 e 99 Empresas Fora da Sequencia de Cdigo
      Begin
        If i=31 Then
         sCampo:='Vlr_Empresa50' // 50 Empresa Fora da Sequencia de Cdigo
        Else If i=32 Then
         sCampo:='Vlr_Empresa99' // 99 Empresa Fora da Sequencia de Cdigo
        Else If i<10 Then
         sCampo:='Vlr_Empresa0'+IntToStr(i) // Empresas na Sequencia Normal de Cdigo
        Else
         sCampo:='Vlr_Empresa'+IntToStr(i); // Empresas na Sequencia Normal de Cdigo

        DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=0;
      End;
      DMVirtual.CDS_V_PlanFinanceiraVlr_Empresa_Total.AsCurrency:=0;

      inc(iIndice);
      DMVirtual.CDS_V_PlanFinanceiraINDICE.AsInteger:=iIndice;

      DMVirtual.CDS_V_PlanFinanceiraVisivel.AsBoolean:=VerificaRegistroNaoVisivelTabela(
                     DMBelShop.CDS_Busca.FieldByName('cod_gr_finan').AsInteger);

      DMVirtual.CDS_V_PlanFinanceira.Post;
    End; // If sgCodigo<>DMBelShop.CDS_Busca.FieldByName('cod_gr_finan').AsString Then

    // Grava Comprovantes ======================================================
    DMVirtual.CDS_V_PlanFinanceira.Append;
    DMVirtual.CDS_V_PlanFinanceiraCod_Comprovante.AsString:=
                        DMBelShop.CDS_Busca.FieldByName('cod_comprov').AsString;
    DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString:=
                        DMBelShop.CDS_Busca.FieldByName('des_comprov').AsString;

    For i:=1 to 32 do // Empresas at 30 Sequencia Normal - 50 e 99 Empresas Fora da Sequencia de Cdigo
    Begin
      If i=31 Then
       sCampo:='Vlr_Empresa50' // 50 Empresa Fora da Sequencia de Cdigo
      Else If i=32 Then
       sCampo:='Vlr_Empresa99' // 99 Empresa Fora da Sequencia de Cdigo
      Else If i<10 Then
       sCampo:='Vlr_Empresa0'+IntToStr(i) // Empresas na Sequencia Normal de Cdigo
      Else
       sCampo:='Vlr_Empresa'+IntToStr(i); // Empresas na Sequencia Normal de Cdigo

      DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=0;
    End;
    DMVirtual.CDS_V_PlanFinanceiraVlr_Empresa_Total.AsCurrency:=0;
    inc(iIndice);
    DMVirtual.CDS_V_PlanFinanceiraINDICE.AsInteger:=iIndice;

    DMVirtual.CDS_V_PlanFinanceiraVisivel.AsBoolean:=VerificaRegistroNaoVisivelTabela(
                     DMBelShop.CDS_Busca.FieldByName('cod_gr_finan').AsInteger);

    // Zera Campos de Total por Mes se Uma Empresa Selecionada =================
    If iNrConexoes=1 Then
    Begin
      For i:=1 to 12 do
      Begin
        If i<10 Then
         sCampo:='Vlr_Mes0'+IntToStr(i)
        Else
         sCampo:='Vlr_Mes'+IntToStr(i);
      
        DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=0;
      End; // For i:=1 to 12 do
    End; // If iNrConexoes=1 Then
                     
    DMVirtual.CDS_V_PlanFinanceira.Post;

    // Vai para o Prximo ======================================================
    sgCodigo:=DMBelShop.CDS_Busca.FieldByName('cod_gr_finan').AsString;

    DMBelShop.CDS_Busca.Next;
  End; // While Not DMBelShop.CDS_Busca.Eof do
  DMBelShop.CDS_Busca.Close;

  // Fixa Colunas ==============================================================
  THackDBGrid(Dbg_FinanPlanFinanceira).FixedCols:=4;

  // ===========================================================================
  // Processa Empresas Selecionadas ============================================
  Dbg_FinanPlanFinanceira.Visible:=False; // Inibe Apresentao dos Resultados
  PlanFinanceiraEmpresas;
  // ===========================================================================

  // Retira Grupos Financeiros de No Visualizao =============================
  DMVirtual.CDS_V_PlanFinanceira.Filtered:=False;
  DMVirtual.CDS_V_PlanFinanceira.Filter:='Visivel=''False''';
  DMVirtual.CDS_V_PlanFinanceira.Filtered:=True;

  While Not DMVirtual.CDS_V_PlanFinanceira.Eof do
  Begin
    DMVirtual.CDS_V_PlanFinanceira.Delete;
  End;
  DMVirtual.CDS_V_PlanFinanceira.Filter:='';
  DMVirtual.CDS_V_PlanFinanceira.Filtered:=False;

  // Acerta Nomes dos Meses Individuais (Odir Altera Nova Loja) ================
//  For i:=38 to 49 do
  For i:=38 to 50 do
  Begin
    If DMVirtual.CDS_V_PlanFinanceira.Fields[i].Visible Then
    Begin
      DMVirtual.CDS_V_PlanFinanceira.Fields[i].DisplayLabel:='Mes_'+
                          DMVirtual.CDS_V_PlanFinanceira.Fields[i].DisplayLabel;
    End; // If DMVirtual.CDS_V_PlanFinanceira.Fields[ii].FieldName='Vlr_mes'+Copy(Memo3.Lines[i],1,2) Then
  End; // For i:=0 to DMVirtual.CDS_V_PlanFinanceira.Fields.Count-1 do

  // Libera Apresentao dos Resultados ========================================
  Dbg_FinanPlanFinanceira.Visible:=True;
  OdirPanApres.Visible:=False;

  // Posiciona do Grid =========================================================
  If Not DMVirtual.CDS_V_PlanFinanceira.Eof Then
  Begin
    DMVirtual.CDS_V_PlanFinanceira.First;
    Dbg_FinanPlanFinanceira.SelectedIndex:=3;
    Dbg_FinanPlanFinanceira.SetFocus;
  End; // If Not DMVirtual.CDS_V_PlanFinanceira.Eof do

  // Guarda Hora de Fim ========================================================
  hHrFim:=TimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  s:=TimeToStr(StrToTime(hHrFim)-StrToTime(hHrInicio));
 
  DMVirtual.CDS_V_PlanFinanceira.First;
  Screen.Cursor:=crDefault;

  THackDBGrid(Dbg_FinanPlanFinanceira).FixedCols:=4;

  msg('Calculo da Planilha Financeira'+cr+'Efetuado com SUCESSO !!'+cr+cr+'Tempo: '+s,'A');

  // Apresenta Lojas No Conectadas ============================================
  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

end; // Calcula Planiha Financeira >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Planilha Financeira - Processa Empresa >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.PlanFinanceiraEmpresas;
Var
  sCampo, MySql: String;
  bSiga: Boolean;
  i: Integer;
  iIndexArray: Integer;
Begin

  // Inicia Processamento ======================================================
  Array_Campos:=nil;
  SetLength(Array_Campos, 100); 
  iIndexArray:=0;
  sgLojasNConectadas:='';

  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

      // Monta Campo da Empresa ================================================
      sCampo:='Vlr_Empresa'+sgCodEmp;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sgCodEmp+' - '+
                                 DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Monta Sql =============================================================
      MySql:=' Select Trim(m.codcomprovante) codcomprovante, sum(m.totnota) Vlr_Total'+
             ' From MCLI m'+
             ' Where m.codfilial='+QuotedStr(sgCodEmp)+
             sgMesAnoPlanFinanceira+ // Periodo
             ' And m.chavenf<>'''''+

             ' And not exists'+
             ' (Select 1'+
             '  From mclipago mm'+
             '  Where mm.chavenf=m.chavenf'+
             '  and mm.codfilial=m.codfilial'+
             '  And mm.chavenf<>'''')'+
             ' Group By 1'+

             ' UNION'+ // Unio ===========================

             ' Select Trim(m1.codcomprovante) codcomprovante, sum(m1.totnota) Vlr_Total'+
             ' From MFOR m1'+
             ' Where m1.codfilial='+QuotedStr(sgCodEmp)+
             f_Troca('m.','m1.',f_troca('datadocumento','dataentrada',sgMesAnoPlanFinanceira))+  // Periodo
             ' And m1.chavenf<>'''''+

             ' And Not Exists'+
             ' (Select 1'+
             '  From mforpago mm1'+
             '  Where mm1.chavenf=m1.chavenf'+
             '  And mm1.codfilial=m1.codfilial'+
             '  And mm1.chavenf<>'''')'+
             ' Group by 1'+

             ' UNION'+ // Unio ===========================

             ' Select Trim(p.codcomprovante) codcomprovante, sum(p.totnota) Vlr_Total'+
             ' From mclipago p'+
             ' Where p.codfilial='+QuotedStr(sgCodEmp)+
             f_Troca('m.','p.',f_troca('datadocumento','datapagamento',sgMesAnoPlanFinanceira))+  // Periodo
             ' And p.chavenf<>'''''+
             ' Group By 1'+

             ' UNION'+ // Unio ===========================

             ' Select Trim(p1.codcomprovante) codcomprovante, sum(p1.totnota) Vlr_Total'+
             ' From mforpago p1'+
             ' Where p1.codfilial='+QuotedStr(sgCodEmp)+
             f_Troca('m.','p1.',f_troca('datadocumento','datapagamento',sgMesAnoPlanFinanceira))+  // Periodo
             ' And p1.chavenf<>'''''+
             ' Group By 1'+

             ' UNION'+ // Unio ===========================

             ' Select'+
             ' CASE'+
             '   When p.principalfor in (''000500'',''000883'') Then'+
             '      ''9991'''+ // Venda Balcao
             '   Else'+
             '      ''9990'''+ // Venda Loja
             ' END codcomprovante,'+
             ' sum(mp.valtotal) Vlr_Total'+
             ' From MCLI m, MCLIPRO mp, PRODUTO p'+
             ' Where m.chavenf=mp.chavenf'+
             ' AND mp.codproduto=p.codproduto'+
             ' AND m.codfilial='+QuotedStr(sgCodEmp)+
             sgMesAnoPlanFinanceira+ // Periodo
             ' AND m.codcomprovante in (''002'', ''007'')'+
             ' And m.chavenf<>'''''+
             ' Group By 1';


      // Conecta Empresa =======================================================
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         Refresh;
         bSiga:=False;

         If sgLojasNConectadas='' Then
          sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
         Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
          sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then

      // Inicia Processamento ==================================================
      If bSiga Then // Empresa Conectada
      Begin
        // Cria Query da Empresa ------------------------------------
        CriaQueryIB('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                    'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                    IBQ_ConsultaFilial, True, True);

        // Busca Comprovantes ---------------------------------------
        IBQ_ConsultaFilial.SQL.Clear;
        IBQ_ConsultaFilial.SQL.Add(MySql);

        // Abre Query -----------------------------------------------
        i:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            IBQ_ConsultaFilial.Open;
            bSiga:=True;
          Except
            Inc(i);
          End; // Try

          If i>10 Then
          Begin
            If sgLojasNConectadas='' Then
             sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
            Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
             sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
          End; // If i>10 Then
        End; // While Not bSiga do

        // Processamento =======================================================
        If bSiga Then // Query Executada
        Begin
          While Not IBQ_ConsultaFilial.Eof do
          Begin
            Refresh;

            // Acumula Totais do Grupo Financeiro -------------------
            MySql:='select g.des_gr_finan, c.ind_soma_grupo'+
                   ' from FIN_COMPROVANTES c, FIN_GR_FINANCEIRO g'+
                   ' where c.cod_gr_finan=g.cod_gr_finan'+
                   ' and g.ind_ativo='+QuotedStr('SIM')+
                   ' and c.cod_comprov='+QuotedStr(Trim(IBQ_ConsultaFilial.FieldByName('codcomprovante').AsString));
            DMBelShop.CDS_BuscaRapida.Close;
            DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
            DMBelShop.CDS_BuscaRapida.Open;

            // Soma no Grupo Financeiros ----------------------------
            If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('des_gr_finan').AsString)<>'' Then
            Begin
              If DMBelShop.CDS_BuscaRapida.FieldByName('ind_soma_grupo').AsString='SIM' Then
              Begin
                If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_BuscaRapida.FieldByName('des_gr_finan').AsString,[]) Then
                Begin
                  DMVirtual.CDS_V_PlanFinanceira.Edit;
                  DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=
                             DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency+
                             IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;                             
                  DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                             DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency+
                             IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
                  DMVirtual.CDS_V_PlanFinanceira.Post;
                End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Tipo',DMBelShop.CDS_BuscaRapida.FieldByName().AsString) Then
              End; // If DMBelShop.CDS_BuscaRapida.FieldByName('ind_soma_grupo').AsString='SIM' Then

              // Soma no Comprovante --------------------------------
              If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',Trim(IBQ_ConsultaFilial.FieldByName('codcomprovante').AsString),[]) Then
              Begin
                DMVirtual.CDS_V_PlanFinanceira.Edit;
                DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency:=
                           DMVirtual.CDS_V_PlanFinanceira.FieldByName(sCampo).AsCurrency+
                           IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
                DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency:=
                           DMVirtual.CDS_V_PlanFinanceira.FieldByName('Vlr_Empresa_Total').AsCurrency+
                           IBQ_ConsultaFilial.FieldByName('Vlr_Total').AsCurrency;
                DMVirtual.CDS_V_PlanFinanceira.Post;
              End; // If DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',Trim(IBQ_ConsultaFilial.FieldByName('codcomprovante').AsString),[]) Then
            End; // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('des_gr_finan').AsString)<>'' Then
            DMBelShop.CDS_BuscaRapida.Close;

            IBQ_ConsultaFilial.Next;
          End; // While Not IBQ_ConsultaFilial.Eof do
          IBQ_ConsultaFilial.Close;
        End; // If bSiga Then // Query Executada

        // Processa Totais por Mes se uma Empresa ==============================
        If (iNrConexoes=1) and (igNrMeses>0) Then
         CalculaMesesIndividuais(sgCodEmp);

        // Calcula Comprovantes com Formula ====================================
        Array_Campos[iIndexArray]:=sCampo;
        Inc(iIndexArray);
        PlanilhaFinanceiraCalculaFormula(sCampo);

        // Calcula Comprovantes com Somar em e/ou Subtrair em ==================
        PlanilhaFinanceiraSomaSubtrai(sCampo);

      End; // If bSiga Then // Empresa Conectada

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');

//      // Calcula Comprovantes com Formula ======================================
//      Array_Campos[iIndexArray]:=sCampo;
//      Inc(iIndexArray);
//      PlanilhaFinanceiraCalculaFormula(sCampo);
//
//      // Calcula Comprovantes com Somar em e/ou Subtrair em ====================
//      PlanilhaFinanceiraSomaSubtrai(sCampo);
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMVirtual.CDS_V_PlanFinanceira.First;

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  // Retira Comprovantes Que no devem ser Apresentados e INATIVOS =============
  PlanilhaFinanceiraRetiraComprovantes;

End; // Planilha Financeira - Processa Empresa >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Apresenta Transito >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.VerTransito(IBQ: TIBQuery; DS: TDataSource; bAltTrasito: Boolean);
Begin
  If IBQ.FieldByName('QTD_TRANSITO').AsCurrency=0 Then
  Begin
    msg('Produto Sem Quantidade em Trnsito !!', 'A');
    Dbg_GeraOCGrid.SetFocus;
    Exit;
  End;
  Screen.Cursor:=crAppStart;

  // Busca Transito ==========================================================
  DMBelShop.CDS_VerTransito.Close;
  DMBelShop.SDS_VerTransito.Params.ParamByName('CodEmp').Value:=
                                        IBQ.FieldByName('Cod_Empresa').AsString;
  DMBelShop.SDS_VerTransito.Params.ParamByName('CodProduto').Value:=
                                           IBQ.FieldByName('Cod_Item').AsString;
  DMBelShop.CDS_VerTransito.Open;

  Screen.Cursor:=crDefault;

  If Trim(DMBelShop.CDS_VerTransitoCODFILIAL.AsString)<>'' Then
  Begin
    FrmVerTransito:=TFrmVerTransito.Create(Self);

    FrmVerTransito.Dbe_VerTransitoCodProduto.DataSource:=DS;
    FrmVerTransito.Dbe_VerTransitoDesProduto.DataSource:=DS;

    If (Not bAltTrasito) Or (IBQ.FieldByName('Ind_OC_Gerada').AsString='S') Then
     FrmVerTransito.Pan_VerTransitoFechaOC.Visible:=False;

    FrmVerTransito.Pan_VerTransitoEmpresa.Caption:=
    'Ordens de Compra em Trnsito/Em Aberto - Empresa: '+
                                        IBQ.FieldByName('Cod_Empresa').AsString+
                                        ' - '+
                                        IBQ.FieldByName('Des_Empresa').AsString;

    FrmVerTransito.ShowModal;
    FreeAndNil(FrmVerTransito);
  End;

End; // Apresenta Transito >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Totais de Pedidos ou Ordem de Compra >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.TotaisPedOC(Var svTotal_Valor: String; Var svTotal_Itens: String; Var svTotal_Qtd: String;
                                  siNumDocto, siCodEmp, sSituacaoQtd: String; siNumOC: String = ''; sCodForn: String = '');
Var
  MySql: String;
Begin
// sSituacaoQtd = 'T' Todos Itens
//                'C' Com Quantidade a Comprar
//                'S' Sem Quantidade a Comprar

  Screen.Cursor:=crAppStart;

  MySql:='select'+
         ' sum(Coalesce(oc.vlr_tot_compra,0)) Total_Valor,'+
         ' Count(oc.cod_item) Total_Itens,'+
         ' Sum(Coalesce(oc.qtd_acomprar,0)) Total_Qtd'+

         ' from OC_COMPRAR oc'+

         ' Where oc.num_documento='+QuotedStr(siNumDocto)+
         ' And   oc.cod_empresa='+QuotedStr(siCodEmp);

         If (Bt_GeraOCImpEditOC.Caption='Editar OC') Then
          MySql:=
           MySql+' And   oc.qtd_transf=0';

         If (Bt_GeraOCImpEditOC.Caption='Editar TR') Then
          MySql:=
           MySql+' And   oc.qtd_transf>0';

         If sCodForn<>'' Then
          MySql:=MySql+' And oc.cod_fornecedor='+QuotedStr(sCodForn);

         If (Bt_GeraOCImpEditOC.Caption='Editar OC') Then
         Begin
           If sSituacaoQtd='C' Then
            MySql:=MySql+' And oc.qtd_acomprar<>0';

           If sSituacaoQtd='S' Then
            MySql:=MySql+' And oc.qtd_acomprar=0';
         End; // If (Bt_GeraOCImpEditOC.Caption='Editar OC') Then

         If siNumOC<>'' Then
          MySql:=MySql+' And oc.num_oc_gerada='+QuotedStr(siNumOC)
         Else
          MySql:=MySql+' And oc.ind_oc_gerada= ''N''';

  MySql:=
   MySql+' AND   EXISTS (SELECT 1'+
         '               FROM OC_COMPRAR_DOCS d'+
         '               WHERE d.num_docto=oc.num_documento'+
         '               AND   d.origem<>'+QuotedStr('Linx')+')';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  svTotal_Valor :='0';
  svTotal_Itens :='0';
  svTotal_Qtd   :='0';
  If Trim(DMBelShop.CDS_Busca.FieldBYName('Total_Valor').AsString)<>'' Then
  Begin
    svTotal_Valor :=DMBelShop.CDS_Busca.FieldBYName('Total_Valor').AsString;
    svTotal_Itens :=DMBelShop.CDS_Busca.FieldBYName('Total_Itens').AsString;
    svTotal_Qtd   :=DMBelShop.CDS_Busca.FieldBYName('Total_Qtd').AsString;
  End;

  DMBelShop.CDS_Busca.Close;

  Screen.Cursor:=crDefault;

End; // Totais de Pedidos ou Ordem de Compra >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Conecta a Administraao MPMS >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.ConectaMPMS(bTestar: Boolean=False): Boolean;
Var
  MySql: String;
  i: Integer;
  s, sMatriz: String;
  sEndIP: String;
Begin
  Result:=False;

  Try
    MySql:='Select *'+
           ' From EMP_Conexoes e';

           If sgCodLojaUnica='' Then
            Begin
              MySql:=MySql+' Where e.cod_filial='+QuotedStr('99');
              sMatriz:='MPMS';
            End
           Else
            Begin
              MySql:=MySql+' Where e.cod_filial='+QuotedStr(sgCodLojaUnica);
              sMatriz:=sgCodLojaUnica;
            End;
    DMBelShop.CDS_ConectaEmpresa.Close;
    DMBelShop.SDS_ConectaEmpresa.CommandText:=MySql;
    DMBelShop.CDS_ConectaEmpresa.Open;

    sCodMatriz:=DMBelShop.CDS_ConectaEmpresa.FieldByName('Cod_Filial').AsString;

    // Inicializa Conexao
    For i:=0 to DMConexoes.ComponentCount-1 do
    Begin
      If DMConexoes.Components[i] is TIBDatabase Then
      Begin
        If (DMConexoes.Components[i] as TIBDatabase).Name='IBDB_'+sMatriz Then
        Begin
           (DMConexoes.Components[i] as TIBDatabase).Connected:=False;

           sEndIP:=DMBelShop.CDS_ConectaEmpresa.FieldByName('ENDERECO_IP').AsString;

          // Conexesa CD=99 e Central de Trocas -------------------------------
          If ((sCodMatriz='99') Or (sCodMatriz='50')) Then
           Begin
             s:='\\'+IncludeTrailingPathDelimiter(sEndIP)+IncludeTrailingPathDelimiter(
                     DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                     DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString
           End // If ((sCodMatriz='99') Or (sCodMatriz='50')) Then

          // Tipo de Conexo: NetBEUI ------------------------------------------
          Else If (Trim(sgTpConexao)='')              Or (Trim(sgTpConexao)='NetBEUI')        Or
                  (AnsiUpperCase(sEndIP)='LOCALHOST') Or (AnsiUpperCase(sEndIP)=sgCompServer) Or
                  (AnsiUpperCase(sEndIP)=sgIPServer) Then
           s:='\\'+IncludeTrailingPathDelimiter(sEndIP)+IncludeTrailingPathDelimiter(
                                               DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                                               DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString

          // Tipo de Conexo: TCP/IP -------------------------------------------
          Else If (Trim(sgTpConexao)='TCP/IP')          and (AnsiUpperCase(sEndIP)<>'LOCALHOST') and
                  (AnsiUpperCase(sEndIP)<>sgCompServer) and (AnsiUpperCase(sEndIP)<>sgIPServer) Then
           s:=sEndIP+':'+
              IncludeTrailingPathDelimiter(DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                                           DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString;

          //==============================================================================
          // Acerta Conexao com a Loja 08 - 201.86.212.9:C:\SIDICOM.NEW\BIGNEW.FDB - TCPIP
          //==============================================================================
          If sCodMatriz='08' Then
           s:=sEndIP+':'+ IncludeTrailingPathDelimiter(
                          DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                          DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString;

          //  \\201.86.212.10\C:\SIDICOM.NEW\BANCO.FDB
          (DMConexoes.Components[i] as TIBDatabase).DatabaseName:=s;
          Break;
        End;
      End; // If DMConexoes.Components[i] is TIBDatabase Then
    End; // For i:=0 to DMConexoes.ComponentCount-1 do

    If Not ConexaoEmpIndividual('IBDB_'+sMatriz, 'IBT_'+sMatriz,'A') Then
    Begin
      DMBelShop.CDS_ConectaEmpresa.Close;

      If Not bTestar Then
      Begin
        If sgCodLojaUnica='' Then
         msg('Impossvel Continuar...'+cr+'Banco de Dados MATRIZ'+cr+cr+'No CONECTADO !!','A')
        Else
         msg('Impossvel Continuar...'+cr+'Banco de Dados SIDICOM'+cr+cr+'No CONECTADO !!','A');

        Application.Terminate;
        Exit;
      End; // If Not bTestar Then
    End;

    // Cria Querys da MPMS =====================================================
    If Not bTestar Then
    Begin
      CriaQueryIB('IBDB_'+sMatriz, 'IBT_'+sMatriz, IBQ_MPMS, True, True);
    End; // If Not bTestar Then

    DMBelShop.CDS_ConectaEmpresa.Close;
    Result:=True;
  Except
  End;
End; // Conecta a Administraao MPMS >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Conecta a Empresa Matriz >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.ConectaMatriz(bTestar: Boolean=False): Boolean;
Var
  MySql: String;
  i: Integer;
  s, sEndIP: String;
Begin
  Result:=False;

  Try
    MySql:='Select *'+
           ' From EMP_Conexoes emp';

           If sgCodLojaUnica='' Then
            Begin
              MySql:=MySql+' Where emp.Tip_Emp=''M''';
            End
           Else
            Begin
              MySql:=MySql+' Where emp.cod_filial='+QuotedStr(sgCodLojaUnica);
            End;
    DMBelShop.CDS_ConectaEmpresa.Close;
    DMBelShop.SDS_ConectaEmpresa.CommandText:=MySql;
    DMBelShop.CDS_ConectaEmpresa.Open;

    sCodMatriz:=DMBelShop.CDS_ConectaEmpresa.FieldByName('Cod_Filial').AsString;

    // Inicializa Conexao
    For i:=0 to DMConexoes.ComponentCount-1 do
    Begin
      If DMConexoes.Components[i] is TIBDatabase Then
      Begin
        If (DMConexoes.Components[i] as TIBDatabase).Name='IBDB_'+sCodMatriz Then
        Begin
           (DMConexoes.Components[i] as TIBDatabase).Connected:=False;

           sEndIP:=DMBelShop.CDS_ConectaEmpresa.FieldByName('ENDERECO_IP').AsString;

          // Conexesa CD=99 e Central de Trocas -------------------------------
          If ((sCodMatriz='99') Or (sCodMatriz='50')) Then
           Begin
              s:='\\'+IncludeTrailingPathDelimiter(sEndIP)+IncludeTrailingPathDelimiter(
                      DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                      DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString
           End // If ((sCodMatriz='99') Or (sCodMatriz='50')) Then

          // Tipo de Conexo: NetBEUI ------------------------------------------
          Else If (Trim(sgTpConexao)='') Or (Trim(sgTpConexao)='NetBEUI')                  Or
               (AnsiUpperCase(sEndIP)='LOCALHOST') Or (AnsiUpperCase(sEndIP)=sgCompServer) Or
               (AnsiUpperCase(sEndIP)=sgIPServer) Then
           s:='\\'+IncludeTrailingPathDelimiter(sEndIP)+IncludeTrailingPathDelimiter(
                                               DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                                               DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString

          // Tipo de Conexo: TCP/IP -------------------------------------------
          Else If (Trim(sgTpConexao)='TCP/IP')          and (AnsiUpperCase(sEndIP)<>'LOCALHOST') and
                  (AnsiUpperCase(sEndIP)<>sgCompServer) and (AnsiUpperCase(sEndIP)<>sgIPServer) Then
           s:=sEndIP+':'+
              IncludeTrailingPathDelimiter(DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                                           DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString;

          //==============================================================================
          // Acerta Conexao com a Loja 08 - 201.86.212.9:C:\SIDICOM.NEW\BIGNEW.FDB - TCPIP
          //==============================================================================
          If sCodMatriz='08' Then
           s:=sEndIP+':'+ IncludeTrailingPathDelimiter(
                          DMBelShop.CDS_ConectaEmpresa.FieldByName('PASTA_BASE_DADOS').AsString)+
                          DMBelShop.CDS_ConectaEmpresa.FieldByName('DES_BASE_DADOS').AsString;

          //  \\201.86.212.10\C:\SIDICOM.NEW\BANCO.FDB
          (DMConexoes.Components[i] as TIBDatabase).DatabaseName:=s;
          Break;
        End;
      End; // If DMConexoes.Components[i] is TIBDatabase Then
    End; // For i:=0 to DMConexoes.ComponentCount-1 do

    If Not ConexaoEmpIndividual('IBDB_'+sCodMatriz, 'IBT_'+sCodMatriz,'A') Then
    Begin
      DMBelShop.CDS_ConectaEmpresa.Close;

      If Not bTestar Then
      Begin
        If sgCodLojaUnica='' Then
         msg('Impossvel Continuar...'+cr+'Banco de Dados MATRIZ'+cr+cr+'No CONECTADO !!','A')
        Else
         msg('Impossvel Continuar...'+cr+'Banco de Dados SIDICOM'+cr+cr+'No CONECTADO !!','A');

        Application.Terminate;
        Exit;
      End; // If Not bTestar Then
    End;

    // Cria Querys da Matriz ==========================================
    If Not bTestar Then
    Begin
      CriaQueryIB('IBDB_'+sCodMatriz, 'IBT_'+sCodMatriz, FrmBelShop.IBQ_Matriz, True, True);

      CriaQueryIB('IBDB_'+sCodMatriz,'IBT_'+sCodMatriz, FrmBelShop.IBQ_ConsultaMatriz, True, True);
    End; // If Not bTestar Then

    DMBelShop.CDS_ConectaEmpresa.Close;

    Result:=True;
  Except
  End;

End; // Conecta a Empresa Matriz >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Monta sgFornecedores >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MontaSelectFornecedores;
Begin
  // Fornecedores Selecionados =================================================
  sgFornecedores:='';
  If Not DMVirtual.CDS_V_Fornecedores.IsEmpty Then
  Begin
    DMVirtual.CDS_V_Fornecedores.First;
    While Not DMVirtual.CDS_V_Fornecedores.Eof do
    Begin
      If sgFornecedores='' Then
       sgFornecedores:=
                  QuotedStr(DMVirtual.CDS_V_FornecedoresCod_Fornecedor.AsString)
      Else
       sgFornecedores:=sgFornecedores+', '+
                 QuotedStr(DMVirtual.CDS_V_FornecedoresCod_Fornecedor.AsString);

      DMVirtual.CDS_V_Fornecedores.Next;
    End; // While Not DMVirtual.CDS_V_Fornecedores.Eof do
    DMVirtual.CDS_V_Fornecedores.First;

  End; // If Not DMVirtual.CDS_V_Fornecedores.IsEmpty Then
End; // Monta sgFornecedores >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Inicializa StoredProcedure >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.StoredProcInicializa(Var IBSP: TIBStoredProc; sDataBase, sTransaction: String);
Var
  i: Integer;
  bDb, bTr: Boolean;
Begin
  bDb:=False;
  bTr:=False;

  If IBSP <> Nil Then
  Begin
    FreeAndNil(IBSP);
  End;

  IBSP:=TIBStoredProc.Create(Self);

  For i:=0 to DMConexoes.ComponentCount-1 do
  Begin
    If DMConexoes.Components[i] is TIBDatabase Then
    Begin
      If (DMConexoes.Components[i] as TIBDatabase).Name=sDataBase Then
      Begin
        bDb:=True;
        IBSP.Database:=(DMConexoes.Components[i] as TIBDatabase);
      End;
    End; // DMConexoes.Components[i] is TIBDatabase Then

    If DMConexoes.Components[i] is TIBTransaction Then
    Begin
      If (DMConexoes.Components[i] as TIBTransaction).Name=sTransaction Then
      Begin
        bTr:=True;
        IBSP.Transaction:=(DMConexoes.Components[i] as TIBTransaction);
      End;
    End; // If DMConexoes.Components[i] is TIBTransaction Then

    If bDb and bTr Then
     Break;
  End; // For i:=0 to DMConexoes.ComponentCount-1 do
End; // Inicializa StoredProcedure >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Conta Registros do IBQuery >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.TotalRegistros(IBQ: TIBQuery;
                                    SqlSelect: String;
                                    Sql1: String =''; Sql2: String =''; Sql3: String ='';
                                    NomeParam1: String =''; VlrParam1 : String ='';
                                    NomeParam2: String =''; VlrParam2 : String ='';
                                    NomeParam3: String =''; VlrParam3 : String ='';
                                    NomeParam4: String =''; VlrParam4 : String ='';
                                    NomeParam5: String =''; VlrParam5 : String ='';
                                    NomeParam6: String =''; VlrParam6 : String ='';
                                    NomeParam7: String =''; VlrParam7 : String ='';
                                    NomeParam8: String =''; VlrParam8 : String =''): Integer;
Var
  MySqlCount: String;
Begin
  Result:=0;

  If IBQ_CountReg <> Nil Then
  Begin
    FreeAndNil(IBQ_CountReg)
  End;

  IBQ_CountReg:=TIBQuery.Create(Self);
  IBQ_CountReg.FetchAll;
  IBQ_CountReg.Database:=IBQ.Database;
  IBQ_CountReg.Transaction:=IBQ.Transaction;

  MySqlCount:='Select Count(*) Qtd';
  MySqlCount:=MySqlCount+SqlSelect;

  If Sql1<>'' Then MySqlCount:=MySqlCount+Sql1;
  If Sql2<>'' Then MySqlCount:=MySqlCount+Sql2;
  If Sql3<>'' Then MySqlCount:=MySqlCount+Sql3;

  IBQ_CountReg.SQL.Add(MySqlCount);

  If NomeParam1<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam1).Value:=VlrParam1;
  If NomeParam2<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam2).Value:=VlrParam2;
  If NomeParam3<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam3).Value:=VlrParam3;
  If NomeParam4<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam4).Value:=VlrParam4;
  If NomeParam5<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam5).Value:=VlrParam5;
  If NomeParam6<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam6).Value:=VlrParam6;
  If NomeParam7<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam7).Value:=VlrParam7;
  If NomeParam8<>'' Then IBQ_CountReg.Params.ParamByName(NomeParam8).Value:=VlrParam8;

  IBQ_CountReg.Open;

  If not IBQ_CountReg.IsEmpty Then
   Result:=IBQ_CountReg.FieldByName('Qtd').AsInteger;

  IBQ_CountReg.Close;
End; // Conta Registros do IBQuery >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Busca Totais das OCs >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.TotaisOC(sNrDoc: String);
Var
  MySql: String;
Begin
  EdtGeraOCTotalGeral.Value:=0;
  DMBelShop.CDS_AComprarOCs.Close;
  If EdtGeraOCBuscaDocto.Value<>0 Then
  Begin
    MySql:=' SELECT'+
           ' ''N'' gerar,'+
           ' CASE'+
           '    WHEN COALESCE(oc.qtd_transf, 0) > 0 THEN'+
           '      ''TR'''+
           '    ELSE'+
           '      ''OC'''+
           ' END tipo,'+
           ' oc.cod_empresa cod_emp_fil,'+
           ' oc.des_empresa des_emp_fil,'+
           ' CASE'+
           '    WHEN em.cod_linx <> 0 THEN'+
           '      em.cod_linx'+
           ' END cod_linx,'+
           ' oc.ind_oc_gerada,'+
           ' oc.cod_fornecedor,'+
           ' oc.des_fornecedor fornecedor,'+
           ' SUM(COALESCE(oc.vlr_bruto, 0.00)) total_bruto,'+
           ' SUM(COALESCE(oc.vlr_descontos, 0.00)) total_descontos,'+
           ' SUM(COALESCE(oc.vlr_ipi, 0.00)) total_ipi,'+
           ' SUM(COALESCE(oc.vlr_despesas, 0.00)) total_despesas,'+
           ' SUM(COALESCE(oc.vlr_st, 0.00)) total_st,'+
           ' SUM(COALESCE(oc.vlr_frete, 0.00)) total_frete,'+
           ' SUM(COALESCE(oc.vlr_icms, 0.00)) total_icms,'+
           ' SUM(COALESCE(oc.vlr_repasse, 0.00)) total_repasse,'+
           ' SUM(CASE'+
           '        WHEN oc.qtd_transf = 0 THEN'+
           '          COALESCE(oc.vlr_tot_compra, 0.00)'+
           '        ELSE'+
           '          0'+
           ' END) total_ocs,'+
           ' SUM(COALESCE(oc.vlr_tot_compra, 0.00)) total_oc,'+
           ' SUM(COALESCE(oc.vlr_tot_venda, 0.00)) total_venda,'+
           ' oc.num_documento,'+
           ' oc.num_oc_gerada,'+
           ' CAST(oc.dta_oc_gerada AS DATE) dta_oc_gerada,'+
           ' oc.cod_comprovante_icms,'+
           ' COUNT(oc.cod_item) total_itens,'+
           ' SUM(COALESCE(oc.qtd_acomprar, 0)) total_qtd,'+
           ' SUM(COALESCE(oc.qtd_transf, 0)) total_qtd_transf,'+
           ' SUM(CASE'+
           '        WHEN oc.qtd_acomprar > 0 THEN'+
           '          1'+
           '        ELSE'+
           '          0'+
           ' END) total_itens_acomprar'+

           ' FROM OC_COMPRAR oc, EMP_CONEXOES em, OC_COMPRAR_DOCS dc'+

           ' WHERE oc.cod_empresa = em.cod_filial'+
           ' AND   oc.num_documento = dc.num_docto'+
           ' AND   CAST(oc.dta_documento AS DATE) = dc.dta_docto'+
           ' AND   oc.cod_comprador = dc.cod_comprador'+
           ' AND   dc.origem<>'+QuotedStr('Linx')+
           ' AND   oc.num_documento='+sNrDoc+

           ' GROUP BY tipo, oc.cod_empresa, oc.des_empresa, em.cod_linx,'+
           '          oc.ind_oc_gerada, oc.cod_fornecedor, oc.des_fornecedor,'+
           '          oc.num_documento, oc.num_oc_gerada, CAST(oc.dta_oc_gerada AS DATE),'+
           '          oc.cod_comprovante_icms'+
           ' ORDER BY oc.cod_empresa, oc.des_fornecedor, oc.num_oc_gerada';
    DMBelShop.CDS_AComprarOCs.Close;
    DMBelShop.SDS_AComprarOCs.CommandText:=MySql;
    DMBelShop.CDS_AComprarOCs.Open;

    EdtGeraOCTotalGeral.Value:=DMBelShop.CDS_AComprarOCsTOTALGERAL.AsVariant;
  End; // If EdtGeraOCBuscaDocto.Value<>0 Then

End; // Busca Totais das OCs >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Calcula Totais do Item da Ordem de Compra >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CalculaTotaisOC(IBQComprar: TIBQuery);
Begin
  IBQComprar.FieldByName('VLR_BRUTO').AsCurrency:=
                                  IBQComprar.FieldByName('QTD_ACOMPRAR').AsCurrency*
                                IBQComprar.FieldByName('VLR_UNI_COMPRA').AsCurrency;

  IBQComprar.FieldByName('VLR_DESCONTOS').AsCurrency:=0;
  If IBQComprar.FieldByName('PER_DESCONTO').AsCurrency<>0 Then
  Begin
    IBQComprar.FieldByName('VLR_DESCONTOS').AsCurrency:=
                                    (IBQComprar.FieldByName('VLR_BRUTO').AsCurrency*
                           (IBQComprar.FieldByName('PER_DESCONTO').AsCurrency/100));
    IBQComprar.FieldByName('VLR_BRUTO').AsCurrency:=
                                    (IBQComprar.FieldByName('VLR_BRUTO').AsCurrency*
                       (1-(IBQComprar.FieldByName('PER_DESCONTO').AsCurrency/100)));
  End; // If IBQComprar.FieldByName('PER_DESCONTO').AsCurrency<>0 Then

  IBQComprar.FieldByName('VLR_BASE_ICMS').AsCurrency:=
                                     IBQComprar.FieldByName('VLR_BRUTO').AsCurrency;

  IBQComprar.FieldByName('VLR_ICMS').AsCurrency:=0;
  If IBQComprar.FieldByName('PER_ICMS').AsCurrency<>0 Then
   IBQComprar.FieldByName('VLR_ICMS').AsCurrency:=Roundto(
                                (IBQComprar.FieldByName('VLR_BASE_ICMS').AsCurrency*
                              IBQComprar.FieldByName('PER_ICMS').AsCurrency)/100,-2);

  IBQComprar.FieldByName('VLR_IPI').AsCurrency:=0;
  If IBQComprar.FieldByName('PER_IPI').AsCurrency<>0 Then
   IBQComprar.FieldByName('VLR_IPI').AsCurrency:=Roundto(
                                    (IBQComprar.FieldByName('VLR_BRUTO').AsCurrency*
                              IBQComprar.FieldByName('PER_IPI').AsCurrency)/100,-2);

  If IBQComprar.FieldByName('PER_MARGEM_ST').AsCurrency=0 Then
   IBQComprar.FieldByName('VLR_BASE_ST').AsCurrency:=
                                      IBQComprar.FieldByName('VLR_BRUTO').AsCurrency
  Else
   IBQComprar.FieldByName('VLR_BASE_ST').AsCurrency:=
                                     IBQComprar.FieldByName('VLR_BRUTO').AsCurrency+
                          (Roundto(((IBQComprar.FieldByName('VLR_BRUTO').AsCurrency*
                      IBQComprar.FieldByName('PER_MARGEM_ST').AsCurrency)/100),-2));

  IBQComprar.FieldByName('VLR_ST').AsCurrency:=(Roundto(
                                 ((IBQComprar.FieldByName('VLR_BASE_ST').AsCurrency*
                              IBQComprar.FieldByName('PER_ST').AsCurrency)/100),-2)-
                                     IBQComprar.FieldByName('VLR_ICMS').AsCurrency);
  IBQComprar.FieldByName('VLR_TOT_COMPRA').AsCurrency:=
                                     IBQComprar.FieldByName('VLR_BRUTO').AsCurrency+
                                        IBQComprar.FieldByName('VLR_ST').AsCurrency+
                                       IBQComprar.FieldByName('VLR_IPI').AsCurrency;
  IBQComprar.Post;

End; // Calcula Totais do Item da Ordem de Compra >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Altera Quantidade ou Preo Unitrio a Comparar >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AlteraAComprar(IBQComprar: TIBQuery; sQual, sNumDoc, sDtaDocto: String);
Var
  sValorNew, sValorOld: String;
  s, sCodEmp, sNumSeq: String;
  MySql: String;

  bLinx: Boolean;
Begin

  // Q  = Quantidade
  // P  = Preco Unitrio
  // DI = Percentual de Desconto Individual
  // DM = Percentual de Desconto no Mix

  // Verifica se  Linx Puro ===================================================
  MySql:=' SELECT d.origem'+
         ' FROM OC_COMPRAR_DOCS d'+
         ' WHERE d.num_docto='+sNumDoc+
         ' AND   d.dta_docto='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)));
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;
  bLinx:=(DMBelShop.CDS_BuscaRapida.FieldByName('origem').AsString='Linx');
  DMBelShop.CDS_BuscaRapida.Close;

  sCodEmp:=IBQComprar.FieldByName('COD_EMPRESA').AsString;
  sNumSeq:=IBQComprar.FieldByName('NUM_SEQ').AsString;

  If IBQComprar.FieldByName('IND_OC_GERADA').AsString='S' Then
  Begin
    If Trim(sgCodLojaUnica)='' Then
     Begin
       If IBQComprar.FieldByName('NUM_OC_GERADA').AsInteger<1000000 Then
        sgMensagem:='Ordem de Compra J Gerada !!'
       Else
        sgMensagem:='Romaneiro de Separao J Gerado !!';

       msg(sgMensagem+cr+cr+'Numero: '+IBQComprar.FieldByName('NUM_OC_GERADA').AsString+' de '+
                                       IBQComprar.FieldByName('DTA_OC_GERADA').AsString,'A');
     End
    Else
     Begin
       msg('Impossvel Alterar !!'+cr+cr+'Produto J Transferido para a MATRIZ !!','A');
     End;

    // Busca Totais das OCs ====================================================
    If Not bLinx Then
     Begin
       If sgCodLojaUnica='' Then
        TotaisOC(sNumDoc)
       Else
        FrmGeraPedidosComprasLojas.TotaisOC;
     End
    Else
     Begin
       FrmOCLinx.TotaisOCLinx(sNumDoc)
     End; // If Not bLinx Then

    Exit;
  End; // If IBQComprar.FieldByName('IND_OC_GERADA').AsString='S' Then

  // Preco Unitario Individual --------------------------------------
  If sQual='P' Then
  Begin
    sValorNew:=IBQComprar.FieldByName('VLR_UNI_COMPRA').AsString;
    sValorOld:=IBQComprar.FieldByName('VLR_UNI_COMPRA').AsString;
    s:='Novo Preo Unitrio do Produto...'
  End;

  // Percentual de Desconto Individual ------------------------------
  If sQual='DI' Then
  Begin
    sValorNew:=IBQComprar.FieldByName('PER_DESCONTO').AsString;
    sValorOld:=IBQComprar.FieldByName('PER_DESCONTO').AsString;
    s:='Percentual de Desconto do Produto...'
  End;

  // Percentual de Desconto para o Mix ------------------------------
  If sQual='DM' Then
  Begin
    If msg('Deseja Realmente Informar o DESCONTO'+cr+cr+'Para TODOS os Produtos','C')=2 Then
     Exit;

    sValorNew:=IBQComprar.FieldByName('PER_DESCONTO').AsString;
    sValorOld:=IBQComprar.FieldByName('PER_DESCONTO').AsString;
    s:='Percentual de Desconto Para o Mix...'
  End;

  // Calcular Somente Quantidade ===============================================
  If sQual='Q' Then
  Begin
    DecimalSeparator:='.';
    MySql:='  UpDate OC_COMPRAR oc'+
           ' Set oc.VLR_DESCONTOS=((oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)*(oc.PER_DESCONTO/100))'+
           ', oc.VLR_BRUTO=(oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)-oc.VLR_DESCONTOS'+
           ', oc.VLR_BASE_ICMS=oc.VLR_BRUTO'+
           ', oc.VLR_ICMS=Cast(((oc.VLR_BASE_ICMS*oc.PER_ICMS)/100) as Numeric(12,2))'+
           ', oc.VLR_IPI=Cast(((oc.VLR_BRUTO*oc.PER_IPI)/100) as Numeric(12,2))'+
           ', oc.VLR_BASE_ST=oc.VLR_BRUTO+(Cast(((oc.VLR_BRUTO*oc.PER_MARGEM_ST)/100) as Numeric(12,2)))'+
           ', oc.VLR_ST=(Cast(((oc.VLR_BASE_ST*oc.PER_ST)/100) as Numeric(12,2))-oc.VLR_ICMS)'+
           ', oc.VLR_TOT_COMPRA=oc.VLR_BRUTO+oc.VLR_ST+oc.VLR_IPI'+
           ', oc.VLR_TOT_VENDA=oc.QTD_ACOMPRAR*oc.VLR_UNI_VENDA'+

           ' Where oc.Ind_OC_Gerada=''N'''+
           ' And   oc.Num_Documento='+QuotedStr(sNumDoc)+
           ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)))+
           ' And   oc.Cod_Item='+QuotedStr(IBQComprar.FieldByName('COD_ITEM').AsString);
    DMBelShop.IBQ_Executa.Close;
    DMBelShop.IBQ_Executa.SQL.Clear;
    DMBelShop.IBQ_Executa.SQL.Add(MySql);
    DMBelShop.IBQ_Executa.ExecSQL;

    DMBelShop.IBT_BelShop.CommitRetaining;
    DecimalSeparator:=',';

    // Reabre IBQ_AComprar =====================================================
    IBQComprar.DisableControls;
    IBQComprar.Close;
    IBQComprar.Open;

    IBQComprar.Locate('Num_Seq', sNumSeq,[]);

    IBQComprar.EnableControls;

    // Busca Totais das OCs ====================================================
    If Not bLinx Then
     Begin
       If sgCodLojaUnica='' Then
        TotaisOC(sNumDoc)
       Else
        FrmGeraPedidosComprasLojas.TotaisOC;
     End
    Else
     Begin
       FrmOCLinx.TotaisOCLinx(sNumDoc)
     End; // If Not bLinx Then

    Exit;
  End; // If sQual='Q' Then

  // Solicita Preo e Descontos ================================================
  If InputQuery(s,'',sValorNew) then
  Begin
    Try
      StrToCurr(sValorNew);

      If (sQual='P') and (StrToCurr(sValorNew)=0) Then
      Begin
        msg('Preo Unitrio Invlido !!','A');
        Dbg_GeraOCGrid.SelectedIndex:=0;
        Dbg_GeraOCGrid.SelectedIndex:=3;
        Dbg_GeraOCGrid.SetFocus;
        Exit;
      End;

      If ((sQual='DI') or (sQual='DM')) and ((StrToCurr(sValorNew)>100) Or (StrToCurr(sValorNew)<0) )Then
      Begin
        msg('Percentual de Desconto Invlido !!','A');
        Dbg_GeraOCGrid.SelectedIndex:=0;
        Dbg_GeraOCGrid.SelectedIndex:=3;
        Dbg_GeraOCGrid.SetFocus;
        Exit;
      End;

      // Preco Unitrio --------------------------------
      If sQual='P' Then
      Begin
        DecimalSeparator:='.';
        MySql:=' UpDate OC_COMPRAR oc'+
               ' Set oc.Vlr_Uni_Compra='+QuotedStr(f_Troca(',','.',sValorNew))+
               ', oc.VLR_DESCONTOS=((oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)*(oc.PER_DESCONTO/100))'+
               ', oc.VLR_BRUTO=(oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)-oc.VLR_DESCONTOS'+
               ', oc.VLR_BASE_ICMS=oc.VLR_BRUTO'+
               ', oc.VLR_ICMS=Cast(((oc.VLR_BASE_ICMS*oc.PER_ICMS)/100) as Numeric(12,2))'+
               ', oc.VLR_IPI=Cast(((oc.VLR_BRUTO*oc.PER_IPI)/100) as Numeric(12,2))'+
               ', oc.VLR_BASE_ST=oc.VLR_BRUTO+(Cast(((oc.VLR_BRUTO*oc.PER_MARGEM_ST)/100) as Numeric(12,2)))'+
               ', oc.VLR_ST=(Cast(((oc.VLR_BASE_ST*oc.PER_ST)/100) as Numeric(12,2))-oc.VLR_ICMS)'+
               ', oc.VLR_TOT_COMPRA=oc.VLR_BRUTO+oc.VLR_ST+oc.VLR_IPI'+

               ', oc.BLOB_TEXTO=oc.BLOB_TEXTO||ascii_char(13)||'+
                   QuotedStr('Aberturta do Aplicativo: '+sgDataHoraAplicativo)+
                             '|| ascii_char(13) ||'+
                             QuotedStr('Alterado em: '+DateTimeToStr(
                             DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+
                             ' por '+Des_Usuario+
                             ' - Preo Anterior: '+sValorOld+
                             ' - Preo Atual: '+sValorNew)+

               ' Where oc.Ind_OC_Gerada=''N'''+
               ' And   oc.Num_Documento='+QuotedStr(sNumDoc)+
               ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)))+
               ' And   oc.Cod_Item='+QuotedStr(IBQComprar.FieldByName('COD_ITEM').AsString);
        DMBelShop.IBQ_Executa.Close;
        DMBelShop.IBQ_Executa.SQL.Clear;
        DMBelShop.IBQ_Executa.SQL.Add(MySql);
        DMBelShop.IBQ_Executa.ExecSQL;

        DMBelShop.IBT_BelShop.CommitRetaining;

        DecimalSeparator:=',';
      End; // If sQual='P' Then

      // Percentual de Desconto Individual ------------------------
      If sQual='DI' Then
      Begin
        DecimalSeparator:='.';
        MySql:=' UpDate OC_COMPRAR oc'+
               ' Set oc.Per_Desconto='+QuotedStr(f_Troca(',','.',sValorNew))+
               ', oc.VLR_DESCONTOS=((oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)*(oc.PER_DESCONTO/100))'+
               ', oc.VLR_BRUTO=(oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)-oc.VLR_DESCONTOS'+
               ', oc.VLR_BASE_ICMS=oc.VLR_BRUTO'+
               ', oc.VLR_ICMS=Cast(((oc.VLR_BASE_ICMS*oc.PER_ICMS)/100) as Numeric(12,2))'+
               ', oc.VLR_IPI=Cast(((oc.VLR_BRUTO*oc.PER_IPI)/100) as Numeric(12,2))'+
               ', oc.VLR_BASE_ST=oc.VLR_BRUTO+(Cast(((oc.VLR_BRUTO*oc.PER_MARGEM_ST)/100) as Numeric(12,2)))'+
               ', oc.VLR_ST=(Cast(((oc.VLR_BASE_ST*oc.PER_ST)/100) as Numeric(12,2))-oc.VLR_ICMS)'+
               ', oc.VLR_TOT_COMPRA=oc.VLR_BRUTO+oc.VLR_ST+oc.VLR_IPI'+

               ', oc.BLOB_TEXTO=oc.BLOB_TEXTO||ascii_char(13)||'+
                   QuotedStr('Aberturta do Aplicativo: '+sgDataHoraAplicativo)+
                             '|| ascii_char(13) ||'+
                             QuotedStr('Alterado em: '+DateTimeToStr(
                             DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+
                             ' por '+Des_Usuario+
                             ' - Desconto Anterior: '+sValorOld+
                             ' - Desconto Atual: '+sValorNew)+

               ' Where oc.Ind_OC_Gerada=''N'''+
               ' And   oc.qtd_transf=0'+
               ' And   oc.Num_Documento='+QuotedStr(sNumDoc)+
               ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)))+
               ' And   oc.Cod_Item='+QuotedStr(IBQComprar.FieldByName('COD_ITEM').AsString);
        DMBelShop.IBQ_Executa.Close;
        DMBelShop.IBQ_Executa.SQL.Clear;
        DMBelShop.IBQ_Executa.SQL.Add(MySql);
        DMBelShop.IBQ_Executa.ExecSQL;

        DMBelShop.IBT_BelShop.CommitRetaining;
        DecimalSeparator:=',';
      End; // If sQual='DI' Then

      // Percentual de Desconto Mix ------------------------
      If sQual='DM' Then
      Begin
        DecimalSeparator:='.';
        MySql:=' UpDate OC_COMPRAR oc'+
               ' Set oc.Per_Desconto='+QuotedStr(f_Troca(',','.',sValorNew))+
               ', oc.VLR_DESCONTOS=((oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)*(oc.PER_DESCONTO/100))'+
               ', oc.VLR_BRUTO=(oc.QTD_ACOMPRAR*oc.VLR_UNI_COMPRA)-oc.VLR_DESCONTOS'+
               ', oc.VLR_BASE_ICMS=oc.VLR_BRUTO'+
               ', oc.VLR_ICMS=Cast(((oc.VLR_BASE_ICMS*oc.PER_ICMS)/100) as Numeric(12,2))'+
               ', oc.VLR_IPI=Cast(((oc.VLR_BRUTO*oc.PER_IPI)/100) as Numeric(12,2))'+
               ', oc.VLR_BASE_ST=oc.VLR_BRUTO+(Cast(((oc.VLR_BRUTO*oc.PER_MARGEM_ST)/100) as Numeric(12,2)))'+
               ', oc.VLR_ST=(Cast(((oc.VLR_BASE_ST*oc.PER_ST)/100) as Numeric(12,2))-oc.VLR_ICMS)'+
               ', oc.VLR_TOT_COMPRA=oc.VLR_BRUTO+oc.VLR_ST+oc.VLR_IPI'+

               ', oc.BLOB_TEXTO=oc.BLOB_TEXTO||ascii_char(13)||'+
                   QuotedStr('Aberturta do Aplicativo: '+sgDataHoraAplicativo)+
                             '|| ascii_char(13) ||'+
                             QuotedStr('Alterado em: '+DateTimeToStr(
                             DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+
                             ' por '+Des_Usuario+
                             ' - Desconto (MIX) Anterior: '+sValorOld+
                             ' - Desconto (MIX) Atual: '+sValorNew)+

               ' Where oc.Ind_OC_Gerada=''N'''+
               ' And   oc.qtd_transf=0'+
               ' And   oc.Num_Documento='+QuotedStr(sNumDoc)+
               ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)));
        DMBelShop.IBQ_Executa.Close;
        DMBelShop.IBQ_Executa.SQL.Clear;
        DMBelShop.IBQ_Executa.SQL.Add(MySql);
        DMBelShop.IBQ_Executa.ExecSQL;

        DMBelShop.IBT_BelShop.CommitRetaining;
        DecimalSeparator:=',';
      End; // If sQual='DM' Then

      // Reabre IBQ_Comprar ====================================================
      IBQComprar.DisableControls;
      IBQComprar.Close;
      IBQComprar.Open;
      IBQComprar.Locate('Num_Seq', sNumSeq,[]);
      IBQComprar.EnableControls;

      // Busca Totais das OCs ==================================================
      If Not bLinx Then
       Begin
         If sgCodLojaUnica='' Then
          TotaisOC(sNumDoc)
         Else
          FrmGeraPedidosComprasLojas.TotaisOC;
       End
      Else
       Begin
         FrmOCLinx.TotaisOCLinx(sNumDoc)
       End; // If Not bLinx Then

    Except
      msg('Valor Invlido !!','A');
    End;
  End; // If InputQuery('Informe a Quantidade a COMPRAR...','',sQtdComprar) then

End; // Altera Quantidade ou Preo Unitrio a Comparar >>>>>>>>>>>>>>>>>>>>>>>>>

// Acerta Nome dos Meses de Demandas no Grid >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.NomeMesesGrid;
Var
  i: Integer;
  MySql: String;
Begin
  MySql:=' SELECT om.*'+
         ' FROM OC_COMPRAR_MESES om, OC_COMPRAR_DOCS od'+
         ' WHERE om.num_documento=od.num_docto'+
         ' AND   od.origem<>'+QuotedStr('Linx')+
         ' AND   om.num_documento='+VarToStr(EdtGeraOCBuscaDocto.Value);
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  For i:=0 to Dbg_GeraOCGrid.Columns.Count-1 do
  Begin

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES1' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes1').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes1').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes1').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes1').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES1' Then

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES2' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes2').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes2').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes2').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes2').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES2' Then

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES3' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes3').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes3').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes3').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes3').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES3' Then

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES4' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes4').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes4').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes4').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes4').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES4' Then

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES5' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes5').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes5').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes5').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes5').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES5' Then

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES6' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes6').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes6').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes6').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes6').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES6' Then

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES7' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes7').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes7').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes7').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes7').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES7' Then

    If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES8' Then
    Begin
      If Trim(DMBelShop.CDS_Busca.FieldByName('Mes8').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=False;
       End
      Else // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes8').AsString)='' Then
       Begin
         Dbg_GeraOCGrid.Columns[i].Visible:=True;
         Dbg_GeraOCGrid.Columns[i].Title.Caption:=DMBelShop.CDS_Busca.FieldByName('Mes8').AsString;
       End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Mes8').AsString)='' Then
    End; // If Dbg_GeraOCGrid.Columns[i].FieldName='QTD_DEM_MES8' Then

  End; // For i:=0 to Dbg_GeraOCGrid.Columns.Count-1 do
  DMBelShop.CDS_Busca.Close;

End; // Acerta Nome dos Meses de Demandas no Grid >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Monta Select para Filial >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.MontaSelectFilial(Var IBQ: TIBQuery);
Begin
  // Curva ABC dos Produtos por Mix de Loja ------------------------------------
  If Rb_CalculoTpCurvaABCMix.Checked Then
  Begin
    BuscaMixLoja(sCodFilial);

    If Trim(sgCurvas)='' Then
     sgCurvas:=QuotedStr('A')+', '+QuotedStr('B')+', '+QuotedStr('C')+', '+
               QuotedStr('D')+', '+QuotedStr('E');
  End;

  // Monta Sql Busca na Loja (Conexo Remoto)
  If (Rb_CalculoTpProcLoja.Checked) And (igCodLojaLinx=0) Then
  Begin
    IBQ.Close;
    IBQ.SQL.Clear;
    IBQ.SQL.Add('select p.codproduto from produto p where p.codproduto=''009582''');
    IBQ.Open;

    // Monta Select para Filiais =================================================
    MySqlSelect:='SELECT'+
                 ' Coalesce(es.codfilial, '+QuotedStr(':pCodFilial')+') COD_EMPRESA,'+
                 ' pr.codproduto, pr.datainclusao, pr.dataalteracao,'+
                 ' Coalesce(es.customedio,0) customedio,'+
                 ' Coalesce(es.saldoatual,0) Qtd_Saldo';

    MySqlClausula1:=' FROM produto pr'+
                    '                 left join estoque es  on pr.codproduto=es.codproduto'+
                    '                                      and Cast(es.codfilial as integer)=:pCodFilial'+

                    '                 left join gruposub gs on pr.codgruposub=gs.codgruposub'+
                    '                 left join grupo gr    on gr.codgrupo=gs.codgrupo';

                    If Not Ckb_FiltroProdNaoCompra.Checked Then
                     MySqlClausula2:=' WHERE Coalesce(pr.situacaopro,0)=0'
                    Else
                     MySqlClausula2:=' WHERE Coalesce(pr.situacaopro,0) in (0,3)';

                    // Produtos Codigos e/ou Produtos Like ---------------------
                    If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                     MySqlClausula2:=
                      MySqlClausula2+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
                    Else If Trim(sgProdutos)<>'' Then
                     MySqlClausula2:=
                      MySqlClausula2+' and pr.CodProduto in ('+sgProdutos+')'
                    Else If Trim(sgLikeProdutos)<>'' Then
                     MySqlClausula2:=
                      MySqlClausula2+' AND '+sgLikeProdutos;

                    // Fornecedores -------------------------------------
                    If Trim(sgFornecedores)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.principalfor in ('+sgFornecedores+')'
                    Else
                     MySqlClausula2:=MySqlClausula2+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

                    // Grupos e SubGrupos -------------------------------
                    If Trim(sgGrupos)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and '+sgGrupos;

                    // Aplicacoes ---------------------------------------
                    If Trim(sgAplicacoes)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.CodAplicacao in ('+sgAplicacoes+')';

                    // Familias Preos ----------------------------------
                    If Trim(sgFamiliaPrecos)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.CodFamiliaPreco in ('+sgFamiliaPrecos+')';

                    // Grupos ST ----------------------------------------
                    If Trim(sgGruposST)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.grupostmva in ('+sgGruposST+')';

                    MySqlOrderGrup:=' Order by pr.codproduto';
    IBQ.Close;
    IBQ.SQL.Clear;
    IBQ.SQL.Add(MySqlSelect+MySqlClausula1+MySqlClausula2+MySqlOrderGrup);
  End; // If (Rb_CalculoTpProcLoja.Checked) And (igCodLojaLinx=0) Then // Monta Sql Busca na Loja (Conexo Remoto)

  // Monta Sql Busca da Loja LOCAL (Conexo Local)
  If (Rb_CalculoTpProcLocal.Checked) Or ((Rb_CalculoTpProcLoja.Checked) And (igCodLojaLinx<>0)) Then
  Begin
    // Monta Select para Filiais =================================================
    MySqlSelect:='SELECT'+
                 ' Coalesce(es.codfilial, '+QuotedStr(':pCodFilial')+') COD_EMPRESA,'+
                 ' pr.codproduto, pr.datainclusao, pr.dataalteracao,'+
                 ' Coalesce(es.customedio,0) customedio,'+
                 ' Coalesce(es.saldoatual,0) Qtd_Saldo';

    MySqlClausula1:=' FROM produto pr'+
                    '         left join estoque es  on pr.codproduto=es.codproduto'+
                    '                              and Cast(es.codfilial as integer)=:pCodFilial';

                    If Not Ckb_FiltroProdNaoCompra.Checked Then
                     MySqlClausula2:=' WHERE Coalesce(pr.situacaopro,0)=0'
                    Else
                     MySqlClausula2:=' WHERE Coalesce(pr.situacaopro,0) in (0,3)';

                    // Produtos Codigos e/ou Produtos Like ---------------------
                    If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                     MySqlClausula2:=
                      MySqlClausula2+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
                    Else If Trim(sgProdutos)<>'' Then
                     MySqlClausula2:=
                      MySqlClausula2+' and pr.CodProduto in ('+sgProdutos+')'
                    Else If Trim(sgLikeProdutos)<>'' Then
                     MySqlClausula2:=
                      MySqlClausula2+' AND '+sgLikeProdutos;

                    // Fornecedores -------------------------------------
                    If Trim(sgFornecedores)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.principalfor in ('+sgFornecedores+')'
                    Else
                     MySqlClausula2:=MySqlClausula2+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

                    // Grupos e SubGrupos -------------------------------
                    If Trim(sgGrupos)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and '+f_Troca('gr.', 'pr.',sgGrupos);

                    // Aplicacoes ---------------------------------------
                    If Trim(sgAplicacoes)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.CodAplicacao in ('+sgAplicacoes+')';

                    // Familias Preos ----------------------------------
                    If Trim(sgFamiliaPrecos)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.CodFamiliaPreco in ('+sgFamiliaPrecos+')';

                    // Grupos ST ----------------------------------------
                    If Trim(sgGruposST)<>'' Then
                     MySqlClausula2:=MySqlClausula2+' and pr.grupostmva in ('+sgGruposST+')';

                    MySqlOrderGrup:=' Order by pr.codproduto';
    IBQ.Close;
    IBQ.SQL.Clear;
    IBQ.SQL.Add(MySqlSelect+MySqlClausula1+MySqlClausula2+MySqlOrderGrup);
  End; // If Rb_CalculoTpProcLocal.Checked Then // Monta Sql Busca da Loja LOCAL (Conexo Local)

End; // Monta Select para Filial >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Calculo e Analise Produtos Filiais >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CalculaFilial;
Var
  bSiga: Boolean;
  b, bMesmoItem: Boolean;
  i: Integer;
  MySql: String;
  cDemanda: Currency;
Begin
  // Apresentacao ==========================================================
  OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sCodFilial+' - '+
                             DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Conecta Empresa =======================================================
  If ConexaoEmpIndividual('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'A') Then
   Begin
     bSiga:=True;
   End
  Else
   Begin
     If sgLojasNConectadas='' Then
      sgLojasNConectadas:='Bel_'+sCodFilial
     Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sCodFilial) then
      sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sCodFilial;

     bSiga:=False;
   End; // If ConexaoEmpIndividual('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'A') Then

  // Inicia Processamento ==================================================
  If bSiga Then
  Begin
    // Cria Query da Empresa ------------------------------------
    CriaQueryIB('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                IBQ_ConsultaFilial, False, True);

    // Apropria Parametros da Filial ----------------------------
    IBQ_ConsultaFilial.Params.ParamByName('pCodFilial').Value:=StrToInt(sCodFilial);

    // Busca Itens da Filial  -----------------------------------
    i:=0;
    bSiga:=False;
    While Not bSiga do
    Begin
      Try
        IBQ_ConsultaFilial.Open;
        bSiga:=True;
      Except
        Inc(i);
      End; // Try

      If i>10 Then
      Begin
        If sgLojasNConectadas='' Then
         sgLojasNConectadas:='Bel_'+sCodFilial
        Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sCodFilial) then
         sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sCodFilial;

        Break;
      End; // If i>10 Then
    End; // While Not bSiga do

    // Processamento  -------------------------------------------
    If bSiga Then
    Begin
      // Busca Curvas Selecionadas e Estoque Minino Produtos
      MySql:=' SELECT c.cod_loja, c.cod_produto, c.ind_curva,'+
             ' p.datainclusao, c.est_minimo,'+
             ' CASE'+
             '   When (c.ind_curva in ('+sgCurvas+') or (p.datainclusao>='+QuotedStr(sgDtaInicio)+')) Then'+
             '    ''SIM'''+
             '   Else'+
             '    ''NAO'''+
             ' END Usar_Curva,'+
             ' COALESCE(T.vlr_aux,0) Dias_Estocagem'+

             ' FROM ES_FINAN_CURVA_ABC c'+
             '        LEFT JOIN PRODUTO p      ON c.cod_produto=p.codproduto'+
             '        LEFT JOIN TAB_AUXILIAR t ON CASE'+
             '                                       WHEN c.ind_curva=''A'' THEN 1'+
             '                                       WHEN c.ind_curva=''B'' THEN 2'+
             '                                       WHEN c.ind_curva=''C'' THEN 3'+
             '                                       WHEN c.ind_curva=''D'' THEN 4'+
             '                                       WHEN c.ind_curva=''E'' THEN 5'+
             '                                    END=t.cod_aux'+

// Retira Conforme Solicitao da ANNA - 12/05/2017
//             ' WHERE c.est_minimo>0'+
             ' WHERE   t.tip_aux=2'+
             ' AND   c.cod_loja='+QuotedStr(sCodFilial);

             // Produtos No Compra -------------------------------------
             If Not Ckb_FiltroProdNaoCompra.Checked Then
              MySql:=
               MySql+' AND Coalesce(p.situacaopro,0)=0'
             Else
              MySql:=
               MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';

             // Produtos Codigos e/ou Produtos Like ---------------------
             If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
              MySql:=
               MySql+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.',sgLikeProdutos)+')'
             Else If Trim(sgProdutos)<>'' Then
              MySql:=
               MySql+' and p.CodProduto in ('+sgProdutos+')'
             Else If Trim(sgLikeProdutos)<>'' Then
              MySql:=
               MySql+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

             // Fornecedores --------------------------------------------
             If Trim(sgFornecedores)<>'' Then
              MySql:=
               MySql+' and p.principalfor in ('+sgFornecedores+')'
             Else
              MySql:=
               MySql+' AND p.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

             If bgECommerce Then
              MySql:=
               MySql+' and p.ECOMMERCE_SN='+QuotedStr('S');

      MySql:=
       MySql+' ORDER BY 2';
      DMBelShop.CDS_Join.Close;
      DMBelShop.SDS_Join.CommandText:=MySql;
      DMBelShop.CDS_Join.Open;

      // Monta Demandas ==========================================================
      MontaDemandasNovo(sCodFilial);

      Try
        // Monta Transacao  -------------------------------------
        TD.TransactionID:=Cardinal(FormatDateTime('ddmmyyyy',now)+FormatDateTime('hhnnss',now));
        TD.IsolationLevel:=xilREADCOMMITTED;
        DMBelShop.SQLC.StartTransaction(TD);

        // Inicia Processamento  ----------------------------------
        IBQ_ConsultaFilial.Last;
        iNrRegistros:=IBQ_ConsultaFilial.RecordCount;
        pgProgBar.Properties.Max:=iNrRegistros;
        Edt_OCTotProdutos.Value:=iNrRegistros;
        bgOC_COMPRAR_Docs:=True;
        pgProgBar.Position:=0;

        DMBelShop.IBQ_OC_ComprarAdd.Close;
        DMBelShop.IBQ_OC_ComprarAdd.SQL.Clear;
        DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' Select *');
        DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' From oc_comprar oc');
        DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' Where oc.num_documento<1');
        DMBelShop.IBQ_OC_ComprarAdd.Open;

        IBQ_ConsultaFilial.First;
        While Not IBQ_ConsultaFilial.Eof do
        Begin
          Application.ProcessMessages;
          pgProgBar.Position:=pgProgBar.Position+1;
          Refresh;

          bgProcCurva:=True;

          b:=False;
          While Not b do // Verifica se Existe na Tabela ES_FINAN_CURVA_ABC
          Begin
            If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_ConsultaFilial.FieldByName('CodProduto').AsString,[]) Then
             Begin
               b:=True;

               // Curvas Por Loja ou Por MPMS
               If ((Gb_CalculoTpCurvaABC.Visible) Or (Gb_CalculoApresCurva.Visible)) and (Gb_CalculoApresCurva.Visible) Then
               Begin
                 If (DMBelShop.CDS_Join.FieldByName('Usar_Curva').AsString='NAO') and (Not Ckb_CalculoApresCurvaFora.Checked) Then
                  Begin
                    bgProcCurva:=False;
                  End
                 Else If (DMBelShop.CDS_Join.FieldByName('Usar_Curva').AsString='NAO') and (Ckb_CalculoApresCurvaFora.Checked) Then
                  Begin
                    If (Rb_CalculoApresCurvaEstCom.Checked) and (IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsInteger=0) Then
                     bgProcCurva:=False
                    Else If (Rb_CalculoApresCurvaEstSem.Checked) and (IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsInteger<>0) Then
                     bgProcCurva:=False
                  End;
               End; // If Gb_CalculoTpCurvaABC.Visible Then
             End
            Else // If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_ConsultaFilial.FieldByName('CodProduto').AsString),[]) Then
             Begin
               If (StrToDate(IBQ_ConsultaFilial.FieldByName('DATAINCLUSAO').AsString)>=StrToDate(sgDtaInicio)) Or
                  (StrToDate(IBQ_ConsultaFilial.FieldByName('DATAALTERACAO').AsString)>=StrToDate(sgDtaInicio)) Then
                Begin
                  DMBelShop.CDS_Join.Locate('IND_CURVA','E',[]);
                  MySql:=DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsString;
                  DMBelShop.CDS_Join.Insert;
                  DMBelShop.CDS_Join.FieldByName('COD_LOJA').AsString:=sCodFilial;
                  DMBelShop.CDS_Join.FieldByName('COD_PRODUTO').AsString:=IBQ_ConsultaFilial.FieldByName('CodProduto').AsString;
                  DMBelShop.CDS_Join.FieldByName('IND_CURVA').AsString:='E';
                  DMBelShop.CDS_Join.FieldByName('DATAINCLUSAO').AsString:=IBQ_ConsultaFilial.FieldByName('DATAINCLUSAO').AsString;
                  DMBelShop.CDS_Join.FieldByName('EST_MINIMO').AsString:='3';
                  DMBelShop.CDS_Join.FieldByName('USAR_CURVA').AsString:='SIM';
                  DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsString:=MySql;
                End
               Else // If StrToDate(IBQ_ConsultaFilial.FieldByName('datainclusao').AsString)>=StrToDate(sgDtaInicio) Then
                Begin
                  bgProcCurva:=False;
                  b:=True;
                End;
             End; // If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_ConsultaFilial.FieldByName('CodProduto').AsString,[]) Then
          End; // While Not b do // Verifica se Existe na Tabela ES_FINAN_CURVA_ABC

          // Busca o Produto Existente na Matriz ----------------
          If bgProcCurva Then
          Begin
            bSiga:=False;
            MySql:=' Select *'+
                   ' From OC_COMPRAR oc'+
                   ' Where oc.num_documento='+sNumDoc+
                   ' And   oc.Cod_Empresa='+QuotedStr(sCodMatriz)+
                   ' And   oc.Cod_Item='+QuotedStr(IBQ_ConsultaFilial.FieldByName('CodProduto').AsString)+
                   ' AND   EXISTS (SELECT 1'+
                   '               FROM OC_COMPRAR_DOCS d'+
                   '               WHERE d.num_docto=oc.num_documento'+
                   '               AND   d.origem<>'+QuotedStr('Linx')+')';
            DMBelShop.CDS_Busca.Close;
            DMBelShop.SDS_Busca.CommandText:=MySql;
            DMBelShop.CDS_Busca.Open;

            If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Item').AsString)<>'' Then
             bSiga:=True;

            // Se Produto Existe na Matriz Processa ---------------
            If bSiga Then
            Begin
              bMesmoItem:=False;
              Inc(iNumSeqDoc);

              // Inicializa Variaveis de Demanda ---------------------------------------
              igNrDias:=0;
              igNrMeses:=0;
              igTotMeses:=igTotMeses;
              cgOutras_Demandas:=0;
              cgTotal_Demandas:=0;

              // Demandas da Filial ------------------------------------------------------
              bgDemandaNovo:=True;
              BuscaDemanda(CB_Mes1, ME_Ano1, IBQ_ConsultaFilial.FieldByName('CodProduto').AsString,
                           sCodFilial, cDemanda, igNrDias, igNrMeses, True);
              bgDemandaNovo:=False;

              // Processa Filial ------------------------------------
              If Not OCProcessaFilial Then
               Break;

              DMBelShop.CDS_Busca.Close;
            End; // If bSiga Then
          End; // If bgProcCurva Then

          IBQ_ConsultaFilial.Next;
        End; // While Not IBQ_ConsultaFilial.Eof do

        Try
          DMBelShop.CDS_Join.Close;
          DMBelShop.CDS_Busca.Close;
          DMBelShop.IBQ_OC_ComprarAdd.Close;
          IBQ_ConsultaFilial.Close;
        Except
        End;

        // Atualiza OC_COMPRAR_DOCS ========================================
        If bgOC_COMPRAR_Docs Then
        Begin
          OC_COMPRAR_DOCS('I', sNumDoc, 'BelShop');
          bgOC_COMPRAR_Docs:=False;
        End;

        OdirPanApres.Visible:=False;
        DMBelShop.SQLC.Commit(TD);
      Except
        on e : Exception do
        Begin
          DMBelShop.SQLC.Rollback(TD);

          DMBelShop.CDS_Join.Close;
          DMBelShop.CDS_Busca.Close;
          DMBelShop.IBQ_OC_ComprarAdd.Close;
          IBQ_ConsultaFilial.Close;

          OdirPanApres.Visible:=False;

          If sgLojasNConectadas='' Then
           sgLojasNConectadas:='Bel_'+sCodFilial
          Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sCodFilial) then
           sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sCodFilial;
        End;
      End; // Try
    End; // If bSiga Then
    Lb_EmpProcessadas.Caption:=IntToStr(StrToInt(Lb_EmpProcessadas.Caption)+1);

    OdirPanApres.Visible:=False;
  End; // If bSiga Then

  // Fecha Conexo ------------------------------------------------
  ConexaoEmpIndividual('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'F');
  DMBelShop.CDS_Join.Close;

End; // Calculo e Analise Produtos Filiais >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Calculo e Analise Produtos Lojas - LOCAL >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CalculaFilialLocal;
Var
  bSiga: Boolean;
  b, bMesmoItem: Boolean;
  i: Integer;
  MySql: String;
  cDemanda: Currency;
Begin

  // Apresentacao ==========================================================
  OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sCodFilial+' - '+DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Inicia Processamento ==================================================
  // Cria Query da Empresa ------------------------------------
  CriaQueryIB('IBDB_BelShop', 'IBT_BelShop',IBQ_ConsultaFilial, True, True);

  // Monta Sql Loja Local -------------------------------------
  MontaSelectFilial(IBQ_ConsultaFilial);

  // Apropria Parametros da Filial ----------------------------
  IBQ_ConsultaFilial.Params.ParamByName('pCodFilial').Value:=StrToInt(sCodFilial);

  // Busca Itens da Filial  -----------------------------------
  i:=0;
  bSiga:=False;
  While Not bSiga do
  Begin
    Try
      IBQ_ConsultaFilial.Open;
      bSiga:=True;
    Except
      on e : Exception do
      Begin
        Inc(i);
      End;
    End; // Try

    If i>10 Then
    Begin
      If sgLojasNConectadas='' Then
       sgLojasNConectadas:='Bel_'+sCodFilial
      Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sCodFilial) then
       sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sCodFilial;

      Break;
    End; // If i>10 Then
  End; // While Not bSiga do

  // Processamento  -------------------------------------------
  If bSiga Then
  Begin
//odiropss
//sgMensagemERRO:='DMBelShop.CDS_Join.';
    // Busca Curvas Selecionadas e Estoque Minino Produtos
    MySql:=' SELECT c.cod_loja, c.cod_produto, c.ind_curva,'+
           ' p.datainclusao, c.est_minimo,'+
           ' CASE'+
           '   When (c.ind_curva in ('+sgCurvas+') or (p.datainclusao>='+QuotedStr(sgDtaInicio)+')) Then'+
           '    ''SIM'''+
           '   Else'+
           '    ''NAO'''+
           ' END Usar_Curva,'+
           ' COALESCE(T.vlr_aux,0) Dias_Estocagem'+

           ' FROM ES_FINAN_CURVA_ABC c'+
           '        LEFT JOIN PRODUTO p      ON c.cod_produto=p.codproduto'+
           '        LEFT JOIN TAB_AUXILIAR t ON CASE'+
           '                                       WHEN c.ind_curva=''A'' THEN 1'+
           '                                       WHEN c.ind_curva=''B'' THEN 2'+
           '                                       WHEN c.ind_curva=''C'' THEN 3'+
           '                                       WHEN c.ind_curva=''D'' THEN 4'+
           '                                       WHEN c.ind_curva=''E'' THEN 5'+
           '                                    END=t.cod_aux'+

// Retira Conforme Solicitao da ANNA - 12/05/2017
//           ' WHERE c.est_minimo>0'+
           ' WHERE t.tip_aux=2'+
           ' AND   c.cod_loja='+QuotedStr(sCodFilial);

           // Produtos No Compra -------------------------------------
           If Not Ckb_FiltroProdNaoCompra.Checked Then
            MySql:=
             MySql+' AND Coalesce(p.situacaopro,0)=0'
           Else
            MySql:=
             MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';

           // Produtos Codigos e/ou Produtos Like ---------------------
           If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
            MySql:=
             MySql+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.',sgLikeProdutos)+')'
           Else If Trim(sgProdutos)<>'' Then
            MySql:=
             MySql+' and p.CodProduto in ('+sgProdutos+')'
           Else If Trim(sgLikeProdutos)<>'' Then
            MySql:=
             MySql+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

           // Fornecedores --------------------------------------------
           If Trim(sgFornecedores)<>'' Then
            MySql:=
             MySql+' and p.principalfor in ('+sgFornecedores+')'
           Else
            MySql:=
             MySql+' AND p.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

           If bgECommerce Then
            MySql:=
             MySql+' and p.ECOMMERCE_SN='+QuotedStr('S');

    MySql:=
     MySql+' ORDER BY 2';
    DMBelShop.CDS_Join.Close;
    DMBelShop.SDS_Join.CommandText:=MySql;
    DMBelShop.CDS_Join.Open;

    // Monta Demandas ==========================================================
//odiropss
//sgMensagemERRO:='DemandaNovo';
    MontaDemandasNovo(sCodFilial);

    Try
      // Monta Transacao  -------------------------------------
      TD.TransactionID:=Cardinal(FormatDateTime('ddmmyyyy',now)+FormatDateTime('hhnnss',now));
      TD.IsolationLevel:=xilREADCOMMITTED;
      DMBelShop.SQLC.StartTransaction(TD);

      // Inicia Processamento  ----------------------------------
      IBQ_ConsultaFilial.Last;
      iNrRegistros:=IBQ_ConsultaFilial.RecordCount;
      pgProgBar.Properties.Max:=iNrRegistros;
      Edt_OCTotProdutos.Value:=iNrRegistros;
      bgOC_COMPRAR_Docs:=True;
      pgProgBar.Position:=0;

//odiropss
//sgMensagemERRO:='DMBelShop.IBQ_OC_ComprarAdd.Open;';
      DMBelShop.IBQ_OC_ComprarAdd.Close;
      DMBelShop.IBQ_OC_ComprarAdd.SQL.Clear;
      DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' Select *');
      DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' From oc_comprar oc');
      DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' Where oc.num_documento<1');
      DMBelShop.IBQ_OC_ComprarAdd.Open;

      IBQ_ConsultaFilial.First;
      While Not IBQ_ConsultaFilial.Eof do
      Begin
        Application.ProcessMessages;
        pgProgBar.Position:=pgProgBar.Position+1;
        Refresh;

        bgProcCurva:=True;

        b:=False;
        While Not b do // Verifica se Existe na Tabela ES_FINAN_CURVA_ABC
        Begin
          If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_ConsultaFilial.FieldByName('CodProduto').AsString,[]) Then
           Begin
             b:=True;

             // Curvas Por Loja ou Por MPMS
             If ((Gb_CalculoTpCurvaABC.Visible) Or (Gb_CalculoApresCurva.Visible)) and (Gb_CalculoApresCurva.Visible) Then
             Begin
               If (DMBelShop.CDS_Join.FieldByName('Usar_Curva').AsString='NAO') and (Not Ckb_CalculoApresCurvaFora.Checked) Then
                Begin
                  bgProcCurva:=False;
                End
               Else If (DMBelShop.CDS_Join.FieldByName('Usar_Curva').AsString='NAO') and (Ckb_CalculoApresCurvaFora.Checked) Then
                Begin
                  If (Rb_CalculoApresCurvaEstCom.Checked) and (IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsInteger=0) Then
                   bgProcCurva:=False
                  Else If (Rb_CalculoApresCurvaEstSem.Checked) and (IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsInteger<>0) Then
                   bgProcCurva:=False
                End;
             End; // If Gb_CalculoTpCurvaABC.Visible Then
           End
          Else // If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_ConsultaFilial.FieldByName('CodProduto').AsString),[]) Then
           Begin
//odiropss
//sgMensagemERRO:='StrToDate(sgDtaInicio)) Or';

             If (StrToDate(IBQ_ConsultaFilial.FieldByName('DATAINCLUSAO').AsString)>=StrToDate(sgDtaInicio)) Or
                (StrToDate(IBQ_ConsultaFilial.FieldByName('DATAALTERACAO').AsString)>=StrToDate(sgDtaInicio)) Then
              Begin
                DMBelShop.CDS_Join.Locate('IND_CURVA','E',[]);
                MySql:=DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsString;
                DMBelShop.CDS_Join.Insert;
                DMBelShop.CDS_Join.FieldByName('COD_LOJA').AsString:=sCodFilial;
                DMBelShop.CDS_Join.FieldByName('COD_PRODUTO').AsString:=IBQ_ConsultaFilial.FieldByName('CodProduto').AsString;
                DMBelShop.CDS_Join.FieldByName('IND_CURVA').AsString:='E';
                DMBelShop.CDS_Join.FieldByName('DATAINCLUSAO').AsString:=IBQ_ConsultaFilial.FieldByName('DATAINCLUSAO').AsString;
                DMBelShop.CDS_Join.FieldByName('EST_MINIMO').AsString:='3';
                DMBelShop.CDS_Join.FieldByName('USAR_CURVA').AsString:='SIM';
                DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsString:=MySql;
              End
             Else // If StrToDate(IBQ_ConsultaFilial.FieldByName('datainclusao').AsString)>=StrToDate(sgDtaInicio) Then
              Begin
                bgProcCurva:=False;
                b:=True;
              End;
           End; // If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_ConsultaFilial.FieldByName('CodProduto').AsString,[]) Then
        End; // While Not b do // Verifica se Existe na Tabela ES_FINAN_CURVA_ABC

        // Busca o Produto Existente na Matriz ----------------
        If bgProcCurva Then
        Begin
          bSiga:=False;
          MySql:=' Select *'+
                 ' From OC_COMPRAR oc'+
                 ' Where oc.num_documento='+sNumDoc+
                 ' And   oc.Cod_Empresa='+QuotedStr(sCodMatriz)+
                 ' And   oc.Cod_Item='+QuotedStr(IBQ_ConsultaFilial.FieldByName('CodProduto').AsString)+
                 ' AND   EXISTS (SELECT 1'+
                 '               FROM OC_COMPRAR_DOCS d'+
                 '               WHERE d.num_docto=oc.num_documento'+
                 '               AND   d.origem<>'+QuotedStr('Linx')+')';
          DMBelShop.CDS_Busca.Close;
          DMBelShop.SDS_Busca.CommandText:=MySql;
          DMBelShop.CDS_Busca.Open;

          If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Item').AsString)<>'' Then
           bSiga:=True;

          // Se Produto Existe na Matriz Processa ---------------
          If bSiga Then
          Begin
            bMesmoItem:=False;
            Inc(iNumSeqDoc);

            // Inicializa Variaveis de Demanda ---------------------------------------
            igNrDias:=0;
            igNrMeses:=0;
            igTotMeses:=igTotMeses;
            cgOutras_Demandas:=0;
            cgTotal_Demandas:=0;

            // Demandas da Filial ------------------------------------------------------
            bgDemandaNovo:=True;
            BuscaDemanda(CB_Mes1, ME_Ano1, IBQ_ConsultaFilial.FieldByName('CodProduto').AsString,
                         sCodFilial, cDemanda, igNrDias, igNrMeses, True);
            bgDemandaNovo:=False;

            // Processa Filial ------------------------------------
//odiropss
//sgMensagemERRO:='OCProcessaFilial';
            If Not OCProcessaFilial Then
             Break;

            DMBelShop.CDS_Busca.Close;
          End; // If bSiga Then
        End; // If bgProcCurva Then

        IBQ_ConsultaFilial.Next;
      End; // While Not IBQ_ConsultaFilial.Eof do

      Try
        DMBelShop.CDS_Join.Close;
        DMBelShop.CDS_Busca.Close;
        DMBelShop.IBQ_OC_ComprarAdd.Close;
        IBQ_ConsultaFilial.Close;
      Except
      End;

      // Atualiza OC_COMPRAR_DOCS ========================================
      If bgOC_COMPRAR_Docs Then
      Begin
        OC_COMPRAR_DOCS('I', sNumDoc, 'BelShop');
        bgOC_COMPRAR_Docs:=False;
      End;

      OdirPanApres.Visible:=False;
      DMBelShop.SQLC.Commit(TD);
    Except
      on e : Exception do
      Begin
        DMBelShop.SQLC.Rollback(TD);

        MessageBox(Handle, pChar(e.message), 'Erro', MB_ICONERROR);
        MessageBox(Handle, pChar('Reg: '+IntToStr(IBQ_ConsultaFilial.RecNo)+#13+
                                 'Loja :'+sCodFilial+#13+
                                 'Prod: '+IBQ_ConsultaFilial.FieldByName('CodProduto').AsString
                                 ), 'Erro', MB_ICONERROR);
        MessageBox(Handle, pChar(sgMensagem), 'Erro', MB_ICONERROR);

        DMBelShop.CDS_Join.Close;
        DMBelShop.CDS_Busca.Close;
        DMBelShop.IBQ_OC_ComprarAdd.Close;
        IBQ_ConsultaFilial.Close;

        OdirPanApres.Visible:=False;

        If sgLojasNConectadas='' Then
         sgLojasNConectadas:='Bel_'+sCodFilial
        Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sCodFilial) then
         sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sCodFilial;
      End;
    End; // Try
  End; // If bSiga Then
  Lb_EmpProcessadas.Caption:=IntToStr(StrToInt(Lb_EmpProcessadas.Caption)+1);

  OdirPanApres.Visible:=False;

  // Fecha Conexo ------------------------------------------------
  ConexaoEmpIndividual('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString, 'F');
  DMBelShop.CDS_Join.Close;
End; // Calculo e Analise Produtos Lojas - LOCAL >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Atualiza Numero dos Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AtualizaNumeroDosMeses;
Var
  MySql: String;
Begin
  sMes1:='0';
  sMes2:='0';
  sMes3:='0';
  sMes4:='0';
  sMes5:='0';
  sMes6:='0';
  sMes7:='0';
  sMes8:='0';

  sMes1:=FormatFloat('00',CB_Mes1.ItemIndex+1);
  sAno1:=Trim(ME_Ano1.Text);

  sMes2:=FormatFloat('00',CB_Mes2.ItemIndex);
  sAno2:=Trim(ME_Ano2.Text);

  sMes3:=FormatFloat('00',CB_Mes3.ItemIndex);
  sAno3:=Trim(ME_Ano3.Text);

  sMes4:=FormatFloat('00',CB_Mes4.ItemIndex);
  sAno4:=Trim(ME_Ano4.Text);

  sMes5:=FormatFloat('00',CB_Mes5.ItemIndex);
  sAno5:=Trim(ME_Ano5.Text);

  sMes6:=FormatFloat('00',CB_Mes6.ItemIndex);
  sAno6:=Trim(ME_Ano6.Text);

  sMes7:=FormatFloat('00',CB_Mes7.ItemIndex);
  sAno7:=Trim(ME_Ano7.Text);

  sMes8:=FormatFloat('00',CB_Mes8.ItemIndex);
  sAno8:=Trim(ME_Ano8.Text);

  // Guarde Mese para Demonstratrar no Grid ====================================
  MySql:='Insert Into OC_COMPRAR_MESES'+
         ' Values('+sNumDoc+', '+
         QuotedStr(CB_Mes1.Text+'/'+ME_Ano1.Text)+', ';

         If CB_Mes2.ItemIndex<>0 Then
          MySql:=MySql+QuotedStr(CB_Mes2.Text+'/'+ME_Ano2.Text)+', '
         Else
          MySql:=MySql+'Null, ';

         If CB_Mes3.ItemIndex<>0 Then
          MySql:=MySql+QuotedStr(CB_Mes3.Text+'/'+ME_Ano3.Text)+', '
         Else
          MySql:=MySql+'Null, ';

         If CB_Mes4.ItemIndex<>0 Then
          MySql:=MySql+QuotedStr(CB_Mes4.Text+'/'+ME_Ano4.Text)+', '
         Else
          MySql:=MySql+'Null, ';

         If CB_Mes5.ItemIndex<>0 Then
          MySql:=MySql+QuotedStr(CB_Mes5.Text+'/'+ME_Ano5.Text)+', '
         Else
          MySql:=MySql+'Null, ';

         If CB_Mes6.ItemIndex<>0 Then
          MySql:=MySql+QuotedStr(CB_Mes6.Text+'/'+ME_Ano6.Text)+', '
         Else
          MySql:=MySql+'Null, ';

         If CB_Mes7.ItemIndex<>0 Then
          MySql:=MySql+QuotedStr(CB_Mes7.Text+'/'+ME_Ano7.Text)+', '
         Else
          MySql:=MySql+'Null, ';

         If CB_Mes8.ItemIndex<>0 Then
          MySql:=MySql+QuotedStr(CB_Mes8.Text+'/'+ME_Ano8.Text)+')'
         Else
          MySql:=MySql+'Null)';
  DMBelShop.SQLC.Execute(MySql,nil,nil);

End; // Atualiza Numero dos Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Busca Demanda e Numeros de Dias e Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.BuscaDemanda(Cbbx_Mes: TComboBox; Me_Ano: TMaskEdit; sCodProduto, sFilial: String;
                                   Var Demanda: Currency; var iNrDias: Integer; Var iNrMeses: Integer; bConsulta: Boolean);
Var
  ii: Integer;
  sDta, MySql: String;
  sDem1, sDem2, sDem3, sDem4, sDem5, sDem6, sDem7, sDem8: String;

  dDta: TDateTime;

  sCase, sCaseDiasMeses, sIN: String;
  sDateSeparator: String;
Begin
  // Busca Demanda se Necessario ===============================================
  If bConsulta Then
  Begin
    If Not bgDemandaNovo Then
    Begin
      // Monta Scripts para Buscar Demandas ====================================
      dDta:=DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);
      sCaseDiasMeses:=' When (Cast(lpad(extract(month from dem.dta_ref),2,''0'') as varchar(2))||''/''||'+
                      '       Cast(lpad(extract(Year from dem.dta_ref),4,''0'') as varchar(4)))='+
                      '      (Cast(lpad(extract(month from current_date),2,''0'') as varchar(2))||''/''||'+
                      '       Cast(lpad(extract(Year from current_date),4,''0'') as varchar(4))) Then '+
                      IntToStr(DiasUteisBelShop(PrimUltDia(dDta,'P'), dDta, False, True));

      sDta:='';
      If StrToIntDef(sMes1,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes1+'.'+ME_Ano1.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem1''';

        dDta:=EncodeDate(StrToInt(ME_Ano1.Text), StrToInt(sMes1), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      If StrToIntDef(sMes2,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes2+'.'+ME_Ano2.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem2''' ;

        dDta:=EncodeDate(StrToInt(ME_Ano2.Text), StrToInt(sMes2), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      If StrToIntDef(sMes3,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes3+'.'+ME_Ano3.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem3''';

        dDta:=EncodeDate(StrToInt(ME_Ano3.Text), StrToInt(sMes3), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      If StrToIntDef(sMes4,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes4+'.'+ME_Ano4.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem4''';

        dDta:=EncodeDate(StrToInt(ME_Ano4.Text), StrToInt(sMes4), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      If StrToIntDef(sMes5,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes5+'.'+ME_Ano5.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem5''';

        dDta:=EncodeDate(StrToInt(ME_Ano5.Text), StrToInt(sMes5), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      If StrToIntDef(sMes6,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes6+'.'+ME_Ano6.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem6''';

        dDta:=EncodeDate(StrToInt(ME_Ano6.Text), StrToInt(sMes6), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      If StrToIntDef(sMes7,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes7+'.'+ME_Ano7.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem7''';

        dDta:=EncodeDate(StrToInt(ME_Ano7.Text), StrToInt(sMes7), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      If StrToIntDef(sMes8,0)<>0 Then
      Begin
        sDta:=QuotedStr('01.'+sMes8+'.'+ME_Ano8.Text);

        sCase:=
         sCase+' When dem.dta_ref = '+sDta+' Then ''Dem8''';

        dDta:=EncodeDate(StrToInt(ME_Ano8.Text), StrToInt(sMes8), 1);
        sCaseDiasMeses:=
         sCaseDiasMeses+'  When dem.dta_ref = '+sDta+' Then '+
                           IntToStr(DiasUteisBelShop(dDta, PrimUltDia(dDta,'U'), False, True));

        If sIN='' Then sIN:=sDta Else sIN:=sIN+', '+sDta;
      End;

      sIN:='('+sIN+')';

      // Busca Demandas ==========================================================
      MySql:=' Select dem.dta_ref,'+
             ' Case '+sCase+' End Demanda,'+
             ' Case '+sCaseDiasMeses+' End Num_Dias,'+
             ' Coalesce(Dem.quant_ref,0) dem'+

             ' From movtos_empresas Dem'+

             ' Where Dem.codproduto='+QuotedStr(sCodProduto)+
             ' And   Dem.codfilial='+QuotedStr(sFilial)+
             ' And   Dem.ind_tipo=''DM'''+
             ' And   Dem.dta_ref in '+sIN+
             ' Order by Dem.dta_atualizacao desc';
      DMBelShop.CDS_Demandas.Close;
      DMBelShop.SDS_Demandas.CommandText:=MySql;
      DMBelShop.CDS_Demandas.Open;
    End; // If Not bgDemandaNovo Then

    // Busca de Demandas Novo - Filtra =========================================
    If bgDemandaNovo Then
    Begin
      DMBelShop.CDS_DemandasNovo.Filter:='CodProduto='+QuotedStr(sCodProduto);
      DMBelShop.CDS_DemandasNovo.Filtered:=True;
    End; // If bgDemandaNovo Then

    // Monta Select de Demandas ================================================
    sDem1:='0';
    If Not bgDemandaNovo Then
     Begin
       If DMBelShop.CDS_Demandas.Locate('Demanda','Dem1',[]) Then
        sDem1:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
     End
    Else
     Begin
       If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem1',[]) Then
        sDem1:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
     End; // If Not bgDemandaNovo Then

    If StrToIntDef(sMes2,0)<>0 Then
    Begin
      sDem2:='0';
      If Not bgDemandaNovo Then
       Begin
         If DMBelShop.CDS_Demandas.Locate('Demanda','Dem2',[]) Then
          sDem2:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
       End
      Else
       Begin
         If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem2',[]) Then
          sDem2:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
       End; // If Not bgDemandaNovo Then
    End;

    If StrToIntDef(sMes3,0)<>0 Then
    Begin
      sDem3:='0';
      If Not bgDemandaNovo Then
       Begin
         If DMBelShop.CDS_Demandas.Locate('Demanda','Dem3',[]) Then
          sDem3:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
       End
      Else
       Begin
         If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem3',[]) Then
          sDem3:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
       End; // If Not bgDemandaNovo Then
    End;

    If StrToIntDef(sMes4,0)<>0 Then
    Begin
      sDem4:='0';
      If Not bgDemandaNovo Then
       Begin
         If DMBelShop.CDS_Demandas.Locate('Demanda','Dem4',[]) Then
          sDem4:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
       End
      Else
       Begin
         If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem4',[]) Then
          sDem4:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
       End; // If Not bgDemandaNovo Then
    End;

    If StrToIntDef(sMes5,0)<>0 Then
    Begin
      sDem5:='0';
      If Not bgDemandaNovo Then
       Begin
         If DMBelShop.CDS_Demandas.Locate('Demanda','Dem5',[]) Then
          sDem5:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
       End
      Else
       Begin
         If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem5',[]) Then
          sDem5:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
       End; // If Not bgDemandaNovo Then
    End;

    If StrToIntDef(sMes6,0)<>0 Then
    Begin
      sDem6:='0';
      If Not bgDemandaNovo Then
       Begin
         If DMBelShop.CDS_Demandas.Locate('Demanda','Dem6',[]) Then
          sDem6:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
       End
      Else
       Begin
         If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem6',[]) Then
          sDem6:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
       End; // If Not bgDemandaNovo Then
    End;

    If StrToIntDef(sMes7,0)<>0 Then
    Begin
      sDem7:='0';
      If Not bgDemandaNovo Then
       Begin
         If DMBelShop.CDS_Demandas.Locate('Demanda','Dem7',[]) Then
          sDem7:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
       End
      Else
       Begin
         If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem7',[]) Then
          sDem7:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
       End; // If Not bgDemandaNovo Then
    End;

    If StrToIntDef(sMes8,0)<>0 Then
    Begin
      sDem8:='0';
      If Not bgDemandaNovo Then
       Begin
         If DMBelShop.CDS_Demandas.Locate('Demanda','Dem8',[]) Then
          sDem8:=DMBelShop.CDS_Demandas.FieldByName('Dem').AsString;
       End
      Else
       Begin
         If DMBelShop.CDS_DemandasNovo.Locate('Demanda','Dem8',[]) Then
          sDem8:=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsString;
       End; // If Not bgDemandaNovo Then
    End;

    // Calculo numero de Dias e Meses ==========================================
    iNrDias:=0;
    iNrMeses:=0;
    DecodeDate(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), wgAnoH, wgMesH, wgDiaH);

    If Not bgDemandaNovo Then
    Begin
      DMBelShop.CDS_Demandas.First;
      While Not DMBelShop.CDS_Demandas.Eof do
      Begin
        ii:=StrToInt(copy(DMBelShop.CDS_Demandas.FieldByName('dta_ref').AsString,4,2));

        // NO Conta Ms Atual ----------------------------------------
        If AnsiUpperCase(ShortMonthNames[wgMesH])+IntToStr(wgAnoH)<>
           AnsiUpperCase(ShortMonthNames[ii])+copy(DMBelShop.CDS_Demandas.FieldByName('dta_ref').AsString,7,4) Then
         Inc(iNrMeses);

         iNrDias:=iNrDias+DMBelShop.CDS_Demandas.FieldByName('Num_Dias').AsInteger;

        DMBelShop.CDS_Demandas.Next;
      End;
    End; // If Not bgDemandaNovo Then

    If bgDemandaNovo Then
    Begin
      sDateSeparator:=DateSeparator;
      DateSeparator:='/';

      cgDemAno:=0;
      cgDemAnoDia:=0;
      DMBelShop.CDS_DemandasNovo.First;
      While Not DMBelShop.CDS_DemandasNovo.Eof do
      Begin
        ii:=StrToInt(copy(DMBelShop.CDS_DemandasNovo.FieldByName('dta_ref').AsString,4,2));

        // Demandas Meses -------------------------------------------
        If Trim(DMBelShop.CDS_DemandasNovo.FieldByName('Demanda').AsString)<>'ANO' Then
        Begin
          // NO Conta Ms Atual ------------------------------------
          If AnsiUpperCase(ShortMonthNames[wgMesH])+IntToStr(wgAnoH)<>
             AnsiUpperCase(ShortMonthNames[ii])+copy(DMBelShop.CDS_DemandasNovo.FieldByName('dta_ref').AsString,7,4) Then
          Begin
            Inc(iNrMeses);
          End;

          If Trim(DMBelShop.CDS_DemandasNovo.FieldByName('Demanda').AsString)<>'ANO' Then
          Begin
             iNrDias:=iNrDias+DMBelShop.CDS_DemandasNovo.FieldByName('Num_Dias').AsInteger;
          End;
        End; // If Trim(DMBelShop.CDS_DemandasNovo.FieldByName('Demanda').AsString)<>'ANO' Then

        // Demandas Ano ---------------------------------------------
        If Trim(DMBelShop.CDS_DemandasNovo.FieldByName('Demanda').AsString)='ANO' Then
        Begin
          cgDemAno   :=DMBelShop.CDS_DemandasNovo.FieldByName('Dem').AsCurrency;

          // Verifica Dias Uteis ------------------------------------
          If (Trim(DMBelShop.CDS_DemandasNovo.FieldByName('dta_ref').AsString)='') Or
             (DMBelShop.CDS_DemandasNovo.FieldByName('dta_ref').AsDateTime<=StrToDate(sgDtaIniAno)) Then
           Begin
             igNrDiasAno:=DMBelShop.CDS_DemandasNovo.FieldByName('Num_Dias').AsInteger;
           End
          Else if (DMBelShop.CDS_DemandasNovo.FieldByName('dta_ref').AsDateTime>StrToDate(sgDtaFimAno)) Then
           Begin
            igNrDiasAno:=1;
           End
          Else
           Begin
             igNrDiasAno:=DiasUteisBelShop(DMBelShop.CDS_DemandasNovo.FieldByName('dta_ref').AsDateTime, StrToDate(sgDtaFimAno)-1, False, True);
           End; // If Trim(DMVirtual.CDS_V_EstoquesDTA_INCLUSAO.AsString)='' Then

          cgDemAnoDia:=cgDemAno/igNrDiasAno;
        End; // If Trim(DMBelShop.CDS_DemandasNovo.FieldByName('Demanda').AsString)='ANO' Then

        DMBelShop.CDS_DemandasNovo.Next;
      End; // While Not DMBelShop.CDS_DemandasNovo.Eof do

      If sDateSeparator='/' Then DateSeparator:='/' Else DateSeparator:='.';
    End; // If bgDemandaNovo Then

    // Monta SQL com as Demandas ===============================================
    MySql:='Select '+sDem1+' Dem1';
           If sDem2<>'' Then MySql:=MySql+', '+sDem2+' Dem2';
           If sDem3<>'' Then MySql:=MySql+', '+sDem3+' Dem3';
           If sDem4<>'' Then MySql:=MySql+', '+sDem4+' Dem4';
           If sDem5<>'' Then MySql:=MySql+', '+sDem5+' Dem5';
           If sDem6<>'' Then MySql:=MySql+', '+sDem6+' Dem6';
           If sDem7<>'' Then MySql:=MySql+', '+sDem7+' Dem7';
           If sDem8<>'' Then MySql:=MySql+', '+sDem8+' Dem8';
           MySql:=MySql+' From RDB$DATABASE';
    DMBelShop.CDS_Demandas.Close;
    DMBelShop.SDS_Demandas.CommandText:=MySql;
    DMBelShop.CDS_Demandas.Open;

    // Busca de Demandas Novo - Limpa Filtra ===================================
    If bgDemandaNovo Then
    Begin
      DMBelShop.CDS_DemandasNovo.Filtered:=False;
      DMBelShop.CDS_DemandasNovo.Filter:='';
    End; // If bgDemandaNovo Then
  End; // If bConsulta Then
End; // Busca Demanda e Numeros de Dias e Meses >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Novo Calculo de Pedido de Compra das Lojas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.OCProcessaFilial: Boolean; // Novo Calculo
Var
  MySql: String;

  i: Integer;
  iQtdMediaDia, iQtdMediaMes: Integer; // Indices dos Campos para Calcular Depois

  s, ss, sDta_Ref, sCodForn,  sNomeForn: String;
  cQuant_Ref, cPreco, cPrecoUnit, cVlr_Total_Ref, cQtdTransito,
  cMediaMes: Currency;

  sCodLojaLinx, sCodProdSidicom, sCodProdLinx, sSaldoLinx, sCodBarras: String;

Begin
  Result:=False;

  Try // IBQ_OC_ComprarAdd
    // Ultima Compra ----------------------------------------------
    sDta_Ref:='';
    sCodForn:='';
    sNomeForn:='';
    cQuant_Ref:=0;
    cPreco:=0;
    cPrecoUnit:=0;
    cVlr_Total_Ref:=0;

    s :=sCodFilial;
    ss:=DMBelShop.CDS_Busca.FieldByName('COD_ITEM').AsString;
    If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'UC']),[]) Then
     Begin
       sDta_Ref      :=DMBelShop.CDS_UltCompraTransito.FieldByName('Dta_Ref').AsString;
       sCodForn      :=DMBelShop.CDS_UltCompraTransito.FieldByName('CodFornecedor').AsString;
       sNomeForn     :=DMBelShop.CDS_UltCompraTransito.FieldByName('NomeFornecedor').AsString;
       cQuant_Ref    :=DMBelShop.CDS_UltCompraTransito.FieldByName('Quant_Ref').AsCurrency;
       cPreco        :=DMBelShop.CDS_UltCompraTransito.FieldByName('Preco').AsCurrency;
       cPrecoUnit    :=DMBelShop.CDS_UltCompraTransito.FieldByName('Preco').AsCurrency;
       cVlr_Total_Ref:=DMBelShop.CDS_UltCompraTransito.FieldByName('Vlr_Total_Ref').AsCurrency;
     End
    Else If DMBelShop.CDS_UltCompraTransito.Locate('CodProduto;Tipo',VarArrayOf([ss, 'UC']),[]) Then
     Begin
       cPrecoUnit    :=DMBelShop.CDS_UltCompraTransito.FieldByName('Preco').AsCurrency;
     End; // If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'UC']),[]) Then
//odiropss
//sgMensagem:=sgMensagem+sDta_Ref;
    // Transito ---------------------------------------------------
    cQtdTransito:=0;
    If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'TR']),[]) Then
    Begin
      cQtdTransito  :=DMBelShop.CDS_UltCompraTransito.FieldByName('Quant_Ref').AsCurrency;
    End; // If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'TR']),[]) Then

    // Loja Linx ===============================================================
    MySql:=' SELECT e.cod_linx'+
           ' FROM EMP_CONEXOES e'+
           ' where e.cod_filial='+QuotedStr(sCodFilial);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sCodLojaLinx:=DMBelShop.CDS_BuscaRapida.FieldByName('COD_LINX').AsString;
    DMBelShop.CDS_BuscaRapida.Close;

    //========================================================================
    // Dados Liunx ===========================================================
    //========================================================================
    sCodProdSidicom:=DMBelShop.CDS_Busca.FieldByName('COD_ITEM').AsString;
    sCodProdLInx:='';
    sSaldoLinx:='';
    sCodBarras:='';

    If sCodLojaLinx<>'0' Then
    Begin
      MySql:=' select p.codbarra'+
             ' from PRODUTO p'+
             ' where p.codproduto='+QuotedStr(sCodProdSidicom)+
             ' union'+
             ' select b.codbarra'+
             ' from PRODUTOSBARRA b'+
             ' where b.codproduto='+QuotedStr(sCodProdSidicom);
      IBQ_MPMS.Close;
      IBQ_MPMS.SQL.Clear;
      IBQ_MPMS.SQL.Add(MySql);
      IBQ_MPMS.Open;

      While Not IBQ_MPMS.Eof do
      Begin
        If Trim(sCodBarras)='' Then
         sCodBarras:=QuotedStr(Trim(IBQ_MPMS.FieldByName('CodBarra').AsString))
        Else
         sCodBarras:=sCodBarras+', '+QuotedStr(Trim(IBQ_MPMS.FieldByName('CodBarra').AsString));

        IBQ_MPMS.Next;
      End; // While Not IBQ_MPMS.Eof do
      IBQ_MPMS.Close;
    End; // If sCodLojaLinx<>'0' Then

    If Trim(sCodBarras)<>'' Then
    Begin
      MySql:=' select pr.cod_produto'+
             ' from LINXPRODUTOS pr'+
             ' where ((Trim(pr.cod_barra) in ('+sCodBarras+')) or (trim(pr.cod_auxiliar)='+QuotedStr(sCodProdSidicom)+'))'+
             ' UNION'+
             ' select cb.cod_produto'+
             ' from LINXPRODUTOSCODBAR cb'+
             ' where Trim(cb.cod_barra) in ('+sCodBarras+')';
      DMBelShop.CDS_BuscaRapida.Close;
      DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
      DMBelShop.CDS_BuscaRapida.Open;
      sCodProdLinx:='';

      If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Produto').AsString)<>'' Then
       sCodProdLinx:=DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Produto').AsString;

      DMBelShop.CDS_BuscaRapida.Close;
    End; // If Trim(sCodBarras)<>'' Then

    If Trim(sCodProdLinx)<>'' Then
    Begin
      MySql:=' select CAST(pd.quantidade as Integer) quantidade'+
             ' from LINXPRODUTOSDETALHES pd'+
             ' where pd.cod_produto='+sCodProdLinx+
             ' and pd.empresa='+sCodLojaLinx;
      DMBelShop.CDS_BuscaRapida.Close;
      DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
      DMBelShop.CDS_BuscaRapida.Open;
      sSaldoLinx:='';
      If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Quantidade').AsString)<>'' Then
       sSaldoLinx:=DMBelShop.CDS_BuscaRapida.FieldByName('Quantidade').AsString;

      DMBelShop.CDS_BuscaRapida.Close;
    End; // If Trim(sCodBarras)<>'' Then
    // Dados Liunx ===========================================================
    //========================================================================

    // Inica Processo ==========================================================
    If Not DMBelShop.IBT_BelShop.Active Then
     DMBelShop.IBT_BelShop.StartTransaction;

    If Not DMBelShop.IBQ_OC_ComprarAdd.Active Then
     DMBelShop.IBQ_OC_ComprarAdd.Open;

    DMBelShop.IBQ_OC_ComprarAdd.Insert;
    For i:=0 to DMBelShop.CDS_Busca.FieldCount-1 do
    Begin

      // Trata Campos =============================================
      If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='NUM_SEQ' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=iNumSeqDoc

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='COD_EMPRESA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sCodFilial

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DES_EMPRESA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=Trim(DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString)

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='CLA_CURVA_ABC' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=DMBelShop.CDS_Join.FieldByName('IND_CURVA').AsString

      Else If (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_UNI_COMPRA') And (cPrecoUnit<>0) Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cPrecoUnit

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_CUSTO_MEDIO' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=IBQ_ConsultaFilial.FieldByName('CUSTOMEDIO').AsCurrency

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_SALDO' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_TRANSITO' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cQtdTransito

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DISPONIVEL' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cQtdTransito+
                          IBQ_ConsultaFilial.FieldByName('QTD_SALDO').AsCurrency

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DTA_ULT_COMPRA') And (sDta_Ref<>'') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sDta_Ref

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DTA_ULT_COMPRA') And (sDta_Ref='') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='COD_FOR_ULT_COMPRA') And (sDta_Ref<>'') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sCodForn

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='COD_FOR_ULT_COMPRA') And (sDta_Ref='') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DES_FOR_ULT_COMPRA') And (sDta_Ref<>'') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sNomeForn

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DES_FOR_ULT_COMPRA') And (sDta_Ref='') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_ULT_COMPRA') And (sDta_Ref<>'') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cQuant_Ref

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_ULT_COMPRA') And (sDta_Ref='') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_UNI_ULT_COMPRA') And (sDta_Ref<>'') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cPreco

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_UNI_ULT_COMPRA') And (sDta_Ref='') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_TOT_ULT_COMPRA') And (sDta_Ref<>'') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cVlr_Total_Ref

      Else if (AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_TOT_ULT_COMPRA') And (sDta_Ref='') Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='COD_CLI_ULT_VENDA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DES_CLI_ULT_VENDA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DTA_ULT_VENDA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_ULT_VENDA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_UNI_ULT_VENDA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='VLR_TOT_ULT_VENDA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=EmptyStr

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES1' Then
       Begin
         If Trim(DMBelShop.CDS_Demandas.FieldByName('Dem1').AsString)<>'' Then
          Begin
            cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem1').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                          DMBelShop.CDS_Demandas.FieldByName('Dem1').AsCurrency;
            End
          Else
           Begin
             DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
           End;
       End

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES2' Then
       Begin
         If  (StrToIntDef(sMes2,0)<>0) And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem2').AsString)<>'') Then
          Begin
            cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
            cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                          DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
          End
         Else
          Begin
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
          End;
       End

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES3' Then
       Begin
         If (StrToIntDef(sMes3,0)<>0) And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem3').AsString)<>'') Then
          Begin
            cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
            cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                          DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
          End
         Else
          Begin
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
          End;
       End

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES4' Then
       Begin
         If (StrToIntDef(sMes4,0)<>0) And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem4').AsString)<>'') Then
          Begin
            cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
            cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                          DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
          End
         Else
          Begin
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
          End;
       End

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES5' Then
       Begin
         If (StrToIntDef(sMes5,0)<>0) And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem5').AsString)<>'') Then
          Begin
            cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
            cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                          DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
          End
         Else
          Begin
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
          End;
       End

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES6' Then
       Begin
         If (StrToIntDef(sMes6,0)<>0) And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem6').AsString)<>'') Then
          Begin
            cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
            cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                          DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
          End
         Else
          Begin
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
          End;
       End

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES7' Then
       Begin
         If  (StrToIntDef(sMes7,0)<>0) And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem7').AsString)<>'') Then
          Begin
            cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
            cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
          End
         Else
          Begin
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
          End;
       End
      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEM_MES8' Then
       Begin
         If (StrToIntDef(sMes8,0)<>0) And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem8').AsString)<>'') Then
          Begin
            cgOutras_Demandas:=cgOutras_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
            cgTotal_Demandas:=cgTotal_Demandas+
                          DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                          DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
          End
        Else
          Begin
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=0;
          End;
       End

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_MEDIA_MES' Then
       iQtdMediaMes:=i

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_MEDIA_DIA' Then
       iQtdMediaDia:=i

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_NR_DIAS' Then
        DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igNrDias

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_NR_MESES' Then
        DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igNrMeses

      Else if AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_TOT_MESES' Then
        DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igTotMeses

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='EST_MINIMO' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=DMBelShop.CDS_Join.FieldByName('EST_MINIMO').AsInteger

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='DIAS_ESTOCAGEM' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsInteger

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEMANDA_DIA' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cgDemAnoDia

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DEMANDA_ANO' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cgDemAno

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_DIAS_ANO' Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igNrDiasAno

      Else If AnsiUpperCase(DMBelShop.CDS_Busca.Fields[i].FieldName)='QTD_TRANSF_ANO' Then // Saldo Linx
       Begin
         If Trim(sSaldoLinx)='' Then
          DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=Unassigned
         Else
          DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSaldoLinx;
       End

      Else
       DMBelShop.IBQ_OC_ComprarAdd.Fields[i].Assign(DMBelShop.CDS_Busca.Fields[i]);

    End; // For i:=0 to DMBelShop.CDS_Busca.FieldCount-1 do

    // Acerta Media (QTD_MEDIA_MES) ============================================
    If igNrMeses<igTotMeses Then
     Begin
       If igNrMeses<>0 Then
        cMediaMes:=RoundTo((cgOutras_Demandas/igNrMeses),-4)
       Else
        cMediaMes:=0;
     End
    Else
     Begin
       cMediaMes:=RoundTo((cgTotal_Demandas/igTotMeses),-4);
     End; // If igNrMeses<igTotMeses Then

     DMBelShop.IBQ_OC_ComprarAdd.Fields[iQtdMediaMes].AsCurrency:=cMediaMes;

    // Acerta Media (QTD_MEDIA_DIA) ============================================
    If igNrDias<>0 Then
     DMBelShop.IBQ_OC_ComprarAdd.Fields[iQtdMediaDia].AsCurrency:=RoundTo((cgTotal_Demandas/igNrDias),-4)
    Else
     DMBelShop.IBQ_OC_ComprarAdd.Fields[iQtdMediaDia].AsCurrency:=0;

    DMBelShop.IBQ_OC_ComprarAdd.Post;

    // Atualiza Transacao ======================================================
    DMBelShop.IBQ_OC_ComprarAdd.ApplyUpdates;
    DMBelShop.IBT_BelShop.CommitRetaining;
    DMBelShop.IBT_BelShop.Commit;

    Result:=True;
  Except // Try // IBQ_OC_ComprarAdd
    On e : Exception do
    Begin
      // Abandona Transacao ====================================================
      DMBelShop.IBT_BelShop.Rollback;

      If sgLojasNConectadas='' Then
       sgLojasNConectadas:='Bel_'+sCodFilial
      Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+sCodFilial) then
       sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+sCodFilial;

      MessageBox(Handle, pChar(IntToStr(IBQ_ConsultaFilial.RecNo)+#13+e.message), 'Erro', MB_ICONERROR);
    End; // On e : Exception do
  End; // Try // IBQ_OC_ComprarAdd

//odirapagar - dta_

End; // Novo Calculo de Pedido de Compra das Lojas >>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Novo Calculo de Pedido de Compra da Matriz >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.OCProcessaMatriz: Boolean; // Novo Calculo
Var
  MySql: String;

  s, ss,
  sCodLojaLinx, sCodProdSidicom, sCodProdLinx, sSaldoLinx, sCodBarras: String;

  b: Boolean;
  i: Integer;

  iQtdMediaDia, iQtdMediaMes: Integer; // Indices dos Campos para Calcular Depois

  sDta_Ref, sCodForn,  sNomeForn: String;
  cQuant_Ref, cPreco, cPrecoUnit, cVlr_Total_Ref, cQtdTransito,
  cMediaMes, cDemanda: Currency;

  // Tributao
  sCOD_ICMS, sEstado, sTIP_PESSOA,
  sCodICM, sSittributaria, sSomaIPIBase, sSomaFreteBase, sSomaDespesaBase,
  sSubstituicao, sSubstValPer, sSomaIPIBaseSubst, sSomaFreteBaseST,
  sSomaDespesaBaseST: String;
  cAliquota, cReducao, cSubstMargem, cSubstAliquota, cAliqRepasse: Currency;
Begin
  Result:=False;

  // Busca Numero de Documento =================================================
  MySql:=' SELECT GEN_ID(GEN_NUM_DOC_CALCULO,1) Codigo'+
         ' FROM RDB$DATABASE';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;
  sNumDoc:=DMBelShop.CDS_Busca.FieldByName('Codigo').AsString;
  DMBelShop.CDS_Busca.Close;

  // Atualiza Numero dos Meses =================================================
  AtualizaNumeroDosMeses;

  // Apresentacao do Processamento -------------------------------------------
  DMVirtual.CDS_V_EmpConexoes.Locate('Tip_Emp','M',[]);

  OdirPanApres.Caption:='AGUARDE !! Processando Empresa Matriz: '+
                         DMVirtual.CDS_V_EmpConexoesCOD_FILIAL.AsString+' - '+
                         DMVirtual.CDS_V_EmpConexoesRAZAO_SOCIAL.AsString;
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  //============================================================================
  // Novo Processo de Calculo Usando IBQ_OC_ComprarAdd =========================
  //============================================================================
  Try // IBQ_OC_ComprarAdd
    If Not DMBelShop.IBT_BelShop.Active Then
     DMBelShop.IBT_BelShop.StartTransaction;

    // Calcula Matriz ==========================================================
    MontaProgressBar(True, FrmBelShop);

    iNrRegistros:=TotalRegistros(IBQ_Matriz, MySqlClausula2);
    pgProgBar.Properties.Max:=iNrRegistros;
    pgProgBar.Position:=0;
    Edt_OCTotProdutos.Value:=iNrRegistros;

    // Busca Tributao ========================================================
    MySql:=' SELECT'+
           ' tr.CODICM, tr.CODESTADO, tr.REVENDACONSUMOFJ, tr.SITTRIBUTARIA, tr.SUBSTITUICAO,'+
           ' COALESCE(tr.SOMAIPIBASE,''N'') SOMAIPIBASE,'+
           ' COALESCE(tr.SOMAFRETEBASE,''N'') SOMAFRETEBASE,'+
           ' COALESCE(tr.SOMADESPESABASE, ''N'') SOMADESPESABASE,'+
           ' COALESCE(tr.SOMAIPIBASESUBST,''N'') SOMAIPIBASESUBST,'+
           ' COALESCE(tr.SOMAFRETEBASEST,''N'') SOMAFRETEBASEST,'+
           ' COALESCE(tr.SOMADESPESABASEST,''N'') SOMADESPESABASEST,'+
           ' COALESCE(tr.REDUCAO,0) REDUCAO,'+
           ' COALESCE(tr.ALIQUOTA,0) ALIQUOTA,'+
           ' COALESCE(tr.SUBSTMARGEM,0) SUBSTMARGEM,'+
           ' COALESCE(tr.SUBSTVALPER,''P'') SUBSTVALPER,'+
           ' COALESCE(tr.SUBSTALIQUOTA,0) SUBSTALIQUOTA,'+
           ' COALESCE(tr.ALIQREPASSE,0) ALIQREPASSE'+

           ' FROM TABELAICMS tr'+

           ' WHERE TRIM(tr.CODCOMPROVANTE)=''012'''+  // Sempre 012 = Ordem de Compra
           ' AND   tr.CLIOUFOR=''F'''+
           ' ORDER BY 1,2,3';
    IBQ_ConsultaMatriz.Close;
    IBQ_ConsultaMatriz.SQL.Clear;
    IBQ_ConsultaMatriz.SQL.Add(MySql);
    IBQ_ConsultaMatriz.Open;

    // Busca Ultima Compra/Transito ============================================
    MySql:=' SELECT m.codfilial, m.codproduto, ''UC'' Tipo, '+
           ' m.dta_ref, pr.principalfor codfornecedor, pr.nomefornecedor,'+
           ' m.quant_ref, m.preco, m.vlr_total_ref'+

           ' FROM MOVTOS_EMPRESAS m, PRODUTO pr'+
           ' WHERE m.codproduto=pr.codproduto'+
           ' AND   m.codfilial<100'+
           ' AND   m.ind_tipo='+QuotedStr('UC');

           // Produtos No Compra -------------------------------------
           If Not Ckb_FiltroProdNaoCompra.Checked Then
            MySql:=
             MySql+' AND Coalesce(pr.situacaopro,0)=0'
           Else
            MySql:=
             MySql+' AND Coalesce(pr.situacaopro,0) in (0,3)';

           // Produtos Codigos e/ou Produtos Like ---------------------
           If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
            MySql:=
             MySql+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
           Else If Trim(sgProdutos)<>'' Then
            MySql:=
             MySql+' AND pr.CodProduto in ('+sgProdutos+')'
           Else If Trim(sgLikeProdutos)<>'' Then
            MySql:=
             MySql+' AND '+sgLikeProdutos;

           // Fornecedores --------------------------------------------
           If Trim(sgFornecedores)<>'' Then
            MySql:=
             MySql+' AND pr.principalfor in ('+sgFornecedores+')'
           Else
            MySql:=
             MySql+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

           If bgECommerce Then
            MySql:=
             MySql+' AND pr.ECOMMERCE_SN='+QuotedStr('S');

    // Verifica se Busca Transito ==============================================
    If CkB_CalculoTransito.Checked Then
    Begin
      MySql:=
       MySql+' UNION'+

             ' SELECT t.codfilial, t.codproduto, ''TR'' Tipo,'+
             ' NULL dta_ref, NULL codfornecedor, NULL nomefornecedor,'+
             ' SUM(COALESCE(t.quant_ref,0)) quant_ref, 0 preco, 0 vlr_total_ref'+

             ' FROM MOVTOS_EMPRESAS t, PRODUTO p'+
             ' WHERE t.codproduto=p.codproduto'+
             ' AND   t.codfilial<100'+
             ' AND   t.ind_tipo='+QuotedStr('TR')+
             ' AND   t.dta_ref>='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_CalculoTransito.Date))));

             If Not bgTodasEmpresas Then
              MySql:=
               MySql+' AND   t.codfilial in ('+sgEmpresas+')';

             // Produtos No Compra -------------------------------------
             If Not Ckb_FiltroProdNaoCompra.Checked Then
              MySql:=
               MySql+' AND Coalesce(p.situacaopro,0)=0'
             Else
              MySql:=
               MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';

             // Produtos Codigos e/ou Produtos Like ---------------------
             If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
              MySql:=
               MySql+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.',sgLikeProdutos)+')'
             Else If Trim(sgProdutos)<>'' Then
              MySql:=
               MySql+' AND p.CodProduto in ('+sgProdutos+')'
             Else If Trim(sgLikeProdutos)<>'' Then
              MySql:=
               MySql+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

             // Fornecedores --------------------------------------------
             If Trim(sgFornecedores)<>'' Then
              MySql:=
               MySql+' AND p.principalfor in ('+sgFornecedores+')'
             Else
              MySql:=
               MySql+' AND p.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

             If bgECommerce Then
              MySql:=
               MySql+' AND p.ECOMMERCE_SN='+QuotedStr('S');

      MySql:=
       MySql+' GROUP BY 1, 2';
    End; // If CkB_CalculoTransito.Checked Then

    MySql:=
     MySql+' ORDER BY 1, 2, 3, 4 DESC';
    DMBelShop.CDS_UltCompraTransito.Close;
    DMBelShop.SDS_UltCompraTransito.CommandText:=MySql;
    DMBelShop.CDS_UltCompraTransito.Open;

    // Monta Demandas ==========================================================
    MontaDemandasNovo(sCodMatriz);

    // Efetua o Calculo Para Analise Matriz ====================================
    iNumSeqDoc :=0;
    sCOD_ICMS  :='';
    sEstado    :='';
    sTIP_PESSOA:='';

    DMBelShop.IBQ_OC_ComprarAdd.Close;
    DMBelShop.IBQ_OC_ComprarAdd.SQL.Clear;
    DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' Select *');
    DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' From oc_comprar oc');
    DMBelShop.IBQ_OC_ComprarAdd.SQL.Add(' Where oc.num_documento<1');
    DMBelShop.IBQ_OC_ComprarAdd.Open;

    // Loja Linx ===============================================================
    MySql:=' SELECT e.cod_linx'+
           ' FROM EMP_CONEXOES e'+
           ' where e.cod_filial=''99''';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sCodLojaLinx:=DMBelShop.CDS_BuscaRapida.FieldByName('COD_LINX').AsString;
    DMBelShop.CDS_BuscaRapida.Close;

    IBQ_Matriz.First;
    While not IBQ_Matriz.Eof do
    Begin
      Application.ProcessMessages;
      pgProgBar.Position:=IBQ_Matriz.RecNo;

      sCodProdSidicom:=IBQ_Matriz.FieldByName('COD_ITEM').AsString;

      //========================================================================
      // Dados Liunx ===========================================================
      //========================================================================
      sCodProdLInx:='';
      sSaldoLinx:='';
      sCodBarras:='';

      If sCodLojaLinx<>'0' Then
      Begin
        MySql:=' select p.codbarra'+
               ' from PRODUTO p'+
               ' where p.codproduto='+QuotedStr(sCodProdSidicom)+
               ' union'+
               ' select b.codbarra'+
               ' from PRODUTOSBARRA b'+
               ' where b.codproduto='+QuotedStr(sCodProdSidicom);
        IBQ_MPMS.Close;
        IBQ_MPMS.SQL.Clear;
        IBQ_MPMS.SQL.Add(MySql);
        IBQ_MPMS.Open;

        While Not IBQ_MPMS.Eof do
        Begin
          If Trim(sCodBarras)='' Then
           sCodBarras:=QuotedStr(Trim(IBQ_MPMS.FieldByName('CodBarra').AsString))
          Else
           sCodBarras:=sCodBarras+', '+QuotedStr(Trim(IBQ_MPMS.FieldByName('CodBarra').AsString));

          IBQ_MPMS.Next;
        End; // While Not IBQ_MPMS.Eof do
        IBQ_MPMS.Close;
      End; // If sCodLojaLinx<>'0' Then

      If Trim(sCodBarras)<>'' Then
      Begin
        MySql:=' select pr.cod_produto'+
               ' from LINXPRODUTOS pr'+
               ' where ((Trim(pr.cod_barra) in ('+sCodBarras+')) or (trim(pr.cod_auxiliar)='+QuotedStr(sCodProdSidicom)+'))'+
               ' UNION'+
               ' select cb.cod_produto'+
               ' from LINXPRODUTOSCODBAR cb'+
               ' where Trim(cb.cod_barra) in ('+sCodBarras+')';
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;
        sCodProdLinx:='';

        If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Produto').AsString)<>'' Then
         sCodProdLinx:=DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Produto').AsString;

        DMBelShop.CDS_BuscaRapida.Close;
      End; // If Trim(sCodBarras)<>'' Then

      If Trim(sCodProdLinx)<>'' Then
      Begin
        MySql:=' select CAST(pd.quantidade as Integer) quantidade'+
               ' from LINXPRODUTOSDETALHES pd'+
               ' where pd.cod_produto='+sCodProdLinx+
               ' and pd.empresa='+sCodLojaLinx;
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;
        sSaldoLinx:='';
        If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Quantidade').AsString)<>'' Then
         sSaldoLinx:=DMBelShop.CDS_BuscaRapida.FieldByName('Quantidade').AsString;

        DMBelShop.CDS_BuscaRapida.Close;
      End; // If Trim(sCodBarras)<>'' Then
      // Dados Liunx ===========================================================
      //========================================================================

      bgProcCurva:=True;

      b:=False;
      While Not b do // Verifica se Existe na Tabela ES_FINAN_CURVA_ABC
      Begin
        If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_Matriz.FieldByName('COD_ITEM').AsString,[]) Then
         Begin
           b:=True;

           // Curvas Por Loja ou Por MPMS
           If ((Gb_CalculoTpCurvaABC.Visible) Or (Gb_CalculoApresCurva.Visible)) and (Gb_CalculoApresCurva.Visible) Then
           Begin
             If (DMBelShop.CDS_Join.FieldByName('Usar_Curva').AsString='NAO') and (Not Ckb_CalculoApresCurvaFora.Checked) Then
              Begin
                bgProcCurva:=False;
              End
             Else If (DMBelShop.CDS_Join.FieldByName('Usar_Curva').AsString='NAO') and (Ckb_CalculoApresCurvaFora.Checked) Then
              Begin
                If (Rb_CalculoApresCurvaEstCom.Checked) and (IBQ_Matriz.FieldByName('QTD_SALDO').AsInteger=0) Then
                  bgProcCurva:=False
                Else If (Rb_CalculoApresCurvaEstSem.Checked) and (IBQ_Matriz.FieldByName('QTD_SALDO').AsInteger<>0) Then
                  bgProcCurva:=False
              End;
           End; // If Gb_CalculoTpCurvaABC.Visible Then
         End
        Else // If DMBelShop.CDS_Join.Locate('COD_PRODUTO',IBQ_Matriz.FieldByName('COD_ITEM').AsString,[]) Then
         Begin
           If (StrToDate(IBQ_Matriz.FieldByName('DATAINCLUSAO').AsString)>=StrToDate(f_Troca('.','/',f_Troca('-','/',sgDtaInicio)))) Or
              (StrToDate(IBQ_Matriz.FieldByName('DATAALTERACAO').AsString)>=StrToDate(f_Troca('.','/',f_Troca('-','/',sgDtaInicio)))) Then
            Begin
              DMBelShop.CDS_Join.Locate('IND_CURVA','E',[]);
              MySql:=DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsString;
              DMBelShop.CDS_Join.Insert;
              DMBelShop.CDS_Join.FieldByName('COD_LOJA').AsString:=sCodMatriz;
              DMBelShop.CDS_Join.FieldByName('COD_PRODUTO').AsString:=IBQ_Matriz.FieldByName('COD_ITEM').AsString;
              DMBelShop.CDS_Join.FieldByName('IND_CURVA').AsString:='E';
              DMBelShop.CDS_Join.FieldByName('DATAINCLUSAO').AsString:=IBQ_Matriz.FieldByName('DATAINCLUSAO').AsString;
              DMBelShop.CDS_Join.FieldByName('EST_MINIMO').AsString:='3';
              DMBelShop.CDS_Join.FieldByName('USAR_CURVA').AsString:='SIM';
              DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsString:=MySql;
            End
           Else
            Begin
              bgProcCurva:=False;
              b:=True;
            End;
         End;
      End; // While Not b do // Verifica se Existe na Tabela ES_FINAN_CURVA_ABC

      // Ultima Compra ----------------------------------------------
      sDta_Ref:='';
      sCodForn:='';
      sNomeForn:='';
      cQuant_Ref:=0;
      cPreco:=0;
      cPrecoUnit:=0;
      cVlr_Total_Ref:=0;

      s :=IBQ_Matriz.FieldByName('COD_EMPRESA').AsString;
      ss:=IBQ_Matriz.FieldByName('COD_ITEM').AsString;
      If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'UC']),[]) Then
       Begin
         sDta_Ref      :=DMBelShop.CDS_UltCompraTransito.FieldByName('Dta_Ref').AsString;
         sCodForn      :=DMBelShop.CDS_UltCompraTransito.FieldByName('CodFornecedor').AsString;
         sNomeForn     :=DMBelShop.CDS_UltCompraTransito.FieldByName('NomeFornecedor').AsString;
         cQuant_Ref    :=DMBelShop.CDS_UltCompraTransito.FieldByName('Quant_Ref').AsCurrency;
         cPreco        :=DMBelShop.CDS_UltCompraTransito.FieldByName('Preco').AsCurrency;
         cPrecoUnit    :=DMBelShop.CDS_UltCompraTransito.FieldByName('Preco').AsCurrency;
         cVlr_Total_Ref:=DMBelShop.CDS_UltCompraTransito.FieldByName('Vlr_Total_Ref').AsCurrency;
       End
      Else If DMBelShop.CDS_UltCompraTransito.Locate('CodProduto;Tipo',VarArrayOf([ss, 'UC']),[]) Then
       Begin
         cPrecoUnit    :=DMBelShop.CDS_UltCompraTransito.FieldByName('Preco').AsCurrency;
       End;// If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'UC']),[]) Then

      // Transito ---------------------------------------------------
      cQtdTransito:=0;
      If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'TR']),[]) Then
      Begin
        cQtdTransito  :=DMBelShop.CDS_UltCompraTransito.FieldByName('Quant_Ref').AsCurrency;
      End; // If DMBelShop.CDS_UltCompraTransito.Locate('CodFilial;CodProduto;Tipo',VarArrayOf([s, ss, 'TR']),[]) Then

      // Inicializa Variaveis de Demanda ---------------------------------------
      igNrDias:=0;
      igNrMeses:=0;
      cgOutras_Demandas:=0;
      cgTotal_Demandas:=0;

      // Busca Demandas e Totais Dias para Mes 1 -------------------------------
      bgDemandaNovo:=True;
//      bgDemandaNovo:=False;

      BuscaDemanda(CB_Mes1, ME_Ano1, IBQ_Matriz.FieldByName('Cod_Item').AsString,
                   IBQ_Matriz.FieldByName('Cod_Empresa').AsString, cDemanda,
                   igNrDias, igNrMeses, True);
      bgDemandaNovo:=False;

      // Tributao ------------------------------------------------------------
      If (sCOD_ICMS  <>IBQ_Matriz.FieldByName('COD_ICMS').AsString) Or
         (sEstado    <>IBQ_Matriz.FieldByName('Estado').AsString)   Or
         (sTIP_PESSOA<>IBQ_Matriz.FieldByName('TIP_PESSOA').AsString) Then
      Begin
        sCodICM           :='';
        sSittributaria    :='';
        sSubstituicao     :='';
        sSomaIPIBase      :='N';
        sSomaFreteBase    :='N';
        sSomaDespesaBase  :='N';
        sSomaIPIBaseSubst :='N';
        sSomaFreteBaseST  :='N';
        sSomaDespesaBaseST:='N';
        cReducao          :=0;
        cAliquota         :=0;
        cSubstMargem      :=0;
        sSubstValPer      :='P';
        cSubstAliquota    :=0;
        cAliqRepasse      :=0;

        sCOD_ICMS  :=IBQ_Matriz.FieldByName('COD_ICMS').AsString;
        sEstado    :=IBQ_Matriz.FieldByName('Estado').AsString;
        sTIP_PESSOA:=IBQ_Matriz.FieldByName('TIP_PESSOA').AsString;

        If IBQ_ConsultaMatriz.Locate('CODICM;CODESTADO;REVENDACONSUMOFJ',VarArrayOf([sCOD_ICMS,sEstado,sTIP_PESSOA]),[]) Then
        Begin
          sCodICM           :=IBQ_ConsultaMatriz.FieldByName('CODICM').AsString;
          sSittributaria    :=IBQ_ConsultaMatriz.FieldByName('SITTRIBUTARIA').AsString;
          sSomaIPIBase      :=IBQ_ConsultaMatriz.FieldByName('SOMAIPIBASE').AsString;
          sSomaFreteBase    :=IBQ_ConsultaMatriz.FieldByName('SOMAFRETEBASE').AsString;
          sSomaDespesaBase  :=IBQ_ConsultaMatriz.FieldByName('SOMADESPESABASE').AsString;
          sSubstituicao     :=IBQ_ConsultaMatriz.FieldByName('SUBSTITUICAO').AsString;
          sSubstValPer      :=IBQ_ConsultaMatriz.FieldByName('SUBSTVALPER').AsString;
          sSomaIPIBaseSubst :=IBQ_ConsultaMatriz.FieldByName('SOMAIPIBASESUBST').AsString;
          sSomaFreteBaseST  :=IBQ_ConsultaMatriz.FieldByName('SOMAFRETEBASEST').AsString;
          sSomaDespesaBaseST:=IBQ_ConsultaMatriz.FieldByName('SOMADESPESABASEST').AsString;
          cAliquota         :=IBQ_ConsultaMatriz.FieldByName('ALIQUOTA').AsCurrency;
          cReducao          :=IBQ_ConsultaMatriz.FieldByName('REDUCAO').AsCurrency;
          cSubstMargem      :=IBQ_ConsultaMatriz.FieldByName('SUBSTMARGEM').AsCurrency;
          cSubstAliquota    :=IBQ_ConsultaMatriz.FieldByName('SUBSTALIQUOTA').AsCurrency;
          cAliqRepasse      :=IBQ_ConsultaMatriz.FieldByName('ALIQREPASSE').AsCurrency;
        End; // If IBQ_ConsultaMatriz.Locate('CODICM;CODESTADO;REVENDACONSUMOFJ',VarArrayOf([sCOD_ICMS,sEstado,sTIP_PESSOA]),[]) Then
      End; // If (sCOD_ICMS  <>IBQ_Matriz.FieldByName('COD_ICMS').AsString) Or

      // Num_Seq de Documento --------------------------------------------------
      If bgProcCurva Then
       Inc(iNumSeqDoc);

      // Insere Documento OC_COMPRAR -------------------------------------------
      DMBelShop.IBQ_OC_ComprarAdd.Insert;
      For i:=0 to IBQ_Matriz.FieldCount-1 do
      Begin
        // Trata Campos =============================================


        If (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='NUM_SEQ') and (bgProcCurva) Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=iNumSeqDoc

        Else If (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='NUM_SEQ') and (Not bgProcCurva) Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=9999999

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='NUM_DOCUMENTO' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=StrToInt(sNumDoc)

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='CLA_CURVA_ABC' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=DMBelShop.CDS_Join.FieldByName('IND_CURVA').AsString

        Else If (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='VLR_UNI_COMPRA') And (cPrecoUnit<>0) Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cPrecoUnit

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='DTA_ULT_COMPRA') And (sDta_Ref<>'') Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sDta_Ref

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='COD_FOR_ULT_COMPRA') And (sDta_Ref<>'') Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sCodForn

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='DES_FOR_ULT_COMPRA') And (sDta_Ref<>'') Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sNomeForn

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_ULT_COMPRA') And (sDta_Ref<>'') Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cQuant_Ref

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='VLR_UNI_ULT_COMPRA') And (sDta_Ref<>'') Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cPreco

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='VLR_TOT_ULT_COMPRA') And (sDta_Ref<>'') Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cVlr_Total_Ref

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_TRANSITO') And (cQtdTransito>0) Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cQtdTransito

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DISPONIVEL') And (cQtdTransito>0) Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cQtdTransito+
                                DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES1') And (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem1').AsString)<>'') Then
         Begin
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem1').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem1').AsCurrency;
         End

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES2') And (StrToIntDef(sMes2,0)<>0) And
                (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem2').AsString)<>'') Then
         Begin
           cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem2').AsCurrency;
         End

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES3') And (StrToIntDef(sMes3,0)<>0) And
                (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem3').AsString)<>'') Then
         Begin
           cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem3').AsCurrency;
         End

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES4') And (StrToIntDef(sMes4,0)<>0) And
                (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem4').AsString)<>'') Then
         Begin
           cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem4').AsCurrency;
         End

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES5') And (StrToIntDef(sMes5,0)<>0) And
                (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem5').AsString)<>'') Then
         Begin
           cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem5').AsCurrency;
         End

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES6') And (StrToIntDef(sMes6,0)<>0) And
                (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem6').AsString)<>'') Then
         Begin
           cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem6').AsCurrency;
         End

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES7') And (StrToIntDef(sMes7,0)<>0) And
                (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem7').AsString)<>'') Then
         Begin
           cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem7').AsCurrency;
         End

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEM_MES8') And (StrToIntDef(sMes8,0)<>0) And
                (Trim(DMBelShop.CDS_Demandas.FieldByName('Dem8').AsString)<>'') Then
         Begin
           cgOutras_Demandas:=cgOutras_Demandas+
                                  DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
           cgTotal_Demandas:=cgTotal_Demandas+
                                DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
           DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=
                                 DMBelShop.CDS_Demandas.FieldByName('Dem8').AsCurrency;
         End

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_NR_DIAS' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igNrDias

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_NR_MESES' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igNrMeses

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_TOT_MESES' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igTotMeses

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_MEDIA_MES' Then
         iQtdMediaMes:=i

        Else if (AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_MEDIA_DIA') Then
         iQtdMediaDia:=i

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='COD_SIT_TRIBUTARIA' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSittributaria

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='IND_SOMA_IPI_BASE_ICMS' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSomaIPIBase

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='IND_SOMA_FRETE_BASE_ICMS' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSomaFreteBase

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='IND_SOMA_DESPESA_BASE_ICMS' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSomaDespesaBase

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='IND_SOMA_IPI_BASE_ST' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSomaIPIBaseSubst

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='IND_SOMA_FRETE_BASE_ST' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSomaFreteBaseST

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='IND_SOMA_DESPESA_BASE_ST' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSomaDespesaBaseST

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='PER_REDUCAO_ICMS' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cReducao

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='PER_ICMS' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cAliquota

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='PER_MARGEM_ST' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cSubstMargem

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='IND_ST' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSubstValPer

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='SUBSTALIQUOTA' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cSubstAliquota

        Else if AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='PER_REPASSE' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cAliqRepasse

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='EST_MINIMO' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=DMBelShop.CDS_Join.FieldByName('EST_MINIMO').AsInteger

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='DIAS_ESTOCAGEM' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=DMBelShop.CDS_Join.FieldByName('DIAS_ESTOCAGEM').AsInteger

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEMANDA_DIA' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cgDemAnoDia

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DEMANDA_ANO' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsCurrency:=cgDemAno

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_DIAS_ANO' Then
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsInteger:=igNrDiasAno

        Else If AnsiUpperCase(IBQ_Matriz.Fields[i].FieldName)='QTD_TRANSF_ANO' Then // Saldo Linx
         Begin
           If Trim(sSaldoLinx)='' Then
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=Unassigned
           Else
            DMBelShop.IBQ_OC_ComprarAdd.Fields[i].AsString:=sSaldoLinx;
         End

        Else // Outros Campos
         DMBelShop.IBQ_OC_ComprarAdd.Fields[i].Assign(IBQ_Matriz.Fields[i]);

      End; // For i:=0 to IBQ_Matriz.FieldCount-1 do

      // Acerta Media (QTD_MEDIA_MES) ============================================
      If igNrMeses<igTotMeses Then
       Begin
         If igNrMeses<>0 Then
          cMediaMes:=RoundTo((cgOutras_Demandas/igNrMeses),-4)
         Else
          cMediaMes:=0;
       End
      Else
       Begin
         cMediaMes:=RoundTo((cgTotal_Demandas/igTotMeses),-4);
       End; // If igNrMeses<igTotMeses Then

       DMBelShop.IBQ_OC_ComprarAdd.Fields[iQtdMediaMes].AsCurrency:=cMediaMes;

      // Acerta Media (QTD_MEDIA_DIA) ============================================
      If igNrDias<>0 Then
       DMBelShop.IBQ_OC_ComprarAdd.Fields[iQtdMediaDia].AsCurrency:=RoundTo((cgTotal_Demandas/igNrDias),-4)
      Else
       DMBelShop.IBQ_OC_ComprarAdd.Fields[iQtdMediaDia].AsCurrency:=0;

      DMBelShop.IBQ_OC_ComprarAdd.Post;

      IBQ_Matriz.Next;
    End; // While not IBQ_Matriz.Eof do

    // Atualiza Transacao ======================================================
    DMBelShop.IBQ_OC_ComprarAdd.ApplyUpdates;
    DMBelShop.IBT_BelShop.CommitRetaining;
    DMBelShop.IBT_BelShop.Commit;

    IBQ_ConsultaMatriz.Close;
    DMBelShop.CDS_DemandasNovo.Close;
    DMBelShop.IBQ_OC_ComprarAdd.Close;
    IBQ_Matriz.Close;

    // Atualiza OC_COMPRAR_DOCS ================================================
    OC_COMPRAR_DOCS('I', sNumDoc, 'BelShop');

    MontaProgressBar(False, FrmBelShop);
    OdirPanApres.Visible:=False;

    Lb_EmpProcessadas.Caption:=IntToStr(StrToInt(Lb_EmpProcessadas.Caption)+1);

    Result:=True;
  Except // Try // IBQ_OC_ComprarAdd
    On e : Exception do
    Begin
      // Abandona Transacao ====================================================
      OdirPanApres.Visible:=False;
      MontaProgressBar(False, FrmBelShop);
      DMBelShop.IBT_BelShop.Rollback;

      Screen.Cursor:=crDefault;

      IBQ_ConsultaMatriz.Close;
      DMBelShop.CDS_DemandasNovo.Close;
      IBQ_Matriz.Close;
      DMBelShop.CDS_Join.Close;
      DMBelShop.CDS_UltCompraTransito.Close;
      DMBelShop.IBQ_OC_ComprarAdd.Close;

      msg('Erro na Gerao dos Produtos !!'+cr+cr+'Filial: '+sCodMatriz +' !!','A');
      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // On e : Exception do
  End; // Try // IBQ_OC_ComprarAdd
End; // Novo Calculode Pedido de Compra da Matriz >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Busca Produtos para Analise >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.BuscaProdutosAnalise: Boolean;
Var
  MySql: String;
Begin
  Result:=False;

  Screen.Cursor:=crAppStart;

  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Grupos e SubGrupos Selecionados ===========================================
  sgGrupos:='';
  sgSubGrupos:='';
  If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GruposProdutos.First;
    While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    Begin
      Refresh;

      If sgGrupos='' Then
       sgGrupos:='(gr.codgrupo='+
                     QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString)
      Else
       sgGrupos:=sgGrupos+' Or gr.codgrupo='+
                    QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString);

      If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
      Begin
        While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        Begin
          Refresh;

          If sgSubGrupos='' Then
           sgSubGrupos:=QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString)
          Else
           sgSubGrupos:=sgSubGrupos+', '+
              QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString);

          DMVirtual.CDS_V_SubGruposProdutos.Next;
        End; // While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
        DMVirtual.CDS_V_SubGruposProdutos.First;

      End; // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then

      If sgSubGrupos<>'' Then
       sgGrupos:=sgGrupos+' and pr.codgruposub in ('+sgSubGrupos+')';

      sgSubGrupos:='';

      DMVirtual.CDS_V_GruposProdutos.Next;
    End; // While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    DMVirtual.CDS_V_GruposProdutos.First;

    If sgGrupos<>'' Then
     sgGrupos:=sgGrupos+')';

  End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then

  // Aplicacoes Selecionadas ===================================================
  sgAplicacoes:='';
  If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then
  Begin

    DMVirtual.CDS_V_Aplicacao.First;
    While Not DMVirtual.CDS_V_Aplicacao.Eof do
    Begin
      Refresh;

      If sgAplicacoes='' Then
       sgAplicacoes:=QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString)
      Else
       sgAplicacoes:=sgAplicacoes+', '+
                     QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString);

      DMVirtual.CDS_V_Aplicacao.Next;
    End; // While Not DMVirtual.CDS_V_Aplicacao.Eof do
    DMVirtual.CDS_V_Aplicacao.First;

  End; // If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then

  // Familias Preos Selecionadas ==============================================
  sgFamiliaPrecos:='';
  If Not DMVirtual.CDS_V_FamiliaPrecos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_FamiliaPrecos.First;
    While Not DMVirtual.CDS_V_FamiliaPrecos.Eof do
    Begin
      Refresh;

      If sgFamiliaPrecos='' Then
       sgFamiliaPrecos:=
               QuotedStr(DMVirtual.CDS_V_FamiliaPrecosCod_FamiliaPreco.AsString)
      Else
       sgFamiliaPrecos:=sgFamiliaPrecos+', '+
              QuotedStr(DMVirtual.CDS_V_FamiliaPrecosCod_FamiliaPreco.AsString);

      DMVirtual.CDS_V_FamiliaPrecos.Next;
    End; // While Not DMVirtual.CDS_V_FamiliaPrecos.Eof do
    DMVirtual.CDS_V_FamiliaPrecos.First;

  End; // If Not DMVirtual.CDS_V_FamiliaPrecos.IsEmpty Then

  // Grupos ST =================================================================
  sgGruposST:='';
  If Not DMVirtual.CDS_V_GrupoST.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GrupoST.First;
    While Not DMVirtual.CDS_V_GrupoST.Eof do
    Begin
      Refresh;

      If sgGruposST='' Then
       sgGruposST:=QuotedStr(DMVirtual.CDS_V_GrupoSTCod_GrupoST.AsString)
      Else
       sgGruposST:=sgGruposST+', '+
                         QuotedStr(DMVirtual.CDS_V_GrupoSTCod_GrupoST.AsString);

      DMVirtual.CDS_V_GrupoST.Next;
    End; // While Not DMVirtual.CDS_V_GrupoST.Eof do
    DMVirtual.CDS_V_GrupoST.First;

  End; // If Not DMVirtual.CDS_V_GrupoST.IsEmpty Then

  sgCurvas:='';
  // Curva ABC dos Produtos por Loja ou MPMS -----------------------------------
  If Not (Rb_CalculoTpCurvaABCMix.Checked) Then
  Begin
    If Not Ckb_CalculoCurvaTodas.Checked Then
    Begin
      If Ckb_CalculoCurvaA.Checked Then
       sgCurvas:=QuotedStr('A');

      If Ckb_CalculoCurvaB.Checked Then
      Begin
        If sgCurvas='' Then
         sgCurvas:=QuotedStr('B')
        Else
         sgCurvas:=sgCurvas+', '+QuotedStr('B');
      End;

      If Ckb_CalculoCurvaC.Checked Then
      Begin
        If sgCurvas='' Then
         sgCurvas:=QuotedStr('C')
        Else
         sgCurvas:=sgCurvas+', '+QuotedStr('C');
      End;

      If Ckb_CalculoCurvaD.Checked Then
      Begin
        If sgCurvas='' Then
         sgCurvas:=QuotedStr('D')
        Else
         sgCurvas:=sgCurvas+', '+QuotedStr('D');
      End;

      If Ckb_CalculoCurvaE.Checked Then
      Begin
        If sgCurvas='' Then
         sgCurvas:=QuotedStr('E')
        Else
         sgCurvas:=sgCurvas+', '+QuotedStr('E');
      End;
    End; // If Not Ckb_CalculoCurvaTodas.Checked Then
  End; //   If Not (Rb_CalculoTpCurvaABCMix.Checked) Then

  // Curva ABC dos Produtos por Mix de Loja ------------------------------------
  If Rb_CalculoTpCurvaABCMix.Checked Then
   BuscaMixLoja(sCodMatriz);

  If Trim(sgCurvas)='' Then
   sgCurvas:=QuotedStr('A')+', '+QuotedStr('B')+', '+QuotedStr('C')+', '+
             QuotedStr('D')+', '+QuotedStr('E');

  sgDtaInicio:=DateToStr(DtEdt_CalculoProdNovos.Date);
  sgDtaInicio:=f_Troca('/','.',sgDtaInicio);
  sgDtaInicio:=f_Troca('-','.',sgDtaInicio);

  // ODIR 1
  // Busca Produtos MPMS =======================================================
  MySqlSelect:=' SELECT 0 NUM_SEQ, 0 NUM_DOCUMENTO, current_timestamp DTA_DOCUMENTO,'+
               ' ''N'' IND_OC_GERADA, NULL DTA_OC_GERADA, NULL NUM_OC_GERADA,'+
               QuotedStr('Calculado em: '+DateTimeToStr(DataHoraServidorFI(
                                          DMBelShop.SDS_DtaHoraServidor))+' por '+Des_Usuario)+' OBS_OC,'+
               ' fi.codfilial COD_EMPRESA, TRIM(cl.nomecliente) DES_EMPRESA,'+
               ' pr.codproduto COD_ITEM, TRIM(pr.apresentacao) DES_ITEM,'+
               ' 0 QTD_SUGERIDA, 0 QTD_ACOMPRAR,'+
               ' COALESCE(es.saldoatual,0) QTD_SALDO,'+
               ' 0 QTD_TRANSITO,'+
               ' COALESCE(es.saldoatual,0) QTD_DISPONIVEL,'+
               ' 0 QTD_MEDIA_MES, 0 QTD_MEDIA_DIA,'+
               ' 0 QTD_DEM_MES1, 0 QTD_DEM_MES2, 0 QTD_DEM_MES3, 0 QTD_DEM_MES4,'+
               ' 0 QTD_DEM_MES5, 0 QTD_DEM_MES6, 0 QTD_DEM_MES7, 0 QTD_DEM_MES8,'+
               ' COALESCE(pf.unidadecaixa,1) UNI_COMPRA,'+
               ' COALESCE(pr.unidadeestoque,1) UNI_VENDA,'+
               ' TRIM(pr.codbarra) COD_BARRAS,'+
               ' gr.codgrupo COD_GRUPO, TRIM(gr.nomegrupo) DES_GRUPO,'+
               ' gs.codsubgrupo COD_SUBGRUPO, TRIM(gs.nomesubgrupo) DES_SUBGRUPO,'+
               ' TRIM(pr.nomegenerico) DES_GENERICO,'+
               ' pr.codaplicacao COD_APLICACAO, TRIM(ap.nomeaplicacao) DES_APLICACAO,'+
               ' SUBSTRING(TRIM(pr.referencia) FROM 1 FOR 30) COD_REFERENCIA,'+
               ' ''A'' CLA_CURVA_ABC,'+
               ' pr.codfamiliapreco COD_FAMILIA_PRECO, TRIM(fp.nomefamiliapreco) DES_FAMILIA_PRECO,'+
               ' NULL DTA_ULT_COMPRA, NULL COD_FOR_ULT_COMPRA, NULL DES_FOR_ULT_COMPRA,'+
               ' NULL QTD_ULT_COMPRA, NULL VLR_UNI_ULT_COMPRA, NULL VLR_TOT_ULT_COMPRA,'+
               ' CAST(ROUND((COALESCE(lp.precocompra,0)-((COALESCE(lp.precocompra,0)*'+
               '             COALESCE(ip.ALIQUOTA,0))/100)),2) AS NUMERIC(12,2)) VLR_UNI_COMPRA,'+

               ' 0 PER_DESCONTO,'+
               ' NULL DTA_ULT_VENDA, NULL COD_CLI_ULT_VENDA, NULL DES_CLI_ULT_VENDA,'+
               ' NULL QTD_ULT_VENDA, NULL VLR_UNI_ULT_VENDA, NULL VLR_TOT_ULT_VENDA,'+
               ' CAST(ROUND(COALESCE(lp.precovenda,0),2) AS NUMERIC(12,2)) VLR_UNI_VENDA,'+
               QuotedStr(sgCodListaPrePadrao)+' COD_LISTA_VENDA,  '+QuotedStr(Trim(sgDesListaPrePadrao))+' DES_LISTA_VENDA,'+
               QuotedStr(sgCodListaPrePadrao)+' COD_LISTA_COMPRA, '+QuotedStr(Trim(sgDesListaPrePadrao))+' DES_LISTA_COMPRA,'+
               ' COALESCE(es.customedio,0) VLR_CUSTO_MEDIO, 0 VLR_TOT_VENDA, 0 VLR_TOT_COMPRA,'+
               ' 0 VLR_BRUTO, 0 VLR_DESCONTOS, 0 VLR_DESPESAS, 0 VLR_FRETE,'+
               ' ''N'' IND_SOMA_IPI_BASE_ICMS, ''N'' IND_SOMA_FRETE_BASE_ICMS,'+
               ' ''N'' IND_SOMA_DESPESA_BASE_ICMS, ''N'' IND_SOMA_IPI_BASE_ST,'+
               ' ''N'' IND_SOMA_FRETE_BASE_ST, ''N'' IND_SOMA_DESPESA_BASE_ST,'+
               ' NULL COD_SIT_TRIBUTARIA,'+
               ' pr.codipicompra COD_IPI, COALESCE(ip.ipipercouvalor,''P'') IND_IPI,'+
               ' COALESCE(ip.aliquota,0) PER_IPI, 0 VLR_IPI,'+
               ' pr.codicmcompra COD_ICMS, 0 PER_REDUCAO_ICMS,'+
               ' 0 VLR_REDUCAO_ICMS, 0 VLR_BASE_ICMS, 0 PER_ICMS, 0 VLR_ICMS,'+
               ' pr.grupostmva COD_GRUPO_ST,';

  MySqlClausula1:='CASE pr.grupostmva'+
                  '   when  0 Then ''No usa'''+
                  '   when  1 Then ''Autopeas'''+
                  '   when  2 Then ''Rao'''+
                  '   when  3 Then ''Colches'''+
                  '   when  4 Then ''Cosmticos'''+
                  '   when  5 Then ''Arroz beneficiado'''+
                  '   when  6 Then ''Correias de Transmisso e Rolamentos'''+
                  '   when  7 Then ''Tintas e Vernizes'''+
                  '   when  8 Then ''Sucos de Frutas e Bebidas no Alcolicas'''+
                  '   when  9 Then ''Ferramentas'''+
                  '   when 10 Then ''Materiais Eltricos'''+
                  '   when 11 Then ''Mat. Construo, Acabamento, Bricolagem ou Adorno'''+
                  '   when 12 Then ''Bicicletas'''+
                  '   when 13 Then ''Brinquedos'''+
                  '   when 14 Then ''Material de Limpeza'''+
                  '   when 15 Then ''Produtos Alimentcios'''+
                  '   when 16 Then ''Artefatos de Uso Domstico'''+
                  '   when 17 Then ''Bebidas Quentes'''+
                  '   when 18 Then ''Artigos de Papelaria'''+
                  '   when 19 Then ''Instrumentos Musicais'''+
                  '   when 20 Then ''Prod. Eletronicos, Eletroeletronicos, Eletrodomsticos'''+
                  ' END DES_GRUPO_ST,'+

                  ' 0 PER_MARGEM_ST, NULL IND_ST, 0 VLR_BASE_ST, 0 PER_ST, 0 VLR_ST,'+
                  ' 0 PER_REPASSE, 0 VLR_REPASSE, ''012'' COD_COMPROVANTE_ICMS,'+
                  ' SUBSTRING(TRIM(pf.codauxiliar) FROM 1 FOR 30) COD_REFERENCIA_FORN,'+
                  ' fo.codfornecedor COD_FORNECEDOR, TRIM(fo.nomefornecedor) DES_FORNECEDOR,'+
                  ' fo.pessoa TIP_PESSOA, TRIM(fo.email) DES_EMAIL,'+
                  ' 0 QTD_NR_DIAS, 0 QTD_NR_MESES, 0 QTD_TOT_MESES,'+
                  QuotedStr(Cod_Usuario)+' COD_COMPRADOR,'+
                  QuotedStr('Aberturta do Aplicativo: '+sgDataHoraAplicativo)+'|| ascii_char(13) ||'+
                  QuotedStr('Calculado em: '+DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+
                                            ' por '+Des_Usuario)+' BLOB_TEXTO,'+

                  ' ''N'' IND_TRANSF, NULL DTA_LIM_TRANSF, 0 QTD_TRANSF, ''SIM'' IND_USAR, 0 IND_QTD_ACIMA,'+
                  ' 0 QTD_SUGERIDA_ANO, 0 QTD_TRANSF_PERIODO, 0 QTD_TRANSF_ANO, 0 EST_MINIMO,'+
                  ' 0 DIAS_ESTOCAGEM, 0 QTD_DEMANDA_DIA, 0 QTD_DEMANDA_ANO, 0 QTD_DIAS_ANO,'+
                  ' pr.DataInclusao, TRIM(fo.Estado) Estado, pr.DATAALTERACAO';

  MySqlClausula2:=' FROM produto pr'+
                  '        left join filial fi    on fi.codfilial='+QuotedStr(sCodMatriz)+
                  '        left join estoque es   on es.codproduto=pr.codproduto'+
                  '                              and es.codfilial = fi.codfilial'+
                  '        left join cliente cl   on cl.codcliente=fi.codnocliente'+
                  '        left join gruposub gs  on gs.codgruposub=pr.codgruposub'+
                  '        left join grupo gr     on gs.codgrupo=gr.codgrupo'+
                  '        left join aplica ap    on ap.codaplicacao=pr.codaplicacao'+
                  '        left join forneced fo  on fo.codfornecedor=pr.principalfor'+
                  '        left join familiap fp  on fp.codfamiliapreco=pr.codfamiliapreco'+
                  '        left join produfor pf  on pf.chaveforpro=pr.principalfor||pr.codproduto'+
                  '        left join listapre lp  on lp.codproduto=pr.codproduto'+
                  '                              and lp.codlista='+QuotedStr(sgCodListaPrePadrao)+
                  '        left join ipis ip      on ip.codipi=pr.codipicompra';

                 // Produtos No Compra -------------------------------------
                 If Not Ckb_FiltroProdNaoCompra.Checked Then
                  MySqlClausula2:=
                   MySqlClausula2+' where Coalesce(pr.situacaopro,0)=0'
                 Else
                  MySqlClausula2:=
                   MySqlClausula2+' where Coalesce(pr.situacaopro,0) in (0,3)';

                 // Produtos Codigos e/ou Produtos Like ---------------------
                 If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                  MySqlClausula2:=
                   MySqlClausula2+' AND (pr.CodProduto in ('+sgProdutos+') Or '+sgLikeProdutos+')'
                 Else If Trim(sgProdutos)<>'' Then
                  MySqlClausula2:=
                   MySqlClausula2+' and pr.CodProduto in ('+sgProdutos+')'
                 Else If Trim(sgLikeProdutos)<>'' Then
                  MySqlClausula2:=
                   MySqlClausula2+' AND'+sgLikeProdutos;

                 // Fornecedores --------------------------------------------
                 If Trim(sgFornecedores)<>'' Then
                  MySqlClausula2:=
                   MySqlClausula2+' and pr.principalfor in ('+sgFornecedores+')'
                 Else
                  MySqlClausula2:=
                   MySqlClausula2+' AND pr.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

                 // Grupos e SubGrupos --------------------------------------
                 If Trim(sgGrupos)<>'' Then
                  MySqlClausula2:=
                   MySqlClausula2+' and '+sgGrupos;

                 // Aplicacoes ----------------------------------------------
                 If Trim(sgAplicacoes)<>'' Then
                  MySqlClausula2:=
                   MySqlClausula2+' and pr.CodAplicacao in ('+sgAplicacoes+')';

                 // Familias Preos -----------------------------------------
                 If Trim(sgFamiliaPrecos)<>'' Then
                  MySqlClausula2:=
                   MySqlClausula2+' and pr.CodFamiliaPreco in ('+sgFamiliaPrecos+')';

                 // Grupos ST -----------------------------------------------
                 If Trim(sgGruposST)<>'' Then
                  MySqlClausula2:=
                   MySqlClausula2+' and pr.grupostmva in ('+sgGruposST+')';

                 If bgECommerce Then
                  MySqlClausula2:=
                   MySqlClausula2+' and pr.ECOMMERCE_SN='+QuotedStr('S');

  MySqlOrderGrup:=' order by pr.apresentacao, pr.codicmcompra, fo.Estado';
  IBQ_Matriz.Close;
  IBQ_Matriz.SQL.Clear;
  IBQ_Matriz.SQL.Add(MySqlSelect+MySqlClausula1+MySqlClausula2+MySqlOrderGrup);
  IBQ_Matriz.Open;

  sgDtaDoc:=DateToStr(IBQ_Matriz.FieldByName('DTA_DOCUMENTO').AsDateTime);
  Try
    sgDtaDoc:=DateToStr(StrToDateTime(sgDtaDoc));
  Except
    Try
      sgDtaDoc:=DateToStr(StrToDateTime(f_Troca('.','/',f_Troca('-','/',sgDtaDoc))));
    Except
      sgDtaDoc:=DateToStr(StrToDateTime(f_Troca('/','.',f_Troca('-','.',sgDtaDoc))));
    End;
  End;

  Screen.Cursor:=crDefault;
  OdirPanApres.Visible:=False;

  If Not IBQ_Matriz.IsEmpty Then
   Begin
     // Busca Curvas Selecionadas e Estoque Minino Produtos
     MySql:=' SELECT c.cod_loja, c.cod_produto, c.ind_curva,'+
            ' p.datainclusao, c.est_minimo,'+
            ' CASE'+
            '   When (c.ind_curva in ('+sgCurvas+') or (p.datainclusao>='+QuotedStr(sgDtaInicio)+'))  and (c.est_minimo>0)  Then'+
            '    ''SIM'''+
            '   Else'+
            '    ''NAO'''+
            ' END Usar_Curva,'+
            ' COALESCE(T.vlr_aux,0) Dias_Estocagem'+

            ' FROM ES_FINAN_CURVA_ABC c'+
            '        LEFT JOIN PRODUTO p ON c.cod_produto=p.codproduto'+
            '        LEFT JOIN TAB_AUXILIAR t ON CASE'+
            '                                       WHEN c.ind_curva=''A'' THEN 1'+
            '                                       WHEN c.ind_curva=''B'' THEN 2'+
            '                                       WHEN c.ind_curva=''C'' THEN 3'+
            '                                       WHEN c.ind_curva=''D'' THEN 4'+
            '                                       WHEN c.ind_curva=''E'' THEN 5'+
            '                                    END=t.cod_aux'+

            ' WHERE t.tip_aux=2'+
// Retira Conforme Solicitao da ANNA - 12/05/2017
//            ' AND   c.est_minimo>0'+
            ' AND   c.cod_loja='+QuotedStr(sCodMatriz);

            // Produtos No Compra -------------------------------------
            If Not Ckb_FiltroProdNaoCompra.Checked Then
             MySql:=
              MySql+' AND Coalesce(p.situacaopro,0)=0'
            Else
             MySql:=
              MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';

            // Produtos Codigos e/ou Produtos Like ---------------------
            If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
             MySql:=
              MySql+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.',sgLikeProdutos)+')'
            Else If Trim(sgProdutos)<>'' Then
             MySql:=
              MySql+' AND p.CodProduto in ('+sgProdutos+')'
            Else If Trim(sgLikeProdutos)<>'' Then
             MySql:=
              MySql+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

            // Fornecedores --------------------------------------------
            If Trim(sgFornecedores)<>'' Then
             MySql:=
              MySql+' and p.principalfor in ('+sgFornecedores+')'
            Else
             MySql:=
              MySql+' AND p.principalfor Not in (''010000'', ''000300'', ''000500'', ''001072'')';

            If bgECommerce Then
             MySql:=
              MySql+' and p.ECOMMERCE_SN='+QuotedStr('S');

     MySql:=
      MySql+' ORDER BY 2';
     DMBelShop.CDS_Join.Close;
     DMBelShop.SDS_Join.CommandText:=MySql;
     DMBelShop.CDS_Join.Open;
   End
  Else // If Not IBQ_Matriz.IsEmpty Then
   Begin
     msg('SEM Produto para Analisar !!','A');
     Exit;
   End; // If Not IBQ_Matriz.IsEmpty Then

  Result:=True;
End; // Busca Produtos para Analise >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Inicializa Meses para Busca de Demandas para Calculo de Mdias >>>>>>>>>>>>>>
Procedure TFrmBelShop.InicializaMeses;
Var
  Dt1: TDate;
  i, Index:Integer;
begin

  OrderGrid:='';

  // Acerta Meses de Calculo ===================================================
  DecodeDate(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), wgAnoH, wgMesH, wgDiaH);

  // Pega Mes Corrente s se mais de 14 Dias ===================================
  If (wgDiaH<15) and (wgMesH>1) Then
   wgMesH:=wgMesH-1;

  For i:=1 to 4 do
  Begin
    Dt1:=EncodeDate(wgAnoH, wgMesH, 1);
//    wgMesH:=wgMesH-1;

    if wgMesH=1  Then Index:= 0;
    if wgMesH=2  Then Index:= 1;
    if wgMesH=3  Then Index:= 2;
    if wgMesH=4  Then Index:= 3;
    if wgMesH=5  Then Index:= 4;
    if wgMesH=6  Then Index:= 5;
    if wgMesH=7  Then Index:= 6;
    if wgMesH=8  Then Index:= 7;
    if wgMesH=9  Then Index:= 8;
    if wgMesH=10 Then Index:= 9;
    if wgMesH=11 Then Index:=10;
    if wgMesH=12 Then Index:=11;

    If i=1 Then
    Begin
      CB_Mes1.ItemIndex:=Index;
      ME_Ano1.Text:=IntToStr(wgAnoH)
    End;

    If i=2 Then
    Begin
      CB_Mes2.ItemIndex:=Index+1;
      ME_Ano2.Text:=IntToStr(wgAnoH);
    End;

    If i=3 Then
    Begin
      CB_Mes3.ItemIndex:=Index+1;
      ME_Ano3.Text:=IntToStr(wgAnoH);
    End;

    If i=4 Then
    Begin
      CB_Mes4.ItemIndex:=Index+1;
      ME_Ano4.Text:=IntToStr(wgAnoH);
    End;

    Dt1:=Dt1-1;
    DecodeDate(Dt1, wgAnoH, wgMesH, wgDiaH);
  End;
End; // Inicializa Meses para Busca de Demandas para Calculo de Mdias >>>>>>>>>

// Cria e Atualiza Conexao TIBQuery >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.CriaQueryIB(sDataBase, sTransaction: String; Var IBQ_Free: TIBQuery; bMatriz, bCriaIBQ: Boolean);
Var
  i: Integer;
  iOk: Integer;
  sCodLojaSidicom: String;
Begin
  iOk:=0;

  If bCriaIBQ Then
  Begin
    Try
      If IBQ_Free <> Nil Then
       FreeAndNil(IBQ_Free);
    Except
    End;

    IBQ_Free:=TIBQuery.Create(Self);
    IBQ_Free.BufferChunks := 100;   // Defaut = 1000 , coloque 100
    IBQ_Free.Unidirectional := False;
    IBQ_Free.FetchAll;
  End;

  IBQ_Free.Close;

  // Loja Sem SIDICOM
//  sCodLojaSidicom:=Copy(sDataBase,6,2);
//  If (StrToInt(sgCodEmp)>=18) And (StrToInt(sgCodEmp)<=45)  Then
//  Begin
//    IBQ_Free.Database   :=DMBelShop.IBDB_BelShop;
//    IBQ_Free.Transaction:=DMBelShop.IBT_BelShop;
//    Exit;
//  End; // If (StrToInt(sgCodEmp)>=18) And (StrToInt(sgCodEmp)<=45)  Then

  For i:=0 to DMConexoes.ComponentCount-1 do
  Begin
    If DMConexoes.Components[i] is TIBDatabase Then
    Begin
      If (DMConexoes.Components[i] as TIBDatabase).Name=sDataBase Then
      Begin
        IBQ_Free.Database:=(DMConexoes.Components[i] as TIBDatabase);
        Inc(iOk);
      End;
    End;

    If DMConexoes.Components[i] is TIBTransaction Then
    Begin
      If (DMConexoes.Components[i] as TIBTransaction).Name=sTransaction Then
      Begin
        IBQ_Free.Transaction:=(DMConexoes.Components[i] as TIBTransaction);
        Inc(iOk);
      End;
    End;

    If iOk = 2 Then
    Begin
      If Not bMatriz Then
      Begin
        MontaSelectFilial(IBQ_ConsultaFilial);
      End; // If Not bMaTriz Then

      Break;
    End;
  End;

End; // Atualiza Conexao TIBQuery >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Verifica se Existe Meses Iguais >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.ConsisteBuscaProdutos: Boolean;
Begin
  DecimalSeparator:=',';
  DateSeparator:='/';

  Result:=False;

  // Analisa Mes Invlido =================================================
  If not CB_Mes1.ItemIndex in [0..11] Then
  Begin
    msg('Informao do Mes 1 Invlida !!','A');
    CB_Mes1.SetFocus;
    Exit;
  End;

  If not CB_Mes2.ItemIndex in [0..12] Then
  Begin
    msg('Informao do Mes 2 Invlida !!','A');
    CB_Mes2.SetFocus;
    Exit;
  End;

  If not CB_Mes3.ItemIndex in [0..12] Then
  Begin
    msg('Informao do Mes 3 Invlida !!','A');
    CB_Mes3.SetFocus;
    Exit;
  End;

  If not CB_Mes4.ItemIndex in [0..12] Then
  Begin
    msg('Informao do Mes 4 Invlida !!','A');
    CB_Mes4.SetFocus;
    Exit;
  End;

  If not CB_Mes5.ItemIndex in [0..12] Then
  Begin
    msg('Informao do Mes 5 Invlida !!','A');
    CB_Mes5.SetFocus;
    Exit;
  End;

  If not CB_Mes6.ItemIndex in [0..12] Then
  Begin
    msg('Informao do Mes 6 Invlida !!','A');
    CB_Mes6.SetFocus;
    Exit;
  End;

  If not CB_Mes7.ItemIndex in [0..12] Then
  Begin
    msg('Informao do Mes 7 Invlida !!','A');
    CB_Mes7.SetFocus;
    Exit;
  End;

  If not CB_Mes8.ItemIndex in [0..12] Then
  Begin
    msg('Informao do Mes 8 Invlida !!','A');
    CB_Mes8.SetFocus;
    Exit;
  End;

  // Analisa Mes em Duplicidde =================================================
  If CB_Mes1.Text+ME_Ano1.Text=CB_Mes2.Text+ME_Ano2.Text Then
  Begin
    CB_Mes2.SetFocus;
    msg('Ms 1 Igual a Ms 2 !!','A');
    Exit;
  End;

  If CB_Mes1.Text+ME_Ano1.Text=CB_Mes3.Text+ME_Ano3.Text Then
  Begin
    CB_Mes3.SetFocus;
    msg('Ms 1 Igual a Ms 3 !!','A');
    Exit;
  End;

  If CB_Mes1.Text+ME_Ano1.Text=CB_Mes4.Text+ME_Ano4.Text Then
  Begin
    CB_Mes4.SetFocus;
    msg('Ms 1 Igual a Ms 4!!','A');
    Exit;
  End;

  If CB_Mes1.Text+ME_Ano1.Text=CB_Mes5.Text+ME_Ano5.Text Then
  Begin
    CB_Mes5.SetFocus;
    msg('Ms 1 Igual a Ms 5 !!','A');
    Exit;
  End;

  If CB_Mes1.Text+ME_Ano1.Text=CB_Mes6.Text+ME_Ano6.Text Then
  Begin
    CB_Mes6.SetFocus;
    msg('Ms 1 Igual a Ms 6 !!','A');
    Exit;
  End;

  If CB_Mes1.Text+ME_Ano1.Text=CB_Mes7.Text+ME_Ano7.Text Then
  Begin
    CB_Mes7.SetFocus;
    msg('Ms 1 Igual a Ms 7 !!','A');
    Exit;
  End;

  If CB_Mes1.Text+ME_Ano1.Text=CB_Mes8.Text+ME_Ano8.Text Then
  Begin
    CB_Mes8.SetFocus;
    msg('Ms 1 Igual a Ms 8 !!','A');
    Exit;
  End;

  If CB_Mes2.ItemIndex<>0 Then
  Begin
    If CB_Mes2.Text+ME_Ano2.Text=CB_Mes3.Text+ME_Ano3.Text Then
    Begin
      CB_Mes3.SetFocus;
      msg('Ms 2 Igual a Ms 3 !!','A');
      Exit;
    End;

    If CB_Mes2.Text+ME_Ano2.Text=CB_Mes4.Text+ME_Ano4.Text Then
    Begin
      CB_Mes4.SetFocus;
      msg('Ms 2 Igual a Ms 4 !!','A');
      Exit;
    End;

    If CB_Mes2.Text+ME_Ano2.Text=CB_Mes5.Text+ME_Ano5.Text Then
    Begin
      CB_Mes5.SetFocus;
      msg('Ms 2 Igual a Ms 5 !!','A');
      Exit;
    End;

    If CB_Mes2.Text+ME_Ano2.Text=CB_Mes6.Text+ME_Ano6.Text Then
    Begin
      CB_Mes6.SetFocus;
      msg('Ms 2 Igual a Ms 6 !!','A');
      Exit;
    End;

    If CB_Mes2.Text+ME_Ano2.Text=CB_Mes7.Text+ME_Ano7.Text Then
    Begin
      CB_Mes7.SetFocus;
      msg('Ms 2 Igual a Ms 7 !!','A');
      Exit;
    End;

    If CB_Mes2.Text+ME_Ano2.Text=CB_Mes8.Text+ME_Ano8.Text Then
    Begin
      CB_Mes8.SetFocus;
      msg('Ms 2 Igual a Ms 8 !!','A');
      Exit;
    End;
  End; // If CB_Mes2.ItemIndex<>0 Then

  If CB_Mes3.ItemIndex<>0 Then
  Begin
    If CB_Mes3.Text+ME_Ano3.Text=CB_Mes4.Text+ME_Ano4.Text Then
    Begin
      CB_Mes4.SetFocus;
      msg('Ms 3 Igual a Ms 4 !!','A');
      Exit;
    End;

    If CB_Mes3.Text+ME_Ano3.Text=CB_Mes5.Text+ME_Ano5.Text Then
    Begin
      CB_Mes5.SetFocus;
      msg('Ms 3 Igual a Ms 5 !!','A');
      Exit;
    End;

    If CB_Mes3.Text+ME_Ano3.Text=CB_Mes6.Text+ME_Ano6.Text Then
    Begin
      CB_Mes6.SetFocus;
      msg('Ms 3 Igual a Ms 6 !!','A');
      Exit;
    End;

    If CB_Mes3.Text+ME_Ano3.Text=CB_Mes7.Text+ME_Ano7.Text Then
    Begin
      CB_Mes7.SetFocus;
      msg('Ms 3 Igual a Ms 7 !!','A');
      Exit;
    End;

    If CB_Mes3.Text+ME_Ano3.Text=CB_Mes8.Text+ME_Ano8.Text Then
    Begin
      CB_Mes8.SetFocus;
      msg('Ms 3 Igual a Ms 8 !!','A');
      Exit;
    End;
  End; // If CB_Mes3.ItemIndex<>0 Then

  If CB_Mes4.ItemIndex<>0 Then
  Begin
    If CB_Mes4.Text+ME_Ano4.Text=CB_Mes5.Text+ME_Ano5.Text Then
    Begin
      CB_Mes5.SetFocus;
      msg('Ms 4 Igual a Ms 5 !!','A');
      Exit;
    End;

    If CB_Mes4.Text+ME_Ano4.Text=CB_Mes6.Text+ME_Ano6.Text Then
    Begin
      CB_Mes6.SetFocus;
      msg('Ms 4 Igual a Ms 6 !!','A');
      Exit;
    End;

    If CB_Mes4.Text+ME_Ano4.Text=CB_Mes7.Text+ME_Ano7.Text Then
    Begin
      CB_Mes7.SetFocus;
      msg('Ms 4 Igual a Ms 7 !!','A');
      Exit;
    End;

    If CB_Mes4.Text+ME_Ano4.Text=CB_Mes8.Text+ME_Ano8.Text Then
    Begin
      CB_Mes8.SetFocus;
      msg('Ms 4 Igual a Ms 8 !!','A');
      Exit;
    End;
  End; // If CB_Mes4.ItemIndex<>0 Then

  If CB_Mes5.ItemIndex<>0 Then
  Begin
    If CB_Mes5.Text+ME_Ano5.Text=CB_Mes6.Text+ME_Ano6.Text Then
    Begin
      CB_Mes6.SetFocus;
      msg('Ms 5 Igual a Ms 6 !!','A');
      Exit;
    End;

    If CB_Mes5.Text+ME_Ano5.Text=CB_Mes7.Text+ME_Ano7.Text Then
    Begin
      CB_Mes7.SetFocus;
      msg('Ms 5 Igual a Ms 7 !!','A');
      Exit;
    End;

    If CB_Mes5.Text+ME_Ano5.Text=CB_Mes8.Text+ME_Ano8.Text Then
    Begin
      CB_Mes8.SetFocus;
      msg('Ms 5 Igual a Ms 8 !!','A');
      Exit;
    End;
  End; // If CB_Mes5.ItemIndex<>0 Then

  If CB_Mes6.ItemIndex<>0 Then
  Begin
    If CB_Mes6.Text+ME_Ano6.Text=CB_Mes7.Text+ME_Ano7.Text Then
    Begin
      CB_Mes7.SetFocus;
      msg('Ms 6 Igual a Ms 7 !!','A');
      Exit;
    End;

    If CB_Mes6.Text+ME_Ano6.Text=CB_Mes8.Text+ME_Ano8.Text Then
    Begin
      CB_Mes8.SetFocus;
      msg('Ms 6 Igual a Ms 8 !!','A');
      Exit;
    End;
  End; // If CB_Mes6.ItemIndex<>0 Then

  If CB_Mes7.ItemIndex<>0 Then
  Begin
    If CB_Mes7.Text+ME_Ano7.Text=CB_Mes8.Text+ME_Ano8.Text Then
    Begin
      CB_Mes8.SetFocus;
      msg('Ms 7 Igual a Ms 8 !!','A');
      Exit;
    End;
  End; // If CB_Mes7.ItemIndex<>0 Then

  // Analisa Ano Invlido =======================================================
  If (CB_Mes1.ItemIndex in [0..11]) and (ME_Ano1.Text='20  ') Then
  Begin
    ME_Ano1.SetFocus;
    msg('Ano Invlido em Ms 1 !!','A');
    Exit;
  End;

  If (CB_Mes2.ItemIndex in [1..12]) and (ME_Ano2.Text='20  ') Then
  Begin
    ME_Ano2.SetFocus;
    msg('Ano Invlido em Ms 2 !!','A');
    Exit;
  End;

  If (CB_Mes3.ItemIndex in [1..12]) and (ME_Ano3.Text='20  ') Then
  Begin
    ME_Ano3.SetFocus;
    msg('Ano Invlido em Ms 3 !!','A');
    Exit;
  End;

  If (CB_Mes4.ItemIndex in [1..12]) and (ME_Ano4.Text='20  ') Then
  Begin
    ME_Ano4.SetFocus;
    msg('Ano Invlido em Ms 4 !!','A');
    Exit;
  End;

  If (CB_Mes5.ItemIndex in [1..12]) and (ME_Ano5.Text='20  ') Then
  Begin
    ME_Ano5.SetFocus;
    msg('Ano Invlido em Ms 5 !!','A');
    Exit;
  End;

  If (CB_Mes6.ItemIndex in [1..12]) and (ME_Ano6.Text='20  ') Then
  Begin
    ME_Ano6.SetFocus;
    msg('Ano Invlido em Ms 6 !!','A');
    Exit;
  End;

  If (CB_Mes7.ItemIndex in [1..12]) and (ME_Ano7.Text='20  ') Then
  Begin
    ME_Ano7.SetFocus;
    msg('Ano Invlido em Ms 7 !!','A');
    Exit;
  End;

  If (CB_Mes8.ItemIndex in [1..12]) and (ME_Ano8.Text='20  ') Then
  Begin
    ME_Ano8.SetFocus;
    msg('Ano Invlido em Ms 8 !!','A');
    Exit;
  End;

  // Verifica Limite Para Busca de Transito ====================================
  If (CkB_CalculoTransito.Checked) and (Trim(DtEdt_CalculoTransito.Text)<>'') Then
   Begin
     Try
       StrToDate(DtEdt_CalculoTransito.Text);
     Except
       msg('Data Limite para Transito Invlida !!','A');
       DtEdt_CalculoTransito.SetFocus;
       Exit;
     End;
   End
  Else If (CkB_CalculoTransito.Checked) and (Trim(DtEdt_CalculoTransito.Text)='') Then
   Begin
     msg('Data Limite para Transito Invlida !!','A');
     DtEdt_CalculoTransito.SetFocus;
     Exit;
   End; // If (CkB_CalculoTransito.Checked) and Trim(DtEdt_CalculoTransito.Text)<>'' Then

  If DtEdt_CalculoTransito.Date<StrToDate('01/01/2011') Then
  Begin
    msg('Data Limite para Transito'+cr+'deve Ser MAIOR que 31/12/2010 !!','A');
    DtEdt_CalculoTransito.SetFocus;
    Exit;
  End; // If DtEdt_CalculoInicio.Date<StrToDate('01/01/2011') Then

  // Lista de Preos ===========================================================
  If EdtOCCodListaPreco.Value=0 Then
  Begin
    EdtOCCodListaPreco.SetFocus;
    msg('Favor Informar a Lista de Preos'+cr+cr+'a ser Utilizada !!','A');
    Exit;
  End;

  Result:=True;
End; // Verifica se Existe Meses Iguais >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Busca Nome e UF do Estado >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.NomeUfEstado(Cod_Uf: String): String;
Var
  MySql: String;
Begin
  MySql:='Select Des_Estado, Des_UF'+
         ' from Estados_IBGE'+
         ' Where Des_UF='+QuotedStr(Cod_UF);
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  Result:=DMBelShop.CDS_Busca.FieldByName('Des_Estado').AsString+';'+
                             DMBelShop.CDS_Busca.FieldByName('Des_UF').AsString;

  DMBelShop.CDS_Busca.Close;

end; // Busca Nome e UF do Estado >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Fecha Todos os Client's >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.FechaTudo;
Var
  i: Integer;
Begin

  // Fecha Componentes DMBelShop ===============================================
  For i:=0 to DMBelShop.ComponentCount-1 do
  Begin
    If DMBelShop.Components[i] is TClientDataSet Then
     If (DMBelShop.Components[i] as TClientDataSet).Active Then
     (DMBelShop.Components[i] as TClientDataSet).Close;

    If DMBelShop.Components[i] is TIBQuery Then
     If (DMBelShop.Components[i] as TIBQuery).Active Then
     (DMBelShop.Components[i] as TIBQuery).Close;
  End;

  // Fecha Componentes UDMVirtual ==============================================
  For i:=0 to DMVirtual.ComponentCount-1 do
  Begin
    If DMVirtual.Components[i] is TClientDataSet Then
     If (DMVirtual.Components[i] as TClientDataSet).Name<>'CDS_V_EmpConexoes' Then
      If (DMVirtual.Components[i] as TClientDataSet).Active Then
       (DMVirtual.Components[i] as TClientDataSet).Close;

    If DMVirtual.Components[i] is TIBQuery Then
     If (DMVirtual.Components[i] as TIBQuery).Active Then
     (DMVirtual.Components[i] as TIBQuery).Close;
  End;

  // Fecha Series dos Graficos =================================================
  FechaSeriesGraficos;

  DbGrafico_FinanObjetivosGrafico.SeriesList.Clear;
   
  If IBQ_Consulta <> nil then
   IBQ_Consulta.Close;

  If IBQ_CountReg <> nil then
    IBQ_CountReg.Close;

  If IBQ_ConsultaFilial <> nil then
    IBQ_ConsultaFilial.Close;

  OdirPanApres.Visible:=False;

end; // Fecha Todos os Client's >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Manda Fechar TabSheet Aberta >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Function TFrmBelShop.MandaFechar: Boolean;
Var
  i: Integer;
Begin
  Result:=True;
  For i:=0 to ComponentCount-1 do
  Begin
    If (Components[i] is TTabSheet) and ((Components[i] as TTabSheet).Tag>99) Then
    Begin
      If (Components[i] as TTabSheet).TabVisible=True Then
      Begin
        msg('Favor Fechar o Mdulo '+cr+cr+(Components[i] as TTabSheet).Caption+cr+cr+
            'Que esta Aberto !!','A');
        Result:=False;
      End;
    End;
  End;
End; // Manda Fechar TabSheet Aberta >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Acesso Administrador >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AcessoAdministrador(b:Boolean);
Begin
  // TS_Usuario ================================================================
  EdtUsuFiltroLogin.Enabled:=b;
  EdtUsuFiltroNome.Enabled:=b;
  GB_UsuLocalizar.Enabled:=b;
  Bt_UsuNovaPesq.Enabled:=b;
  GB_UsuManutAdmin.Visible:=b;
  GB_UsuManutAtivo.Visible:=b;
  GB_UsuManutLogin.Visible:=b;
  Bt_UsuNovo.Visible:=b;
  Bt_UsuExcluir.Visible:=b;
End; // Acesso Administrador >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Inicializa Usuario >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.InicializaUsuario(var Permissao: String);
Begin

  // Login =====================================================================
  Des_Login:='';

  FrmLogin:=TFrmLogin.Create(Self);

  If sgCodLojaUnica='' Then
   FrmLogin.Caption:='Gerenciador Belshop'
  Else
   FrmLogin.Caption:='Gerenciador Belshop - Bel_'+sgCodLojaUnica;

  FrmEntrada.Close;
  FrmLogin.ShowModal;

  FrmEntrada.Show;
  FrmEntrada.Refresh;
  Application.ProcessMessages;

  // Verifica Encerramento  ====================================================
  Des_Login:=FrmLogin.Login;

  If Des_Login='' Then
  Begin
    FrmEntrada.Close;
    FreeAndNil(FrmEntrada);
    FreeAndNil(FrmLogin);
    Application.Terminate;
    Exit;
  End;

  // Ajusta Dados das Lojas ====================================================
  If Trim(sgCodLojaUnica)='' Then
  Begin
    Screen.Cursor:=crAppStart;
    If Not DMBelShop.AjustaDadosLojas Then
    Begin
      MessageBox(Handle,pChar('Erro ao Ajustar Empresas'+cr+cr+sgMensagem), 'Erro', MB_ICONERROR);
    End;
    Screen.Cursor:=crDefault;
  End; // If Trim(sgCodLojaUnica)='' Then

  // Guarda Codigo do Usuario ==================================================
  If Des_Login<>'' Then
  Begin
    Cod_Usuario:=DMBelShop.IBQ_Busca.FieldByName('Cod_Usuario').AsString;
    Des_Usuario:=DMBelShop.IBQ_Busca.FieldByName('Des_Usuario').AsString;
    bgInd_Admin:=DMBelShop.IBQ_Busca.FieldByName('Ind_Admin').AsString='SIM';
  End;

  DMBelShop.IBQ_Busca.Close;

//  Try
//    If FrmLogin<>nil then
//     FreeAndNil(FrmLogin);
//  Except
//  End;

  Screen.Cursor:=crAppStart;

  BloqueioMenu(FrmBelShop, DMBelShop.CDS_Seguranca, DMBelShop.SDS_Busca, Des_Login, bgInd_Admin);

  Mem_Odir.Visible:=False;

  Screen.Cursor:=crDefault;

End; // Inicializa Usuario >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Acerta Acessos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AcertaAcessos(var Perm: String);
Var
  ii,i: Integer;
Begin

  // Busca Menu ================================================================
  for i:=0 to MainMenu1.Items.Count-1 do
  Begin
    For ii:=0 to MainMenu1.Items[i].Count-1 do
    Begin
      If MainMenu1.Items[i].Items[ii].Tag<>0 Then
       If Copy(Perm,MainMenu1.Items[i].Items[ii].Tag,1)='N' Then
        MainMenu1.Items[i].Items[ii].Visible:=False
       Else
        MainMenu1.Items[i].Items[ii].Visible:=True;
    End;
  End;

End; // Acerta Acessos >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Libera Opes de Menu >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.LiberaMenu(b: Boolean);
Begin
  MenuSistema.Enabled:=b;
  MenuUsuarios.Enabled:=b;
  MenuCompras.Enabled:=b;
  MenuFinanceiro.Enabled:=b;
  MenuSalao.Enabled:=b;

  If sgCodLojaUnica<>'' Then
  Begin
    MenuSAIR.Enabled:=b;
    SBt_Sair.Enabled:=b;
  End;
End; // Libera Opes de Menu >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Controle TabSheet's e Menu >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.AbreFechaTabSheet(Fechar, Menu: Boolean);
Var
  i: Integer;
Begin

  For i:=0 to ComponentCount-1 do
  Begin
    If Components[i] is TTabSheet Then
    Begin
      If (Components[i] as TTabSheet).Tag>99 Then // Somente TabSheet Principal
      Begin
        If (Components[i] as TTabSheet).TabVisible Then
        Begin
          (Components[i] as TTabSheet).TabVisible:=Fechar;
          (Components[i] as TTabSheet).Highlighted:=False;
          Refresh;
        End; // If (Components[i] as TTabSheet).TabVisible Then
      End; // If (Components[i] as TTabSheet).Tag>99 Then // Somente TabSheet Principal
    End; // If Components[i] is TTabSheet Then
  End; // For i:=0 to ComponentCount-1 do

  For i:=0 to MainMenu1.Items.Count-1 do
  Begin
    If (MainMenu1.Items.Items[i].Name<>'MenuVersao') and
       (MainMenu1.Items.Items[i].Name<>'MenuCalculadora') Then
     MainMenu1.Items.Items[i].Enabled:=bConexaoOK //Menu;
    Else
     MainMenu1.Items.Items[i].Enabled:=True; //Menu;
  End; // For i:=0 to MainMenu1.Items.Count-1 do

  If PC_Principal.Visible Then
  Begin
    Try
      PC_Principal.Visible:=False;
    Except
    End;
  End;
end; // Controle TabSheet's e Menu >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

// Abre Determinada TabSheet >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
Procedure TFrmBelShop.SelecionaTabSheet(ts:TTabSheet);
Var
  i: Integer;
Begin
  bEnterTab:=True;

  For i:=0 to ComponentCount-1 do
  Begin
    If Components[i] is TTabSheet Then
    Begin
      If (Components[i] as TTabSheet).Tag>99 Then // Somente TabSheet Principal
      Begin
        If (Components[i] as TTabSheet).Name=ts.Name Then
         Begin
           (Components[i] as TTabSheet).TabVisible:=True;
           ts.Refresh;
         End
        Else
         Begin
           (Components[i] as TTabSheet).TabVisible:=False;
         End;
      End;
    End;
  End;

  For i:=0 to MainMenu1.Items.Count-1 do
  Begin
    If (MainMenu1.Items.Items[i].Name<>'MenuVersao') and
       (MainMenu1.Items.Items[i].Name<>'MenuCalculadora') Then
     MainMenu1.Items.Items[i].Enabled:=False;
  End;

  If Not PC_Principal.Visible Then
   PC_Principal.Visible:=True;

  Refresh;

end; // Abre Determinada TabSheet >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>


//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
// ODIR FIM >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
//>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>

procedure TFrmBelShop.FormShow(Sender: TObject);
Var
  MySql: String;
begin

  //============================================================================
  // TbaSheet's No Usados =====================================================
  //============================================================================
  SubMenuFinanFechamentoDiarioLojas.Enabled:=False;
  SubMenuFinanFechamentoDiarioLojas.Visible:=False;
  SubMenuFinanFechamentoCaixa.Enabled:=False;
  SubMenuFinanFechamentoCaixa.Visible:=False;
  //============================================================================

  // Cor Form
  CorCaptionForm.Active:=False;
  CorTelaForm.Visible:=False;

  CorCaptionForm.Active:=True;
  CorTelaForm.Visible:=True;

  // Permissoes
  InicializaUsuario(PermissoesAtual);

  If FrmLogin=nil Then
   Exit;

  bConexaoOK:=True;

  AbreFechaTabSheet(False, True);

  // Apresenta Verso e Usurio ================================================
  ApresentaDataHoraVersao;

  // Cria Feriados =============================================================
  CriaFeriadosAno(YearOf(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)));

  // Busca Lista de Preo Padro ===============================================
  MySql:=' SELECT e.cod_listaPre'+
         ' FROM EMP_CONEXOES e';

         If Trim(sgCodLojaUnica)='' Then
          MySql:=MySql+' WHERE e.Cod_Filial='+QuotedStr('99')
         Else
          MySql:=MySql+' WHERE e.Cod_Filial='+QuotedStr(sgCodLojaUnica);
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;
  sgCodListaPrePadrao:=DMBelShop.CDS_BuscaRapida.FieldByName('Cod_ListaPre').AsString;
  DMBelShop.CDS_BuscaRapida.Close;

  If Trim(sgCodListaPrePadrao)='' Then
   sgCodListaPrePadrao:='0006';

  // Busca Descrio da Lista de Precos ========================================
  MySql:=' Select lp.nomelista'+
         ' from lista lp'+
         ' where lp.codlista='+QuotedStr(sgCodListaPrePadrao);
  IBQ_MPMS.Close;
  IBQ_MPMS.SQL.Clear;
  IBQ_MPMS.SQL.Add(MySql);
  IBQ_MPMS.Open;
  sgDesListaPrePadrao:=IBQ_MPMS.FieldByName('nomelista').AsString;
  IBQ_MPMS.Close;

  FrmEntrada.Close;
  FreeAndNil(FrmEntrada);
  FreeAndNil(FrmLogin);

end;

procedure TFrmBelShop.MenuSAIRClick(Sender: TObject);
begin
  SubMenuEmpConexoesSairClick(Self);
end;

procedure TFrmBelShop.FormClose(Sender: TObject; var Action: TCloseAction);
begin
//  if bgSair Then
//   Begin
//     Screen.Cursor:=crAppStart;
//
//     // Painel de Processamento em Tempo de Execuo ==============================
//     Try
//       OdirPanApres.Caption:='AGUARDE !! Desconectando Empresas...';
//       OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
//       OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
//       OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
//       OdirPanApres.Visible:=True;
//       Refresh;
//     Except
//     End;
//
//     // Desconecta Bancos e Encerra Programa ===================================
//     DMBelShop.Desconecta;
//
//     OdirPanApres.Visible:=False;
//
//     Screen.Cursor:=crDefault;
//
//     Action := caFree;
//   End
//  Else
//   Begin
//     Action := caNone;
//     SubMenuEmpConexoesSairClick(Self);
//   End;
//
end;

procedure TFrmBelShop.MenuCalculadoraClick(Sender: TObject);
begin
  ShellExecute(handle, 'open', 'calc.exe', '', nil, sw_shownormal);
end;

procedure TFrmBelShop.MenuVersaoClick(Sender: TObject);
begin
  msg('Data da ltima Alterao: '+Copy(DateTimeToStr(FileDateToDateTime(
      FileAge(IncludeTrailingPathDelimiter(ExtractFilePath(Application.ExeName))+
      ExtractFileName(Application.ExeName)))),1,19)+cr+cr+
      'Login do Usurio Atual'+cr+cr+Des_Login,'A');
end;

procedure TFrmBelShop.PC_PrincipalChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_Principal);
end;

procedure TFrmBelShop.FormCreate(Sender: TObject);
Var
  b: TNavigateBtn;
  i: Integer;
Begin
  bgOnActivate  :=False;
  bgSelectSoLinx:=False;

  // Coloca BitMaps em Componentes =============================================
  BitMaps(FrmBelShop);

  // Se Utiliza Busca de Demandas Novo =========================================
  bgDemandaNovo:=False;

  // Coloca Icone no Form ======================================================
  Icon:=Application.Icon;

  // Acertar Erro na Rolagem do Mouse ==========================================
  Application.OnMessage := ApplicationEvents1Message;

  // Parametro Para Verificao de Verso em UPermissao/FrmLogin ===============
  sgPastaExecutavel:=IncludeTrailingPathDelimiter(ExtractFilePath(Application.ExeName))+'PBelShop.exe';
  sgParamAplicativo:='';
  For i:=1 to ParamCount do
  Begin
    If ParamStr(i)<>sgPastaExecutavel Then
    Begin
      sgParamAplicativo:=ParamStr(i);
      Break;
    End;
  End; // For i:=0 to ParamCount-1 do

  // Bloquer PrintScreen =======================================================
  Application.OnIdle := AntiCopia;

  // Caption do DBNavegator ====================================================
  For b := Low(TNavigateBtn) to High(TNavigateBtn) do
  Begin
    With TDBNewNavigator(DBNav_FInainAuditoriaManut).Buttons[b] do
    Begin
      Case Index of
        nbFirst   : Caption := 'Primeiro';
        nbPrior   : Caption := 'Anterior';
        nbNext    : Caption := 'Prximo';
        nbLast    : Caption := 'ltimo';
        nbInsert  : Caption := 'Novo';
        nbDelete  : Caption := 'Excluir';
        nbEdit    : Caption := 'Editar';
        nbPost    : Caption := 'Salvar';
        nbCancel  : Caption := 'Cancelar';
        nbRefresh : Caption := 'Atualizar';
      End; // With TDBNewNavigator(DBNav_FInainAuditoriaManut).Buttons[b] do

      Layout := blGlyphTop;
      Hint := Caption;
      ShowHint := True;
    End; // With TDBNewNavigator(DBNavigator1).Buttons[b] do
  End; // for b := Low(TNavigateBtn) to High(TNavigateBtn) do

  // Inicializa Variaveis ======================================================
  InicializaFormatos;

  bEnterTab:= True;

  // Posiciona PageControls ====================================================
  PC_Principal.TabIndex:=0;
  PC_PrincipalChange(Self);

  PC_OrdemCompra.TabIndex:=0;
  PC_OrdemCompraChange(Self);

  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);

  Application.OnMessage := AppEventsMessage;

  // Traduo DevExpress =======================================================
  if FileExists(IncludeTrailingPathDelimiter(ExtractFilePath(Application.ExeName))+'TradDevExpBr.ini') then {Verifica se existe o arquivo dentro da pasta}
  begin
    Trad_Localizer.LoadFromFile(IncludeTrailingPathDelimiter(ExtractFilePath(Application.ExeName))+'TradDevExpBr.ini');
    Trad_Localizer.LanguageIndex := 1; {Muda o idioma / linguagem}
    Trad_Localizer.Active := TRUE;     {Ativa o componente / a traduo}
  end;
end;

procedure TFrmBelShop.SubMenuProtUsuariosUsuariosClick(Sender: TObject);
Var
  i: Integer;
begin
  Mem_Conexoes.Visible:=False;
  Mem_Conexoes.Lines.Clear;
  For i:=0 to DMConexoes.ComponentCount-1 do
  Begin
    If DMConexoes.Components[i] is TIBDatabase Then
    Begin
      Mem_Conexoes.Lines.Add((DMConexoes.Components[i] as TIBDatabase).Name+' - '+(DMConexoes.Components[i] as TIBDatabase).DatabaseName);
    End;
  End; // For i:=0 to DMConexoes.ComponentCount-1 do

  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  SelecionaTabSheet(TS_Usuario);

  EdtUsuFiltroNome.Clear;
  EdtUsuFiltroNome.Enabled:=True;
  EdtUsuFiltroLogin.Clear;
  EdtUsuFiltroLogin.Enabled:=True;
  If Not bgInd_Admin Then
   Begin
     EdtUsuFiltroLogin.Text:=Des_Login;
     EdtUsuFiltroLogin.Enabled:=False;
     EdtUsuFiltroNome.Enabled:=False;
     Bt_UsuPesqClick(Self)
   End
  Else
   Begin
     EdtUsuFiltroNome.SetFocus;
   End;

end;

procedure TFrmBelShop.Bt_UsuFechaClick(Sender: TObject);
begin
  // Usado em:
  //==================================
  // Bt_ConEmpresasFecharClick
  // Bt_OCFecharClick
  // Bt_ConsultaOCFecharClick
  // Bt_ConsultaNFeFecharClick
  // Bt_CurvaABCEndFecharClick
  // Bt_EstFisFinanFecharClick
  // Bt_FinanComprovantesFecharClick
  //==================================

  If (Sender is TJvXPButton) Then
  Begin
    If (Sender as TJvXPButton).Name='Bt_FinanComprovantesFechar' Then
    Begin
      EdtFinanComprovantesLocalizar.Clear;
    End;

    If (Sender as TJvXPButton).Name='Bt_OCFechar' Then
    Begin
      Painel_FiltroOC.Height:=167;
    End;

    If (Sender as TJvXPButton).Name='Bt_CurvaABCEndFechar' Then
    Begin
      If gCDS_V_Geral<>nil Then
      Begin
        FreeAndNil(gCDS_V_Geral);
        FreeAndNil(gDS);
      End;
    End; // If (Sender as TJvXPButton).Name='Bt_CurvaABCEndFechar' Then
  End; // If (Sender is TJvXPButton) Then

  EdtGeraOCBuscaDocto.AsInteger:=0;
  DtEdt_GeraOCDataDocto.Clear;

  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.FormKeyPress(Sender: TObject; var Key: Char);
begin

  If bEnterTab Then
  Begin
    If Key = #13 Then
    Begin
      Key:=#0;
      SelectNext(ActiveControl,True,True);
    End;
  End; // If bEnterTab Then

end;

procedure TFrmBelShop.Bt_UsuPesqClick(Sender: TObject);
Var
  MySql: String;
begin
  Dbg_Usuarios.SetFocus;

  Screen.Cursor:=crAppStart;

  DMBelShop.CDS_Usuario.Filtered:=False;
  DMBelShop.CDS_Usuario.Filter:='';

  MySql:='Select *'+
         ' from PS_Usuarios';

         // BelShop Normal
         If Trim(sgCodLojaUnica)='' Then
         Begin
           If Cod_Usuario='1' Then
            MySql:=MySql+' Where Cod_Usuario>0'
           Else If StrToInt(Cod_Usuario)>1 Then
            MySql:=MySql+' Where Cod_Usuario>1'
           Else
            MySql:=MySql+' Where Cod_Usuario>=0';
         End; // If Trim(sgCodLojaUnica)='' Then

         // BelShop Loja Unica
         If Trim(sgCodLojaUnica)<>'' Then
         Begin
           If Cod_Usuario='1' Then
            MySql:=MySql+' Where Cod_Usuario>0'
           Else If Cod_Usuario='2' Then
            MySql:=MySql+' Where Cod_Usuario>1'
           Else If StrToInt(Cod_Usuario)>1 Then
            MySql:=MySql+' Where Cod_Usuario>2'
           Else
            MySql:=MySql+' Where Cod_Usuario>=0';
         End; // If Trim(sgCodLojaUnica)='' Then

         If Trim(EdtUsuFiltroNome.Text)<>'' Then
          MySql:=MySql+' And Upper(Des_Usuario) like '+
                        QuotedStr('%'+AnsiUpperCase(EdtUsuFiltroNome.Text)+'%');

         If Trim(EdtUsuFiltroLogin.Text)<>'' Then
          MySql:=MySql+' And Upper(Des_Login) like '+
                        QuotedStr('%'+AnsiUpperCase(EdtUsuFiltroLogin.Text)+'%');

         If Rb_UsuAtivoSim.Checked Then
          MySql:=MySql+' And Ind_Ativo=''SIM''';

         If Rb_UsuAtivoNao.Checked Then
          MySql:=MySql+' And Ind_Ativo=''NAO''';

         MySql:=MySql+' Order by Des_Usuario';
  DMBelShop.CDS_Usuario.Close;
  DMBelShop.CDS_Usuario.Filtered:=False;
  DMBelShop.CDS_Usuario.Filter:='';
  DMBelShop.SDS_Usuario.CommandText:=MySql;
  DMBelShop.CDS_Usuario.Open;

  Screen.Cursor:=crDefault;

  If Trim(DMBelShop.CDS_Usuario.FieldByName('Cod_Usuario').AsString)='' Then
  Begin
    msg('Sem Registro a Listar...','A');
    Exit;
  End;

  Dbg_Usuarios.SetFocus;
end;

procedure TFrmBelShop.Bt_UsuNovaPesqClick(Sender: TObject);
begin
  DMBelShop.CDS_Usuario.Close;

  EdtUsuLocaliza.Clear;
  EdtUsuFiltroNome.Clear;

  EdtUsuFiltroNome.Clear;
  EdtUsuFiltroNome.Enabled:=True;
  EdtUsuFiltroLogin.Clear;
  EdtUsuFiltroLogin.Enabled:=True;
  If Not bgInd_Admin Then
   Begin
     EdtUsuFiltroLogin.Text:=Des_Login;
     EdtUsuFiltroLogin.Enabled:=False;
     EdtUsuFiltroNome.Enabled:=False;
     Bt_UsuPesq.SetFocus;
   End
  Else
   Begin
     EdtUsuFiltroNome.SetFocus;
   End;

end;

procedure TFrmBelShop.Rb_UsuLocalizaNomeClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_UsuLocalizaNome);
  AcertaRb_Style(Rb_UsuLocalizaLogin);

end;

procedure TFrmBelShop.Bt_UsuLocalizaClick(Sender: TObject);
Var
  s: String;
begin
  Screen.Cursor:=crAppStart;

  DMBelShop.CDS_Usuario.Filtered:=False;
  DMBelShop.CDS_Usuario.Filter:='';
  DMBelShop.CDS_Usuario.Filtered:=True;
  If Not DMBelShop.CDS_Usuario.IsEmpty Then
  Begin
    DMBelShop.CDS_Usuario.DisableControls;

    If Rb_UsuLocalizaNome.Checked Then
     s:='DES_USUARIO'
    Else
     s:='DES_LOGIN';

    DMBelShop.CDS_Usuario.Filtered:=False;
    If Trim(EdtUsuLocaliza.Text)<>'' Then
     DMBelShop.CDS_Usuario.Filter:='Upper('+s+') like '+
                        QuotedStr('%'+AnsiUpperCase(EdtUsuFiltroNome.Text)+'%');

    DMBelShop.CDS_Usuario.Filtered:=True;

    DMBelShop.CDS_Usuario.EnableControls;

    Dbg_Usuarios.SetFocus;
  End;

  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.Dbg_UsuariosDblClick(Sender: TObject);
begin
  Bt_UsuDetalharClick(Self);

end;

procedure TFrmBelShop.Bt_UsuNovoClick(Sender: TObject);
Var
  MySql: String;
begin
  Screen.Cursor:=crAppStart;

  MySql:='Select *'+
         ' from PS_Usuarios'+
         ' Where Cod_Usuario<0';
  DMBelShop.CDS_Usuario.Close;
  DMBelShop.SDS_Usuario.CommandText:=MySql;
  DMBelShop.CDS_Usuario.Open;

  // Insere ====================================================================
  DMBelShop.CDS_Usuario.Insert;
  DMBelShop.CDS_Usuario.FieldByName('Ind_Admin').AsString:='NAO';
  DMBelShop.CDS_Usuario.FieldByName('Ind_Ativo').AsString:='SIM';

  // Libera Insero ===========================================================
  Bt_UsuManutSalvar.Caption:='Incluir';

  Dbe_UsuManutCodigo.ReadOnly:=False;
  Dbe_UsuManutCodigo.Color:=clWindow;
  Dbe_UsuManutCodigo.Font.Style:=[];
  Dbe_UsuManutCodigo.TabStop:=True;

  SelecionaTabSheet(Ts_UsuarioManut);

  Dbe_UsuManutCodigo.SetFocus;

  Screen.Cursor:=crDefault;


end;

procedure TFrmBelShop.Bt_UsuDetalharClick(Sender: TObject);
begin

  If DMBelShop.CDS_Usuario.IsEmpty Then
  Begin
    msg('SEM Usurio a DETALHAR !!' ,'A');
    Exit;
  End;

  Screen.Cursor:=crAppStart;

  // Edita =====================================================================
  DMBelShop.CDS_Usuario.Edit;

  // Libera Edio ============================================================
  Bt_UsuManutSalvar.Caption:='Alterar';

  Dbe_UsuManutCodigo.ReadOnly:=True;
  Dbe_UsuManutCodigo.Color:=$00B9B9FF;
  Dbe_UsuManutCodigo.Font.Style:=[fsBold];
  Dbe_UsuManutCodigo.TabStop:=False;

  SelecionaTabSheet(Ts_UsuarioManut);

  EdtUsuManutSenhaAtual.Clear;
  EdtUsuManutSenhaNova.Clear;
  EdtUsuManutSenhaRepete.Clear;

  Dbe_UsuManutNome.SetFocus;

  Screen.Cursor:=crDefault;
end;

procedure TFrmBelShop.Bt_UsuExcluirClick(Sender: TObject);
Var
  MySql: String;
begin

  Dbg_Usuarios.SetFocus;

  If DMBelShop.CDS_Usuario.IsEmpty Then
  Begin
    msg('SEM Usurio a EXCLUIR !!' ,'A');
    Exit;
  End;

  If msg('Deseja Realmente Exclui o'+cr+cr+'Usurio Selecionado ??','C')=2 Then
   Exit;

  Screen.Cursor:=crAppStart;
  Try
    // Monta Transacao =========================================================
    TD.TransactionID:=Cardinal(FormatDateTime('ddmmyyyy',now)+FormatDateTime('hhnnss',now));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);

    // Exlui Usuario ===========================================================
    MySql:=' Delete from PS_Usuarios'+
           ' Where Cod_Usuario='+
           DMBelShop.CDS_Usuario.fieldByName('Cod_Usuario').AsString ;
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    DMBelShop.SQLC.Commit(TD);

    DMBelShop.CDS_Usuario.Close;
    DMBelShop.CDS_Usuario.Open;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      msg('Usuario com Movimentao !!'+cr+cr+'Excluso NO Permitida !!','A');
      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End;
  End;

  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.Bt_UsuManutVoltarClick(Sender: TObject);
Var
  i: Integer;
begin
  If (DMBelShop.CDS_Usuario.State=dsInsert) Or (DMBelShop.CDS_Usuario.State=dsEdit) Then
   DMBelShop.CDS_Usuario.CancelUpdates;

  SelecionaTabSheet(Ts_Usuario);

  i:=DMBelShop.CDS_Usuario.FieldByName('Cod_Usuario').AsInteger;
  Bt_UsuPesqClick(Self);
  DMBelShop.CDS_Usuario.Locate('Cod_Usuario',i,[]);

  Dbg_Usuarios.SetFocus;

end;

procedure TFrmBelShop.Bt_UsuManutSalvarClick(Sender: TObject);
Var
  MySql: String;
begin
  Dbe_UsuManutNome.SetFocus;

  If (Trim(Dbe_UsuManutCodigo.Text)='0') Then
  Begin
    msg('Favor Informar o Cdigo do Usurio !!','A');
    Dbe_UsuManutCodigo.SetFocus;
    Exit;
  End;

  If (Trim(Dbe_UsuManutNome.Text)='') Then
  Begin
    msg('Favor Informar o Nome do Usurio !!','A');
    Dbe_UsuManutNome.SetFocus;
    Exit;
  End;

  If (Trim(Dbe_UsuManutLogin.Text)='') Then
  Begin
    msg('Favor Informar o Login do Usurio !!','A');
    Dbe_UsuManutLogin.SetFocus;
    Exit;
  End;

  If Dbe_UsuManutSenha.Text='' Then
  Begin
    If msg('Usurio Sem Senha !!'+cr+cr+'Deseja Continuar ??','C')=2 Then
     Exit;
  End;

  If Bt_UsuManutSalvar.Caption='Incluir' Then
  Begin
    // Verifica se a Existencia ==================================================
    MySql:='Select cod_usuario'+
           ' From PS_Usuarios'+
           ' Where Cod_Usuario='+QuotedStr(Dbe_UsuManutCodigo.Text);
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Usuario').AsString)<>'' Then
    Begin
      msg('Cdigo de Usurio J Existente !!','A');
      Dbe_UsuManutCodigo.SetFocus;
      Exit;
    end;
  End; // If Bt_UsuManutSalvar.Caption='Incluir' Then

  MySql:='Select cod_usuario'+
         ' From PS_Usuarios'+
         ' Where Des_Usuario='+QuotedStr(Dbe_UsuManutNome.Text)+
         ' And Des_Usuario<>'+
         QuotedStr(DMBelShop.CDS_Usuario.FieldByName('Des_Usuario').OldValue);
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Usuario').AsString)<>'' Then
  Begin
    msg('Usurio J Existente !!','A');
    Dbe_UsuManutNome.SetFocus;
    Exit;
  end;

  MySql:='Select cod_usuario'+
         ' From PS_Usuarios'+
         ' Where Des_Login='+QuotedStr(Dbe_UsuManutLogin.Text)+
         ' And Des_Login<>'+
         QuotedStr(DMBelShop.CDS_Usuario.FieldByName('Des_Login').OldValue);
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Usuario').AsString)<>'' Then
  Begin
    msg('Login J Existente !!','A');
    Dbe_UsuManutLogin.SetFocus;
    Exit;
  end;

  MySql:='Select cod_usuario'+
         ' From PS_Usuarios'+
         ' Where Des_Senha='+QuotedStr(Dbe_UsuManutSenha.Text)+
         ' And Des_Senha<>'+
         QuotedStr(DMBelShop.CDS_Usuario.FieldByName('Des_Senha').OldValue);
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Usuario').AsString)<>'' Then
  Begin
    msg('Senha J Existente !!','A');
    Dbe_UsuManutLogin.SetFocus;
    Exit;
  end;

  If (Trim(DBCB_UsuManutAdmin.Text)<>'SIM') And (Trim(DBCB_UsuManutAdmin.Text)<>'NAO')Then
  Begin
    msg('Indicador de Administrador Invlido !!','A');
    DBCB_UsuManutAdmin.SetFocus;
    Exit;
  End;
  DMBelShop.CDS_Busca.Close;

  Try
    Screen.Cursor:=crAppStart;

    // Monta Transacao =========================================================
    TD.TransactionID:=Cardinal(FormatDateTime('ddmmyyyy',now)+FormatDateTime('hhnnss',now));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);

    If Bt_UsuManutSalvar.Caption='Incluir' Then
     Begin
       // Inclui Usuario ----------------------------------------
       MySql:='Insert into PS_Usuarios Values('+
              QuotedStr(Dbe_UsuManutCodigo.Text)+', '+ // IntToStr(Cod)+', '+
              QuotedStr(Dbe_UsuManutNome.Text)+', '+
              QuotedStr(Dbe_UsuManutLogin.Text)+', '+
              QuotedStr(Dbe_UsuManutSenha.Text)+', '+
              QuotedStr(DBCB_UsuManutAdmin.Text)+', '+
              QuotedStr(DBCB_UsuManutAtivo.Text)+', '+
              QuotedStr(Cod_Usuario)+', '+
              'Current_Date, Null, null)';
       DMBelShop.SQLC.Execute(MySql,nil,nil);
     End
    Else // If Bt_UsuManutSalvar.Caption='Incluir' Then
     Begin
       // Cod:=DMBelShop.CDS_Usuario.FieldByName('Cod_Usuario').AsInteger;

       // Altera Usuario ----------------------------------------
       MySql:='Update PS_Usuarios Set'+
              ' Des_Usuario='+QuotedStr(Dbe_UsuManutNome.Text)+', '+
              ' Des_Login='+QuotedStr(Dbe_UsuManutLogin.Text)+', '+
              ' Des_Senha='+QuotedStr(Dbe_UsuManutSenha.Text)+', '+
              ' Ind_Admin='+QuotedStr(DBCB_UsuManutAdmin.Text)+', '+
              ' Ind_Ativo='+QuotedStr(DBCB_UsuManutAtivo.Text)+', '+
              ' Usu_Altera='+QuotedStr(Cod_Usuario)+', '+
              ' Dta_Altera=Current_Date'+
              ' Where Cod_Usuario='+QuotedStr(Dbe_UsuManutCodigo.Text); // ' Where Cod_Usuario='+IntToStr(Cod);
       DMBelShop.SQLC.Execute(MySql,nil,nil);

       // Acerta Permisses ====================================================
       If DMBelShop.CDS_Usuario.FieldByName('Des_login').NewValue<>DMBelShop.CDS_Usuario.FieldByName('Des_login').OldValue Then
       Begin
         MySql:=' UPDATE SEGURANCA s'+
                ' SET s.usuario='+QuotedStr(VarToStr(DMBelShop.CDS_Usuario.FieldByName('Des_login').NewValue))+
                ' WHERE s.usuario='+QuotedStr(VarToStr(DMBelShop.CDS_Usuario.FieldByName('Des_login').OldValue));
         DMBelShop.SQLC.Execute(MySql,nil,nil);
       End; // If DMBelShop.CDS_Usuario.FieldByName('Des_login').NewValue<>DMBelShop.CDS_Usuario.FieldByName('Des_login').OldValue Then
     End; // If Bt_UsuManutSalvar.Caption='Incluir' Then

    DMBelShop.SQLC.Commit(TD);

    Bt_UsuManutVoltarClick(Self);

    DMBelShop.CDS_Usuario.Locate('Cod_Usuario',QuotedStr(Dbe_UsuManutCodigo.Text),[]);

    Screen.Cursor:=crDefault;
  Except
    on e : Exception do
    begin
      DMBelShop.SQLC.Rollback(TD);

      Screen.Cursor:=crDefault;
      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);

      Bt_UsuManutVoltarClick(Self);
    end;
  End;

end;

procedure TFrmBelShop.Bt_UsuManutSenhaClick(Sender: TObject);
begin
  Bt_UsuManutSenha.Enabled:=False;
  Bt_UsuManutVoltar.Enabled:=False;
  Bt_UsuManutSalvar.Enabled:=False;

  EdtUsuManutSenhaAtual.Clear;
  EdtUsuManutSenhaNova.Clear;
  EdtUsuManutSenhaRepete.Clear;

  If Gb_UsuManutSenha.Visible Then
  Begin
    Gb_UsuManutSenha.Visible:=False;
    Dbe_UsuManutNome.SetFocus;
  End
  Else
  Begin
    Gb_UsuManutSenha.Visible:=True;
    EdtUsuManutSenhaAtual.SetFocus;
  End;

end;

procedure TFrmBelShop.EdtUsuManutSenhaAtualExit(Sender: TObject);
begin
   If EncriptaSTR(trim(EdtUsuManutSenhaAtual.Text),40,30,20)<>Dbe_UsuManutSenha.Text Then
   Begin
     If msg('Senha Informada NO Corresponde a Atual !!'+cr+cr+'Deseja Sair do Mdulo de Senha','C')=2 Then
     Begin
       EdtUsuManutSenhaAtual.SetFocus;
       Exit;
     End;

     Bt_UsuManutSenhaSalvaClick(Bt_UsuManutSenhaFecha);
   end;
end;

procedure TFrmBelShop.EdtUsuManutSenhaRepeteExit(Sender: TObject);
begin
  If EdtUsuManutSenhaRepete.Text<>EdtUsuManutSenhaNova.Text Then
  Begin
    msg('Senha NOVA NO Corresponde a REPETIDA !!'+cr+cr+'Favor Refazer as Informaes','A');
    EdtUsuManutSenhaNova.SetFocus;
    Exit;
  end;

end;

procedure TFrmBelShop.Bt_UsuManutSenhaSalvaClick(Sender: TObject);
begin

  // Grava Nova Senha ==========================================================
  If (Sender is TJvXPButton) Then
  Begin
    If (Sender as TJvXPButton).Name='Bt_UsuManutSenhaSalva' Then
    Begin
      If Trim(EdtUsuManutSenhaNova.Text)='' Then
       Begin
         If msg('Gravar Usurio SEM Senha ??','C')=2 Then
         Begin
           EdtUsuManutSenhaAtual.SetFocus;
           Exit;
         end;
         Dbe_UsuManutSenha.Clear;
       End
      Else
       Begin
         Dbe_UsuManutSenha.Text:=EncriptaSTR(trim(EdtUsuManutSenhaNova.Text),40,30,20);
       End;
    End; // If (Sender as TJvXPButton).Name='Bt_UsuManutSenhaFecha' Then
  End; // If (Sender is TJvXPButton) Then

  Gb_UsuManutSenha.Visible:=False;

  Bt_UsuManutSenha.Enabled:=True;
  Bt_UsuManutVoltar.Enabled:=True;
  Bt_UsuManutSalvar.Enabled:=True;

  Dbe_UsuManutNome.SetFocus;

end;

procedure TFrmBelShop.SubMenuProtUsuariosPermissesdeAcessoClick(Sender: TObject);
Var
  MySql: String;
begin

  // Cria Form Permissoes ======================================================
  FrmAcessosUsuario:=TFrmAcessosUsuario.Create(Self);

  TabSheetInvisivel(FrmAcessosUsuario);
  FrmAcessosUsuario.Ts_AcessoGerenciador.TabVisible:=True;

  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // indica em qual formulario esta o menu principal
  MySql:=' SELECT m.cod_menu, m.des_menu, m.des_form'+
         ' FROM per_menus m'+
         ' ORDER BY 1';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    FrmAcessosUsuario.Cbx_Menu.Items.Add(DMBelShop.CDS_BuscaRapida.FieldByName('Des_Menu').AsString);

    DMBelShop.CDS_BuscaRapida.Next;
  End;
  DMBelShop.CDS_BuscaRapida.Close;


  FrmAcessosUsuario.Cbx_Menu.ItemIndex:=0;
  FrmAcessosUsuario.TreeSeguranca.pFormulario := FrmBelShop;

  FrmAcessosUsuario.ShowModal;
  FreeAndNil(FrmAcessosUsuario);
end;

procedure TFrmBelShop.Rb_UsuAtivoSimClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_UsuAtivoNao);
  AcertaRb_Style(Rb_UsuAtivoAmbos);
  AcertaRb_Style(Rb_UsuAtivoSim);
end;

procedure TFrmBelShop.PopM_UsuSenhaPopup(Sender: TObject);
begin
//  PopM_UsuSenha.Items.Items[0].Caption:='Usurios...';
  If (bgInd_Admin) and (Not DMBelShop.CDS_Usuario.IsEmpty) Then
   PopM_UsuSenha.Items.Items[0].Caption:=DecriptaSTR(
              DMBelShop.CDS_Usuario.FieldByName('Des_Senha').AsString,40,30,20);
end;

procedure TFrmBelShop.Bt_ConEmpresasBuscaEstadoClick(Sender: TObject);
Var
  MySql: String;
Begin
  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:='Select Des_Estado, Cod_Estado, Des_UF'+
         ' From Estados_IBGE'+
         ' Order by Des_Estado';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('Cod_Estado').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    DMBelShop.CDS_Pesquisa.Close;
    FreeAndNil(FrmPesquisa);
    EdtConEmpresasEstado.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Des_Estado';
  FrmPesquisa.Campo_Codigo:='Cod_Estado';
  FrmPesquisa.Campo_Descricao:='Des_UF';
  FrmPesquisa.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
  Begin
    DMBelShop.CDS_Empresa.FieldByName('Cod_UF').AsString:=FrmPesquisa.EdtDescricao.Text;
    EdtConEmpresasEstado.Text:=Separa_String(NomeUfEstado(Dbe_ConEmpresasUF.Text),1);
    Bt_ConEmpresasBuscaMunicipio.SetFocus;
  End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.Bt_ConEmpresasBuscaMunicipioClick(Sender: TObject);
Var
  MySql: String;
begin

  If Trim(Dbe_ConEmpresasUF.Text)='' Then
  Begin
    msg('Favor Informar o Estado (UF) !!','A');
    Dbe_ConEmpresasUF.SetFocus;
    Exit;
  end;

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:='Select Des_Municipio, Cod_Municipio, Des_UF'+
         ' From Municipios_IBGE'+
         ' Where Des_UF='+QuotedStr(Dbe_ConEmpresasUF.Text)+
         ' Order by Des_Municipio';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('Cod_Municipio').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    DMBelShop.CDS_Pesquisa.Close;
    FreeAndNil(FrmPesquisa);
    Bt_ConEmpresasBuscaMunicipio.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Des_Municipio';
  FrmPesquisa.Campo_Codigo:='Cod_Municipio';
  FrmPesquisa.Campo_Descricao:='Des_Municipio';
  FrmPesquisa.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
  Begin
    DMBelShop.CDS_Empresa.FieldByName('Des_Cidade').AsString:=FrmPesquisa.EdtDescricao.Text;
    Perform(WM_NEXTDLGCTL, 0, 0);
  End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.Bt_ConEmpresasNovoClick(Sender: TObject);
begin
  Screen.Cursor:=crAppStart;

  // Insere ====================================================================
  DMBelShop.CDS_Empresa.Insert;
  DMBelShop.CDS_Empresa.FieldByName('Tip_Emp').AsString:='F';
  DMBelShop.CDS_Empresa.FieldByName('Ind_Ativo').AsString:='SIM';

  Me_ConEmpresasCEP.Clear;
  Me_ConEmpresasCNPJ.Clear;
  EdtDta_ConEmpresasInicioLinx.Clear;
  EdtDta_ConEmpresasInventLinx.Clear;
  EdtConEmpresasEstado.Clear;

  // Libera Insero ===========================================================
  LiberaCamposSidicom(True);

  Pan_ConEmpresasDados.Enabled:=True;
  Pan_ConEmpresasDados.Color:=$00DADADA;
  Dbg_ConEmpresas.Enabled:=False;
  Dbg_ConEmpresas.Color:=$00E2E2E2;

  Bt_ConEmpresasDML.Caption:='Incluir';
  Bt_ConEmpresasDML.Enabled:=True;
  Bt_ConEmpresasVoltar.Enabled:=True;

  Bt_ConEmpresasNovo.Enabled:=False;
  Bt_ConEmpresasDetalhar.Enabled:=False;
  Bt_ConEmpresasFechar.Enabled:=False;

  Dbe_ConEmpresasCodEmp.SetFocus;

  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.Bt_ConEmpresasDetalharClick(Sender: TObject);
begin

  If DMBelShop.CDS_Empresa.IsEmpty Then
  Begin
    msg('SEM Empresa a DETALHAR !!' ,'A');
    Exit;
  End;

  Screen.Cursor:=crAppStart;

  // Edita =====================================================================
  DMBelShop.CDS_Empresa.Edit;

  // Libera Edio =============================================================
  LiberaCamposSidicom(False);

  Pan_ConEmpresasDados.Enabled:=True;
  Pan_ConEmpresasDados.Color:=$00DADADA;
  Dbg_ConEmpresas.Enabled:=False;
  Dbg_ConEmpresas.Color:=$00E2E2E2;

  Bt_ConEmpresasDML.Caption:='Alterar';
  Bt_ConEmpresasDML.Enabled:=True;
  Bt_ConEmpresasVoltar.Enabled:=True;

  Bt_ConEmpresasNovo.Enabled:=False;
  Bt_ConEmpresasDetalhar.Enabled:=False;
  Bt_ConEmpresasFechar.Enabled:=False;

  Dbe_ConEmpresasRazaoSocial.SetFocus;

  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.Bt_ConEmpresasDMLClick(Sender: TObject);
Var
  Cod: Integer;
  MySql: String;
  i: Integer;
  bDeleteConexao, bDesconecta: Boolean;
begin
  Dbe_ConEmpresasCodEmp.SetFocus;

  If Not DMBelShop.ConsisteConexaoEmpresas Then
  Begin
    If Trim(sgMensagem)<>'' Then
     msg(sgMensagem,'A');
    Exit;
  End;

  Try
    Screen.Cursor:=crAppStart;

    // Monta Transacao =========================================================
    TD.TransactionID:=Cardinal(FormatDateTime('ddmmyyyy',now)+FormatDateTime('hhnnss',now));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);

    Cod:=DMBelShop.CDS_Empresa.FieldByName('Cod_Emp').AsInteger;
    DateSeparator:='.';

    If Bt_ConEmpresasDML.Caption='Incluir' Then
     Begin
       MySql:='Insert into EMP_CONEXOES ('+
              ' COD_FILIAL, ENDERECO_IP, ENDERECO_IP_EXTERNO, PASTA_BASE_DADOS,'+
              ' DES_BASE_DADOS, COD_EMP, RAZAO_SOCIAL, TIP_EMP, DES_BAIRRO,'+
              ' DES_CIDADE, COD_UF, COD_CEP, NUM_CNPJ, INSCR_ESTADUAL,'+
              ' DES_ENDERECO, NUM_ENDERECO, COMPL_ENDERECO, COD_LISTAPRE, IND_ATIVO,'+
              ' USU_INCLUI, NUM_SINDICATO, NUM_ALVARA_MUN, COD_CONTABIL,'+
              ' COD_LINX, DTA_INICIO_LINX, DTA_INVENTARIO_LINX)'+

              ' Values('+
              ' :COD_FILIAL, :ENDERECO_IP, :ENDERECO_IP_EXTERNO, :PASTA_BASE_DADOS,'+
              ' :DES_BASE_DADOS, :COD_EMP, :RAZAO_SOCIAL, :TIP_EMP, :DES_BAIRRO,'+
              ' :DES_CIDADE, :COD_UF, :COD_CEP, :NUM_CNPJ, :INSCR_ESTADUAL,'+
              ' :DES_ENDERECO, :NUM_ENDERECO, :COMPL_ENDERECO, :COD_LISTAPRE, :IND_ATIVO,'+
              ' :USU_INCLUI, :NUM_SINDICATO, :NUM_ALVARA_MUN, :COD_CONTABIL,'+
              ' :COD_LINX, :DTA_INICIO_LINX, :DTA_INVENTARIO_LINX)';
       DMBelShop.SQLQuery1.Close;
       DMBelShop.SQLQuery1.SQL.Clear;
       DMBelShop.SQLQuery1.SQL.Add(MySql);

       DMBelShop.SQLQuery1.Params.ParamByName('COD_FILIAL').AsString          :=DMBelShop.CDS_EmpresaCOD_FILIAL.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('ENDERECO_IP').AsString         :=DMBelShop.CDS_EmpresaENDERECO_IP.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('ENDERECO_IP_EXTERNO').AsString :=DMBelShop.CDS_EmpresaENDERECO_IP_EXTERNO.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('PASTA_BASE_DADOS').AsString    :=DMBelShop.CDS_EmpresaPASTA_BASE_DADOS.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('DES_BASE_DADOS').AsString      :=DMBelShop.CDS_EmpresaDES_BASE_DADOS.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('COD_EMP').AsString             :=DMBelShop.CDS_EmpresaCOD_EMP.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('RAZAO_SOCIAL').AsString        :=DMBelShop.CDS_EmpresaRAZAO_SOCIAL.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('TIP_EMP').AsString             :=DMBelShop.CDS_EmpresaTIP_EMP.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('DES_BAIRRO').AsString          :=DMBelShop.CDS_EmpresaDES_BAIRRO.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('DES_CIDADE').AsString          :=DMBelShop.CDS_EmpresaDES_CIDADE.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('COD_UF').AsString              :=DMBelShop.CDS_EmpresaCOD_UF.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('COD_CEP').AsString             :=Tira_Mascara(Me_ConEmpresasCEP.Text);
       DMBelShop.SQLQuery1.Params.ParamByName('NUM_CNPJ').AsString            :=Tira_Mascara(Me_ConEmpresasCNPJ.Text);
       DMBelShop.SQLQuery1.Params.ParamByName('INSCR_ESTADUAL').AsString      :=DMBelShop.CDS_EmpresaINSCR_ESTADUAL.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('DES_ENDERECO').AsString        :=DMBelShop.CDS_EmpresaDES_ENDERECO.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('NUM_ENDERECO').AsString        :=DMBelShop.CDS_EmpresaNUM_ENDERECO.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('COMPL_ENDERECO').AsString      :=DMBelShop.CDS_EmpresaCOMPL_ENDERECO.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('COD_LISTAPRE').AsString        :=DMBelShop.CDS_EmpresaCOD_LISTAPRE.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('IND_ATIVO').AsString           :=DMBelShop.CDS_EmpresaIND_ATIVO.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('NUM_SINDICATO').AsString       :=DMBelShop.CDS_EmpresaNUM_SINDICATO.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('NUM_ALVARA_MUN').AsString      :=DMBelShop.CDS_EmpresaNUM_ALVARA_MUN.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('COD_CONTABIL').AsString        :=DMBelShop.CDS_EmpresaCOD_CONTABIL.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('COD_LINX').AsString            :=DMBelShop.CDS_EmpresaCOD_LINX.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('DTA_INICIO_LINX').AsString     :=DMBelShop.CDS_EmpresaDTA_INICIO_LINX.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('DTA_INVENTARIO_LINX').AsString :=DMBelShop.CDS_EmpresaDTA_INVENTARIO_LINX.AsString;
       DMBelShop.SQLQuery1.Params.ParamByName('USU_INCLUI').AsString          :=Cod_Usuario;
       DMBelShop.SQLQuery1.ExecSQL;
     End
    Else // If Bt_ConEmpresasDML.Caption='Incluir' Then
     Begin
       MySql:='Update EMP_Conexoes Set'+
              ' COD_FILIAL='+QuotedStr(Dbe_ConEmpresasCodFilial.Text)+', '+
              ' COD_EMP='+QuotedStr(Dbe_ConEmpresasCodEmp.Text)+', '+
              ' ENDERECO_IP='+QuotedStr(Dbe_ConEmpresasIP.Text)+', '+
              ' ENDERECO_IP_EXTERNO='+QuotedStr(Dbe_ConEmpresasIPExterno.Text)+', '+
              ' PASTA_BASE_DADOS='+QuotedStr(Dbe_ConEmpresasPastaBD.Text)+', '+
              ' DES_BASE_DADOS='+QuotedStr(Dbe_ConEmpresasBaseDados.Text)+', '+
              ' RAZAO_SOCIAL='+QuotedStr(Dbe_ConEmpresasRazaoSocial.Text)+', '+
              ' TIP_EMP='+QuotedStr(Dbcb_ConEmpresasTipo.Text)+', '+
              ' DES_BAIRRO='+QuotedStr(Dbe_ConEmpresasBairro.Text)+', '+
              ' DES_CIDADE='+QuotedStr(Dbe_ConEmpresasMunicipio.Text)+', '+
              ' COD_UF='+QuotedStr(Dbe_ConEmpresasUF.Text)+', '+
              ' COD_CEP='+QuotedStr(Tira_Mascara(Me_ConEmpresasCEP.Text))+', '+
              ' NUM_CNPJ='+QuotedStr(Tira_Mascara(Me_ConEmpresasCNPJ.Text))+', '+
              ' INSCR_ESTADUAL='+QuotedStr(Dbe_ConEmpresasInscrEstadual.Text)+', '+
              ' DES_ENDERECO='+QuotedStr(Dbe_ConEmpresasEndereco.Text)+', '+
              ' NUM_ENDERECO='+QuotedStr(Dbe_ConEmpresasNumero.Text)+', '+
              ' COMPL_ENDERECO='+QuotedStr(Dbe_ConEmpresasComplemento.Text)+', '+
              ' IND_ATIVO='+QuotedStr(Dbcb_ConEmpresasAtivo.Text)+', '+
              ' COD_LISTAPRE='+QuotedStr(Dbe_ConEmpresasCodLP.Text)+', '+
              ' USU_ALTERA='+QuotedStr(Cod_Usuario)+', '+
              ' DTA_ALTERA=Current_Date'+', '+
              ' NUM_SINDICATO='+QuotedStr(Dbe_ConEmpresasNumSindicato.Text)+', '+
              ' NUM_ALVARA_MUN='+QuotedStr(Dbe_ConEmpresasNumAlvaraMun.Text)+', '+
              ' COD_CONTABIL='+QuotedStr(Dbe_ConEmpresasCodContabil.Text)+', ';

              If (Trim(EdtDta_ConEmpresasInicioLinx.Text)<>'') and (Trim(EdtDta_ConEmpresasInicioLinx.Text)<>'/  /') Then
               Begin
                 MySql:=
                  MySql+ ' DTA_INICIO_LINX='+QuotedStr(f_Troca('/','.',f_Troca('-','.',EdtDta_ConEmpresasInicioLinx.Text)))+', ';
               End
              Else
               Begin
                 MySql:=
                  MySql+ ' DTA_INICIO_LINX=NULL, ';
               End;

              If (Trim(EdtDta_ConEmpresasInventLinx.Text)<>'') and (Trim(EdtDta_ConEmpresasInventLinx.Text)<>'/  /') Then
               Begin
                 MySql:=
                  MySql+ ' DTA_INVENTARIO_LINX='+QuotedStr(f_Troca('/','.',f_Troca('-','.',EdtDta_ConEmpresasInventLinx.Text)))+', ';
               End
              Else
               Begin
                 MySql:=
                  MySql+ ' DTA_INVENTARIO_LINX=NULL, ';
               End;

       MySql:=
        MySql+' COD_LINX='+QuotedStr(Dbe_ConEmpresasCodLojaLinx.Text)+

              ' Where Cod_Emp='+
              QuotedStr(DMBelShop.CDS_Empresa.FieldByName('Cod_Emp').OldValue)+
              ' And Cod_Filial='+
              QuotedStr(DMBelShop.CDS_Empresa.FieldByName('Cod_Filial').OldValue);
       DMBelShop.SQLC.Execute(MySql,nil,nil);
     End; // If Bt_ConEmpresasDML.Caption='Incluir' Then

    // Acerta Conexoes =========================================================
    If DMVirtual.CDS_V_EmpConexoes.Active Then
    Begin
      If Trim(DMBelShop.CDS_Empresa.FieldByName('Cod_Emp').OldValue)<>'' Then
       i:=DMBelShop.CDS_Empresa.FieldByName('Cod_Emp').OldValue
      Else
       i:=DMBelShop.CDS_Empresa.FieldByName('Cod_Emp').NewValue;

      // Localiza Conexo da Empresa ----------------------------------
      bDesconecta:=False;
      bDeleteConexao:=False;
      If DMVirtual.CDS_V_EmpConexoes.Locate('Cod_Emp',i,[]) Then
       Begin
         If (DMVirtual.CDS_V_EmpConexoesCOD_FILIAL.AsString<>Dbe_ConEmpresasCodFilial.Text) Or
         (DMVirtual.CDS_V_EmpConexoesCOD_EMP.AsString<>Dbe_ConEmpresasCodEmp.Text) Or
         (DMVirtual.CDS_V_EmpConexoesPASTA_BASE_DADOS.AsString<>Dbe_ConEmpresasPastaBD.Text) Or
         (DMVirtual.CDS_V_EmpConexoesDES_BASE_DADOS.AsString<>Dbe_ConEmpresasBaseDados.Text) Or
         (DMVirtual.CDS_V_EmpConexoesIND_ATIVO.AsString<>Dbcb_ConEmpresasAtivo.Text) Or
         ((DMVirtual.CDS_V_EmpConexoesENDERECO_IP.AsString<>Dbe_ConEmpresasIP.Text) and
          (DMVirtual.CDS_V_EmpConexoesENDERECO_IP.AsString<>Dbe_ConEmpresasIPExterno.Text)) Then
         Begin
           bDesconecta:=True;
           If Dbcb_ConEmpresasAtivo.Text='NAO' Then
            Begin
              DMVirtual.CDS_V_EmpConexoes.Delete;
              bDeleteConexao:=True;
            End;
         End; // If (DMVirtual.CDS_V_EmpConexoesCOD_FILIAL.AsString<>Dbe_ConEmpresasCodFilial.Text) Or ...

         If Not bDeleteConexao Then
          DMVirtual.CDS_V_EmpConexoes.Edit;
       End
      Else  // If DMVirtual.CDS_V_EmpConexoes.Locate('Cod_Emp',i,[]) Then
       Begin
         If Dbcb_ConEmpresasAtivo.Text='SIM' Then
         Begin
           DMVirtual.CDS_V_EmpConexoes.Insert;
         End;
       End; // If DMVirtual.CDS_V_EmpConexoes.Locate('Cod_Emp',i.[]) Then

      // Efetua DML ---------------------------------------------
      If (DMVirtual.CDS_V_EmpConexoes.State=dsInsert) Or (DMVirtual.CDS_V_EmpConexoes.State=dsEdit) Then
      Begin
        If DMVirtual.CDS_V_EmpConexoes.State=dsInsert Then
         DMVirtual.CDS_V_EmpConexoesCONECTAR.AsString:='SIM';

        DMVirtual.CDS_V_EmpConexoesCOD_FILIAL.AsString:=Dbe_ConEmpresasCodFilial.Text;

        If (Not bgConexaoLocal) and (Trim(Dbe_ConEmpresasIPExterno.Text)<>'') Then
         DMVirtual.CDS_V_EmpConexoesENDERECO_IP.AsString:=Dbe_ConEmpresasIPExterno.Text
        Else
         DMVirtual.CDS_V_EmpConexoesENDERECO_IP.AsString:=Dbe_ConEmpresasIP.Text;

        DMVirtual.CDS_V_EmpConexoesPASTA_BASE_DADOS.AsString:=Dbe_ConEmpresasPastaBD.Text;
        DMVirtual.CDS_V_EmpConexoesDES_BASE_DADOS.AsString  :=Dbe_ConEmpresasBaseDados.Text;
        DMVirtual.CDS_V_EmpConexoesCOD_EMP.AsString         :=Dbe_ConEmpresasCodEmp.Text;
        DMVirtual.CDS_V_EmpConexoesRAZAO_SOCIAL.AsString    :=Dbe_ConEmpresasRazaoSocial.Text;
        DMVirtual.CDS_V_EmpConexoesTIP_EMP.AsString         :=Dbcb_ConEmpresasTipo.Text;
        DMVirtual.CDS_V_EmpConexoesDES_BAIRRO.AsString      :=Dbe_ConEmpresasBairro.Text;
        DMVirtual.CDS_V_EmpConexoesDES_CIDADE.AsString      :=Dbe_ConEmpresasMunicipio.Text;
        DMVirtual.CDS_V_EmpConexoesCOD_UF.AsString          :=Dbe_ConEmpresasUF.Text;
        DMVirtual.CDS_V_EmpConexoesCOD_CEP.AsString         :=Tira_Mascara(Me_ConEmpresasCEP.Text);
        DMVirtual.CDS_V_EmpConexoesNUM_CNPJ.AsString        :=Tira_Mascara(Me_ConEmpresasCNPJ.Text);
        DMVirtual.CDS_V_EmpConexoesINSCR_ESTADUAL.AsString  :=Dbe_ConEmpresasInscrEstadual.Text;
        DMVirtual.CDS_V_EmpConexoesDES_ENDERECO.AsString    :=Dbe_ConEmpresasEndereco.Text;
        DMVirtual.CDS_V_EmpConexoesNUM_ENDERECO.AsString    :=Dbe_ConEmpresasNumero.Text;
        DMVirtual.CDS_V_EmpConexoesCOMPL_ENDERECO.AsString  :=Dbe_ConEmpresasComplemento.Text;
        DMVirtual.CDS_V_EmpConexoesIND_ATIVO.AsString       :=Dbcb_ConEmpresasAtivo.Text;

        DMVirtual.CDS_V_EmpConexoesCOD_LINX.AsString             :=Dbe_ConEmpresasCodLojaLinx.Text;
        DMVirtual.CDS_V_EmpConexoesDTA_INICIO_LINX.AsDateTime    :=EdtDta_ConEmpresasInicioLinx.Date;
        DMVirtual.CDS_V_EmpConexoesDTA_INVENTARIO_LINX.AsDateTime:=EdtDta_ConEmpresasInventLinx.Date;

        If (bDesconecta) or (DMVirtual.CDS_V_EmpConexoes.State=dsInsert) Then
         DMVirtual.CDS_V_EmpConexoesCONEXAO.AsString:='No';

        DMVirtual.CDS_V_EmpConexoesDATABASE.AsString  :='IBDB_'+Dbe_ConEmpresasCodFilial.Text;
        DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString :='IBT_'+Dbe_ConEmpresasCodFilial.Text;
        DMVirtual.CDS_V_EmpConexoes.Post;
      End; // If (DMVirtual.CDS_V_EmpConexoes.State=dsInsert) Or (DMVirtual.CDS_V_EmpConexoes.State=dsEdit) Then
    End; // If DMVirtual.CDS_V_EmpConexoes.Active Then

    DateSeparator:='/';

    DMBelShop.SQLC.Commit(TD);

    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    begin
       DMBelShop.SQLC.Rollback(TD);

       MontaProgressBar(False, FrmBelShop);
       Screen.Cursor:=crDefault;
       MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);

       Bt_ConEmpresasVoltarClick(Self);
    end;
  End;

  DMBelShop.CDS_Empresa.Close;
  DMBelShop.CDS_Empresa.IndexFieldNames:='';
  DMBelShop.CDS_Empresa.Open;
  DMBelShop.CDS_Empresa.Locate('Cod_Emp',cod,[]);

  LiberaCamposSidicom(False);

  Bt_ConEmpresasVoltarClick(Self);

end;

procedure TFrmBelShop.Bt_ConEmpresasVoltarClick(Sender: TObject);
begin
  Dbe_ConEmpresasCodEmp.SetFocus;

  If (DMBelShop.CDS_Empresa.State=dsInsert) Or (DMBelShop.CDS_Empresa.State=dsEdit) Then
   DMBelShop.CDS_Empresa.CancelUpdates;

  Pan_ConEmpresasDados.Enabled:=False;
  Pan_ConEmpresasDados.Color:=$00DADADA;
  Dbg_ConEmpresas.Enabled:=True;
  Dbg_ConEmpresas.Color:=clWindow;

  Bt_ConEmpresasDML.Enabled:=False;
  Bt_ConEmpresasVoltar.Enabled:=False;

  Bt_ConEmpresasNovo.Enabled:=True;
  Bt_ConEmpresasDetalhar.Enabled:=True;
  Bt_ConEmpresasFechar.Enabled:=True;

  LiberaCamposSidicom(False);

  Dbg_ConEmpresas.SetFocus;
end;

procedure TFrmBelShop.Dbg_ConEmpresasTitleClick(Column: TColumn);
begin
  If (OrderGrid='') or (OrderGrid='Crescente') Then
   Begin
     OrderByGrid(DMBelShop.CDS_Empresa, Dbg_ConEmpresas, Column.FieldName, False);
     OrderGrid:='Decrescente';
   End
  Else
   Begin
     OrderByGrid(DMBelShop.CDS_Empresa, Dbg_ConEmpresas, Column.FieldName, True);
     OrderGrid:='Crescente';
   End

end;

procedure TFrmBelShop.PC_OrdemCompraChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_OrdemCompra);

  If (PC_OrdemCompra.ActivePage=Ts_OCBuscaProdutos) And (Ts_OCBuscaProdutos.CanFocus) Then
   CB_Mes1.SetFocus;

  If (PC_OrdemCompra.ActivePage=Ts_OCGeraOrdemCompra) And (Ts_OCGeraOrdemCompra.CanFocus) Then
  Begin
    PC_GeraOCApresentacaoChange(Self);
    If EdtGeraOCBuscaDocto.AsInteger=0 Then
      EdtGeraOCBuscaDocto.SetFocus
    Else
     PC_GeraOCApresentacaoChange(Self);
  End;

  If (PC_OrdemCompra.ActivePage=Ts_OCGeraEditaOrdemCompra) And (Ts_OCGeraEditaOrdemCompra.CanFocus) Then
  Begin
    Dbg_GeraOCEditaGrid.SelectedIndex:=2;
    Dbg_GeraOCEditaGrid.SetFocus;
  End;

end;

procedure TFrmBelShop.Ckb_GeraOCCalculoTransitoClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_GeraOCCalculoTransito);
end;

procedure TFrmBelShop.PC_FiltrosChange(Sender: TObject);
begin
  Try
    CorSelecaoTabSheet(PC_Filtros);

    If (PC_Filtros.ActivePage=TS_FiltroFornecedor) and (TS_FiltroFornecedor.CanFocus) Then
     EdtFiltroCodForn.SetFocus;

    If (PC_Filtros.ActivePage=TS_FiltroProdutos) and (TS_FiltroProdutos.CanFocus) Then
     EdtFiltroCodProduto.SetFocus;

    If (PC_Filtros.ActivePage=TS_FiltroGrupos) and (TS_FiltroGrupos.CanFocus) Then
     EdtFiltroCodGrupo.SetFocus;

    If (PC_Filtros.ActivePage=TS_FiltroAplicacao) and (TS_FiltroAplicacao.CanFocus) Then
     EdtOCCodAplicacao.SetFocus;

    If (PC_Filtros.ActivePage=TS_FiltroFamiliaPreco) and (TS_FiltroFamiliaPreco.CanFocus) Then
     EdtOCCodFamiliaPrecos.SetFocus;

    If (PC_Filtros.ActivePage=TS_FiltroGrupoST) and (TS_FiltroGrupoST.CanFocus) Then
     EdtFiltroCodGrupoST.SetFocus;

    If (PC_Filtros.ActivePage=TS_FiltroComprovantes) and (TS_FiltroComprovantes.CanFocus) Then
     EdtFiltroCodComprov.SetFocus;
  Except
  End;
end;

procedure TFrmBelShop.Ckb_GeraOCCalculoEstoqueClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_GeraOCCalculoEstoque);
end;

procedure TFrmBelShop.EdtFiltroCodFornExit(Sender: TObject);
Var
  MySql: String;
  bSiga: Boolean;
begin

  If EdtFiltroCodForn.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Fornecedores =======================================================
    bSiga:=True;
    If (PC_ConsultaMovtoCompr.Visible) and (PC_ConsultaMovtoCompr.CanFocus) Then
    Begin
      MySql:=' SELECT f.nomefornecedor, f.codfornecedor'+
             ' FROM FORNECED f'+
             ' WHERE f.codfornecedor='+VarToStr(EdtFiltroCodForn.Value);
      bSiga:=False;
    End;

    If bSiga Then
    Begin
      MySql:='select First 1 f.nomefornecedor, f.codfornecedor'+
             ' from produto p, forneced f'+
             ' where p.principalfor=f.codfornecedor';

             If Painel_FiltroNaoCompra.Visible Then
             Begin
               If Not Ckb_FiltroProdNaoCompra.Checked Then
                MySql:=MySql+' And Coalesce(p.situacaopro,0)=0'
               Else
                MySql:=MySql+' And Coalesce(p.situacaopro,0) in (0,3)';
             End;

             Try
               Cbx_EstFisFinanSituacaoProd.SetFocus;
               If Cbx_EstFisFinanSituacaoProd.ItemIndex=0      Then MySql:=MySql+' And Coalesce(p.situacaopro,0)=0'
               Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then MySql:=MySql+' And Coalesce(p.situacaopro,3)=3'
               Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then MySql:=MySql+' And Coalesce(p.situacaopro,0) in (0,3)';
             Except
             End;

             Try
               Cbx_ConsultaNfeSituacaoProd.SetFocus;
               If Cbx_ConsultaNfeSituacaoProd.ItemIndex=0      Then MySql:=MySql+' And Coalesce(p.situacaopro,0)=0'
               Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then MySql:=MySql+' And Coalesce(p.situacaopro,3)=3'
               Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then MySql:=MySql+' And Coalesce(p.situacaopro,0) in (0,3)';
             Except
             End;


      MySql:=
       MySql+' And f.codfornecedor='+QuotedStr(FormatFloat('000000',EdtFiltroCodForn.AsInteger));

      bSiga:=False;
    End;
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('codfornecedor').AsString)='' Then
    Begin
      msg('Fornecedor NO Encontrado !!!', 'A');
      IBQ_MPMS.Close;
      EdtFiltroCodForn.Clear;
      EdtFiltroCodForn.SetFocus;
      Exit;
    End;

    If DMVirtual.CDS_V_Fornecedores.Locate('Cod_Fornecedor',IBQ_MPMS.FieldByName('CodFornecedor').AsString,[]) Then
    Begin
      Begin
        msg('Fornecedor J Informado !!','A');
        IBQ_MPMS.Close;
        EdtFiltroCodForn.Clear;
        EdtFiltroCodForn.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_Fornecedores.Insert;
    DMVirtual.CDS_V_FornecedoresCod_Fornecedor.AsString:=
                                 IBQ_MPMS.FieldByName('CodFornecedor').AsString;
    DMVirtual.CDS_V_FornecedoresDes_Fornecedor.AsString:=
                                IBQ_MPMS.FieldByName('NomeFornecedor').AsString;
    DMVirtual.CDS_V_Fornecedores.Post;

    // Monta sFornecedore
    MontaSelectFornecedores;

    IBQ_MPMS.Close;
    EdtFiltroCodForn.Text:='0';
    EdtFiltroCodForn.SetFocus;
  End;
end;

procedure TFrmBelShop.EdtFiltroCodGrupoExit(Sender: TObject);
Var
  MySql: String;
begin

  If EdtFiltroCodGrupo.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Grupos ============================================================
    MySql:='select g.NomeGrupo, g.CodGrupo'+
           ' from Grupo g'+
           ' where g.codgrupo=+'+VarToStr(EdtFiltroCodGrupo.Value);
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('CodGrupo').AsString)='' Then
    Begin
      msg('Grupo NO Encontrado !!!', 'A');
      IBQ_MPMS.Close;
      EdtFiltroCodGrupo.Clear;
      EdtFiltroCodGrupo.SetFocus;
      Exit;
    End;

    If DMVirtual.CDS_V_GruposProdutos.Locate('Cod_Grupo',IBQ_MPMS.FieldByName('CodGrupo').AsString,[]) Then
    Begin
      Begin
        msg('Grupo J Informado !!','A');
        IBQ_MPMS.Close;
        EdtFiltroCodGrupo.Clear;
        EdtFiltroCodGrupo.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_GruposProdutos.Insert;
    DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString:=
                                      IBQ_MPMS.FieldByName('CodGrupo').AsString;
    DMVirtual.CDS_V_GruposProdutosDes_Grupo.AsString:=
                                     IBQ_MPMS.FieldByName('NomeGrupo').AsString;
    DMVirtual.CDS_V_GruposProdutos.Post;

    IBQ_MPMS.Close;
    EdtFiltroCodGrupo.Text:='0';
    EdtFiltroCodGrupo.SetFocus;
  End;
end;

procedure TFrmBelShop.EdtFiltroCodSubGrupoExit(Sender: TObject);
Var
  MySql: String;
begin
  If DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin
    msg('Favor Selecioanr o Grupo de Produtos !!','A');
    EdtFiltroCodGrupo.SetFocus;
    Exit;
  End;

  If EdtFiltroCodSubGrupo.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Sub-Grupos ========================================================
    MySql:='select sg.NomeSubGrupo, sg.CodSubGrupo'+
           ' from GrupoSub sg'+
           ' where sg.codgrupo='+
           QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString)+
           ' and sg.codsubgrupo='+VarToStr(EdtFiltroCodSubGrupo.Value);
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('CodSubGrupo').AsString)='' Then
    Begin
      msg('Sub-Grupo NO Encontrado !!!', 'A');
      IBQ_MPMS.Close;
      EdtFiltroCodSubGrupo.Clear;
      EdtFiltroCodSubGrupo.SetFocus;
      Exit;
    End;

    If DMVirtual.CDS_V_SubGruposProdutos.Locate('Cod_Grupo; Cod_SubGrupo',
       VarArrayOf([DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString,
       IBQ_MPMS.FieldByName('CodSubGrupo').AsString]),[]) Then
    Begin
      msg('Sub-Grupo J Informado !!','A');
      IBQ_MPMS.Close;
      EdtFiltroCodSubGrupo.Clear;
      EdtFiltroCodSubGrupo.SetFocus;
      Exit;
    End;

    DMVirtual.CDS_V_SubGruposProdutos.Insert;
    DMVirtual.CDS_V_SubGruposProdutosCod_Grupo.AsString:=
                               DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString;
    DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString:=
                              (DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+
                                  IBQ_MPMS.FieldByName('CodSubGrupo').AsString);
    DMVirtual.CDS_V_SubGruposProdutosCod_SubGrupo.AsString:=
                                   IBQ_MPMS.FieldByName('CodSubGrupo').AsString;
    DMVirtual.CDS_V_SubGruposProdutosDes_SubGrupo.AsString:=
                                  IBQ_MPMS.FieldByName('NomeSubGrupo').AsString;
    DMVirtual.CDS_V_SubGruposProdutos.Post;

    IBQ_MPMS.Close;
    EdtFiltroCodSubGrupo.Text:='0';
    EdtFiltroCodSubGrupo.SetFocus;
  End;

end;

procedure TFrmBelShop.Dbg_FiltroFornecedoresKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Key=VK_Delete) And (Trim(sgCodLojaUnica)='') Then
  Begin
    If Not DMVirtual.CDS_V_Fornecedores.IsEmpty Then
    Begin
      // Excluir os Itens --------------------------------------------
      If Not DMVirtual.CDS_V_Produtos.IsEmpty Then
      Begin
        DMVirtual.CDS_V_Produtos.Filtered:=False;
        DMVirtual.CDS_V_Produtos.Filter:='Cod_Fornecedor='+DMVirtual.CDS_V_FornecedoresCod_Fornecedor.AsString;
        DMVirtual.CDS_V_Produtos.Filtered:=True;

        DMVirtual.CDS_V_Produtos.First;
        While Not DMVirtual.CDS_V_Produtos.Eof do
         DMVirtual.CDS_V_Produtos.Delete;

        DMVirtual.CDS_V_Produtos.Filtered:=False;
        DMVirtual.CDS_V_Produtos.First;
      End; // If Not DMVirtual.CDS_V_Produtos.IsEmpty Then

      // Excluir o Fornecedor ----------------------------------------
      DMVirtual.CDS_V_Fornecedores.Delete;

      // Monta sFornecedore
      MontaSelectFornecedores;
    End; // If Not DMVirtual.CDS_V_Fornecedores.IsEmpty Then
  End; // if Key=VK_Delete Then
  Dbg_FiltroFornecedores.SetFocus;
end;

procedure TFrmBelShop.Dbg_FiltroGruposProdutosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key=VK_Delete Then
  Begin
    If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
    Begin
      // Excluir Sub-Grupo de Produto ===========================================
      While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
      Begin
        Refresh;

        DMVirtual.CDS_V_SubGruposProdutos.Delete;
      End;

      // Excluir Grupo de Produto ===============================================
      DMVirtual.CDS_V_GruposProdutos.Delete;
    End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  End; // if Key=VK_Delete Then

  Dbg_FiltroGruposProdutos.SetFocus;
end;

procedure TFrmBelShop.Dbg_FiltroSubGruposProdutosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key=VK_Delete Then
   If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
    DMVirtual.CDS_V_SubGruposProdutos.Delete;

  Dbg_FiltroSubGruposProdutos.SetFocus;
end;

procedure TFrmBelShop.Bt_OCBuscaProdutosClick(Sender: TObject);
Var
  MySql: String;
  hHrInicio, hHrFim,
  sDtaDocto: String;
  b: Boolean;
begin

  Lb_EmpAprocessar.Caption:='0';
  Img_Calculo.Visible:=False;

  If (Not Rb_CalculoTpProcLocal.Checked) and (Not Rb_CalculoTpProcLoja.Checked) Then
  Begin
    Img_Calculo.Visible:=True;
    msg('Favor Selecionar o'+cr+'Tipo de Processamento !!','A');
    Rb_CalculoTpProcLocal.SetFocus;
    Exit;
  End; // If (Not Rb_CalculoTpProcLocal.Checked) and (Not Rb_CalculoTpProcLoja.Checked) Then

  sgOutrasEmpresa:='(''89'',''99'')';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=True;
  FrmSelectEmpProcessamento.Pan_SelectEmpProcECommerce.Visible:=True;

  FrmSelectEmpProcessamento.ShowModal;

  // Se Processa Produtos E-Commerce ===========================================
  bgECommerce:=FrmSelectEmpProcessamento.Ckb_SelectEmpProcECommerce.Checked;
  Lb_EmpAprocessar.Caption:=IntToStr(FrmSelectEmpProcessamento.iNrEmpProc);

  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Processa Todas as Empresas ====================================
  sgEmpresas:='';
  bgTodasEmpresas:=True;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       // Atualiza sgEmpresa para Sql ---------------------------------
       If sgEmpresas='' Then
        sgEmpresas:=QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString)
       Else
        sgEmpresas:=sgEmpresas+', '+QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);
     End
    Else // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       bgTodasEmpresas:=False;
     End; // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  If sgEmpresas='' Then
  Begin
    CB_Mes1.SetFocus;
    Exit;
  End; // If sgEmpresas='' Then

  If msg('Deseja Realmente Iniciar o Calculo ??','C')=2 Then
  Begin
    Lb_EmpAprocessar.Caption:='0';
    CB_Mes1.SetFocus;
    Exit;
  End;

  // Inicia o Processameto =====================================================
  hHrInicio:=TimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  hHrFim:='';

  CB_Mes1.SetFocus;
  Lb_EmpProcessadas.Caption:='0';

  If Not ConsisteBuscaProdutos Then
   Exit;

  OdirPanApres.Caption:='AGUARDE !! Localizando os Produtos...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.BringToFront();
  OdirPanApres.Visible:=True;
  Refresh;

  // Numero de Meses Total -------------------------------------------------
  igTotMeses:=1; // CB_Mes1 - Sempre Soma
  If CB_Mes2.Text<>'NAO USAR' Then igTotMeses:=igTotMeses+1;
  If CB_Mes3.Text<>'NAO USAR' Then igTotMeses:=igTotMeses+1;
  If CB_Mes4.Text<>'NAO USAR' Then igTotMeses:=igTotMeses+1;
  If CB_Mes5.Text<>'NAO USAR' Then igTotMeses:=igTotMeses+1;
  If CB_Mes6.Text<>'NAO USAR' Then igTotMeses:=igTotMeses+1;
  If CB_Mes7.Text<>'NAO USAR' Then igTotMeses:=igTotMeses+1;
  If CB_Mes8.Text<>'NAO USAR' Then igTotMeses:=igTotMeses+1;

  // Busca os Produtos =========================================================
  sgDtaLimTransf:='';
  If Not BuscaProdutosAnalise Then
  Begin
    IBQ_Matriz.Close;

    OdirPanApres.Visible:=False;
    hHrInicio:='';
    hHrFim:='';
    CB_Mes1.SetFocus;
    Exit;
  End;

  // Calcula Dias Uteis no Ultimo Ano ==========================================
  DecodeDate(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), wgAnoH, wgMesH, wgDiaH);
  sgDtaIniAno:=DateToStr(EncodeDate(wgAnoH-1, wgMesH, 1));
  sgDtaFimAno:=DateToStr(EncodeDate(wgAnoH, wgMesH, wgDiaH));

  igNrDiasAno:=DiasUteisBelShop(StrToDateTime(sgDtaIniAno),StrToDateTime(sgDtaFimAno)-1, False, True);

  // Procesamento Pedido de Compra da Matriz ===================================
  Screen.Cursor:=crAppStart;
  If Not OCProcessaMatriz Then
  Begin
    hHrInicio:='';
    hHrFim:='';
    CB_Mes1.SetFocus;
    Exit;
  End;

  //============================================================================
  // PROCESSA LOJAS ============================================================
  //============================================================================
  DecimalSeparator:='.';
  DateSeparator:='.';

  sgLojasNConectadas:='';
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if (DMBelShop.CDS_EmpProcessaPROC.AsString='SIM') and (DMBelShop.CDS_EmpProcessaTIP_EMP.AsString<>'M') Then
    Begin
      sCodFilial   :=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      igCodLojaLinx:=DMBelShop.CDS_EmpProcessaCOD_LINX.AsInteger;

      MontaProgressBar(True, FrmBelShop);

      // Processamento na Loja ou Ento Local ==================================
      If (Rb_CalculoTpProcLoja.Checked) And (igCodLojaLinx=0) Then
       CalculaFilial
      Else
       CalculaFilialLocal;

      MontaProgressBar(False, FrmBelShop);
    End; // if (DMBelShop.CDS_EmpProcessaPROC.AsString='SIM') and  (DMBelShop.CDS_EmpProcessaTIP_EMP.AsString<>'M') Then

    OdirPanApres.Visible:=False;
    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do
  DMBelShop.CDS_UltCompraTransito.Close;

  DecimalSeparator:=',';
  DateSeparator:='/';

  // Elimina Produtos da Matriz - MPMS-99 Que no  para Processar =============
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Atualiza OC_COMPRAR_DOCS ================================================
    OC_COMPRAR_DOCS('I', sNumDoc, 'BelShop');

    // Busca Sequencia para Atualizar Itens do CD Usados (Curva Selecionada) ===
    MySql:=' SELECT COALESCE(MAX(o.num_seq)+1 ,1) Num_Seq'+
           ' FROM OC_COMPRAR o'+
           ' WHERE o.num_seq<9999999'+
           ' AND o.num_documento='+QuotedStr(sNumDoc)+
           ' AND   EXISTS (SELECT 1'+
           '               FROM OC_COMPRAR_DOCS d'+
           '               WHERE d.num_docto=o.num_documento'+
           '               AND   d.origem<>'+QuotedStr('Linx')+')';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    // Atualiza Numerador para Num_Seq  (Curva Selecionada) ====================
    MySql:=' ALTER SEQUENCE GEN_ODIR RESTART WITH '+DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsString;
    DMBelShop.SQLC.Execute(MySql,nil,nil);
    DMBelShop.CDS_BuscaRapida.Close;

    // Busca Da da Ordem de Compra =============================================
    MySql:=' SELECT first 1 o.dta_documento'+
           ' FROM OC_COMPRAR o'+
           ' WHERE o.num_documento='+QuotedStr(sNumDoc)+
           ' AND   EXISTS (SELECT 1'+
           '               FROM OC_COMPRAR_DOCS d'+
           '               WHERE d.num_docto=o.num_documento'+
           '               AND   d.origem<>'+QuotedStr('Linx')+')';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    sDtaDocto:=DMBelShop.CDS_BuscaRapida.FieldByName('dta_documento').AsString;
    DMBelShop.CDS_BuscaRapida.Close;

    // Verifica Se Existem Outras Lojas Calculadas =============================
    MySql:=' Select oc.num_documento'+
           ' From OC_COMPRAR oc'+
           ' WHERE oc.num_seq=9999999'+
           ' AND   oc.num_documento='+QuotedStr(sNumDoc)+
           ' AND   oc.dta_documento='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)))+
           ' AND   oc.cod_empresa='+QuotedStr('99')+
           ' AND   EXISTS (SELECT 1'+
           '               FROM oc_comprar o'+
           '               WHERE o.num_documento=oc.num_documento'+
           '               AND   o.cod_empresa<>oc.cod_empresa'+
           '               AND   o.dta_documento=oc.dta_documento'+
           '               AND   o.cod_item=oc.cod_item)';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    b:=(DMBelShop.CDS_BuscaRapida.FieldByName('num_documento').AsString)<>'';;
    DMBelShop.CDS_BuscaRapida.Close;

    // Libera Itens do CD Usados (Curva Selecionada) ===========================
    MySql:=' UPDATE oc_comprar oc'+
           ' SET oc.num_seq=GEN_ID(GEN_ODIR,1)'+
           ' WHERE oc.num_seq=9999999'+
           ' AND   oc.num_documento='+QuotedStr(sNumDoc)+
           ' AND   oc.dta_documento='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)))+
           ' AND   oc.cod_empresa='+QuotedStr('99');
    If b Then
    Begin
      MySql:=
       MySql+' AND   EXISTS (SELECT 1'+
             '               FROM oc_comprar o'+
             '               WHERE o.num_documento=oc.num_documento'+
             '               AND   o.cod_empresa<>oc.cod_empresa'+
             '               AND   o.dta_documento=oc.dta_documento'+
             '               AND   o.cod_item=oc.cod_item)';
    End; // If b Then
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Retira Itens do CD No Usados (Curva Selecionada) =======================
    MySql:=' Delete from oc_comprar oc'+
           ' where oc.cod_empresa='+QuotedStr('99')+
           ' And   oc.num_seq=9999999'+
           ' And   oc.num_documento='+QuotedStr(sNumDoc)+
           ' And   oc.dta_documento='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sDtaDocto)));
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      exit;
    End; // on e : Exception do
  End; // Try

  Screen.Cursor:=crDefault;
  //IBT_BelShop.
  // Calcula Sugestes / Transferencias / Estoque Excedente ====================
  OCCalculaSugTransfExc(sNumDoc, sgDtaDoc);

  // Busca Totais das OCs ======================================================
  TotaisOC(sNumDoc);

  // Coloca Saldo Linx em QTD_DISPONIVEL =======================================

  // Encerramento ==============================================================
  hHrFim:=TimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));

  Edt_OCTotProdutos.Value:=0;

  msg('Analise dos Produtos'+cr+'Efetuada com SUCESSO !!'+cr+cr+
      ' TEMPO: '+TimeToStr(StrToTime(hHrFim)-StrToTime(hHrInicio)),'A');

  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

  b:=False;
  DMBelShop.IBDB_BelShop.Connected:=False;
  While Not b do
  Begin
    Try
      DMBelShop.IBDB_BelShop.Connected:=True;
      b:=True;
    Except
    End;
  End; // While Not b do

  Lb_EmpAprocessar.Caption:='0';
  Lb_EmpProcessadas.Caption:='0';

  PC_OrdemCompra.TabIndex:=1;
  PC_OrdemCompraChange(Self);

  EdtGeraOCBuscaDocto.Value:=StrToInt(sNumDoc);
  EdtGeraOCBuscaDoctoExit(Sender);
end;

procedure TFrmBelShop.EdtOCCodAplicacaoExit(Sender: TObject);
Var
  MySql: String;
begin

  If EdtOCCodAplicacao.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Aplicaoes ========================================================
    MySql:='select a.NomeAplicacao, a.CodAplicacao'+
           ' from Aplica a'+
           ' where a.CodAplicacao='+VarToStr(EdtOCCodAplicacao.Value);
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('CodAplicacao').AsString)='' Then
    Begin
      msg('Aplicao NO Encontrada !!!', 'A');
      IBQ_MPMS.Close;
      EdtOCCodAplicacao.Clear;
      EdtOCCodAplicacao.SetFocus;
      Exit;
    End;

    If DMVirtual.CDS_V_Aplicacao.Locate('Cod_Aplicacao',IBQ_MPMS.FieldByName('CodAplicacao').AsString,[]) Then
    Begin
      Begin
        msg('Aplicao J Informada !!','A');
        IBQ_MPMS.Close;
        EdtOCCodAplicacao.Clear;
        EdtOCCodAplicacao.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_Aplicacao.Insert;
    DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString:=
                                  IBQ_MPMS.FieldByName('CodAplicacao').AsString;
    DMVirtual.CDS_V_AplicacaoDes_Aplicacao.AsString:=
                                 IBQ_MPMS.FieldByName('NomeAplicacao').AsString;
    DMVirtual.CDS_V_Aplicacao.Post;

    IBQ_MPMS.Close;
    EdtOCCodAplicacao.Text:='0';
    EdtOCCodAplicacao.SetFocus;
  End;
end;

procedure TFrmBelShop.Dbg_OCAplicacaoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key=VK_Delete Then
   If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then
    DMVirtual.CDS_V_Aplicacao.Delete;

  Dbg_OCAplicacao.SetFocus;
end;

procedure TFrmBelShop.EdtOCCodFamiliaPrecosExit(Sender: TObject);
Var
  MySql: String;
begin

  If EdtOCCodFamiliaPrecos.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Familia Precos ====================================================
    MySql:='select f.NomeFamiliaPreco, f.CodFamiliaPreco'+
           ' from FamiliaP f'+
           ' where f.CodFamiliaPreco='+VarToStr(EdtOCCodFamiliaPrecos.Value);
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('CodFamiliaPreco').AsString)='' Then
    Begin
      msg('Familia Preo NO Encontrada !!!', 'A');
      IBQ_MPMS.Close;
      EdtOCCodFamiliaPrecos.Clear;
      EdtOCCodFamiliaPrecos.SetFocus;
      Exit;
    End;

    If DMVirtual.CDS_V_FamiliaPrecos.Locate('Cod_FamiliaPreco',IBQ_MPMS.FieldByName('CodFamiliaPreco').AsString,[]) Then
    Begin
      Begin
        msg('Familia Preo J Informada !!','A');
        IBQ_MPMS.Close;
        EdtOCCodFamiliaPrecos.Clear;
        EdtOCCodFamiliaPrecos.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_FamiliaPrecos.Insert;
    DMVirtual.CDS_V_FamiliaPrecosCod_FamiliaPreco.AsString:=
                               IBQ_MPMS.FieldByName('CodFamiliaPreco').AsString;
    DMVirtual.CDS_V_FamiliaPrecosDes_FamiliaPreco.AsString:=
                              IBQ_MPMS.FieldByName('NomeFamiliaPreco').AsString;
    DMVirtual.CDS_V_FamiliaPrecos.Post;

    IBQ_MPMS.Close;
    EdtOCCodFamiliaPrecos.Text:='0';
    EdtOCCodFamiliaPrecos.SetFocus;
  End;
end;

procedure TFrmBelShop.Dbg_OCFamiliaPrecosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key=VK_Delete Then
   If Not DMVirtual.CDS_V_FamiliaPrecos.IsEmpty Then
    DMVirtual.CDS_V_FamiliaPrecos.Delete;

  Dbg_OCFamiliaPrecos.SetFocus;
end;

procedure TFrmBelShop.EdtFiltroCodGrupoSTExit(Sender: TObject);
begin

  If EdtFiltroCodGrupoST.Value<>0 Then
  Begin
    If Not DMVirtual.CDS_GruposST.Locate('Cod_GrupoST', EdtFiltroCodGrupoST.Text,[]) Then
    Begin
     msg('Grupo ST NO Encontrado !!!', 'A');
     EdtFiltroCodGrupoST.Clear;
     EdtFiltroCodGrupoST.SetFocus;
     Exit;
    End;

    If DMVirtual.CDS_V_GrupoST.Locate('Cod_GrupoST',DMVirtual.CDS_GruposSTCod_GrupoST.AsString,[]) Then
    Begin
      Begin
        msg('Grupo ST J Informado !!','A');
        EdtFiltroCodGrupoST.Clear;
        EdtFiltroCodGrupoST.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_GrupoST.Insert;
    DMVirtual.CDS_V_GrupoSTCod_GrupoST.AsString:=
                                     DMVirtual.CDS_GruposSTCod_GrupoST.AsString;
    DMVirtual.CDS_V_GrupoSTDes_GrupoST.AsString:=
                                     DMVirtual.CDS_GruposSTDes_GrupoST.AsString;
    DMVirtual.CDS_V_GrupoST.Post;

    EdtFiltroCodGrupoST.Text:='0';
    EdtFiltroCodGrupoST.SetFocus;
  End;

end;

procedure TFrmBelShop.Dbg_FiltroGrupoSTKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if Key=VK_Delete Then
   If Not DMVirtual.CDS_V_GrupoST.IsEmpty Then
    DMVirtual.CDS_V_GrupoST.Delete;

  Dbg_FiltroGrupoST.SetFocus;
end;

procedure TFrmBelShop.EdtFiltroCodProdutoExit(Sender: TObject);
Var
  MySql: String;
begin

  If EdtFiltroCodProduto.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Produtos ==========================================================
    MySql:='select p.Apresentacao Des_Produto, p.CodProduto, p.PrincipalFor'+
           ' from produto p'+
           ' Where p.CodProduto='+QuotedStr(FormatFloat('000000',EdtFiltroCodProduto.AsInteger));

           If Painel_FiltroNaoCompra.Visible Then
           Begin
             If Not Ckb_FiltroProdNaoCompra.Checked Then
              MySql:=MySql+' AND Coalesce(p.situacaopro,0)=0'
             Else
              MySql:=MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';
           End; // If Painel_FiltroNaoCompra.Visible Then

           Try
             Cbx_EstFisFinanSituacaoProd.SetFocus;
             If Cbx_EstFisFinanSituacaoProd.ItemIndex=0      Then MySql:=MySql+' AND Coalesce(p.situacaopro,0)=0'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then MySql:=MySql+' AND Coalesce(p.situacaopro,3)=3'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then MySql:=MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';
           Except
           End; // Try

           Try
             Cbx_ConsultaNfeSituacaoProd.SetFocus;
             If Cbx_ConsultaNfeSituacaoProd.ItemIndex=0      Then MySql:=MySql+' AND Coalesce(p.situacaopro,0)=0'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then MySql:=MySql+' AND Coalesce(p.situacaopro,3)=3'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then MySql:=MySql+' AND Coalesce(p.situacaopro,0) in (0,3)';
           Except
           End;

           If Trim(sgFornecedores)<>'' Then
            MySql:=MySql+' And p.principalfor in ('+sgFornecedores+')';
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('CodProduto').AsString)='' Then
    Begin
      msg('Produto NO Encontrado !!!', 'A');
      IBQ_MPMS.Close;
      EdtFiltroCodProduto.Clear;
      EdtFiltroCodProduto.SetFocus;
      Exit;
    End;

    If DMVirtual.CDS_V_Produtos.Locate('Cod_Produto',IBQ_MPMS.FieldByName('CodProduto').AsString,[]) Then
    Begin
      msg('Produto J Informado !!','A');
      IBQ_MPMS.Close;
      EdtFiltroCodProduto.Clear;
      EdtFiltroCodProduto.SetFocus;
      Exit;
    End;

    DMVirtual.CDS_V_Produtos.Insert;
    DMVirtual.CDS_V_ProdutosCod_Produto.AsString:=
                                    IBQ_MPMS.FieldByName('CodProduto').AsString;
    DMVirtual.CDS_V_ProdutosDes_Produto.AsString:=
                                   IBQ_MPMS.FieldByName('Des_Produto').AsString;
    DMVirtual.CDS_V_ProdutosCod_Fornecedor.AsString:=
                                  IBQ_MPMS.FieldByName('PrincipalFor').AsString;
    DMVirtual.CDS_V_Produtos.Post;

    IBQ_MPMS.Close;
    EdtFiltroCodProduto.Text:='0';
    EdtFiltroCodProduto.SetFocus;
  End;
end;

procedure TFrmBelShop.Dbg_FiltroProdutoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If Key=VK_Delete Then
  Begin
    If Not DMVirtual.CDS_V_Produtos.IsEmpty Then
     DMVirtual.CDS_V_Produtos.Delete;
  End; // If Key=VK_Delete Then

  Dbg_FiltroProduto.SetFocus;
end;

procedure TFrmBelShop.EdtOCCodListaPrecoExit(Sender: TObject);
Var
  MySql: String;
begin
  
  EdtOCListaPreco.Clear;
  If EdtOCCodListaPreco.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Fornecedores =======================================================
    MySql:='select lp.nomelista, lp.codlista'+
           ' from lista lp'+
           ' where lp.desativada=''N'''+
           ' and lp.CodLista='+QuotedStr(FormatFloat('0000',EdtOCCodListaPreco.AsInteger));
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('codlista').AsString)='' Then
    Begin
      msg('Lista de Preo NO Encontrada !!!', 'A');
      IBQ_MPMS.Close;
      EdtOCCodListaPreco.Clear;
      EdtOCCodListaPreco.SetFocus;
      Exit;
    End;

    EdtOCListaPreco.Text:=IBQ_MPMS.FieldByName('NomeLista').AsString;
    IBQ_MPMS.Close;
  End;
end;

procedure TFrmBelShop.PC_GeraOCProdutoChange(Sender: TObject);
begin
  If PC_GeraOCProduto.ActivePage=Ts_GeraOCProdutos Then
   Dbg_GeraOCProdutos.SetFocus;

end;

procedure TFrmBelShop.EdtGeraOCBuscaDoctoExit(Sender: TObject);
Var
  b: Boolean;
  MySql: String;
  i: Integer;
begin
  If (EdtGeraOCBuscaDocto.Value=0) Or (PC_OrdemCompra.ActivePage<>Ts_OCGeraOrdemCompra) Then
   Exit;

  If PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid Then
   Dbg_GeraOCGrid.SetFocus;

  If PC_GeraOCApresentacao.ActivePage=Ts_GeraOCOrdensCompra Then
   Dbg_GeraOCTotalGeral.SetFocus;

  DecimalSeparator:=',';

  Screen.Cursor:=crAppStart;

  Bt_GeraOCCalcular.Visible:=False;

  b:=False;
  DMBelShop.IBDB_BelShop.Connected:=False;
  While Not b do
  Begin
    Try
      DMBelShop.IBDB_BelShop.Connected:=True;
      b:=True;
    Except
    End;
  End; // While Not b do
  DMBelShop.IBQ_AComprar.Close;
  DMBelShop.CDS_AComprarOCs.Close;

  OdirPanApres.Caption:='AGUARDE !! Localizando Documento...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Busca Itens do Documento --------------------------------------------------
  MySql:=' SELECT DISTINCT oc.cod_item, oc.des_item, oc.num_documento,'+
         '                 cast(oc.dta_documento as Date) dta_documento,'+
         '                 oc.cod_comprador, us.des_usuario'+

         ' FROM OC_COMPRAR oc'+
         '       LEFT JOIN PS_USUARIOS us     ON us.cod_usuario = oc.cod_comprador'+
         '       LEFT JOIN OC_COMPRAR_DOCS od ON od.num_docto = oc.num_documento'+
         ' WHERE od.origem<>'+QuotedStr('Linx')+
         ' AND   oc.num_documento='+VarToStr(EdtGeraOCBuscaDocto.Value)+
         ' ORDER BY oc.des_item';
  DMBelShop.CDS_AComprarItens.Close;
  DMBelShop.SDS_AComprarItens.CommandText:=MySql;
  DMBelShop.CDS_AComprarItens.Open;

  OdirPanApres.Visible:=False;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
  Begin
    msg('Documento Nmero: '+VarToStr(EdtGeraOCBuscaDocto.Value)+cr+cr+'No Encontrado !!','A');

    EdtGeraOCBuscaDocto.Clear;
    EdtGeraOCBuscaDocto.SetFocus;
    Screen.Cursor:=crDefault;
    Exit;
  End; // If DMBelShop.CDS_AComprarItens.IsEmpty Then

  // Inicailiza Data ===========================================================
  DtEdt_GeraOCDataDocto.Date:=DMBelShop.CDS_AComprarItensDTA_DOCUMENTO.AsDateTime;

  // Botao de Calculo ==========================================================
  Bt_GeraOCCalcular.Visible:=True;

  // Busca Dados dos Itens do Documento ========================================
  i:=0;
  b:=False;
  While Not b do
  Begin
    Inc(i);
    DMBelShop.IBQ_AComprar.Close;
    DMBelShop.IBQ_AComprar.Open;
    If DMBelShop.IBQ_AComprar.IsEmpty Then
     Begin
       DMBelShop.CDS_AComprarItens.Close;
       EdtGeraOCBuscaDoctoExit(Self);
       Break;
     End
    Else
     Begin
       Break;;
     End;

     If i=3 Then
     Begin
       DMBelShop.CDS_AComprarItens.Close;
       EdtGeraOCBuscaDocto.AsInteger:=0;
       EdtGeraOCBuscaDocto.SetFocus;
       Exit;
     End;
  End; // While Not b do

  // Acerta Nome dos Meses de Demandas no Grid =================================
  NomeMesesGrid;

  // Busca Totais das OCs ======================================================
  TotaisOC(IntToStr(EdtGeraOCBuscaDocto.AsInteger));

  // Posiciona na Empresa ======================================================
  If Trim(sgCodEmp)<>'' Then
  Begin
    DMBelShop.IBQ_AComprar.Locate('Cod_Empresa',sgCodEmp,[]);
    DMBelShop.CDS_AComprarOCs.Locate('COD_EMP_FIL',sgCodEmp,[]);
  End;

  // Verifica se  Solicitao de Lojas Unicas =================================
  MySqlSelect:=' SELECT FIRST 1 ol.num_seq'+
               ' FROM oc_comprar_lojas ol'+
               ' WHERE ol.ind_oc_gerada='+QuotedStr('S')+
               ' AND   ol.num_oc_gerada='+VarToStr(EdtGeraOCBuscaDocto.Value);
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySqlSelect;
  DMBelShop.CDS_BuscaRapida.Open;

  If Not DMBelShop.CDS_BuscaRapida.IsEmpty Then
   Pan_GeraOCLojaUnica.Caption:='Solicitao de Lojas';
  DMBelShop.CDS_BuscaRapida.Close;

  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.PC_GeraOCFiliaisChange(Sender: TObject);
begin
  If PC_GeraOCFiliais.ActivePage=Ts_GeraOCFiliais Then
   Dbg_GeraOCFiliais.SetFocus;

end;

procedure TFrmBelShop.PC_GeraOCApresentacaoChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_GeraOCApresentacao);

  If (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) And (Ts_GeraOCGrid.CanFocus) Then
  Begin
    PC_GeraOCFiliais.Visible:=True;
    PC_GeraOCProduto.Visible:=True;

    If Not DMBelShop.IBQ_AComprar.IsEmpty Then
    Begin
      Dbg_GeraOCGrid.SelectedIndex:=0;
      Dbg_GeraOCGrid.SelectedIndex:=3;
      Dbg_GeraOCGrid.SetFocus;
    End;

    Sb_GeraOC.Panels[1].Visible:=True;
    Sb_GeraOC.Panels[2].Visible:=True;
  End;

  If (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCOrdensCompra) And (Ts_GeraOCOrdensCompra.CanFocus) Then
  Begin
    PC_GeraOCProduto.Visible:=False;
    PC_GeraOCFiliais.Visible:=False;
    Dbg_GeraOCTotalGeral.SetFocus;

    Sb_GeraOC.Panels[1].Visible:=False;
    Sb_GeraOC.Panels[2].Visible:=False;
  End;

end;

procedure TFrmBelShop.Dbg_GeraOCProdutosKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  MySql, s: String;
begin
  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  If key=Vk_Return Then
   Ts_GeraOCFiliais.SetFocus;

  // Localiza Produto SIDICOM ==================================================
  If (Key=VK_F4) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
  Begin
    s:='';
    If InputQuery('Localizar Produto SIDICOM','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          DMBelShop.CDS_AComprarItens.Locate('Cod_Item',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMBelShop.CDS_AComprarItens.Locate('Des_Item',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) then
  End; // If Key=VK_F4 Then

  // Localiza Produto LINX =====================================================
  If (Key=VK_F3) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
  Begin
    s:='';
    If InputQuery('Localizar Produto LINX','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          s:=DMBelShop.LINX_BuscaCodigoSIDICOM(s);
          DMBelShop.CDS_AComprarItens.Locate('Cod_Item',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMBelShop.CDS_AComprarItens.Locate('Des_Item',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) then
  End; // If Key=VK_F4 Then

  // Apresenta Datas de Inclusao/Alteracao do Produto ==========================
  If (key=Vk_F5) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
  Begin
    MySql:=' SELECT Trim(p.Apresentacao) Apresentacao, p.datainclusao, p.dataalteracao'+
           ' FROM produto p'+
           ' WHERE p.codproduto='+QuotedStr(DMBelShop.CDS_AComprarItensCOD_ITEM.AsString);
    IBQ_ConsultaMatriz.Close;
    IBQ_ConsultaMatriz.SQL.Clear;
    IBQ_ConsultaMatriz.SQL.Add(MySql);
    IBQ_ConsultaMatriz.Open;

    MessageBox(Handle, pChar('Produto:'+cr+IBQ_ConsultaMatriz.FieldByName('Apresentacao').AsString+cr+cr+
                             'Data de Incluso : '+IBQ_ConsultaMatriz.FieldByName('datainclusao').AsString+cr+
                             'Data de Alterao: '+IBQ_ConsultaMatriz.FieldByName('dataalteracao').AsString), 'PRODUTO', MB_ICONINFORMATION);
    IBQ_ConsultaMatriz.Close;
  End; // If (key=Vk_F5) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then

end;

procedure TFrmBelShop.Dbg_GeraOCFiliaisKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  MySql, s: String;
begin
  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  If key=Vk_Return Then
   Ts_GeraOCGrid.SetFocus;

  // Localiza Produto SISICOM ==================================================
  If (Key=VK_F4) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
  Begin
    s:='';
    If InputQuery('Localizar Produto SIDICOM','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          DMBelShop.CDS_AComprarItens.Locate('Cod_Item',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMBelShop.CDS_AComprarItens.Locate('Des_Item',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) then
  End; // If Key=VK_F4 Then

  // Localiza Produto LINX =====================================================
  If (Key=VK_F3) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
  Begin
    s:='';
    If InputQuery('Localizar Produto LINX','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          s:=DMBelShop.LINX_BuscaCodigoSIDICOM(s);
          DMBelShop.CDS_AComprarItens.Locate('Cod_Item',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMBelShop.CDS_AComprarItens.Locate('Des_Item',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) then
  End; // If Key=VK_F4 Then

  // Apresenta Datas de Inclusao/Alteracao do Produto ==========================
  If (key=Vk_F5) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
  Begin
    MySql:=' SELECT Trim(p.Apresentacao) Apresentacao, p.datainclusao, p.dataalteracao'+
           ' FROM produto p'+
           ' WHERE p.codproduto='+QuotedStr(DMBelShop.CDS_AComprarItensCOD_ITEM.AsString);
    IBQ_ConsultaMatriz.Close;
    IBQ_ConsultaMatriz.SQL.Clear;
    IBQ_ConsultaMatriz.SQL.Add(MySql);
    IBQ_ConsultaMatriz.Open;

    MessageBox(Handle, pChar('Produto:'+cr+IBQ_ConsultaMatriz.FieldByName('Apresentacao').AsString+cr+cr+
                             'Data de Incluso : '+IBQ_ConsultaMatriz.FieldByName('datainclusao').AsString+cr+
                             'Data de Alterao: '+IBQ_ConsultaMatriz.FieldByName('dataalteracao').AsString), 'PRODUTO', MB_ICONINFORMATION);
    IBQ_ConsultaMatriz.Close;
  End; // If (key=Vk_F5) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
end;

procedure TFrmBelShop.Dbg_GeraOCGridKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  MySql, s: String;
begin
  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  // Altera Seta Para Baixo para Enter/Return ==================================
  If (key=Vk_Down) Then
   key:=Vk_Return;

  // Executa Enter/Return ======================================================
  If (key=Vk_Return) Then
  Begin
    If DMBelShop.IBQ_AComprar.RecordCount=1 Then
     Begin
       If DMBelShop.CDS_AComprarItens.RecNo=DMBelShop.CDS_AComprarItens.RecordCount Then
        DMBelShop.CDS_AComprarItens.First
       Else
        DMBelShop.CDS_AComprarItens.Next;
     End
    Else
     Begin
       DMBelShop.IBQ_AComprar.Next;
     End; // If DMBelShop.IBQ_AComprar.RecordCount=1 Then

    If Dbg_GeraOCGrid.SelectedIndex<>9 Then
    Begin
      Dbg_GeraOCGrid.SelectedIndex:=0;
      Dbg_GeraOCGrid.SelectedIndex:=3;
    End;

    Dbg_GeraOCGrid.SetFocus;
    bgEnterTab:=False;
    Exit;
  End; // If (key=Vk_Return) Then

  // Executa Seta Para Cima ====================================================
  If (key=VK_UP) and (DMBelShop.IBQ_AComprar.RecordCount=1) Then
  Begin
    If DMBelShop.CDS_AComprarItens.RecNo<>1 Then
     DMBelShop.CDS_AComprarItens.Prior;
  End; // If (key=Key_Down) and (DMBelShop.IBQ_AComprar.RecordCount=1) Then

  // Localiza Produto SIDICOM ==================================================
  If (Key=VK_F4) And ((PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) And (Ts_GeraOCGrid.CanFocus)) Then
  Begin
    s:='';
    If InputQuery('Localizar Produto SIDICOM','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          DMBelShop.CDS_AComprarItens.Locate('Cod_Item',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMBelShop.CDS_AComprarItens.Locate('Des_Item',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) then
  End; // If Key=VK_F4 Then

  // Localiza Produto LINX =====================================================
  If (Key=VK_F3) And ((PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) And (Ts_GeraOCGrid.CanFocus)) Then
  Begin
    s:='';
    If InputQuery('Localizar Produto LINX','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          s:=DMBelShop.LINX_BuscaCodigoSIDICOM(s);
          DMBelShop.CDS_AComprarItens.Locate('Cod_Item',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMBelShop.CDS_AComprarItens.Locate('Des_Item',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) then
  End; // If Key=VK_F4 Then

  // Apresenta Datas de Inclusao/Alteracao do Produto ==========================
  If (key=Vk_F5) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
  Begin
    MySql:=' SELECT Trim(p.Apresentacao) Apresentacao, p.datainclusao, p.dataalteracao'+
           ' FROM produto p'+
           ' WHERE p.codproduto='+QuotedStr(DMBelShop.CDS_AComprarItensCOD_ITEM.AsString);
    IBQ_ConsultaMatriz.Close;
    IBQ_ConsultaMatriz.SQL.Clear;
    IBQ_ConsultaMatriz.SQL.Add(MySql);
    IBQ_ConsultaMatriz.Open;

    MessageBox(Handle, pChar('Produto:'+cr+IBQ_ConsultaMatriz.FieldByName('Apresentacao').AsString+cr+cr+
                             'Data de Incluso : '+IBQ_ConsultaMatriz.FieldByName('datainclusao').AsString+cr+
                             'Data de Alterao: '+IBQ_ConsultaMatriz.FieldByName('dataalteracao').AsString), 'PRODUTO', MB_ICONINFORMATION);
    IBQ_ConsultaMatriz.Close;
  End; // If (key=Vk_F5) And (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid) Then
end;

procedure TFrmBelShop.Dbg_GeraOCGridDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If (Column.FieldName='QTD_SALDO') Or (Column.FieldName='IND_QTD_ACIMA') Then
  Begin
    If DMBelShop.IBQ_AComprarIND_QTD_ACIMA.AsCurrency>0 Then
     Dbg_GeraOCGrid.Canvas.Font.Color:=clRed;
  End; // If (Column.FieldName='QTD_SALDO') Or (Column.FieldName='IND_QTD_ACIMA')Then

  If (Column.FieldName='QTD_ACOMPRAR') Then
  Begin
     Dbg_GeraOCGrid.Canvas.Font.Style:=[fsBold];

    If DMBelShop.IBQ_AComprarQTD_ACOMPRAR.AsCurrency=0 Then
     Dbg_GeraOCGrid.Canvas.Font.Style:=[]
    Else If (DMBelShop.IBQ_AComprarQTD_ACOMPRAR.AsCurrency<>0) and (DMBelShop.IBQ_AComprarQTD_TRANSF.AsCurrency<>0) Then
     Begin
       Dbg_GeraOCGrid.Canvas.Font.Color:=clRed;
     End;
  End; // If (Column.FieldName='QTD_ACOMPRAR') Then

  If (Column.FieldName='QTD_TRANSF') Then
  Begin
    If DMBelShop.IBQ_AComprarQTD_TRANSF.AsCurrency=0 Then
     Dbg_GeraOCGrid.Canvas.Font.Style:=[]
    Else
     Dbg_GeraOCGrid.Canvas.Font.Style:=[fsBold];
  End; // If (Column.FieldName='QTD_TRANSF') Then

  If (Column.FieldName='VLR_UNI_COMPRA') Then
  Begin
    If DMBelShop.IBQ_AComprarVLR_UNI_COMPRA.AsCurrency=0 Then
     Begin
       Dbg_GeraOCGrid.Canvas.Font.Style:=[];

       If DMBelShop.IBQ_AComprarIND_OC_GERADA.AsString='N' Then
       Begin
         Dbg_GeraOCGrid.Canvas.Font.Color:=clWhite;
         Dbg_GeraOCGrid.Canvas.Brush.Color:=clRed;
       End; // If DMBelShop.IBQ_AComprarIND_OC_GERADA.AsString='N' Then
     End
    Else
     Begin
       Dbg_GeraOCGrid.Canvas.Font.Style:=[fsBold];
     End; // If DMBelShop.IBQ_AComprarVLR_UNI_COMPRA.AsCurrency=0 Then
  End; // If (Column.FieldName='VLR_UNI_COMPRA') Then

  if not (gdSelected in State) Then
  Begin
    if DMBelShop.IBQ_AComprarCOD_EMPRESA.AsString='99' Then
      Dbg_GeraOCGrid.Canvas.Brush.Color:=$0080FFFF; //$00DDFFDD;

    If DMBelShop.IBQ_AComprarIND_USAR.AsString='NAO'  Then
     Dbg_GeraOCGrid.Canvas.Brush.Color:=$00C6FFC6;

    if DMBelShop.IBQ_AComprarIND_OC_GERADA.AsString='S' Then
      Dbg_GeraOCGrid.Canvas.Brush.Color:=clSkyBlue;
  End; // if not (gdSelected in State) Then

  // Sem Saldo - Produtos No Encontrado no Linx ----------------------
  If (Column.FieldName='QTD_TRANSF_ANO') Then
  Begin
    If Trim(DMBelShop.IBQ_AComprarQTD_TRANSF_ANO.AsString)='' Then
     Dbg_GeraOCGrid.Canvas.Brush.Color:=clRed;
  End; // If (Column.FieldName='QTD_TRANSF_ANO') Then

  Dbg_GeraOCGrid.Canvas.FillRect(Rect);
  Dbg_GeraOCGrid.DefaultDrawDataCell(Rect,Column.Field,state);

  // Alinhamento
  DMBelShop.IBQ_AComprarUNI_COMPRA.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarCLA_CURVA_ABC.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarDTA_ULT_COMPRA.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarIND_SOMA_IPI_BASE_ICMS.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarIND_SOMA_FRETE_BASE_ICMS.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarIND_SOMA_DESPESA_BASE_ICMS.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarIND_SOMA_IPI_BASE_ST.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarIND_SOMA_FRETE_BASE_ST.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarIND_SOMA_DESPESA_BASE_ST.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarIND_SOMA_FRETE_BASE_ICMS.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarCOD_IPI.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarCOD_ICMS.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarCOD_GRUPO_ST.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarTIP_PESSOA.Alignment:=taCenter;
  DMBelShop.IBQ_AComprarDTA_OC_GERADA.Alignment:=taCenter;

end;

procedure TFrmBelShop.Bt_GeraOCCalcularClick(Sender: TObject);
Var
  cQtdACompra: Currency;
  MySql: String;
begin

  If DMBelShop.IBQ_AComprar.IsEmpty Then
   Exit;

  DtEdt_GeraOCDataDocto.SetFocus;
  If EdtGeraOCDias.Value<1 Then
  Begin
    msg('Nmero de Dias Para Clculo Invlido !!', 'A');
    EdtGeraOCDias.SetFocus;
    Exit;
  End;

  If msg('Deseja Realmente Calcular'+cr+cr+'Necessidade de COMPRA ??','C')=2 Then
   Exit;

  PC_GeraOCApresentacao.TabIndex:=1;
  PC_GeraOCApresentacaoChange(Self);

  If msg('Produtos Sem Preo Unitrio'+cr+'Ficaro COM SUGESTO de COMPRA e'+cr+
         'SEM QUANTIDADE a COMPRAR !!'+cr+cr+'Deseja Realmente Continuar ??','C')=2 Then
   Exit;

  Screen.Cursor:=crAppStart;

  // Busca Produtos ===========================================================
  DMBelShop.CDS_Sugestao.Close;
  DMBelShop.SDS_Sugestao.Params.ParamByName('NumDocto').AsInteger:=EdtGeraOCBuscaDocto.AsInteger;
  DMBelShop.SDS_Sugestao.Params.ParamByName('Dta').AsDate:=DtEdt_GeraOCDataDocto.Date;
  DMBelShop.CDS_Sugestao.Open;

  // Inicia Processamento =====================================================
  MontaProgressBar(True, FrmBelShop);
  pgProgBar.Properties.Max:=DMBelShop.CDS_Sugestao.RecordCount;
  pgProgBar.Position:=0;

  While Not DMBelShop.CDS_Sugestao.Eof do
  Begin
    Application.ProcessMessages;

    pgProgBar.Position:=DMBelShop.CDS_Sugestao.RecNo;
    Refresh;

    If (DMBelShop.CDS_SugestaoIND_OC_GERADA.AsString<>'S') and (DMBelShop.CDS_SugestaoQTD_TRANSF.AsCurrency=0) Then
    Begin
      // Calcula Acomprar ------------------------------------------
      cQtdACompra:=RoundTo(DMBelShop.CDS_Sugestao.FieldByName('QTD_MEDIA_DIA').AsCurrency*EdtGeraOCDias.Value,0);

      // Verifica Se Utiliza Saldo ---------------------------------
      If Ckb_GeraOCCalculoEstoque.Checked Then
       cQtdACompra:=cQtdACompra-DMBelShop.CDS_Sugestao.FieldByName('QTD_SALDO').AsCurrency;

      // Verifica Se Utiliza Transito ------------------------------
      If Ckb_GeraOCCalculoTransito.Checked Then
       cQtdACompra:=cQtdACompra-DMBelShop.CDS_Sugestao.FieldByName('QTD_TRANSITO').AsCurrency;

      If cQtdACompra<0 Then
       cQtdACompra:=0;

      // Atulaiza Necessidade de Compra ----------------------------
      DMBelShop.CDS_Sugestao.Edit;
      DMBelShop.CDS_Sugestao.FieldByName('QTD_ACOMPRAR').AsCurrency:=cQtdACompra;

      If DMBelShop.CDS_Sugestao.FieldByName('VLR_UNI_COMPRA').AsCurrency>0 Then
       DMBelShop.CDS_Sugestao.FieldByName('QTD_SUGERIDA').AsCurrency:=cQtdACompra
      Else
       DMBelShop.CDS_Sugestao.FieldByName('QTD_SUGERIDA').AsCurrency:=0;

      // Calcula Totais do Produto ------------------------------
      If (DMBelShop.CDS_Sugestao.FieldByName('QTD_ACOMPRAR').AsCurrency<>0) and
         (DMBelShop.CDS_Sugestao.FieldByName('VLR_UNI_COMPRA').AsCurrency<>0) Then
      Begin
        // Valor Bruto --------------------------------
        DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency:=
                 (DMBelShop.CDS_Sugestao.FieldByName('QTD_ACOMPRAR').AsCurrency*
               DMBelShop.CDS_Sugestao.FieldByName('VLR_UNI_COMPRA').AsCurrency);

        // Valor Base ICMS ----------------------------
        DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ICMS').AsCurrency:=
                     DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency;

        // Valor ICMS ---------------------------------
        If DMBelShop.CDS_Sugestao.FieldByName('PER_ICMS').AsCurrency<>0 Then
         DMBelShop.CDS_Sugestao.FieldByName('VLR_ICMS').AsCurrency:=Roundto(
                (DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ICMS').AsCurrency*
             DMBelShop.CDS_Sugestao.FieldByName('PER_ICMS').AsCurrency)/100,-2);

        // Valor IPI ----------------------------------
        If DMBelShop.CDS_Sugestao.FieldByName('PER_IPI').AsCurrency<>0 Then
         DMBelShop.CDS_Sugestao.FieldByName('VLR_IPI').AsCurrency:=Roundto(
                    (DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency*
              DMBelShop.CDS_Sugestao.FieldByName('PER_IPI').AsCurrency)/100,-2);

        // Valores ST ---------------------------------
        If DMBelShop.CDS_Sugestao.FieldByName('PER_ST').AsCurrency<>0 Then
        Begin
          // Valor Base ST ----------------------------
          If DMBelShop.CDS_Sugestao.FieldByName('PER_MARGEM_ST').AsCurrency=0 Then
           DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ST').AsCurrency:=
                      DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency
          Else
           DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ST').AsCurrency:=
                     DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency+
                     (Roundto(((DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency*
                     DMBelShop.CDS_Sugestao.FieldByName('PER_MARGEM_ST').AsCurrency)/100),-2));

          // Valor ST ---------------------------------
          DMBelShop.CDS_Sugestao.FieldByName('VLR_ST').AsCurrency:=(Roundto(
                 ((DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ST').AsCurrency*
              DMBelShop.CDS_Sugestao.FieldByName('PER_ST').AsCurrency)/100),-2)-
                     DMBelShop.CDS_Sugestao.FieldByName('VLR_ICMS').AsCurrency);

        End; // If DMBelShop.CDS_Sugestao.FieldByName('PER_ST').AsCurrency<>0 Then

        // Valor Total do Item
        DMBelShop.CDS_Sugestao.FieldByName('VLR_TOT_COMPRA').AsCurrency:=
                     DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency+
                        DMBelShop.CDS_Sugestao.FieldByName('VLR_ST').AsCurrency+
                       DMBelShop.CDS_Sugestao.FieldByName('VLR_IPI').AsCurrency;

       End
      Else //        If (DMBelShop.CDS_Sugestao.FieldByName('QTD_ACOMPRAR').AsCurrency<>0) and (DMBelShop.CDS_Sugestao.FieldByName('VLR_UNI_COMPRA').AsCurrency<>0) Then
       Begin
         // Zera todo
         // Valor Bruto --------------------------------
         DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsCurrency:=0;

         // Valor Base ICMS ----------------------------
         DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ICMS').AsCurrency:=0;

         // Valor ICMS ---------------------------------
         DMBelShop.CDS_Sugestao.FieldByName('VLR_ICMS').AsCurrency:=0;

         // Valor IPI ----------------------------------
         DMBelShop.CDS_Sugestao.FieldByName('VLR_IPI').AsCurrency:=0;

         // Valor Base ST ----------------------------
         DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ST').AsCurrency:=0;

         // Valor ST ---------------------------------
         DMBelShop.CDS_Sugestao.FieldByName('VLR_ST').AsCurrency:=0;

         // Valor Total do Item
         DMBelShop.CDS_Sugestao.FieldByName('VLR_TOT_COMPRA').AsCurrency:=0;
       End; // If (DMBelShop.CDS_Sugestao.FieldByName('QTD_ACOMPRAR').AsCurrency<>0) and


      DecimalSeparator:='.';
      MySql:='UpDate OC_COMPRAR oc'+
             ' Set oc.Qtd_AComprar='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('QTD_ACOMPRAR').AsString)+', '+
             ' oc.Qtd_Sugerida='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('QTD_SUGERIDA').AsString)+', '+
             ' oc.Vlr_Uni_Compra='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_UNI_COMPRA').AsString)+', '+
             ' oc.Vlr_Bruto='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_BRUTO').AsString)+', '+
             ' oc.Vlr_Base_ICMS='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ICMS').AsString)+', '+
             ' oc.Vlr_ICMS='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_ICMS').AsString)+', '+
             ' oc.Vlr_IPI='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_IPI').AsString)+', '+
             ' oc.Vlr_Base_ST='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_BASE_ST').AsString)+', '+
             ' oc.Vlr_ST='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_ST').AsString)+', '+
             ' oc.Vlr_Tot_Compra='+QuotedStr(DMBelShop.CDS_Sugestao.FieldByName('VLR_TOT_COMPRA').AsString)+

             ' Where oc.Num_Documento='+DMBelShop.CDS_SugestaoNUM_DOCUMENTO.AsString+
             ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DMBelShop.CDS_SugestaoDTA_DOCUMENTO.AsDateTime))))+
             ' And   oc.Num_Seq='+DMBelShop.CDS_Sugestao.FieldByName('NUM_SEQ').AsString;
      DMBelShop.SQLC.Execute(MySql,nil,nil);
      DecimalSeparator:=',';

      // Busca Totais das OCs ======================================================
      TotaisOC(DMBelShop.CDS_Sugestao.FieldByName('NUM_DOCUMENTO').AsString);
    End; // If DMBelShop.CDS_SugestaoIND_OC_GERADA.AsString<>'S' Then

    // Vai para o Proximo Produto ---------------------------------------------
    Screen.Cursor:=crAppStart;

    DMBelShop.CDS_Sugestao.Next
  End; // While Not DMBelShop.CDS_Sugestao.Eof do
  MontaProgressBar(False, FrmBelShop);

  bgSiga:=True;
  EdtGeraOCBuscaDoctoExit(Self);
  bgSiga:=False;

  // Encerra Processamento ====================================================
  Screen.Cursor:=crDefault;
  msg('Processmento Efetuado com Sucesso !!','A');
  EdtGeraOCDias.Value:=0;

  DMBelShop.IBT_BelShop.Commit;

  DMBelShop.IBQ_AComprar.Close;
  DMBelShop.IBQ_AComprar.Open;

  Gb_GeraOCCalculaCompra.Visible:=False;
  Gb_GeraOCEstoqueTransito.Visible:=False;

  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);

  Dbg_GeraOCGrid.SelectedIndex:=0;
  Dbg_GeraOCGrid.SelectedIndex:=3;
  Dbg_GeraOCGrid.SetFocus;

  Bt_GeraOCGeraOCClick(Self);

end;

procedure TFrmBelShop.EdtGeraOCBuscaDoctoChange(Sender: TObject);
begin
  bEnterTab:=True;

  DMBelShop.IBQ_AComprar.Close;
  DMBelShop.CDS_AComprarItens.Close;
  DMBelShop.CDS_AComprarOCs.Close;

  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);

  Pan_GeraOCLojaUnica.Caption:='';

  Bt_GeraOCCalcular.Visible:=False;

end;

procedure TFrmBelShop.Bt_GeraOCGeraOCClick(Sender: TObject);
Var
  sOrdem, sItensOC, sNrOC: String;
  MySql: String;
  i: Integer;
  bSiga, b: Boolean;
  iNrOCNaoGeradas: Integer;
  sDtaGeracao: String;
begin

  If not (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCOrdensCompra) Then
   Exit;

  Dbg_GeraOCTotalGeral.SetFocus;
  Memo2.Lines.Clear;

  If DMBelShop.CDS_AComprarOCs.IsEmpty Then
   Exit;

  // Verifica se Existe OC para Gerar ==========================================
  i:=0;
  DMBelShop.CDS_AComprarOCs.First;
  While Not DMBelShop.CDS_AComprarOCs.Eof do
  Begin
    If (DMBelShop.CDS_AComprarOCsGERAR.AsString='S') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='OC') Then
    Begin
      i:=1;
      Break;
    End;

    DMBelShop.CDS_AComprarOCs.Next;
  End;
  DMBelShop.CDS_AComprarOCs.First;

  If i=0 Then
  Begin
    msg('Favor Selecionar a Empresa/Filial a Gerar OCs !!','A');
    Dbg_GeraOCTotalGeral.SetFocus;
    Exit;
  End;

  If msg('Deseja Realmente'+cr+cr+'Gerar Ordem de Compra ??','C')=2 Then
   Exit;

  If msg('Deseja Informar OBSERVAES'+cr+cr+'Na(s) Ordem(ns) de Compra ??','C')=1 Then
  Begin
    // Observao nas Ordens de Compra ===========================================
    While Not DMBelShop.CDS_AComprarOCs.Eof do
    Begin
      Refresh;

      If (DMBelShop.CDS_AComprarOCsGERAR.AsString='S') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='OC') Then
      Begin
        bgProcessar:=False;

        MySql:='Select First 1 oc.OBS_OC'+
               ' From OC_COMPRAR oc'+
               ' Where oc.qtd_acomprar>0'+
               ' And   oc.qtd_transf=0'+
               ' And   oc.ind_oc_gerada=''N'''+
               ' And   oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
               ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
               ' And   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
               ' And   oc.cod_fornecedor='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString);
        DMBelShop.CDS_Busca.Close;
        DMBelShop.SDS_Busca.CommandText:=MySql;
        DMBelShop.CDS_Busca.Open;

        // Apresenta Observao ---------------------------------------
        FrmOCObservacao:=TFrmOCObservacao.Create(Self);
        FrmOCObservacao.Mem_OCObsObservacao.Lines.Add(Trim(DMBelShop.CDS_Busca.FieldByName('OBS_OC').AsString));
        DMBelShop.CDS_Busca.Close;

        FrmOCObservacao.ShowModal;

        // Atualiza Observao ----------------------------------------
        If bgProcessar Then
         Begin

           Try
             If DMBelShop.IBT_BelShop.Active Then
             Begin
               DMBelShop.IBT_BelShop.Rollback;
             End;
             DMBelShop.IBT_BelShop.StartTransaction;

             MySql:=' Update OC_COMPRAR oc'+
                    ' Set oc.OBS_OC='+QuotedStr(FrmOCObservacao.Mem_OCObsObservacao.Text)+
                    ' Where oc.qtd_acomprar>0'+
                    ' And   oc.qtd_transf=0'+
                    ' And   oc.ind_oc_gerada=''N'''+
                    ' And   oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
                    ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
                    ' And   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
                    ' And   oc.cod_fornecedor='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString);
             DMBelShop.IBQ_Executa.Close;
             DMBelShop.IBQ_Executa.SQL.Clear;
             DMBelShop.IBQ_Executa.SQL.Add(MySql);
             DMBelShop.IBQ_Executa.ExecSQL;

             DMBelShop.IBT_BelShop.CommitRetaining;
           except
             on e : Exception do
             Begin
               DMBelShop.IBT_BelShop.Rollback;

               Screen.Cursor:=crDefault;
               MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);

               FreeAndNil(FrmOCObservacao);
               exit;
             End;
           End; // Try
         End // If bgProcessar Then
        Else
         Begin
           FreeAndNil(FrmOCObservacao);
           Exit;
         End; // If bgProcessar Then
        FreeAndNil(FrmOCObservacao);

        bgProcessar:=False;
      End; // If (DMBelShop.CDS_AComprarOCsGERAR.AsString='S') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='OC') Then

      DMBelShop.CDS_AComprarOCs.Next;
    End; // While Not DMBelShop.CDS_AComprarOCs.Eof do
  End; // If msg('Deseja Informar OBSERVAES'+cr+cr+'Na(s) Ordem(ns) de Compra ??','C')=1 Then

  // Cria Insert para OC =======================================================
  sOrdem:='Insert into ORDEM ('+
          ' CODOC, CODFORNECEDOR, CODFILIAL, SITUACAO, DATAPEDIDO, DATAENTREGA,'+
          ' FLAG, TOTALOC, OBSERVACAO, TOTALITENS, TOTBRUTO, TOTDESCONTO,'+
          ' TOTIPI, TOTDESPESAS, TOTSUBSTITUICAO, TOTFRETE, TOTICM, ISENTOIPI,'+
          ' ISENTOICM, ISENTOSUBST, CODOCPENDENTE, GRUPOPENDENTESN,'+
          ' CODCOMPRADOR, CODTRANSPORTADORA, TIPOFRETE, TOTREPASSE,'+
          ' CODCOMPROVANTEOC)'+

          ' Values ('+
          ' :CODOC, :CODFORNECEDOR, :CODFILIAL, :SITUACAO, :DATAPEDIDO, :DATAENTREGA,'+
          ' :FLAG, :TOTALOC, :OBSERVACAO, :TOTALITENS, :TOTBRUTO, :TOTDESCONTO,'+
          ' :TOTIPI, :TOTDESPESAS, :TOTSUBSTITUICAO, :TOTFRETE, :TOTICM, :ISENTOIPI,'+
          ' :ISENTOICM, :ISENTOSUBST, :CODOCPENDENTE, :GRUPOPENDENTESN,'+
          ' :CODCOMPRADOR, :CODTRANSPORTADORA, :TIPOFRETE, :TOTREPASSE,'+
          ' :CODCOMPROVANTEOC)';

  sItensOC:='Insert into ORDEMITE ('+
            ' CODOC, CODPRODUTO, QUANTIDADE, PRECO, ALIQIPI, IPIPERCOUVALOR,'+
            ' ALIQICM, ALIQICMREDUCAO, SUBSTVALPER, SUBSTMARGEM, SUBSTALIQ,'+
            ' DESCONTO1, DESCONTO2, DESCONTO3, DESCONTO4, DESCONTOCALC,'+
            ' VALBRUTO, VALDESCONTO, VALDESPESAS, VALFRETE, VALIPI,'+
            ' VALSUBSTITUICAO, VALBASEICM, VALBASESUBST, VALICM, TOTALITEM,'+
            ' ALIQREPASSE, VALREPASSE, VALPECAS)'+

            ' Values ('+
            ' :CODOC, :CODPRODUTO, :QUANTIDADE, :PRECO, :ALIQIPI, :IPIPERCOUVALOR,'+
            ' :ALIQICM, :ALIQICMREDUCAO, :SUBSTVALPER, :SUBSTMARGEM, :SUBSTALIQ,'+
            ' :DESCONTO1, :DESCONTO2, :DESCONTO3, :DESCONTO4, :DESCONTOCALC,'+
            ' :VALBRUTO, :VALDESCONTO, :VALDESPESAS, :VALFRETE, :VALIPI,'+
            ' :VALSUBSTITUICAO, :VALBASEICM, :VALBASESUBST, :VALICM, :TOTALITEM,'+
            ' :ALIQREPASSE, :VALREPASSE, :VALPECAS)';

  // Monta Busca Pedido para Gerar Ordem de Compra =============================
  MySql:=' Select *'+
         ' From OC_COMPRAR oc'+
         ' Where oc.qtd_acomprar>0'+
         ' And   oc.qtd_transf=0'+
         ' And   oc.ind_oc_gerada=''N'''+
         ' And   oc.num_documento=:NumDocto'+
         ' And   Cast(oc.dta_documento as Date)=:Dta'+
         ' And   oc.cod_empresa=:CodFilial'+
         ' And   oc.cod_fornecedor=:CodFornecedor'+
         ' Order By oc.cod_item';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;

  // Cria OC's =================================================================
  iNrOCNaoGeradas:=0;
  DMBelShop.CDS_AComprarOCs.First;
  While Not DMBelShop.CDS_AComprarOCs.Eof do
  Begin
    Application.ProcessMessages;
    Refresh;

    sCodFilial:=DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString;

    If (DMBelShop.CDS_AComprarOCsGERAR.AsString='S') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='OC') Then
    Begin

      OdirPanApres.Caption:='AGUARDE !! Processando Filial: '+
                            DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString+' - '+
                            DMBelShop.CDS_AComprarOCsDES_EMP_FIL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Busca Codigo Linx =====================================================
      MySql:=' SELECT em.cod_linx'+
             ' FROM EMP_CONEXOES em'+
             ' where em.cod_filial='+QuotedStr(sCodFilial);
      DMBelShop.CDS_BuscaRapida.Close;
      DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
      DMBelShop.CDS_BuscaRapida.Open;
      Try
        igCodLojaLinx:=DMBelShop.CDS_BuscaRapida.fieldByName('Cod_Linx').AsInteger;
      Except
        igCodLojaLinx:=0;
      End;
      DMBelShop.CDS_BuscaRapida.Close;

      // Dta da Gerao -----------------------------------
      sDtaGeracao:=DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));

      bSiga:=True;

      // Efetua Conecxo SIDICOM =============================================
      If igCodLojaLinx=0 Then // SIDICOM
      Begin
        // Busca Dados de Conexo para Banco de Dados SIDICOM ====================
        DMVirtual.CDS_V_EmpConexoes.Locate('COD_FILIAL', DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString,[]);

        If ConexaoEmpIndividual(DMVirtual.CDS_V_EmpConexoesDATABASE.AsString, DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString, 'A') Then
         Begin
           bSiga:=True;
         End
        Else
         Begin
           bSiga:=False;
           iNrOCNaoGeradas:=iNrOCNaoGeradas+1;
           Memo2.Lines.Add(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString);
         End; // If ConexaoEmpIndividual(DMVirtual.CDS_V_EmpConexoesDATABASE.AsString, DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString, 'A') Then
      End; // If igCodLojaLinx=0 Then // SIDICOM

      If bSiga Then
      Begin
        // Insere OC e Itens - SIDICOM =======================================
        If igCodLojaLinx=0 Then // SIDICOM
        Begin
          Try
            CriaQueryIB(DMVirtual.CDS_V_EmpConexoesDATABASE.AsString,
                        DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString,
                        IBQ_ConsultaFilial, True, True);
          Except
          End;
        End; // If igCodLojaLinx=0 Then // SIDICOM

        // Busca OC para Transferir para Empresa/Filial ======================
        // Transfere Somente em Caso de Banco SIDICOM
        DMBelShop.CDS_Busca.Close;
        DMBelShop.SDS_Busca.Params.ParamByName('NumDocto').Value     :=DMBelShop.CDS_AComprarOCsNUM_DOCUMENTO.AsString;
        DMBelShop.SDS_Busca.Params.ParamByName('Dta').AsDate         :=DtEdt_GeraOCDataDocto.Date;
        DMBelShop.SDS_Busca.Params.ParamByName('CodFilial').Value    :=DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString;
        DMBelShop.SDS_Busca.Params.ParamByName('CodFornecedor').Value:=DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString;
        DMBelShop.CDS_Busca.Open;

        MontaProgressBar(True, FrmBelShop);
        pgProgBar.Properties.Max:=DMBelShop.CDS_Busca.RecordCount;
        pgProgBar.Position:=0;

        // Monta StoredProcInicializa Busca Numero da OC ---------------------
        If igCodLojaLinx=0 Then // SIDICOM
        Begin
          b:=False;
          While Not b do
          Begin
            b:=IBTransacao('S', DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString);
          End; // While Not b do

          b:=False;
          i:=0;
          While Not b do
          Begin
            Try
              StoredProcInicializa(IBSP_Geral,
                                   DMVirtual.CDS_V_EmpConexoesDATABASE.AsString,
                                   DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString);
              b:=True;
              i:=0;
            Except
              i:=i+1
            End;

            If i=10 Then
            Begin
              iNrOCNaoGeradas:=iNrOCNaoGeradas+1;
              Memo2.Lines.Add(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString);
              bSiga:=False;
              Break;
            End;
          End; // While Not b do
        End; // If igCodLojaLinx=0 Then // SIDICOM

        If bSiga Then
        Begin
          // Busca Numero da OC - SIDICOM ====================================
          If igCodLojaLinx=0 Then // SIDICOM
          Begin
            b:=False;
            i:=0;
            While Not b do
            Begin
              Try
                IBSP_Geral.StoredProcName:='BUSCA_NUMERADOR_AUTOMATICO';
                IBSP_Geral.Prepare;
                IBSP_Geral.ParamByName('PAR_CODNUMERADOR').Value:='04';
                IBSP_Geral.ParamByName('PAR_ADICIONA_SN').Value:='S';
                IBSP_Geral.ExecProc;
                sNrOC:=IBSP_Geral.ParamByName('RET_NUMERO').AsString;
                IBSP_Geral.Prepared:=False;
                b:=True;
                i:=0;
              Except
                i:=i+1
              End;

              If i=10 Then
              Begin
                iNrOCNaoGeradas:=iNrOCNaoGeradas+1;
                Memo2.Lines.Add(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString);
                bSiga:=False;
                Break;
              End;
            End; // While Not b do
          End; // If igCodLojaLinx=0 Then // SIDICOM

          // Busca Numero da OC ==============================================
          If igCodLojaLinx<>0 Then // LINX
          Begin
            MySql:=' SELECT COALESCE(MAX(oc.num_oc_gerada)+1 ,1) Num_Docto'+
                   ' FROM OC_COMPRAR oc'+
                   ' WHERE oc.cod_empresa='+QuotedStr(sCodFilial)+
                   ' AND   oc.num_oc_gerada< 1000000'+
                   ' AND   EXISTS (SELECT 1'+
                   '               FROM OC_COMPRAR_DOCS d'+
                   '               WHERE d.num_docto=oc.num_documento'+
                   '               AND   d.origem<>'+QuotedStr('Linx')+')';
            DMBelShop.CDS_BuscaRapida.Close;
            DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
            DMBelShop.CDS_BuscaRapida.Open;
            sNrOC:=DMBelShop.CDS_BuscaRapida.fieldByName('Num_Docto').AsString;
            DMBelShop.CDS_BuscaRapida.Close;
          End; // If igCodLojaLinx<>0 Then // LINX

          If bSiga Then
          Begin
            If igCodLojaLinx=0 Then // SIDICOM
            Begin
              // Commita Transao =============================================
              b:=False;
              While Not b do
              Begin
                b:=IBTransacao('C', DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString);
              End; // While Not b do
            End; // If igCodLojaLinx=0 Then // SIDICOM

            // Processa Empres/Filial ========================================
            Screen.Cursor:=crAppStart;
            Try
              If igCodLojaLinx=0 Then // SIDICOM
              Begin
                // Abre Transacao ----------------------------------------------
                b:=False;
                While Not b do
                Begin
                  b:=IBTransacao('S', DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString);
                End; // While Not b do
              End; // If igCodLojaLinx=0 Then // SIDICOM

              If DMBelShop.IBT_BelShop.Active Then
              Begin
                DMBelShop.IBT_BelShop.Rollback;
              End;
              DMBelShop.IBT_BelShop.StartTransaction;

              // Cria OC -----------------------------------------------------
              DecimalSeparator:='.';
              While Not DMBelShop.CDS_Busca.Eof do
              Begin
                Application.ProcessMessages;

                pgProgBar.Position:=DMBelShop.CDS_Busca.RecNo;
                Refresh;

                If igCodLojaLinx=0 Then // SIDICOM
                Begin
                  // Insere OC -------------------------------------------
                  If DMBelShop.CDS_Busca.RecNo=1 Then
                  Begin
                    IBQ_ConsultaFilial.Close;
                    IBQ_ConsultaFilial.SQL.Clear;
                    IBQ_ConsultaFilial.SQL.Add(sOrdem);

                    IBQ_ConsultaFilial.Params.ParamByName('CODOC').Value:=
                                          FormatFloat('000000',StrToInt(sNrOC));
                    IBQ_ConsultaFilial.Params.ParamByName('CODFORNECEDOR').Value:=
                     DMBelShop.CDS_Busca.FieldByName('COD_FORNECEDOR').AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('CODFILIAL').Value:=
                                  DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('SITUACAO').Value:='1';
                    IBQ_ConsultaFilial.Params.ParamByName('DATAPEDIDO').Value:=
                                                    DateToStr(DataHoraServidorFI(
                                                DMBelShop.SDS_DtaHoraServidor));
                    IBQ_ConsultaFilial.Params.ParamByName('DATAENTREGA').Value:=
                                                    DateToStr(DataHoraServidorFI(
                                                DMBelShop.SDS_DtaHoraServidor));
                    IBQ_ConsultaFilial.Params.ParamByName('FLAG').Value:=EmptyStr;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTALOC').Value:=
                                     DMBelShop.CDS_AComprarOCsTOTAL_OC.AsString;

                    IBQ_ConsultaFilial.Params.ParamByName('OBSERVACAO').Value:=
                          DMBelShop.CDS_Busca.FieldByName('OBS_OC').AsString+cr+
                                                    'OC Gerada em '+sDtaGeracao+
                                                  ' Pelo Usurio: '+Des_Usuario;

                    IBQ_ConsultaFilial.Params.ParamByName('TOTALITENS').Value:=
                                                DMBelShop.CDS_Busca.RecordCount;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTBRUTO').Value:=
                                  DMBelShop.CDS_AComprarOCsTOTAL_BRUTO.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTDESCONTO').Value:=
                              DMBelShop.CDS_AComprarOCsTOTAL_DESCONTOS.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTIPI').Value:=
                                    DMBelShop.CDS_AComprarOCsTOTAL_IPI.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTDESPESAS').Value:=
                               DMBelShop.CDS_AComprarOCsTOTAL_DESPESAS.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTSUBSTITUICAO').Value:=
                                     DMBelShop.CDS_AComprarOCsTOTAL_ST.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTFRETE').Value:=
                                   DMBelShop.CDS_AComprarOCsTOTAL_FRETE.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('TOTICM').Value:=
                                    DMBelShop.CDS_AComprarOCsTOTAL_ICMS.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('ISENTOIPI').Value:='N';
                    IBQ_ConsultaFilial.Params.ParamByName('ISENTOICM').Value:='N';
                    IBQ_ConsultaFilial.Params.ParamByName('ISENTOSUBST').Value:='N';
                    IBQ_ConsultaFilial.Params.ParamByName('CODOCPENDENTE').Value:=
                                                                       EmptyStr;
                    IBQ_ConsultaFilial.Params.ParamByName('GRUPOPENDENTESN').Value:='N';
                    IBQ_ConsultaFilial.Params.ParamByName('CODCOMPRADOR').Value:=
                                                                    Cod_Usuario;
                    IBQ_ConsultaFilial.Params.ParamByName('CODTRANSPORTADORA').Value:=
                                                                       EmptyStr;
                    IBQ_ConsultaFilial.Params.ParamByName('TIPOFRETE').Value:='1';
                    IBQ_ConsultaFilial.Params.ParamByName('TOTREPASSE').Value:=
                                DMBelShop.CDS_AComprarOCsTOTAL_REPASSE.AsString;
                    IBQ_ConsultaFilial.Params.ParamByName('CODCOMPROVANTEOC').Value:=
                         DMBelShop.CDS_AComprarOCsCOD_COMPROVANTE_ICMS.AsString;

                    IBQ_ConsultaFilial.ExecSQL;

                  End; // If DMBelShop.CDS_Busca.RecNo=1 Then

                  // Monta Insere Itens da OC ---------------------------
                  IBQ_ConsultaFilial.Close;
                  IBQ_ConsultaFilial.SQL.Clear;
                  IBQ_ConsultaFilial.SQL.Add(sItensOC);

                  // Insere Itens da OC -----------------------------------
                  IBQ_ConsultaFilial.Params.ParamByName('CODOC').Value:=
                                          FormatFloat('000000',StrToInt(sNrOC));
                  IBQ_ConsultaFilial.Params.ParamByName('CODPRODUTO').Value:=
                           DMBelShop.CDS_Busca.FieldByName('COD_ITEM').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('QUANTIDADE').Value:=
                       DMBelShop.CDS_Busca.FieldByName('QTD_ACOMPRAR').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('PRECO').Value:=
                     DMBelShop.CDS_Busca.FieldByName('Vlr_UNI_COMPRA').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('ALIQIPI').Value:=
                            DMBelShop.CDS_Busca.FieldByName('PER_IPI').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('IPIPERCOUVALOR').Value:=
                            DMBelShop.CDS_Busca.FieldByName('IND_IPI').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('ALIQICM').Value:=
                           DMBelShop.CDS_Busca.FieldByName('PER_ICMS').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('ALIQICMREDUCAO').Value:=
                   DMBelShop.CDS_Busca.FieldByName('PER_REDUCAO_ICMS').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('SUBSTVALPER').Value:=
                             DMBelShop.CDS_Busca.FieldByName('IND_ST').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('SUBSTMARGEM').Value:=
                      DMBelShop.CDS_Busca.FieldByName('PER_MARGEM_ST').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('SUBSTALIQ').Value:=
                             DMBelShop.CDS_Busca.FieldByName('PER_ST').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('DESCONTO1').Value:='0';
                  IBQ_ConsultaFilial.Params.ParamByName('DESCONTO2').Value:='0';
                  IBQ_ConsultaFilial.Params.ParamByName('DESCONTO3').Value:='0';
                  IBQ_ConsultaFilial.Params.ParamByName('DESCONTO4').Value:='0';
                  IBQ_ConsultaFilial.Params.ParamByName('DESCONTOCALC').Value:=
                       DMBelShop.CDS_Busca.FieldByName('PER_DESCONTO').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALBRUTO').Value:=
                          DMBelShop.CDS_Busca.FieldByName('VLR_BRUTO').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALDESCONTO').Value:=
                      DMBelShop.CDS_Busca.FieldByName('VLR_DESCONTOS').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALDESPESAS').Value:=
                       DMBelShop.CDS_Busca.FieldByName('VLR_DESPESAS').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALFRETE').Value:=
                          DMBelShop.CDS_Busca.FieldByName('VLR_FRETE').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALIPI').Value:=
                            DMBelShop.CDS_Busca.FieldByName('VLR_IPI').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALSUBSTITUICAO').Value:=
                             DMBelShop.CDS_Busca.FieldByName('VLR_ST').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALBASEICM').Value:=
                      DMBelShop.CDS_Busca.FieldByName('VLR_BASE_ICMS').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALBASESUBST').Value:=
                        DMBelShop.CDS_Busca.FieldByName('VLR_BASE_ST').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALICM').Value:=
                           DMBelShop.CDS_Busca.FieldByName('VLR_ICMS').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('TOTALITEM').Value:=
                     DMBelShop.CDS_Busca.FieldByName('VLR_TOT_COMPRA').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('ALIQREPASSE').Value:=
                        DMBelShop.CDS_Busca.FieldByName('PER_REPASSE').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALREPASSE').Value:=
                        DMBelShop.CDS_Busca.FieldByName('VLR_REPASSE').AsString;
                  IBQ_ConsultaFilial.Params.ParamByName('VALPECAS').Value:='0';
                  IBQ_ConsultaFilial.ExecSQL;

                  // Atualiza Quantidades Pendentes -----------------------
                  MySql:=' Update ESTOQUE'+
                         ' Set comprapendente=comprapendente+'+
                         DMBelShop.CDS_Busca.FieldByName('QTD_ACOMPRAR').AsString+
                         ' Where codproduto='+QuotedStr(
                         DMBelShop.CDS_Busca.FieldByName('Cod_Item').AsString)+
                         ' And codfilial='+QuotedStr(
                         DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString);
                  IBQ_ConsultaFilial.Close;
                  IBQ_ConsultaFilial.SQL.Clear;
                  IBQ_ConsultaFilial.SQL.Add(MySql);
                  IBQ_ConsultaFilial.ExecSQL;
                End; // If igCodLojaLinx=0 Then // SIDICOM

                // Atualiza OC_COMPRAR ----------------------------------
                MySql:=' Update OC_COMPRAR oc'+
                       ' Set oc.IND_OC_GERADA=''S'''+
                       ', oc.DTA_OC_GERADA='+QuotedStr(f_Troca('/','.',sDtaGeracao))+
                       ', oc.NUM_OC_GERADA='+sNrOC+

                       ', oc.OBS_OC=oc.OBS_OC||ascii_char(13)||'+QuotedStr('OC Gerada em '+sDtaGeracao+
                                                                 ' Pelo Usurio: '+Des_Usuario)+

                       ', oc.BLOB_TEXTO=oc.BLOB_TEXTO||ascii_char(13)||'+QuotedStr('Aberturta do Aplicativo: '+sgDataHoraAplicativo)+
                                     '|| ascii_char(13) ||'+QuotedStr('OC N '+sNrOC+' Gerada em: '+
                                     DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+' por '+Des_Usuario)+
                       ' Where oc.Num_Seq='+DMBelShop.CDS_Busca.FieldByName('Num_Seq').AsString+
                       ' And   oc.Num_Documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
                       ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))));
                DMBelShop.IBQ_Executa.Close;
                DMBelShop.IBQ_Executa.SQL.Clear;
                DMBelShop.IBQ_Executa.SQL.Add(MySql);
                DMBelShop.IBQ_Executa.ExecSQL;

                DMBelShop.IBT_BelShop.CommitRetaining;

                // Proximo Registro -------------------------------------
                DMBelShop.CDS_Busca.Next;
              End; // While Not DMBelShop.CDS_Busca.Eof do
              DecimalSeparator:=',';
              MontaProgressBar(False, FrmBelShop);

              If igCodLojaLinx=0 Then // SIDICOM
              Begin
                // Commit ------------------------------------------------------
                b:=False;
                While Not b do
                Begin
                  b:=IBTransacao('C', DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString);
                End; // While Not b do
              End; // If igCodLojaLinx=0 Then // SIDICOM

              DMBelShop.IBT_BelShop.Commit;

            Except // Try
              on e : Exception do
              Begin
                Screen.Cursor:=crDefault;

                MontaProgressBar(False, FrmBelShop);

                OdirPanApres.Visible:=False;
                DecimalSeparator:=',';

                // Guarda Empresas No Geradas ----------------------
                iNrOCNaoGeradas:=iNrOCNaoGeradas+1;
                Memo2.Lines.Add(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString);

                If igCodLojaLinx=0 Then // SIDICOM
                Begin
                  // Rollback Transacao --------------------------------------------
                  b:=False;
                  While Not b do
                  Begin
                    b:=IBTransacao('R', DMVirtual.CDS_V_EmpConexoesTRANSACAO.AsString);
                  End; // While Not b do
                End; // If igCodLojaLinx=0 Then // SIDICOM

                MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);

                If DMBelShop.IBT_BelShop.Active Then
                Begin
                  DMBelShop.IBT_BelShop.Rollback;
                End;
              End;
            End; // Try
          End; // If bSiga Then
        End; // If bSiga Then
        MontaProgressBar(False, FrmBelShop);
      End; // If bSiga Then

      OdirPanApres.Visible:=False;
    End; // If (DMBelShop.CDS_AComprarOCsGERAR.AsString='S') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='OC') Then

    // Proxima Empresa =========================================================
    DMBelShop.CDS_AComprarOCs.Next;
  End; // While Not DMBelShop.CDS_AComprarOCs.Eof do

  If iNrOCNaoGeradas<> 0 Then
   msg('Hoveram '+IntToStr(iNrOCNaoGeradas)+' Ordens de Compra No Geradas !!'+cr+cr+'Tende Novamente !!','A')
  Else
   msg('Gerao de Ordens de Compra'+cr+cr+'Efetuada com SUCESSO !!','A');

  // Busca Ordem de Compra =====================================================
  EdtGeraOCBuscaDoctoExit(Self);

  TotaisOC(IntToStr(EdtGeraOCBuscaDocto.AsInteger));

  // Marca Empresas No Geradas ================================================
  DMBelShop.CDS_AComprarOCs.DisableControls;
  For i:=0 to Memo2.Lines.Count-1 do
  Begin
    If DMBelShop.CDS_AComprarOCs.Locate('COD_EMP_FIL', Trim(Memo2.Lines[i]),[]) Then
    Begin
      DMBelShop.CDS_AComprarOCs.Edit;
      DMBelShop.CDS_AComprarOCsGERAR.AsString:='S';
      DMBelShop.CDS_AComprarOCs.Post;
    End;
  End; // For i:=0 to Memo2.Lines.Count-1 do
  DMBelShop.CDS_AComprarOCs.EnableControls;
  DMBelShop.CDS_AComprarOCs.First;

  If Trim(sNrOC)<>'' Then
   DMBelShop.CDS_AComprarOCs.Locate('NUM_OC_GERADA', sNrOC,[]);

  Screen.Cursor:=crDefault;
end;

procedure TFrmBelShop.Bt_GeraOCImpEditOCClick(Sender: TObject);
Var
  MySql, dir_relat: String;
  sTotal_Valor, sTotal_Itens, sTotal_Qtd: String;
  s: String;
begin
  Dbg_GeraOCTotalGeral.SetFocus;

  If DMBelShop.CDS_AComprarOCs.IsEmpty Then
   Exit;

  // Edit OC ===================================================================
  If (Bt_GeraOCImpEditOC.Caption='Editar OC') Or (Bt_GeraOCImpEditOC.Caption='Editar TR') Then
  Begin
    Screen.Cursor:=crAppStart;

    sgCodEmp:=DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString;

    Ts_OCBuscaProdutos.TabVisible:=False;
    Ts_OCGeraOrdemCompra.TabVisible:=False;
    Ts_OCGeraEditaOrdemCompra.TabVisible:=True;

    // Busca Pedido -------------------------------------------------
    MySql:=' SELECT *'+
           ' FROM  OC_COMPRAR OC'+
           ' WHERE oc.ind_oc_gerada='+QuotedStr('N')+
           ' AND   oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
           ' AND   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
           ' AND   oc.cod_empresa='+QuotedStr(sgCodEmp)+
           ' AND   oc.cod_fornecedor='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString);

           If (Bt_GeraOCImpEditOC.Caption='Editar OC') Then
           Begin
             MySql:=
              MySql+' AND   oc.qtd_transf=0';

             Rb_GeraOCEditaComQtd.Visible:=True;
             Rb_GeraOCEditaSemQtd.Visible:=True;
             Rb_GeraOCEditaTodosItens.Visible:=True;
             dxStatusBar1.Visible:=True;

             Dbg_GeraOCEditaGrid.Columns[2].ReadOnly:=False;
           End;

           If (Bt_GeraOCImpEditOC.Caption='Editar TR') Then
           Begin
             MySql:=
              MySql+' AND   oc.qtd_transf>0';

             Rb_GeraOCEditaComQtd.Visible:=False;
             Rb_GeraOCEditaSemQtd.Visible:=False;
             Rb_GeraOCEditaTodosItens.Visible:=False;
             dxStatusBar1.Visible:=False;

             Dbg_GeraOCEditaGrid.Columns[2].ReadOnly:=True;
           End;

    MySql:=
     MySql+' ORDER BY oc.cla_curva_abc, oc.Des_Item';
    DMBelShop.IBQ_AComprarEdita.Close;
    DMBelShop.IBQ_AComprarEdita.SQL.Clear;
    DMBelShop.IBQ_AComprarEdita.SQL.Add(MySql);
    DMBelShop.IBQ_AComprarEdita.Open;

    If DMBelShop.IBQ_AComprarEdita.IsEmpty Then
    Begin
      msg('Documento Nmero: '+VarToStr(EdtGeraOCBuscaDocto.Value)+cr+cr+'Sem Produto a Listar !!','A');

      DMBelShop.IBQ_AComprarEdita.Close;
      sgCodEmp:='';

      EdtGeraOCEditaDocto.Clear;
      DtEdt_GeraOCEditaDataDocto.Clear;

      Ts_OCBuscaProdutos.TabVisible:=True;
      Ts_OCGeraOrdemCompra.TabVisible:=True;
      Ts_OCGeraEditaOrdemCompra.TabVisible:=False;

      PC_OrdemCompra.TabIndex:=1;
      PC_OrdemCompraChange(Sender);
      EdtGeraOCBuscaDoctoExit(Self);

      Screen.Cursor:=crDefault;
      Exit;
    End; // If DMBelShop.CDS_AComprarItens.IsEmpty Then

    EdtGeraOCEditaDocto.Value:=EdtGeraOCBuscaDocto.Value;
    DtEdt_GeraOCEditaDataDocto.Date:=DtEdt_GeraOCDataDocto.Date;

    // Fecha Consultas Anteriores -----------------------------------
    DMBelShop.CDS_AComprarItens.Close;
    DMBelShop.IBQ_AComprar.Close;

    // Busca Totais do Pedido ---------------------------------------
    If Rb_GeraOCEditaComQtd.Checked Then s:='C';
    If Rb_GeraOCEditaSemQtd.Checked Then s:='S';
    If Rb_GeraOCEditaTodosItens.Checked Then s:='T';

    TotaisPedOC(sTotal_Valor, sTotal_Itens, sTotal_Qtd,
                DMBelShop.IBQ_AComprarEditaNUM_DOCUMENTO.AsString,
                DMBelShop.IBQ_AComprarEditaCOD_EMPRESA.AsString, s, '', DMBelShop.IBQ_AComprarEditaCOD_FORNECEDOR.AsString);

    EdtGeraOCEditaTotalGeral.Value  :=StrToCurr(sTotal_Valor);
    EdtGeraOCEditaTotalItens.Value  :=StrToCurr(sTotal_Itens);
    EdtGeraOCEditaTotallQtd.Value   :=StrToCurr(sTotal_Qtd);

    Rb_GeraOCEditaTodosItens.Checked:=True;

    Screen.Cursor:=crDefault;
  End; // If Bt_GeraOCImpEditOC.Caption='Editar OC' Then

  // Imprime OC ================================================================
  If Bt_GeraOCImpEditOC.Caption='Imprimir OC' Then
  Begin
    If DMBelShop.CDS_AComprarOCsIND_OC_GERADA.AsString='N' Then
    Begin
      If msg('Ordem de Compra Ainda No Gerada !!'+cr+cr+'Deseja Continuar ??','C')=2 Then
       Exit;
    End;

    Screen.Cursor:=crAppStart;

    OdirPanApres.Caption:='AGUARDE !! Montando Relatrio...';
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
    OdirPanApres.Visible:=True;
    Refresh;

    // Busca OC -----------------------------------------------------
    MySql:=' SELECT oc.des_empresa, oc.num_oc_gerada,'+
           ' Case co.compl_endereco'+
           '   when '''' Then'+
           '      co.des_endereco ||'', ''|| co.num_endereco'+
           '   Else'+
           '      co.des_endereco ||'', ''|| co.num_endereco ||'' - ''|| co.compl_endereco'+
           ' End Endereco,'+
           ' co.des_bairro, co.des_cidade, co.cod_uf,'+

           ' cast((substring(co.cod_cep from 1 for 5) ||''-''|| substring(co.cod_cep from 6 for 3)) as varchar(9)) cod_cep,'+

           ' CAST(('+
           ' substring(co.num_cnpj from 1 for 2) ||''.''||'+
           ' substring(co.num_cnpj from 3 for 3) ||''.''||'+
           ' substring(co.num_cnpj from 6 for 3) ||''/''||'+
           ' substring(co.num_cnpj from 9 for 4) ||''-''||'+
           ' substring(co.num_cnpj from 13 for 2'+
           ' )) AS VARCHAR(18)) num_cnpj,'+

           ' co.inscr_estadual,'+
           ' case oc.ind_oc_gerada'+
           '   When ''N'' Then'+
           '      ''ABERTA'''+
           '   Else'+
           '      ''ABERTA - PENDENTE FORNECEDOR'''+
           ' End Situacao,'+
           ' Cast(oc.dta_oc_gerada as Date) Dta_Pedido,'+
           ' Cast(oc.dta_oc_gerada as Date) Dta_Entrega,'+
           ' oc.cod_fornecedor, oc.des_fornecedor,'+
           ' oc.cod_item, oc.cod_barras, oc.cod_referencia_forn,'+
           ' oc.des_item, oc.uni_compra, oc.uni_venda,'+
           ' oc.qtd_acomprar, oc.vlr_uni_compra, oc.per_desconto,'+
           ' oc.vlr_tot_compra, oc.obs_oc, oc.cod_comprador, us.des_usuario,'+
           ' ''000.000.000.0000'' Enderecamento'+

           ' FROM OC_COMPRAR oc'+
           '    LEFT JOIN EMP_CONEXOES co ON oc.cod_empresa=co.cod_filial'+
           '    LEFT JOIN PS_USUARIOS  us ON oc.cod_comprador=us.cod_usuario'+

           ' WHERE oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
           ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
           ' and   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
           ' and   oc.num_oc_gerada='+ QuotedStr(DMBelShop.CDS_AComprarOCsNUM_OC_GERADA.AsString)+

           ' order by oc.des_item';
    DMBelShop.IBQ_OrdemCompra.Close;
    DMBelShop.IBQ_OrdemCompra.SQL.Clear;
    DMBelShop.IBQ_OrdemCompra.SQL.Add(MySql);
    DMBelShop.IBQ_OrdemCompra.Open;

    // Dados da Filial ----------------------------------------------
    MySql:=' select cl.telefone, cl.contato, cl.email'+
           ' from clientefone cl, filial fi'+
           ' where cl.codcliente = fi.codnocliente'+
           ' and fi.codfilial='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
           ' order by cl.email desc';
    IBQ_Matriz.Close;
    IBQ_Matriz.SQL.Clear;
    IBQ_Matriz.SQL.Add(MySql);
    IBQ_Matriz.Open;

    sEmpTelefone  :=Trim(IBQ_Matriz.FieldByName('Telefone').AsString);
    sEmpCcontato  :=Trim(IBQ_Matriz.FieldByName('Contato').AsString);
    sEmpEmail     :=Trim(IBQ_Matriz.FieldByName('Email').AsString);

    // Dados do Fornecedor ------------------------------------------
    MySql:=' select fo.endereco, fo.cidade, fo.estado,'+
           ' (substring(fo.codigopostal from 1 for 5) ||''-''||'+
           '  substring(fo.codigopostal from 6 for 3)) cod_cep,'+
           ' fo.fone1, fo.fonefax, fo.email, fo.contato'+
           ' from forneced fo'+
           ' where fo.codfornecedor='+
           QuotedStr(DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString);
    IBQ_Matriz.Close;
    IBQ_Matriz.SQL.Clear;
    IBQ_Matriz.SQL.Add(MySql);
    IBQ_Matriz.Open;

    sFornEndereco :=Trim(IBQ_Matriz.FieldByName('Endereco').AsString);
    sFornCidade   :=Trim(IBQ_Matriz.FieldByName('Cidade').AsString);
    sFornEstado   :=Trim(IBQ_Matriz.FieldByName('Estado').AsString);
    sFornCodCep   :=Trim(IBQ_Matriz.FieldByName('Cod_Cep').AsString);
    sFornFone1    :=Trim(IBQ_Matriz.FieldByName('Fone1').AsString);
    sFornFoneFax  :=Trim(IBQ_Matriz.FieldByName('FoneFax').AsString);
    sFornEmail    :=Trim(IBQ_Matriz.FieldByName('EMail').AsString);
    sFornContato  :=Trim(IBQ_Matriz.FieldByName('Contato').AsString);
    IBQ_Matriz.Close;

    // Imprime Ordem de Compra --------------------------------------
    sgTipoImpressao:='ImpOC';

    // Diretorio dos Relatrios -------------------------------------
    {$IFDEF MSWINDOWS}
      dir_relat       :=  ExtractFilePath(Application.ExeName)+'Relatorios\';
    {$ENDIF}

    DMRelatorio.frDBDataSet1.DataSet:=DMBelShop.IBQ_OrdemCompra;
    DMRelatorio.frReport1.LoadFromFile(Dir_Relat+'OrdemCompra.frf');

    // Atualiza Variaveis -------------------------------------------
    DMRelatorio.frReport1.Dictionary.Variables.Variable['Telefone']:=#39+sEmpTelefone+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['Contato']:=#39+sEmpCcontato+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['EMail']:=#39+sEmpEmail+#39;

    DMRelatorio.frReport1.Dictionary.Variables.Variable['EnderecoForn']:=#39+sFornEndereco+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['CidadeForn']:=#39+sFornCidade+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['EstadoForn']:=#39+sFornEstado+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['CepForn']:=#39+sFornCodCep+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['FoneForn']:=#39+sFornFone1+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['FoneFaxForn']:=#39+sFornFonefax+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['EmailForn']:=#39+sFornEmail+#39;
    DMRelatorio.frReport1.Dictionary.Variables.Variable['ContatoForn']:=#39+sFornContato+#39;

    DMRelatorio.frReport1.PrepareReport;
    DMRelatorio.frReport1.ShowReport;

    Screen.Cursor:=crDefault;
    OdirPanApres.Visible:=False;
    Refresh;
  End; // If Bt_GeraOCImpEditOC.Caption='Imprimir OC' Then

end;

procedure TFrmBelShop.Dbg_GeraOCTotalGeralDblClick(Sender: TObject);
Var
  bGrava: Boolean;
begin
  bGrava:=True;
  If (Trim(DMBelShop.CDS_AComprarOCsIND_OC_GERADA.AsString)='S') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='OC') Then
  Begin
    msg('Ordem de Compra j Gerada !!','A');
    bGrava:=False;
  End;

  If DMBelShop.CDS_AComprarOCsTOTAL_OC.AsCurrency=0 Then
  Begin
    msg('Valor do Documento Igual a Zero !!','A');
    bGrava:=False;
  End;

  If Not bGrava Then
  Begin
    DMBelShop.CDS_AComprarOCs.Edit;
    DMBelShop.CDS_AComprarOCsGERAR.AsString:='N';
    DMBelShop.CDS_AComprarOCs.Post;
    Exit;
  End; // If Not bGrava Then

  If DMBelShop.CDS_AComprarOCsGERAR.AsString='S' Then
  Begin
    DMBelShop.CDS_AComprarOCs.Edit;
    DMBelShop.CDS_AComprarOCsGERAR.AsString:='N';
    DMBelShop.CDS_AComprarOCs.Post;

    If igQtd_Tipo>0 Then
     igQtd_Tipo:=igQtd_Tipo-1;

    If igQtd_Tipo<0 Then
     igQtd_Tipo:=0;

    Exit;
  End; // If DMBelShop.CDS_AComprarOCsGERAR.AsString='S' Then

  If igQtd_Tipo=0 Then
   Begin
     DMBelShop.CDS_AComprarOCs.Edit;
     DMBelShop.CDS_AComprarOCsGERAR.AsString:='S';
     DMBelShop.CDS_AComprarOCs.Post;

     sgIndOCGerada:=DMBelShop.CDS_AComprarOCsIND_OC_GERADA.AsString;
     sgTipo :=DMBelShop.CDS_AComprarOCsTIPO.AsString;
     igQtd_Tipo:=1;
   End
  Else // If igQtd_Tipo=0 Then
   Begin
     If (sgIndOCGerada=DMBelShop.CDS_AComprarOCsIND_OC_GERADA.AsString) And (sgTipo =DMBelShop.CDS_AComprarOCsTIPO.AsString) Then
      Begin
        igQtd_Tipo:=igQtd_Tipo+1;

        DMBelShop.CDS_AComprarOCs.Edit;
        DMBelShop.CDS_AComprarOCsGERAR.AsString:='S';
        DMBelShop.CDS_AComprarOCs.Post;
      End
     Else // If (sgIndOCGerada=DMBelShop.CDS_AComprarOCsIND_OC_GERADA.AsString) And...
      Begin
        DMBelShop.CDS_AComprarOCs.Edit;
        DMBelShop.CDS_AComprarOCsGERAR.AsString:='N';
        DMBelShop.CDS_AComprarOCs.Post;

        msg('Selecione Somente Um Tipo de Documento:'+cr+cr+'(OC)=Ordem de Compra ou'+cr+'(TR)=Romaneio de Transferncia)'+cr+'(Aberto ou Fechado) !!','A');
      End; // If (sgIndOCGerada=DMBelShop.CDS_AComprarOCsIND_OC_GERADA.AsString) And...
   End; // If igQtd_Tipo=0 Then
end;

procedure TFrmBelShop.Ckb_FiltroProdNaoCompraClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FiltroProdNaoCompra);

end;

procedure TFrmBelShop.EdtGeraOCBuscaDoctoEnter(Sender: TObject);
begin
  bEnterTab:=True;
end;

procedure TFrmBelShop.Dbg_GeraOCGridColEnter(Sender: TObject);
begin
  //////////////////////////////////////////////////////////////////////////////
  // ESTA LIGADO TAMBEM NO Dbg_GeraOCEditaTotalGeral
  //////////////////////////////////////////////////////////////////////////////

  bEnterTab:=False;
end;

procedure TFrmBelShop.Dbg_GeraOCGridColExit(Sender: TObject);
begin
  //////////////////////////////////////////////////////////////////////////////
  // ESTA LIGADO TAMBEM NO Dbg_GeraOCEditaTotalGeral
  //////////////////////////////////////////////////////////////////////////////

  bEnterTab:=True;

end;

procedure TFrmBelShop.PopM_AuditoriaPopup(Sender: TObject);
Var
  MySql: String;
begin
  If bgInd_Admin Then
  Begin
    MySql:=' Select oc.Blob_Texto'+
           ' From OC_COMPRAR oc'+
           ' Where oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
           ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
           ' And   oc.Num_Seq='+DMBelShop.IBQ_AComprarNUM_SEQ.AsString;
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    FrmAuditoria:=TFrmAuditoria.Create(Self);
    FrmAuditoria.DBMemo1.DataSource:=DMBelShop.DS_Busca;
    FrmAuditoria.DBMemo1.DataField:='BLOB_TEXTO';
    FrmAuditoria.ShowModal;
    FreeAndNil(FrmAuditoria);
  End; // If Ind_Admin Then
end;

procedure TFrmBelShop.Ts_OCBuscaProdutosEnter(Sender: TObject);
begin
  bEnterTab:=True;

end;

procedure TFrmBelShop.Ts_OCGeraOrdemCompraExit(Sender: TObject);
begin
  bEnterTab:=True;
end;

procedure TFrmBelShop.SubMenuComprasContaCorreteFornClick(Sender: TObject);
begin
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmFluxoFornecedor, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Permisses de Visualizao ================================================
//  PermissaoVisual(FrmFluxoFornecedor.Ts_????);

  FrmFluxoFornecedor.EdtFluFornCodFornecedor.Clear;
  FrmFluxoFornecedor.EdtFluFornFornecedor.Clear;
  FrmFluxoFornecedor.EdtFluFornComprovante.Clear;

  FrmFluxoFornecedor.ShowModal;
end;

procedure TFrmBelShop.Bt_GeraOCBuscaDoctoClick(Sender: TObject);
Var
  MySql: String;
begin
  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);
  Dbg_GeraOCGrid.SetFocus;

  FrmPesquisa:=TFrmPesquisa.Create(Self);

  EdtGeraOCBuscaDocto.Clear;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' SELECT CAST(d.num_docto AS VARCHAR(15)) Num_Documento,'+
         '        d.des_comprador, d.origem, d.dta_docto Dta_Documento, d.cod_comprador'+
         ' FROM OC_COMPRAR_DOCS d'+
         ' WHERE d.dta_docto='+QuotedStr(f_Troca('/','.',(f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date)))))+
         ' AND   d.Origem<>'+QuotedStr('Linx')+
         ' AND   EXISTS (SELECT 1'+
         '               FROM  OC_COMPRAR c'+
         '               WHERE c.num_documento=d.num_docto'+
         '               AND   CAST(c.dta_documento AS DATE)=d.dta_docto)'+
         ' ORDER BY 1';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('Num_Documento').AsString)='' Then
  Begin
    msg('Sem Documento a Listar !!','A');
    DMBelShop.CDS_Pesquisa.Close;
    FreeAndNil(FrmPesquisa);
    EdtGeraOCBuscaDocto.SetFocus;
    Exit;
  End;

  // Dbg_Pesquisa para Pesquisa de Documentos de OC ============================
  FrmPesquisa.Dbg_PesquisaPesquisaDoctosOC;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Num_Documento';
  FrmPesquisa.Campo_Codigo:='Num_Documento';
  FrmPesquisa.Campo_Descricao:='Num_Documento';//Dta_Documento';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtGeraOCBuscaDocto.Text:=FrmPesquisa.EdtCodigo.Text;
   End
  Else
   Begin
     FreeAndNil(FrmPesquisa);
     EdtGeraOCBuscaDocto.Clear;
     EdtGeraOCBuscaDocto.SetFocus;
     Exit;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);

  EdtGeraOCBuscaDoctoExit(self);
end;

procedure TFrmBelShop.Bt_OCBuscaListaPrecoClick(Sender: TObject);
Var
  MySql: String;
begin

  EdtOCListaPreco.Clear;

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);
  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' select lp.nomelista, lp.codlista'+
         ' from lista lp'+
         ' where lp.desativada=''N'''+
         ' order by lp.nomelista';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('codlista').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtOCCodListaPreco.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtOCCodListaPreco.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeLista';
  FrmPesquisaIB.Campo_Codigo:='CodLista';
  FrmPesquisaIB.Campo_Descricao:='NomeLista';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    EdtOCListaPreco.Text:=FrmPesquisaIB.EdtDescricao.Text;
    EdtOCCodListaPreco.Text:=FrmPesquisaIB.EdtCodigo.Text;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_FiltroBuscaGrupoSTClick(Sender: TObject);
Var
  i: Integer;
  s: String;
begin
  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.FieldDefs.Clear;

  FrmPesquisaIB.IBCDS_Pesquisa.FieldDefs.Add('Cod_GrupoST',ftInteger);
  FrmPesquisaIB.IBCDS_Pesquisa.FieldDefs.Add('Des_GrupoST',ftString,30);

  FrmPesquisaIB.IBCDS_Pesquisa.CreateDataSet;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;
  For i:=0 to 20 do
  Begin
    If i= 0 Then s:='No usa';
    If i= 1 Then s:='Autopeas';
    If i= 2 Then s:='Rao';
    If i= 3 Then s:='Colches';
    If i= 4 Then s:='Cosmticos';
    If i= 5 Then s:='Arroz beneficiado';
    If i= 6 Then s:='Correias de Transmisso e Rolamentos';
    If i= 7 Then s:='Tintas e Vernizes';
    If i= 8 Then s:='Sucos de Frutas e Bebidas no Alcolicas';
    If i= 9 Then s:='Ferramentas';
    If i=10 Then s:='Materiais Eltricos';
    If i=11 Then s:='Mat. Construo, Acabamento, Bricolagem ou Adorno';
    If i=12 Then s:='Bicicletas';
    If i=13 Then s:='Brinquedos';
    If i=14 Then s:='Material de Limpeza';
    If i=15 Then s:='Produtos Alimentcios';
    If i=16 Then s:='Artefatos de Uso Domstico';
    If i=17 Then s:='Bebidas Quentes';
    If i=18 Then s:='Artigos de Papelaria';
    If i=19 Then s:='Instrumentos Musicais';
    If i=20 Then s:='Prod. Eletronicos, Eletroeletronicos, Eletrodomsticos';

    FrmPesquisaIB.IBCDS_Pesquisa.Insert;
    FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('Cod_GrupoST').AsInteger:=i;
    FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('Des_GrupoST').AsString:=AnsiUpperCase(s);
    FrmPesquisaIB.IBCDS_Pesquisa.Post;
  End; // For i:=1 to 20 do

  Screen.Cursor:=crDefault;


  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='Des_GrupoST';
  FrmPesquisaIB.Campo_Codigo:='Cod_GrupoST';
  FrmPesquisaIB.Campo_Descricao:='Des_GrupoST';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    If DMVirtual.CDS_V_GrupoST.Locate('Cod_GrupoST',FrmPesquisaIB.EdtCodigo.Text,[]) Then
    Begin
      Begin
        msg('Grupo ST J Informado !!','A');
        EdtFiltroCodGrupoST.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtFiltroCodGrupoST.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_GrupoST.Insert;
    DMVirtual.CDS_V_GrupoSTCod_GrupoST.AsString:=FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_GrupoSTDes_GrupoST.AsString:=FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_GrupoST.Post;

  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.FieldDefs.Clear;
  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_FiltroBuscaFornClick(Sender: TObject);
Var
  MySql: String;
  bSiga: Boolean;
begin

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);
  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_MPMS.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_MPMS.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  bSiga:=True;
  If (PC_ConsultaMovtoCompr.Visible) and (PC_ConsultaMovtoCompr.CanFocus) Then
  Begin
    MySql:=' SELECT f.nomefornecedor, f.codfornecedor'+
           ' FROM FORNECED f';
    bSiga:=False;
  End;

  If bSiga Then
  Begin
    MySql:=' select distinct f.nomefornecedor, f.codfornecedor'+
           ' from produto p, forneced f'+
           ' where p.principalfor=f.codfornecedor';

           If Painel_FiltroNaoCompra.Visible Then
           Begin
             If Not Ckb_FiltroProdNaoCompra.Checked Then
              MySql:=MySql+' And Coalesce(p.situacaopro,0)=0'
             Else
              MySql:=MySql+' And Coalesce(p.situacaopro,0) in (0,3)';
           End;

           Try
             Cbx_EstFisFinanSituacaoProd.SetFocus;
             If Cbx_EstFisFinanSituacaoProd.ItemIndex=0      Then MySql:=MySql+' And Coalesce(p.situacaopro,0)=0'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then MySql:=MySql+' And Coalesce(p.situacaopro,3)=3'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then MySql:=MySql+' And Coalesce(p.situacaopro,0) in (0,3)';
           Except
           End;

           Try
             Cbx_ConsultaNfeSituacaoProd.SetFocus;
             If Cbx_ConsultaNfeSituacaoProd.ItemIndex=0      Then MySql:=MySql+' And Coalesce(p.situacaopro,0)=0'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then MySql:=MySql+' And Coalesce(p.situacaopro,3)=3'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then MySql:=MySql+' And Coalesce(p.situacaopro,0) in (0,3)';
           Except
           End;
    bSiga:=False;
  End; // If bSiga Then

  MySql:=
   MySql+' order by f.nomefornecedor';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('codfornecedor').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtFiltroCodForn.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtFiltroCodForn.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeFornecedor';
  FrmPesquisaIB.Campo_Codigo:='CodFornecedor';
  FrmPesquisaIB.Campo_Descricao:='NomeFornecedor';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    If DMVirtual.CDS_V_Fornecedores.Locate('Cod_Fornecedor',FrmPesquisaIB.EdtCodigo.Text,[]) Then
    Begin
      Begin
        msg('Fornecedor J Informado !!','A');
        EdtFiltroCodForn.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtFiltroCodForn.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_Fornecedores.Insert;
    DMVirtual.CDS_V_FornecedoresCod_Fornecedor.AsString:=FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_FornecedoresDes_Fornecedor.AsString:=FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_Fornecedores.Post;

    // Monta sFornecedore
    MontaSelectFornecedores;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_FiltroBuscaProdtudoClick(Sender: TObject);
Var
  MySql: String;
begin

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySqlClausula1:='';
  MySql:=' select p.Apresentacao Des_Produto, p.CodProduto, p.PrincipalFor'+
         ' from produto p';

         If Painel_FiltroNaoCompra.Visible Then
         Begin
           If Not Ckb_FiltroProdNaoCompra.Checked Then
            MySqlClausula1:=' WHERE Coalesce(p.situacaopro,0)=0'
           Else
            MySqlClausula1:=' WHERE Coalesce(p.situacaopro,0) in (0,3)';
         End; // If Painel_FiltroNaoCompra.Visible Then

         If MySqlClausula1='' Then
         Begin
           Try
             Cbx_EstFisFinanSituacaoProd.SetFocus;
             If Cbx_EstFisFinanSituacaoProd.ItemIndex=0      Then MySqlClausula1:=' Where Coalesce(p.situacaopro,0)=0'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then MySqlClausula1:=' Where Coalesce(p.situacaopro,3)=3'
             Else If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then MySqlClausula1:=' Where Coalesce(p.situacaopro,0) in (0,3)';
           Except
           End; // Try

           Try
             Cbx_ConsultaNfeSituacaoProd.SetFocus;
             If Cbx_ConsultaNfeSituacaoProd.ItemIndex=0      Then MySqlClausula1:=' Where Coalesce(p.situacaopro,0)=0'
             Else If Cbx_ConsultaNfeSituacaoProd.ItemIndex=1 Then MySqlClausula1:=' Where Coalesce(p.situacaopro,3)=3'
             Else If Cbx_ConsultaNfeSituacaoProd.ItemIndex=2 Then MySqlClausula1:=' Where Coalesce(p.situacaopro,0) in (0,3)';
           Except
           End;
         End; // If MySqlClausula1='' Then

         If Trim(sgFornecedores)<>'' Then
         Begin
           If MySqlClausula1='' Then
            MySqlClausula1:=' Where p.principalfor in ('+sgFornecedores+')'
           Else
            MySqlClausula1:=
             MySqlClausula1+' AND p.principalfor in ('+sgFornecedores+')'
         End; // If Trim(sgFornecedores)<>'' Then

         MySql:=
          MySql+MySqlClausula1+' Order by p.Apresentacao';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('PrincipalFor').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtFiltroCodProduto.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtFiltroCodProduto.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='Des_Produto';
  FrmPesquisaIB.Campo_Codigo:='CodProduto';
  FrmPesquisaIB.Campo_Descricao:='Des_Produto';
  FrmPesquisaIB.EdtDescricao.Clear;
  FrmPesquisaIB.Campo_Retorno1:='PrincipalFor';

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    If DMVirtual.CDS_V_Produtos.Locate('Cod_Produto',FrmPesquisaIB.EdtCodigo.Text,[]) Then
    Begin
      Begin
        msg('Produto J Informado !!','A');
        EdtFiltroCodProduto.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtFiltroCodProduto.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_Produtos.Insert;
    DMVirtual.CDS_V_ProdutosCod_Produto.AsString:=FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_ProdutosDes_Produto.AsString:=FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_ProdutosCod_Fornecedor.AsString:=FrmPesquisaIB.Retorno1;
    DMVirtual.CDS_V_Produtos.Post;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_FiltroBuscaGrupoClick(Sender: TObject);
Var
  MySql: String;
begin

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' select TRIM(g.NomeGrupo) NomeGrupo, TRIM(g.CodGrupo) CodGrupo'+
         ' from Grupo g'+
         ' order by g.nomegrupo';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('codGrupo').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtFiltroCodGrupo.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtFiltroCodGrupo.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeGrupo';
  FrmPesquisaIB.Campo_Codigo:='CodGrupo';
  FrmPesquisaIB.Campo_Descricao:='NomeGrupo';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') And (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0') Then
  Begin
    If DMVirtual.CDS_V_GruposProdutos.Locate('Cod_Grupo',FrmPesquisaIB.EdtCodigo.Text,[]) Then
    Begin
      Begin
        msg('Grupo J Informado !!','A');
        EdtFiltroCodGrupo.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtFiltroCodGrupo.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_GruposProdutos.Insert;
    DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString:=FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_GruposProdutosDes_Grupo.AsString:=FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_GruposProdutos.Post;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') And (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0') Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_FiltroBuscaSubGrupoClick(Sender: TObject);
Var
  MySql: String;
begin

  If DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin
    msg('Favor Selecioanr o Grupo de Produtos !!','A');
    EdtFiltroCodGrupo.SetFocus;
    Exit;
  End;

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' select TRIM(sg.NomeSubGrupo) NomeSubGrupo, TRIM(sg.CodSubGrupo) CodSubGrupo'+
         ' from GrupoSub sg'+
         ' where sg.codgrupo='+
         QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString)+
         ' order by sg.NomeSubGrupo';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('CodSubGrupo').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtFiltroCodSubGrupo.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtFiltroCodSubGrupo.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeSubGrupo';
  FrmPesquisaIB.Campo_Codigo:='CodSubGrupo';
  FrmPesquisaIB.Campo_Descricao:='NomeSubGrupo';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') And (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0') Then
  Begin
    If DMVirtual.CDS_V_SubGruposProdutos.Locate('Cod_Grupo; Cod_SubGrupo',
       VarArrayOf([DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString,
       FrmPesquisaIB.EdtCodigo.Text]),[]) Then
    Begin
      Begin
        msg('Sub-Grupo J Informado !!','A');
        EdtFiltroCodSubGrupo.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtFiltroCodSubGrupo.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_SubGruposProdutos.Insert;
    DMVirtual.CDS_V_SubGruposProdutosCod_Grupo.AsString:=
                               DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString;
    DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString:=
                              (DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+
                                                  FrmPesquisaIB.EdtCodigo.Text);
    DMVirtual.CDS_V_SubGruposProdutosCod_SubGrupo.AsString:=
                                                   FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_SubGruposProdutosDes_SubGrupo.AsString:=
                                                FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_SubGruposProdutos.Post;

    DMVirtual.CDS_V_GruposProdutosAfterScroll(DMVirtual.CDS_V_GruposProdutos);
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') And (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0') Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_OCBuscaAplicacaoClick(Sender: TObject);
Var
  MySql: String;
begin
  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  // Busca Aplicaes ==========================================================
  MySql:='select a.NomeAplicacao, a.CodAplicacao'+
         ' from Aplica a'+
         ' order by a.NomeAplicacao';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('CodAplicacao').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtOCCodAplicacao.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtOCCodAplicacao.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeAplicacao';
  FrmPesquisaIB.Campo_Codigo:='CodAplicacao';
  FrmPesquisaIB.Campo_Descricao:='NomeAplicacao';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    If DMVirtual.CDS_V_Aplicacao.Locate('Cod_Aplicacao',FrmPesquisaIB.EdtCodigo.Text,[]) Then
    Begin
      Begin
        msg('Aplicacao J Informada !!','A');
        EdtOCCodAplicacao.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtOCCodAplicacao.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_Aplicacao.Insert;
    DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString:=FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_AplicacaoDes_Aplicacao.AsString:=FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_Aplicacao.Post;

  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_OCBuscaFamiliaPrecosClick(Sender: TObject);
Var
  MySql: String;
begin

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  // Busca Familia Precos ======================================================
  MySql:='select f.NomeFamiliaPreco, f.CodFamiliaPreco'+
         ' from FamiliaP f'+
         ' order by f.NomeFamiliaPreco';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('CodFamiliaPreco').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtOCCodFamiliaPrecos.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtOCCodFamiliaPrecos.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeFamiliaPreco';
  FrmPesquisaIB.Campo_Codigo:='CodFamiliaPreco';
  FrmPesquisaIB.Campo_Descricao:='NomeFamiliaPreco';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    If DMVirtual.CDS_V_FamiliaPrecos.Locate('Cod_FamiliaPreco',FrmPesquisaIB.EdtCodigo.Text,[]) Then
    Begin
      Begin
        msg('Familia Precos J Informada !!','A');
        EdtOCCodFamiliaPrecos.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtOCCodFamiliaPrecos.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_FamiliaPrecos.Insert;
    DMVirtual.CDS_V_FamiliaPrecosCod_FamiliaPreco.AsString:=FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_FamiliaPrecosDes_FamiliaPreco.AsString:=FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_FamiliaPrecos.Post;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Dbg_GeraOCEditaGridKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  s: String;
begin
  If key=Vk_Return Then
  Begin
    DMBelShop.IBQ_AComprarEdita.Next;
    Dbg_GeraOCEditaGrid.SetFocus;
    Dbg_GeraOCEditaGrid.SelectedIndex:=2;
    Exit;
  End;

  // Altera Preco Unitrio =====================================================
  If (key=Vk_F2) and (dxStatusBar1.Visible) Then
   AlteraAComprar(DMBelShop.IBQ_AComprarEdita, 'P', VarToStr(EdtGeraOCBuscaDocto.Value), DateToStr(DtEdt_GeraOCDataDocto.Date));

  // Localiza Produto ==========================================================
  If Key=VK_F4 Then
  Begin
    s:='';
    If InputQuery('Localizar Produto','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          DMBelShop.IBQ_AComprarEdita.Locate('Cod_Item',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMBelShop.IBQ_AComprarEdita.Locate('Des_Item',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) then
  End; // If Key=VK_F4 Then

  // Altera Desconto Individual ================================================
  If (key=Vk_F3) and (dxStatusBar1.Visible) Then
   AlteraAComprar(DMBelShop.IBQ_AComprarEdita, 'DI', VarToStr(EdtGeraOCBuscaDocto.Value), DateToStr(DtEdt_GeraOCDataDocto.Date));

  // Altera Desconto no Mix ====================================================
  If (key=Vk_F5) and (dxStatusBar1.Visible) Then
   AlteraAComprar(DMBelShop.IBQ_AComprarEdita, 'DM', VarToStr(EdtGeraOCBuscaDocto.Value), DateToStr(DtEdt_GeraOCDataDocto.Date));

  // Transito ==================================================================
  If (Key=VK_F6) and (dxStatusBar1.Visible) Then
  Begin
    VerTransito(DMBelShop.IBQ_AComprarEdita, DMBelShop.DS_AComprarEdita, False);
  End; // Transito - If Key=VK_F3 Then
end;

procedure TFrmBelShop.PC_GeraOCEditaApresentacaoChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_GeraOCEditaApresentacao);

  If (PC_GeraOCEditaApresentacao.ActivePage=Ts_GeraOCEditaGrid) And (Ts_GeraOCEditaGrid.CanFocus) Then
  Begin
    Dbg_GeraOCEditaGrid.SelectedIndex:=2;
    Dbg_GeraOCEditaGrid.SetFocus;
  End;

end;

procedure TFrmBelShop.Bt_GeraOCEditaVoltarClick(Sender: TObject);
begin
  DMBelShop.IBQ_AComprarEdita.Close;

  EdtGeraOCEditaDocto.Clear;
  DtEdt_GeraOCEditaDataDocto.Clear;

  Ts_OCBuscaProdutos.TabVisible:=True;
  Ts_OCGeraOrdemCompra.TabVisible:=True;
  Ts_OCGeraEditaOrdemCompra.TabVisible:=False;

  PC_OrdemCompra.TabIndex:=1;
  PC_OrdemCompraChange(Sender);

  If EdtGeraOCBuscaDocto.AsInteger=0 Then
    EdtGeraOCBuscaDocto.SetFocus
  Else
   PC_GeraOCApresentacaoChange(Self);

  If PC_GeraOCApresentacao.ActivePage=Ts_GeraOCGrid Then
   Dbg_GeraOCGrid.SetFocus;

  If PC_GeraOCApresentacao.ActivePage=Ts_GeraOCOrdensCompra Then
   Dbg_GeraOCTotalGeral.SetFocus;
end;

procedure TFrmBelShop.Rb_GeraOCEditaTodosItensClick(Sender: TObject);
Var
  MySql: String;
  sTotal_Valor, sTotal_Itens, sTotal_Qtd: String;
  s: String;
begin

  If Not Rb_GeraOCEditaTodosItens.Visible Then
   Exit;

  AcertaRb_Style(Rb_GeraOCEditaTodosItens);
  AcertaRb_Style(Rb_GeraOCEditaComQtd);
  AcertaRb_Style(Rb_GeraOCEditaSemQtd);

  // Busca Pedido -------------------------------------------------
  MySql:='Select *'+
         ' From OC_COMPRAR oc'+
         ' Where oc.ind_oc_gerada=''N'''+
         ' And   oc.qtd_transf=0'+
         ' And   oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
         ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
         ' And   oc.cod_empresa='+QuotedStr(sgCodEmp)+
         ' And   oc.cod_fornecedor='+QuotedStr(DMBelShop.IBQ_AComprarEditaCOD_FORNECEDOR.AsString);

         If Rb_GeraOCEditaComQtd.Checked Then
          MySql:=MySql+' And oc.qtd_acomprar<>0';

         If Rb_GeraOCEditaSemQtd.Checked Then
          MySql:=MySql+' And oc.qtd_acomprar=0';

         MySql:=MySql+' Order By oc.Des_Item';
  DMBelShop.IBQ_AComprarEdita.Close;
  DMBelShop.IBQ_AComprarEdita.SQL.Clear;
  DMBelShop.IBQ_AComprarEdita.SQL.Add(MySql);
  DMBelShop.IBQ_AComprarEdita.Open;

  If DMBelShop.IBQ_AComprarEdita.IsEmpty Then
  Begin
    msg('Documento Nmero: '+VarToStr(EdtGeraOCBuscaDocto.Value)+cr+cr+'Sem Produto a Listar !!','A');

    DMBelShop.IBQ_AComprarEdita.Close;

    Exit;
  End; // If DMBelShop.CDS_AComprarItens.IsEmpty Then

  // Busca Totais do Pedido ===================================================
  If Rb_GeraOCEditaComQtd.Checked Then s:='C';
  If Rb_GeraOCEditaSemQtd.Checked Then s:='S';
  If Rb_GeraOCEditaTodosItens.Checked Then s:='T';

  TotaisPedOC(sTotal_Valor, sTotal_Itens, sTotal_Qtd,
              DMBelShop.IBQ_AComprarEditaNUM_DOCUMENTO.AsString,
              DMBelShop.IBQ_AComprarEditaCOD_EMPRESA.AsString, s, '', DMBelShop.IBQ_AComprarEditaCOD_FORNECEDOR.AsString);

  EdtGeraOCEditaTotalGeral.Value  :=StrToCurr(sTotal_Valor);
  EdtGeraOCEditaTotalItens.Value  :=StrToCurr(sTotal_Itens);
  EdtGeraOCEditaTotallQtd.Value   :=StrToCurr(sTotal_Qtd);

  Dbg_GeraOCEditaGrid.SelectedIndex:=2;
  Dbg_GeraOCEditaGrid.SetFocus;
end;

procedure TFrmBelShop.SubMenuComprasGeraOCClick(Sender: TObject);
Var
  s: String;
  i: Integer;
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  OrderGrid:='';

  // Acerta Meses de Calculo ===================================================
  InicializaMeses;

  // Inicializa Tabelas Virtuais para Filtros ==================================
  try
    DMVirtual.CDS_V_Produtos.CreateDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  Except
    DMVirtual.CDS_V_Produtos.EmptyDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  End;

  try
    DMVirtual.CDS_V_Fornecedores.CreateDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  Except
    DMVirtual.CDS_V_Fornecedores.EmptyDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  End;
  MontaSelectFornecedores;

  try
    DMVirtual.CDS_V_GruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  Except
    DMVirtual.CDS_V_GruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_SubGruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  Except
    DMVirtual.CDS_V_SubGruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_Aplicacao.CreateDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  Except
    DMVirtual.CDS_V_Aplicacao.EmptyDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  End;

  try
    DMVirtual.CDS_V_FamiliaPrecos.CreateDataSet;
    DMVirtual.CDS_V_FamiliaPrecos.Open;
  Except
    DMVirtual.CDS_V_FamiliaPrecos.EmptyDataSet;
    DMVirtual.CDS_V_FamiliaPrecos.Open;
  End;

  try
    DMVirtual.CDS_V_GrupoST.CreateDataSet;
    DMVirtual.CDS_V_GrupoST.Open;
  Except
    DMVirtual.CDS_V_GrupoST.EmptyDataSet;
    DMVirtual.CDS_V_GrupoST.Open;
  End;

  // Cadastro de Grupos ST =====================================================
  try
    DMVirtual.CDS_GruposST.CreateDataSet;
    DMVirtual.CDS_GruposST.Open;
  Except
    DMVirtual.CDS_GruposST.EmptyDataSet;
    DMVirtual.CDS_GruposST.Open;
  End;

  For i:=0 to 20 do
  Begin
    If i= 0 Then s:='No usa';
    If i= 1 Then s:='Autopeas';
    If i= 2 Then s:='Rao';
    If i= 3 Then s:='Colches';
    If i= 4 Then s:='Cosmticos';
    If i= 5 Then s:='Arroz beneficiado';
    If i= 6 Then s:='Correias de Transmisso e Rolamentos';
    If i= 7 Then s:='Tintas e Vernizes';
    If i= 8 Then s:='Sucos de Frutas e Bebidas no Alcolicas';
    If i= 9 Then s:='Ferramentas';
    If i=10 Then s:='Materiais Eltricos';
    If i=11 Then s:='Mat. Construo, Acabamento, Bricolagem ou Adorno';
    If i=12 Then s:='Bicicletas';
    If i=13 Then s:='Brinquedos';
    If i=14 Then s:='Material de Limpeza';
    If i=15 Then s:='Produtos Alimentcios';
    If i=16 Then s:='Artefatos de Uso Domstico';
    If i=17 Then s:='Bebidas Quentes';
    If i=18 Then s:='Artigos de Papelaria';
    If i=19 Then s:='Instrumentos Musicais';
    If i=20 Then s:='Prod. Eletronicos, Eletroeletronicos, Eletrodomsticos';

    DMVirtual.CDS_GruposST.Insert;
    DMVirtual.CDS_GruposSTCod_GrupoST.AsInteger:=i;
    DMVirtual.CDS_GruposSTDes_GrupoST.AsString:=AnsiUpperCase(s);
    DMVirtual.CDS_GruposST.Post;
  End; // For i:=1 to 20 do

  // Inicializa Variaveis ======================================================
  Lb_EmpAprocessar.Caption:='0';
  Lb_EmpProcessadas.Caption:='0';
  Edt_OCTotProdutos.Value:=0;

  DMVirtual.CDS_V_EmpConexoes.First;
  While Not DMVirtual.CDS_V_EmpConexoes.Eof do
  Begin
    If DMVirtual.CDS_V_EmpConexoesCONEXAO.AsString='SIM' Then
     Lb_EmpAprocessar.Caption:=IntToStr(StrToInt(Lb_EmpAprocessar.Caption)+1);

    DMVirtual.CDS_V_EmpConexoes.Next;
  End; // While Not DMVirtual.CDS_V_EmpConexoes.Eof
  DMVirtual.CDS_V_EmpConexoes.First;

  // Inicializa Data de Pesquisa ===============================================
  DtEdt_GeraOCDataDocto.Date:=DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);

  // Limite para Transito dos Produtos =========================================
  DtEdt_CalculoTransito.Text:=DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)-30);

  // Limite para Produtos Novos ================================================
  DtEdt_CalculoProdNovos.Date:=PrimUltDia(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor),'P');
  DtEdt_CalculoProdNovos.Date:=DtEdt_CalculoProdNovos.Date-1;
  DtEdt_CalculoProdNovos.Date:=PrimUltDia(DtEdt_CalculoProdNovos.Date,'P');
  DtEdt_CalculoProdNovos.Date:=DtEdt_CalculoProdNovos.Date-1;
  DtEdt_CalculoProdNovos.Date:=PrimUltDia(DtEdt_CalculoProdNovos.Date,'P');
  DtEdt_CalculoProdNovos.Date:=DtEdt_CalculoProdNovos.Date-1;
  DtEdt_CalculoProdNovos.Date:=PrimUltDia(DtEdt_CalculoProdNovos.Date,'P');

  //============================================================================
  // PageControl de Filtros - INICIO ===========================================
  //============================================================================
  //-----------------------------------------------------------------
  // Filtro de Fornecedores -----------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFornecedor.Visible:=True;
  // Curva ABC no Fornecedor
  Painel_FiltroOC.Visible:=True;
  // Obs para Utilizao no Movto de Comprovantes
  Label_MovtoComprovForn.Visible:=False;
  Label_MovtoComprovForn.Top:=Painel_FiltroOC.Top;

  //-----------------------------------------------------------------
  // Filtro de Produtos ---------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroProdutos.TabVisible:=True;
  // Filtor nao Produtos de No Compra
  Painel_FiltroNaoCompra.Visible:=True;
  // Filtro para Busca Pelo Nome
  Gb_CalculoFiltroNome.Visible:=True;
  EdtCalculoFiltroNome1.Clear;
  EdtCalculoFiltroNome2.Clear;
  EdtCalculoFiltroNome3.Clear;
  EdtCalculoFiltroNome4.Clear;

  //-----------------------------------------------------------------
  // Filtro de Grupos e SubGrupos -----------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupos.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Aplicaes dos Produtos ------------------------------
  //-----------------------------------------------------------------
  TS_FiltroAplicacao.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Familia de Preos ------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFamiliaPreco.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Grupos ST --------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupoST.TabVisible:=True;

  //-----------------------------------------------------------------
  // Grupo de Comprovantes ------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroComprovantes.TabVisible:=False;

  //-----------------------------------------------------------------
  // Posiciona o PC_Filtros em seu Parent ---------------------------
  //-----------------------------------------------------------------
  PC_Filtros.Parent:=Pan_OC;
  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);
  //============================================================================
  // PageControl de Filtros - FIM ==============================================
  //============================================================================

  // Abre TabSheet =============================================================
  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);

  PC_OrdemCompra.TabIndex:=0;
  PC_OrdemCompraChange(Self);

  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);

  // Curva ABC =================================================================
  Rb_CalculoApresCurvaEstCom.Checked:=True;
  Ckb_CalculoCurvaTodas.Checked:=True;
  Ckb_CalculoCurvaTodasClick(Self);
  Rb_CalculoTpCurvaABCLoja.Checked:=True;
  Rb_CalculoTpCurvaABCLojaClick(Self);

  Gb_CalculoTpCurvaABC.Enabled:=False;
  Gb_CalculoApresCurva.Enabled:=False;
  Painel_FiltroOC.Height:=53;

  // Tipo de Calculo ===========================================================
  Rb_CalculoTpProcLoja.Checked:=False;
  Rb_CalculoTpProcLocal.Checked:=True;
  Rb_CalculoTpProcLocalClick(Self);
  Img_Calculo.Visible:=False;

  // Abre TabSheet =============================================================
  Ts_OCGeraEditaOrdemCompra.TabVisible:=False;
  EdtGeraOCBuscaDocto.Value:=0;
  EdtGeraOCDias.Value:=0;

  EdtOCCodListaPreco.Text:=sgCodListaPrePadrao;
  EdtOCCodListaPrecoExit(Self);

  // Verifica se h Solicitao de Loja nica a Importar =======================
  MySqlDML:=' SELECT COUNT( DISTINCT oc.num_documento) Qtd_Solictacao'+
            ' FROM oc_comprar_lojas oc'+
            ' WHERE oc.ind_oc_gerada='+QuotedStr('N');
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySqlDML;
  DMBelShop.CDS_BuscaRapida.Open;
  i:=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Solictacao').AsInteger;
  DMBelShop.CDS_BuscaRapida.Close;

  If i<>0 Then
  Begin
    If i=1 Then
     sgMensagem:='Existe '+IntToStr(i)+' Solcitao de Loja a IMPORTAR !!'
    Else
     sgMensagem:='Existem '+IntToStr(i)+' Solcitaes de Loja a IMPORTAR !!';

    msg(sgMensagem,'A');
    sgMensagem:='';
  End; // If i<>0 Then

  SelecionaTabSheet(Ts_OrdemCompra);
  CorSelecaoTabSheet(PC_Principal);

  EdtFiltroCodForn.SetFocus;
end;

procedure TFrmBelShop.SubMenuComprasConsultaOCClick(Sender: TObject);
Var
  i: Integer;
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  // Busca Empresas ============================================================
  Clbx_ConsultaOCEmpresas.Items.Clear;

  DMVirtual.CDS_V_EmpConexoes.First;

  DMVirtual.CDS_V_EmpConexoes.DisableControls;
  While Not DMVirtual.CDS_V_EmpConexoes.Eof do
  Begin
    Clbx_ConsultaOCEmpresas.Items.Add(
                           DMVirtual.CDS_V_EmpConexoesCOD_FILIAL.AsString+'-'+
                              DMVirtual.CDS_V_EmpConexoesRAZAO_SOCIAL.AsString);

    DMVirtual.CDS_V_EmpConexoes.Next;
  End; // While Not DMVirtual.CDS_V_EmpConexoes.Eof do
  DMVirtual.CDS_V_EmpConexoes.EnableControls;
  DMVirtual.CDS_V_EmpConexoes.First;

  For i:=0 to Clbx_ConsultaOCEmpresas.Items.Count-1 do
   Clbx_ConsultaOCEmpresas.Checked[i]:=True;

  Ckb_ConsultaOCSelectEmpresas.Checked:=True;

  // Abre TabSheet de Consulta Ordem de Compra =================================
  DtEdt_ConsultaOCDtInicio.Date:=PrimeiroUltimoDia(StrToDateTime('01/11/2011'),'P');
  DtEdt_ConsultaOCDtFim.Date:=StrToDateTime(DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)));

  bgSiga:=True;
  SelecionaTabSheet(Ts_ConsultaOC);
  DtEdt_ConsultaOCDtInicio.SetFocus;

end;

procedure TFrmBelShop.Bt_ConsultaOCBuscaOCsClick(Sender: TObject);
Var
  MySql: String;
  sEmpresas: String;
  i, ii: Integer;
begin

  Dbg_ConsultaOCOrdensCompra.SetFocus;

  If EdtConsultaOCCodFornecedor.Value=0 Then
  Begin
    msg('Favor Informar o Fornecedor !!','A');
    EdtConsultaOCCodFornecedor.SetFocus;
    Exit;
  End;

  If (Trim(DtEdt_ConsultaOCDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaOCDtFim.Text)<>'') Then
   Begin
     Try
       StrToDate(DtEdt_ConsultaOCDtInicio.Text);
     Except
       msg('Data Inicial do Perodo Invlida !!','A');
       DtEdt_ConsultaOCDtInicio.SetFocus;
       Exit;
     End;

     Try
       StrToDate(DtEdt_ConsultaOCDtFim.Text);
     Except
       msg('Data Final do Perodo Invlida !!','A');
       DtEdt_ConsultaOCDtFim.SetFocus;
       Exit;
     End;
   
     If DtEdt_ConsultaOCDtFim.Date<DtEdt_ConsultaOCDtInicio.Date Then
     Begin
       msg('Perodo Invlido !!','A');
       DtEdt_ConsultaOCDtInicio.SetFocus;
       Exit;
     End;
   End
  Else // If (Trim(DtEdt_ConsultaOCDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaOCDtFim.Text)='') Then
   Begin
     msg('Perodo Invlido !!','A');
     DtEdt_ConsultaOCDtInicio.SetFocus;
     Exit;
   End; // If (Trim(DtEdt_ConsultaOCDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaOCDtFim.Text)='') Then

  // Empresa a Consultar =======================================================
  sEmpresas:='';
  If Not Ckb_ConsultaOCSelectEmpresas.Checked Then
  Begin
    for i:=0 to Clbx_ConsultaOCEmpresas.Items.Count - 1 do
    Begin
     if Clbx_ConsultaOCEmpresas.Checked[i] Then
     Begin

       ii:=pos('-',Clbx_ConsultaOCEmpresas.Items[i]);

       If sEmpresas<>'' Then
        sEmpresas:=sEmpresas+', '+QuotedStr(Trim(Copy(Clbx_ConsultaOCEmpresas.Items[i],1,ii-1)));

       If sEmpresas='' Then
        sEmpresas:=QuotedStr(Trim(Copy(Clbx_ConsultaOCEmpresas.Items[i],1,ii-1)));

     End; // if Clbx_ConsultaOCEmpresas.Checked[i] Then
    End; // for i:=0 to Clbx_ConsultaOCEmpresas.Count - 1 do

    If sEmpresas<>'' Then
     Begin
       sEmpresas:='('+sEmpresas+')';
     End
    Else // If sEmpresas<>'' Then
     Begin
       msg('Favor Selecionar Empresa !!','A');
       Ckb_ConsultaOCSelectEmpresas.SetFocus;
       Exit;
     End;
  End; // If Not Ckb_ConsultaOCSelectEmpresas.Checked Then

  If (Trim(DtEdt_ConsultaOCDtInicio.Text)='') and (Trim(DtEdt_ConsultaOCDtFim.Text)='') and
     (EdtConsultaOCNumOC.Value=0) and (EdtConsultaOCNumDocto.Value=0) Then
  Begin
    If msg('ATENO !!'+cr+cr+'Todas as Ordens Sero Apresentadas !!'+cr+cr+'Deseja CONTINUAR ???','C')=2 Then
    Begin
      DtEdt_ConsultaOCDtInicio.SetFocus;
      Exit;
    End;
  End;

  Screen.Cursor:=crAppStart;

  // Busca Notas ===============================================================
  MySql:=' Select oc.num_documento, oc.cod_empresa Cod_Emp_Fil,'+cr+
         ' oc.des_empresa des_emp_fil, oc.cod_fornecedor, oc.num_oc_gerada,'+cr+
         ' cast(oc.dta_oc_gerada as Date) dta_oc_gerada,'+cr+
         ' sum(oc.vlr_bruto) Total_Bruto,'+cr+
         ' sum(oc.vlr_descontos) Total_Descontos,'+cr+
         ' sum(oc.vlr_ipi) Total_IPI,'+cr+
         ' sum(oc.vlr_despesas) Total_Despesas,'+cr+
         ' sum(oc.vlr_st) Total_ST,'+cr+
         ' sum(oc.vlr_frete) Total_Frete,'+cr+
         ' sum(oc.vlr_icms) Total_ICMS,'+cr+
         ' sum(oc.vlr_repasse) Total_Repasse,'+cr+
         ' sum(oc.vlr_tot_compra) Total_OC,'+cr+
         ' oc.cod_comprovante_icms,'+cr+
         ' Count(oc.cod_item) Total_Itens,'+cr+
         ' Sum(oc.qtd_acomprar) Total_Qtd'+cr+

         ' from oc_comprar oc'+cr+

         ' Where oc.ind_oc_gerada=''S'''+cr+
         ' And oc.qtd_transf=0'+

         ' and oc.cod_fornecedor='+QuotedStr(FormatFloat('000000', EdtConsultaOCCodFornecedor.AsInteger))+cr;

         If sEmpresas<>'' Then
          MySql:=MySql+' and oc.cod_empresa in '+sEmpresas+cr;

         If Trim(DtEdt_ConsultaOCDtInicio.Text)<>'' Then
         Begin
           MySql:=MySql+' and cast(oc.dta_oc_gerada as Date) between '+
              QuotedStr(f_Troca('/','.',DtEdt_ConsultaOCDtInicio.Text))+' and '+
                      QuotedStr(f_Troca('/','.',DtEdt_ConsultaOCDtFim.Text))+cr;
         End; // If Trim(DtEdt_ConsultaOCDtInicio.Text)<>'' Then

         If EdtConsultaOCNumDocto.Value<>0 Then
          MySql:=MySql+' and oc.num_documento='+VarToStr(EdtConsultaOCNumDocto.Value)+cr;

         If EdtConsultaOCNumOC.Value<>0 Then
          MySql:=MySql+' and oc.num_oc_gerada='+VarToStr(EdtConsultaOCNumOC.Value)+cr;

         MySql:=
          MySql+' AND   EXISTS (SELECT 1'+
                '               FROM OC_COMPRAR_DOCS d'+
                '               WHERE d.num_docto=oc.num_documento'+
                '               AND   d.origem<>'+QuotedStr('Linx')+')'+

                ' group by oc.num_documento, Cod_Emp_Fil, oc.des_empresa,'+cr+
                ' oc.cod_fornecedor, oc.num_oc_gerada,'+cr+
                ' cast(oc.dta_oc_gerada as Date), oc.cod_comprovante_icms'+cr+

                ' Having sum(oc.vlr_tot_compra)>0'+cr+

                ' Order by cod_emp_fil, oc.num_oc_gerada'; // cast(oc.dta_oc_gerada as Date),'+cr+
  DMBelShop.CDS_OCs.Close;
  DMBelShop.SDS_OCs.CommandText:=MySql;
  DMBelShop.CDS_OCs.Open;

  Screen.Cursor:=crDefault;

  If Trim(DMBelShop.CDS_OCsNUM_DOCUMENTO.AsString)='' Then
  Begin
    msg('Sem Ordem de Compra a Listar','A');
    DMBelShop.CDS_OCs.Close;
    Exit;
  End;
end;

procedure TFrmBelShop.DtEdt_ConsultaOCDtInicioEditing(Sender: TObject; var CanEdit: Boolean);
begin
  DMBelShop.CDS_OCs.Close;
end;

procedure TFrmBelShop.DtEdt_ConsultaOCDtFimEditing(Sender: TObject; var CanEdit: Boolean);
begin
  DMBelShop.CDS_OCs.Close;

end;

procedure TFrmBelShop.EdtConsultaOCCodFornecedorChange(Sender: TObject);
begin
  DMBelShop.CDS_OCs.Close;
  EdtConsultaOCDesFornecedor.Clear;

end;

procedure TFrmBelShop.EdtConsultaOCCodFornecedorExit(Sender: TObject);
Var
  MySql: String;
begin

  EdtConsultaOCDesFornecedor.Clear;
  DMBelShop.CDS_OCs.Close;

  If EdtConsultaOCCodFornecedor.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Fornecedores =======================================================
    MySql:=' select First 1 f.nomefornecedor, f.codfornecedor'+
           ' from produto p, forneced f'+
           ' where p.principalfor=f.codfornecedor'+
           ' and Coalesce(p.situacaopro,0) in (0,3)'+
           ' and f.codfornecedor='+QuotedStr(
           FormatFloat('000000',EdtConsultaOCCodFornecedor.AsInteger));
    IBQ_Matriz.Close;
    IBQ_Matriz.SQL.Clear;
    IBQ_Matriz.SQL.Add(MySql);
    IBQ_Matriz.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_Matriz.FieldByName('codfornecedor').AsString)='' Then
    Begin
      msg('Fornecedor NO Encontrado !!!', 'A');
      EdtConsultaOCCodFornecedor.Clear;
      EdtConsultaOCCodFornecedor.SetFocus;
      IBQ_Matriz.Close;
      Exit;
    End;

    EdtConsultaOCDesFornecedor.Text:=IBQ_Matriz.FieldByName('NomeFornecedor').AsString;

    IBQ_Matriz.Close;

    Bt_ConsultaOCBuscaOCs.SetFocus;

  End;
end;

procedure TFrmBelShop.Bt_ConsultaOCBuscaFornecedorClick(Sender: TObject);
Var
  MySql: String;
begin
             
  EdtConsultaOCCodFornecedor.Clear;
  EdtConsultaOCDesFornecedor.Clear;
  DMBelShop.CDS_OCs.Close;

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' select distinct f.nomefornecedor, f.codfornecedor'+
         ' from produto p, forneced f'+
         ' where p.principalfor=f.codfornecedor'+
         ' and Coalesce(p.situacaopro,0) in (0,3)'+
         ' order by f.nomefornecedor';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('codfornecedor').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtConsultaOCCodFornecedor.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtConsultaOCCodFornecedor.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeFornecedor';
  FrmPesquisaIB.Campo_Codigo:='CodFornecedor';
  FrmPesquisaIB.Campo_Descricao:='NomeFornecedor';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    EdtConsultaOCCodFornecedor.Text:=FrmPesquisaIB.EdtCodigo.Text;
    EdtConsultaOCDesFornecedor.Text:=FrmPesquisaIB.EdtDescricao.Text;
    Bt_ConsultaOCBuscaOCs.SetFocus;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB)
end;

procedure TFrmBelShop.Bt_ConsultaOCImprimeClick(Sender: TObject);
Var
  MySql, dir_relat: String;
begin

  If DMBelShop.CDS_OCs.IsEmpty Then
  Begin
    msg('Sem Ordem de Compra a Visualiza/Imprimir !!','A');
    EdtConsultaOCCodFornecedor.SetFocus;
    Exit;
  End;

  // Busca OC -----------------------------------------------------
  MySql:='SELECT oc.des_empresa, oc.num_oc_gerada,'+
         ' Case co.compl_endereco'+
         '   when '''' Then'+
         '      co.des_endereco ||'', ''|| co.num_endereco'+
         '   Else'+
         '      co.des_endereco ||'', ''|| co.num_endereco ||'' - ''|| co.compl_endereco'+
         ' End Endereco,'+
         ' co.des_bairro, co.des_cidade, co.cod_uf,'+

         ' cast((substring(co.cod_cep from 1 for 5) ||''-''|| substring(co.cod_cep from 6 for 3)) as varchar(9)) cod_cep,'+

         ' CAST(('+
         ' substring(co.num_cnpj from 1 for 2) ||''.''||'+
         ' substring(co.num_cnpj from 3 for 3) ||''.''||'+
         ' substring(co.num_cnpj from 6 for 3) ||''/''||'+
         ' substring(co.num_cnpj from 9 for 4) ||''-''||'+
         ' substring(co.num_cnpj from 13 for 2'+
         ' )) AS VARCHAR(18)) num_cnpj,'+

         ' co.inscr_estadual,'+
         ' case oc.ind_oc_gerada'+
         '   When ''N'' Then'+
         '      ''ABERTA'''+
         '   Else'+
         '      ''ABERTA - PENDENTE FORNECEDOR'''+
         ' End Situacao,'+
         ' Cast(oc.dta_oc_gerada as Date) Dta_Pedido,'+
         ' Cast(oc.dta_oc_gerada as Date) Dta_Entrega,'+
         ' oc.cod_fornecedor, oc.des_fornecedor,'+
         ' oc.cod_item, oc.cod_barras, oc.cod_referencia_forn,'+
         ' oc.des_item, oc.uni_compra, oc.uni_venda,'+
         ' oc.qtd_acomprar, oc.vlr_uni_compra, oc.per_desconto,'+
         ' oc.vlr_tot_compra, oc.obs_oc, oc.cod_comprador, us.des_usuario,'+
         ' ''000.000.000.0000'' Enderecamento'+

         ' FROM OC_COMPRAR oc'+
         '    LEFT JOIN EMP_CONEXOES co ON oc.cod_empresa=co.cod_filial'+
         '    LEFT JOIN PS_USUARIOS  us ON oc.cod_comprador=us.cod_usuario'+

         ' where oc.num_documento='+DMBelShop.CDS_OCsNUM_DOCUMENTO.AsString+
         ' and   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_OCsCOD_EMP_FIL.AsString)+
         ' and   oc.num_oc_gerada='+QuotedStr(DMBelShop.CDS_OCsNUM_OC_GERADA.AsString)+

         ' AND   EXISTS (SELECT 1'+
         '               FROM OC_COMPRAR_DOCS d'+
         '               WHERE d.num_docto=oc.num_documento'+
         '               AND   d.origem<>'+QuotedStr('Linx')+')'+

         ' order by oc.des_item';
  DMBelShop.IBQ_OrdemCompra.Close;
  DMBelShop.IBQ_OrdemCompra.SQL.Clear;
  DMBelShop.IBQ_OrdemCompra.SQL.Add(MySql);
  DMBelShop.IBQ_OrdemCompra.Open;

  // Dados da Filial ----------------------------------------------
  MySql:='select cl.telefone, cl.contato, cl.email'+
         ' from clientefone cl, filial fi'+
         ' where cl.codcliente = fi.codnocliente'+
         ' and fi.codfilial='+QuotedStr(DMBelShop.CDS_OCsCOD_EMP_FIL.AsString);
  IBQ_Matriz.Close;
  IBQ_Matriz.SQL.Clear;
  IBQ_Matriz.SQL.Add(MySql);
  IBQ_Matriz.Open;
  sEmpTelefone  :=Trim(IBQ_Matriz.FieldByName('Telefone').AsString);
  sEmpCcontato  :=Trim(IBQ_Matriz.FieldByName('Contato').AsString);
  sEmpEmail     :=Trim(IBQ_Matriz.FieldByName('Email').AsString);

  // Dados do Fornecedor ------------------------------------------
  MySql:='select fo.endereco, fo.cidade, fo.estado,'+
         ' (substring(fo.codigopostal from 1 for 5) ||''-''||'+
         '  substring(fo.codigopostal from 6 for 3)) cod_cep,'+
         ' fo.fone1, fo.fonefax, fo.email, fo.contato'+
         ' from forneced fo'+
         ' where fo.codfornecedor='+
         QuotedStr(DMBelShop.CDS_OCsCOD_FORNECEDOR.AsString);
  IBQ_Matriz.Close;
  IBQ_Matriz.SQL.Clear;
  IBQ_Matriz.SQL.Add(MySql);
  IBQ_Matriz.Open;
  sFornEndereco :=Trim(IBQ_Matriz.FieldByName('Endereco').AsString);
  sFornCidade   :=Trim(IBQ_Matriz.FieldByName('Cidade').AsString);
  sFornEstado   :=Trim(IBQ_Matriz.FieldByName('Estado').AsString);
  sFornCodCep   :=Trim(IBQ_Matriz.FieldByName('Cod_Cep').AsString);
  sFornFone1    :=Trim(IBQ_Matriz.FieldByName('Fone1').AsString);
  sFornFoneFax  :=Trim(IBQ_Matriz.FieldByName('FoneFax').AsString);
  sFornEmail    :=Trim(IBQ_Matriz.FieldByName('EMail').AsString);
  sFornContato  :=Trim(IBQ_Matriz.FieldByName('Contato').AsString);
  IBQ_Matriz.Close;

  // Imprime Ordem de Compra --------------------------------------
  sgTipoImpressao:='ImpOC';

  // Diretorio dos Relatrios -------------------------------------
  {$IFDEF MSWINDOWS}
    dir_relat       :=  ExtractFilePath(Application.ExeName)+'\Relatorios\';
  {$ENDIF}

  DMRelatorio.frDBDataSet1.DataSet:=DMBelShop.IBQ_OrdemCompra;
  DMRelatorio.frReport1.LoadFromFile(Dir_Relat+'OrdemCompra.frf');

  // Altera ClientDataSet -----------------------------------------
  (DMRelatorio.frReport1.FindObject('Memo49') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo49') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_BRUTO"]');

  (DMRelatorio.frReport1.FindObject('Memo51') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo51') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_ICMS"]');

  (DMRelatorio.frReport1.FindObject('Memo53') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo53') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_IPI"]');

  (DMRelatorio.frReport1.FindObject('Memo55') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo55') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_ST"]');

  (DMRelatorio.frReport1.FindObject('Memo57') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo57') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_DESPESAS"]');

  (DMRelatorio.frReport1.FindObject('Memo59') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo59') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_FRETE"]');

  (DMRelatorio.frReport1.FindObject('Memo61') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo61') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_DESCONTOS"]');

  (DMRelatorio.frReport1.FindObject('Memo63') as TfrMemoView).Memo.Clear;
  (DMRelatorio.frReport1.FindObject('Memo63') as TfrMemoView).Memo.Add('[DMBelShop.CDS_OCs."TOTAL_OC"]');

  (DMRelatorio.frReport1.FindObject('Memo48') as TfrMemoView).Memo.Clear;


  // Atualiza Variaveis -------------------------------------------
  DMRelatorio.frReport1.Dictionary.Variables.Variable['Telefone']:=#39+sEmpTelefone+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['Contato']:=#39+sEmpCcontato+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['EMail']:=#39+sEmpEmail+#39;

  DMRelatorio.frReport1.Dictionary.Variables.Variable['EnderecoForn']:=#39+sFornEndereco+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['CidadeForn']:=#39+sFornCidade+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['EstadoForn']:=#39+sFornEstado+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['CepForn']:=#39+sFornCodCep+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['FoneForn']:=#39+sFornFone1+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['FoneFaxForn']:=#39+sFornFonefax+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['EmailForn']:=#39+sFornEmail+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['ContatoForn']:=#39+sFornContato+#39;

  DMRelatorio.frReport1.PrepareReport;
  DMRelatorio.frReport1.ShowReport;

  DMBelShop.IBQ_OrdemCompra.Close;

end;

procedure TFrmBelShop.Ckb_ConsultaOCSelectEmpresasClick(Sender: TObject);
Var
  I: Integer;
begin
  DMBelShop.CDS_OCs.Close;

  If (Clbx_ConsultaOCEmpresas.Items.Count>0) and (bgSiga) Then
   Begin
     If Ckb_ConsultaOCSelectEmpresas.Checked Then
      Ckb_ConsultaOCSelectEmpresas.Font.Style:=[fsBold]
     Else
      Ckb_ConsultaOCSelectEmpresas.Font.Style:=[];

     For i:=0 to Clbx_ConsultaOCEmpresas.Items.Count-1 do
      Clbx_ConsultaOCEmpresas.Checked[i]:=Ckb_ConsultaOCSelectEmpresas.Checked;
   End
  Else // If Clbx_ConsultaOCEmpresas.Items.Count>0 Then
   Begin
     Ckb_ConsultaOCSelectEmpresas.Checked:=False;
   End; // If Clbx_ConsultaOCEmpresas.Items.Count>0 Then
end;

procedure TFrmBelShop.EdtConsultaOCNumOCChange(Sender: TObject);
begin
  DMBelShop.CDS_OCs.Close;

end;

procedure TFrmBelShop.Clbx_ConsultaOCEmpresasClick(Sender: TObject);
Var
  i: Integer;
  b: Boolean;
begin
   DMBelShop.CDS_OCs.Close;

   b:=True;
   For i:=0 to Clbx_ConsultaOCEmpresas.Items.Count-1 do
   Begin
     If Not Clbx_ConsultaOCEmpresas.Checked[i] Then
     Begin
       b:=False;
       Break;
     End;
   End; // For i:=0 to Clbx_ConsultaOCEmpresas.Items.Count-1 do

   bgSiga:=False;
   Ckb_ConsultaOCSelectEmpresas.Checked:=b;
   bgSiga:=True;

end;

procedure TFrmBelShop.SubMenuProtUsuariosAlteraoBancodeDadosDMLClick(Sender: TObject);
var
  slAtualiza : TStringList;
  i : integer;
  OpenDialog: TOpenDialog;
  MySql: String;
begin
  If msg('Deseja Realmente Efetuar Alterao'+cr+cr+'no Banco de Dados ???','C')=2 Then
   Exit;

  OpenDialog:=TOpenDialog.Create(OpenDialog);

  With OpenDialog do
  Begin
    Options := [ofPathMustExist, ofHideReadOnly, ofOverwritePrompt];
    DefaultExt := 'SQL';
    Filter := 'Arquivos SQL (*.SQL)|*.SQL';
    FilterIndex := 1;
    Title := 'Busca Arquivos de Atualizao de Banco de Dados (SQL)';

    If (Execute) and (FileExists(FileName)) Then
     Begin
       slAtualiza := TStringList.Create;
       slAtualiza.LoadFromFile(OpenDialog.FileName);
       i := 0;
       If slAtualiza.Strings[i] <> '[INICIO]' Then
        Begin
          msg('O Arquivo Invlido !!','A');
          FreeAndNil(slAtualiza);
        End
       Else // if slAtualiza.Strings[i] <> '[INICIO]' then
        Begin
          Try
            Screen.Cursor:=crAppStart;
            LB_DML.Visible:=True;

            TD.TransactionID:=Cardinal(FormatDateTime('ddmmyyyy',now)+FormatDateTime('hhnnss',now));
            TD.IsolationLevel:=xilREADCOMMITTED;
            DMBelShop.SQLC.StartTransaction(TD);

            MySql:='';
            While i < slAtualiza.Count do
            Begin
              If slAtualiza.Strings[i] = '[INICIO]' Then
              Begin
                i := i + 1;
                With DMBelShop.SQLC do
                Begin
                  while slAtualiza.Strings[i] <> '[FIM]' do
                  Begin
                    Refresh;

                    MySql:=MySql+' '+slAtualiza.Strings[i];
                    i := i + 1;
                  End;
                  LB_DML.Caption := MySql;
                  Application.ProcessMessages;

                  Execute(MySql, nil, nil);
                  MySql:='';
                End; // With DMBelShop.SQLC do
              End; // if slAtualiza.Strings[i] = '[INICIO]' then

              If slAtualiza.Strings[i] = '[COMMIT]' Then
              Begin
                DMBelShop.SQLC.Commit(TD);
                DMBelShop.SQLC.StartTransaction(TD);
              End;
              i := i + 1;
            End;
            DMBelShop.SQLC.Commit(TD);

            RenameFile(OpenDialog.FileName,OpenDialog.FileName+'OK');

            Screen.Cursor:=crDefault;

            LB_DML.Visible:=False;

            msg('Atualizao Efetuada com SUCESSO !!', 'A');
          Except
            on e : Exception do
            Begin
              Screen.Cursor:=crDefault;
              DMBelShop.SQLC.Rollback(TD);

              MessageBox(Handle, pChar('Mensagem de erro na Atualizao:'+#13+e.message), 'Erro', MB_ICONERROR);

              LB_DML.Visible:=False;
              FreeAndNil(slAtualiza);
              exit;
            End;

          End;
          FreeAndNil(slAtualiza);
        End;
     End
    Else // if (Execute) and (FileExists(FileName)) then
     Begin
       Free;
       Exit;
     End;
    Free;
  End; // with OpenDialog do

end;

procedure TFrmBelShop.SubMenuProtUsuariosBackupRestaureClick(Sender: TObject);
begin
  msg('Opo em Analise !!', 'A');
end;

procedure TFrmBelShop.SubMenuComprasCurvaABCClick(Sender: TObject);
Var                   
  MySql: String;
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Apresenta TabSheeet =======================================================
  SelecionaTabSheet(Ts_CurvaABCEndereco);

  // Posiciona TabSheet ========================================================
  Cbx_CurvaABCEndSituacaoProd.ItemIndex:=-1;
  EdtCurvaABCEndTotalProdutos.Value:=0;
  PC_CurvaABCEnderecamentos.TabIndex:=0;
  PC_CurvaABCFornEnd.TabIndex:=0;
  Ts_CurvaABCEnderecamentos.TabVisible:=False;
  Bt_CurvaABCEndDistrEndereco.Visible:=False;
  Refresh;

  EdtCurvaABCEndTotalProc.Value:=0;
  EdtCurvaABCEndLimiteCurvaA.SetFocus;

  // Lista de Preco ============================================================
  EdtCurvaABCEndCodLista.Text:=sgCodListaPrePadrao;
  EdtCurvaABCEndCodListaExit(Self);

  // Busca Valores da Curva ABC ================================================
  MySql:=' select t.des_aux, t.cod_aux'+
         ' from tab_auxiliar t'+
         ' where t.tip_aux=2'+
         ' order by t.des_aux';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='1' Then
     EdtCurvaABCEndLimiteCurvaA.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='2' Then
     EdtCurvaABCEndLimiteCurvaB.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='3' Then
     EdtCurvaABCEndLimiteCurvaC.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='4' Then
     EdtCurvaABCEndLimiteCurvaD.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='5' Then
     EdtCurvaABCEndLimiteCurvaE.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;

  // Inicializa Client para Produtos ===========================================
  try
    DMVirtual.CDS_V_Produtos.CreateDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  Except
    DMVirtual.CDS_V_Produtos.EmptyDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  End;

  // Inicializa Client's para Grupos e SubGrupos ===============================
  try
    DMVirtual.CDS_V_GruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  Except
    DMVirtual.CDS_V_GruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_SubGruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  Except
    DMVirtual.CDS_V_SubGruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  End;

  // Inicializa Client de Fornecedores =========================================
  Try
    DMVirtual.CDS_V_Fornecedores.CreateDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  Except
    DMVirtual.CDS_V_Fornecedores.EmptyDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  End;
  MontaSelectFornecedores;

  // Inicializa Client de Aplicaes ===========================================
  Try
    DMVirtual.CDS_V_Aplicacao.CreateDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  Except
    DMVirtual.CDS_V_Aplicacao.EmptyDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  End;

// OdirApagar BuscaEnderecamentos - 09/06/2017
//  // Busca Enderecamentos ======================================================
//  BuscaEnderecamentos;

  // Inicializa Datas ==========================================================
  DecodeDate(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), wgAnoH, wgMesH, wgDiaH);
  DtEdt_CurvaABCEndInicio.Date:=EncodeDate(wgAnoH-1, wgMesH, 1);
  DtEdt_CurvaABCEndFim.Date:=EncodeDate(wgAnoH, wgMesH, 1);
  DtEdt_CurvaABCEndFim.Date:=DtEdt_CurvaABCEndFim.Date-1;
  
  // Monta Mix de Prodtuos por Loja ============================================
  MySql:=' Select co.cod_filial, co.razao_social'+
         ' From EMP_CONEXOES co'+
         ' Where (co.ind_ativo=''SIM'' or co.cod_filial=''99'')'+
         ' And not exists (Select 1'+
         '                 From EMP_MIX_PRODUTOS mp'+
         '                 Where mp.cod_loja=co.cod_filial)';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    MySql:=' Insert Into EMP_MIX_PRODUTOS'+
           ' (COD_LOJA, IND_CURVA_A, IND_CURVA_B, IND_CURVA_C, IND_CURVA_D, IND_CURVA_E, USU_INCLUI, DTA_INCLUI)'+
           ' Values ('+
           QuotedStr(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Filial').AsString)+', '+
           QuotedStr('SIM')+', '+
           QuotedStr('SIM')+', '+
           QuotedStr('SIM')+', '+
           QuotedStr('SIM')+', '+
           QuotedStr('SIM')+', '+
           QuotedStr(Cod_Usuario)+
           ', Current_Date)';
    DMBelShop.SQLC.Execute(MySql, nil, nil);
           
    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;

  If DMVirtual.CDS_V_Mix_Prod.Active Then
   DMVirtual.CDS_V_Mix_Prod.Close;
     
  DMVirtual.CDS_V_Mix_Prod.CreateDataSet;
  DMVirtual.CDS_V_Mix_Prod.Open;
  
  MySql:=' Select co.cod_filial, co.razao_social,'+
         ' mp.ind_curva_a, mp.ind_curva_b, mp.ind_curva_c, mp.ind_curva_d, mp.ind_curva_e'+
         ' From emp_conexoes co, emp_mix_produtos mp'+
         ' Where co.cod_filial=mp.cod_loja'+
         ' Order By co.cod_filial';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    DMVirtual.CDS_V_Mix_Prod.Append;
    DMVirtual.CDS_V_Mix_ProdCOD_LOJA.AsString:=
                   DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Filial').AsString;
    DMVirtual.CDS_V_Mix_ProdRAZAO_SOCIAL.AsString:=
                 DMBelShop.CDS_BuscaRapida.FieldByName('Razao_Social').AsString;
    DMVirtual.CDS_V_Mix_ProdIND_CURVA_A.AsString:=
                  DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_A').AsString;
    DMVirtual.CDS_V_Mix_ProdIND_CURVA_B.AsString:=
                  DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_B').AsString;
    DMVirtual.CDS_V_Mix_ProdIND_CURVA_C.AsString:=
                  DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_C').AsString;
    DMVirtual.CDS_V_Mix_ProdIND_CURVA_D.AsString:=
                  DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_D').AsString;
    DMVirtual.CDS_V_Mix_ProdIND_CURVA_E.AsString:=
                  DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Curva_E').AsString;
    DMVirtual.CDS_V_Mix_Prod.Post;

    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;
  DMVirtual.CDS_V_Mix_Prod.First;

  //============================================================================
  // PageControl de Filtros - INICIO ===========================================
  //============================================================================
  //-----------------------------------------------------------------
  // Filtro de Fornecedores -----------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFornecedor.Visible:=True;
  // Curva ABC no Fornecedor
  Painel_FiltroOC.Visible:=False;
  // Obs para Utilizao no Movto de Comprovantes
  Label_MovtoComprovForn.Visible:=False;
  Label_MovtoComprovForn.Top:=Painel_FiltroOC.Top;

  //-----------------------------------------------------------------
  // Filtro de Produtos ---------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroProdutos.TabVisible:=True;
  // Filtor nao Produtos de No Compra
  Painel_FiltroNaoCompra.Visible:=False;

  // Filtro para Busca Pelo Nome <<========================
  // Colocar na TabSheet do Fornecedor <<========================
  Gb_CalculoFiltroNome.Parent:=TS_FiltroProdutos;
  Gb_CalculoFiltroNome.Visible:=True;
  EdtCalculoFiltroNome1.Clear;
  EdtCalculoFiltroNome2.Clear;
  EdtCalculoFiltroNome3.Clear;
  EdtCalculoFiltroNome4.Clear;

  //-----------------------------------------------------------------
  // Filtro de Grupos e SubGrupos -----------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupos.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Aplicaes dos Produtos ------------------------------
  //-----------------------------------------------------------------
  TS_FiltroAplicacao.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Familia de Preos ------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFamiliaPreco.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Grupos ST --------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupoST.TabVisible:=False;

  //-----------------------------------------------------------------
  // Grupo de Comprovantes ------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroComprovantes.TabVisible:=False;

  //-----------------------------------------------------------------
  // Posiciona o PC_Filtros em seu Parent ---------------------------
  //-----------------------------------------------------------------
  PC_Filtros.Parent:=Ts_CurvaABCFiltros;
  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);
  //============================================================================
  // PageControl de Filtros - FIM ==============================================
  //============================================================================

end;

procedure TFrmBelShop.Bt_PlanFinanFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.SubMenuFinanComprPlanFinanceiraClick(Sender: TObject);
Var
  MySql: String;
  i: Integer;
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Permisses de Visualizao ================================================
  PermissaoVisual(Ts_FinanComprPlanFinan);

  SelecionaTabSheet(Ts_FinanComprPlanFinan);
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanRelacao;
  Ts_FinanComprPlanFinanManutComprov.TabVisible:=False;
  Ts_FinanComprPlanFinanPlanilhaFinanceira.TabVisible:=False;
  Ts_FinanComprPlanFinanDemonsResultados.TabVisible:=False;

  // Conecta MPMS ============================================================
  If Not ConectaMPMS Then
  Begin
    If sgCodLojaUnica='' Then
     msg('Impossvel Continuar...'+cr+'Banco de Dados MPMS (Administrao)'+cr+cr+'No CONECTADO !!','A')
    Else
     msg('Impossvel Continuar...'+cr+'Banco de Dados SIDICOM'+cr+cr+'No CONECTADO !!','A');
    Application.Terminate;
    Exit;
  End;

  If msg('Deseja Altualizar Comprovantes NOVOS e/ou ALTERADOS ???','C')=1 Then
  Begin
    OdirPanApres.Caption:='AGUARDE !! Atualizando Comprovantes Novos e Alterados...';
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
    OdirPanApres.Visible:=True;
    Refresh;
    
    // Monta Transacao =========================================================
    TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);
    Try
      Screen.Cursor:=crAppStart;
      DateSeparator:='.';
      DecimalSeparator:='.';

      // Busca Comprovantes ====================================================
      MySql:='select c.codcomprovante, c.nomecomprovante, c.compdesativado'+
             ' from comprv c'+
             ' order by c.nomecomprovante';
      IBQ_MPMS.Close;
      IBQ_MPMS.SQL.Clear;
      IBQ_MPMS.SQL.Add(MySql);
      IBQ_MPMS.Open;

      While Not IBQ_MPMS.Eof do
      Begin
        Refresh;

        // Busca Grupo Financeiro ==============================================
        MySql:='Select COD_GR_FINAN'+
               ' From FIN_GR_FINANCEIRO'+
               ' Where DES_PESQUISA=substring('+QuotedStr(Trim(
                             IBQ_MPMS.FieldByName('nomecomprovante').AsString))+
               '             from 1 for char_length(des_pesquisa))';
        DMBelShop.CDS_BuscaRapida.Close;
        DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
        DMBelShop.CDS_BuscaRapida.Open;

        If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('COD_GR_FINAN').AsString)='' Then
         i:=9999
        Else
         i:=DMBelShop.CDS_BuscaRapida.FieldByName('COD_GR_FINAN').AsInteger;

        DMBelShop.CDS_BuscaRapida.Close;

        // Trata Comprovante ===================================================
        MySql:='select c.cod_comprov'+
               ' from FIN_COMPROVANTES c'+
               ' Where c.cod_comprov='+
               QuotedStr(IBQ_MPMS.FieldByName('codcomprovante').AsString);
        DMBelShop.CDS_Busca.Close;
        DMBelShop.SDS_Busca.CommandText:=MySql;
        DMBelShop.CDS_Busca.Open;

        If Trim(DMBelShop.CDS_Busca.FieldByName('cod_comprov').AsString)='' Then
         Begin
           MySql:='Insert Into FIN_COMPROVANTES ('+
                  ' COD_COMPROV, DES_COMPROV, COD_GR_FINAN, IND_PLANILHA,'+
                  ' IND_SOMA_GRUPO, IND_ATIVO, USU_INCLUI)'+

                  ' Values ('+
                  QuotedStr(IBQ_MPMS.FieldByName('CODCOMPROVANTE').AsString)+', '+
                  QuotedStr(Trim(IBQ_MPMS.FieldByName('NOMECOMPROVANTE').AsString))+', '+
                  IntToStr(i)+', '+QuotedStr('SIM')+', '+QuotedStr('SIM')+', '+
                  QuotedStr('SIM')+', '+Cod_Usuario+')';
         End
        Else // If Trim(DMBelShop.CDS_Busca.FieldByName('cod_comprov').AsString)='' Then
         Begin
           MySql:='Update FIN_COMPROVANTES'+
                  ' Set DES_COMPROV='+
                  QuotedStr(Trim(IBQ_MPMS.FieldByName('NOMECOMPROVANTE').AsString));

                  If i<>9999 Then
                  MySql:=MySql+', COD_GR_FINAN='+IntToStr(i);

                  MySql:=MySql+' Where COD_COMPROV='+
                  QuotedStr(IBQ_MPMS.FieldByName('CODCOMPROVANTE').AsString);
         End; // If Trim(DMBelShop.IBQ_Busca.FieldByName('cod_comprov').AsString)='' Then
        DMBelShop.CDS_Busca.Close;

        DMBelShop.SQLC.Execute(MySql, nil, nil);

        IBQ_MPMS.Next;
      End; // While Not IBQ_MPMS.Eof do
      IBQ_MPMS.Close;

      // Fecha Transacao =======================================================
      DMBelShop.SQLC.Commit(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;
      OdirPanApres.Visible:=False;

    Except
      on e : Exception do
      Begin
        IBQ_MPMS.Close;
        DMBelShop.SQLC.Rollback(TD);

        DateSeparator:='/';
        DecimalSeparator:=',';
        Screen.Cursor:=crDefault;
        OdirPanApres.Visible:=False;

        MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      End; // on e : Exception do
    End; // Try

    // Desconecta Empresa ======================================================
    ConexaoEmpIndividual('IBDB_MPMS', 'IBT_MPMS', 'F');
  End; // If msg('Deseja Altualizar Comprovantes NOVOS e/ou ALTERADOS ???','C')=1 Then

  // Apresenta Comprovantes ====================================================
  DMBelShop.CDS_Comprovantes.Close;
  DMBelShop.CDS_Comprovantes.IndexFieldNames:='';
  DMBelShop.CDS_Comprovantes.Open;
  THackDBGrid(Dbg_FinanComprovantes).FixedCols:=3;
  Dbg_FinanComprovantes.SetFocus;

end;

procedure TFrmBelShop.PC_FinanComprPlanFinanChange(Sender: TObject);
begin

  CorSelecaoTabSheet(PC_FinanComprPlanFinan);

  If (PC_FinanComprPlanFinan.ActivePage=Ts_FinanComprPlanFinanRelacao) And (Ts_FinanComprPlanFinanRelacao.CanFocus) Then
  Begin
    Bt_FinanComprovantesDetalhar.Enabled:=True;
    Bt_FinanComprovantesFechar.Enabled:=True;
    Label58.Visible:=True;
    EdtFinanComprovantesLocalizar.Visible:=True;

    Dbg_FinanComprovantes.SetFocus;
  End;

  If (PC_FinanComprPlanFinan.ActivePage=Ts_FinanComprPlanFinanManutComprov) And (Ts_FinanComprPlanFinanManutComprov.CanFocus) Then
   Dbe_FinanManutComprovCodGrFinanceiro.SetFocus;

  If (PC_FinanComprPlanFinan.ActivePage=Ts_FinanComprPlanFinanManutGrFinanceiro) And (Ts_FinanComprPlanFinanManutGrFinanceiro.CanFocus) Then
  Begin
    Bt_FinanComprovantesDetalhar.Enabled:=False;
    Bt_FinanComprovantesFechar.Enabled:=False;
    Label58.Visible:=False;
    EdtFinanComprovantesLocalizar.Visible:=False;

    Dbg_FinanGrFinanceiro.SetFocus;
  End;

  // Apresenta TabSheet de Demonstrativo de Resultados
  If ((PC_FinanComprPlanFinan.ActivePage<>Ts_FinanComprPlanFinanDemonsResultados) And (Not Ts_FinanComprPlanFinanDemonsResultados.CanFocus)) Then
   Ts_FinanComprPlanFinanDemonsResultados.TabVisible:=False;
  
end;

procedure TFrmBelShop.Dbg_FinanComprovantesColEnter(Sender: TObject);
begin
                                       
  if (THackDBGrid(Dbg_FinanComprovantes).SelectedIndex = 0) Or
     (THackDBGrid(Dbg_FinanComprovantes).SelectedIndex = 1) then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanComprovantes).LeftCol := 3; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanComprovantes).SelectedIndex := 2; // Index da 1 Coluna No Fixada Sem Contar Indicador
  end;
end;

procedure TFrmBelShop.Dbg_FinanComprovantesTitleClick(Column: TColumn);
begin
  If (OrderGrid='') or (OrderGrid='Crescente') Then
   Begin
     OrderByGrid(DMBelShop.CDS_Comprovantes, Dbg_FinanComprovantes, Column.FieldName, False);
     OrderGrid:='Decrescente';
   End
  Else
   Begin
     OrderByGrid(DMBelShop.CDS_Comprovantes, Dbg_FinanComprovantes, Column.FieldName, True);
     OrderGrid:='Crescente';
   End;
end;

procedure TFrmBelShop.EdtFinanComprovantesLocalizarChange(Sender: TObject);
begin
  If DMBelShop.CDS_Comprovantes.Active Then
  Begin
    Try
      StrToInt(EdtFinanComprovantesLocalizar.Text);
      DMBelShop.CDS_Comprovantes.Locate('COD_COMPROV',EdtFinanComprovantesLocalizar.Text,[]);
    Except
      DMBelShop.CDS_Comprovantes.Locate('DES_COMPROV',EdtFinanComprovantesLocalizar.Text,[loPartialKey]);
    End;
  End; // If DMBelShop.CDS_Comprovantes.Active Then

end;

procedure TFrmBelShop.Bt_FinanComprovantesDetalharClick(Sender: TObject);
Var
  MySql: String;
begin

  If DMBelShop.CDS_Comprovantes.IsEmpty Then
  Begin
    msg('SEM Comprovante a DETALHAR !!' ,'A');
    Exit;
  End;

  Screen.Cursor:=crAppStart;

  // Edita =====================================================================
  MySql:='select *'+
         ' from fin_comprovantes'+
         ' Where cod_comprov='+
         QuotedStr(DMBelShop.CDS_ComprovantesCOD_COMPROV.AsString);
  DMBelShop.CDS_Comprovante.Close;
  DMBelShop.SDS_Comprovante.CommandText:=MySql;
  DMBelShop.CDS_Comprovante.Open;

  DMBelShop.CDS_Comprovante.Edit;

  EdtFinanManutComprovDesGrFinanceiro.Text:=
                                DMBelShop.CDS_ComprovantesDES_GR_FINAN.AsString;

  Ckb_FinanManutComprovPlanilha.Checked:=
                          DMBelShop.CDS_ComprovantesIND_PLANILHA.AsString='SIM';
  Ckb_FinanManutComprovPlanilhaClick(Self);

  Ckb_FinanManutComprovSomaGrupo.Checked:=
                        DMBelShop.CDS_ComprovantesIND_SOMA_GRUPO.AsString='SIM';
  Ckb_FinanManutComprovSomaGrupoClick(Self);

  Ckb_FinanManutComprovAtivo.Checked:=
                             DMBelShop.CDS_ComprovantesIND_ATIVO.AsString='SIM';
  Ckb_FinanManutComprovAtivoClick(Self);

  // Guarda Codigo do Comprovante ==============================================
  sgCodigo:=DMBelShop.CDS_ComprovantesCOD_COMPROV.AsString;

  Dbe_FinanManutComprovFormulaExit(Self);

  // Abre TabSheet de Detalhamento =============================================
  Ts_FinanComprPlanFinanManutComprov.TabVisible:=True;
  Ts_FinanComprPlanFinanRelacao.TabVisible:=False;
  Ts_FinanComprPlanFinanManutGrFinanceiro.TabVisible:=False;

  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanManutComprov;
  PC_FinanComprPlanFinanChange(Self);

  If StrToInt(sgCodigo)>9000 Then
   Begin
     Dbe_FinanManutComprovDesComprovante.ReadOnly:=False;
     Dbe_FinanManutComprovDesComprovante.Color:=clWindow;
   End
  Else
   Begin
     Dbe_FinanManutComprovDesComprovante.ReadOnly:=True;
     Dbe_FinanManutComprovDesComprovante.Color:=$00ECECFF;
   End; // If StrToInt(sgCodigo)>9000 Then
  Dbe_FinanManutComprovCodGrFinanceiro.SetFocus;

  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.Bt_FinanManutComprovVoltarClick(Sender: TObject);
begin
  DMBelShop.CDS_Comprovante.CancelUpdates;

  Ts_FinanComprPlanFinanRelacao.TabVisible:=True;
  Ts_FinanComprPlanFinanManutGrFinanceiro.TabVisible:=True;
  Ts_FinanComprPlanFinanManutComprov.TabVisible:=False;

  THackDBGrid(Dbg_FinanComprovantes).FixedCols:=3;

  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanRelacao;
  PC_FinanComprPlanFinanChange(Self);
  DMBelShop.CDS_Comprovantes.Locate('COD_COMPROV',sgCodigo,[loCaseInsensitive]);
  Dbg_FinanComprovantes.SetFocus;
end;

procedure TFrmBelShop.Ckb_FinanManutComprovPlanilhaClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanManutComprovPlanilha);
end;

procedure TFrmBelShop.Ckb_FinanManutComprovAtivoClick(Sender: TObject);
begin

  If DMBelShop.CDS_ComprovanteCOD_COMPROV.AsInteger>=9990 Then
  Begin
    msg('Este Comprovante S Pode ser'+cr+cr+'Desativado Pelos ODIR !!','A');
    Ckb_FinanManutComprovAtivo.Checked:=True;
    Exit;
  End; // If DMBelShop.CDS_ComprovanteCOD_COMPROV.AsInteger>=9990 Then

  AcertaCkb_SN(Ckb_FinanManutComprovAtivo);

  If Not Ckb_FinanManutComprovAtivo.Checked Then
   Begin
     Ckb_FinanManutComprovPlanilha.Enabled:=False;
     Ckb_FinanManutComprovPlanilha.Checked:=False;
     Ckb_FinanManutComprovPlanilhaClick(Self);

     Ckb_FinanManutComprovSomaGrupo.Enabled:=False;
     Ckb_FinanManutComprovSomaGrupo.Checked:=False;
     Ckb_FinanManutComprovSomaGrupoClick(Self);

     Dbe_FinanManutComprovFormula.Enabled:=False;
     Dbe_FinanManutComprovFormula.Color:=$00ECECFF;

     Dbe_FinanManutComprovFormulaNumDecimais.Enabled:=False;
     Dbe_FinanManutComprovFormulaNumDecimais.Color:=$00ECECFF;

     Dbe_FinanManutComprovSoma.Enabled:=False;
     Dbe_FinanManutComprovSoma.Color:=$00ECECFF;

     Dbe_FinanManutComprovSubtrai.Enabled:=False;
     Dbe_FinanManutComprovSubtrai.Color:=$00ECECFF;
   End // If Not Ckb_FinanManutComprovAtivo.Checked Then
  Else
   Begin
     Ckb_FinanManutComprovPlanilha.Enabled:=True;
     Ckb_FinanManutComprovPlanilhaClick(Self);

     Ckb_FinanManutComprovSomaGrupo.Enabled:=True;
     Ckb_FinanManutComprovSomaGrupoClick(Self);

     Dbe_FinanManutComprovFormula.Enabled:=True;
     Dbe_FinanManutComprovFormula.Color:=clWindow;

     Dbe_FinanManutComprovFormulaNumDecimais.Enabled:=True;
     Dbe_FinanManutComprovFormulaNumDecimais.Color:=clWindow;

     Dbe_FinanManutComprovSoma.Enabled:=True;
     Dbe_FinanManutComprovSoma.Color:=clWindow;

     Dbe_FinanManutComprovSubtrai.Enabled:=True;
     Dbe_FinanManutComprovSubtrai.Color:=clWindow;
   End; // If Not Ckb_FinanManutComprovAtivo.Checked Then

end;

procedure TFrmBelShop.Bt_FinanManutComprovSalvarClick(Sender: TObject);
Var
  MySql: String;
  s: String;
begin

  If Trim(DMBelShop.CDS_ComprovanteDES_COMPROV.AsString)='' Then
  Begin
    msg('Favor Informar a Descrio do Comprovante!!','A');
    Dbe_FinanManutComprovDesComprovante.SetFocus;
    Exit;
  End;

  If Trim(EdtFinanManutComprovDesGrFinanceiro.Text)='' Then
  Begin
    msg('Favor Informar o Grupo Financeiro !!','A');
    Dbe_FinanManutComprovCodGrFinanceiro.SetFocus;
    Exit;
  End;

  // Avisa Recaldulo da Planilha Financeira ====================================
  If (DMVirtual.CDS_V_PlanFinanceira.Active) Or (Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty) Then
  Begin
    msg('Se Voc Alterou o Comprovante'+cr+'Recalcule a Planilha para'+cr+'Obter o Novo Resultado...','A');
  End;

  
  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    If DMBelShop.CDS_Comprovante.State=dsEdit Then
    Begin
      MySql:='Update FIN_COMPROVANTES'+
             ' Set COD_GR_FINAN='+
             DMBelShop.CDS_ComprovanteCOD_GR_FINAN.AsString+
             ', DES_COMPROV='+
             QuotedStr(DMBelShop.CDS_ComprovanteDES_COMPROV.AsString)+
             ', DES_FORMULA='+
             QuotedStr(DMBelShop.CDS_ComprovanteDES_FORMULA.AsString)+
             ', NUM_DECIMAIS='+
             QuotedStr(DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsString)+
             ', SOMAR_EM='+
             QuotedStr(DMBelShop.CDS_ComprovanteSOMAR_EM.AsString)+
             ', SUBTRAIR_DE='+
             QuotedStr(DMBelShop.CDS_ComprovanteSUBTRAIR_DE.AsString)+
             ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
             ', DTA_ALTERA=Current_Date';

             s:='NAO';
             If Ckb_FinanManutComprovPlanilha.Checked Then
              s:='SIM';
             MySql:=MySql+', IND_PLANILHA='+QuotedStr(s);

             s:='NAO';
             If Ckb_FinanManutComprovSomaGrupo.Checked Then
              s:='SIM';
             MySql:=MySql+', IND_SOMA_GRUPO='+QuotedStr(s);

             s:='NAO';
             If Ckb_FinanManutComprovAtivo.Checked Then
              s:='SIM';
             MySql:=MySql+', IND_ATIVO='+QuotedStr(s);

      MySql:=MySql+' Where COD_COMPROV='+QuotedStr(
                   DMBelShop.CDS_ComprovanteCOD_COMPROV.AsString);
    End; // If DMBelShop.CDS_Comprovante.State=dsEdit Then

    If DMBelShop.CDS_Comprovante.State=dsInsert Then
    Begin
      MySql:='Insert Into FIN_COMPROVANTES ('+
              ' COD_COMPROV, DES_COMPROV, COD_GR_FINAN, IND_PLANILHA,'+
              ' IND_SOMA_GRUPO, IND_ATIVO, DES_FORMULA, NUM_DECIMAIS,'+
              ' SOMAR_EM, SUBTRAIR_DE, USU_INCLUI, DTA_INCLUI)'+

              ' Values ('+
              QuotedStr(sgCodigo)+', '+
              QuotedStr(DMBelShop.CDS_ComprovanteDES_COMPROV.AsString)+', '+
              QuotedStr(DMBelShop.CDS_ComprovanteCOD_GR_FINAN.AsString)+', ';

               s:='NAO';
              If Ckb_FinanManutComprovPlanilha.Checked Then
               s:='SIM';
              MySql:=MySql+QuotedStr(s)+', ';

              s:='NAO';
              If Ckb_FinanManutComprovSomaGrupo.Checked Then
               s:='SIM';
              MySql:=MySql+QuotedStr(s)+', ';

              s:='NAO';
              If Ckb_FinanManutComprovAtivo.Checked Then
               s:='SIM';
              MySql:=MySql+QuotedStr(s)+', ';

      MySql:=MySql+QuotedStr(DMBelShop.CDS_ComprovanteDES_FORMULA.AsString)+', '+
                   QuotedStr(DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsString)+', '+
                   QuotedStr(DMBelShop.CDS_ComprovanteSOMAR_EM.AsString)+', '+
                   QuotedStr(DMBelShop.CDS_ComprovanteSUBTRAIR_DE.AsString)+', '+
                   QuotedStr(Cod_Usuario)+', Current_Date)';
    End; // If DMBelShop.CDS_Comprovante.State=dsInsert Then
    DMBelShop.SQLC.Execute(MySql, nil, nil);

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

  DMBelShop.CDS_Comprovantes.Close;
  DMBelShop.CDS_Comprovantes.IndexFieldNames:='';
  DMBelShop.CDS_Comprovantes.Open;

  Bt_FinanManutComprovVoltarClick(Self);

end;

procedure TFrmBelShop.Bt_FinanManutComprovBuscaGrFinanceiroClick(Sender: TObject);
Var
  MySql: String;
Begin
  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:='select DES_GR_FINAN, COD_GR_FINAN'+
         ' from FIN_GR_FINANCEIRO'+
         ' order by DES_GR_FINAN';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('COD_GR_FINAN').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    DMBelShop.CDS_Pesquisa.Close;
    FreeAndNil(FrmPesquisa);
    Dbe_FinanManutComprovCodGrFinanceiro.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='DES_GR_FINAN';
  FrmPesquisa.Campo_Codigo:='COD_GR_FINAN';
  FrmPesquisa.Campo_Descricao:='DES_GR_FINAN';
  FrmPesquisa.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
  Begin
    DMBelShop.CDS_ComprovanteCOD_GR_FINAN.AsString:=FrmPesquisa.EdtCodigo.Text;
    EdtFinanManutComprovDesGrFinanceiro.Text:=FrmPesquisa.EdtDescricao.Text;
    SelectNext(ActiveControl,True,True);
  End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.Dbe_FinanManutComprovCodGrFinanceiroExit(Sender: TObject);
Var
  MySql: String;
begin

  EdtFinanManutComprovDesGrFinanceiro.Clear;

  If DMBelShop.CDS_ComprovanteCOD_GR_FINAN.AsInteger<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Fornecedores =======================================================
    MySql:='select DES_GR_FINAN, COD_GR_FINAN'+
           ' from FIN_GR_FINANCEIRO'+
           ' where COD_GR_FINAN='+
           IntToStr(DMBelShop.CDS_ComprovanteCOD_GR_FINAN.AsInteger);
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    Screen.Cursor:=crDefault;

    If Trim(DMBelShop.CDS_Busca.FieldByName('COD_GR_FINAN').AsString)='' Then
    Begin
      msg('Grupo Financeiro NO Encontrado !!!', 'A');
      EdtFinanManutComprovDesGrFinanceiro.Clear;
      Dbe_FinanManutComprovCodGrFinanceiro.SetFocus;
      DMBelShop.CDS_Busca.Close;
      Exit;
    End;

    EdtFinanManutComprovDesGrFinanceiro.Text:=DMBelShop.CDS_Busca.FieldByName('Des_Gr_Finan').AsString;

    DMBelShop.CDS_Busca.Close;

  End;
end;

procedure TFrmBelShop.Ts_FinanComprPlanFinanManutGrFinanceiroExit(Sender: TObject);
Var
  i: Integer;
begin
  If (DMBelShop.CDS_Gr_Financeiro.State=dsEdit) or (DMBelShop.CDS_Gr_Financeiro.State=dsInsert) Then
   DMBelShop.CDS_Gr_Financeiro.CancelUpdates;

  DMBelShop.CDS_Gr_Financeiro.Close;

  // Retorna
  Bt_FinanGrFinanNovo.Enabled:=True;
  Bt_FinanGrFinanAlterar.Enabled:=True;
  Bt_FinanGrFinanExcluir.Enabled:=True;
  Bt_FinanGrFinanVoltar.Enabled:=True;
  Dbg_FinanGrFinanceiro.Enabled:=True;
  Pan_FinanGrFinan.Enabled:=False;
  Bt_FinanGrFinanSalvar.Enabled:=False;
  Bt_FinanGrFinanAbandonar.Enabled:=False;

  If Not DMBelShop.CDS_Comprovantes.IsEmpty Then
   i:=DMBelShop.CDS_ComprovantesCOD_COMPROV.AsInteger;

  DMBelShop.CDS_Comprovantes.Close;
  DMBelShop.CDS_Comprovantes.IndexFieldNames:='';
  DMBelShop.CDS_Comprovantes.Open;
  THackDBGrid(Dbg_FinanComprovantes).FixedCols:=3;

  If Not DMBelShop.CDS_Comprovantes.IsEmpty Then
   DMBelShop.CDS_Comprovantes.Locate('COD_COMPROV',i,[]);

end;

procedure TFrmBelShop.Ts_FinanComprPlanFinanManutGrFinanceiroEnter(Sender: TObject);
begin
  DMBelShop.CDS_Gr_Financeiro.Close;
  DMBelShop.CDS_Gr_Financeiro.IndexFieldNames:='';
  DMBelShop.CDS_Gr_Financeiro.Open;
end;

procedure TFrmBelShop.Btg_FinanGrupoFinanSalvarClick(Sender: TObject);
begin
  DMBelShop.CDS_Gr_Financeiro.ApplyUpdates(0);
end;

procedure TFrmBelShop.Bt_FinanGrFinanNovoClick(Sender: TObject);
Var
  MySql: String;
begin

  MySql:=' Select coalesce(max(f.COD_GR_FINAN)+1 ,1) Codigo'+
         ' from FIN_GR_FINANCEIRO f'+
         ' Where f.cod_gr_finan<9999';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;
  sgCodigo:=DMBelShop.CDS_Busca.FieldByName('Codigo').AsString;
  DMBelShop.CDS_Busca.Close;

  DMBelShop.CDS_Gr_Financeiro.Insert;
  DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString:=sgCodigo;
  DMBelShop.CDS_Gr_FinanceiroUSU_INCLUI.AsString:=Cod_Usuario;
  DMBelShop.CDS_Gr_FinanceiroDTA_INCLUI.AsDateTime:=
                               DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);

  Ckb_FinanGrFinanAtivo.Checked:=True;
  Ckb_FinanGrFinanAtivoClick(Self);
  
  Pan_FinanGrFinan.Enabled:=True;
  Bt_FinanGrFinanSalvar.Enabled:=True;
  Bt_FinanGrFinanAbandonar.Enabled:=True;
  Dbe_FinanGrFinanGrFinanceiro.SetFocus;

  Bt_FinanGrFinanNovo.Enabled:=False;
  Bt_FinanGrFinanAlterar.Enabled:=False;
  Bt_FinanGrFinanExcluir.Enabled:=False;
  Bt_FinanGrFinanVoltar.Enabled:=False;
  Dbg_FinanGrFinanceiro.Enabled:=False;

end;

procedure TFrmBelShop.Bt_FinanGrFinanAlterarClick(Sender: TObject);
begin
  Ckb_FinanGrFinanAtivo.Checked:=DMBelShop.CDS_Gr_FinanceiroIND_ATIVO.AsString='SIM';
  
  AcertaCkb_SN(Ckb_FinanGrFinanAtivo);

  sgCodigo:=DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString;

  DMBelShop.CDS_Gr_Financeiro.Edit;

  Pan_FinanGrFinan.Enabled:=True;
  Bt_FinanGrFinanSalvar.Enabled:=True;
  Bt_FinanGrFinanAbandonar.Enabled:=True;
  Dbe_FinanGrFinanGrFinanceiro.SetFocus;

  Bt_FinanGrFinanNovo.Enabled:=False;
  Bt_FinanGrFinanAlterar.Enabled:=False;
  Bt_FinanGrFinanExcluir.Enabled:=False;
  Bt_FinanGrFinanVoltar.Enabled:=False;
  Dbg_FinanGrFinanceiro.Enabled:=False;

end;

procedure TFrmBelShop.Bt_FinanGrFinanSalvarClick(Sender: TObject);
Var
  MySql: String;
  i: Integer;
  s: String;
begin

  If Dbe_FinanGrFinanGrFinanceiro.Text='' Then
  Begin
    msg('Favor Informar a Descrio'+cr+cr+'do Grupo Financeiro !!','A');
    Dbe_FinanGrFinanGrFinanceiro.SetFocus;
    Exit;
  End;

  If Dbe_FinanGrFinanAbrevPesquisa.Text='' Then
  Begin
    msg('Favor Informar a Abreviatuara'+cr+cr+'para Pesquisa !!','A');
    Dbe_FinanGrFinanAbrevPesquisa.SetFocus;
    Exit;
  End;

  Try
    If DMBelShop.CDS_Gr_FinanceiroNUM_ORDEM.AsInteger=0 Then
    Begin
      msg('Favor Informar o Nmero da Ordem'+cr+'para Apresentao na'+cr+'Planilha Financeira !!','A');
      Dbe_FinanGrFinanNumOrdem.SetFocus;
      Exit;
    End;
  Except
    If DMBelShop.CDS_Gr_FinanceiroNUM_ORDEM.AsInteger=0 Then
    Begin
      msg('Nmero da Ordem Invlido !!','A');
      Dbe_FinanGrFinanNumOrdem.SetFocus;
      Exit;
    End;
  End;

  // Avisa Recaldulo da Planilha Financeira ====================================
  If (DMVirtual.CDS_V_PlanFinanceira.Active) Or (Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty) Then
  Begin
    msg('Se Voc Alterou o Grupo Financeiro'+cr+'Recalcule a Planilha para'+cr+'Obter o Novo Resultado...','A');
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Acerta Ordem de Apresentacao na Planilha Financeira ----------
    MySql:='select COD_GR_FINAN'+
           ' from FIN_GR_FINANCEIRO'+
           ' Where COD_GR_FINAN<9999'+
           ' and COD_GR_FINAN<>'+DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString+
           ' order by num_ordem';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    i:=0;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin

      Inc(i);

      If i=DMBelShop.CDS_Gr_FinanceiroNUM_ORDEM.AsInteger Then
       Inc(i);

      MySql:='Update FIN_GR_FINANCEIRO'+
             ' Set NUM_ORDEM='+IntToStr(i)+
             ' Where COD_GR_FINAN='+
             DMBelShop.CDS_Busca.FieldByName('COD_GR_FINAN').AsString;
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    DMBelShop.CDS_Busca.Close;

    If DMBelShop.CDS_Gr_Financeiro.State=dsInsert Then
    Begin
      MySql:='Insert Into FIN_GR_FINANCEIRO ('+
             ' COD_GR_FINAN, DES_GR_FINAN, DES_PESQUISA, NUM_ORDEM,'+
             ' IND_ATIVO, USU_INCLUI, DTA_INCLUI)'+
             ' Values ('+
             QuotedStr(DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString)+', '+
             QuotedStr(DMBelShop.CDS_Gr_FinanceiroDES_GR_FINAN.AsString)+', '+
             QuotedStr(DMBelShop.CDS_Gr_FinanceiroDES_PESQUISA.AsString)+', '+
             QuotedStr(DMBelShop.CDS_Gr_FinanceiroNUM_ORDEM.AsString)+', '+
             QuotedStr('SIM')+', '+QuotedStr(Cod_Usuario)+', Current_Date)';
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End;

    If DMBelShop.CDS_Gr_Financeiro.State=dsEdit Then
    Begin
      MySql:='Update FIN_GR_FINANCEIRO '+
             ' Set DES_GR_FINAN='+
             QuotedStr(DMBelShop.CDS_Gr_FinanceiroDES_GR_FINAN.AsString)+
             ', DES_PESQUISA='+
             QuotedStr(DMBelShop.CDS_Gr_FinanceiroDES_PESQUISA.AsString)+
             ', NUM_ORDEM='+
             QuotedStr(DMBelShop.CDS_Gr_FinanceiroNUM_ORDEM.AsString);

             s:='NAO';
             If Ckb_FinanGrFinanAtivo.Checked Then
              s:='SIM';
             MySql:=MySql+', IND_ATIVO='+QuotedStr(s);

             MySql:=MySql+', USU_ALTERA='+QuotedStr(Cod_Usuario)+
                          ', DTA_ALTERA=Current_Date'+
                          ' Where COD_GR_FINAN='+
                          QuotedStr(DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString);
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End;

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

  Bt_FinanGrFinanAbandonarClick(Self);

end;

procedure TFrmBelShop.Dbg_FinanGrFinanceiroTitleClick(Column: TColumn);
begin
  If (OrderGrid='') or (OrderGrid='Crescente') Then
   Begin
     OrderByGrid(DMBelShop.CDS_Gr_Financeiro, Dbg_FinanGrFinanceiro, Column.FieldName, False);
     OrderGrid:='Decrescente';
   End
  Else
   Begin
     OrderByGrid(DMBelShop.CDS_Gr_Financeiro, Dbg_FinanGrFinanceiro, Column.FieldName, True);
     OrderGrid:='Crescente';
   End

end;

procedure TFrmBelShop.Bt_FinanGrFinanAbandonarClick(Sender: TObject);
begin
  If (DMBelShop.CDS_Gr_Financeiro.State=dsEdit) or (DMBelShop.CDS_Gr_Financeiro.State=dsInsert) Then
   DMBelShop.CDS_Gr_Financeiro.CancelUpdates;

  DMBelShop.CDS_Gr_Financeiro.Close;
  DMBelShop.CDS_Gr_Financeiro.IndexFieldNames:='';
  DMBelShop.CDS_Gr_Financeiro.Open;

  If sgCodigo<>'' Then
   DMBelShop.CDS_Gr_Financeiro.Locate('COD_GR_FINAN',sgCodigo,[]);

  // Retorna
  Bt_FinanGrFinanNovo.Enabled:=True;
  Bt_FinanGrFinanAlterar.Enabled:=True;
  Bt_FinanGrFinanExcluir.Enabled:=True;
  Bt_FinanGrFinanVoltar.Enabled:=True;
  Dbg_FinanGrFinanceiro.Enabled:=True;

  Dbg_FinanGrFinanceiro.SetFocus;

  Pan_FinanGrFinan.Enabled:=False;
  Bt_FinanGrFinanSalvar.Enabled:=False;
  Bt_FinanGrFinanAbandonar.Enabled:=False;

end;

procedure TFrmBelShop.Dbg_FinanGrFinanceiroDblClick(Sender: TObject);
begin
  Bt_FinanGrFinanAlterarClick(Self);
end;

procedure TFrmBelShop.Bt_FinanGrFinanExcluirClick(Sender: TObject);
Var
  MySql: String;
  i: Integer;
begin
  If msg('Deseja Realmente EXCLUIR o Grupo Selecionado ??','C')=2 Then
  Begin
    Dbg_FinanGrFinanceiro.SetFocus;
    Exit;
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    If Not DMBelShop.CDS_Gr_Financeiro.IsEmpty Then
    Begin
      MySql:='Delete From FIN_GR_FINANCEIRO'+
             ' Where COD_GR_FINAN='+
             DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString;
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End;

    // Acerta Ordem de Apresentacao na Planilha Financeira ----------
    MySql:='select COD_GR_FINAN'+
           ' from FIN_GR_FINANCEIRO'+
           ' Where COD_GR_FINAN<9999'+
           ' and COD_GR_FINAN<>'+
           DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString+
           ' order by num_ordem';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    i:=0;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin

      Inc(i);

      MySql:='Update FIN_GR_FINANCEIRO'+
             ' Set NUM_ORDEM='+IntToStr(i)+
             ' Where COD_GR_FINAN='+
             DMBelShop.CDS_Busca.FieldByName('COD_GR_FINAN').AsString;
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    DMBelShop.CDS_Busca.Close;

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

    DMBelShop.CDS_Gr_Financeiro.Close;
    DMBelShop.CDS_Gr_Financeiro.IndexFieldNames:='';
    DMBelShop.CDS_Gr_Financeiro.Open;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

end;

procedure TFrmBelShop.Bt_FinanComprPlanFinanPlanilhaClick(Sender: TObject);
begin
  // Abre TabSheet da Planilha Financeira =============================================
  Ts_FinanComprPlanFinanPlanilhaFinanceira.TabVisible:=True;
  Ts_FinanComprPlanFinanRelacao.TabVisible:=False;
  Ts_FinanComprPlanFinanManutGrFinanceiro.TabVisible:=False;

  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanPlanilhaFinanceira;
  PC_FinanComprPlanFinanChange(Self);

  Dbg_FinanPlanFinanceira.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanPlanFinanceiraVoltarClick(Sender: TObject);
begin
  // Abre TabSheet da Planilha Financeira =====================================
  Ts_FinanComprPlanFinanManutGrFinanceiro.TabVisible:=True;
  Ts_FinanComprPlanFinanRelacao.TabVisible:=True;
  Ts_FinanComprPlanFinanPlanilhaFinanceira.TabVisible:=False;

  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanRelacao;
  PC_FinanComprPlanFinanChange(Self);

end;

procedure TFrmBelShop.Dbg_FinanPlanFinanceiraColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 0) Or
     (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 1) Or
     (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 2) then
  begin
    THackDBGrid(Dbg_FinanPlanFinanceira).LeftCol:=4;
    THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex:=3;
    Dbg_FinanPlanFinanceira.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanPlanFinanceiraDrawColumnCell(Sender: TObject;
          const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin

  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanPlanFinanceiraColEnter(Self);

  // Acerta Apresentacao --------------------------------------------
  if not (gdSelected in State) Then
  Begin
    if DMVirtual.CDS_V_PlanFinanceiraTipo.AsString<>'' Then
    Begin
      Dbg_FinanPlanFinanceira.Canvas.Font.Style:=[fsBold];
      Dbg_FinanPlanFinanceira.Canvas.Brush.Color:=clSkyBlue;
    end;

    if (DMVirtual.CDS_V_PlanFinanceiraTipo.AsString='') and (DMVirtual.CDS_V_PlanFinanceiraCod_Comprovante.AsString='') Then
    Begin
      Dbg_FinanPlanFinanceira.Canvas.Brush.Color:=clWindow;
    end;

    if Copy(DMVirtual.CDS_V_PlanFinanceiraDes_Comprovante.AsString,1,8)='Perodo ' Then
    Begin
      Dbg_FinanPlanFinanceira.Canvas.Font.Style:=[fsBold];
    end;

    Dbg_FinanPlanFinanceira.Canvas.FillRect(Rect);
    Dbg_FinanPlanFinanceira.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Dbg_FinanPlanFinanceiraKeyDown(Sender: TObject;var Key: Word; Shift: TShiftState);
Var
  s: String;  
begin

  // Acerta Posicio na Celula ================================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 3) then
  Begin
    Key := VK_Clear;
    Dbg_FinanPlanFinanceira.Refresh;
  End;

  // Movimentos do Comprovante =================================================
  If key=VK_F6 Then
  Begin
    s:=Dbg_FinanPlanFinanceira.Columns[Dbg_FinanPlanFinanceira.SelectedIndex].Title.Caption;

    If (Copy(s,1,4)='Bel_') and (Trim(DMVirtual.CDS_V_PlanFinanceiraCod_Comprovante.AsString)<>'') Then
    Begin
      s:=Copy(s,length(s)-1,length(s));
      PlanilhaFinanceiraMovtos(s, DMVirtual.CDS_V_PlanFinanceiraCod_Comprovante.AsString);
    End; // If (Copy(s,1,4)='Bel_') and (Trim(DMVirtual.CDS_V_PlanFinanceiraCod_Comprovante.AsString)<>'') Then
    
  End; // If key=VK_F6 Then

  // Localiza Comprovante ======================================================
  If Key=VK_F4 Then
  Begin
    s:='';
    If InputQuery('Localizar Comprovante','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        If StrToIntDef(s,999999)=999999 Then
         DMVirtual.CDS_V_PlanFinanceira.Locate('Des_Comprovante',AnsiUpperCase(s),[loPartialKey])
        Else
         DMVirtual.CDS_V_PlanFinanceira.Locate('Cod_Comprovante',s,[]);
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Comprovante','',s) then
  End; // If Key=VK_F4 Then

end;

procedure TFrmBelShop.Bt_FinanPlanFinanceiraTempoCalculoVoltarClick(Sender: TObject);
begin
  Bt_FinanPlanFinanceiraCalcular.Enabled:=True;
  Bt_FinanPlanFinanceiraTamColunas.Enabled:=True;
  Bt_FinanPlanDemonsResultados.Enabled:=True;
  Bt_FinanPlanFinanceiraVoltar.Enabled:=True;

  Dbg_FinanPlanFinanceira.SetFocus;

end;

procedure TFrmBelShop.Ckb_FinanManutComprovSomaGrupoClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanManutComprovSomaGrupo);
end;

procedure TFrmBelShop.Dbg_FinanPlanFinanceiraColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanPlanFinanceiraColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanPlanFinanceiraDrawDataCell(Sender: TObject; const Rect:
          TRect; Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty Then
  Begin
    if (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 0) Or
       (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 1) Or
       (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 2) then
    begin
      THackDBGrid(Dbg_FinanPlanFinanceira).FixedCols:=4;
      THackDBGrid(Dbg_FinanPlanFinanceira).LeftCol:=4;
      THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex:=3;
      Dbg_FinanPlanFinanceira.Refresh;
    end;
  End;
end;

procedure TFrmBelShop.Bt_FinanPlanFinanceiraTamColunasClick(Sender: TObject);
Var
  i: Integer;
Begin
  Dbg_FinanPlanFinanceira.SetFocus;

  If (DMVirtual.CDS_V_PlanFinanceira.IsEmpty) and (DMVirtual.CDS_V_PlanFinanceira.Filter='') Then
   Exit;

  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(17);

  FrmSolicitacoes.Ts_FinanPlanFinanceiraSolicitaDatas.TabVisible:=False;
  FrmSolicitacoes.Ts_FinanPlanFinanceiraSolicitaTamColunas.Highlighted:=True;
  FrmSolicitacoes.Ts_FinanPlanFinanceiraSolicitaTamColunas.TabVisible:=True;

  FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunas1.Value:=Dbg_FinanPlanFinanceira.Columns[0].Width;
  FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunas2.Value:=Dbg_FinanPlanFinanceira.Columns[1].Width;
  FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunas3.Value:=Dbg_FinanPlanFinanceira.Columns[2].Width;
  FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunasNaoFixadas.Value:=Dbg_FinanPlanFinanceira.Columns[3].Width;

  bgProcessar:=False;
  FrmSolicitacoes.ShowModal;

  If bgProcessar Then
  Begin
    // Tamanho Colunas No FIXADAS ===============================================
    For i:=3 to Dbg_FinanPlanFinanceira.Columns.Count-1 do
    Begin
      Dbg_FinanPlanFinanceira.Columns[i].Width:=FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunasNaoFixadas.AsInteger;

      Application.ProcessMessages;
      Dbg_FinanPlanFinanceira.Refresh;
    End;

    // Tamanho Colunas FIXADAS ===================================================
    For i:=0 to 2 do
    Begin
      If i=0 Then
       Dbg_FinanPlanFinanceira.Columns[i].Width:=FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunas1.AsInteger;

      If i=1 Then
       Dbg_FinanPlanFinanceira.Columns[i].Width:=FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunas2.AsInteger;

      If i=2 Then
       Dbg_FinanPlanFinanceira.Columns[i].Width:=FrmSolicitacoes.EdtFinanPlanFinanceiraTamColunas3.AsInteger;

      Application.ProcessMessages;
      Dbg_FinanPlanFinanceira.Refresh;
    End;
    DMVirtual.CDS_V_PlanFinanceira.Last;
    DMVirtual.CDS_V_PlanFinanceira.First;

    Dbg_FinanPlanFinanceira.Refresh;
  End; // If bgProcessar Then
  FreeAndNil(FrmSolicitacoes);

  Dbg_FinanPlanFinanceira.SetFocus;

end;

procedure TFrmBelShop.Ckb_FinanGrFinanAtivoClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanGrFinanAtivo);

end;

procedure TFrmBelShop.Bt_FinanGrFinanVoltarClick(Sender: TObject);
begin
  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanRelacao;
  PC_FinanComprPlanFinanChange(Self);
  Dbg_FinanComprovantes.SetFocus;

end;

procedure TFrmBelShop.Dbe_FinanManutComprovFormulaExit(Sender: TObject);
begin
  If (DMBelShop.CDS_ComprovanteDES_FORMULA.NewValue='') Or (DMBelShop.CDS_ComprovanteDES_FORMULA.NewValue=Null) Then
   DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsInteger:=0;

  If ((DMBelShop.CDS_ComprovanteDES_FORMULA.NewValue<>'') And (DMBelShop.CDS_ComprovanteDES_FORMULA.NewValue<>Null)) and
     ((DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsInteger=0) Or (DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsString='') Or
     (DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsString=Null)) Then
   DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsInteger:=2;

end;

procedure TFrmBelShop.Ckb_FinanManutComprovPlanilhaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanManutComprovPlanilhaClick(Self);

end;

procedure TFrmBelShop.Ckb_FinanManutComprovSomaGrupoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanManutComprovSomaGrupoClick(Self);
end;

procedure TFrmBelShop.Ckb_FinanManutComprovAtivoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanManutComprovAtivoClick(Self);
end;

procedure TFrmBelShop.Ckb_GeraOCCalculoTransitoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_GeraOCCalculoTransitoClick(Self);
end;

procedure TFrmBelShop.Ckb_GeraOCCalculoEstoqueKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_GeraOCCalculoEstoqueClick(Self);
end;

procedure TFrmBelShop.Ckb_FinanGrFinanAtivoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanGrFinanAtivoClick(Self);
end;

procedure TFrmBelShop.Ckb_ConsultaOCSelectEmpresasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_ConsultaOCSelectEmpresasClick(Self);
end;

procedure TFrmBelShop.Ckb_FiltroProdNaoCompraKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FiltroProdNaoCompraClick(Self);
end;

procedure TFrmBelShop.Dbg_FinanComprovantesColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanComprovantesColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanComprovantesDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanComprovantesColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanComprovantesDrawDataCell(Sender: TObject; const Rect: TRect;
          Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty Then
  Begin
    If (THackDBGrid(Dbg_FinanComprovantes).SelectedIndex = 0) Or
       (THackDBGrid(Dbg_FinanComprovantes).SelectedIndex = 1) then // Index das Colunas Fixadas Sem Indicador
    Begin
      THackDBGrid(Dbg_FinanComprovantes).LeftCol := 3; // Index da 1 Coluna No Fixada Contando Indicador
      THackDBGrid(Dbg_FinanComprovantes).SelectedIndex := 2; // Index da 1 Coluna No Fixada Sem Contar Indicador
    End;
  End;

end;

procedure TFrmBelShop.Dbg_FinanComprovantesKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanComprovantes).SelectedIndex = 2) then // Index da 1 Coluna No Fixada Sem Contar Indicador
  Begin
    Key := VK_Clear;
    Dbg_FinanComprovantes.SetFocus;
  End;

end;

procedure TFrmBelShop.Bt_FinanComprovantesNovoClick(Sender: TObject);
Var
  MySql: String;
begin

  Screen.Cursor:=crAppStart;

  // Codigos Apartir de 9990  somento do Odir
  /////////////////////////////////////////////
  
  // Busca Cdigo do Comprovante ===============================================
  MySql:='Select coalesce(max(Cast(f.cod_comprov as Integer))+1 ,1) Codigo'+
         ' from fin_comprovantes f'+
         ' Where Cast(f.cod_comprov as Integer)>9000'+
         ' and Cast(f.cod_comprov as Integer)<9990';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  If DMBelShop.CDS_Busca.FieldByName('Codigo').AsInteger<9000 Then
   sgCodigo:=IntToStr(DMBelShop.CDS_Busca.FieldByName('Codigo').AsInteger+9000)
  Else
   sgCodigo:=DMBelShop.CDS_Busca.FieldByName('Codigo').AsString;
  DMBelShop.CDS_Busca.Close;

  // Edita =====================================================================
  MySql:='select *'+
         ' from fin_comprovantes'+
         ' Where cod_comprov<0';
  DMBelShop.CDS_Comprovante.Close;
  DMBelShop.SDS_Comprovante.CommandText:=MySql;
  DMBelShop.CDS_Comprovante.Open;

  DMBelShop.CDS_Comprovante.Insert;
  DMBelShop.CDS_ComprovanteCOD_COMPROV.AsString:=sgCodigo;
  DMBelShop.CDS_ComprovanteNUM_DECIMAIS.AsInteger:=0;
  DMBelShop.CDS_ComprovanteIND_PLANILHA.AsString:='SIM';
  DMBelShop.CDS_ComprovanteIND_SOMA_GRUPO.AsString:='SIM';

  Ckb_FinanManutComprovPlanilha.Checked:=
                          DMBelShop.CDS_ComprovantesIND_PLANILHA.AsString='SIM';
  Ckb_FinanManutComprovPlanilhaClick(Self);

  Ckb_FinanManutComprovSomaGrupo.Checked:=
                        DMBelShop.CDS_ComprovantesIND_SOMA_GRUPO.AsString='SIM';
  Ckb_FinanManutComprovSomaGrupoClick(Self);

  Ckb_FinanManutComprovAtivo.Checked:=
                             DMBelShop.CDS_ComprovantesIND_ATIVO.AsString='SIM';
  Ckb_FinanManutComprovAtivoClick(Self);

  // Abre TabSheet de Detalhamento =============================================
  Ts_FinanComprPlanFinanManutComprov.TabVisible:=True;
  Ts_FinanComprPlanFinanRelacao.TabVisible:=False;
  Ts_FinanComprPlanFinanManutGrFinanceiro.TabVisible:=False;

  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanManutComprov;
  PC_FinanComprPlanFinanChange(Self);

  Dbe_FinanManutComprovDesComprovante.ReadOnly:=False;
  Dbe_FinanManutComprovDesComprovante.Color:=clWindow;

  Dbe_FinanManutComprovDesComprovante.SetFocus;

  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.PopM_PlanFinanceiraSalvarClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty Then
  Begin
    Dbg_FinanPlanFinanceira.SetFocus;
    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_PlanFinanceira,Dbg_FinanPlanFinanceira,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.PopM_PlanFinanceiraSinteticoClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty Then
  Begin
    DMVirtual.CDS_V_PlanFinanceira.Filtered:=False;
    DMVirtual.CDS_V_PlanFinanceira.Filter:='TIPO is not null';
    DMVirtual.CDS_V_PlanFinanceira.Filtered:=True;
  End;

end;

procedure TFrmBelShop.PopM_PlanFinanceiraAnaliticoClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty Then
  Begin
    DMVirtual.CDS_V_PlanFinanceira.Filtered:=False;
    DMVirtual.CDS_V_PlanFinanceira.Filter:='';
  End;

end;

procedure TFrmBelShop.Bt_FinanPlanFinanceiraCalcularClick(Sender: TObject);
Var
  MesI, MesF, AnoI, AnoF: Word;
begin
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(17);

  FrmSolicitacoes.PC_FinanPlanFinanceiraPeriodo.TabIndex:=0;

  FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaInicio.Date:=PrimeiroUltimoDia(
                         DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), 'P');
  FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaFim.Date:=PrimeiroUltimoDia(
                         DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), 'U');

  FrmSolicitacoes.Ts_FinanPlanFinanceiraSolicitaTamColunas.TabVisible:=False;
  FrmSolicitacoes.Ts_FinanPlanFinanceiraSolicitaDatas.Highlighted:=True;
  FrmSolicitacoes.Ts_FinanPlanFinanceiraSolicitaDatas.TabVisible:=True;

  FrmSolicitacoes.Rb_FinanPlanFinanceiraUsarDtaDocto.Checked:=True;
  FrmSolicitacoes.Ts_FinanPlanFinanceiraPeriodoData.TabVisible:=True;

  bgProcessar:=False;
  FrmSolicitacoes.ShowModal;

  If bgProcessar Then
  Begin
    bFinanPlanFinanceiraUsarMesAno:=FrmSolicitacoes.Rb_FinanPlanFinanceiraUsarMesAno.Checked;
    sCbx_FinanPlanFinanceiraMes1  :=FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes1.Text;
    sEdtFinanPlanFinanceiraAno1   :=FrmSolicitacoes.EdtFinanPlanFinanceiraAno1.Text;
    sCbx_FinanPlanFinanceiraMes2  :=FrmSolicitacoes.Cbx_FinanPlanFinanceiraMes2.Text;
    sEdtFinanPlanFinanceiraAno2   :=FrmSolicitacoes.EdtFinanPlanFinanceiraAno2.Text;
    dDtEdt_FinanPlanFinanceiraPeriodoDtaInicio:=FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaInicio.Date;
    dDtEdt_FinanPlanFinanceiraPeriodoDtaFim   :=FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaFim.Date;

    // Guarda Numero de Meses ====================================================
    DecodeDate(FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaInicio.Date,AnoI,MesI,wgDiaH);
    DecodeDate(FrmSolicitacoes.DtEdt_FinanPlanFinanceiraPeriodoDtaFim.Date,AnoF,MesF,wgDiaH);
    igNrMeses:=0;
    If (MesI<>MesF) Or (AnoI<>AnoF) Then
     igNrMeses:=1;

    // Fecha Planilha de Demostrativo de Resultados ==============================
    If DMVirtual.CDS_V_PlanDemonsResultados.Active Then
     DMVirtual.CDS_V_PlanDemonsResultados.Close;

    // Cria Planilha Financeira ==================================================
    try
      DMVirtual.CDS_V_PlanFinanceira.CreateDataSet;
      DMVirtual.CDS_V_PlanFinanceira.Open;
    Except
      DMVirtual.CDS_V_PlanFinanceira.EmptyDataSet;
      DMVirtual.CDS_V_PlanFinanceira.Open;
    End;
    DMVirtual.CDS_V_PlanFinanceira.Filtered:=False;
    DMVirtual.CDS_V_PlanFinanceira.Filter:='';

    CalculaPlanilhaFinanceira;

    Dbg_FinanPlanFinanceira.Refresh;
  End; // If bgProcessar Then
  FreeAndNil(FrmSolicitacoes);

  Dbg_FinanPlanFinanceira.SetFocus;


end;

procedure TFrmBelShop.Bt_FinanDemonsResultBuscaGrFinanceiroClick(Sender: TObject);
Var
  MySql, s: String;
Begin
  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:='select DES_GR_FINAN, COD_GR_FINAN'+
         ' from FIN_GR_FINANCEIRO'+
         ' Where Ind_Ativo=''SIM'''+
         ' order by DES_GR_FINAN';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('COD_GR_FINAN').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    DMBelShop.CDS_Pesquisa.Close;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='DES_GR_FINAN';
  FrmPesquisa.Campo_Codigo:='COD_GR_FINAN';
  FrmPesquisa.Campo_Descricao:='DES_GR_FINAN';
  FrmPesquisa.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;
                 
  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
  Begin
    s:=DMBelShop.CDS_DemonsResultadoDES_FORMULA.AsString;
    If Dbe_FinanDemonsResultFormula.SelStart>0 Then
     Insert('GR_'+FrmPesquisa.EdtDescricao.Text,s,Dbe_FinanDemonsResultFormula.SelStart+1)
    Else
     Insert('GR_'+FrmPesquisa.EdtDescricao.Text,s,Dbe_FinanDemonsResultFormula.SelStart);

    DMBelShop.CDS_DemonsResultadoDES_FORMULA.AsString:=s;
    Dbe_FinanDemonsResultFormula.SetFocus;
    Dbe_FinanDemonsResultFormula.SelStart:=(Pos('GR_'+FrmPesquisa.EdtDescricao.Text,
                                                Dbe_FinanDemonsResultFormula.Text))+
                                            Length('GR_'+FrmPesquisa.EdtDescricao.Text)-1;
  End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.PC_FinanComprPlanFinanDemonsResultadosChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_FinanComprPlanFinanDemonsResultados);

end;

procedure TFrmBelShop.Bt_FinanPlanDemonsResultadosClick(Sender: TObject);
begin
  If (Not DMVirtual.CDS_V_PlanFinanceira.Active) Or (DMVirtual.CDS_V_PlanFinanceira.IsEmpty) Then
   Exit;
   
  // Posiciona no TabSheet =====================================================
  Ts_FinanComprPlanFinanDemonsResultados.TabVisible:=True;
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanDemonsResultados;
  PC_FinanComprPlanFinanDemonsResultados.ActivePage:=Ts_FinanComprPlanFinanManutDemonsResultados;
  PC_FinanComprPlanFinanChange(Self);

  If EdtFinanDemonsResultCodVisao.AsInteger<>0 Then
   Dbg_FinanDemonsResultado.SetFocus
  Else
   EdtFinanDemonsResultCodVisao.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultVoltarClick(Sender: TObject);
begin
                      
  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanPlanilhaFinanceira;
  PC_FinanComprPlanFinanChange(Self);
  Dbg_FinanPlanFinanceira.SetFocus;

end;

procedure TFrmBelShop.EdtFinanDemonsResultCodVisaoExit(Sender: TObject);
Var
  MySql: String;
begin

  // Fecha Planilha de Demostrativo de Resultados ==============================
  If DMVirtual.CDS_V_PlanDemonsResultados.Active Then
   DMVirtual.CDS_V_PlanDemonsResultados.Close;

  EdtFinanDemonsResultDesVisao.Clear;
  DMBelShop.CDS_DemonsResultado.Close;

  If EdtFinanDemonsResultCodVisao.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Viso do Demonstrativo de Resultados ==============================
    MySql:=' select t.des_aux Des_Visao, t.cod_aux cod_Visao'+
           ' from tab_auxiliar t'+
           ' where t.tip_aux=1'+
           ' and t.cod_aux='+VarToStr(EdtFinanDemonsResultCodVisao.Value);
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    Screen.Cursor:=crDefault;

    If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Visao').AsString)='' Then
    Begin
      msg('Viso do Demonstrativo de Resultados'+cr+cr+'NO Encontrada !', 'A');
      EdtFinanDemonsResultDesVisao.Clear;
      EdtFinanDemonsResultCodVisao.Value:=0;
      EdtFinanDemonsResultCodVisao.SetFocus;
      DMBelShop.CDS_Busca.Close;
      Exit;
    End; // If Trim(DMBelShop.CDS_Busca.FieldByName('Cod_Visao').AsString)='' Then

    EdtFinanDemonsResultDesVisao.Text:=DMBelShop.CDS_Busca.FieldByName('Des_Visao').AsString;

    DMBelShop.CDS_Busca.Close;
    
  End; // If EdtFinanDemonsResultCodVisao.Value<>0 Then
end;

procedure TFrmBelShop.Bt_FinanDemonsResultCadVisaoClick(Sender: TObject);
begin
  If msg('Deseja Realmente Cadastrar Nova Viso'+cr+cr+'do Demonstrativo de Resultados ??','C')=1 Then
  Begin
    DemonsResultadosCadastraVisao;
    
    // Fecha Planilha de Demostrativo de Resultados ==============================
    If DMVirtual.CDS_V_PlanDemonsResultados.Active Then
     DMVirtual.CDS_V_PlanDemonsResultados.Close;

  End;
 
  EdtFinanDemonsResultCodVisao.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultBuscaVisaoClick(Sender: TObject);
Var
  MySql: String;
begin

  // Fecha Planilha de Demostrativo de Resultados ==============================
  If DMVirtual.CDS_V_PlanDemonsResultados.Active Then
   DMVirtual.CDS_V_PlanDemonsResultados.Close;

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crSQLWait;

  MySql:=' Select t.des_aux Des_Visao, t.cod_aux cod_Visao'+
         ' From tab_auxiliar t'+
         ' where t.tip_aux=1'+
         ' order by t.des_aux';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('Cod_Visao').AsString)='' Then
  Begin
    msg('Sem Viso a Listar !!','A');
    EdtFinanDemonsResultCodVisao.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_Pesquisa:='Des_Visao';
  FrmPesquisa.Campo_Codigo:='Cod_Visao';
  FrmPesquisa.Campo_Descricao:='Des_Visao';
  FrmPesquisa.EdtDescricao.Clear;

  // Campos Qualquer de Retorno ================================================
  // Variavel de Entrada  - Variavel de Retorno
  // Campo_Retorno1       - Retorno1
  // Campo_Retorno2       - Retorno2
  // Campo_Retorno3       - Retorno3
  // FrmPesquisa.Campo_Retorno1:='Dta_Cadastro';
  // FrmPesquisa.Campo_Retorno2:='Cod_Cidade';
  // FrmPesquisa.Campo_Retorno3:='';

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtFinanDemonsResultCodVisao.Value:=StrToInt(FrmPesquisa.EdtCodigo.Text);
     EdtFinanDemonsResultDesVisao.Text:=FrmPesquisa.EdtDescricao.Text;
   End
  Else
   Begin
     EdtFinanDemonsResultCodVisao.Value:=0;
     EdtFinanDemonsResultDesVisao.Clear;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);

end;

procedure TFrmBelShop.EdtFinanDemonsResultDesVisaoChange(Sender: TObject);
begin
  // Busca Demonstrativos de Resultados da Viso
  DemonstrativosResultado(IntToStr(EdtFinanDemonsResultCodVisao.AsInteger));

  Bt_FinanDemonsResultNovo.Enabled:=False;
  Bt_FinanDemonsResultAlterar.Enabled:=False;
  Bt_FinanDemonsResultExcluir.Enabled:=False;
  If Trim(EdtFinanDemonsResultDesVisao.Text)<>'' Then
  Begin
    Bt_FinanDemonsResultNovo.Enabled:=True;
    Bt_FinanDemonsResultAlterar.Enabled:=True;
    Bt_FinanDemonsResultExcluir.Enabled:=True;
  End; // If Trim(EdtFinanDemonsResultDesVisao.Text)<>'' Then

end;

procedure TFrmBelShop.Bt_FinanDemonsResultNovoClick(Sender: TObject);
Var
  MySql: String;
begin

  MySql:=' Select Coalesce(max(f.cod_demonstrativo)+1 ,1) Cod_Demons'+
         ' From fin_demons_resultado f'+
         ' where f.cod_visao='+VarToStr(EdtFinanDemonsResultCodVisao.Value);
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;
  sgCodigo:=DMBelShop.CDS_Busca.FieldByName('Cod_Demons').AsString;
  DMBelShop.CDS_Busca.Close;

  DMBelShop.CDS_DemonsResultado.Insert;
  DMBelShop.CDS_DemonsResultadoCOD_VISAO.AsInteger:=
                                         EdtFinanDemonsResultCodVisao.AsInteger;
  DMBelShop.CDS_DemonsResultadoCOD_DEMONSTRATIVO.AsString:=sgCodigo;
  DMBelShop.CDS_DemonsResultadoNUM_DECIMAIS.AsInteger:=0;
  DMBelShop.CDS_DemonsResultadoUSU_INCLUI.AsString:=Cod_Usuario;
  DMBelShop.CDS_DemonsResultadoDTA_INCLUI.AsDateTime:=
                               DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);

  Pan_FinanDemonsResultados.Enabled:=True;
  Bt_FinanDemonsResultSalvar.Enabled:=True;
  Bt_FinanDemonsResultAbandonar.Enabled:=True;
  Dbe_FinanDemonsResultDesDemonstrativo.SetFocus;

  Pan_FinanDemonsResultVisao.Enabled:=False;
  Bt_FinanDemonsResultNovo.Enabled:=False;
  Bt_FinanDemonsResultAlterar.Enabled:=False;
  Bt_FinanDemonsResultExcluir.Enabled:=False;
  Bt_FinanDemonsResultVoltar.Enabled:=False;
  DBG_FinanDemonsResultado.Enabled:=False;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultAbandonarClick(Sender: TObject);
begin
  If (DMBelShop.CDS_DemonsResultado.State=dsEdit) or (DMBelShop.CDS_DemonsResultado.State=dsInsert) Then
   DMBelShop.CDS_DemonsResultado.CancelUpdates;

  DMBelShop.CDS_DemonsResultado.Close;
  DMBelShop.CDS_DemonsResultado.IndexFieldNames:='';
  DMBelShop.CDS_DemonsResultado.Open;

  If sgCodigo<>'' Then
   DMBelShop.CDS_DemonsResultado.Locate('COD_DEMONSTRATIVO',sgCodigo,[]);

  // Retorna
  Pan_FinanDemonsResultVisao.Enabled:=True;
  Bt_FinanDemonsResultNovo.Enabled:=True;
  Bt_FinanDemonsResultAlterar.Enabled:=True;
  Bt_FinanDemonsResultExcluir.Enabled:=True;
  Bt_FinanDemonsResultVoltar.Enabled:=True;
  Dbg_FinanDemonsResultado.Enabled:=True;

  Dbg_FinanDemonsResultado.SetFocus;

  Pan_FinanDemonsResultados.Enabled:=False;
  Bt_FinanDemonsResultSalvar.Enabled:=False;
  Bt_FinanDemonsResultAbandonar.Enabled:=False;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultAlterarClick(Sender: TObject);
begin
  If DMBelShop.CDS_DemonsResultado.IsEmpty Then
   Exit;
   
  sgCodigo:=DMBelShop.CDS_DemonsResultadoCOD_DEMONSTRATIVO.AsString;

  DMBelShop.CDS_DemonsResultado.Edit;

  Pan_FinanDemonsResultados.Enabled:=True;
  Bt_FinanDemonsResultSalvar.Enabled:=True;
  Bt_FinanDemonsResultAbandonar.Enabled:=True;
  Dbe_FinanDemonsResultDesDemonstrativo.SetFocus;

  Pan_FinanDemonsResultVisao.Enabled:=False;
  Bt_FinanDemonsResultNovo.Enabled:=False;
  Bt_FinanDemonsResultAlterar.Enabled:=False;
  Bt_FinanDemonsResultExcluir.Enabled:=False;
  Bt_FinanDemonsResultVoltar.Enabled:=False;
  Dbg_FinanDemonsResultado.Enabled:=False;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultExcluirClick(Sender: TObject);
Var
  MySql: String;
  i: Integer;
begin
  If DMBelShop.CDS_DemonsResultado.IsEmpty Then
   Exit;

  If msg('Deseja Realmente EXCLUIR o Demonstrativo'+cr+cr+'de Resultado Selecionado ??','C')=2 Then
  Begin
    Dbg_FinanDemonsResultado.SetFocus;
    Exit;
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    MySql:='Delete From FIN_DEMONS_RESULTADO'+
           ' Where COD_VISAO='+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger)+
           ' And COD_DEMONSTRATIVO='+DMBelShop.CDS_DemonsResultadoCOD_DEMONSTRATIVO.AsString;
    DMBelShop.SQLC.Execute(MySql, nil, nil);

    // Acerta Ordem de Apresentacao na Planilha Financeira ----------
    MySql:='select COD_VISAO, COD_DEMONSTRATIVO'+
           ' from FIN_DEMONS_RESULTADO'+
           ' Where COD_VISAO='+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger)+
           ' order by num_ordem';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    i:=0;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin

      Inc(i);

      MySql:='Update FIN_DEMONS_RESULTADO'+
             ' Set NUM_ORDEM='+IntToStr(i)+
             ' Where COD_VISAO='+DMBelShop.CDS_Busca.FieldByName('COD_VISAO').AsString+
             ' And COD_DEMONSTRATIVO='+DMBelShop.CDS_Busca.FieldByName('COD_DEMONSTRATIVO').AsString;
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    DMBelShop.CDS_Busca.Close;

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

    DMBelShop.CDS_DemonsResultado.Close;
    DMBelShop.CDS_DemonsResultado.IndexFieldNames:='';
    DMBelShop.CDS_DemonsResultado.Open;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

end;

procedure TFrmBelShop.Bt_FinanDemonsResultSalvarClick(Sender: TObject);
Var
  MySql: String;
  i: Integer;
begin

  If Dbe_FinanDemonsResultDesDemonstrativo.Text='' Then
  Begin
    msg('Favor Informar a Descrio !!','A');
    Dbe_FinanDemonsResultDesDemonstrativo.SetFocus;
    Exit;
  End;

  Try
    DMBelShop.CDS_DemonsResultadoNUM_ORDEM.AsInteger;

    If DMBelShop.CDS_DemonsResultadoNUM_ORDEM.AsInteger=0 Then
    Begin
      msg('Favor Informar o Nmero da Ordem'+cr+'para Apresentao na'+cr+'Planilha !!','A');
      Dbe_FinanDemonsResultOrdem.SetFocus;
      Exit;
    End;
  Except
    If DMBelShop.CDS_DemonsResultadoNUM_ORDEM.AsInteger=0 Then
    Begin
      msg('Nmero da Ordem Invlido !!','A');
      Dbe_FinanDemonsResultOrdem.SetFocus;
      Exit;
    End;
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Acerta Ordem de Apresentacao na Planilha Financeira ----------
    MySql:='select COD_VISAO, COD_DEMONSTRATIVO'+
           ' from FIN_DEMONS_RESULTADO'+
           ' Where COD_VISAO='+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger)+
           ' and COD_DEMONSTRATIVO<>'+DMBelShop.CDS_DemonsResultadoCOD_DEMONSTRATIVO.AsString+
           ' order by num_ordem';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    i:=0;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin

      Inc(i);

      If i=DMBelShop.CDS_DemonsResultadoNUM_ORDEM.AsInteger Then
       Inc(i);

      MySql:='Update FIN_DEMONS_RESULTADO'+
             ' Set NUM_ORDEM='+IntToStr(i)+
             ' Where COD_VISAO='+DMBelShop.CDS_Busca.FieldByName('COD_VISAO').AsString+
             ' And COD_DEMONSTRATIVO='+DMBelShop.CDS_Busca.FieldByName('COD_DEMONSTRATIVO').AsString;
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    DMBelShop.CDS_Busca.Close;

    If DMBelShop.CDS_DemonsResultado.State=dsInsert Then
    Begin
      MySql:='Insert Into FIN_DEMONS_RESULTADO ('+
             ' COD_VISAO, COD_DEMONSTRATIVO, DES_DEMONSTRATIVO, DES_FORMULA,'+
             ' NUM_DECIMAIS, NUM_ORDEM, USU_INCLUI, DTA_INCLUI)'+
             ' Values ('+
             QuotedStr(DMBelShop.CDS_DemonsResultadoCOD_VISAO.AsString)+', '+
             QuotedStr(DMBelShop.CDS_DemonsResultadoCOD_DEMONSTRATIVO.AsString)+', '+
             QuotedStr(DMBelShop.CDS_DemonsResultadoDES_DEMONSTRATIVO.AsString)+', '+
             QuotedStr(DMBelShop.CDS_DemonsResultadoDES_FORMULA.AsString)+', '+
             QuotedStr(DMBelShop.CDS_DemonsResultadoNUM_DECIMAIS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_DemonsResultadoNUM_ORDEM.AsString)+', '+
             QuotedStr(Cod_Usuario)+', Current_Date)';
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End;

    If DMBelShop.CDS_DemonsResultado.State=dsEdit Then
    Begin
      MySql:='Update FIN_DEMONS_RESULTADO '+
             ' Set DES_DEMONSTRATIVO='+
             QuotedStr(DMBelShop.CDS_DemonsResultadoDES_DEMONSTRATIVO.AsString)+
             ', DES_FORMULA='+
             QuotedStr(DMBelShop.CDS_DemonsResultadoDES_FORMULA.AsString)+
             ', NUM_DECIMAIS='+
             QuotedStr(DMBelShop.CDS_DemonsResultadoNUM_DECIMAIS.AsString)+
             ', NUM_ORDEM='+
             QuotedStr(DMBelShop.CDS_DemonsResultadoNUM_ORDEM.AsString)+
             ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
             ', DTA_ALTERA=Current_Date'+

             ' Where COD_VISAO='+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger)+
             ' And COD_DEMONSTRATIVO='+sgCodigo;
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End;

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      
    End; // on e : Exception do
  End; // Try

  Bt_FinanDemonsResultAbandonarClick(Self);

end;

procedure TFrmBelShop.EdtFinanGrFinanUsuarioCodExit(Sender: TObject);
Var
  MySql: String;
begin

  If EdtFinanGrFinanUsuarioCod.Value>1 Then
  Begin
    Screen.Cursor:=crAppStart;
    MySql:='Select Des_Usuario, Cod_Usuario'+
           ' From PS_Usuarios'+
           ' Where Ind_Ativo=''SIM'''+
           ' And Cod_Usuario='+VarToStr(EdtFinanGrFinanUsuarioCod.Value);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Usuario').AsString)='' Then
    Begin
      msg('Usuario No Encontrado !!','A');
      EdtFinanGrFinanUsuarioCod.SetFocus;
      DMBelShop.CDS_Busca.Close;
      Screen.Cursor:=crDefault;
      Exit;
    End;

    // Verifica se J Existe ===================================================
    MySql:='Select vo.Cod_Usuario'+
           ' From PS_VISUAL_OBJETOS vo'+
           ' Where vo.Des_Tabela=''FIN_GR_FINANCEIRO'''+
           ' And vo.Des_Modulo=''Ts_FinanComprPlanFinan'''+

           ' And vo.Cod_Usuario='+QuotedStr(
           DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Usuario').AsString)+
           ' And vo.Cod_Tabela='+QuotedStr(
           DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Usuario').AsString)='' Then
    Begin
      // Inclui Usurio
      // Monta Transacao ===========================================================
      TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
      TD.IsolationLevel:=xilREADCOMMITTED;
      DMBelShop.SQLC.StartTransaction(TD);
      Try
        Screen.Cursor:=crAppStart; 
        DateSeparator:='.';
        DecimalSeparator:='.';

        MySql:='Insert Into PS_VISUAL_OBJETOS'+
               ' (COD_USUARIO, DES_MODULO, DES_COMPONENTE, DES_TABELA, COD_TABELA)'+
               ' VALUES ('+
               QuotedStr(IntToStr(EdtFinanGrFinanUsuarioCod.AsInteger))+', '+
               QuotedStr('Ts_FinanComprPlanFinan')+
               ', Null, '+
               QuotedStr('FIN_GR_FINANCEIRO')+', '+
               QuotedStr(DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString)+')';
        DMBelShop.SQLC.Execute(MySql, nil, nil);

        DMBelShop.CDS_VisualObjetos.Close;
        DMBelShop.CDS_VisualObjetos.Open;
        DMBelShop.CDS_VisualObjetos.Locate('Cod_Usuario', EdtFinanGrFinanUsuarioCod.AsInteger,[]);

//      i:=0;
//      If (Not DMBelShop.CDS_VisualObjetos.IsEmpty) and (DMBelShop.CDS_VisualObjetos.Active) Then
//       i:=DMBelShop.CDS_VisualObjetos.RecNo;
//      If (i<>0) and (Not DMBelShop.CDS_VisualObjetos.IsEmpty) and (DMBelShop.CDS_VisualObjetos.Active) Then
//       If i<=DMBelShop.CDS_VisualObjetos.RecordCount Then
//        DMBelShop.CDS_VisualObjetos.RecNo:=i;
        // Fecha Transacao ===========================================================
        DMBelShop.SQLC.Commit(TD);

        DateSeparator:='/';
        DecimalSeparator:=',';
        Screen.Cursor:=crDefault;

      Except
        on e : Exception do
        Begin
          EdtFinanGrFinanUsuarioCod.SetFocus;

          DMBelShop.SQLC.Rollback(TD);

          DateSeparator:='/';
          DecimalSeparator:=',';
          Screen.Cursor:=crDefault;

          MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);

        End; // on e : Exception do
      End; // Try
    End; // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Usuario').AsString)='' Then
    DMBelShop.CDS_BuscaRapida.Close;
    
    EdtFinanGrFinanUsuarioCod.Value:=0;
    EdtFinanGrFinanUsuarioCod.SetFocus;
    Screen.Cursor:=crDefault;
  End; // If EdtFinanGrFinanUsuarioCod.Value>1 Then

end;

procedure TFrmBelShop.Bt_FinanGrFinanUsuarioExcluiClick(Sender: TObject);
Var
  MySql: String;
begin
  If DMBelShop.CDS_VisualObjetos.IsEmpty Then
  Begin
    msg('SEM Usurio a EXCLUIR !!' ,'A');
    EdtFinanGrFinanUsuarioCod.SetFocus;
    Exit;
  End;

  If msg('Deseja Realmente Excluir'+cr+cr+'Usurio Selecionado ??','C')=2 Then
  Begin
    EdtFinanGrFinanUsuarioCod.SetFocus;
    Exit;
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart; 
    DateSeparator:='.';
    DecimalSeparator:='.';

    MySql:='Delete From PS_VISUAL_OBJETOS vo'+
           ' Where vo.Des_Tabela=''FIN_GR_FINANCEIRO'''+
           ' And vo.Des_Modulo=''Ts_FinanComprPlanFinan'''+

           ' And vo.Cod_Usuario='+QuotedStr(
           DMBelShop.CDS_VisualObjetosCOD_USUARIO.AsString)+
           ' And vo.Cod_Tabela='+QuotedStr(
           DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString);
    DMBelShop.SQLC.Execute(MySql, nil, nil);        

    DMBelShop.CDS_VisualObjetos.Close;
    DMBelShop.CDS_VisualObjetos.Open;

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;
  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

  EdtFinanGrFinanUsuarioCod.Value:=0;
  EdtFinanGrFinanUsuarioCod.SetFocus;   
end;

procedure TFrmBelShop.Bt_FinanGrFinanUsuarioIncluiTodosClick(Sender: TObject);
begin
  If DMBelShop.CDS_VisualObjetos.IsEmpty Then
  Begin
    msg('SEM Usurio a INCLUIR !!' ,'A');
    Exit;
  End;

end;

procedure TFrmBelShop.Bt_FinanGrFinanUsuarioExcluiTodosClick(Sender: TObject);
begin
  If DMBelShop.CDS_VisualObjetos.IsEmpty Then
  Begin
    msg('SEM Usurio a EXCLUIR !!' ,'A');
    Exit;
  End;

end;

procedure TFrmBelShop.Bt_FinanGrFinanUsuarioBuscaClick(Sender: TObject);
Var
  MySql: String;
begin
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  EdtFinanGrFinanUsuarioCod.Value:=0;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:='Select Des_Usuario, Cod_Usuario'+
         ' From PS_Usuarios'+
         ' Where Ind_Ativo=''SIM'''+
         ' And Cod_Usuario>1'+
         ' Order by Des_Usuario';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('Cod_Usuario').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Sem Usuario a Listar !!','A');
    EdtFinanGrFinanUsuarioCod.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Des_Usuario';
  FrmPesquisa.Campo_Codigo:='Cod_Usuario';
  FrmPesquisa.Campo_Descricao:='Des_Usuario';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     // Verifica se J Existe ===================================================
     MySql:='Select vo.Cod_Usuario'+
            ' From PS_VISUAL_OBJETOS vo'+
            ' Where vo.Des_Tabela=''FIN_GR_FINANCEIRO'''+
            ' And vo.Des_Modulo=''Ts_FinanComprPlanFinan'''+

            ' And vo.Cod_Usuario='+QuotedStr(FrmPesquisa.EdtCodigo.Text)+
            ' And vo.Cod_Tabela='+QuotedStr(DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString);
     DMBelShop.CDS_BuscaRapida.Close;
     DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
     DMBelShop.CDS_BuscaRapida.Open;

     If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Usuario').AsString)='' Then
     Begin
       // Inclui Usurio
       // Monta Transacao ===========================================================
       TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
       TD.IsolationLevel:=xilREADCOMMITTED;
       DMBelShop.SQLC.StartTransaction(TD);
       Try
         Screen.Cursor:=crAppStart;
         DateSeparator:='.';
         DecimalSeparator:='.';

         MySql:='Insert Into PS_VISUAL_OBJETOS'+
                ' (COD_USUARIO, DES_MODULO, DES_COMPONENTE, DES_TABELA, COD_TABELA)'+
                ' VALUES ('+
                QuotedStr(FrmPesquisa.EdtCodigo.Text)+', '+
                QuotedStr('Ts_FinanComprPlanFinan')+
                ', Null, '+
                QuotedStr('FIN_GR_FINANCEIRO')+', '+
                QuotedStr(DMBelShop.CDS_Gr_FinanceiroCOD_GR_FINAN.AsString)+')';
         DMBelShop.SQLC.Execute(MySql, nil, nil);

         DMBelShop.CDS_VisualObjetos.Close;
         DMBelShop.CDS_VisualObjetos.Open;
         DMBelShop.CDS_VisualObjetos.Locate('Cod_Usuario', FrmPesquisa.EdtCodigo.Text,[]);

         // Fecha Transacao ===========================================================
         DMBelShop.SQLC.Commit(TD);

         DateSeparator:='/';
         DecimalSeparator:=',';
         Screen.Cursor:=crDefault;

       Except
         on e : Exception do
         Begin
           DMBelShop.SQLC.Rollback(TD);

           DateSeparator:='/';
           DecimalSeparator:=',';
           Screen.Cursor:=crDefault;

           MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
         End; // on e : Exception do
       End; // Try
     End; // If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Usuario').AsString)='' Then
     DMBelShop.CDS_BuscaRapida.Close;

     EdtFinanGrFinanUsuarioCod.Value:=0;
     EdtFinanGrFinanUsuarioCod.SetFocus;
     Screen.Cursor:=crDefault;
   End
  Else // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtFinanGrFinanUsuarioCod.Clear;
     EdtFinanGrFinanUsuarioCod.SetFocus;
     Exit;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.Bt_FinanDemonsResultExcVisaoClick(Sender: TObject);
Var
  MySql: String;
begin
  If Trim(EdtFinanDemonsResultDesVisao.Text)='' Then
   Exit;

  If msg('Deseja Realmente EXCLUIR a Viso do'+cr+cr+'Demonstrativo'+cr+'de Resultado Selecionado ??','C')=2 Then
  Begin
    Dbg_FinanDemonsResultado.SetFocus;
    Exit;
  End;

  // Fecha Planilha de Demostrativo de Resultados ==============================
  If DMVirtual.CDS_V_PlanDemonsResultados.Active Then
   DMVirtual.CDS_V_PlanDemonsResultados.Close;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Busca Viso do Demonstrativo de Resultados ==============================
    MySql:='Delete from tab_auxiliar t'+
           ' where t.tip_aux=1'+
           ' and t.cod_aux='+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger);
    DMBelShop.SQLC.Execute(MySql, nil, nil);

    MySql:='Delete From FIN_DEMONS_RESULTADO'+
           ' Where COD_VISAO='+IntToStr(EdtFinanDemonsResultCodVisao.AsInteger);
    DMBelShop.SQLC.Execute(MySql, nil, nil);

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

    DMBelShop.CDS_DemonsResultado.Close;
    DMBelShop.CDS_DemonsResultado.IndexFieldNames:='';
    DMBelShop.CDS_DemonsResultado.Open;

    EdtFinanDemonsResultCodVisao.Value:=0; 
    EdtFinanDemonsResultDesVisao.Clear; 

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

  EdtFinanDemonsResultCodVisao.SetFocus;
end;

procedure TFrmBelShop.Bt_FinanDemonsResultGeraResultClick(Sender: TObject);
Var
  i: Integer;
begin
  If Trim(EdtFinanDemonsResultDesVisao.Text)='' Then
  Begin
    msg('Favor Informar a Viso do'+cr+cr+'Demonstrativo de Resultados !!', 'A');
    Exit;
  End;

  If DMBelShop.CDS_DemonsResultado.IsEmpty Then
  Begin
    msg('Viso do Demonstrativo de Resultados'+cr+'Sem Item !!!', 'A');
    Exit;
  End;

  // Cria Planilha de Demostrativo de Resultados ===============================
  If DMVirtual.CDS_V_PlanDemonsResultados.Active Then
   DMVirtual.CDS_V_PlanDemonsResultados.Close;
     
  DMVirtual.CDS_V_PlanDemonsResultados.CreateDataSet;
  DMVirtual.CDS_V_PlanDemonsResultados.IndexFieldNames:='';
  DMVirtual.CDS_V_PlanDemonsResultados.Open;

  For i:=3 to DMVirtual.CDS_V_PlanDemonsResultados.Fields.Count-1 do
  Begin
    DMVirtual.CDS_V_PlanDemonsResultados.Fields[i-1].Visible:=DMVirtual.CDS_V_PlanFinanceira.Fields[i].Visible;
    DMVirtual.CDS_V_PlanDemonsResultados.Fields[i-1].DisplayLabel:=DMVirtual.CDS_V_PlanFinanceira.Fields[i].DisplayLabel;
    DMVirtual.CDS_V_PlanDemonsResultados.Fields[i-1].Alignment:=DMVirtual.CDS_V_PlanFinanceira.Fields[i].Alignment;
  End;

  For i:=1 to Dbg_FinanPlanFinanceira.Columns.Count-1 do
  Begin
     If Copy(Dbg_FinanPlanFinanceira.Columns[i].FieldName,1,7)<>'Vlr_Mes' Then
     Begin
       Dbg_FinanDemonsResultPlanDemons.Columns[i-1].Width:=Dbg_FinanPlanFinanceira.Columns[i].Width;
       Dbg_FinanDemonsResultPlanDemons.Columns[i-1].Title.Alignment:=Dbg_FinanPlanFinanceira.Columns[i].Title.Alignment;
     End;
  End;

  // Tamanho das Colunas =======================================================
  EdtFinanDemonsResultTamColunas1.Value:=Dbg_FinanDemonsResultPlanDemons.Columns[0].Width;
  EdtFinanDemonsResultTamColunas2.Value:=Dbg_FinanDemonsResultPlanDemons.Columns[1].Width;
  EdtFinanDemonsResultTamColunasNaoFixadas.Value:=Dbg_FinanDemonsResultPlanDemons.Columns[2].Width;
  
  // Monta Planilha de Demonstrativode Resultados ==============================
  MontaPlanilhaDemonstrativoResultados;
end;

procedure TFrmBelShop.Dbg_FinanDemonsResultPlanDemonsColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanDemonsResultPlanDemons).SelectedIndex = 0) Or
     (THackDBGrid(Dbg_FinanDemonsResultPlanDemons).SelectedIndex = 1) then
  begin
    THackDBGrid(Dbg_FinanDemonsResultPlanDemons).LeftCol:=3;
    THackDBGrid(Dbg_FinanDemonsResultPlanDemons).SelectedIndex:=2;
    Dbg_FinanDemonsResultPlanDemons.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanDemonsResultPlanDemonsColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanDemonsResultPlanDemonsColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanDemonsResultPlanDemonsDrawColumnCell(Sender: TObject;
          const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin

  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanDemonsResultPlanDemonsColEnter(Self);

  // Acerta Apresentacao --------------------------------------------
  if not (gdSelected in State) Then
  Begin
    if DMVirtual.CDS_V_PlanDemonsResultadosCod_Demonstrativo.AsString<>'' Then
    Begin
      Dbg_FinanDemonsResultPlanDemons.Canvas.Font.Style:=[fsBold];
    end;

    if DMVirtual.CDS_V_PlanDemonsResultadosCod_Demonstrativo.AsString='' Then
    Begin
      Dbg_FinanDemonsResultPlanDemons.Canvas.Brush.Color:=clWindow;
    end;

    if Copy(DMVirtual.CDS_V_PlanDemonsResultadosDes_Demonstrativo.AsString,1,8)='Perodo ' Then
    Begin
      Dbg_FinanDemonsResultPlanDemons.Canvas.Font.Style:=[fsBold];
    end;

    Dbg_FinanDemonsResultPlanDemons.Canvas.FillRect(Rect);
    Dbg_FinanDemonsResultPlanDemons.DefaultDrawDataCell(Rect,Column.Field,state);
  End;
  
end;

procedure TFrmBelShop.Dbg_FinanDemonsResultPlanDemonsDrawDataCell(Sender: TObject;
          const Rect: TRect; Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_PlanDemonsResultados.IsEmpty Then
  Begin
    if (THackDBGrid(Dbg_FinanDemonsResultPlanDemons).SelectedIndex = 0) Or
       (THackDBGrid(Dbg_FinanDemonsResultPlanDemons).SelectedIndex = 1) then
    begin
      THackDBGrid(Dbg_FinanDemonsResultPlanDemons).FixedCols:=3;
      THackDBGrid(Dbg_FinanDemonsResultPlanDemons).LeftCol:=3;
      THackDBGrid(Dbg_FinanDemonsResultPlanDemons).SelectedIndex:=2;
      Dbg_FinanDemonsResultPlanDemons.Refresh;
    end;
  End;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultPlanDemonsVoltarClick(Sender: TObject);
begin
  // Posiciona no TabSheet =====================================================
  PC_FinanComprPlanFinan.ActivePage:=Ts_FinanComprPlanFinanPlanilhaFinanceira;
  PC_FinanComprPlanFinanChange(Self);
  Dbg_FinanPlanFinanceira.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultPlanDemonsSalvarClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_PlanDemonsResultados.IsEmpty Then
  Begin
    Dbg_FinanDemonsResultPlanDemons.SetFocus;
    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_PlanDemonsResultados,Dbg_FinanDemonsResultPlanDemons,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.Bt_FinanDemonsResultPlanDemonsTamColunasClick(Sender: TObject);
Var
 i: Integer;
begin
  If (DMVirtual.CDS_V_PlanDemonsResultados.IsEmpty) and (DMVirtual.CDS_V_PlanDemonsResultados.Filter='') Then
   Exit;

  // Tamanho Colunas No FIXADAS ===============================================
  For i:=2 to Dbg_FinanDemonsResultPlanDemons.Columns.Count-1 do
  Begin
    Dbg_FinanDemonsResultPlanDemons.Columns[i].Width:=EdtFinanDemonsResultTamColunasNaoFixadas.AsInteger;
  End;

  // Tamanho Colunas FIXADAS ===================================================
  For i:=0 to 1 do
  Begin
    If i=0 Then
     Dbg_FinanDemonsResultPlanDemons.Columns[i].Width:=EdtFinanDemonsResultTamColunas1.AsInteger;

    If i=1 Then
     Dbg_FinanDemonsResultPlanDemons.Columns[i].Width:=EdtFinanDemonsResultTamColunas2.AsInteger;

  End;

  // Posiciona no Grid =========================================================
  Dbg_FinanDemonsResultPlanDemons.SetFocus;
end;

procedure TFrmBelShop.PC_CurvaABCEnderecamentosChange(Sender: TObject);
Var
  MySql: String;
begin
  CorSelecaoTabSheet(PC_CurvaABCEnderecamentos);

  If (PC_CurvaABCEnderecamentos.ActivePage=Ts_CurvaABCEndMantencao) And (Ts_CurvaABCEndMantencao.CanFocus) Then
   Cbx_CurvaABCEndSituacaoProd.SetFocus;


  If (PC_CurvaABCEnderecamentos.ActivePage=Ts_CurvaABCEndCurvaABC) And (Ts_CurvaABCEndCurvaABC.CanFocus) Then
  Begin
    Bt_CurvaABCEndVoltar.Parent:=Pan_CurvaABCEndABC;
    Dbg_CurvaABCEndCurvaABC.SetFocus;
  End;

  If (PC_CurvaABCEnderecamentos.ActivePage=Ts_CurvaABCEnderecamentos) And (Ts_CurvaABCEnderecamentos.CanFocus) Then
  Begin
    Bt_CurvaABCEndVoltar.Parent:=Pan_CurvaABCEndEndereca;

    Cbx_CurvaABCEndZona.SetFocus;

    EdtCurvaABCEndTotGavetas.AsInteger:=0;
    EdtCurvaABCEndTotGavLivres.AsInteger:=0;
    
    EdtCurvaABCEndTotGavA.AsInteger:=0;
    EdtCurvaABCEndTotGavLivresA.AsInteger:=0;
    EdtCurvaABCEndTotGavB.AsInteger:=0;
    EdtCurvaABCEndTotGavLivresB.AsInteger:=0;
    EdtCurvaABCEndTotGavC.AsInteger:=0;
    EdtCurvaABCEndTotGavLivresC.AsInteger:=0;

    // Totais de Gavetas =========================================================
    MySql:=' Select e.tip_curvaabc, count(e.cod_prateleira) Gavetas'+
           ' From ce_enderecamentos e'+
           ' Group by e.tip_curvaabc';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    While Not DMBelShop.CDS_BuscaRapida.Eof do
    Begin
      EdtCurvaABCEndTotGavetas.AsInteger:=EdtCurvaABCEndTotGavetas.AsInteger+
                       DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;

      If DMBelShop.CDS_BuscaRapida.FieldByName('tip_curvaabc').AsString='A' Then
       EdtCurvaABCEndTotGavA.AsInteger:=DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;
                     
      If DMBelShop.CDS_BuscaRapida.FieldByName('tip_curvaabc').AsString='B' Then
       EdtCurvaABCEndTotGavB.AsInteger:=DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;

      If DMBelShop.CDS_BuscaRapida.FieldByName('tip_curvaabc').AsString='C' Then
       EdtCurvaABCEndTotGavC.AsInteger:=DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;

      DMBelShop.CDS_BuscaRapida.Next;
    End;
    DMBelShop.CDS_BuscaRapida.Close;
         
    // Totais de Gavetas Livres ==================================================
    MySql:=' Select e.tip_curvaabc, count(e.cod_prateleira) Gavetas'+
           ' From ce_enderecamentos e'+
           ' Where e.cod_produto is null'+
           ' Group by e.tip_curvaabc';
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    While Not DMBelShop.CDS_BuscaRapida.Eof do
    Begin
      EdtCurvaABCEndTotGavLivres.AsInteger:=EdtCurvaABCEndTotGavLivres.AsInteger+
                       DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;

      If DMBelShop.CDS_BuscaRapida.FieldByName('tip_curvaabc').AsString='A' Then
       EdtCurvaABCEndTotGavLivresA.AsInteger:=DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;
                     
      If DMBelShop.CDS_BuscaRapida.FieldByName('tip_curvaabc').AsString='B' Then
       EdtCurvaABCEndTotGavLivresB.AsInteger:=DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;

      If DMBelShop.CDS_BuscaRapida.FieldByName('tip_curvaabc').AsString='C' Then
       EdtCurvaABCEndTotGavLivresC.AsInteger:=DMBelShop.CDS_BuscaRapida.FieldByName('Gavetas').AsInteger;

      DMBelShop.CDS_BuscaRapida.Next;
    End;
    DMBelShop.CDS_BuscaRapida.Close;
  End; // If (PC_CurvaABCEnderecamentos.ActivePage=Ts_CurvaABCEnderecamentos) And (Ts_CurvaABCEnderecamentos.CanFocus) Then
end;

procedure TFrmBelShop.Bt_CurvaABCEndCalculoCurvaABCClick(Sender: TObject);
Var
  i: Integer;
begin
  //Zona:  Tamanho Ilimitado caracteres Numricos (Inteiros)
  //Corredor: Tamanho "OBRIGATRIO" 3 caracteres AlfaNumericos
  //Prateleira: Tamanho  "OBRIGATRIO"  3 caracteres AlfaNumericos
  //Gaveta Tamanho  "OBRIGATRIO"  3 caracteres AlfaNumericos

  EdtCurvaABCEndTotalProdutos.Value:=0;
  EdtCurvaABCEndTotalProc.Value:=0;
  EdtCurvaABCEndLimiteCurvaA.SetFocus;

  bgUsaFornecedores:=False; // Seu Utiliza Seleo de Fornecedor
  sCbx_SituacaoProd:=''; // Deve ser sempre Index =2 (Ativo/No Compra)

  // Verifica Valores da Curva ABC =============================================
  If EdtCurvaABCEndLimiteCurvaA.AsInteger=0 Then
  Begin
    msg('Favor Informar o Limite para Curva "A" !!','A');
    EdtCurvaABCEndLimiteCurvaA.SetFocus;
    Exit;
  End;

  If EdtCurvaABCEndCodLista.Value<1 Then
  Begin
    msg('Favor Informar a Lista de Preos !!','A');
    EdtCurvaABCEndCodLista.SetFocus;
    Exit;
  End;

  i:=EdtCurvaABCEndLimiteCurvaA.AsInteger+
     EdtCurvaABCEndLimiteCurvaB.AsInteger+
     EdtCurvaABCEndLimiteCurvaC.AsInteger+
     EdtCurvaABCEndLimiteCurvaD.AsInteger+
     EdtCurvaABCEndLimiteCurvaE.AsInteger;
  If i<>100 Then
  Begin
    msg('Total da Distribuio dos Percentuais'+cr+'da Curva NO Fecham 100% !!','A');
    EdtCurvaABCEndLimiteCurvaA.SetFocus;
    Exit;
  End;

  // Verifica Perodo ==========================================================
  If (Trim(DtEdt_CurvaABCEndInicio.Text)<>'') Or (Trim(DtEdt_CurvaABCEndFim.Text)<>'') Then
  Begin
    Try
      StrToDate(DtEdt_CurvaABCEndInicio.Text);
    Except
      msg('Data Inicial do Perodo Invlida !!','A');
      DtEdt_CurvaABCEndInicio.SetFocus;
      Exit;
    End;

    Try
      StrToDate(DtEdt_CurvaABCEndFim.Text);
    Except
      msg('Data Final do Perodo Invlida !!','A');
      DtEdt_CurvaABCEndFim.SetFocus;
      Exit;
    End;

    If DtEdt_CurvaABCEndFim.Date<DtEdt_CurvaABCEndInicio.Date Then
    Begin
      msg('Perodo Invlido !!','A');
      DtEdt_CurvaABCEndInicio.SetFocus;
      Exit;
    End;
  End
  Else // If (Trim(DtEdt_CurvaABCEndInicio.Text)<>'') Or (Trim(DtEdt_CurvaABCEndFim.Text)<>'') Then
  Begin
    msg('Perodo Invlido !!','A');
    DtEdt_CurvaABCEndInicio.SetFocus;
    Exit;
  End; // If (Trim(DtEdt_CurvaABCEndInicio.Text)<>'') Or (Trim(DtEdt_CurvaABCEndFim.Text)<>'') Then

  If DtEdt_CurvaABCEndInicio.Date<StrToDate('01/01/2011') Then
  Begin
    msg('Data de Incio deve Ser'+cr+'MAIOR que 31/12/2010 !!','A');
    DtEdt_CurvaABCEndInicio.SetFocus;
    Exit;
  End; // If DtEdt_CurvaABCEndInicio.Date<StrToDate('01/01/2011') Then

  If Cbx_CurvaABCEndSituacaoProd.ItemIndex=-1 Then
  Begin
    msg('Favor Informar a Situaes dos Produtos !!','A');
    Cbx_CurvaABCEndSituacaoProd.SetFocus;
    Exit;
  End; // If Cbx_CurvaABCEndSituacaoProd.ItemIndex=-1 Then

  // Verifica Continuidade =====================================================
  If Not DMVirtual.CDS_V_CurvaABCEndereco.IsEmpty Then
  Begin
    If msg('Deseja ReCalcular a Curva ABC ??','C')=2 Then
     Exit;

    DMVirtual.CDS_V_CurvaABCEndereco.Close;
  End;

  // Grupos e SubGrupos Selecionados ===========================================
  sgGrupos:='';
  sgSubGrupos:='';
  If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GruposProdutos.First;
    While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    Begin
      Refresh;

      If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
       Begin
         While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
         Begin
           Refresh;

           If sgSubGrupos='' Then
            sgSubGrupos:=QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString)
           Else
            sgSubGrupos:=sgSubGrupos+', '+
              QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString);

           DMVirtual.CDS_V_SubGruposProdutos.Next;
         End; // While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
         DMVirtual.CDS_V_SubGruposProdutos.First;
       End // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
      Else
       Begin
         If sgGrupos='' Then
          sgGrupos:='(p.codgruposub BetWeen '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'0000')+
                ' AND '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'9999')+')'
         Else
          sgGrupos:=sgGrupos+' Or (p.codgruposub BetWeen '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'0000')+
                ' AND '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'9999')+')';
       End; // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then

      If sgSubGrupos<>'' Then
      Begin
        If sgGrupos='' Then
         sgGrupos:='(p.codgruposub in ('+sgSubGrupos+'))'
        Else
         sgGrupos:=sgGrupos+' OR (p.codgruposub in ('+sgSubGrupos+'))';
      End;

      sgSubGrupos:='';

      DMVirtual.CDS_V_GruposProdutos.Next;
    End; // While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    DMVirtual.CDS_V_GruposProdutos.First;

    If sgGrupos<>'' Then
     sgGrupos:='('+sgGrupos+')';
  End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then

  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Aplicacoes Selecionadas ===================================================
  sgAplicacoes:='';
  If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then
  Begin

    DMVirtual.CDS_V_Aplicacao.First;
    While Not DMVirtual.CDS_V_Aplicacao.Eof do
    Begin
      Refresh;

      If sgAplicacoes='' Then
       sgAplicacoes:=QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString)
      Else
       sgAplicacoes:=sgAplicacoes+', '+
                     QuotedStr(DMVirtual.CDS_V_AplicacaoCod_Aplicacao.AsString);

      DMVirtual.CDS_V_Aplicacao.Next;
    End; // While Not DMVirtual.CDS_V_Aplicacao.Eof do
    DMVirtual.CDS_V_Aplicacao.First;
  End; // If Not DMVirtual.CDS_V_Aplicacao.IsEmpty Then

  // Processa Curva ABC ========================================================
  If Not CalculaCurvaABCEndereco Then
   Exit;

  If Trim(sgFornecedores)<>'' Then
   bgUsaFornecedores:=True; // Seu Utiliza Seleo de Fornecedor

  sCbx_SituacaoProd:=IntToStr(Cbx_CurvaABCEndSituacaoProd.ItemIndex); // Deve ser sempre Idex =2 (Ativo/No Compra)

  bgProcessar:=True; // Se Executa Update na Curva ABC para 'E' em todos os Produtos

  PC_CurvaABCEnderecamentos.TabIndex:=1;
  Dbg_CurvaABCEndCurvaABC.SetFocus;
  EdtCurvaABCEndTotalProc.Value:=0;

  DMVirtual.CDS_V_CurvaABCEndereco.First;

  msg('Calculo da Curva ABC '+cr+'Efetuado com SUCESSO !!','A');

  // Apresenta Lojas No Conectadas ============================================
  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

end;

procedure TFrmBelShop.Bt_CurvaABCEndVoltarClick(Sender: TObject);
begin
  PC_CurvaABCEnderecamentos.TabIndex:=0;
  PC_CurvaABCEnderecamentosChange(Self);
  EdtCurvaABCEndLimiteCurvaA.SetFocus;

end;

procedure TFrmBelShop.Rb_CurvaABCEndTipoCalculoUnidadesClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_CurvaABCEndTipoCalculoUnidades);
  AcertaRb_Style(Rb_CurvaABCEndTipoCalculoValores);
end;

procedure TFrmBelShop.Dbg_FinanDemonsResultPlanDemonsKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  // Acerta Posicio na Celula ================================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanDemonsResultPlanDemons).SelectedIndex = 2) then
  Begin
    Key := VK_Clear;
    Dbg_FinanDemonsResultPlanDemons.Refresh;
  End;
end;

procedure TFrmBelShop.Bt_FinanPlanoContasCP200FecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);
end;

procedure TFrmBelShop.SubMenuFinanPlanodeContasComprov200Click(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  SelecionaTabSheet(Ts_FinanPlanoContasCompr200);

  Dbg_FinanPlanoContasCompr200.SetFocus;

end;

procedure TFrmBelShop.Dbg_FinanPlanoContasCompr200ColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanPlanoContasCompr200).SelectedIndex=0) Then
  begin
    THackDBGrid(Dbg_FinanPlanoContasCompr200).LeftCol:=2;
    THackDBGrid(Dbg_FinanPlanoContasCompr200).SelectedIndex:=1;
    Dbg_FinanPlanoContasCompr200.Refresh;
  end;
end;

procedure TFrmBelShop.Dbg_FinanPlanoContasCompr200ColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanPlanoContasCompr200ColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanPlanoContasCompr200DrawDataCell(Sender: TObject;
          const Rect: TRect; Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty Then
  Begin
    if (THackDBGrid(Dbg_FinanPlanoContasCompr200).SelectedIndex=0) Then
    begin
      THackDBGrid(Dbg_FinanPlanoContasCompr200).FixedCols:=2;
      THackDBGrid(Dbg_FinanPlanoContasCompr200).LeftCol:=2;
      THackDBGrid(Dbg_FinanPlanoContasCompr200).SelectedIndex:=1;
      Dbg_FinanPlanoContasCompr200.Refresh;
    end;
  End;

end;

procedure TFrmBelShop.Dbg_FinanPlanoContasCompr200KeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  // Acerta Posicio na Celula ================================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanPlanoContasCompr200).SelectedIndex=1) then
  Begin
    Key := VK_Clear;
    Dbg_FinanPlanoContasCompr200.Refresh;
  End;
end;

procedure TFrmBelShop.Dbg_FinanPlanoContasCompr200DrawColumnCell(Sender: TObject;
          const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin

  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanPlanoContasCompr200ColEnter(Self);

  // Acerta Apresentacao --------------------------------------------
  if not (gdSelected in State) Then
  Begin
    If (Copy(DMVirtual.CDS_V_PlanoContasCompr200Des_PlanoContas.AsString,1,1)=' ') And
       (DMVirtual.CDS_V_PlanoContasCompr200Des_PlanoContas.AsString<>'') Then
    Begin
      Dbg_FinanPlanoContasCompr200.Canvas.Font.Style:=[fsBold];
      Dbg_FinanPlanoContasCompr200.Canvas.Brush.Color:=clSkyBlue;
    End;

    If (DMVirtual.CDS_V_PlanoContasCompr200Des_PlanoContas.AsString)='-- TOTAL GERAL --' Then
    Begin
      Dbg_FinanPlanoContasCompr200.Canvas.Font.Style:=[fsBold];
      Dbg_FinanPlanoContasCompr200.Canvas.Brush.Color:=clMoneyGreen;
    End;

    Dbg_FinanPlanoContasCompr200.Canvas.FillRect(Rect);
    Dbg_FinanPlanoContasCompr200.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Bt_FinanPlanoContasCP200CalcularClick(Sender: TObject);
Var
  i: Integer;
  Cor: TColor;
begin

  Dbg_FinanPlanoContasCompr200.SetFocus;

  // Seleciona Empresa =========================================================
  sgOutrasEmpresa:='';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;

  FrmSelectEmpProcessamento.ShowModal;
  iNrConexoes:=FrmSelectEmpProcessamento.iNrEmpProc;
  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Existe Empresa a Processar ====================================
  If DMBelShop.CDS_EmpProcessa.Eof Then
  Begin
    Dbg_FinanPlanoContasCompr200.SetFocus;
    Exit;
  End;

  // Solicita o Perodo ========================================================
  bgSiga:=False;
  FrmPeriodoApropriacao:=TFrmPeriodoApropriacao.Create(Self);
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Text:=
                      DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Text   :=
                      DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmPeriodoApropriacao.ShowModal;

  sgDtaInicio:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Date);
  sgDtaFim:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Date);
  FreeAndNil(FrmPeriodoApropriacao);

  // Verifica se Prossegue Processamento =======================================
  If bgSiga Then
  Begin
    // Acerta Periodo -----------------------------------------------
    EdtFinanPlanoContasCP200Periodo.Text:='Perodo de '+sgDtaInicio+' a '+sgDtaFim; 

    // Cria ClientDataSet -------------------------------------------
    If DMVirtual.CDS_V_PlanoContasCompr200.Active Then
     DMVirtual.CDS_V_PlanoContasCompr200.Close;
     
    DMVirtual.CDS_V_PlanoContasCompr200.CreateDataSet;
    DMVirtual.CDS_V_PlanoContasCompr200.Open;
    DMVirtual.CDS_V_PlanoContasCompr200.Filtered:=False;
    DMVirtual.CDS_V_PlanoContasCompr200.Filter:='';

    // Apresenta o Processamento ------------------------------------
    OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
    OdirPanApres.Visible:=True;
    Refresh;

    // Acerta CDS_V_PlanFinanceira ----------------------------------
    For i:=0 to DMVirtual.CDS_V_PlanoContasCompr200.Fields.Count-1 do
    Begin
      DMVirtual.CDS_V_PlanoContasCompr200.Fields[i].Visible:=False;
      DMVirtual.CDS_V_PlanoContasCompr200.Fields[i].DisplayLabel:=
                        DMVirtual.CDS_V_PlanoContasCompr200.Fields[i].FieldName;
    End;
    DMVirtual.CDS_V_PlanoContasCompr200.Fields[0].Visible:=True;

    // Monta Planilha de Plano de Contas ----------------------------
    Cor:=$00E1FFFF;
    DMBelShop.CDS_EmpProcessa.First;
    While Not DMBelShop.CDS_EmpProcessa.Eof do
    Begin
      Refresh;

      if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
      Begin
        i:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsInteger;

        If Cor=$00E1FFFF Then
         Cor:=$00F2F9F9
        Else
         Cor:=$00E1FFFF;

        // Acerta Titulo no ClientDataSet ---------------------------
        DMVirtual.CDS_V_PlanoContasCompr200.Fields[i].Visible:=True;
        DMVirtual.CDS_V_PlanoContasCompr200.Fields[i].DisplayLabel:='Bel_'+
                                    DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

        // Libera e Acerta Cor da Coluna no Grid =================================
        Dbg_FinanPlanoContasCompr200.Columns[Dbg_FinanPlanoContasCompr200.Columns.Count-1].Color:=Cor;
        Dbg_FinanPlanoContasCompr200.Columns[Dbg_FinanPlanoContasCompr200.Columns.Count-1].Width:=85;
        Dbg_FinanPlanoContasCompr200.Columns[Dbg_FinanPlanoContasCompr200.Columns.Count-1].Title.Alignment:=taRightJustify;
      End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

      DMBelShop.CDS_EmpProcessa.Next;
    End; // While Not DMBelShop.CDS_EmpProcessa.Eof do
    DMBelShop.CDS_EmpProcessa.First;

    // Acerta Coluna de Totais --------------------------------------
    If Cor=$00E1FFFF Then
     Cor:=$00F2F9F9
    Else
     Cor:=$00E1FFFF;

    // Acerta Titulo no CDS_V_PlanoContasCompr200 -------------------
    DMVirtual.CDS_V_PlanoContasCompr200.Fields[0].DisplayLabel:='';
    Dbg_FinanPlanoContasCompr200.Columns[0].Width:=200;

    // Libera e Acerta Cor da Coluna no Grid ------------------------
    DMVirtual.CDS_V_PlanoContasCompr200.Fields[33].Visible:=True;
    DMVirtual.CDS_V_PlanoContasCompr200.Fields[33].DisplayLabel:='EMPRESA';

    Dbg_FinanPlanoContasCompr200.Columns[Dbg_FinanPlanoContasCompr200.Columns.Count-1].Color:=Cor;
    Dbg_FinanPlanoContasCompr200.Columns[Dbg_FinanPlanoContasCompr200.Columns.Count-1].Title.Alignment:=taRightJustify;
    Dbg_FinanPlanoContasCompr200.Columns[Dbg_FinanPlanoContasCompr200.Columns.Count-1].Width:=90;
    Dbg_FinanPlanoContasCompr200.Columns[Dbg_FinanPlanoContasCompr200.Columns.Count-1].Visible:=True;
              
    THackDBGrid(Dbg_FinanPlanoContasCompr200).FixedCols:=2;
    
    // Tamanho das Colunas ------------------------------------------
    EdtFinanPlanoContasCP200TamColunas1.Value:=Dbg_FinanPlanoContasCompr200.Columns[0].Width;
    EdtFinanPlanoContasCP200TamColunasNaoFixadas.Value:=Dbg_FinanPlanoContasCompr200.Columns[1].Width;

    // Grava em CDS_V_PlanoContasCompr200 ===========================          
    // Linhas Iniciais ----------------------------------------------
    DMVirtual.CDS_V_PlanoContasCompr200.Append;
    DMVirtual.CDS_V_PlanoContasCompr200Des_PlanoContas.AsString:='';
    DMVirtual.CDS_V_PlanoContasCompr200.Post;

    // Perodo ------------------------------------------------------
    DMVirtual.CDS_V_PlanoContasCompr200.Append;
    DMVirtual.CDS_V_PlanoContasCompr200Des_PlanoContas.AsString:=' '+sgDtaInicio+' a '+sgDtaFim;
    DMVirtual.CDS_V_PlanoContasCompr200.Post;

    THackDBGrid(Dbg_FinanPlanoContasCompr200).FixedCols:=2;

    // Processa Empresas Selecionadas ==========================================
    PlanoContasEmpresasCP200;

    OdirPanApres.Visible:=False;

    msg('Processamento Efetuado com Sucesso !!','A');
    Dbg_FinanPlanoContasCompr200.SetFocus;
    
    // Apresenta Lojas No Conectadas ============================================
    If sgLojasNConectadas<>'' Then
     msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

  End; // If bgSiga Then // Verifica se Prossegue Processamento
  
end;

procedure TFrmBelShop.Bt_FinanPlanoContasCP200SalvarClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_PlanoContasCompr200.IsEmpty Then
  Begin
    Dbg_FinanPlanoContasCompr200.SetFocus;
    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_PlanoContasCompr200,Dbg_FinanPlanoContasCompr200,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.Bt_FinanPlanoContasCP200TamColunasClick(Sender: TObject);
Var
  i: Integer;  
begin
  If DMVirtual.CDS_V_PlanoContasCompr200.IsEmpty Then
   Exit;

  // Tamanho Colunas No FIXADAS ===============================================
  For i:=1 to Dbg_FinanPlanoContasCompr200.Columns.Count-1 do
  Begin
    Dbg_FinanPlanoContasCompr200.Columns[i].Width:=EdtFinanPlanoContasCP200TamColunasNaoFixadas.AsInteger;
  End;

  // Tamanho Colunas FIXADAS =================================================== 
  Dbg_FinanPlanoContasCompr200.Columns[0].Width:=EdtFinanPlanoContasCP200TamColunas1.AsInteger;

  // Posiciona no Grid =========================================================
  THackDBGrid(Dbg_FinanPlanoContasCompr200).FixedCols:=2;
  Dbg_FinanPlanoContasCompr200.SetFocus;

end;

procedure TFrmBelShop.SubMenuFinanObjetivosClick(Sender: TObject);
Var
  MySql: String;
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  // Busca Objetivos ===========================================================
  If DMBelShop.CDS_Objetivos.Active Then
   DMBelShop.CDS_Objetivos.Close;

  DMBelShop.CDS_Objetivos.Open;

  // Busca Empresa  ============================================================
  MySql:=' Select e.cod_filial, e.razao_social, e.Cod_Linx'+
         ' From emp_conexoes e'+
         ' Where ((e.ind_ativo=''SIM'') or (e.tip_emp=''M''))'+
         ' Order By e.cod_filial';
  DMBelShop.CDS_ObjetivosEmpresas.Close;
  DMBelShop.SDS_ObjetivosEmpresas.CommandText:=MySql;
  DMBelShop.CDS_ObjetivosEmpresas.Open;
 
  // Acerta Mes/Ano ============================================================
  Cbx_FinanObjetivosGerarMes.Text:=LongMonthNames[MonthOf(Date)];
  EdtFinanObjetivosGerarAno.Value:=YearOf(Date);
  Cbx_FinanObjetivosGerarMesChange(Self);

  // Apresenta TabSheet ========================================================
  PC_FinanObjetivos.TabIndex:=0;
  EdtFinanObjetivosAno.AsInteger:=StrToInt(Copy(DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)),7,4));
  EdtFinanObjetivosMeses.AsInteger:=12;

  Ts_FinanObjetivosGraficos.TabVisible:=False;
  SelecionaTabSheet(Ts_FinanObjetivos);
  CorSelecaoTabSheet(PC_Principal);

  // Verifica Existencia de Objetivos ==========================================
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

  // Acerta Tamanho da Coluna do Grid ========================================== 
  Dbg_FinanObjetivosManutEmpresas.Columns[1].Width:=
                                          Dbg_FinanObjetivosManutEmpresas.Width-
                          (Dbg_FinanObjetivosManutEmpresas.Columns[0].Width+92);
  Dbg_FinanObjetivosManut.SetFocus;

end;

procedure TFrmBelShop.PC_FinanObjetivosChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_FinanObjetivos);

end;

procedure TFrmBelShop.Bt_FinanObjetivosFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutAtivoClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanObjetivosManutAtivo);

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutVlrFixoClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanObjetivosManutVlrFixo);

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutVlrFixoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosManutVlrFixoClick(Self);
end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutAtivoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosManutAtivoClick(Self);

end;

procedure TFrmBelShop.Bt_FinanObjetivosNovoClick(Sender: TObject);
Var
  MySql: String;
begin
  MySql:=' Select Coalesce(max(f.COD_OBJETIVO)+1 ,1) Cod_Objetivo'+
         ' From FIN_OBJETIVOS f';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;
  sgCodigo:=DMBelShop.CDS_Busca.FieldByName('Cod_Objetivo').AsString;
  DMBelShop.CDS_Busca.Close;
            
  DMBelShop.CDS_Objetivos.Insert;
  DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString:=sgCodigo;
  DMBelShop.CDS_ObjetivosIND_OPERACAO.AsInteger:=3;
  DMBelShop.CDS_ObjetivosIND_FIXO.AsString:='NAO';
  DMBelShop.CDS_ObjetivosNUM_DECIMAIS.AsInteger:=0;
  DMBelShop.CDS_ObjetivosIND_ATIVO.AsString:='SIM';
  DMBelShop.CDS_ObjetivosULT_12_MESES.AsString:='NAO';
  DMBelShop.CDS_ObjetivosUSU_INCLUI.AsString:=Cod_Usuario;
  DMBelShop.CDS_ObjetivosDTA_INCLUI.AsDateTime:=
                               DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);

  If DMBelShop.CDS_Objetivos.Active Then                             
   DMBelShop.CDS_ObjetivosAfterScroll(DMBelShop.CDS_Objetivos);

  Pan_FinanObjetivosManut.Enabled:=True;
  Bt_FinanObjetivosManutSalvar.Enabled:=True;
  Bt_FinanObjetivosManutAbandonar.Enabled:=True;

  Gb_FinanObjetivosManutObjetivos.Enabled:=True;
  Bt_FinanObjetivosManutObjetivos.Enabled:=False;
  Bt_FinanObjetivosManutObjetivosSalvar.Enabled:=False;
  Bt_FinanObjetivosManutObjetivosAbandonar.Enabled:=False;

  Bt_FinanObjetivosNovo.Enabled:=False;
  Bt_FinanObjetivosAlterar.Enabled:=False;
  Bt_FinanObjetivosExcluir.Enabled:=False;
  Bt_FinanObjetivosGeraObjetivos.Enabled:=False;
  Bt_FinanObjetivosFechar.Enabled:=False;
  Dbg_FinanObjetivosManut.Enabled:=False;

  StBar_FinanObjetivosManutCalculaObjetivo.Visible:=True;
  Bt_FOSoma.Enabled:=False;
  
  // Fecha TabSheets ===========================================================
  Ts_FinanObjetivosResultadosDias.TabVisible:=False;
  Ts_FinanObjetivosResultadosMeses.TabVisible:=False;
  Ts_FinanObjetivosGraficos.TabVisible:=False;
  
  // Verifica Existencia de Objetivos ==========================================
  DMBelShop.CDS_ObjetivosMetas.Close;
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

  Dbe_FinanObjetivosManutDesObjetivo.SetFocus;

  // Abre Transao ============================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutAbandonarClick(Sender: TObject);
begin
  // DMBelShop.SQLC.StartTransaction(TD) em Bt_FinanObjetivosNovo/Bt_FinanObjetivosAlterar

  // Fecha Transao ===========================================================
  If (DMBelShop.CDS_Objetivos.State=dsEdit) or (DMBelShop.CDS_Objetivos.State=dsInsert) Then
   DMBelShop.CDS_Objetivos.CancelUpdates;

  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);
   
  DateSeparator:='/';
  DecimalSeparator:=',';
  Screen.Cursor:=crDefault;

  // Reabre Objetivos ==========================================================
  DMBelShop.CDS_Objetivos.Close;
  DMBelShop.CDS_Objetivos.IndexFieldNames:='';
  DMBelShop.CDS_Objetivos.Open;

  If sgCodigo<>'' Then
   DMBelShop.CDS_Objetivos.Locate('COD_OBJETIVO',sgCodigo,[]);

  // Fecha TabSheets ===========================================================
  Ts_FinanObjetivosResultadosDias.TabVisible:=True;
  Ts_FinanObjetivosResultadosMeses.TabVisible:=True;

  // Retorna ===================================================================
  Pan_FinanObjetivosManut.Enabled:=False;
  Bt_FinanObjetivosManutSalvar.Enabled:=False;
  Bt_FinanObjetivosManutAbandonar.Enabled:=False;
  Bt_FinanObjetivosManutObjetivosSalvar.Enabled:=False;
  Bt_FinanObjetivosManutObjetivos.Enabled:=False;

  Bt_FinanObjetivosNovo.Enabled:=True;
  Bt_FinanObjetivosAlterar.Enabled:=True;
  Bt_FinanObjetivosExcluir.Enabled:=True;
  Bt_FinanObjetivosGeraObjetivos.Enabled:=True;
  Bt_FinanObjetivosFechar.Enabled:=True;
  Dbg_FinanObjetivosManut.Enabled:=True;

  Bt_FOSoma.Enabled:=False;

  StBar_FinanObjetivosManutCalculaObjetivo.Visible:=False;

  Dbg_FinanObjetivosManut.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanObjetivosAlterarClick(Sender: TObject);
begin
  If DMBelShop.CDS_Objetivos.IsEmpty Then
   Exit;
   
  sgCodigo:=DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;

  DMBelShop.CDS_Objetivos.Edit;

  Pan_FinanObjetivosManut.Enabled:=True;
  Bt_FinanObjetivosManutSalvar.Enabled:=True;
  Bt_FinanObjetivosManutAbandonar.Enabled:=True;

  Gb_FinanObjetivosManutObjetivos.Enabled:=True;
  Bt_FinanObjetivosManutObjetivos.Enabled:=False;
  Bt_FinanObjetivosManutObjetivosSalvar.Enabled:=False;
  Bt_FinanObjetivosManutObjetivosAbandonar.Enabled:=False;

  Bt_FinanObjetivosNovo.Enabled:=False;
  Bt_FinanObjetivosAlterar.Enabled:=False;
  Bt_FinanObjetivosExcluir.Enabled:=False;
  Bt_FinanObjetivosGeraObjetivos.Enabled:=False;
  Bt_FinanObjetivosFechar.Enabled:=False;
  Dbg_FinanObjetivosManut.Enabled:=False;

  StBar_FinanObjetivosManutCalculaObjetivo.Visible:=True;

  Gb_FinanObjetivosManutTpOperacao.Enabled:=True;
  Ckb_FinanObjetivosManutNaoCompra.Enabled:=True;
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    Gb_FinanObjetivosManutTpOperacao.Enabled:=False;
    Ckb_FinanObjetivosManutNaoCompra.Enabled:=False;
  End;

  Bt_FOSoma.Enabled:=True;

  // Fecha TabSheets ===========================================================
  Ts_FinanObjetivosResultadosDias.TabVisible:=False;
  Ts_FinanObjetivosResultadosMeses.TabVisible:=False;
  Ts_FinanObjetivosGraficos.TabVisible:=False;

  // Verifica Existencia de Objetivos ==========================================
  DMBelShop.CDS_ObjetivosMetas.Close;
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

  Dbe_FinanObjetivosManutDesObjetivo.SetFocus;

  // Abre Transao ============================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  
end;

procedure TFrmBelShop.Bt_FinanObjetivosExcluirClick(Sender: TObject);
Var
  MySql: String;
  i: Integer;
begin
  If DMBelShop.CDS_Objetivos.IsEmpty Then
   Exit;

  If msg('Deseja Realmente EXCLUIR o'+cr+cr+'Objetivo Selecionado ??','C')=2 Then
  Begin
    Dbg_FinanObjetivosManut.SetFocus;
    Exit;
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    MySql:='Delete From FIN_OBJETIVOS_METAS'+
           ' Where COD_OBJETIVO='+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
    DMBelShop.SQLC.Execute(MySql, nil, nil);

    MySql:='Delete From FIN_OBJETIVOS'+
           ' Where COD_OBJETIVO='+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
    DMBelShop.SQLC.Execute(MySql, nil, nil);

    // Acerta Ordem de Apresentacao na Planilha Financeira ----------
    MySql:='select COD_OBJETIVO, DES_OBJETIVO'+
           ' from FIN_OBJETIVOS'+
           ' order by num_ordem';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    i:=0;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin

      Inc(i);

      MySql:='Update FIN_OBJETIVOS'+
             ' Set NUM_ORDEM='+IntToStr(i)+
             ' Where COD_OBJETIVO='+DMBelShop.CDS_Busca.FieldByName('COD_OBJETIVO').AsString;
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    DMBelShop.CDS_Busca.Close;

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

    DMBelShop.CDS_Objetivos.Close;
    DMBelShop.CDS_Objetivos.IndexFieldNames:='';
    DMBelShop.CDS_Objetivos.Open;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutSalvarClick(Sender: TObject);
Var
  MySql: String;
  i: Integer;
  s: String;
begin
  // DMBelShop.SQLC.StartTransaction(TD) em Bt_FinanObjetivosNovo/Bt_FinanObjetivosAlterar

  If Dbe_FinanObjetivosManutDesObjetivo.Text='' Then
  Begin
    msg('Favor Informar a Descrio !!','A');
    Dbe_FinanObjetivosManutDesObjetivo.SetFocus;
    Exit;
  End;

  If Dbe_FinanObjetivosManutFormula.Text='' Then
  Begin
    msg('Favor Informar a Frmula !!','A');
    Dbe_FinanObjetivosManutFormula.SetFocus;
    Exit;
  End;

  Try
    If DMBelShop.CDS_ObjetivosNUM_ORDEM.AsInteger=0 Then
    Begin
      msg('Favor Informar o Nmero da Ordem'+cr+'para Apresentao na'+cr+'Planilha !!','A');
      Dbe_FinanObjetivosManutOrdem.SetFocus;
      Exit;
    End;
  Except
    If DMBelShop.CDS_ObjetivosNUM_ORDEM.AsInteger=0 Then
    Begin
      msg('Nmero da Ordem Invlido !!','A');
      Dbe_FinanObjetivosManutOrdem.SetFocus;
      Exit;
    End;
  End;

  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Acerta Ordem de Apresentacao na Planilha Financeira ----------
    MySql:='select COD_OBJETIVO, DES_OBJETIVO'+
           ' from FIN_OBJETIVOS'+
           ' Where COD_OBJETIVO<>'+sgCodigo+
           ' order by num_ordem';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    i:=0;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin

      Inc(i);

      If i=DMBelShop.CDS_ObjetivosNUM_ORDEM.AsInteger Then
       Inc(i);

      MySql:='Update FIN_OBJETIVOS'+
             ' Set NUM_ORDEM='+IntToStr(i)+
             ' Where COD_OBJETIVO='+
             DMBelShop.CDS_Busca.FieldByName('COD_OBJETIVO').AsString;
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    DMBelShop.CDS_Busca.Close;

    If DMBelShop.CDS_Objetivos.State=dsInsert Then
    Begin
      MySql:='Insert Into FIN_OBJETIVOS ('+
             ' COD_OBJETIVO, DES_OBJETIVO, IND_OPERACAO, IND_FIXO,'+
             ' IND_NAOCOMPRA, DES_FORMULA,'+
             ' NUM_DECIMAIS, NUM_ORDEM, IND_ATIVO, ULT_12_MESES,'+
             ' USU_INCLUI, DTA_INCLUI)'+
             ' Values ('+
             QuotedStr(sgCodigo)+', '+
             QuotedStr(DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString)+', ';

             If Rb_FinanObjetivosManutTpOperacaoLoja.Checked Then s:='1'; 
             If Rb_FinanObjetivosManutTpOperacaoSalao.Checked Then s:='2'; 
             If Rb_FinanObjetivosManutTpOperacaoAmbos.Checked Then s:='3';
             MySql:=MySql+QuotedStr(s)+', ';

             s:='NAO';
             If Ckb_FinanObjetivosManutVlrFixo.Checked Then
              s:='SIM';
             MySql:=MySql+QuotedStr(s)+', ';

             s:='NAO';
             If Ckb_FinanObjetivosManutNaoCompra.Checked Then
              s:='SIM';
             MySql:=MySql+QuotedStr(s)+', ';

             MySql:=MySql+
             QuotedStr(DMBelShop.CDS_ObjetivosDES_FORMULA.AsString)+', '+
             QuotedStr(DMBelShop.CDS_ObjetivosNUM_DECIMAIS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_ObjetivosNUM_ORDEM.AsString)+', ';

             s:='NAO';
             If Ckb_FinanObjetivosManutAtivo.Checked Then
              s:='SIM';
             MySql:=MySql+QuotedStr(s)+', ';
             
             s:='NAO';
             If Ckb_FinanObjetivosManutUlt12Meses.Checked Then
              s:='SIM';
             MySql:=MySql+QuotedStr(s)+', ';

             MySql:=MySql+
             QuotedStr(Cod_Usuario)+', Current_Date)';
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End;

    If DMBelShop.CDS_Objetivos.State=dsEdit Then
    Begin
      MySql:='Update FIN_OBJETIVOS '+
             ' Set DES_OBJETIVO='+
             QuotedStr(DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString);

             If Rb_FinanObjetivosManutTpOperacaoLoja.Checked Then s:='1';
             If Rb_FinanObjetivosManutTpOperacaoSalao.Checked Then s:='2'; 
             If Rb_FinanObjetivosManutTpOperacaoAmbos.Checked Then s:='3'; 
             MySql:=MySql+', IND_OPERACAO='+QuotedStr(s);

             s:='NAO';
             If Ckb_FinanObjetivosManutVlrFixo.Checked Then
              s:='SIM';
             MySql:=MySql+', IND_FIXO='+QuotedStr(s);
             
             s:='NAO';
             If Ckb_FinanObjetivosManutNaoCompra.Checked Then
              s:='SIM';
             MySql:=MySql+', IND_NAOCOMPRA='+QuotedStr(s);

             MySql:=MySql+
             ', DES_FORMULA='+
             QuotedStr(DMBelShop.CDS_ObjetivosDES_FORMULA.AsString)+
             ', NUM_DECIMAIS='+
             QuotedStr(DMBelShop.CDS_ObjetivosNUM_DECIMAIS.AsString)+
             ', NUM_ORDEM='+
             QuotedStr(DMBelShop.CDS_ObjetivosNUM_ORDEM.AsString);
             
             s:='NAO';
             If Ckb_FinanObjetivosManutAtivo.Checked Then
              s:='SIM';
             MySql:=MySql+', IND_ATIVO='+QuotedStr(s);

             s:='NAO';
             If Ckb_FinanObjetivosManutUlt12Meses.Checked Then
              s:='SIM';
             MySql:=MySql+', ULT_12_MESES='+QuotedStr(s);

             MySql:=MySql+
             ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
             ', DTA_ALTERA=Current_Date'+
             
             ' Where COD_OBJETIVO='+sgCodigo;
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End;

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      
    End; // on e : Exception do
  End; // Try

  Bt_FinanObjetivosManutAbandonarClick(Self);
end;

procedure TFrmBelShop.Bt_FinanObjetivosManutObjetivosClick(Sender: TObject);
begin
  // Habilita Manutencao de Objetivos ==========================================
  HabilitaDesabilitaManutencaoObjetivos(True);

  If Bt_FinanObjetivosManutObjetivos.Caption='Incluir' Then
  Begin
    DMBelShop.CDS_ObjetivosMetas.Insert;
    DMBelShop.CDS_ObjetivosMetasCOD_FILIAL.AsString:=
               DMBelShop.CDS_ObjetivosEmpresas.FieldByName('Cod_Filial').AsString;
    DMBelShop.CDS_ObjetivosMetasCOD_OBJETIVO.AsString:=sgCodigo;
    DMBelShop.CDS_ObjetivosMetasDES_ANO.AsInteger:=EdtFinanObjetivosAno.AsInteger;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES01.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES02.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES03.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES04.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES05.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES06.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES07.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES08.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES09.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES10.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES11.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasOBJ_MES12.AsCurrency:=0;
    DMBelShop.CDS_ObjetivosMetasUSU_INCLUI.AsString:=Cod_Usuario;
    DMBelShop.CDS_ObjetivosMetasDTA_INCLUI.AsString:=
                    DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  End; // If Bt_FinanObjetivosManutObjetivos.Caption='Incluir' Then

  If Bt_FinanObjetivosManutObjetivos.Caption='Alterar' Then
  Begin
    DMBelShop.CDS_ObjetivosMetas.Edit;
    DMBelShop.CDS_ObjetivosMetasUSU_ALTERA.AsString:=Cod_Usuario;
    DMBelShop.CDS_ObjetivosMetasDTA_ALTERA.AsString:=
                    DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  End; // If Bt_FinanObjetivosManutObjetivos.Caption='Incluir' Then

  Dbe_FinanObjetivosManutJan.SetFocus;
  Bt_FinanObjetivosManutObjetivos.Enabled:=False;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutObjetivosAbandonarClick(Sender: TObject);
begin
  If (DMBelShop.CDS_ObjetivosMetas.State=dsEdit) or (DMBelShop.CDS_ObjetivosMetas.State=dsInsert) Then
   DMBelShop.CDS_ObjetivosMetas.CancelUpdates;

  // Disabilita Manutencao de Objetivos ========================================
  HabilitaDesabilitaManutencaoObjetivos(False);
  
  // Verifica Existencia de Objetivos ==========================================
  Bt_FinanObjetivosManutSalvar.Enabled:=True;
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

  Dbg_FinanObjetivosManutEmpresas.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutObjetivosSalvarClick(Sender: TObject);
Var
  MySql: String;
begin
  // DMBelShop.SQLC.StartTransaction(TD) em Bt_FinanObjetivosNovo/Bt_FinanObjetivosAlterar

  Screen.Cursor:=crAppStart; 
  DateSeparator:='.';
  DecimalSeparator:='.';

  If Bt_FinanObjetivosManutObjetivos.Caption='Incluir' Then
  Begin
    MySql:=' Insert Into FIN_OBJETIVOS_METAS ('+
           ' COD_FILIAL, COD_OBJETIVO, DES_ANO,'+
           ' OBJ_MES01, OBJ_MES02, OBJ_MES03, OBJ_MES04, OBJ_MES05, OBJ_MES06,'+
           ' OBJ_MES07, OBJ_MES08, OBJ_MES09, OBJ_MES10, OBJ_MES11, OBJ_MES12,'+
           ' USU_INCLUI, DTA_INCLUI)'+
           ' Values ('+
           QuotedStr(DMBelShop.CDS_ObjetivosEmpresas.FieldByName('Cod_Filial').AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString)+', '+
           QuotedStr(VarToStr(EdtFinanObjetivosAno.Value))+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES01.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES02.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES03.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES04.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES05.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES06.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES07.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES08.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES09.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES10.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES11.AsString)+', '+
           QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES12.AsString)+', '+
           QuotedStr(Cod_Usuario)+', '+
           QuotedStr(DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)))+')';
  End; //   If Bt_FinanObjetivosManutObjetivos.Caption='Incluir' Then

  If Bt_FinanObjetivosManutObjetivos.Caption='Alterar' Then
  Begin
    MySql:=' Update FIN_OBJETIVOS_METAS Set'+                             
           ' OBJ_MES01='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES01.AsString)+', '+
           ' OBJ_MES02='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES02.AsString)+', '+
           ' OBJ_MES03='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES03.AsString)+', '+
           ' OBJ_MES04='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES04.AsString)+', '+
           ' OBJ_MES05='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES05.AsString)+', '+
           ' OBJ_MES06='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES06.AsString)+', '+
           ' OBJ_MES07='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES07.AsString)+', '+
           ' OBJ_MES08='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES08.AsString)+', '+
           ' OBJ_MES09='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES09.AsString)+', '+
           ' OBJ_MES10='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES10.AsString)+', '+
           ' OBJ_MES11='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES11.AsString)+', '+
           ' OBJ_MES12='+QuotedStr(DMBelShop.CDS_ObjetivosMetasOBJ_MES12.AsString)+', '+
           ' USU_ALTERA='+QuotedStr(Cod_Usuario)+', '+
           ' DTA_ALTERA='+QuotedStr(DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)))+
           ' Where COD_FILIAL='+QuotedStr(
           DMBelShop.CDS_ObjetivosEmpresas.FieldByName('Cod_Filial').AsString)+
           ' And COD_OBJETIVO='+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString+
           ' And DES_ANO='+QuotedStr(VarToStr(EdtFinanObjetivosAno.Value));
  End; // If Bt_FinanObjetivosManutObjetivos.Caption='Alterar' Then

  DMBelShop.SQLC.Execute(MySql, nil, nil);
  
  DateSeparator:='/';
  DecimalSeparator:=',';
  Screen.Cursor:=crDefault;

  // Verifica Existencia de Objetivos ==========================================
  Bt_FinanObjetivosManutSalvar.Enabled:=True;
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

  Bt_FinanObjetivosManutObjetivosAbandonarClick(Self);
end;

procedure TFrmBelShop.EdtFinanObjetivosAnoExit(Sender: TObject);
begin
  If EdtFinanObjetivosAno.Value=0 Then
  Begin
    msg('Ano Invlido !!','A');
    EdtFinanObjetivosAno.SetFocus;
    Exit;
  End;

  // Verifica Existencia de Objetivos ==========================================
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

end;

procedure TFrmBelShop.Dbe_FinanObjetivosManutDesObjetivoChange(Sender: TObject);
begin
  // Verifica Existencia de Objetivos ==========================================
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaSinalAbreParentesClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  Dbe_FinanObjetivosManutFormula.SelText:='(';
  DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaExcluirClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  If Dbe_FinanObjetivosManutFormula.SelText='' Then
  Begin
    msg('Favor Marcar o Texto a Excluir !!','A');
    Dbe_FinanObjetivosManutFormula.SetFocus;
    Exit;
  End;
  Dbe_FinanObjetivosManutFormula.SelText:='';
  DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaSinalFechaParentesClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  Dbe_FinanObjetivosManutFormula.SelText:=')';
  DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaSinalSomaClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  Dbe_FinanObjetivosManutFormula.SelText:='+';
  DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaSinalSubtraiClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  Dbe_FinanObjetivosManutFormula.SelText:='-';
  DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaSinalMultiplicaClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  Dbe_FinanObjetivosManutFormula.SelText:='*';
  DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaSinalDivideClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  Dbe_FinanObjetivosManutFormula.SelText:='/';
  DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;

end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaComprovanteClick(Sender: TObject);
Var
  i: Integer;
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  FrmObjetivosFormula:=TFrmObjetivosFormula.Create(Self);
  FrmObjetivosFormula.Ts_ObjetivosCalculaObjetivo.TabVisible:=False;
  FrmObjetivosFormula.Ts_ObjetivosFormulaTpEstoque.TabVisible:=False;

  // Carrega Campos para Pesquisa ==============================================
  for i:=Low(ArrayObjetivos) to High(ArrayObjetivos) do
   FrmObjetivosFormula.Clbx_ObjetivosFormulaCampos.Items.Add(ArrayObjetivos[i]);
  
  bgProcessar:=False;
  FrmObjetivosFormula.ShowModal;

  If bgProcessar Then
  Begin

    For i:=0 to FrmObjetivosFormula.Clbx_ObjetivosFormulaCampos.Items.Count-1 do
    Begin
      If FrmObjetivosFormula.Clbx_ObjetivosFormulaCampos.Checked[i] Then
      Begin
        Dbe_FinanObjetivosManutFormula.SelText:='CP'+
                 FrmObjetivosFormula.EdtObjetivosFormulaCodComprovante.Text+'.'+
                       FrmObjetivosFormula.Clbx_ObjetivosFormulaCampos.Items[i];
        DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;
        Break;
      End;
    End; // For i:=0 to FrmObjetivosFormula.Clbx_ObjetivosFormulaCampos.Items.Count-1 do
   
  End; // If bgProcessar Then

  FreeAndNil(FrmObjetivosFormula);
end;

procedure TFrmBelShop.Bt_FinanObjetivosGeraObjetivosClick(Sender: TObject);
Var
  ii, i: Integer;
  iNumDiasUteis: Integer;
  s: String;
  sDiaSemanaMes: String;
  MySql: String;
  iIndicePlan: Integer;
  iIndicePlanMeses: Integer;
  bb, b: Boolean;

  // Planilha Meses
  sMes, sAno: String;
  Ano, Mes, Dia: Word;
  Dta: TDate;

  bCalculoDias, bCalculoMeses: Boolean;
Begin
  sgLojasNConectadas:='';
  StatusBar2.Panels[2].Text:='Gerado em: 00/00/0000 00:00:00';

  // Verifica Se Existe Objetivos a Processar ==================================
  If (Not DMBelShop.CDS_Objetivos.Active) or (DMBelShop.CDS_Objetivos.IsEmpty) Then
  Begin
    msg('Sem Objetivos a Processar !!','A');
    Exit;
  End;

  OdirPanApres.Caption:='AGUARDE !! Analisando Objetivos Selecionados...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  DMBelShop.CDS_Objetivos.DisableControls;
  DMBelShop.CDS_Objetivos.First;
  b :=False;
  bb:=False;
  While Not DMBelShop.CDS_Objetivos.Eof do
  Begin
    If DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM' Then
     b:=True;

    If DMBelShop.CDS_ObjetivosPROC.AsString='SIM' Then
     bb:=True;

    DMBelShop.CDS_Objetivos.Next;
  End; // While b do
  DMBelShop.CDS_Objetivos.First;
  DMBelShop.CDS_Objetivos.EnableControls;
  OdirPanApres.Visible:=False;

  If (Not b) Or (Not bb) Then
  Begin
    msg('Sem Objetivos a Processar !!'+cr+cr+'Selecione o(s) Objetivo(s)/Meta(s)'+cr+'a Calcular !!','A');
    Dbg_FinanObjetivosManut.SetFocus;
    Exit;
  End;

  Screen.Cursor:=crAppStart;
  Dbg_FinanObjetivosManut.SetFocus;
  iIndicePlan:=0;
  iIndicePlanMeses:=0;

  // Fecha Grafico =============================================================
  Ts_FinanObjetivosGraficos.TabVisible:=False;
  FechaSeriesGraficos;

  // Seleciona Empresa =========================================================
  sgOutrasEmpresa:='(99)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;
  FrmSelectEmpProcessamento.Pan_SelectEmpProcECommerce.Visible:=True;
  FrmSelectEmpProcessamento.ShowModal;
  iNrConexoes:=FrmSelectEmpProcessamento.iNrEmpProc;
  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Existe Empresa a Processar ====================================
  If DMBelShop.CDS_EmpProcessa.Eof Then
  Begin
    Dbg_FinanObjetivosManut.SetFocus;
    Screen.Cursor:=crDefault;
    Exit;
  End;
  Screen.Cursor:=crAppStart;

  // Acerta Perodo ============================================================
  EdtFinanObjetivosAno.Value:=EdtFinanObjetivosGerarAno.Value;
  If DMBelShop.CDS_ObjetivosEmpresas.Active Then
   DMBelShop.CDS_ObjetivosEmpresasAfterScroll(DMBelShop.CDS_ObjetivosEmpresas);

  AtualizaData(Cbx_FinanObjetivosGerarMes, sgPeriodo, EdtFinanObjetivosGerarAno.Text);

  // Cria ClientDataSet Dias ===================================================
  If DMVirtual.CDS_V_ObjetivosDias.Active Then
   DMVirtual.CDS_V_ObjetivosDias.Close;

  DMVirtual.CDS_V_ObjetivosDias.CreateDataSet;
  DMVirtual.CDS_V_ObjetivosDias.Open;
  DMVirtual.CDS_V_ObjetivosDias.Filtered:=False;
  DMVirtual.CDS_V_ObjetivosDias.Filter:='VISIVEL='+QuotedStr('S');
  DMVirtual.CDS_V_ObjetivosDias.Filtered:=True;

  // Cria ClientDataSet Meses ==================================================
  If DMVirtual.CDS_V_ObjetivosMeses.Active Then
   DMVirtual.CDS_V_ObjetivosMeses.Close;

  DMVirtual.CDS_V_ObjetivosMeses.CreateDataSet;
  DMVirtual.CDS_V_ObjetivosMeses.Open;
  DMVirtual.CDS_V_ObjetivosMeses.Filtered:=False;
  DMVirtual.CDS_V_ObjetivosMeses.Filter:='VISIVEL='+QuotedStr('S');
  DMVirtual.CDS_V_ObjetivosMeses.Filtered:=True;

  // Cria ClientDataSet Auditorias =============================================
  If DMVirtual.CDS_V_ObjetivosAuditorias.Active Then
   DMVirtual.CDS_V_ObjetivosAuditorias.Close;

  DMVirtual.CDS_V_ObjetivosAuditorias.CreateDataSet;
  DMVirtual.CDS_V_ObjetivosAuditorias.Open;
  DMVirtual.CDS_V_ObjetivosAuditorias.Filtered:=False;
  DMVirtual.CDS_V_ObjetivosAuditorias.Filter:='';

  // Cria ClientDataSet Movtos =================================================
  If DMVirtual.CDS_V_ObjetivosMovtos.Active Then
   DMVirtual.CDS_V_ObjetivosMovtos.Close;

  DMVirtual.CDS_V_ObjetivosMovtos.CreateDataSet;
  DMVirtual.CDS_V_ObjetivosMovtos.Open;
  DMVirtual.CDS_V_ObjetivosMovtos.Filtered:=False;
  DMVirtual.CDS_V_ObjetivosMovtos.Filter:='';

  // Inicializa Variavies para Auditorias ======================================
  bgAuditoria:=False;
  cgVlrAcumulado1:=0;
  cgVlrAcumulado2:=0;
  cgVlrAcumulado3:=0;
  igTotInteiro   :=0;

  // Apresenta o Processamento =================================================
  OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento dos Objetivos Selecionados...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  bCalculoDias:=False;
  bCalculoMeses:=False;

  // Acerta CDS_V_ObjetivosDias ================================================
  For i:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do
   DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible:=False;

  // Acerta CDS_V_ObjetivosMeses ===============================================
  For i:=0 to DMVirtual.CDS_V_ObjetivosMeses.Fields.Count-1 do
   DMVirtual.CDS_V_ObjetivosMeses.Fields[i].Visible:=False;

  // Libera Colunas Principais CDS_V_ObjetivosDias =============================
  DMVirtual.CDS_V_ObjetivosDias.Fields[1].Visible:=True;
  Dbg_FinanObjetivosResultadosDias.Columns[0].Width:=100;
  DMVirtual.CDS_V_ObjetivosDias.Fields[2].Visible:=True;
  Dbg_FinanObjetivosResultadosDias.Columns[1].Width:=100;
  Dbg_FinanObjetivosResultadosDias.Columns[1].Title.Alignment:=taRightJustify;
  DMVirtual.CDS_V_ObjetivosDias.Fields[4].Visible:=True;
  Dbg_FinanObjetivosResultadosDias.Columns[2].Width:=60;
  DMVirtual.CDS_V_ObjetivosDias.Fields[5].Visible:=True;
  Dbg_FinanObjetivosResultadosDias.Columns[3].Width:=90;

  // Libera Colunas Principais CDS_V_ObjetivosMeses ============================
  DMVirtual.CDS_V_ObjetivosMeses.Fields[1].Visible:=True;
  Dbg_FinanObjetivosResultadosMeses.Columns[0].Width:=100;
  DMVirtual.CDS_V_ObjetivosMeses.Fields[2].Visible:=True;
  Dbg_FinanObjetivosResultadosMeses.Columns[1].Width:=100;
  Dbg_FinanObjetivosResultadosMeses.Columns[1].Title.Alignment:=taRightJustify;
  DMVirtual.CDS_V_ObjetivosMeses.Fields[4].Visible:=True;
  Dbg_FinanObjetivosResultadosMeses.Columns[2].Width:=60;
  DMVirtual.CDS_V_ObjetivosMeses.Fields[5].Visible:=True;
  Dbg_FinanObjetivosResultadosMeses.Columns[3].Width:=90;

  // Apropria Datas de Incio e Fim do Periodo ==================================
  i:=pos('Between ', sgPeriodo);
  sgDtaInicio:=Copy(sgPeriodo,i+9,10);
  i:=pos(' and ', sgPeriodo);
  sgDtaFim:=Copy(sgPeriodo,i+6,10);

  // Guarda Data (Dias) de Incio para Verificao com Inicio Linx -------------
  sgDtaI:=sgDtaInicio;

  // Libera Colunas de Dias teis ==============================================
  // Busca Feriados -------------------------------------------------
  iNumDiasUteis:=0;
  While StrToDate(sgDtaInicio)<=StrToDate(sgDtaFim) do
  Begin
    sDiaSemanaMes:='1';
    If (DiaSemanaAbrev(StrToDateTime(sgDtaInicio))='Dom') Then
     Begin
       sDiaSemanaMes:='0';
     End
    Else // If (DiaSemanaAbrev(StrToDateTime(sgDtaInicio))='Dom') Then
     Begin
       MySql:=' Select f.Dta_Feriado'+
              ' From FIN_FERIADOS_ANO f'+
              ' Where f.Ind_Ativo=''SIM'''+
              ' And f.Dta_Feriado='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaInicio)));
       DMBelShop.CDS_BuscaRapida.Close;
       DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
       DMBelShop.CDS_BuscaRapida.Open;

       If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Dta_Feriado').AsString)<>'' Then
        sDiaSemanaMes:='0';

       DMBelShop.CDS_BuscaRapida.Close;
     End; // If (DiaSemanaAbrev(StrToDateTime(sgDtaInicio))='Dom') Then

    If sDiaSemanaMes<>'0' Then
    Begin
      Inc(iNumDiasUteis);

      For i:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do
      Begin
        sDiaSemanaMes:=Copy(sgDtaInicio,1,2);
        If DMVirtual.CDS_V_ObjetivosDias.Fields[i].DisplayName='Dia_'+sDiaSemanaMes Then
        Begin
         DMVirtual.CDS_V_ObjetivosDias.Fields[i].Visible:=True;
         Dbg_FinanObjetivosResultadosDias.Columns[Dbg_FinanObjetivosResultadosDias.Columns.Count-1].Width:=85;
         Dbg_FinanObjetivosResultadosDias.Columns[Dbg_FinanObjetivosResultadosDias.Columns.Count-1].Title.Alignment:=taRightJustify;
         Break;
        End; // If DMVirtual.CDS_V_ObjetivosDias.Fields[i].DisplayName='Dia_'+sDiaSemana Then
      End; // For i:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do
    End; // If sDiaSemana<>'0' Then

    sgDtaInicio:=DateToStr(StrToDate(sgDtaInicio)+1);
  End; // While StrToDate(sgDtaInicio)<=StrToDate(sgDtaFim) do

  // Orderna Apresentao do Objetivos =========================================
  OrderGrid:='Crescente';
  OrderByGrid(DMBelShop.CDS_Objetivos, Dbg_FinanObjetivosManut, Dbg_FinanObjetivosManut.Columns[2].FieldName, True);

  // Retorna Numero do Mes =====================================================
  sDiaSemanaMes:=IntToStr(MonthOf(StrToDateTime(sgDtaInicio)-1));
  If Length(sDiaSemanaMes)<2 Then
   sDiaSemanaMes:='0'+sDiaSemanaMes;

  // Mes/Ano para Planilha Meses ===============================================
  Dta:=DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);
  Dta:=PrimeiroUltimoDia(Dta,'P');
  Dta:=IncMonth(Dta,-EdtFinanObjetivosMeses.AsInteger);
  sgPeriodo1:=DateToStr(Dta);

  // Guarda Data (Meses) de Incio para Verificao com Inicio Linx ------------
  sgDtaIniAno:=sgPeriodo1;

  // Inicio da Montagem do Perodo =============================================
  sgPeriodo1:='BETWEEN '+QuotedStr(DateToStr(Dta));

  // Monta ClientDataSet de Meses ==============================================
  For ii:=6 to EdtFinanObjetivosMeses.AsInteger+5 do
  Begin
    DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].Visible:=True;
    DMVirtual.CDS_V_ObjetivosMeses.Fields[ii].DisplayLabel:=Copy(DateToStr(Dta),4,2)+'/'+Copy(DateToStr(Dta),7,4);
    Dbg_FinanObjetivosResultadosMeses.Columns[Dbg_FinanObjetivosResultadosMeses.Columns.Count-1].Width:=85;
    Dbg_FinanObjetivosResultadosMeses.Columns[Dbg_FinanObjetivosResultadosMeses.Columns.Count-1].Title.Alignment:=taRightJustify;

    dta:=IncMonth(Dta,1);
  End;
  Dta:=Dta-1;

  // Guarda Data (Meses) de FIM para Verificao com Inicio Linx ---------------
  sgDtaFimAno:=DateToStr(Dta);

  // Termina Montagem do Perodo ===============================================
  sgPeriodo1:=sgPeriodo1+' AND '+QuotedStr(DateToStr(Dta));

  // Acerta Coluna de Totais Meses =============================================
  DMVirtual.CDS_V_ObjetivosMeses.Fields[18].Visible:=True;
  Dbg_FinanObjetivosResultadosMeses.Columns[Dbg_FinanObjetivosResultadosMeses.Columns.Count-1].Width:=100;
  Dbg_FinanObjetivosResultadosMeses.Columns[Dbg_FinanObjetivosResultadosMeses.Columns.Count-1].Title.Alignment:=taRightJustify;

  // Monta Planilha de Objetivos ===============================================
  DMBelShop.CDS_Objetivos.First;
  DMBelShop.CDS_Objetivos.DisableControls;
  While Not DMBelShop.CDS_Objetivos.Eof do
  Begin
    Refresh;

    // Monta Planilha de Objetivos por Dias -------------------------
    If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) and
       ((Not Ckb_FinanObjetivosManutAuditoria.Checked) and (Not Ckb_FinanObjetivosManutAvarias.Checked)) and
       (DMBelShop.CDS_ObjetivosULT_12_MESES.AsString='NAO') Then
    Begin
      bCalculoDias:=True;
      MontaPlanilhaObjetivosDias(sDiaSemanaMes, iNumDiasUteis, iIndicePlan);
    End; // If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) and

    // Monta Planilha de Objetivos por Meses -------------------------
    If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) and
       (((not Ckb_FinanObjetivosManutAuditoria.Checked) And (Ckb_FinanObjetivosManutAvarias.Checked)) or
        ((not Ckb_FinanObjetivosManutAuditoria.Checked) And (Not Ckb_FinanObjetivosManutAvarias.Checked) and
         (DMBelShop.CDS_ObjetivosULT_12_MESES.AsString='SIM'))) Then
    Begin
      bCalculoMeses:=True;
      MontaPlanilhaObjetivosMeses(iIndicePlanMeses);
    End; // If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) and

    // Libera para Calculo de Planilha de Objetivos Auditoria ---------
    If ((DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM')) and
       ((Ckb_FinanObjetivosManutAuditoria.Checked) And (Not Ckb_FinanObjetivosManutAvarias.Checked)) Then
    Begin
      bCalculoMeses:=True;
    End; // If (DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM') and

    DMBelShop.CDS_Objetivos.Next;
  End;// While Not DMBelShop.CDS_Objetivos.Eof do
  DMBelShop.CDS_Objetivos.EnableControls;
  DMVirtual.CDS_V_ObjetivosDias.First;
  DMBelShop.CDS_EmpProcessa.First;
  DMBelShop.CDS_Objetivos.First;

  // Tamanho das Colunas =======================================================
  EdtFinanObjetivosResultDiasTamColuna1.Value:=Dbg_FinanObjetivosResultadosDias.Columns[0].Width;
  EdtFinanObjetivosResultDiasTamColuna2.Value:=Dbg_FinanObjetivosResultadosDias.Columns[1].Width;
  EdtFinanObjetivosResultDiasTamColuna3.Value:=Dbg_FinanObjetivosResultadosDias.Columns[2].Width;
  EdtFinanObjetivosResultDiasTamColuna4.Value:=Dbg_FinanObjetivosResultadosDias.Columns[3].Width;
  EdtFinanObjetivosResultDiasTamNaoFixas.Value:=Dbg_FinanObjetivosResultadosDias.Columns[4].Width;

  EdtFinanObjetivosResultMesesTamColuna1.Value:=Dbg_FinanObjetivosResultadosMeses.Columns[0].Width;
  EdtFinanObjetivosResultMesesTamColuna2.Value:=Dbg_FinanObjetivosResultadosMeses.Columns[1].Width;
  EdtFinanObjetivosResultMesesTamColuna3.Value:=Dbg_FinanObjetivosResultadosMeses.Columns[2].Width;
  EdtFinanObjetivosResultMesesTamColuna4.Value:=Dbg_FinanObjetivosResultadosMeses.Columns[3].Width;
  EdtFinanObjetivosResultMesesTamNaoFixas.Value:=Dbg_FinanObjetivosResultadosMeses.Columns[4].Width;

  OdirPanApres.Visible:=False;

  // Processa Empresas Selecionadas por Dia ====================================
  If bCalculoDias Then
  Begin
    THackDBGrid(Dbg_FinanObjetivosResultadosDias).FixedCols:=5;
    PC_FinanObjetivos.ActivePage:=Ts_FinanObjetivosResultadosDias;
    Dbg_FinanObjetivosResultadosDias.SetFocus;

    // Calcula por Dia ----------------------------------------------
    CaluclaObjetivosMetasDias;

    // Calcula Resultado dos Objetivos por Dia ----------------------
    CaluclaResultadosObjetivosMetasDias;

    // Retira Colunas de Dias a No Usar ----------------------------
    ii:=DayOf(DtEdt_FinanObjetivosGerarUltDia.Date);
    ii:=ii+1;
    For i:=ii to 31 do
    Begin
      If i<10 Then
       s:='0'+IntToStr(i)
      Else
       s:=IntToStr(i);

      For ii:=0 to DMVirtual.CDS_V_ObjetivosDias.Fields.Count-1 do
      Begin
        If (DMVirtual.CDS_V_ObjetivosDias.Fields[ii].Visible) and
           (DMVirtual.CDS_V_ObjetivosDias.Fields[ii].FieldName='Vlr_Dia'+s) Then
         DMVirtual.CDS_V_ObjetivosDias.Fields[ii].Visible:=False
      End;
    End; // For i to 31 do

    THackDBGrid(Dbg_FinanObjetivosResultadosDias).FixedCols:=5;
    DMVirtual.CDS_V_ObjetivosDias.First;
  End; // If bCalculoDias Then

  // Processa Empresas Selecionadas por Meses ==================================
  If bCalculoMeses Then
  Begin
    THackDBGrid(Dbg_FinanObjetivosResultadosMeses).FixedCols:=5;
    Ts_FinanObjetivosResultadosMeses.Caption:=' Resultados ltimos '+EdtFinanObjetivosMeses.Text+' Meses ';
    PC_FinanObjetivos.ActivePage:=Ts_FinanObjetivosResultadosMeses;
    Dbg_FinanObjetivosResultadosMeses.SetFocus;

    // Calcula por Meses --------------------------------------------
    CaluclaObjetivosMetasMeses;

    // Calcula Resultado dos Objetivos por Meses --------------------
    CaluclaResultadosObjetivosMetasMeses;

    THackDBGrid(Dbg_FinanObjetivosResultadosMeses).FixedCols:=5;
    DMVirtual.CDS_V_ObjetivosMeses.First;
  End; // If bCalculoMeses Then

  DMBelShop.CDS_EmpProcessa.First;
  DMBelShop.CDS_Objetivos.First;
  DMVirtual.CDS_V_ObjetivosDias.First;
  DMVirtual.CDS_V_ObjetivosMeses.First;
  DMVirtual.CDS_V_ObjetivosAuditorias.First;

  OdirPanApres.Visible:=False;
  Screen.Cursor:=crDefault;
  Refresh;

  If Dbg_FinanObjetivosResultadosDias.CanFocus Then
   Dbg_FinanObjetivosResultadosDias.SetFocus;

  If Dbg_FinanObjetivosResultadosMeses.CanFocus Then
   Dbg_FinanObjetivosResultadosMeses.SetFocus;

  If Dbg_FinanObjetivosResultadosAuditoria.CanFocus Then
   Dbg_FinanObjetivosResultadosAuditoria.SetFocus;

  StatusBar2.Panels[2].Text:='Gerado em: '+DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor))+' '+
                                           TimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));

  If sgLojasNConectadas<>'' Then
   MessageBox(Handle, pChar('Loja(s) No Conectada(s)'+cr+'ou'+cr+'SEM Movimento no Perodo !!'+cr+cr+sgLojasNConectadas), 'Erro', MB_ICONERROR)
  Else
   msg('Processamento Efetuado com Sucesso !!','A');

  Dta:=PrimeiroUltimoDia(Dta, 'U');
  sgPeriodo1:=sgPeriodo1+' and '+QuotedStr(f_Troca('/','.',DateToStr(Dta)));

end;

procedure TFrmBelShop.Cbx_FinanObjetivosGerarMesExit(Sender: TObject);
Var
  i: Integer;
  b: Boolean;
begin
  b:=False;
  For i:=1 to 12 do
  Begin
    If AnsiUpperCase(LongMonthNames[i])=Cbx_FinanObjetivosGerarMes.Text Then
     b:=True;
  end;

  If Not b Then
  Begin
    msg('Ms Informado  Invlido !!','A');
    Cbx_FinanObjetivosGerarMes.SetFocus;
    Exit;
  End;
end;

procedure TFrmBelShop.EdtFinanObjetivosGerarAnoExit(Sender: TObject);
begin
  If EdtFinanObjetivosGerarAno.Value<1 Then
  Begin
    msg('Ano Invlido !!','A');
    EdtFinanObjetivosGerarAno.SetFocus;
    Exit;
  End;

  Cbx_FinanObjetivosGerarMesChange(Self);
end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosDiasColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=2) Or
     (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=3) Then
  begin
    THackDBGrid(Dbg_FinanObjetivosResultadosDias).LeftCol:=5;
    THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex:=4;
    Dbg_FinanObjetivosResultadosDias.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosDiasColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanObjetivosResultadosDiasColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosDiasDrawColumnCell(Sender: TObject;
          const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
Var
  i: Integer;
  s: String;
begin

  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanObjetivosResultadosDiasColEnter(Self);

  if not (gdSelected in State) Then
  Begin
    if DMVirtual.CDS_V_ObjetivosDiasDes_Objetivo.AsString<>'' Then
     Dbg_FinanObjetivosResultadosDias.Canvas.Brush.Color:=clSkyBlue;

    if (DMVirtual.CDS_V_ObjetivosDiasTipo.AsString='Resultado') Or (DMVirtual.CDS_V_ObjetivosDiasTipo.AsString='Percentual') Then
    Begin
      Dbg_FinanObjetivosResultadosDias.Canvas.Font.Style:=[fsBold];
    End;

    if (DMVirtual.CDS_V_ObjetivosDiasDes_Empresa.AsString='Empresa') Then
    Begin
      Dbg_FinanObjetivosResultadosDias.Canvas.Brush.Color:=$0080FFFF;
    End;
    
    Dbg_FinanObjetivosResultadosDias.Canvas.FillRect(Rect);
    Dbg_FinanObjetivosResultadosDias.DefaultDrawDataCell(Rect,Column.Field,state);
    
  End; // if not (gdSelected in State) Then

  For i:=1 to 31 do
  Begin
    s:=IntToStr(i);
    If i<10 Then
     s:='0'+s;
         
    If (Column.Field.FieldName = 'Vlr_Dia'+s) then
    Begin
     If DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).Value < 0 then
      Begin
         Dbg_FinanObjetivosResultadosDias.Canvas.Font.Color:= clRed;
         Dbg_FinanObjetivosResultadosDias.Canvas.FillRect(Rect);
         Dbg_FinanObjetivosResultadosDias.DefaultDrawColumnCell(Rect, DataCol, Column, State);
      End
     Else
      Begin
        If Dbg_FinanObjetivosResultadosDias.Canvas.Font.Style=[fsBold] Then
         Dbg_FinanObjetivosResultadosDias.Canvas.Font.Color:= clBlue
        Else
         Dbg_FinanObjetivosResultadosDias.Canvas.Font.Color:= clBlack;

        Dbg_FinanObjetivosResultadosDias.Canvas.FillRect(Rect);
        Dbg_FinanObjetivosResultadosDias.DefaultDrawColumnCell(Rect, DataCol, Column, State);
      End; // If DMVirtual.CDS_V_ObjetivosDias.FieldByName('Vlr_Dia'+s).Value < 0 then
    End; // If (Column.Field.FieldName = 'Vlr_Dia'+s) then
  End; // For i:=1 to 31 do

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosDiasKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  // Acerta Posicio na Celula ================================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=4) then
  Begin
    Key := VK_Clear;
    Dbg_FinanObjetivosResultadosDias.Refresh;
  End;

    // Acerta Posicio na Celula ==============================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanPlanFinanceira).SelectedIndex = 3) then
  Begin
    Key := VK_Clear;
    Dbg_FinanPlanFinanceira.Refresh;
  End;

  // Movimentos de Objetivo ====================================================
  If key=VK_F6 Then
  Begin
    If Trim(DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString)<>'' Then
    Begin
      If DMBelShop.CDS_Objetivos.Locate('COD_OBJETIVO', DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsInteger,[]) Then
      Begin
        ApresentaMovtosObjetivos('D');
        Dbg_FinanObjetivosResultadosDias.SetFocus;
      End; // If DMBelShop.CDS_Objetivos.Locate('COD_OBJETIVO', DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsInteger,[]) Then
    End; // If Trim(DMVirtual.CDS_V_ObjetivosDiasCod_Objetivo.AsString)<>'' Then
  End; // If key=VK_F6 Then

  // Habilita / Desabilita Linhas ==============================================
  If key=VK_F8 Then
  Begin
    If DMVirtual.CDS_V_ObjetivosDias.IsEmpty Then
     Exit;

    // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ------------
    FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
    AbreSolicitacoes(1);

    FrmSolicitacoes.Ckb_FinanObjetivosHabDesObjetivos.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesDiarios.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesRealizados.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesResultados.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesPercentuais.Checked:=True;
    FrmSolicitacoes.Lb_FinanObjetivosHabDesDiarios.Caption:='Linhas de Dirio ..............................';
    
    bgProcessar:=False;
    FrmSolicitacoes.ShowModal;

    If bgProcessar Then
    Begin
      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Habilitando/Desabilitando Linha(s)...';
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      Dbg_FinanObjetivosResultadosDias.Visible:=False;

      // Habilita Todas as Linhas ==============================================
      DMVirtual.CDS_V_ObjetivosDias.Filtered:=False;
      DMVirtual.CDS_V_ObjetivosDias.First;
      While not DMVirtual.CDS_V_ObjetivosDias.Eof do
      Begin
        Refresh;
        If DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString<>'S' Then
        Begin
          DMVirtual.CDS_V_ObjetivosDias.Edit;
          DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString:='S';
          DMVirtual.CDS_V_ObjetivosDias.Post;
        End; // If DMVirtual.CDS_V_ObjetivosDiasVISIVEL.AsString<>'S' Then

        DMVirtual.CDS_V_ObjetivosDias.Next;
      End; // While not DMVirtual.CDS_V_ObjetivosDias.Eof do
      DMVirtual.CDS_V_ObjetivosDias.First;

      // Habilita Desabilita Linha =============================================
      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesObjetivos.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosDias, 'Tipo', 'Objetivo', False);

      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesDiarios.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosDias, 'Tipo', 'Dirio', False);
      
      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesRealizados.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosDias, 'Tipo', 'Realizado', False);

      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesResultados.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosDias, 'Tipo', 'Resultado', False);

      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesPercentuais.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosDias, 'Tipo', 'Percentual', False);

      DMVirtual.CDS_V_ObjetivosDias.Filtered:=True;
      Dbg_FinanObjetivosResultadosDias.Visible:=True;
      Dbg_FinanObjetivosResultadosDias.SetFocus;
      OdirPanApres.Visible:=False;
      Refresh;

    End; // If bgProcessar Then
  End; //  If key=VK_F8 Then
  FreeAndNil(FrmSolicitacoes);
end;

procedure TFrmBelShop.Bt_FinanObjetivosManutFormulaTextoClick(Sender: TObject);
Var
  s: String;
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Auditoria !!','A');
    Exit;
  End;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    msg('Impossvel Alterar a Frmula !!'+cr+cr+'Objetivo de Avarias/Vencidos !!','A');
    Exit;
  End;

  If InputQuery('Texto a Incluir na Frmula','',s) then
  Begin
    if Trim(s)<>''then
    Begin
      Dbe_FinanObjetivosManutFormula.SelText:=s;
      DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=Dbe_FinanObjetivosManutFormula.Text;
    End
  End; // If InputQuery('Texto a Incluir na Frmula','',s) then

end;

procedure TFrmBelShop.Bt_FinanObjetivosResultDiasSalvarClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_ObjetivosDias.IsEmpty Then
  Begin
    Dbg_FinanObjetivosResultadosDias.SetFocus;
    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_ObjetivosDias,Dbg_FinanObjetivosResultadosDias,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.Bt_FinanObjetivosResultDiasTamColunasClick(Sender: TObject);
Var
 i: Integer;
begin
  If (DMVirtual.CDS_V_ObjetivosDias.IsEmpty) and (DMVirtual.CDS_V_ObjetivosDias.Filter='VISIBEL=''S''') Then
   Exit;

  // Tamanho Colunas No FIXADAS ===============================================
  For i:=4 to Dbg_FinanObjetivosResultadosDias.Columns.Count-1 do
  Begin
    Dbg_FinanObjetivosResultadosDias.Columns[i].Width:=EdtFinanObjetivosResultDiasTamNaoFixas.AsInteger;
  End;

  // Tamanho Colunas FIXADAS =================================================== 
  Dbg_FinanObjetivosResultadosDias.Columns[0].Width:=EdtFinanObjetivosResultDiasTamColuna1.AsInteger;
  Dbg_FinanObjetivosResultadosDias.Columns[1].Width:=EdtFinanObjetivosResultDiasTamColuna2.AsInteger;
  Dbg_FinanObjetivosResultadosDias.Columns[2].Width:=EdtFinanObjetivosResultDiasTamColuna3.AsInteger;
  Dbg_FinanObjetivosResultadosDias.Columns[3].Width:=EdtFinanObjetivosResultDiasTamColuna4.AsInteger;

  // Fixa Colunas ==============================================================
  THackDBGrid(Dbg_FinanObjetivosResultadosDias).FixedCols:=5;

  // Posiciona no Grid =========================================================
  Dbg_FinanObjetivosResultadosDias.SetFocus;
end;

procedure TFrmBelShop.SubMenuFinanControleFeriadosAno1Click(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  SelecionaTabSheet(Ts_FinanFeriadosAno);
  CorSelecaoTabSheet(PC_Principal);
  Cbx_FinanFeriadosAnoMes.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanFeriadosAnoFecharClick(Sender: TObject);
begin
  If Gb_FinanFeriadosAnoInfFeriado.Enabled Then
  Begin
    If Bt_FinanFeriadosAnoSalvar.Caption='Incluir' Then
     Begin
       msg('Antes de Encerrar Termine a Incluso !!','A');
       EdtFinanFeriadosAnoDiaFeriado.SetFocus;
     End
    Else
     Begin
       msg('Antes de Encerrar Termine a Alterao !!','A');
       EdtFinanFeriadosAnoDesFeriado.SetFocus;
     End;

    Exit;
  End;
  
  Cbx_FinanFeriadosAnoMes.Text:='';
  EdtFinanFeriadosAnoAno.Clear;
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.Cbx_FinanFeriadosAnoMesExit(Sender: TObject);
Var
  MySql: String;
  i: Integer;
  b: Boolean;
begin

  If Trim(Cbx_FinanFeriadosAnoMes.Text)='' Then
  Begin
    If msg('Deseja Sair Desde Mdulo do Sistema ??','C')=2 Then
     Begin
       Cbx_FinanFeriadosAnoMes.SetFocus;
       Exit;
     End
    Else // If msg('Deseja Sair Desde Mdulo do Sistema ??','C')=2 Then
     Begin
       Bt_FinanFeriadosAnoFecharClick(Self);
       Exit;
     End; // If msg('Deseja Sair Desde Mdulo do Sistema ??','C')=2 Then
  End; // If Trim(Cbx_FinanFeriadosAnoMes.Text)='' Then

  b:=False;
  For i:=1 to 12 do
  Begin
    If AnsiUpperCase(LongMonthNames[i])=Cbx_FinanFeriadosAnoMes.Text Then
     b:=True;
  end;

  If Not b Then
  Begin
    msg('Ms Informado  Invlido !!','A');
    Cbx_FinanFeriadosAnoMes.SetFocus;
    Exit;
  End;

  If EdtFinanFeriadosAnoAno.Value>0 Then
  Begin
    // Cria Feriados do Ano ====================================================
    CriaFeriadosAno(EdtFinanFeriadosAnoAno.AsInteger);

    // Gera Perodo ============================================================
    AtualizaData(Cbx_FinanFeriadosAnoMes, sgPeriodo, EdtFinanFeriadosAnoAno.Text);  
    sgPeriodo:=f_Troca('-','.',sgPeriodo);
    sgPeriodo:=f_Troca('/','.',sgPeriodo);
    
    // Busca Feriados ==========================================================
    MySql:=' SELECT *'+
           ' FROM fin_feriados_ano f'+
           ' WHERE f.Ind_Ativo='+QuotedStr('SIM')+
           ' AND f.dta_feriado '+sgPeriodo+
           ' ORDER BY f.dta_feriado';
    DMBelShop.CDS_FeriadosAno.Close;
    DMBelShop.SDS_FeriadosAno.CommandText:=MySql;
    DMBelShop.CDS_FeriadosAno.Open;
  End; // If EdtFinanFeriadosAnoAno.Value>0 Then
  
end;

procedure TFrmBelShop.EdtFinanFeriadosAnoAnoExit(Sender: TObject);
Var
  MySql: String;
begin
  If EdtFinanFeriadosAnoAno.Value=0 Then
  Begin
    Cbx_FinanFeriadosAnoMes.SetFocus;
    Exit;
  End;

  If EdtFinanFeriadosAnoAno.Value<2000 Then
  Begin
    msg('Ano Invlido !!','A');
    EdtFinanFeriadosAnoAno.SetFocus;
    Exit;
  End;

  If Trim(Cbx_FinanFeriadosAnoMes.Text)<>'' Then
  Begin
    // Cria Feriados do Ano ====================================================
    CriaFeriadosAno(EdtFinanFeriadosAnoAno.AsInteger);

    // Gera Perodo ============================================================
    AtualizaData(Cbx_FinanFeriadosAnoMes, sgPeriodo, EdtFinanFeriadosAnoAno.Text);  
    sgPeriodo:=f_Troca('-','.',sgPeriodo);
    sgPeriodo:=f_Troca('/','.',sgPeriodo);

    // Busca Feriados ==========================================================
    MySql:=' SELECT *'+
           ' FROM fin_feriados_ano f'+
           ' WHERE f.Ind_Ativo='+QuotedStr('SIM')+
           ' AND f.dta_feriado '+sgPeriodo+
           ' ORDER BY f.dta_feriado';
    DMBelShop.CDS_FeriadosAno.Close;
    DMBelShop.SDS_FeriadosAno.CommandText:=MySql;
    DMBelShop.CDS_FeriadosAno.Open;

    Dbg_FinanFeriadosAnoDatasFeriado.SetFocus;
  End;

end;

procedure TFrmBelShop.EdtFinanFeriadosAnoDiaFeriadoExit(Sender: TObject);
Var
  s: String;
begin

  If EdtFinanFeriadosAnoDiaFeriado.Value<1 Then
  Begin
    Bt_FinanFeriadosAnoAbandonarClick(Self);
    Exit;
  End;

  s:=NumeroMes(Cbx_FinanFeriadosAnoMes.Text);
  Try
    StrToDate(EdtFinanFeriadosAnoDiaFeriado.Text+'/'+s+'/'+EdtFinanFeriadosAnoAno.Text);
  Except
    msg('Dia Invlido no MS !!','A');
    EdtFinanFeriadosAnoDiaFeriado.SetFocus;
    Exit;
  End; 

end;

procedure TFrmBelShop.Dbg_FinanFeriadosAnoDatasFeriadoKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  MySql: String;
begin
  If Key=VK_Insert Then
  Begin
    EdtFinanFeriadosAnoDiaFeriado.Value:=0;
    EdtFinanFeriadosAnoDiaFeriado.Enabled:=True;
    EdtFinanFeriadosAnoDiaFeriado.Color:=clWindow;
    EdtFinanFeriadosAnoDesFeriado.Clear;

    Bt_FinanFeriadosAnoSalvar.Caption:='Incluir';
    Gb_FinanFeriadosAnoInfFeriado.Enabled:=True;
    Gb_FinanFeriadosAnoMesAno.Enabled:=False;
    EdtFinanFeriadosAnoDiaFeriado.SetFocus;
  End; // If Key=VK_Insert Then
  
  If Key=VK_Delete Then
  Begin
    If Not DMBelShop.CDS_FeriadosAno.IsEmpty Then
    Begin
      If msg('Deseja Realmente Excluir'+cr+cr+'Feriado Selecionado ?','C')=2 Then
       Exit;

      // Monta Transacao =======================================================
      TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
      TD.IsolationLevel:=xilREADCOMMITTED;
      DMBelShop.SQLC.StartTransaction(TD);
      Try
        Screen.Cursor:=crAppStart; 
        DateSeparator:='.';
        DecimalSeparator:='.';

        If DMBelShop.CDS_FeriadosAnoIND_CALCULADO.AsString='SIM' Then
         Begin
           MySql:='Update FIN_FERIADOS_ANO'+
                  ' Set Ind_Ativo='+QuotedStr('NAO')+
                  ' Where Dta_Feriado='+
                  QuotedStr(DMBelShop.CDS_FeriadosAnoDTA_FERIADO.AsString);
           DMBelShop.SQLC.Execute(MySql,nil,nil);
         End 
        Else // If DMBelShop.CDS_FeriadosAnoIND_CALCULADO.AsString='SIM' Then
         Begin
           MySql:='Delete From FIN_FERIADOS_ANO'+
                  ' Where Dta_Feriado='+
                  QuotedStr(DMBelShop.CDS_FeriadosAnoDTA_FERIADO.AsString);
           DMBelShop.SQLC.Execute(MySql,nil,nil);
         End; // If DMBelShop.CDS_FeriadosAnoIND_CALCULADO.AsString='SIM' Then
        
        // Atualiza Transacao =======================================
        DMBelShop.SQLC.Commit(TD);

        DateSeparator:='/';
        DecimalSeparator:=',';
        Screen.Cursor:=crDefault;

        EdtFinanFeriadosAnoAnoExit(Self);
      Except
        on e : Exception do
        Begin
          // Abandona Transacao =====================================
          DMBelShop.SQLC.Rollback(TD);

          DateSeparator:='/';
          DecimalSeparator:=',';
          Screen.Cursor:=crDefault;

          MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
        End; // on e : Exception do
      End; // Try 
    End; //If Not DMBelShop.CDS_FeriadosAno.IsEmpty Then
  End; // If Key=VK_Delete Then
end;

procedure TFrmBelShop.Dbg_FinanFeriadosAnoDatasFeriadoDblClick(Sender: TObject);
begin
  If Not DMBelShop.CDS_FeriadosAno.IsEmpty Then
  Begin
    EdtFinanFeriadosAnoDiaFeriado.AsInteger:=StrToInt(Copy(DMBelShop.CDS_FeriadosAnoDTA_FERIADO.AsString,1,2));
    EdtFinanFeriadosAnoDiaFeriado.Enabled:=False;
    EdtFinanFeriadosAnoDiaFeriado.Color:=$00B9B9FF;
    EdtFinanFeriadosAnoDesFeriado.Text:=DMBelShop.CDS_FeriadosAnoDES_FERIADO.AsString;
    Bt_FinanFeriadosAnoSalvar.Caption:='Alterar';
    Gb_FinanFeriadosAnoInfFeriado.Enabled:=True;
    Gb_FinanFeriadosAnoMesAno.Enabled:=False;
    EdtFinanFeriadosAnoDesFeriado.SetFocus;
  End;

end;

procedure TFrmBelShop.Bt_FinanFeriadosAnoAbandonarClick(Sender: TObject);
begin
  // Retorna ===================================================================
  EdtFinanFeriadosAnoDiaFeriado.AsInteger:=0;
  EdtFinanFeriadosAnoDiaFeriado.Enabled:=True;
  EdtFinanFeriadosAnoDiaFeriado.Color:=clWindow;
  EdtFinanFeriadosAnoDesFeriado.Clear;

  Bt_FinanFeriadosAnoSalvar.Caption:='';
  Gb_FinanFeriadosAnoInfFeriado.Enabled:=False;
  Gb_FinanFeriadosAnoMesAno.Enabled:=True;
  Dbg_FinanFeriadosAnoDatasFeriado.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanFeriadosAnoSalvarClick(Sender: TObject);
Var
  sDta: String;
  MySql: String;
begin
  If Trim(EdtFinanFeriadosAnoDesFeriado.Text)='' Then
  Begin
    msg('Favor Informar a Descrio do Feriado !!','A');
    EdtFinanFeriadosAnoDesFeriado.SetFocus;
    Exit;
  End;

  sDta:=NumeroMes(Cbx_FinanFeriadosAnoMes.Text);
  If Length(sDta)<2 Then
   sDta:='0'+sDta;

  sDta:=EdtFinanFeriadosAnoDiaFeriado.Text+'.'+sDta+'.'+EdtFinanFeriadosAnoAno.Text;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Incluso =====================================================
    If Bt_FinanFeriadosAnoSalvar.Caption='Incluir' Then
    Begin
      MySql:=' Select f.Dta_Feriado, f.Des_Feriado, f.Ind_Calculado, f.Ind_Ativo'+
             ' From FIN_FERIADOS_ANO f'+
             ' Where f.Dta_Feriado='+QuotedStr(sDta);
      DMBelShop.CDS_BuscaRapida.Close;
      DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
      DMBelShop.CDS_BuscaRapida.Open;

      // Altera Feriado Calculado Mas Inativo -----------------------
      If (DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Calculado').AsString='SIM') And
         (DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Ativo').AsString='NAO') Then
      Begin
        MySql:='Update FIN_FERIADOS_ANO'+
               ' Set Des_Feriado='+QuotedStr(EdtFinanFeriadosAnoDesFeriado.Text)+
               ', Ind_Ativo='+QuotedStr('SIM')+
               ' Where Dta_Feriado='+QuotedStr(sDta);
        DMBelShop.SQLC.Execute(MySql,nil,nil);
      End;
       
      // Feriado j Cadastrado --------------------------------------
      If DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Ativo').AsString='SIM' Then
      Begin
        DMBelShop.CDS_FeriadosAno.Locate('Dta_Feriado',sDta,[]);
        msg('Dia de Feriado J Cadastrado !!','A');
      End;

      // Insere Feriado ---------------------------------------------
      If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Dta_Feriado').AsString)='' Then
      Begin
        MySql:='Insert Into FIN_FERIADOS_ANO'+
               ' Values ('+
               QuotedStr(sDta)+', '+
               QuotedStr(EdtFinanFeriadosAnoDesFeriado.Text)+', '+
               QuotedStr('NAO')+', '+
               QuotedStr('SIM')+')';
        DMBelShop.SQLC.Execute(MySql,nil,nil);
      End;

      DMBelShop.CDS_BuscaRapida.Close;
    End; // If Bt_FinanFeriadosAnoSalvar.Caption='Incluir' Then

    // Alterao ====================================================
    If Bt_FinanFeriadosAnoSalvar.Caption='Alterar' Then
    Begin
      MySql:='Update FIN_FERIADOS_ANO'+
             ' Set Des_Feriado='+QuotedStr(EdtFinanFeriadosAnoDesFeriado.Text)+
             ' Where Dta_Feriado='+QuotedStr(sDta);
      DMBelShop.SQLC.Execute(MySql,nil,nil);
    End; // If Bt_FinanFeriadosAnoSalvar.Caption='Incluir' Then

    // Fecha Transacao ==============================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;
    
    EdtFinanFeriadosAnoAnoExit(Self);
  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try 

  // Retorna ===================================================================
  EdtFinanFeriadosAnoDiaFeriado.AsInteger:=0;
  EdtFinanFeriadosAnoDiaFeriado.Enabled:=True;
  EdtFinanFeriadosAnoDiaFeriado.Color:=clWindow;
  EdtFinanFeriadosAnoDesFeriado.Clear;

  Bt_FinanFeriadosAnoSalvar.Caption:='';
  Gb_FinanFeriadosAnoInfFeriado.Enabled:=False;
  Gb_FinanFeriadosAnoMesAno.Enabled:=True;

  DMBelShop.CDS_FeriadosAno.Locate('Dta_Feriado',f_Troca('.','/',sDta),[]);

  Dbg_FinanFeriadosAnoDatasFeriado.SetFocus;

end;

procedure TFrmBelShop.Cbx_FinanFeriadosAnoMesSelect(Sender: TObject);
begin
  SelectNext(ActiveControl,True,True);
end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosDiasDrawDataCell(Sender: TObject;
          const Rect: TRect; Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_ObjetivosDias.IsEmpty Then
  Begin
    If (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=0) Or
       (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=1) Or
       (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=2) Or
       (THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex=3) Then
    Begin
      THackDBGrid(Dbg_FinanObjetivosResultadosDias).LeftCol:=5;
      THackDBGrid(Dbg_FinanObjetivosResultadosDias).SelectedIndex:=4;
      Dbg_FinanObjetivosResultadosDias.Refresh;
    End;
  End;

end;

procedure TFrmBelShop.Cbx_FinanObjetivosGerarMesChange(Sender: TObject);
Var
  s: String;
begin
  AtualizaData(Cbx_FinanObjetivosGerarMes, s, EdtFinanObjetivosGerarAno.Text);

  s:=Copy(s,10,10);
  DtEdt_FinanObjetivosGerarUltDia.Date:=PrimUltDia(StrToDateTime(s),'U');
end;

procedure TFrmBelShop.DtEdt_FinanObjetivosGerarUltDiaExit(Sender: TObject);
Var
  s: String;
begin
  AtualizaData(Cbx_FinanObjetivosGerarMes, s, EdtFinanObjetivosGerarAno.Text);

  s:=Copy(s,10,10);

  If (MonthOf(StrToDateTime(s))<>MonthOf(DtEdt_FinanObjetivosGerarUltDia.Date)) or 
     (YearOf(StrToDateTime(s))<>YearOf(DtEdt_FinanObjetivosGerarUltDia.Date)) Then
  Begin
    msg('Data do ltimo Dia '+cr+cr+'Fora do Ms Solicitado !!','A');
    Cbx_FinanObjetivosGerarMesChange(Self);
    DtEdt_FinanObjetivosGerarUltDia.SetFocus;
    Exit;
  End;
end;

procedure TFrmBelShop.SubMenuComprasEstoqueFisicoFinanceiroClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Inicializa Tabelas Virtuais para Filtros ==================================
  try
    DMVirtual.CDS_V_Produtos.CreateDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  Except
    DMVirtual.CDS_V_Produtos.EmptyDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  End;

  try
    DMVirtual.CDS_V_Fornecedores.CreateDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  Except
    DMVirtual.CDS_V_Fornecedores.EmptyDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  End;
  MontaSelectFornecedores;

  try
    DMVirtual.CDS_V_GruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  Except
    DMVirtual.CDS_V_GruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_SubGruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  Except
    DMVirtual.CDS_V_SubGruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  End;

  // Inicializa Curva ABC ======================================================
  Ckb_EstFisFinanCurvaTodas.Checked:=True;
  Ckb_EstFisFinanCurvaTodasClick(Self);

  Rb_EstFisFinanSaldoTodos.Checked:=True;
  Rb_EstFisFinanSaldoCom.Checked:=False;
  Rb_EstFisFinanSaldoSem.Checked:=False;
  Rb_EstFisFinanSaldoTodosClick(Self);

  Rb_EstFisFinanSqlSaldoTodos.Checked:=True;
  Rb_EstFisFinanSqlSaldoCom.Checked:=False;
  Rb_EstFisFinanSqlSaldoSem.Checked:=False;
  Rb_EstFisFinanSqlSaldoTodosClick(Self);

  //============================================================================
  // PageControl de Filtros - INICIO ===========================================
  //============================================================================
  //-----------------------------------------------------------------
  // Filtro de Fornecedores -----------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFornecedor.Visible:=True;
  // Curva ABC no Fornecedor
  Painel_FiltroOC.Visible:=False;
  // Obs para Utilizao no Movto de Comprovantes
  Label_MovtoComprovForn.Visible:=False;
  Label_MovtoComprovForn.Top:=Painel_FiltroOC.Top;

  //-----------------------------------------------------------------
  // Filtro de Produtos ---------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroProdutos.TabVisible:=True;
  // Filtor nao Produtos de No Compra
  Painel_FiltroNaoCompra.Visible:=False;
  // Filtro para Busca Pelo Nome
  Gb_CalculoFiltroNome.Visible:=True;
  EdtCalculoFiltroNome1.Clear;
  EdtCalculoFiltroNome2.Clear;
  EdtCalculoFiltroNome3.Clear;
  EdtCalculoFiltroNome4.Clear;

  //-----------------------------------------------------------------
  // Filtro de Grupos e SubGrupos -----------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupos.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Aplicaes dos Produtos ------------------------------
  //-----------------------------------------------------------------
  TS_FiltroAplicacao.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Familia de Preos ------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFamiliaPreco.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Grupos ST --------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupoST.TabVisible:=True;

  //-----------------------------------------------------------------
  // Grupo de Comprovantes ------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroComprovantes.TabVisible:=False;

  //-----------------------------------------------------------------
  // Posiciona o PC_Filtros em seu Parent ---------------------------
  //-----------------------------------------------------------------
  PC_Filtros.Parent:=Ts_EstFisFinaFiltros;
  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);
  //============================================================================
  // PageControl de Filtros - FIM ==============================================
  //============================================================================

  // Seleciona TabSheet ========================================================
  Cbx_EstFisFinanSituacaoProd.ItemIndex:=0;
  SelecionaTabSheet(Ts_EstoqueFisicoFinan);

  PC_EstoqueFisicoFinan.TabIndex:=0;

  EdtEstFisFinanCodListaPreco.Text:=sgCodListaPrePadrao;
  EdtEstFisFinanCodListaPrecoExit(Self);

  Cbx_EstFisFinanSituacaoProd.SetFocus;

end;

procedure TFrmBelShop.PC_EstoqueFisicoFinanChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_EstoqueFisicoFinan);

  If (PC_EstoqueFisicoFinan.ActivePage=Ts_EstFisFinaResutadoFisicoFinan) And (Ts_EstFisFinaResutadoFisicoFinan.CanFocus) Then
  Begin
    Bt_EstFisFinanVoltar.Parent:=Pan_EstFisFinaResutadoGiroFisicoFinan;
    Dbg_EstFisFinanEmpresa.SetFocus;
  End;

  If (PC_EstoqueFisicoFinan.ActivePage=Ts_EstFisFinaResutadoGiroEstoque) And (Ts_EstFisFinaResutadoGiroEstoque.CanFocus) Then
  Begin
    Bt_EstFisFinanVoltar.Parent:=Pan_EstFisFinaResutadoGiroEstoque;
    Dbg_EstFisFinanGiroEstoque.SetFocus;
  End;

end;

procedure TFrmBelShop.EdtEstFisFinanCodListaPrecoExit(Sender: TObject);
Var
  MySql: String;
begin

  EdtEstFisFinanListaPreco.Clear;
  If EdtEstFisFinanCodListaPreco.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Fornecedores =======================================================
    MySql:='select lp.nomelista, lp.codlista'+
           ' from lista lp'+
           ' where lp.desativada=''N'''+
           ' and lp.CodLista='+QuotedStr(FormatFloat('0000',EdtEstFisFinanCodListaPreco.AsInteger));
    IBQ_Matriz.Close;
    IBQ_Matriz.SQL.Clear;
    IBQ_Matriz.SQL.Add(MySql);
    IBQ_Matriz.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_Matriz.FieldByName('codlista').AsString)='' Then
    Begin
     msg('Lista de Preo NO Encontrada !!!', 'A');
     EdtEstFisFinanCodListaPreco.Clear;
     EdtEstFisFinanCodListaPreco.SetFocus;
     Exit;
    End;

    EdtEstFisFinanListaPreco.Text:=IBQ_Matriz.FieldByName('NomeLista').AsString;
  End;
end;

procedure TFrmBelShop.Bt_EstFisFinanBuscaListaPrecoClick(Sender: TObject);
Var
  MySql: String;
begin

  EdtEstFisFinanListaPreco.Clear;
  
  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);
  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:='select lp.nomelista, lp.codlista'+
         ' from lista lp'+
         ' where lp.desativada=''N'''+
         ' order by lp.nomelista';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('codlista').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtEstFisFinanCodListaPreco.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtEstFisFinanCodListaPreco.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeLista';
  FrmPesquisaIB.Campo_Codigo:='CodLista';
  FrmPesquisaIB.Campo_Descricao:='NomeLista';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    EdtEstFisFinanListaPreco.Text:=FrmPesquisaIB.EdtDescricao.Text;
    EdtEstFisFinanCodListaPreco.Text:=FrmPesquisaIB.EdtCodigo.Text;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Bt_EstFisFinanVoltarClick(Sender: TObject);
begin
  // Posiciona no TabSheet =====================================================
  PC_EstoqueFisicoFinan.ActivePage:=Ts_EstFisFinaFiltros;
  PC_EstoqueFisicoFinanChange(Self);
  Cbx_EstFisFinanSituacaoProd.SetFocus;
end;

procedure TFrmBelShop.Bt_EstFisFinanBuscaEstoquesClick(Sender: TObject);
Var
  i: Integer;
  iIndiceEmp, iIndiceLoja: Integer;
  cTotEstoque, cTotCusto, cTotVenda: Currency;
  MySql: String;
  bSiga: Boolean;
  sCodForn, sCodProd: String;
  cPrecoVenda, cPrecoComnpra: Currency;
  sCodLista: String;
begin

  If EdtEstFisFinanCodListaPreco.Value<1 Then
  Begin
    msg('Favor Informar a Lista de Preos !!','A');
    EdtEstFisFinanCodListaPreco.SetFocus;
    Exit;
  End;

  If Cbx_EstFisFinanSituacaoProd.ItemIndex=-1 Then
  Begin
    msg('Favor Informar a Situaes dos Produtos !!','A');
    Cbx_EstFisFinanSituacaoProd.SetFocus;
    Exit;
  End; // If (Trim(DtEdt_ConsultaOCDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaOCDtFim.Text)='') Then

  If msg('Deseja Realmente Estoques'+cr+'Fisico e Financeiro ??','C')=2 Then
   Exit;
   
  Screen.Cursor:=crAppStart;
  iIndiceEmp:=0;
  iIndiceLoja:=0;

  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Grupos e SubGrupos Selecionados ===========================================
  sgGrupos:='';
  sgSubGrupos:='';
  If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GruposProdutos.First;
    While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    Begin
      Refresh;

      If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
       Begin
         While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
         Begin
           Refresh;

           If sgSubGrupos='' Then
            sgSubGrupos:=QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString)
           Else
            sgSubGrupos:=sgSubGrupos+', '+
              QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString);

           DMVirtual.CDS_V_SubGruposProdutos.Next;
         End; // While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
         DMVirtual.CDS_V_SubGruposProdutos.First;
       End // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
      Else
       Begin
         If sgGrupos='' Then
          sgGrupos:='(p.codgruposub BetWeen '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'0000')+
                ' AND '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'9999')+')'
         Else
          sgGrupos:=sgGrupos+' Or (p.codgruposub BetWeen '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'0000')+
                ' AND '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'9999')+')';
       End; // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then

      If sgSubGrupos<>'' Then
      Begin
        If sgGrupos='' Then
         sgGrupos:='(p.codgruposub in ('+sgSubGrupos+'))'
        Else
         sgGrupos:=sgGrupos+' OR (p.codgruposub in ('+sgSubGrupos+'))';
      End;

      sgSubGrupos:='';

      DMVirtual.CDS_V_GruposProdutos.Next;
    End; // While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    DMVirtual.CDS_V_GruposProdutos.First;

    If sgGrupos<>'' Then
     sgGrupos:='('+sgGrupos+')';

  End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then

  // Seleciona Empresa =========================================================
  sgOutrasEmpresa:='(99)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;

  FrmSelectEmpProcessamento.ShowModal;
  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Existe Empresa a Processar ====================================
  If DMBelShop.CDS_EmpProcessa.Eof Then
  Begin
    PC_EstoqueFisicoFinan.TabIndex:=0;
    EdtEstFisFinanCodListaPreco.SetFocus;
    Screen.Cursor:=crDefault;    
    Exit;
  End;

  // Posiciona no Grid de Resultados da Empresa ================================
  PC_EstoqueFisicoFinan.TabIndex:=1;
  PC_EstoqueFisicoFinanChange(Self);
  Dbg_EstFisFinanEmpresa.SetFocus;

  // Cria DataSet's ============================================================
  If DMVirtual.CDS_V_EstFisFinanEmp.Active Then
   DMVirtual.CDS_V_EstFisFinanEmp.Close;
     
  DMVirtual.CDS_V_EstFisFinanEmp.CreateDataSet;
  DMVirtual.CDS_V_EstFisFinanEmp.Filtered:=False;
  DMVirtual.CDS_V_EstFisFinanEmp.Filter:='';
  DMVirtual.CDS_V_EstFisFinanEmp.Open;

  Rb_EstFisFinanSaldoTodos.Checked:=True;
  Rb_EstFisFinanSaldoCom.Checked:=False;
  Rb_EstFisFinanSaldoSem.Checked:=False;
  Rb_EstFisFinanSaldoTodosClick(Self);

  If DMVirtual.CDS_V_EstFisFinanLojas.Active Then
   DMVirtual.CDS_V_EstFisFinanLojas.Close;
     
  DMVirtual.CDS_V_EstFisFinanLojas.CreateDataSet;
  DMVirtual.CDS_V_EstFisFinanLojas.Open;

  // Fixa Colunas ==============================================================
  THackDBGrid(Dbg_EstFisFinanLojas).FixedCols:=3;
  THackDBGrid(Dbg_EstFisFinanEmpresa).FixedCols:=3;

  // Cria Cabecalho Empresa ====================================================
  Inc(iIndiceEmp);
  DMVirtual.CDS_V_EstFisFinanEmp.Insert;
  DMVirtual.CDS_V_EstFisFinanEmpDES_FORNECEDOR.AsString:='Data: '+
                DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  DMVirtual.CDS_V_EstFisFinanEmpINDICE.AsInteger:=iIndiceEmp;
  DMVirtual.CDS_V_EstFisFinanEmp.Post;

  // Linha em Branco ------------------------------------------------
  Inc(iIndiceEmp);
  DMVirtual.CDS_V_EstFisFinanEmp.Insert;
  DMVirtual.CDS_V_EstFisFinanEmpDES_FORNECEDOR.AsString:=' ';
  DMVirtual.CDS_V_EstFisFinanEmpINDICE.AsInteger:=iIndiceEmp;
  DMVirtual.CDS_V_EstFisFinanEmp.Post;

  Inc(iIndiceEmp);
  DMVirtual.CDS_V_EstFisFinanEmp.Insert;
  DMVirtual.CDS_V_EstFisFinanEmpDES_FORNECEDOR.AsString:='TOTAL EMPRESA';
  DMVirtual.CDS_V_EstFisFinanEmpINDICE.AsInteger:=iIndiceEmp;
  DMVirtual.CDS_V_EstFisFinanEmp.Post;

  // Linha em Branco ------------------------------------------------
  Inc(iIndiceEmp);
  DMVirtual.CDS_V_EstFisFinanEmp.Insert;
  DMVirtual.CDS_V_EstFisFinanEmpDES_FORNECEDOR.AsString:=' ';
  DMVirtual.CDS_V_EstFisFinanEmpINDICE.AsInteger:=iIndiceEmp;
  DMVirtual.CDS_V_EstFisFinanEmp.Post;

  // Cria Cabecalho Lojas ======================================================
  Inc(iIndiceLoja);
  DMVirtual.CDS_V_EstFisFinanLojas.Insert;
  DMVirtual.CDS_V_EstFisFinanLojasDES_FORNECEDOR.AsString:='Data: '+
                DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  DMVirtual.CDS_V_EstFisFinanLojasINDICE.AsInteger:=iIndiceLoja;
  DMVirtual.CDS_V_EstFisFinanLojasLINK.AsInteger:=999999;
  DMVirtual.CDS_V_EstFisFinanLojas.Post;

  // Linha em Branco ------------------------------------------------
  Inc(iIndiceLoja);
  DMVirtual.CDS_V_EstFisFinanLojas.Insert;
  DMVirtual.CDS_V_EstFisFinanLojasDES_FORNECEDOR.AsString:=' ';
  DMVirtual.CDS_V_EstFisFinanLojasINDICE.AsInteger:=iIndiceLoja;
  DMVirtual.CDS_V_EstFisFinanLojasLINK.AsInteger:=999999;
  DMVirtual.CDS_V_EstFisFinanLojas.Post;

  Inc(iIndiceLoja);
  DMVirtual.CDS_V_EstFisFinanLojas.Insert;
  DMVirtual.CDS_V_EstFisFinanLojasDES_FORNECEDOR.AsString:='LOJAS';
  DMVirtual.CDS_V_EstFisFinanLojasINDICE.AsInteger:=iIndiceLoja;
  DMVirtual.CDS_V_EstFisFinanLojasLINK.AsInteger:=999999;
  DMVirtual.CDS_V_EstFisFinanLojas.Post;

  // Linha em Branco ------------------------------------------------
  Inc(iIndiceLoja);
  DMVirtual.CDS_V_EstFisFinanLojas.Insert;
  DMVirtual.CDS_V_EstFisFinanLojasDES_FORNECEDOR.AsString:=' ';
  DMVirtual.CDS_V_EstFisFinanLojasINDICE.AsInteger:=iIndiceLoja;
  DMVirtual.CDS_V_EstFisFinanLojasLINK.AsInteger:=999999;
  DMVirtual.CDS_V_EstFisFinanLojas.Post;
  
  // Processa Empresas =========================================================
  sgLojasNConectadas:='';
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      sCodLista:=FormatFloat('0000',EdtEstFisFinanCodListaPreco.AsInteger);
      If (Trim(DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsString)<>'') and
         (FormatFloat('0000',DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsInteger)<>sCodLista) Then
      Begin
        sCodLista:=FormatFloat('0000',DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsInteger);
      End; // If (Trim(DMBelShop.CDS_EmpProcessaCOD_LISTAPRE.AsString)<>'') and

      // Guarda Codigo Empresa =================================================
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Loja: Bel_'+sgCodEmp+' - '+
                                 DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      // Conecta Empresa =======================================================
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         Refresh;
         bSiga:=False;

         If sgLojasNConectadas='' Then 
          sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
         Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
          sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then

      // Inicia Processamento ==================================================
      If bSiga Then // Empresa Conectada
      Begin
        // Cria Query da Empresa ------------------------------------
        CriaQueryIB('IBDB_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                    'IBT_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString,
                    IBQ_ConsultaFilial, True, True);

        MySql:=' Select p.codproduto, p.apresentacao,'+
               ' p.principalfor, fo.nomefornecedor,'+
               ' Cast(Coalesce(es.saldoatual,0) as Numeric(12,2)) Qtd_Estoque'+

               ' From Produto p'+
               '                left join estoque  es  on es.codproduto=p.codproduto'+
               '                                      and es.codfilial='+QuotedStr(sgCodEmp)+
               '                left join forneced fo  on fo.codfornecedor=p.principalfor';

               // Situacao dos Produtos -----------------------------
               If Cbx_EstFisFinanSituacaoProd.ItemIndex=0 Then
                MySql:=MySql+' Where Coalesce(p.situacaopro,0)=0';

               If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then
                MySql:=MySql+' Where Coalesce(p.situacaopro,3)=3';

               If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then
                MySql:=MySql+' Where Coalesce(p.situacaopro,0) in (0,3)';

               // Produtos Codigos e/ou Produtos Like ---------------------
               If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                MySql:=
                 MySql+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.', sgLikeProdutos)+')'
               Else If Trim(sgProdutos)<>'' Then
                MySql:=
                 MySql+' AND p.CodProduto in ('+sgProdutos+')'
               Else If Trim(sgLikeProdutos)<>'' Then
                MySql:=
                 MySql+' AND '+f_Troca('pr.','p.', sgLikeProdutos);

               // Fornecedores -------------------------------------
               If Trim(sgFornecedores)<>'' Then
                MySql:=MySql+' and p.principalfor in ('+sgFornecedores+')';

               // Grupos e SubGrupos --------------------------------
               If Trim(sgGrupos)<>'' Then
                MySql:=MySql+' and '+sgGrupos;

               // Saldo ---------------------------------------------
               If Rb_EstFisFinanSqlSaldoCom.Checked Then
                MySql:=MySql+' and Cast(Coalesce(es.saldoatual,0) as Numeric(12,2))>0';

               If Rb_EstFisFinanSqlSaldoSem.Checked Then
                MySql:=MySql+' and Cast(Coalesce(es.saldoatual,0) as Numeric(12,2))=0';

               MySql:=MySql+' Order By p.apresentacao';
        IBQ_ConsultaFilial.SQL.Clear;
        IBQ_ConsultaFilial.SQL.Add(MySql);

        // Abre Query -----------------------------------------------
        i:=0;
        bSiga:=False;
        While Not bSiga do
        Begin
          Try
            IBQ_ConsultaFilial.Open;
            bSiga:=True;
          Except
            Inc(i);
          End; // Try

          If i>10 Then
          Begin
            If sgLojasNConectadas='' Then
             sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
            Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
             sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
          End; // If i>10 Then
        End; // While Not bSiga do

        // Processamento =======================================================
        If bSiga Then // Query Executada
        Begin
          While Not IBQ_ConsultaFilial.Eof do
          Begin
            Refresh;
            Try // Se Empresa Perder a Conxo -------------------------

              // Busca Lista de Precos
              cPrecoComnpra:=0;
              cPrecoVenda  :=0;
              MySql:=' Select l.precocompra, l.precovenda'+
                     ' From listapre l'+
                     ' where l.codlista='+QuotedStr(sCodLista)+
                     ' And l.codproduto='+
                     QuotedStr(IBQ_ConsultaFilial.FieldByName('CodProduto').AsString);
              IBQ_MPMS.Close;
              IBQ_MPMS.SQL.Clear;
              IBQ_MPMS.SQL.Add(MySql);
              IBQ_MPMS.Open;

              If Not IBQ_MPMS.IsEmpty Then
              Begin
                cPrecoComnpra:=IBQ_MPMS.FieldByName('PrecoCompra').AsCurrency;
                cPrecoVenda:=IBQ_MPMS.FieldByName('PrecoVenda').AsCurrency;
              End;
              IBQ_MPMS.Close;

              // Empresa - Busca Fornecedor e Produto ---------------
              sCodForn:=IBQ_ConsultaFilial.FieldByName('PrincipalFor').AsString;
              sCodProd:=IBQ_ConsultaFilial.FieldByName('CodProduto').AsString;

              if DMVirtual.CDS_V_EstFisFinanEmp.Locate('Cod_Fornecedor;Cod_Produto', VarArrayOf([sCodForn,sCodProd]),[]) Then
               Begin
                 DMVirtual.CDS_V_EstFisFinanEmp.Edit;
                 DMVirtual.CDS_V_EstFisFinanEmpQTD_ESTOQUE.AsCurrency:=
                         DMVirtual.CDS_V_EstFisFinanEmpQTD_ESTOQUE.AsCurrency+
                         IBQ_ConsultaFilial.FieldByName('Qtd_Estoque').AsCurrency;

                 DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_CUSTO.AsCurrency:=
                             DMVirtual.CDS_V_EstFisFinanEmpQTD_ESTOQUE.AsCurrency*
                            DMVirtual.CDS_V_EstFisFinanEmpVLR_PC_CUSTO.AsCurrency;

                 DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_VENDA.AsCurrency:=
                             DMVirtual.CDS_V_EstFisFinanEmpQTD_ESTOQUE.AsCurrency*
                            DMVirtual.CDS_V_EstFisFinanEmpVLR_PC_VENDA.AsCurrency;
                 DMVirtual.CDS_V_EstFisFinanEmp.Post;
               End
              Else // if not DMVirtual.CDS_V_EstFisFinanEmp.Locate('Cod_Fornecedor;Cod_Produto', VarArrayOf([sCodForn,sCodProd]),[]) Then
               Begin
                 Inc(iIndiceEmp);

                 // Insere Estoque Fisico/ Financeiro ---------------
                 DMVirtual.CDS_V_EstFisFinanEmp.Insert;
                 DMVirtual.CDS_V_EstFisFinanEmpCOD_FORNECEDOR.AsString:=
                          IBQ_ConsultaFilial.FieldByName('PrincipalFor').AsString;
                 DMVirtual.CDS_V_EstFisFinanEmpDES_FORNECEDOR.AsString:=
                        IBQ_ConsultaFilial.FieldByName('NomeFornecedor').AsString;
                 DMVirtual.CDS_V_EstFisFinanEmpCOD_PRODUTO.AsString:=
                            IBQ_ConsultaFilial.FieldByName('CodProduto').AsString;
                 DMVirtual.CDS_V_EstFisFinanEmpDES_PRODUTO.AsString:=
                          IBQ_ConsultaFilial.FieldByName('Apresentacao').AsString;
                 DMVirtual.CDS_V_EstFisFinanEmpQTD_ESTOQUE.AsCurrency:=
                         IBQ_ConsultaFilial.FieldByName('Qtd_Estoque').AsCurrency;

                 DMVirtual.CDS_V_EstFisFinanEmpVLR_PC_CUSTO.AsCurrency:=cPrecoComnpra;
                 DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_CUSTO.AsCurrency:=cPrecoComnpra*
                                IBQ_ConsultaFilial.FieldByName('Qtd_Estoque').AsCurrency;

                 DMVirtual.CDS_V_EstFisFinanEmpVLR_PC_VENDA.AsCurrency:=cPrecoVenda;
                 DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_VENDA.AsCurrency:=cPrecoVenda*
                              IBQ_ConsultaFilial.FieldByName('Qtd_Estoque').AsCurrency;

                 DMVirtual.CDS_V_EstFisFinanEmpINDICE.AsInteger:=iIndiceEmp;
                 DMVirtual.CDS_V_EstFisFinanEmp.Post;
               End; // if not DMVirtual.CDS_V_EstFisFinanEmp.Locate('Cod_Fornecedor;Cod_Produto', VarArrayOf([sCodForn,sCodProd]),[]) Then

              // Lojas - Insere Resultado ---------------------------
              Inc(iIndiceLoja);

              DMVirtual.CDS_V_EstFisFinanLojas.Insert;
              DMVirtual.CDS_V_EstFisFinanLojasDES_PRODUTO.AsString:='Bel_'+sgCodEmp;
              DMVirtual.CDS_V_EstFisFinanLojasINDICE.AsInteger:=iIndiceLoja;
              DMVirtual.CDS_V_EstFisFinanLojasLINK.AsInteger:=
                                   DMVirtual.CDS_V_EstFisFinanEmpINDICE.AsInteger;
              DMVirtual.CDS_V_EstFisFinanLojas.Post;
             
              Inc(iIndiceLoja);

              DMVirtual.CDS_V_EstFisFinanLojas.Insert;
              DMVirtual.CDS_V_EstFisFinanLojasDES_FORNECEDOR.AsString:=
                        IBQ_ConsultaFilial.FieldByName('NomeFornecedor').AsString;
              DMVirtual.CDS_V_EstFisFinanLojasCOD_PRODUTO.AsString:=
                            IBQ_ConsultaFilial.FieldByName('CodProduto').AsString;
              DMVirtual.CDS_V_EstFisFinanLojasDES_PRODUTO.AsString:=
                          IBQ_ConsultaFilial.FieldByName('Apresentacao').AsString;
              DMVirtual.CDS_V_EstFisFinanLojasQTD_ESTOQUE.AsCurrency:=
                         IBQ_ConsultaFilial.FieldByName('Qtd_Estoque').AsCurrency;
                         
              DMVirtual.CDS_V_EstFisFinanLojasVLR_PC_CUSTO.AsCurrency:=cPrecoComnpra;
              DMVirtual.CDS_V_EstFisFinanLojasVLR_TOTAL_CUSTO.AsCurrency:=cPrecoComnpra*
                               IBQ_ConsultaFilial.FieldByName('Qtd_Estoque').AsCurrency;

              DMVirtual.CDS_V_EstFisFinanLojasVLR_PC_VENDA.AsCurrency:=cPrecoVenda;
              DMVirtual.CDS_V_EstFisFinanLojasVLR_TOTAL_VENDA.AsCurrency:=cPrecoVenda*
                             IBQ_ConsultaFilial.FieldByName('Qtd_Estoque').AsCurrency;

              DMVirtual.CDS_V_EstFisFinanLojasINDICE.AsInteger:=iIndiceLoja;
              DMVirtual.CDS_V_EstFisFinanLojasLINK.AsInteger:=
                                   DMVirtual.CDS_V_EstFisFinanEmpINDICE.AsInteger;
              DMVirtual.CDS_V_EstFisFinanLojas.Post;

              IBQ_ConsultaFilial.Next;
            Except
              on e : Exception do
              Begin
                Screen.Cursor:=crDefault;

                MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
                Break;
              End; // on e : Exception do
            End; // Try // Se Empresa Perder a Conexo

          End; // While Not IBQ_ConsultaFilial.Eof do
          IBQ_ConsultaFilial.Close;

        End; // If bSiga Then // Query Executada
      End; //If bSiga Then // Empresa Conectada

      // Apresenta o Processamento ------------------------------------
      OdirPanApres.Caption:='AGUARDE !! Efetuando Processamento ...';
      Refresh;

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
      
    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  // Calcula Totais da Empresa =================================================
  cTotCusto:=0;
  cTotEstoque:=0;
  cTotVenda:=0;
  DMVirtual.CDS_V_EstFisFinanEmp.First;
  While Not DMVirtual.CDS_V_EstFisFinanEmp.Eof do
  Begin
    Refresh;
    
    If Trim(DMVirtual.CDS_V_EstFisFinanEmpCOD_FORNECEDOR.AsString)<>'' Then
    Begin
      cTotCusto:=cTotCusto+DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_CUSTO.AsCurrency;
      cTotEstoque:=cTotEstoque+DMVirtual.CDS_V_EstFisFinanEmpQTD_ESTOQUE.AsCurrency;
      cTotVenda:=cTotVenda+DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_VENDA.AsCurrency;
    End; // If Trim(DMVirtual.CDS_V_EstFisFinanEmpCOD_FORNECEDOR.AsString)<>'' Then
    
    DMVirtual.CDS_V_EstFisFinanEmp.Next;
  End;// While Not DMVirtual.CDS_V_EstFisFinanEmp.Eof do

  DMVirtual.CDS_V_EstFisFinanEmp.Locate('DES_FORNECEDOR','TOTAL EMPRESA',[]);
  DMVirtual.CDS_V_EstFisFinanEmp.Edit;
  DMVirtual.CDS_V_EstFisFinanEmpQTD_ESTOQUE.AsCurrency:=cTotEstoque;
  DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_CUSTO.AsCurrency:=cTotCusto;
  DMVirtual.CDS_V_EstFisFinanEmpVLR_TOTAL_VENDA.AsCurrency:=cTotVenda;
  DMVirtual.CDS_V_EstFisFinanEmp.Post;
  DMVirtual.CDS_V_EstFisFinanEmp.First;
  
  Screen.Cursor:=crDefault;    
  OdirPanApres.Visible:=False;

  IBQ_MPMS.Close;
  msg('Processamento Efetuado com SUCESSO !!','A');

  // Apresenta Lojas No Conectadas ============================================
  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');

End;

procedure TFrmBelShop.Bt_EstFisFinanSalvarEmpresaClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_EstFisFinanEmp.IsEmpty Then
  Begin
    Dbg_EstFisFinanEmpresa.SetFocus;
    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_EstFisFinanEmp,Dbg_EstFisFinanEmpresa,Mem_Salvar);
  End;
end;

procedure TFrmBelShop.Dbg_EstFisFinanEmpresaColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_EstFisFinanEmpresa).SelectedIndex = 0) Or
     (THackDBGrid(Dbg_EstFisFinanEmpresa).SelectedIndex = 1) then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_EstFisFinanEmpresa).LeftCol := 3; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_EstFisFinanEmpresa).SelectedIndex := 2; // Index da 1 Coluna No Fixada Sem Contar Indicador
  end;
end;

procedure TFrmBelShop.Dbg_EstFisFinanLojasColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_EstFisFinanLojas).SelectedIndex = 0) Or
     (THackDBGrid(Dbg_EstFisFinanLojas).SelectedIndex = 1) then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_EstFisFinanLojas).LeftCol := 3; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_EstFisFinanLojas).SelectedIndex := 2; // Index da 1 Coluna No Fixada Sem Contar Indicador
  end;
end;

procedure TFrmBelShop.Dbg_EstFisFinanEmpresaColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_EstFisFinanEmpresaColEnter(Self);

end;

procedure TFrmBelShop.Dbg_EstFisFinanLojasColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_EstFisFinanLojasColEnter(Self);

end;

procedure TFrmBelShop.Dbg_EstFisFinanEmpresaDrawDataCell(Sender: TObject; const Rect: TRect;
          Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_EstFisFinanEmp.IsEmpty Then
  Begin
    If (THackDBGrid(Dbg_EstFisFinanEmpresa).SelectedIndex = 0) Or
       (THackDBGrid(Dbg_EstFisFinanEmpresa).SelectedIndex = 1) then // Index das Colunas Fixadas Sem Indicador
    Begin
      THackDBGrid(Dbg_EstFisFinanEmpresa).LeftCol := 3; // Index da 1 Coluna No Fixada Contando Indicador
      THackDBGrid(Dbg_EstFisFinanEmpresa).SelectedIndex := 2; // Index da 1 Coluna No Fixada Sem Contar Indicador
    End;
  End;
end;

procedure TFrmBelShop.Dbg_EstFisFinanLojasDrawDataCell(Sender: TObject; const Rect: TRect;
          Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_EstFisFinanLojas.IsEmpty Then
  Begin
    If (THackDBGrid(Dbg_EstFisFinanLojas).SelectedIndex = 0) Or
       (THackDBGrid(Dbg_EstFisFinanLojas).SelectedIndex = 1) then // Index das Colunas Fixadas Sem Indicador
    Begin
      THackDBGrid(Dbg_EstFisFinanLojas).LeftCol := 3; // Index da 1 Coluna No Fixada Contando Indicador
      THackDBGrid(Dbg_EstFisFinanLojas).SelectedIndex := 2; // Index da 1 Coluna No Fixada Sem Contar Indicador
    End;
  End;
end;

procedure TFrmBelShop.Dbg_EstFisFinanEmpresaKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  // Acerta Posicio na Celula ================================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_EstFisFinanEmpresa).SelectedIndex = 2) then
  Begin
    Key := VK_Clear;
    Dbg_EstFisFinanEmpresa.Refresh;
  End;
end;

procedure TFrmBelShop.Dbg_EstFisFinanLojasKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  // Acerta Posicio na Celula ================================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_EstFisFinanLojas).SelectedIndex = 2) then
  Begin
    Key := VK_Clear;
    Dbg_EstFisFinanLojas.Refresh;
  End;
end;

procedure TFrmBelShop.Dbg_EstFisFinanEmpresaDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_EstFisFinanEmpresaColEnter(Self);

end;

procedure TFrmBelShop.Dbg_EstFisFinanLojasDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  If Not DMVirtual.CDS_V_EstFisFinanLojas.IsEmpty Then
   Dbg_EstFisFinanLojasColEnter(Self);

end;

procedure TFrmBelShop.Bt_EstFisFinanSalvarLojasClick(Sender: TObject);
begin
  If Trim(DMVirtual.CDS_V_EstFisFinanEmpCOD_PRODUTO.AsString)='' Then
   Exit;

  If Not DMVirtual.CDS_V_EstFisFinanLojas.IsEmpty Then
  Begin

    If msg('Salvar Somente Resultado'+cr+cr+'do Produto Selecionado ?','C')=1 Then
     Begin
       SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_EstFisFinanLojas,Dbg_EstFisFinanLojas,Mem_Salvar);
     End
    Else // If msg('Salvar Somente Resultado'+cr+cr+'do Produto Selecionado ?','C')=2 Then
     Begin
        DMVirtual.CDS_V_EstFisFinanLojas.Filtered:=False;
        SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_EstFisFinanLojas,Dbg_EstFisFinanLojas,Mem_Salvar);
        DMVirtual.CDS_V_EstFisFinanEmpAfterScroll(DMVirtual.CDS_V_EstFisFinanEmp);
        
     End; // If msg('Salvar Somente Resultado'+cr+cr+'do Produto Selecionado ?','C')=2 Then
    Dbg_EstFisFinanEmpresa.SetFocus;
  End;

end;

procedure TFrmBelShop.PC_CurvaABCFornEndChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_CurvaABCFornEnd);
end;

procedure TFrmBelShop.Bt_CurvaABCEndDistrEnderecoClick(Sender: TObject);
//Var
//  bSIDICOM: Boolean;
begin
// OdirApagar  - 09/06/2017
//  msg('Opo Desabilitada Momentaneamente !!','A');
//  Exit;
//
//  Dbg_CurvaABCEndCurvaABC.SetFocus;
//  bSIDICOM:=True;
//  If msg('Deseja Manter Endereamento'+cr+'do SIDICOM ?? !!','C')=2 Then
//   bSIDICOM:=False;
//
//  If bSIDICOM Then
//  Begin
//   If msg('Deseja Realmente Efetuar a Distribuio de'+cr+'Endereamente MANTENDO o ENDEREO do SIDICOM  ??','C')=2 Then
//    Exit;
//  End;
//
//  If Not bSIDICOM Then
//  Begin
//   If msg('Deseja Realmente Efetuar a Distribuio de'+cr+'Endereamente SEM MANTER o ENDEREO do SIDICOM  ??','C')=2 Then
//    Exit;
//  End;
//
//// OdirApagar AtualizaEnderecamentos - 09/06/2017
////  AtualizaEnderecamentos(bSIDICOM);
//
//  msg('SIDICOM No Atualizado...'+cr+cr+'Faltam Definioes Sobre MPMS !!','A');
end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutEmpresasKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  sCodObjetivo: String;  
  s, ss: String;
begin
  If (Key=VK_F6) and (Not Dbg_FinanObjetivosManut.Enabled) Then
  Begin
    sCodObjetivo:=DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
   
    FrmObjetivosFormula:=TFrmObjetivosFormula.Create(Self);
    FrmObjetivosFormula.Ts_ObjetivosFormulaCompr.TabVisible:=False;
    FrmObjetivosFormula.Ts_ObjetivosFormulaTpEstoque.TabVisible:=False;

    bgProcessar:=False;
    FrmObjetivosFormula.ShowModal;

    Refresh;
    If bgProcessar Then
    Begin
      s :=FrmObjetivosFormula.EdtObjetivosCalculoCodObjetivo1.Text;
      ss:=FrmObjetivosFormula.EdtObjetivosCalculoCodObjetivo2.Text;
      CalculaValoresObjetivo(sCodObjetivo, s, ss, FrmObjetivosFormula.sTipoOperacao);
    End; // If bgProcessar Then

    FreeAndNil(FrmObjetivosFormula);

  End; // If (Key=VK_F6) and (Not Dbg_FinanObjetivosManut.Enabled) Then
 
end;

procedure TFrmBelShop.Bt_FinanObjetivosGraficoVoltarClick(Sender: TObject);
begin
  // Posiciona no TabSheet =====================================================
  Ts_FinanObjetivosGraficos.TabVisible:=False;
  PC_FinanObjetivos.ActivePage:=Ts_FinanObjetivosResultadosDias;
  Dbg_FinanObjetivosResultadosDias.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanObjetivosDiasGraficosClick(Sender: TObject);
begin

  If (DMVirtual.CDS_V_ObjetivosDias.IsEmpty)  and 
     (DMVirtual.CDS_V_ObjetivosMeses.IsEmpty) and 
     (DMVirtual.CDS_V_ObjetivosAuditorias.IsEmpty) Then
  Begin
    msg('SEM Objetivo Calculado !!','A');
    Exit;
  End;

  // Fecha Grafico =============================================================
  Ckb_FinanObjetivosGraficoMouse.Checked:=False;
  Ckb_FinanObjetivosGraficoValorVertical.Checked:=False;
  FechaSeriesGraficos;

  // Monta Selees de Objetivos ===============================================
  Cbx_FinanObjetivosGraficoObjetivos.Items.Clear;
  DMBelShop.CDS_Objetivos.First;
  While Not DMBelShop.CDS_Objetivos.Eof do
  Begin
    Refresh;
                
    If (DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM') and (DMBelShop.CDS_ObjetivosPROC.AsString='SIM') Then
     Cbx_FinanObjetivosGraficoObjetivos.Items.Add(
                             DMBelShop.CDS_ObjetivosDES_OBJETIVO.AsString+' - '+
                                  DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString);
    
    DMBelShop.CDS_Objetivos.Next;
  End; // While Not DMBelShop.CDS_Objetivos.Eof do  

  // Monta Selees de Empresas ================================================
  Cbx_FinanObjetivosGraficoEmpresas.Items.Clear;
  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Cbx_FinanObjetivosGraficoEmpresas.Items.Add('Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_Objetivos.Eof do  
  Cbx_FinanObjetivosGraficoEmpresas.Items.Add('Empresa');

  // Apresenta TabSheet ========================================================
  Cbx_FinanObjetivosGraficoTpApres.ItemIndex:=0;
  Gb_FinanObjetivosGraficoTpGrafico.Enabled:=False;
  Gb_FinanObjetivosGraficoMouse.Enabled:=False;
  Gb_FinanObjetivosGraficoValorVertical.Enabled:=False;
  Pan_FinanObjetivosGrafico3D.Enabled:=False;
  if (Trim(Cbx_FinanObjetivosGraficoObjetivos.Text)<>'') And (Trim(Cbx_FinanObjetivosGraficoEmpresas.Text)<>'') Then
  Begin
    Gb_FinanObjetivosGraficoTpGrafico.Enabled:=True;
    Gb_FinanObjetivosGraficoMouse.Enabled:=True;
    Gb_FinanObjetivosGraficoValorVertical.Enabled:=True;
    Pan_FinanObjetivosGrafico3D.Enabled:=True;
  End; // if (Trim(Cbx_FinanObjetivosGraficoObjetivos.Text)<>'') And (Trim(Cbx_FinanObjetivosGraficoEmpresas.Text)<>'') Then
  
  Ts_FinanObjetivosGraficos.TabVisible:=True;
  PC_FinanObjetivos.ActivePage:=Ts_FinanObjetivosGraficos;
  CorSelecaoTabSheet(PC_FinanObjetivos);

end;

procedure TFrmBelShop.Cbx_FinanObjetivosGraficoObjetivosChange(Sender: TObject);
begin
  // Fecha Series do Grafico ===================================================
  FechaSeriesGraficos;

  // Libera Gerao do Grafico =================================================
  Gb_FinanObjetivosGraficoTpGrafico.Enabled:=False;
  Gb_FinanObjetivosGraficoMouse.Enabled:=False;
  Gb_FinanObjetivosGraficoValorVertical.Enabled:=False;
  Pan_FinanObjetivosGrafico3D.Enabled:=False;
  if (Trim(Cbx_FinanObjetivosGraficoObjetivos.Text)<>'') And (Trim(Cbx_FinanObjetivosGraficoEmpresas.Text)<>'') Then
  Begin
    Gb_FinanObjetivosGraficoTpGrafico.Enabled:=True;
    Gb_FinanObjetivosGraficoMouse.Enabled:=True;
    Gb_FinanObjetivosGraficoValorVertical.Enabled:=True;
    Pan_FinanObjetivosGrafico3D.Enabled:=True;

    // Apresenta Grafico =======================================================
    ApresentaGraficoObjetivosMetas;
    
    If Cbx_FinanObjetivosGraficoTpApres.Text<>'Sem Apresentao' Then
     Cbx_FinanObjetivosGraficoTpApresChange(Self);

  End; // if (Trim(Cbx_FinanObjetivosGraficoObjetivos.Text)<>'') And (Trim(Cbx_FinanObjetivosGraficoEmpresas.Text)<>'') Then

end;

procedure TFrmBelShop.Rb_FinanObjetivosGraficoTpBarrasClick(Sender: TObject);
begin

  AcertaRb_Style(Rb_FinanObjetivosGraficoTpBarras);
  AcertaRb_Style(Rb_FinanObjetivosGraficoTpLinha);
  AcertaRb_Style(Rb_FinanObjetivosGraficoTpPizza);

  Cbx_FinanObjetivosGraficoObjetivosChange(Self);

end;

procedure TFrmBelShop.Ckb_FinanObjetivosGraficoMouseClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanObjetivosGraficoMouse);
  
  If Ckb_FinanObjetivosGraficoMouse.Checked Then
  Begin
    OldX:=-1;                          { initialize variables }
    CrossHairColor:=clYellow;
    CrossHairStyle:=psSolid;
  End;

end;

procedure TFrmBelShop.DbGrafico_FinanObjetivosGraficoMouseMove(Sender: TObject; Shift: TShiftState; X, Y: Integer);
  { This procedure draws the crosshair lines }
  Procedure DrawCross(AX,AY:Integer);
  begin
    With DbGrafico_FinanObjetivosGrafico,Canvas do
    begin
      Pen.Color:=CrossHairColor;
      Pen.Style:=CrossHairStyle;
      Pen.Mode:=pmXor;
      Pen.Width:=2;
      MoveTo(ax,ChartRect.Top-Height3D);
      LineTo(ax,ChartRect.Bottom-Height3D);
      MoveTo(ChartRect.Left+Width3D,ay);
      LineTo(ChartRect.Right+Width3D,ay);
    end;
  end;

//Var 
//  tmpX, tmpY:Double;
begin
  if not Ckb_FinanObjetivosGraficoMouse.Checked Then
   Exit;
   
  if (OldX<>-1) then
  begin
    DrawCross(OldX,OldY);  { draw old crosshair }
    OldX:=-1;
  end;

  { check if mouse is inside Chart rectangle }
  if PtInRect( DbGrafico_FinanObjetivosGrafico.ChartRect, Point(X-DbGrafico_FinanObjetivosGrafico.Width3D,Y+DbGrafico_FinanObjetivosGrafico.Height3D)) Then
  begin
    DrawCross(x,y);  { draw crosshair at current position }
    { store old position }
    OldX:=x;
    OldY:=y;
    { set label text }
//    With Linha do
//    begin
//      GetCursorValues(tmpX,tmpY);  { <-- get values under mouse cursor }
////      Label3.Caption:=GetVertAxis.LabelValue(tmpY)+
////                      ' '+
////                      GetHorizAxis.LabelValue(tmpX);
//    end;
  end;

end;

procedure TFrmBelShop.Sb_FinanObjetivosGrafico3DChange(Sender: TObject);
begin
  DbGrafico_FinanObjetivosGrafico.Chart3DPercent:=Sb_FinanObjetivosGrafico3D.Position;
end;

procedure TFrmBelShop.Ckb_FinanObjetivosGrafico3DClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanObjetivosGrafico3D);

  If Ckb_FinanObjetivosGrafico3D.Checked Then
   Begin
     Sb_FinanObjetivosGrafico3D.Enabled:=True;

     If Rb_FinanObjetivosGraficoTpLinha.Checked Then
      gsLinha.LinePen.Width:=1;
   End
  Else
   Begin
     Sb_FinanObjetivosGrafico3D.Enabled:=False;

     If Rb_FinanObjetivosGraficoTpLinha.Checked Then
      gsLinha.LinePen.Width:=8;
   End;

  DbGrafico_FinanObjetivosGrafico.View3D:=Ckb_FinanObjetivosGrafico3D.Checked;

  // Verifica de nao de pizza ==================================================
  If Not Rb_FinanObjetivosGraficoTpPizza.Checked Then
   DbGrafico_FinanObjetivosGrafico.View3DOptions.Orthogonal:=True;

end;

procedure TFrmBelShop.Bt_FinanObjetivosGraficoSalvarClick(Sender: TObject);
Var
  SaveDialog: TSaveDialog;
begin

  // Salva em Memria ==========================================================
  If Rb_FinanObjetivosGraficoTpClipboard.Checked Then
  Begin
    DbGrafico_FinanObjetivosGrafico.CopyToClipboardMetafile(True); 

    msg('Arquivo Salvo em Memria'+#13+'Use < Ctrl + V > para Busca da Memria !','A');
    Exit;
  End; // If Rb_FinanObjetivosGraficoTpClipboard.Checked Then


  SaveDialog:=TSaveDialog.Create(SaveDialog);

  // Salva em BMP ==============================================================
  If Rb_FinanObjetivosGraficoTpBMP.Checked Then
  Begin
    With SaveDialog do
    Begin
      Options := [ofPathMustExist, ofHideReadOnly, ofOverwritePrompt];
      DefaultExt := 'BMP';
      Filter := 'Arquivo (*.BMP)|*.BMP';
      FilterIndex := 1;
      Title := 'Salvar Arquivo';

      If Execute then
       Begin
         DbGrafico_FinanObjetivosGrafico.SaveToMetafile(SaveDialog.FileName);
       End
      Else // if Execute then
       Begin
         Free;
         Exit;
       End; // if Execute then

      Free;
    End; // With SaveDialog do
  End; //If Rb_FinanObjetivosGraficoTpBMP.Checked Then

  // Salva em WMF ==============================================================
  If Rb_FinanObjetivosGraficoTpWMF.Checked Then
  Begin
    With SaveDialog do
    Begin
      Options := [ofPathMustExist, ofHideReadOnly, ofOverwritePrompt];
      DefaultExt := 'WMF';
      Filter := 'Arquivo (*.WMF)|*.WMF';
      FilterIndex := 1;
      Title := 'Salvar Arquivo';

      If Execute then
       Begin
         DbGrafico_FinanObjetivosGrafico.SaveToMetafile(SaveDialog.FileName);
       End
      Else // If Execute then
      Begin
        Free;
        Exit;
      End; // If Execute then

      Free;
    End; // With SaveDialog do
  End; //If Rb_FinanObjetivosGraficoTpBMP.Checked Then
  
end;

procedure TFrmBelShop.Cbx_FinanObjetivosGraficoTpApresChange(Sender: TObject);
begin
 
  // Apresenta Grafico =========================================================
  If Cbx_FinanObjetivosGraficoTpApres.Text='Sem Apresentao' Then
  Begin
    If Rb_FinanObjetivosGraficoTpBarras.Checked Then gsBarra.Marks.Visible:=False;
    If Rb_FinanObjetivosGraficoTpLinha.Checked  Then gsLinha.Marks.Visible:=False;
    If Rb_FinanObjetivosGraficoTpPizza.Checked  Then gsPizza.Marks.Visible:=False;
  End;

  If (Cbx_FinanObjetivosGraficoTpApres.Text='Resultado') or (Cbx_FinanObjetivosGraficoTpApres.Text='Percentual')Then
  Begin
    If Rb_FinanObjetivosGraficoTpBarras.Checked Then 
    Begin
      gsBarra.Marks.Style:=smsValue;
      gsBarra.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpLinha.Checked Then
    Begin
      gsLinha.Marks.Style:=smsValue;
      gsLinha.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpPizza.Checked Then 
    Begin
      gsPizza.Marks.Style:=smsValue;
      gsPizza.Marks.Visible:=True;
    End;
  End; // If (Cbx_FinanObjetivosGraficoTpApres.Text='Resultado') or (Cbx_FinanObjetivosGraficoTpApres.Text='Percentual')Then

  If Cbx_FinanObjetivosGraficoTpApres.Text='Descrio' Then
  Begin
    If Rb_FinanObjetivosGraficoTpBarras.Checked Then 
    Begin
      gsBarra.Marks.Style:=smsLabel;
      gsBarra.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpLinha.Checked Then
    Begin
      gsLinha.Marks.Style:=smsLabel;
      gsLinha.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpPizza.Checked Then 
    Begin
      gsPizza.Marks.Style:=smsLabel;
      gsPizza.Marks.Visible:=True;
    End;
  End; // If Cbx_FinanObjetivosGraficoTpApres.Text='Descrio' Then
  
  If Cbx_FinanObjetivosGraficoTpApres.Text='Descrio/Percentual' Then
  Begin
    If Rb_FinanObjetivosGraficoTpBarras.Checked Then 
    Begin
      gsBarra.Marks.Style:=smsLabelValue;
      gsBarra.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpLinha.Checked Then
    Begin
      gsLinha.Marks.Style:=smsLabelValue;
      gsLinha.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpPizza.Checked Then 
    Begin
      gsPizza.Marks.Style:=smsLabelValue;
      gsPizza.Marks.Visible:=True;
    End;
  End; // If Cbx_FinanObjetivosGraficoTpApres.Text='Descrio/Percentual' Then

  If Cbx_FinanObjetivosGraficoTpApres.Text='Descrio/Resultado' Then
  Begin
    If Rb_FinanObjetivosGraficoTpBarras.Checked Then
    Begin
      gsBarra.Marks.Style:=smsLabelValue;
      gsBarra.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpLinha.Checked Then
    Begin
      gsLinha.Marks.Style:=smsLabelValue;
      gsLinha.Marks.Visible:=True;
    End;

    If Rb_FinanObjetivosGraficoTpPizza.Checked Then 
    Begin
      gsPizza.Marks.Style:=smsLabelValue;
      gsPizza.Marks.Visible:=True;
    End;
  End; // If Cbx_FinanObjetivosGraficoTpApres.Text='Descrio/Resultado' Then

end;

procedure TFrmBelShop.Ckb_FinanObjetivosGraficoValorVerticalClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanObjetivosGraficoValorVertical);
  
  If Ckb_FinanObjetivosGraficoValorVertical.Checked Then
   DbGrafico_FinanObjetivosGrafico.LeftAxis.Visible:=True
  Else
   DbGrafico_FinanObjetivosGrafico.LeftAxis.Visible:=False;

end;

procedure TFrmBelShop.Cbx_FinanObjetivosGraficoTpApresClick(Sender: TObject);
begin
  Cbx_FinanObjetivosGraficoObjetivosChange(Self);

end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutDblClick(Sender: TObject);
begin
  DMBelShop.CDS_Objetivos.Edit;
  If DMBelShop.CDS_ObjetivosPROC.AsString='SIM' Then
   DMBelShop.CDS_ObjetivosPROC.AsString:='NAO'
  Else
   DMBelShop.CDS_ObjetivosPROC.AsString:='SIM';

  DMBelShop.CDS_Objetivos.Post;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutTitleClick(Column: TColumn);
begin
  If (OrderGrid='') or (OrderGrid='Crescente') Then
   Begin
     OrderByGrid(DMBelShop.CDS_Objetivos, Dbg_FinanObjetivosManut, Column.FieldName, False);
     OrderGrid:='Decrescente';
   End
  Else
   Begin
     OrderByGrid(DMBelShop.CDS_Objetivos, Dbg_FinanObjetivosManut, Column.FieldName, True);
     OrderGrid:='Crescente';
   End
end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    if DMBelShop.CDS_ObjetivosPROC.AsString='SIM' then
     Dbg_FinanObjetivosManut.Canvas.Brush.Color:=clSkyBlue
    Else
     Dbg_FinanObjetivosManut.Canvas.Brush.Color:=$00E4F2F3;//$00EAEAFF;

    Dbg_FinanObjetivosManut.Canvas.FillRect(Rect);
    Dbg_FinanObjetivosManut.DefaultDrawDataCell(Rect,Column.Field,state);
  End;

end;

procedure TFrmBelShop.Rb_FinanObjetivosManutTpOperacaoLojaClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_FinanObjetivosManutTpOperacaoLoja);
  AcertaRb_Style(Rb_FinanObjetivosManutTpOperacaoSalao);
  AcertaRb_Style(Rb_FinanObjetivosManutTpOperacaoAmbos);

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutAuditoriaClick(Sender: TObject);
Var
 MySql: String;  
begin

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    Ckb_FinanObjetivosManutAuditoria.Checked:=False;
    AcertaCkb_Style(Ckb_FinanObjetivosManutAuditoria);
    Exit;
  End;

  Gb_FinanObjetivosManutTpOperacao.Enabled:=True;
  Ckb_FinanObjetivosManutNaoCompra.Enabled:=True;
  Ckb_FinanObjetivosManutNaoCompra.Checked:=False;
  AcertaCkb_Style(Ckb_FinanObjetivosManutNaoCompra);
  
  AcertaCkb_Style(Ckb_FinanObjetivosManutAuditoria);
  Dbe_FinanObjetivosManutDecimais.SetFocus;

  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    MySql:=' select *'+                                 //EST. FINAN. VENDA
           ' from Fin_Objetivos o'+                     //EST. FINAN. AUDITORIA 
           ' where o.Des_Formula='+QuotedStr('AUDITORIA/EST. FINAN. AUDITORIA')+
           ' and o.Cod_Objetivo<>'+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Objetivo').AsString)<>'' Then
    Begin
      msg('Objetivo de Auditoria j Existe'+cr+'Codigo do Ojetivo de Auditoria: '+DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Objetivo').AsString,'A');
      Ckb_FinanObjetivosManutAuditoria.Checked:=False;
      AcertaCkb_Style(Ckb_FinanObjetivosManutAuditoria);
      DMBelShop.CDS_BuscaRapida.Close;
      Exit;
    End;
    DMBelShop.CDS_BuscaRapida.Close;
                                                              
    Rb_FinanObjetivosManutTpOperacaoLoja.Checked:=True;
    Gb_FinanObjetivosManutTpOperacao.Enabled:=False;
    Ckb_FinanObjetivosManutNaoCompra.Checked:=False;
    Ckb_FinanObjetivosManutNaoCompra.Enabled:=False;
      
    DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:='AUDITORIA/EST. FINAN. AUDITORIA';

    FreeAndNil(FrmObjetivosFormula);
  End; // If Ckb_FinanObjetivosManutAuditoria.Checked Then

  If (Not Ckb_FinanObjetivosManutAuditoria.Checked) and (DMBelShop.CDS_ObjetivosDES_FORMULA.AsString='AUDITORIA/EST. FINAN. AUDITORIA') Then
   DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=EmptyStr;

  If Not Ckb_FinanObjetivosManutAuditoria.Checked Then
   Begin
     Gb_FinanObjetivosManutUlt12Meses.Visible:=True;
     EdtFinanObjetivosMeses.Visible:=True;
   End
  Else
   Begin
     Ckb_FinanObjetivosManutUlt12Meses.Checked:=False;
     Gb_FinanObjetivosManutUlt12Meses.Visible:=False;
     EdtFinanObjetivosMeses.Visible:=False;
   End;
  AcertaCkb_SN(FrmBelShop.Ckb_FinanObjetivosManutUlt12Meses);

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutAuditoriaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosManutAuditoriaClick(Self);

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosDiasCellClick(Column: TColumn);
begin
  Dbg_FinanObjetivosResultadosDias.Refresh;
end;

procedure TFrmBelShop.Bt_FinanObjetivosMarcaTodosClick(Sender: TObject);
begin
  DMBelShop.CDS_Objetivos.DisableControls;
  DMBelShop.CDS_ObjetivosEmpresas.DisableControls;
  
  DMBelShop.CDS_Objetivos.First;
  While Not DMBelShop.CDS_Objetivos.Eof do
  Begin
    Refresh;

    If DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM' Then
    Begin
      DMBelShop.CDS_Objetivos.Edit;
      DMBelShop.CDS_ObjetivosPROC.AsString:='SIM';
      DMBelShop.CDS_Objetivos.Post;
    End;
    
    DMBelShop.CDS_Objetivos.Next;
  End;
  DMBelShop.CDS_ObjetivosEmpresas.EnableControls;
  DMBelShop.CDS_Objetivos.EnableControls;
  DMBelShop.CDS_Objetivos.First;

end;

procedure TFrmBelShop.Bt_FinanObjetivosDesMarcaTodosClick(Sender: TObject);
begin
  DMBelShop.CDS_Objetivos.DisableControls;
  DMBelShop.CDS_Objetivos.First;
  While Not DMBelShop.CDS_Objetivos.Eof do
  Begin
    Refresh;

    If DMBelShop.CDS_ObjetivosIND_ATIVO.AsString='SIM' Then
    Begin
      DMBelShop.CDS_Objetivos.Edit;
      DMBelShop.CDS_ObjetivosPROC.AsString:='NAO';
      DMBelShop.CDS_Objetivos.Post;
    End;
    
    DMBelShop.CDS_Objetivos.Next;
  End;
  DMBelShop.CDS_Objetivos.EnableControls;
  DMBelShop.CDS_Objetivos.First;

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutAvariasClick(Sender: TObject);
Var
  MySql: String;  
begin
  If Ckb_FinanObjetivosManutAuditoria.Checked Then
  Begin
    Ckb_FinanObjetivosManutAvarias.Checked:=False;
    AcertaCkb_Style(Ckb_FinanObjetivosManutAvarias);
    Exit;
  End;

  AcertaCkb_Style(Ckb_FinanObjetivosManutAvarias);
  Dbe_FinanObjetivosManutDecimais.SetFocus;

  If Ckb_FinanObjetivosManutAvarias.Checked Then
  Begin
    MySql:=' select *'+
           ' from Fin_Objetivos o'+
           ' where o.Des_Formula='+QuotedStr('AVARIAS E VENCIDOS/VENDAS MS')+
           ' and o.Cod_Objetivo<>'+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Objetivo').AsString)<>'' Then
    Begin
      msg('Objetivo de Avarias/Vencidos j Existe'+cr+'Codigo do Ojetivo de Avarias/Vencidos: '+DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Objetivo').AsString,'A');
      Ckb_FinanObjetivosManutAvarias.Checked:=False;
      AcertaCkb_Style(Ckb_FinanObjetivosManutAvarias);
      DMBelShop.CDS_BuscaRapida.Close;
      Exit;
    End;
    DMBelShop.CDS_BuscaRapida.Close;

    DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:='AVARIAS E VENCIDOS/VENDAS MS';
    DMBelShop.CDS_ObjetivosULT_12_MESES.AsString:='SIM';
    Ckb_FinanObjetivosManutUlt12Meses.Checked:=True;
  End; // If Ckb_FinanObjetivosManutAvarias.Checked Then

  If (Not Ckb_FinanObjetivosManutAvarias.Checked) and (DMBelShop.CDS_ObjetivosDES_FORMULA.AsString='AVARIAS E VENCIDOS/VENDAS MS') Then
   DMBelShop.CDS_ObjetivosDES_FORMULA.AsString:=EmptyStr;

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutAvariasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosManutAvariasClick(Self);

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosMesesCellClick(Column: TColumn);
begin
  Dbg_FinanObjetivosResultadosMeses.Refresh;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosMesesColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=2) Or
     (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=3) Then
  begin
    THackDBGrid(Dbg_FinanObjetivosResultadosMeses).LeftCol:=5;
    THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex:=4;
    Dbg_FinanObjetivosResultadosMeses.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosMesesColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanObjetivosResultadosMesesColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosMesesDrawColumnCell(Sender: TObject;
          const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
Var
  i: Integer;
  s: String;
begin

  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanObjetivosResultadosMesesColEnter(Self);

  If not (gdSelected in State) Then
  Begin
    If DMVirtual.CDS_V_ObjetivosMesesDes_Objetivo.AsString<>'' Then
     Dbg_FinanObjetivosResultadosMeses.Canvas.Brush.Color:=clSkyBlue;

    If (DMVirtual.CDS_V_ObjetivosMesesTipo.AsString='Resultado') Or (DMVirtual.CDS_V_ObjetivosMesesTipo.AsString='Percentual') Then
    Begin
      Dbg_FinanObjetivosResultadosMeses.Canvas.Font.Style:=[fsBold];
    End;

    If (DMVirtual.CDS_V_ObjetivosMesesDes_Empresa.AsString='Empresa') Then
    Begin
      Dbg_FinanObjetivosResultadosMeses.Canvas.Brush.Color:=$0080FFFF;
    End;
    
    Dbg_FinanObjetivosResultadosMeses.Canvas.FillRect(Rect);
    Dbg_FinanObjetivosResultadosMeses.DefaultDrawDataCell(Rect,Column.Field,state);
    
  End; // if not (gdSelected in State) Then

  // Acerta Cor da Fonte, Vermelho Fora da Meta e Azul Dentro da Meta ========
  For i:=1 to 12 do
  Begin
    s:=IntToStr(i);
    If i<10 Then
     s:='0'+s;

    If (Column.Field.FieldName = 'Vlr_Mes'+s) then
    Begin
      If DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).Value < 0 then
       Begin
         Dbg_FinanObjetivosResultadosMeses.Canvas.Font.Color:= clRed;
         Dbg_FinanObjetivosResultadosMeses.Canvas.FillRect(Rect);
         Dbg_FinanObjetivosResultadosMeses.DefaultDrawColumnCell(Rect, DataCol, Column, State);
       End
      Else
       Begin
         If Dbg_FinanObjetivosResultadosMeses.Canvas.Font.Style=[fsBold] Then
          Dbg_FinanObjetivosResultadosMeses.Canvas.Font.Color:= clBlue
         Else
          Dbg_FinanObjetivosResultadosMeses.Canvas.Font.Color:= clBlack;
                 
         Dbg_FinanObjetivosResultadosMeses.Canvas.FillRect(Rect);
         Dbg_FinanObjetivosResultadosMeses.DefaultDrawColumnCell(Rect, DataCol, Column, State);
       End; // If DMVirtual.CDS_V_ObjetivosMeses.FieldByName('Vlr_Mes'+s).Value < 0 then
    End; // If (Column.Field.FieldName = 'Vlr_Mes'+s) then
  End; // For i:=1 to 31 do

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosMesesDrawDataCell(Sender: TObject;
          const Rect: TRect; Field: TField; State: TGridDrawState);
begin
  If Not DMVirtual.CDS_V_ObjetivosDias.IsEmpty Then
  Begin
    If (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=0) Or
       (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=1) Or
       (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=2) Or
       (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=3) Then
    Begin
      THackDBGrid(Dbg_FinanObjetivosResultadosMeses).LeftCol:=5;
      THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex:=4;
      Dbg_FinanObjetivosResultadosMeses.Refresh;
    End;
  End;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosMesesKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  // Acerta Posicio na Celula ================================================
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanObjetivosResultadosMeses).SelectedIndex=4) then
  Begin
    Key := VK_Clear;
    Dbg_FinanObjetivosResultadosMeses.Refresh;
  End;

  // Movimentos de Objetivo ====================================================
  If key=VK_F6 Then
  Begin
    If Trim(DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString)<>'' Then
    Begin
      If DMBelShop.CDS_Objetivos.Locate('COD_OBJETIVO', DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsInteger,[]) Then
      Begin
        ApresentaMovtosObjetivos('M');
        Dbg_FinanObjetivosResultadosMeses.SetFocus;
      End; // If DMBelShop.CDS_Objetivos.Locate('COD_OBJETIVO', DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsInteger,[]) Then
    End; // If Trim(DMVirtual.CDS_V_ObjetivosMesesCod_Objetivo.AsString)<>'' Then
  End; // If key=VK_F6 Then

  // Habilita / Desabilita LInhas ==============================================
  If key=VK_F8 Then
  Begin
    If DMVirtual.CDS_V_ObjetivosMeses.IsEmpty Then
     Exit;
     
    // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ------------
    FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
    AbreSolicitacoes(1);

    FrmSolicitacoes.Ckb_FinanObjetivosHabDesObjetivos.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesDiarios.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesRealizados.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesResultados.Checked:=True;
    FrmSolicitacoes.Ckb_FinanObjetivosHabDesPercentuais.Checked:=True;
    FrmSolicitacoes.Lb_FinanObjetivosHabDesDiarios.Caption:='Linhas de Ms .................................';
                                            
    bgProcessar:=False;
    FrmSolicitacoes.ShowModal;

    If bgProcessar Then
    Begin

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Habilitando/Desabilitando Linha(s)...';
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Visible:=True;
      Refresh;

      Dbg_FinanObjetivosResultadosMeses.Visible:=False;

      // Habilita Todas as Linhas ==============================================
      DMVirtual.CDS_V_ObjetivosMeses.Filtered:=False;
      DMVirtual.CDS_V_ObjetivosMeses.First;
      While not DMVirtual.CDS_V_ObjetivosMeses.Eof do
      Begin
        Refresh;
        If DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString<>'S' Then
        Begin
          DMVirtual.CDS_V_ObjetivosMeses.Edit;
          DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString:='S';
          DMVirtual.CDS_V_ObjetivosMeses.Post;
        End; // If DMVirtual.CDS_V_ObjetivosMesesVISIVEL.AsString<>'S' Then

        DMVirtual.CDS_V_ObjetivosMeses.Next;
      End; // While not DMVirtual.CDS_V_ObjetivosMeses.Eof do
      DMVirtual.CDS_V_ObjetivosMeses.First;

      // Habilita Desabilita Linha =============================================
      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesObjetivos.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosMeses, 'Tipo', 'Objetivo', False);

      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesDiarios.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosMeses, 'Tipo', 'Ms', False);
      
      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesRealizados.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosMeses, 'Tipo', 'Realizado', False);

      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesResultados.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosMeses, 'Tipo', 'Resultado', False);

      If Not FrmSolicitacoes.Ckb_FinanObjetivosHabDesPercentuais.Checked Then
       HabilitaDesabilitaLinha(DMVirtual.CDS_V_ObjetivosMeses, 'Tipo', 'Percentual', False);

      DMVirtual.CDS_V_ObjetivosMeses.Filtered:=True;
      Dbg_FinanObjetivosResultadosMeses.Visible:=True;
      Dbg_FinanObjetivosResultadosMeses.SetFocus;
      OdirPanApres.Visible:=False;
      Refresh;
      
    End; // If bgProcessar Then
  End; //  If key=VK_F8 Then
  FreeAndNil(FrmSolicitacoes);
  
end;

procedure TFrmBelShop.Bt_FinanObjetivosResultMesesSalvarClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_ObjetivosMeses.IsEmpty Then
  Begin
    Dbg_FinanObjetivosResultadosMeses.SetFocus;
    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_ObjetivosMeses,Dbg_FinanObjetivosResultadosMeses,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.Bt_FinanObjetivosResultMesesTamColunasClick(Sender: TObject);
Var
 i: Integer;
begin
  If (DMVirtual.CDS_V_ObjetivosMeses.IsEmpty) and (DMVirtual.CDS_V_ObjetivosMeses.Filter='VISIVEL=''S''') Then
   Exit;

  // Tamanho Colunas No FIXADAS ===============================================
  For i:=4 to Dbg_FinanObjetivosResultadosMeses.Columns.Count-1 do
  Begin
    Dbg_FinanObjetivosResultadosMeses.Columns[i].Width:=EdtFinanObjetivosResultMesesTamNaoFixas.AsInteger;
  End;

  // Tamanho Colunas FIXADAS =================================================== 
  Dbg_FinanObjetivosResultadosMeses.Columns[0].Width:=EdtFinanObjetivosResultMesesTamColuna1.AsInteger;
  Dbg_FinanObjetivosResultadosMeses.Columns[1].Width:=EdtFinanObjetivosResultMesesTamColuna2.AsInteger;
  Dbg_FinanObjetivosResultadosMeses.Columns[2].Width:=EdtFinanObjetivosResultMesesTamColuna3.AsInteger;
  Dbg_FinanObjetivosResultadosMeses.Columns[3].Width:=EdtFinanObjetivosResultMesesTamColuna4.AsInteger;

  // Fixa Colunas ==============================================================
  THackDBGrid(Dbg_FinanObjetivosResultadosMeses).FixedCols:=5;

  // Posiciona no Grid =========================================================
  Dbg_FinanObjetivosResultadosMeses.SetFocus;
end;

procedure TFrmBelShop.Bt_FinanObjetivosResultMesesVoltarClick(Sender: TObject);
begin
  // Posiciona no TabSheet =====================================================
  PC_FinanObjetivos.ActivePage:=Ts_FinanObjetivosManut;
  CorSelecaoTabSheet(PC_FinanObjetivos);
  Dbg_FinanObjetivosManut.SetFocus;

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutNaoCompraClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_FinanObjetivosManutNaoCompra);
end;

procedure TFrmBelShop.Cbx_CurvaABCEndZonaChange(Sender: TObject);
Var
  MySql: String;
  sCodZona, sCodCorredor, sCodPrateleira: String;
begin
  DMBelShop.CDS_Enderecamento.Close;

  sCodZona:=Trim(Copy(Cbx_CurvaABCEndZona.Text,Pos('ENDERECAMENTO ',Cbx_CurvaABCEndZona.Text)+Length('ENDERECAMENTO '),4));
  sCodCorredor:=Trim(Copy(Cbx_CurvaABCEndCorredor.Text,Pos('CORREDOR ',Cbx_CurvaABCEndCorredor.Text)+Length('CORREDOR '),4));
  sCodPrateleira:=Trim(Copy(Cbx_CurvaABCEndPrateleira.Text,Pos('PRATELEIRA ',Cbx_CurvaABCEndPrateleira.Text)+Length('PRATELEIRA '),4));

  If Trim(sCodZona)='' Then
  Begin
    msg('Favor Informar a Zona de Endereamento !!','A');
    Cbx_CurvaABCEndZona.SetFocus;
    Exit;
  End;

  If Trim(sCodCorredor)='' Then
   Exit;

  If Trim(sCodPrateleira)='' Then
   Exit;

  MySql:=' Select e.cod_zona, z.des_zona,'+
         ' e.cod_corredor, c.des_corredor,'+
         ' e.cod_prateleira, p.des_prateleira,'+
         ' e.cod_gaveta, g.des_gaveta,'+
         ' e.tip_curvaabc,'+
         ' e.cod_produto, e.des_produto, e.cod_fornecedor, e.des_fornecedor'+

         ' from CE_ENDERECAMENTOS e,'+
         ' ce_zona_enderecos z, ce_corredores c, ce_prateleiras p, ce_gavetas g'+

         ' where e.cod_zona=z.cod_zona'+
         ' and e.cod_corredor=c.cod_corredor'+
         ' and e.cod_prateleira=p.cod_prateleira'+
         ' and e.cod_gaveta=g.cod_gaveta'+

         ' and e.cod_zona='+QuotedStr(sCodZona);

         If Trim(sCodCorredor)<>'' Then
          MySql:=MySql+' and c.cod_corredor='+QuotedStr(sCodCorredor);
          
         If Trim(sCodPrateleira)<>'' Then
          MySql:=MySql+' and p.cod_prateleira='+QuotedStr(sCodPrateleira);

         MySql:=MySql+' order by e.COD_ZONA, e.COD_CORREDOR,'+
                      ' e.COD_PRATELEIRA, e.COD_GAVETA';
  DMBelShop.CDS_Enderecamento.Close;
  DMBelShop.SDS_Enderecamento.CommandText:=MySql;
  DMBelShop.CDS_Enderecamento.Open;

  If Trim(DMBelShop.CDS_Enderecamento.FieldByName('cod_zona').AsString)='' Then
  Begin
    msg('Espao Fsico NO Existe !!','A');
    DMBelShop.CDS_Enderecamento.Close;
    Cbx_CurvaABCEndZona.SetFocus;
    Exit;
  End;

  If Trim(EdtCurvaABCEndCodProd.Text)<>'' Then
   DMBelShop.CDS_Enderecamento.Locate('COD_PRODUTO',EdtCurvaABCEndCodProd.Text,[]);

  EdtCurvaABCEndCodProd.Clear;
  EdtCurvaABCEndDescProd.Clear;

end;

procedure TFrmBelShop.Bt_CurvaABCEndLocalizaProdClick(Sender: TObject);
Var
  MySql: String;
  b: Boolean;
  sNomeProd: String;
begin

  EdtCurvaABCEndCodProd.Clear;
  EdtCurvaABCEndDescProd.Clear;
  Dbg_CurvaABCEndEnderecamento.SetFocus;
  
  b:=True;
  While b do
  Begin
    If InputQuery('Informe Parte do Nome do Produto','',sNomeProd) then
     Begin
       sNomeProd:=AnsiUpperCase(sNomeProd);
       If Trim(sNomeProd)='' Then
        Exit;
        
       Break;
     End
    Else // If InputQuery('Informe Parte do Nome do Produto','',sNomeProd) then
     Begin
       Exit;
     End; // If InputQuery('Informe Parte do Nome do Produto','',sNomeProd) then
  End; // While b do

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' select p.Apresentacao Des_Produto, p.CodProduto, p.PrincipalFor'+
         ' from produto p'+
         ' Where p.Apresentacao Like ''%'+sNomeProd+'%'''+
         ' Order by p.Apresentacao';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('PrincipalFor').AsString)='' Then
  Begin
    msg('Produtos No Encontrado !!','A');
    EdtCurvaABCEndCodProd.Clear;
    EdtCurvaABCEndDescProd.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtCurvaABCEndCodProd.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='Des_Produto';
  FrmPesquisaIB.Campo_Codigo:='CodProduto';
  FrmPesquisaIB.Campo_Descricao:='Des_Produto';
  FrmPesquisaIB.EdtDescricao.Clear;
  FrmPesquisaIB.Campo_Retorno1:='PrincipalFor';

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    EdtCurvaABCEndCodProd.Text:=FrmPesquisaIB.EdtCodigo.Text;
    EdtCurvaABCEndDescProd.Text:=FrmPesquisaIB.EdtDescricao.Text;

// OdirApagar - EnderecamentoProduto - 09/06/2017
//    If Not EnderecamentoProduto Then
//    Begin
//      msg('Produto SEM Endereamento !!','A');
//      EdtCurvaABCEndCodProd.Clear;
//      EdtCurvaABCEndDescProd.Clear;
//      FreeAndNil(FrmPesquisaIB);
//      EdtCurvaABCEndCodProd.SetFocus;
//      Exit;
//    End;

    Cbx_CurvaABCEndZonaChange(Self);

    Dbg_CurvaABCEndEnderecamento.SetFocus;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.EdtCurvaABCEndCodProdExit(Sender: TObject);
Var
  MySql: String;
begin

  
  EdtCurvaABCEndDescProd.Clear;
  If EdtCurvaABCEndCodProd.Text<>'' Then
  Begin
    Try
      StrToInt(EdtCurvaABCEndCodProd.Text);
    Except
      msg('Cdigo do ProdutoInvlido !!','A');
      EdtCurvaABCEndCodProd.SetFocus;
      Exit;
    End;

    Try
      EdtCurvaABCEndCodProd.Text:=FormatFloat('000000',StrToInt(EdtCurvaABCEndCodProd.text));
    Except
    End;

    Screen.Cursor:=crAppStart;

    // Busca Produto ===========================================================
    MySql:=' Select p.Apresentacao Des_Produto, p.CodProduto, p.PrincipalFor'+
           ' From produto p'+
           ' Where p.CodProduto='+QuotedStr(EdtCurvaABCEndCodProd.Text);
    IBQ_Matriz.Close;
    IBQ_Matriz.SQL.Clear;
    IBQ_Matriz.SQL.Add(MySql);
    IBQ_Matriz.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_Matriz.FieldByName('PrincipalFor').AsString)='' Then
    Begin
     msg('Produto NO Encontrado !!!', 'A');
     EdtCurvaABCEndCodProd.Clear;
     EdtCurvaABCEndDescProd.Clear;
     EdtCurvaABCEndCodProd.SetFocus;
     Exit;
    End;

    EdtCurvaABCEndDescProd.Text:=IBQ_Matriz.FieldByName('Des_Produto').AsString;
    IBQ_Matriz.Close;

// OdirApagar EnderecamentoProduto - 09/06/2017
//    If Not EnderecamentoProduto Then
//    Begin
//      msg('Produto SEM Endereamento !!','A');
//      EdtCurvaABCEndCodProd.Clear;
//      EdtCurvaABCEndDescProd.Clear;
//      EdtCurvaABCEndCodProd.SetFocus;
//      Exit;
//    End;

    Cbx_CurvaABCEndZonaChange(Self);
    Dbg_CurvaABCEndEnderecamento.SetFocus;

  End;
end;

procedure TFrmBelShop.Image1DblClick(Sender: TObject);
begin
  If Cod_Usuario='0' Then
  Begin
    If Mem_Odir.Visible Then
     Mem_Odir.Visible:=False
    Else
     Mem_Odir.Visible:=True;
  End; // If Cod_Usuario=0 Then
end;

procedure TFrmBelShop.EdtVersaoStop(Sender: TObject);
begin
  EdtVersao.Transparent:=True;
end;

procedure TFrmBelShop.Dbg_GeraOCFiliaisDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    // Se Lina do Produto no CD
    if DMBelShop.IBQ_AComprarCOD_EMPRESA.AsString='99' Then
      Dbg_GeraOCFiliais.Canvas.Brush.Color:=$0080FFFF; //$00DDFFDD;

    Dbg_GeraOCFiliais.Canvas.FillRect(Rect);
    Dbg_GeraOCFiliais.DefaultDrawDataCell(Rect,Column.Field,state);
  End;

  // Alinhamento
  DMBelShop.IBQ_AComprarCOD_EMPRESA.Alignment:=taCenter;
end;

procedure TFrmBelShop.Bt_FinanAuditoriaManutFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.PC_FinanAuditoriaChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_FinanAuditoria);

  If (PC_FinanAuditoria.ActivePage=Ts_FinanAuditoriaAnalises) And (Ts_FinanAuditoriaAnalises.CanFocus) Then
   EdtFinanAuditoriaAnaliseCodLoja.SetFocus;

  If (PC_FinanAuditoria.ActivePage=Ts_FinanAuditoriaManut) And (Ts_FinanAuditoriaManut.CanFocus) Then
   EdtFinanAuditoriaManutCodLoja.SetFocus;

end;

procedure TFrmBelShop.EdtFinanAuditoriaManutCodLojaChange(Sender: TObject);
begin
  DMBelShop.CDS_Auditorias.Close;
  EdtFinanAuditoriaManutDesLoja.Clear;
  DtEdtFinanAuditoriaManutData.Enabled:=False;
  DtEdtFinanAuditoriaManutData.Clear;
  Bt_FinanAuditoriaManutBuscaAuditoria.Enabled:=False;
end;

procedure TFrmBelShop.EdtFinanAuditoriaManutCodLojaExit(Sender: TObject);
Var
  MySql: String;
begin

  If EdtFinanAuditoriaManutCodLoja.Value=0 Then
   Bt_FinanAuditoriaManutFechar.SetFocus;
  
  If Bt_FinanAuditoriaManutFechar.Focused Then
   Exit;

  EdtFinanAuditoriaManutDesLoja.Clear;
  DMBelShop.CDS_Auditorias.Close;

  If EdtFinanAuditoriaManutCodLoja.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Lojas =============================================================
    MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
           ' From EMP_CONEXOES'+
           ' Where IND_ATIVO=''SIM'''+
           ' And COD_FILIAL='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger));
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('COD_FILIAL').AsString)='' Then
    Begin
      msg('Loja NO Encontrada !!!', 'A');
      Screen.Cursor:=crDefault;
      EdtFinanAuditoriaManutCodLoja.Clear;
      EdtFinanAuditoriaManutCodLoja.SetFocus;
      DMBelShop.CDS_BuscaRapida.Close;
      Exit;
    End;

    EdtFinanAuditoriaManutDesLoja.Text:=DMBelShop.CDS_BuscaRapida.FieldByName('Razao_Social').AsString;
    Bt_FinanAuditoriaManutBuscaAuditoria.Enabled:=True;
    DtEdtFinanAuditoriaManutData.Enabled:=True;
    DtEdtFinanAuditoriaManutData.SetFocus;

    DMBelShop.CDS_BuscaRapida.Close;

   Screen.Cursor:=crDefault;
  End;
end;

procedure TFrmBelShop.Bt_FinanAuditoriaManutBuscaLojaClick(Sender: TObject);
Var
  MySql: String;
begin

  FrmPesquisa:=TFrmPesquisa.Create(Self);

  EdtFinanAuditoriaManutCodLoja.Clear;
  EdtFinanAuditoriaManutDesLoja.Clear;
                      
  DMBelShop.CDS_Auditorias.Close;
  EdtFinanAuditoriaManutCodLoja.SetFocus;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
         ' From EMP_CONEXOES'+
         ' Where IND_ATIVO=''SIM'''+
         ' Order by RAZAO_SOCIAL';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('COD_FILIAL').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Sem Loja a Listar !!','A');
    EdtFinanAuditoriaManutCodLoja.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Razao_Social';
  FrmPesquisa.Campo_Codigo:='Cod_Filial';
  FrmPesquisa.Campo_Descricao:='Razao_Social';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtFinanAuditoriaManutCodLoja.Text:=FrmPesquisa.EdtCodigo.Text;
     EdtFinanAuditoriaManutDesLoja.Text:=FrmPesquisa.EdtDescricao.Text;
     Bt_FinanAuditoriaManutBuscaAuditoria.Enabled:=True;
     DtEdtFinanAuditoriaManutData.Enabled:=True;
     DtEdtFinanAuditoriaManutData.SetFocus;
   End
  Else
   Begin
     EdtFinanAuditoriaManutCodLoja.Clear;
     EdtFinanAuditoriaManutDesLoja.Clear;
     EdtFinanAuditoriaManutCodLoja.SetFocus;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.DtEdtFinanAuditoriaDataPropertiesEditValueChanged(Sender: TObject);
Var
  MySql: String;
begin
  DMBelShop.CDS_AuditoriaDatas.Close;
  If Trim(DtEdtFinanAuditoriaManutData.Text)='' Then
   Exit;

  Screen.Cursor:=crAppStart;

  Bt_FinanAuditoriaManutSalvar.Enabled:=False;

  // Busca Auditoria ===========================================================
  DMBelShop.CDS_Auditorias.DisableControls;
  DateSeparator:='.';
  MySql:=' Select *'+ 
         ' From Auditorias'+
         ' Where COD_LOJA='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger))+
         ' And DTA_AUDITORIA='+QuotedStr(DateToStr(DtEdtFinanAuditoriaManutData.Date));
  DMBelShop.CDS_Auditorias.Close;
  DMBelShop.SDS_Auditorias.CommandText:=MySql;
  DMBelShop.CDS_Auditorias.Open;
  DateSeparator:='/';
  DMBelShop.CDS_Auditorias.EnableControls;

  // Acerta Cor do Objetivo ====================================================
  AuditoriaCorObjetivos;
  
  // Verifica o Que Fazer ======================================================
  If Trim(DMBelShop.CDS_AuditoriasCOD_LOJA.AsString)='' Then
   Begin
     If msg('Deseja INCLUIR Nova Auditoria ??','C')=2 Then
     Begin
       Screen.Cursor:=crDefault;

       Pan_FinanAuditoriaManutSolic.Enabled:=True;
       Pan_FinanAuditoriaManutSolic.Color:=clBtnFace;
       Edt_FinanAuditoriaManutQtdCodGeral.AsInteger:=0;

       DMBelShop.CDS_Auditorias.Close; 
       DtEdtFinanAuditoriaManutData.Clear;
       DtEdtFinanAuditoriaManutData.SetFocus;
       Exit;
     End;

     // Cria Nova Auditoria --------------------------
     DMBelShop.CDS_Auditorias.Insert; 
     AutidoriaCriaNovaAuditoria;
     
     Bt_FinanAuditoriaManutSalvar.Caption:='Incluir';
     Bt_FinanAuditoriaManutExcluir.Enabled:=False;
   End
  Else // If Trim(DMBelShop.CDS_AuditoriasCOD_LOJA.AsString)='' Then
   Begin
     // Busca as Datas de Todas as Auditorias ==================================
     AuditoriaTodasDatas;

     Bt_FinanAuditoriaManutSalvar.Caption:='Alterar';
     DMBelShop.CDS_Auditorias.Edit;
   End; // If Trim(DMBelShop.CDS_AuditoriasCOD_LOJA.AsString)='' Then

  // Trata Componentes =========================================================
  Pan_FinanAuditoriaManutSolic.Color:=clSilver;

  Bt_FinanAuditoriaManutFechar.Enabled:=False;
  Bt_FinanAuditoriaManutAbandonar.Enabled:=True;

  
  Bt_FinanAuditoriaManutExcluir.Enabled:=True;
  If Bt_FinanAuditoriaManutSalvar.Caption='Incluir' Then
   Bt_FinanAuditoriaManutExcluir.Enabled:=False;
  
  Gb_FinanAuditoriaManut.Enabled:=True;

  Pan_FinanAuditoriaManutSolic.Enabled:=False;
  
  Dbe_FinanAuditoriaManutVlrNegReal.SetFocus; 
  Screen.Cursor:=crDefault;

end;

procedure TFrmBelShop.Bt_FinanAuditoriaManutAbandonarClick(Sender: TObject);
begin

  // Fecha Transao ===========================================================
  If (DMBelShop.CDS_Auditorias.State=dsEdit) or (DMBelShop.CDS_Auditorias.State=dsInsert) Then
  Begin
    DMBelShop.CDS_Auditorias.CancelUpdates;
    Edt_FinanAuditoriaManutQtdCodGeral.AsInteger:=0;
  End;

  DMBelShop.CDS_Auditorias.Close;
   
  // Trata Componentes =========================================================
  Pan_FinanAuditoriaManutSolic.Enabled:=True;

  If bgCor Then
   Pan_FinanAuditoriaManutSolic.Color:=clBtnFace;
  bgCor:=True;
   
  Bt_FinanAuditoriaManutSalvar.Enabled:=False;
  Bt_FinanAuditoriaManutAbandonar.Enabled:=False;
  Bt_FinanAuditoriaManutExcluir.Enabled:=False;
  Gb_FinanAuditoriaManut.Enabled:=False;
  DtEdtFinanAuditoriaManutData.Clear;
  Bt_FinanAuditoriaManutFechar.Enabled:=True;

  Refresh;

  EdtFinanAuditoriaManutCodLoja.SetFocus;
end;

procedure TFrmBelShop.Dbe_FinanAuditoriaManutVlrNegRealExit(Sender: TObject);
begin
  If (DMBelShop.CDS_Auditorias.State=dsEdit) or (DMBelShop.CDS_Auditorias.State=dsInsert) Then
  Begin
    DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency:=
                            DMBelShop.CDS_AuditoriasVLR_EST_NEG_REAL.AsCurrency+
                                DMBelShop.CDS_AuditoriasVLR_EST_LOJA.AsCurrency;

    Dbe_FinanAuditoriaManutVlrEstInicialExit(Self);
                                
  End; // If (DMBelShop.CDS_Auditorias.State=dsEdit) or (DMBelShop.CDS_Auditorias.State=dsInsert) Then

end;

procedure TFrmBelShop.Dbe_FinanAuditoriaManutVlrEstInicialExit(Sender: TObject);
Var
  cTotPerGeral, cTotPerCont: Currency;
begin
  If (DMBelShop.CDS_Auditorias.State=dsEdit) or (DMBelShop.CDS_Auditorias.State=dsInsert) Then
  Begin
    // Acerta DBEdts em Branco ================================================
    AuditoriaDBEdtBranco;

    // Valor do Estoque Inicial ================================================
    If DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency<>
       (DMBelShop.CDS_AuditoriasVLR_EST_NEG_REAL.AsCurrency+DMBelShop.CDS_AuditoriasVLR_EST_LOJA.AsCurrency) Then
    Begin
      msg('Valor do Estoque Inicial Invlido !!','A');
      DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency:=
                            DMBelShop.CDS_AuditoriasVLR_EST_NEG_REAL.AsCurrency+
                                DMBelShop.CDS_AuditoriasVLR_EST_LOJA.AsCurrency;
    End;

    // =========================================================================
    // Resultado Final Financeiro ==============================================
    // =========================================================================
    
    // Valor Perda Equivalente --------------------------------------
    DMBelShop.CDS_AuditoriasVLR_PERDA_EQUIVALENTE.AsCurrency:=
                            DMBelShop.CDS_AuditoriasVLR_COD_ENTRADAS.AsCurrency-
                             (DMBelShop.CDS_AuditoriasVLR_COD_SAIDAS.AsCurrency+
                       DMBelShop.CDS_AuditoriasVLR_COD_NAO_CONTADOS.AsCurrency);

    // Percentual de Codigos de Entradas ----------------------------
    DMBelShop.CDS_AuditoriasPER_COD_ENTRADAS.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency<>0 Then
     DMBelShop.CDS_AuditoriasPER_COD_ENTRADAS.AsCurrency:=Roundto(
                      (DMBelShop.CDS_AuditoriasVLR_COD_ENTRADAS.AsCurrency*100)/
                         DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency,-2);

    // Percentual de Codigos de Saidas ------------------------------
    DMBelShop.CDS_AuditoriasPER_COD_SAIDAS.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency<>0 Then
     DMBelShop.CDS_AuditoriasPER_COD_SAIDAS.AsCurrency:=Roundto(
                        (DMBelShop.CDS_AuditoriasVLR_COD_SAIDAS.AsCurrency*100)/
                         DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency,-2);

    // Percentual de Codigos No Encontrados ------------------------
    DMBelShop.CDS_AuditoriasPER_COD_NAO_CONTADOS.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency<>0 Then
     DMBelShop.CDS_AuditoriasPER_COD_NAO_CONTADOS.AsCurrency:=Roundto(
                  (DMBelShop.CDS_AuditoriasVLR_COD_NAO_CONTADOS.AsCurrency*100)/
                         DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency,-2);

    // Estoque Final ------------------------------------------------
    DMBelShop.CDS_AuditoriasVLR_EST_FINAL.AsCurrency:=
                             DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency+
                       DMBelShop.CDS_AuditoriasVLR_PERDA_EQUIVALENTE.AsCurrency;

    // Valor Equivalente --------------------------------------------
    DMBelShop.CDS_AuditoriasVLR_ADMISS_EQUIVALENTE.AsCurrency:=Roundto(
                            (DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency*
                     DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsCurrency)/100,-2);

    // Percentual Perda Final ---------------------------------------
    DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency<>0 Then
     DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency:=Roundto(
                 (DMBelShop.CDS_AuditoriasVLR_PERDA_EQUIVALENTE.AsCurrency*100)/
                         DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsCurrency,-2);

    // =========================================================================
    // Resultado Final Produtos ================================================
    // =========================================================================

    // Total Geral de Produtos --------------------------------------
    Edt_FinanAuditoriaManutQtdCodGeral.AsInteger:=
                             DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger+
                         DMBelShop.CDS_AuditoriasQTD_COD_NAO_CONTADOS.AsInteger;

    // Percentuais de Produtos com Quantidade Fechada no Geral ------
    DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS.AsCurrency:=0;
    If Edt_FinanAuditoriaManutQtdCodGeral.AsInteger<>0 Then
     DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS.AsCurrency:=Roundto(
                             (DMBelShop.CDS_AuditoriasQTD_COD_OK.AsInteger*100)/
                               Edt_FinanAuditoriaManutQtdCodGeral.AsInteger,-2);
    cTotPerGeral:=DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS.AsCurrency;

    // Percentuais de Produtos com Quantidade Fechada nos Contados --
    DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS_ENCONT.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger<>0 Then
     DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS_ENCONT.AsCurrency:=Roundto(
                             (DMBelShop.CDS_AuditoriasQTD_COD_OK.AsInteger*100)/
                         DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger,-2);
    cTotPerCont:=DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS_ENCONT.AsCurrency;

    // Quantidade de Produtos Encontrados com Quantidade No Fechados ---
    DMBelShop.CDS_AuditoriasQTD_PROD_NAO_FECHADOS.AsInteger:=
                             DMBelShop.CDS_AuditoriasQTD_COD_ENTRADAS.AsInteger+
                               DMBelShop.CDS_AuditoriasQTD_COD_SAIDAS.AsInteger;

    // Percentuais de Produtos com Quantidade Nao Fechada no Geral -----
    DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS.AsCurrency:=0;
    If Edt_FinanAuditoriaManutQtdCodGeral.AsInteger<>0 Then
     DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS.AsCurrency:=Roundto(
                  (DMBelShop.CDS_AuditoriasQTD_PROD_NAO_FECHADOS.AsInteger*100)/
                               Edt_FinanAuditoriaManutQtdCodGeral.AsInteger,-2);
    cTotPerGeral:=cTotPerGeral+DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS.AsCurrency;
    
    // Percentuais de Produtos com Quantidade Nao Fechada nos Contados --
    DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS_ENCONT.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger<>0 Then 
     DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS_ENCONT.AsCurrency:=Roundto(
                  (DMBelShop.CDS_AuditoriasQTD_PROD_NAO_FECHADOS.AsInteger*100)/
                         DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger,-2);
    cTotPerCont:=cTotPerCont+DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS_ENCONT.AsCurrency;

    // Quantidade de Produtos No Resolvidos ------------------------
    DMBelShop.CDS_AuditoriasQTD_PROD_NAO_RESOLVIDOS.AsInteger:=
                             DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger-
                                  (DMBelShop.CDS_AuditoriasQTD_COD_OK.AsInteger+
                             DMBelShop.CDS_AuditoriasQTD_COD_ENTRADAS.AsInteger+
                              DMBelShop.CDS_AuditoriasQTD_COD_SAIDAS.AsInteger);

    // Percentuais de Produtos No Resolvidos no Geral --------------
    DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS.AsCurrency:=0;
    If Edt_FinanAuditoriaManutQtdCodGeral.AsInteger<>0 Then
     DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS.AsCurrency:=Roundto(
                (DMBelShop.CDS_AuditoriasQTD_PROD_NAO_RESOLVIDOS.AsInteger*100)/
                               Edt_FinanAuditoriaManutQtdCodGeral.AsInteger,-2);
    cTotPerGeral:=cTotPerGeral+DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS.AsCurrency;

    // Percentuais de Produtos Nao Resolvidos nos Contados ----------
    DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger<>0 Then 
     DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsCurrency:=Roundto(
                (DMBelShop.CDS_AuditoriasQTD_PROD_NAO_RESOLVIDOS.AsInteger*100)/
                         DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsInteger,-2);
    cTotPerCont:=cTotPerCont+DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsCurrency;

    // --------------------------------------------------------------
    // Acerta o Percentual para Total Contados 100% -----------------
    // --------------------------------------------------------------
    DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsCurrency:=
              DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsCurrency+
                                                              (100-cTotPerCont);
                                                             
    // Percentuais de Produtos No Contados no Geral ---------------
    DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsCurrency:=0;
    If Edt_FinanAuditoriaManutQtdCodGeral.AsInteger<>0 Then
     DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsCurrency:=Roundto(
                   (DMBelShop.CDS_AuditoriasQTD_COD_NAO_CONTADOS.AsInteger*100)/
                               Edt_FinanAuditoriaManutQtdCodGeral.AsInteger,-2);
    cTotPerGeral:=cTotPerGeral+DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsCurrency;

    // --------------------------------------------------------------
    // Acerta o Percentual para Total Geral 100% --------------------
    // --------------------------------------------------------------
    DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsCurrency:=
                       DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsCurrency+
                                                             (100-cTotPerGeral);

    // Acerta Objetivo =========================================================
    DMBelShop.CDS_AuditoriasPER_OBJ_PER_ADMISSIVEL.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsCurrency<>0 Then
     DMBelShop.CDS_AuditoriasPER_OBJ_PER_ADMISSIVEL.AsCurrency:=Roundto(
                       (DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsCurrency*100)/
                          DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsCurrency,-2);

    DMBelShop.CDS_AuditoriasPER_OBJ_VLR_ADMISSIVEL.AsCurrency:=0;
    If DMBelShop.CDS_AuditoriasVLR_ADMISS_EQUIVALENTE.AsCurrency<>0 Then 
     DMBelShop.CDS_AuditoriasPER_OBJ_VLR_ADMISSIVEL.AsCurrency:=Roundto(
                 (DMBelShop.CDS_AuditoriasVLR_PERDA_EQUIVALENTE.AsCurrency*100)/
                  DMBelShop.CDS_AuditoriasVLR_ADMISS_EQUIVALENTE.AsCurrency,-2);

    // Acerta Cor do Objetivo ==================================================
    AuditoriaCorObjetivos;
  End; // If (DMBelShop.CDS_Auditorias.State=dsEdit) or (DMBelShop.CDS_Auditorias.State=dsInsert) Then
end;

procedure TFrmBelShop.DtEdtFinanAuditoriaManutDataExit(Sender: TObject);
begin
  If (Bt_FinanAuditoriaManutFechar.Focused) Or (Bt_FinanAuditoriaManutBuscaAuditoria.Focused)  Then
   Exit;

  If Trim(DtEdtFinanAuditoriaManutData.Text)='' Then
   EdtFinanAuditoriaManutCodLoja.SetFocus;
end;

procedure TFrmBelShop.Dbe_FinanAuditoriaManutQtdEstInicialExit(Sender: TObject);
begin
  Dbe_FinanAuditoriaManutVlrEstInicialExit(Self);
end;

procedure TFrmBelShop.Bt_FinanAuditoriaManutSalvarClick(Sender: TObject);
Var
  MySql: String;
begin

  If msg('Deseja Realmente '+Bt_FinanAuditoriaManutSalvar.Caption+cr+cr+' a Auditoria Informada ??','C')=2 Then
  Begin
    Dbe_FinanAuditoriaManutVlrNegReal.SetFocus;
    Exit;
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';


    If DMBelShop.CDS_Auditorias.State=dsInsert Then
    Begin
      MySql:='Insert Into AUDITORIAS ('+
             ' COD_LOJA, DTA_AUDITORIA, VLR_EST_NEG_REAL, VLR_EST_LOJA, VLR_EST_INICIAL,'+
             ' QTD_EST_INICIAL, QTD_COD_CONTADOS, QTD_COD_OK,'+
             ' QTD_COD_ENTRADAS, VLR_COD_ENTRADAS, PER_COD_ENTRADAS,'+
             ' QTD_COD_SAIDAS, VLR_COD_SAIDAS, PER_COD_SAIDAS,'+
             ' QTD_COD_NAO_CONTADOS, VLR_COD_NAO_CONTADOS, PER_COD_NAO_CONTADOS,'+
             ' VLR_EST_FINAL,'+
             ' PER_ADMISSIVEL, VLR_ADMISS_EQUIVALENTE,'+
             ' PER_PERDA_FINAL, VLR_PERDA_EQUIVALENTE,'+
             ' PER_OBJ_PER_ADMISSIVEL, PER_OBJ_VLR_ADMISSIVEL,'+
             ' PER_PROD_FECHADOS, PER_PROD_FECHADOS_ENCONT,'+
             ' QTD_PROD_NAO_FECHADOS, PER_PROD_NAO_FECHADOS, PER_PROD_NAO_FECHADOS_ENCONT,'+
             ' QTD_PROD_NAO_RESOLVIDOS, PER_PROD_NAO_RESOLVIDOS, PER_PROD_NAO_RESOLVIDOS_ENCONT,'+
             ' PER_PROD_NAO_CONTADOS,'+
             ' USU_INCLUI, DTA_INCLUI)'+

             ' Values ('+
             QuotedStr(FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger))+', '+
             QuotedStr(DateToStr(DtEdtFinanAuditoriaManutData.Date))+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_NEG_REAL.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_LOJA.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasQTD_EST_INICIAL.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_OK.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_ENTRADAS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_COD_ENTRADAS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_COD_ENTRADAS.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_SAIDAS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_COD_SAIDAS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_COD_SAIDAS.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_NAO_CONTADOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_COD_NAO_CONTADOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_COD_NAO_CONTADOS.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_FINAL.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_ADMISS_EQUIVALENTE.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasVLR_PERDA_EQUIVALENTE.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasPER_OBJ_PER_ADMISSIVEL.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_OBJ_VLR_ADMISSIVEL.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS_ENCONT.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasQTD_PROD_NAO_FECHADOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS_ENCONT.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasQTD_PROD_NAO_RESOLVIDOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS.AsString)+', '+
             QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsString)+', '+

             QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsString)+', '+

             QuotedStr(Cod_Usuario)+', Current_Date)';
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End; // If DMBelShop.CDS_Auditorias.State=dsInsert Then

    If DMBelShop.CDS_Auditorias.State=dsEdit Then
    Begin
      MySql:='Update AUDITORIAS '+
             ' Set VLR_EST_NEG_REAL='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_NEG_REAL.AsString)+
             ', VLR_EST_LOJA='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_LOJA.AsString)+
             ', VLR_EST_INICIAL='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_INICIAL.AsString)+
             ', QTD_EST_INICIAL='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_EST_INICIAL.AsString)+

             ', QTD_COD_CONTADOS='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_CONTADOS.AsString)+
             ', QTD_COD_OK='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_OK.AsString)+

             ', QTD_COD_ENTRADAS='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_ENTRADAS.AsString)+
             ', VLR_COD_ENTRADAS='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_COD_ENTRADAS.AsString)+
             ', PER_COD_ENTRADAS='+QuotedStr(DMBelShop.CDS_AuditoriasPER_COD_ENTRADAS.AsString)+

             ', QTD_COD_SAIDAS='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_SAIDAS.AsString)+
             ', VLR_COD_SAIDAS='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_COD_SAIDAS.AsString)+
             ', PER_COD_SAIDAS='+QuotedStr(DMBelShop.CDS_AuditoriasPER_COD_SAIDAS.AsString)+

             ', QTD_COD_NAO_CONTADOS='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_COD_NAO_CONTADOS.AsString)+
             ', VLR_COD_NAO_CONTADOS='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_COD_NAO_CONTADOS.AsString)+
             ', PER_COD_NAO_CONTADOS='+QuotedStr(DMBelShop.CDS_AuditoriasPER_COD_NAO_CONTADOS.AsString)+

             ', VLR_EST_FINAL='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_EST_FINAL.AsString)+

             ', PER_ADMISSIVEL='+QuotedStr(DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsString)+
             ', VLR_ADMISS_EQUIVALENTE='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_ADMISS_EQUIVALENTE.AsString)+

             ', PER_PERDA_FINAL='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PERDA_FINAL.AsString)+
             ', VLR_PERDA_EQUIVALENTE='+QuotedStr(DMBelShop.CDS_AuditoriasVLR_PERDA_EQUIVALENTE.AsString)+

             ', PER_OBJ_PER_ADMISSIVEL='+QuotedStr(DMBelShop.CDS_AuditoriasPER_OBJ_PER_ADMISSIVEL.AsString)+
             ', PER_OBJ_VLR_ADMISSIVEL='+QuotedStr(DMBelShop.CDS_AuditoriasPER_OBJ_VLR_ADMISSIVEL.AsString)+

             ', PER_PROD_FECHADOS='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS.AsString)+
             ', PER_PROD_FECHADOS_ENCONT='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_FECHADOS_ENCONT.AsString)+

             ', QTD_PROD_NAO_FECHADOS='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_PROD_NAO_FECHADOS.AsString)+
             ', PER_PROD_NAO_FECHADOS='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS.AsString)+
             ', PER_PROD_NAO_FECHADOS_ENCONT='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_FECHADOS_ENCONT.AsString)+

             ', QTD_PROD_NAO_RESOLVIDOS='+QuotedStr(DMBelShop.CDS_AuditoriasQTD_PROD_NAO_RESOLVIDOS.AsString)+
             ', PER_PROD_NAO_RESOLVIDOS='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS.AsString)+
             ', PER_PROD_NAO_RESOLVIDOS_ENCONT='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_RESOLVIDOS_ENCONT.AsString)+

             ', PER_PROD_NAO_CONTADOS='+QuotedStr(DMBelShop.CDS_AuditoriasPER_PROD_NAO_CONTADOS.AsString)+

             ', USU_ALTERA='+QuotedStr(Cod_Usuario)+
             ', DTA_ALTERA=Current_Date'+

             ' Where COD_LOJA='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger))+
             ' And DTA_AUDITORIA='+QuotedStr(DateToStr(DtEdtFinanAuditoriaManutData.Date));
      DMBelShop.SQLC.Execute(MySql, nil, nil);
    End; // If DMBelShop.CDS_Auditorias.State=dsEdit Then

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    // Busca as Datas de Todas as Auditorias ==================================
    AuditoriaTodasDatas;

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);

      Dbe_FinanAuditoriaManutVlrNegReal.SetFocus;
      Exit;
      
    End; // on e : Exception do
  End; // Try

  Bt_FinanAuditoriaManutSalvar.Caption:='Alterar';
  Bt_FinanAuditoriaManutSalvar.Enabled:=False;
  Bt_FinanAuditoriaManutExcluir.Enabled:=True;
  
  Dbe_FinanAuditoriaManutVlrNegReal.SetFocus;

end;

procedure TFrmBelShop.Dbe_FinanAuditoriaManutPerAdmissivelExit(Sender: TObject);
begin
  If DMBelShop.CDS_AuditoriasPER_ADMISSIVEL.AsCurrency<0 Then
  Begin
    msg('Percentual Invlido !!'+cr+cr+'No Pode ser Menor que <ZERO>','A');
    Dbe_FinanAuditoriaManutPerAdmissivel.SetFocus;
    Exit;
  End;

  Dbe_FinanAuditoriaManutVlrEstInicialExit(Self);
  Dbe_FinanAuditoriaManutVlrNegReal.SetFocus

end;

procedure TFrmBelShop.Bt_FinanAuditoriaManutBuscaAuditoriaClick(Sender: TObject);
Var
  s, MySql: String;
begin

  FrmPesquisa:=TFrmPesquisa.Create(Self);

  DtEdtFinanAuditoriaManutData.Clear;
                      
  DMBelShop.CDS_Auditorias.Close;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' Select au.dta_auditoria "Dta_Auditoria", au.Cod_Loja "Cod_Loja", em.Razao_Social "Razao_Social"'+
         ' From AUDITORIAS au, EMP_CONEXOES em'+
         ' Where  au.Cod_Loja=em.Cod_Filial'+
         ' And au.Cod_Loja='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger))+
         ' Order by au.Dta_Auditoria desc';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('Cod_Loja').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Loja Sem Auditoria Cadastrada !!','A');
    EdtFinanAuditoriaManutCodLoja.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Dta_Auditoria';
  FrmPesquisa.Campo_Codigo:='Cod_Loja';
  FrmPesquisa.Campo_Descricao:='Dta_Auditoria';
  FrmPesquisa.Campo_Retorno1:='Dta_Auditoria';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)='') Or (Trim(FrmPesquisa.EdtCodigo.Text)='0') Then
  Begin
    FreeAndNil(FrmPesquisa);
    EdtFinanAuditoriaManutCodLoja.SetFocus;
    Exit;
  End;

  s:=FrmPesquisa.Retorno1;
  FreeAndNil(FrmPesquisa);

  Pan_FinanAuditoriaManutSolic.Enabled:=True;
  DtEdtFinanAuditoriaManutData.Date:=StrToDate(s);

end;

procedure TFrmBelShop.DtEdtFinanAuditoriaManutDataKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
 If Key=VK_F9 Then
  Bt_FinanAuditoriaManutBuscaAuditoriaClick(Self);
end;

procedure TFrmBelShop.DBNav_FInainAuditoriaManutClick(Sender: TObject; Button: TNavigateBtn);
Var
  ss, s: String;
begin
  s:=DMBelShop.CDS_AuditoriaDatasDTA_AUDITORIA.AsString;
  ss:=DateToStr(DtEdtFinanAuditoriaManutData.Date);
  If StrToDate(s)<>StrToDate(ss) Then
  Begin
    Bt_FinanAuditoriaManutAbandonarClick(Self);
    Pan_FinanAuditoriaManutSolic.Enabled:=True;

    bgCor:=False;
    DtEdtFinanAuditoriaManutData.SetFocus;
    
    DtEdtFinanAuditoriaManutData.Date:=StrToDate(s);
    Refresh;
  End;


end;

procedure TFrmBelShop.Dbe_FinanAuditoriaManutVlrNegRealChange(Sender: TObject);
begin
  Bt_FinanAuditoriaManutSalvar.Enabled:=True;
end;

procedure TFrmBelShop.Bt_FinanObjetivosResultAuditSalvarClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_ObjetivosAuditorias.IsEmpty Then
  Begin
    Dbg_FinanObjetivosResultadosAuditoria.SetFocus;
    SalvaResultado_CLI(DMVirtual.CDS_V_ObjetivosAuditorias,Dbg_FinanObjetivosResultadosAuditoria,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosResultadosAuditoriaDrawColumnCell(Sender: TObject;
          const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin

  If not (gdSelected in State) Then
  Begin
    If DMVirtual.CDS_V_ObjetivosAuditoriasDES_LOJA.AsString<>'' Then
     Dbg_FinanObjetivosResultadosAuditoria.Canvas.Brush.Color:=clSkyBlue;

    If DMVirtual.CDS_V_ObjetivosAuditoriasDES_LOJA.AsString='TOTAL DA LOJA' Then
    Begin
      Dbg_FinanObjetivosResultadosAuditoria.Canvas.Font.Style:=[fsBold];
      Dbg_FinanObjetivosResultadosAuditoria.Canvas.Brush.Color:=$00FFF2F2;
    End;

    If DMVirtual.CDS_V_ObjetivosAuditoriasDES_LOJA.AsString='TOTAL DA EMPRESA' Then
    Begin
      Dbg_FinanObjetivosResultadosAuditoria.Canvas.Font.Style:=[fsBold];
      Dbg_FinanObjetivosResultadosAuditoria.Canvas.Brush.Color:=$00BBFFFF;
    End;

    Dbg_FinanObjetivosResultadosAuditoria.Canvas.FillRect(Rect);
    Dbg_FinanObjetivosResultadosAuditoria.DefaultDrawDataCell(Rect,Column.Field,state);
    
    If (Column.Field.FieldName = 'PERCENTUAL') then
    Begin
    
      If DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString='V' Then
       Dbg_FinanObjetivosResultadosAuditoria.Canvas.Font.Color:=clRed
      Else If DMVirtual.CDS_V_ObjetivosAuditoriasCOR.AsString='A' Then
       Dbg_FinanObjetivosResultadosAuditoria.Canvas.Font.Color:=clBlue
      Else
       Dbg_FinanObjetivosResultadosAuditoria.Canvas.Font.Color:=clBlack;

      Dbg_FinanObjetivosResultadosAuditoria.Canvas.FillRect(Rect);
      Dbg_FinanObjetivosResultadosAuditoria.DefaultDrawColumnCell(Rect, DataCol, Column, State);
    End; // If (Column.Field.FieldName = 'PERCENTUAL') then
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Bt_FinanObjetivosResultAuditVoltarClick(Sender: TObject);
begin
  // Posiciona no TabSheet =====================================================
  PC_FinanObjetivos.ActivePage:=Ts_FinanObjetivosManut;
  CorSelecaoTabSheet(PC_FinanObjetivos);
  Dbg_FinanObjetivosManut.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanAuditoriaManutExcluirClick(Sender: TObject);
Var
  MySql: String;
begin

  If msg('Deseja Realmente '+Bt_FinanAuditoriaManutExcluir.Caption+cr+cr+' a Auditoria Selecionada ??','C')=2 Then
  Begin
    Dbe_FinanAuditoriaManutVlrNegReal.SetFocus;
    Exit;
  End;

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;

    DateSeparator:='.';
    DecimalSeparator:='.';
    
    MySql:=' Delete From  AUDITORIAS au'+
           ' Where COD_LOJA='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaManutCodLoja.AsInteger))+
           ' And DTA_AUDITORIA='+QuotedStr(DateToStr(DtEdtFinanAuditoriaManutData.Date));
    DMBelShop.SQLC.Execute(MySql, nil, nil);

    // Fecha Transacao ===========================================================
    DMBelShop.SQLC.Commit(TD);

    // Busca as Datas de Todas as Auditorias ==================================
    AuditoriaTodasDatas;

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      DMBelShop.SQLC.Rollback(TD);
      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);

      Dbe_FinanAuditoriaManutVlrNegReal.SetFocus;
      Exit;
    End; // on e : Exception do
  End; // Try

  Bt_FinanAuditoriaManutAbandonarClick(Self);

end;

procedure TFrmBelShop.Bt_GeraOCRecalculoLojaClick(Sender: TObject);
begin
  If msg('Deseja Realmente Recalcular uma Loja ??','C')=2 Then
   Exit;
end;

procedure TFrmBelShop.Bt_ConsultaNFeEmpresaClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_NFe.Active Then
   Exit;

  PC_ConsultaMovtoCompr.ActivePage:=Ts_ConsultaNFeMovtoCompr;
  PC_ConsultaMovtoComprChange(Self);
  SBar_ConsultaNFeNotasLojas.Visible:=False;

  DMVirtual.CDS_V_NFeCOD_COMPROV.Visible:=False;
  DMVirtual.CDS_V_NFeCOD_FORNECEDOR.Visible:=False;
  DMVirtual.CDS_V_NFeDES_COMPROV.Visible:=False;
  DMVirtual.CDS_V_NFeDES_FORNECEDOR.Visible:=False;
  DMVirtual.CDS_V_NFeDES_SERIE.Visible:=False;
  DMVirtual.CDS_V_NFeDTA_ENTRADA.Visible:=False;
  DMVirtual.CDS_V_NFeDTA_NOTA.Visible:=False;

  DMVirtual.CDS_V_NFe.Filtered:=False;
  DMVirtual.CDS_V_NFe.Filter:='COD_LOJA=9999';
  DMVirtual.CDS_V_NFe.Filtered:=True;

  Dbg_ConsultaNFeEmpresa.Align:=alClient;
  Dbg_ConsultaNFeLojas.Align:=alNone;
  Dbg_ConsultaNFeNotasLojas.Align:=alNone;
  
  Dbg_ConsultaNFeEmpresa.Visible:=True;
  Dbg_ConsultaNFeLojas.Visible:=False;
  Dbg_ConsultaNFeNotasLojas.Visible:=False;

  Dbg_ConsultaNFeEmpresa.SetFocus;
end;

procedure TFrmBelShop.Bt_ConsultaNFeLojasClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_NFe.Active Then
   Exit;

  PC_ConsultaMovtoCompr.ActivePage:=Ts_ConsultaNFeMovtoCompr;
  SBar_ConsultaNFeNotasLojas.Visible:=False;

  DMVirtual.CDS_V_NFeCOD_COMPROV.Visible:=False;
  DMVirtual.CDS_V_NFeCOD_FORNECEDOR.Visible:=False;
  DMVirtual.CDS_V_NFeDES_COMPROV.Visible:=False;
  DMVirtual.CDS_V_NFeDES_FORNECEDOR.Visible:=True;
  DMVirtual.CDS_V_NFeDES_SERIE.Visible:=False;
  DMVirtual.CDS_V_NFeDTA_ENTRADA.Visible:=False;
  DMVirtual.CDS_V_NFeDTA_NOTA.Visible:=False;

  DMVirtual.CDS_V_NFe.Filtered:=False;
  DMVirtual.CDS_V_NFe.Filter:='DES_FORNECEDOR='+QuotedStr('Total da LOJA');
  DMVirtual.CDS_V_NFe.Filtered:=True;

  Dbg_ConsultaNFeEmpresa.Align:=alNone;
  Dbg_ConsultaNFeLojas.Align:=alClient;
  Dbg_ConsultaNFeNotasLojas.Align:=alNone;
  
  Dbg_ConsultaNFeEmpresa.Visible:=False;
  Dbg_ConsultaNFeLojas.Visible:=True;
  Dbg_ConsultaNFeNotasLojas.Visible:=False;

  Dbg_ConsultaNFeLojas.SetFocus;

end;

procedure TFrmBelShop.Bt_ConsultaNFeNotasClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_NFe.Active Then
   Exit;

  PC_ConsultaMovtoCompr.ActivePage:=Ts_ConsultaNFeMovtoCompr;
  SBar_ConsultaNFeNotasLojas.Visible:=True;

  DMVirtual.CDS_V_NFeCOD_COMPROV.Visible:=True;
  DMVirtual.CDS_V_NFeCOD_FORNECEDOR.Visible:=True;
  DMVirtual.CDS_V_NFeDES_COMPROV.Visible:=True;
  DMVirtual.CDS_V_NFeDES_FORNECEDOR.Visible:=True;
  DMVirtual.CDS_V_NFeDES_SERIE.Visible:=True;
  DMVirtual.CDS_V_NFeDTA_ENTRADA.Visible:=True;
  DMVirtual.CDS_V_NFeDTA_NOTA.Visible:=True;

  DMVirtual.CDS_V_NFe.Filtered:=False;
  If Rb_ConsultaNFeApresAnalitica.Checked Then
   DMVirtual.CDS_V_NFe.Filter:=''
  Else
   Begin
    DMVirtual.CDS_V_NFe.Filter:='DTA_NOTA IS NULL';
    DMVirtual.CDS_V_NFe.Filtered:=True;
   End;

  Dbg_ConsultaNFeEmpresa.Align:=alNone;
  Dbg_ConsultaNFeLojas.Align:=alNone;
  Dbg_ConsultaNFeNotasLojas.Align:=alClient;

  Dbg_ConsultaNFeEmpresa.Visible:=False;
  Dbg_ConsultaNFeLojas.Visible:=False;
  Dbg_ConsultaNFeNotasLojas.Visible:=True;

  Dbg_ConsultaNFeNotasLojas.SetFocus;

end;

procedure TFrmBelShop.Bt_ConsultaNFeBuscaOCsClick(Sender: TObject);
begin

  // Inicializa Tudo ===========================================================
  DtEdt_ConsultaNFeDtInicio.SetFocus;

  Dbg_ConsultaNFeEmpresa.Align:=alNone;
  Dbg_ConsultaNFeLojas.Align:=alNone;
  Dbg_ConsultaNFeNotasLojas.Align:=alNone;

  Dbg_ConsultaNFeEmpresa.Visible:=False;
  Dbg_ConsultaNFeLojas.Visible:=False;
  Dbg_ConsultaNFeNotasLojas.Visible:=False;

  // Consiste ==================================================================
  If DMVirtual.CDS_V_Comprovantes.IsEmpty Then
  Begin
    If msg('SEM Comprovante Selecionado !!'+cr+'TODOS Sero Selecionados...'+cr+'Deseja Continuar ???','C')=2 Then
    Begin
      PC_Filtros.ActivePage:=TS_FiltroComprovantes;
      CorSelecaoTabSheet(PC_Filtros);
      EdtFiltroCodComprov.SetFocus;
      Exit;
    End;
  End;

  If (Trim(DtEdt_ConsultaNFeDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaNfeDtFim.Text)<>'') Then
   Begin
     Try
       StrToDate(DtEdt_ConsultaNFeDtInicio.Text);
     Except
       msg('Data Inicial do Perodo Invlida !!','A');
       DtEdt_ConsultaNFeDtInicio.SetFocus;
       Exit;
     End;

     Try
       StrToDate(DtEdt_ConsultaNFeDtFim.Text);
     Except
       msg('Data Final do Perodo Invlida !!','A');
       DtEdt_ConsultaNfeDtFim.SetFocus;
       Exit;
     End;

     If DtEdt_ConsultaNFeDtFim.Date<DtEdt_ConsultaNFeDtInicio.Date Then
     Begin
       msg('Perodo Invlido !!','A');
       DtEdt_ConsultaNFeDtInicio.SetFocus;
       Exit;
     End;
   End
  Else // If (Trim(DtEdt_ConsultaNFeDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaNFeDtFim.Text)='') Then
   Begin
     msg('Perodo Invlido !!','A');
     DtEdt_ConsultaNFeDtInicio.SetFocus;
     Exit;
   End; // If (Trim(DtEdt_ConsultaNFeDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaNFeDtFim.Text)='') Then

  If msg('O Perodo Informado de '+cr+DtEdt_ConsultaNFeDtInicio.Text+' a '+DtEdt_ConsultaNFeDtFim.Text+cr+cr+'Esta CORRETO ??','C')=2 Then
   Exit;

  // Inicializa Apresentao do Resultado dos Produtos =========================
  DMVirtual.CDS_SelectLoja.Close;
  Ckbx_ConsultaNFeApresTotais.Checked:=False;
  Ckbx_ConsultaNFeApresTotaisClick(Self);

  // Libera ClientDataSet de Produtos -------------------------------
  If DMVirtual.CDS_V_NFeProdutos.Active Then
   DMVirtual.CDS_V_NFeProdutos.Close;

  DMVirtual.CDS_V_NFeProdutos.CreateDataSet;
  DMVirtual.CDS_V_NFeProdutos.IndexFieldNames:='';
  DMVirtual.CDS_V_NFeProdutos.Open;

  // Cria DataSet NFe ==========================================================
  If DMVirtual.CDS_V_NFe.Active Then
   DMVirtual.CDS_V_NFe.Close;

  DMVirtual.CDS_V_NFe.CreateDataSet;
  DMVirtual.CDS_V_NFe.Open;

  // Busca Comprovantes ========================================================
  If BuscaMovtosComprov Then // If ApresentaNFe Then // Antigo ApresentaNFe: Boolean;
  Begin
    // Apresenta Resultado -----------------------------------------------------
    Bt_ConsultaNFeEmpresaClick(Self);
  End;

end;

procedure TFrmBelShop.DtEdt_ConsultaNFeDtFimEditing(Sender: TObject; var CanEdit: Boolean);
begin
  If DMVirtual.CDS_V_NFe.Active Then
   DMVirtual.CDS_V_NFe.Close;
end;

procedure TFrmBelShop.Dbg_ConsultaNFeNotasLojasDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If not (gdSelected in State) Then
  Begin
    If (DMVirtual.CDS_V_NFeCOD_LOJA.AsString<>'') and (DMVirtual.CDS_V_NFeCOD_LOJA.AsString<>'9999') And 
       (DMVirtual.CDS_V_NFeDES_LOJA.AsString<>'') Then
     Dbg_ConsultaNFeNotasLojas.Canvas.Brush.Color:=clSkyBlue;

    If DMVirtual.CDS_V_NFeDES_FORNECEDOR.AsString='Total da LOJA' Then
    Begin
      Dbg_ConsultaNFeNotasLojas.Canvas.Font.Style:=[fsBold];
      Dbg_ConsultaNFeNotasLojas.Canvas.Brush.Color:=clSkyBlue;
    End;

    If DMVirtual.CDS_V_NFeDES_LOJA.AsString='Participao Comprovante' Then
    Begin
      Dbg_ConsultaNFeNotasLojas.Canvas.Font.Style:=[fsBold];
      Dbg_ConsultaNFeNotasLojas.Canvas.Brush.Color:=$00E4F2F3;
    End;

    If DMVirtual.CDS_V_NFeDES_LOJA.AsString='Total da EMPRESA' Then
    Begin
      Dbg_ConsultaNFeNotasLojas.Canvas.Font.Style:=[fsBold];
      Dbg_ConsultaNFeNotasLojas.Canvas.Brush.Color:=$00BBFFFF;
    End;

    If DMVirtual.CDS_V_NFeCOD_LOJA.AsString='' Then
      Dbg_ConsultaNFeNotasLojas.Canvas.Brush.Color:=$00E4F2F3;

    Dbg_ConsultaNFeNotasLojas.Canvas.FillRect(Rect);
    Dbg_ConsultaNFeNotasLojas.DefaultDrawDataCell(Rect,Column.Field,state);

    DMVirtual.CDS_V_NFeCOD_LOJA.Alignment:=taCenter;
    DMVirtual.CDS_V_NFeCOD_COMPROV.Alignment:=taRightJustify;
    DMVirtual.CDS_V_NFeDES_SERIE.Alignment:=taRightJustify;
    DMVirtual.CDS_V_NFeDTA_NOTA.Alignment:=taCenter;
    DMVirtual.CDS_V_NFeDTA_ENTRADA.Alignment:=taCenter;

  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Bt_ConsultaNFeSalvarClipboardClick(Sender: TObject);
begin

  If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeMovtoCompr) And (Ts_ConsultaNFeMovtoCompr.CanFocus) Then
  Begin
    If Not DMVirtual.CDS_V_NFe.Active Then
     Exit;

    If Dbg_ConsultaNFeLojas.Visible Then
     DBGridClipboard(Dbg_ConsultaNFeLojas);

    If Dbg_ConsultaNFeEmpresa.Visible Then
     DBGridClipboard(Dbg_ConsultaNFeEmpresa);

    If Dbg_ConsultaNFeNotasLojas.Visible Then
     DBGridClipboard(Dbg_ConsultaNFeNotasLojas);
  End; // If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeMovtoCompr) And (Ts_ConsultaNFeMovtoCompr.CanFocus) Then

  If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeProdutos) And (Ts_ConsultaNFeProdutos.CanFocus) Then
  Begin
    If Not DMVirtual.CDS_V_NFeProdutos.Active Then
     Exit;

     DBGridClipboard(Dbg_ConsultaNFeProdutos);
  End;

end;

procedure TFrmBelShop.Bt_ConsultaNFeSalvarCSVClick(Sender: TObject);
begin
  If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeMovtoCompr) And (Ts_ConsultaNFeMovtoCompr.CanFocus) Then
  Begin
    If Not DMVirtual.CDS_V_NFe.Active Then
     Exit;

    PC_ConsultaMovtoCompr.ActivePage:=Ts_ConsultaNFeMovtoCompr;

    If Dbg_ConsultaNFeLojas.Visible Then
     SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_NFe,Dbg_ConsultaNFeLojas, Mem_Salvar);

    If Dbg_ConsultaNFeEmpresa.Visible Then
     SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_NFe,Dbg_ConsultaNFeEmpresa, Mem_Salvar);

    If Dbg_ConsultaNFeNotasLojas.Visible Then
     SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_NFe,Dbg_ConsultaNFeNotasLojas, Mem_Salvar);
  End; // If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeMovtoCompr) And (Ts_ConsultaNFeMovtoCompr.CanFocus) Then


  If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeProdutos) And (Ts_ConsultaNFeProdutos.CanFocus) Then
  Begin
    If Not DMVirtual.CDS_V_NFeProdutos.Active Then
     Exit;

    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_NFeProdutos,Dbg_ConsultaNFeProdutos, Mem_Salvar);
  End; // If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeMovtoCompr) And (Ts_ConsultaNFeMovtoCompr.CanFocus) Then

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutUlt12MesesClick(Sender: TObject);
begin
  If Ckb_FinanObjetivosManutAvarias.Checked Then
   Ckb_FinanObjetivosManutUlt12Meses.Checked:=True;

  AcertaCkb_SN(Ckb_FinanObjetivosManutUlt12Meses);

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutUlt12MesesKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosManutUlt12MesesClick(Self);

end;

procedure TFrmBelShop.EdtFinanObjetivosGerarAnoClick(Sender: TObject);
begin
  Cbx_FinanObjetivosGerarMesChange(Self);
end;

procedure TFrmBelShop.EdtFinanObjetivosGerarAnoEditing(Sender: TObject; var CanEdit: Boolean);
begin
  Cbx_FinanObjetivosGerarMesChange(Self);

end;

procedure TFrmBelShop.EdtFinanObjetivosGerarAnoDblClick(Sender: TObject);
begin
  Cbx_FinanObjetivosGerarMesChange(Self);

end;

procedure TFrmBelShop.SubMenuFinanAuditoriaManutencaoClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  EdtFinanAuditoriaManutCodLoja.Clear;
  DtEdtFinanAuditoriaManutData.Enabled:=False;
  DtEdtFinanAuditoriaManutData.Clear;
  Bt_FinanAuditoriaManutBuscaAuditoria.Enabled:=False;
  EdtFinanAuditoriaManutDesLoja.Clear;
  Gb_FinanAuditoriaManut.Enabled:=False;

  bgCor:=True;

  Ts_FinanAuditoriaAnalises.TabVisible:=False;
  Ts_FinanAuditoriaManut.TabVisible:=True;
  SelecionaTabSheet(Ts_FinanAuditoria);
  CorSelecaoTabSheet(PC_Principal);

  EdtFinanAuditoriaManutCodLoja.SetFocus;

end;

procedure TFrmBelShop.SubMenuFinanAuditoriaAnaliseClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  EdtFinanAuditoriaAnaliseCodLoja.Clear;
  Bt_FinanAuditoriaAnaliseBuscaAuditoria.Enabled:=False;
  EdtFinanAuditoriaAnaliseDesLoja.Clear;
  DMBelShop.CDS_AuditoriaAnalise.Close;

  bgCor:=True;

  Ts_FinanAuditoriaAnalises.TabVisible:=True;
  Ts_FinanAuditoriaManut.TabVisible:=False;
  SelecionaTabSheet(Ts_FinanAuditoria);
  CorSelecaoTabSheet(PC_Principal);

  EdtFinanAuditoriaAnaliseCodLoja.SetFocus;

end;

procedure TFrmBelShop.EdtFinanAuditoriaAnaliseCodLojaExit(Sender: TObject);
Var
  MySql: String;
begin

  EdtFinanAuditoriaAnaliseDesLoja.Clear;
                                  
  If EdtFinanAuditoriaAnaliseCodLoja.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Fornecedores ======================================================
    MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
           ' From EMP_CONEXOES'+
           ' Where COD_FILIAL='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaAnaliseCodLoja.AsInteger));
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('COD_FILIAL').AsString)='' Then
    Begin
      msg('Loja NO Encontrada !!!', 'A');
      Screen.Cursor:=crDefault;
      EdtFinanAuditoriaAnaliseCodLoja.Clear;
      EdtFinanAuditoriaAnaliseCodLoja.SetFocus;
      DMBelShop.CDS_BuscaRapida.Close;
      Exit;
    End;

    EdtFinanAuditoriaAnaliseDesLoja.Text:=DMBelShop.CDS_BuscaRapida.FieldByName('Razao_Social').AsString;

    DMBelShop.CDS_BuscaRapida.Close;

    Screen.Cursor:=crDefault;
   
    Bt_FinanAuditoriaAnaliseBuscaAuditoriaClick(Self);
  End;
end;

procedure TFrmBelShop.Bt_FinanAuditoriaAnaliseBuscaAuditoriaClick(Sender: TObject);
Var
  MySql: String;
  s, sDtaAuditoria: String; 
begin

  FrmPesquisa:=TFrmPesquisa.Create(Self);

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;                                                         

  MySql:=' Select au.dta_auditoria "Dta_Auditoria", au.Cod_Loja "Cod_Loja", em.Razao_Social "Razao_Social"'+
         ' From AUDITORIAS au, EMP_CONEXOES em'+
         ' Where  au.Cod_Loja=em.Cod_Filial'+
         ' And au.Cod_Loja='+QuotedStr(FormatFloat('00',EdtFinanAuditoriaAnaliseCodLoja.AsInteger))+
         ' Order by au.Dta_Auditoria desc';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('Cod_Loja').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Loja Sem Auditoria Cadastrada !!','A');
    EdtFinanAuditoriaAnaliseDesLoja.Clear;
    EdtFinanAuditoriaAnaliseCodLoja.Clear;
    EdtFinanAuditoriaAnaliseCodLoja.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Dta_Auditoria';
  FrmPesquisa.Campo_Codigo:='Cod_Loja';
  FrmPesquisa.Campo_Descricao:='Dta_Auditoria';
  FrmPesquisa.Campo_Retorno1:='Dta_Auditoria';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)='') Or (Trim(FrmPesquisa.EdtCodigo.Text)='0') Then
  Begin
    FreeAndNil(FrmPesquisa);
    EdtFinanAuditoriaAnaliseDesLoja.Clear;
    EdtFinanAuditoriaAnaliseCodLoja.Clear;
    EdtFinanAuditoriaAnaliseCodLoja.SetFocus;
    Exit;
  End;

  sDtaAuditoria:=FrmPesquisa.Retorno1;
  sDtaAuditoria:=f_Troca('/','.',sDtaAuditoria);
  sDtaAuditoria:=f_Troca('-','.',sDtaAuditoria);
  
  FreeAndNil(FrmPesquisa);

  // Acerta o Codigo da Loja ===================================================
  sgCodEmp:=VarToStr(EdtFinanAuditoriaAnaliseCodLoja.Value);
  If EdtFinanAuditoriaAnaliseCodLoja.Value<10 Then
   sgCodEmp:='0'+VarToStr(EdtFinanAuditoriaAnaliseCodLoja.Value);
   
  // Verifica se J Existe a Auditoria =========================================
  s:='(au.cod_loja='+QuotedStr(sgCodEmp)+' and au.dta_auditoria='+QuotedStr(sDtaAuditoria)+')';
  If Not AnsiContainsStr(MySqlClausula1,s) Then
  Begin
    // Busca Auditorias Selecionadas =============================================
    If MySqlClausula1='' Then
     MySqlClausula1:='(au.cod_loja='+QuotedStr(sgCodEmp)+
                     ' and au.dta_auditoria='+QuotedStr(sDtaAuditoria)+')'
    Else
     MySqlClausula1:=MySqlClausula1+' or (au.cod_loja='+QuotedStr(sgCodEmp)+
                                    ' and au.dta_auditoria='+QuotedStr(sDtaAuditoria)+')';
                        
    // Apresenta Auditoria para Analise ==========================================
    AuditoriaAnalise(MySqlClausula1);
  End; // If Not AnsiContainsStr(MySqlClausula1,s) Then
    
  EdtFinanAuditoriaAnaliseDesLoja.Clear;
  EdtFinanAuditoriaAnaliseCodLoja.Clear;
  EdtFinanAuditoriaAnaliseCodLoja.SetFocus;
  
end;

procedure TFrmBelShop.Bt_FinanAuditoriaAnaliseBuscaLojaClick(Sender: TObject);
Var
  MySql: String;
begin
   
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  EdtFinanAuditoriaAnaliseCodLoja.Clear;
  EdtFinanAuditoriaAnaliseDesLoja.Clear;

  EdtFinanAuditoriaAnaliseCodLoja.SetFocus;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
         ' From EMP_CONEXOES'+
         ' Where IND_ATIVO=''SIM'''+
         ' Order by RAZAO_SOCIAL';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('COD_FILIAL').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Sem Loja a Listar !!','A');
    EdtFinanAuditoriaAnaliseCodLoja.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Razao_Social';
  FrmPesquisa.Campo_Codigo:='Cod_Filial';
  FrmPesquisa.Campo_Descricao:='Razao_Social';
  // FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtFinanAuditoriaAnaliseCodLoja.Text:=FrmPesquisa.EdtCodigo.Text;
     EdtFinanAuditoriaAnaliseDesLoja.Text:=FrmPesquisa.EdtDescricao.Text;

     FreeAndNil(FrmPesquisa);

     Bt_FinanAuditoriaAnaliseBuscaAuditoriaClick(Self);
     Exit;
   End
  Else
   Begin
     EdtFinanAuditoriaAnaliseCodLoja.Clear;
     EdtFinanAuditoriaAnaliseDesLoja.Clear;
     EdtFinanAuditoriaAnaliseCodLoja.SetFocus;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.Dbg_FinanAuditoriaAnaliseDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If not (gdSelected in State) Then
  Begin
    If DMBelShop.CDS_AuditoriaAnaliseCOD_LOJA.AsString='999' Then
    Begin
      Dbg_FinanAuditoriaAnalise.Canvas.Font.Style:=[fsBold];
      Dbg_FinanAuditoriaAnalise.Canvas.Brush.Color:=$00BBFFFF;
    End;
    Dbg_FinanAuditoriaAnalise.Canvas.FillRect(Rect);
    Dbg_FinanAuditoriaAnalise.DefaultDrawDataCell(Rect,Column.Field,state);

    If (Column.Field.FieldName = 'PER_PERDA_FINAL') Or 
       (Column.Field.FieldName = 'PER_OBJ_PER_ADMISSIVEL') Or 
       (Column.Field.FieldName = 'COD_LOJA') Or 
       (Column.Field.FieldName = 'RAZAO_SOCIAL') Then
    Begin
    
      If DMBelShop.CDS_AuditoriaAnaliseCORPER.AsString='V' Then
       Dbg_FinanAuditoriaAnalise.Canvas.Font.Color:=clRed
      Else If DMBelShop.CDS_AuditoriaAnaliseCORPER.AsString='A' Then
       Dbg_FinanAuditoriaAnalise.Canvas.Font.Color:=clBlue
      Else
       Dbg_FinanAuditoriaAnalise.Canvas.Font.Color:=clBlack;

      Dbg_FinanAuditoriaAnalise.Canvas.FillRect(Rect);
      Dbg_FinanAuditoriaAnalise.DefaultDrawColumnCell(Rect, DataCol, Column, State);
    End; // If (Column.Field.FieldName = 'PERCENTUAL') then
  End; // if not (gdSelected in State) Then


end;

procedure TFrmBelShop.Bt_FinanAuditoriaAnaliseFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);
  MySqlClausula1:='';

end;

procedure TFrmBelShop.Bt_FinanAuditoriaAnaliseSalvarClick(Sender: TObject);
begin
  If Not DMBelShop.CDS_AuditoriaAnalise.IsEmpty Then
  Begin
    Dbg_FinanAuditoriaAnalise.SetFocus;
    SalvaResultado_CLI(DMBelShop.CDS_AuditoriaAnalise,Dbg_FinanAuditoriaAnalise,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.Bt_FinanAuditoriaAnaliseExcluirClick(Sender: TObject);
var
  s: String;
  sDta, sCod: String;
begin
  If Not DMBelShop.CDS_AuditoriaAnalise.IsEmpty Then
  Begin
    sCod:=DMBelShop.CDS_AuditoriaAnaliseCOD_LOJA.AsString;
    sDta:=DMBelShop.CDS_AuditoriaAnaliseDTA_AUDITORIA.AsString;
    sDta:=f_Troca('/','.',sDta);
    sDta:=f_Troca('-','.',sDta);
  
    s:=' or (au.cod_loja='+QuotedStr(sCod)+' and au.dta_auditoria='+QuotedStr(sDta)+')';
    MySqlClausula1:=StringReplace(MySqlClausula1, s, '', [rfReplaceAll]);

    s:='(au.cod_loja='+QuotedStr(sCod)+' and au.dta_auditoria='+QuotedStr(sDta)+') or';
    MySqlClausula1:=StringReplace(MySqlClausula1, s, '', [rfReplaceAll]);
                         
    s:='(au.cod_loja='+QuotedStr(sCod)+' and au.dta_auditoria='+QuotedStr(sDta)+')';
    MySqlClausula1:=StringReplace(MySqlClausula1, s, '', [rfReplaceAll]);

    // Reapresenta Auditorias ==================================================
    AuditoriaAnalise(MySqlClausula1);
    
  End; // If Not DMBelShop.CDS_AuditoriaAnalise.IsEmpty Then
end;

procedure TFrmBelShop.Bt_FinanObjetivosResultDiasVoltarClick(Sender: TObject);
begin
  // Posiciona no TabSheet =====================================================
  PC_FinanObjetivos.ActivePage:=Ts_FinanObjetivosManut;
  CorSelecaoTabSheet(PC_FinanObjetivos);
  Dbg_FinanObjetivosManut.SetFocus;

end;

procedure TFrmBelShop.Ckb_CalculoCurvaTodasClick(Sender: TObject);
begin
  If Ckb_CalculoCurvaTodas.Checked Then
   Begin
     Ckb_CalculoCurvaA.Checked:=True;
     Ckb_CalculoCurvaB.Checked:=True;
     Ckb_CalculoCurvaC.Checked:=True;
     Ckb_CalculoCurvaD.Checked:=True;
     Ckb_CalculoCurvaE.Checked:=True;

     Ckb_CalculoCurvaA.Enabled:=False;
     Ckb_CalculoCurvaB.Enabled:=False;
     Ckb_CalculoCurvaC.Enabled:=False;
     Ckb_CalculoCurvaD.Enabled:=False;
     Ckb_CalculoCurvaE.Enabled:=False;

     Gb_CalculoApresCurva.Visible:=False;
     Ckb_CalculoApresCurvaForaClick(Self);
   End
  Else
   Begin
     Ckb_CalculoCurvaA.Checked:=True;
     Ckb_CalculoCurvaB.Checked:=False;
     Ckb_CalculoCurvaC.Checked:=False;
     Ckb_CalculoCurvaD.Checked:=False;
     Ckb_CalculoCurvaE.Checked:=False;

     Ckb_CalculoCurvaA.Enabled:=True;
     Ckb_CalculoCurvaB.Enabled:=True;
     Ckb_CalculoCurvaC.Enabled:=True;
     Ckb_CalculoCurvaD.Enabled:=True;
     Ckb_CalculoCurvaE.Enabled:=True;

     Gb_CalculoApresCurva.Visible:=True;
     Ckb_CalculoApresCurvaForaClick(Self);
   End;

  AcertaCkb_Style(Ckb_CalculoCurvaTodas);
  AcertaCkb_Style(Ckb_CalculoCurvaA);
  AcertaCkb_Style(Ckb_CalculoCurvaB);
  AcertaCkb_Style(Ckb_CalculoCurvaC);
  AcertaCkb_Style(Ckb_CalculoCurvaD);
  AcertaCkb_Style(Ckb_CalculoCurvaE);
end;

procedure TFrmBelShop.Ckb_CalculoCurvaTodasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_CalculoCurvaTodasClick(Self);
end;

procedure TFrmBelShop.Ckb_CalculoCurvaAClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_CalculoCurvaA);

  Gb_CalculoApresCurva.Visible:=False;
  If (Not Ckb_CalculoCurvaA.Checked) Or (Not Ckb_CalculoCurvaB.Checked) Or
     (Not Ckb_CalculoCurvaC.Checked) Or (Not Ckb_CalculoCurvaD.Checked) Or
     (Not Ckb_CalculoCurvaE.Checked) Then
  Begin
    Gb_CalculoApresCurva.Visible:=True;
  End;

  If (Ckb_CalculoCurvaA.Checked) And (Ckb_CalculoCurvaB.Checked) And
     (Ckb_CalculoCurvaC.Checked) And (Ckb_CalculoCurvaD.Checked) And
     (Ckb_CalculoCurvaE.Checked) Then
  Begin
    Ckb_CalculoCurvaTodas.Checked:=True;
    Gb_CalculoApresCurva.Visible:=False;
    Ckb_CalculoCurvaTodasClick(Self)
  End;

  If (Not Ckb_CalculoCurvaA.Checked) and (Not Ckb_CalculoCurvaB.Checked) and 
     (Not Ckb_CalculoCurvaC.Checked) and (Not Ckb_CalculoCurvaD.Checked) and 
     (Not Ckb_CalculoCurvaE.Checked) Then
  Begin
    Ckb_CalculoCurvaTodas.Checked:=True;
    Ckb_CalculoCurvaTodasClick(Self);

    Gb_CalculoApresCurva.Visible:=False;
  End;
end;

procedure TFrmBelShop.Ckb_CalculoCurvaAKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_CalculoCurvaAClick(Self);

end;

procedure TFrmBelShop.Ckb_CalculoCurvaBKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_CalculoCurvaBClick(Self);

end;

procedure TFrmBelShop.Ckb_CalculoCurvaBClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_CalculoCurvaB);

  Ckb_CalculoCurvaAClick(Self);
end;

procedure TFrmBelShop.Ckb_CalculoCurvaCClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_CalculoCurvaC);

  Ckb_CalculoCurvaAClick(Self);

end;

procedure TFrmBelShop.Ckb_CalculoCurvaCKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_CalculoCurvaCClick(Self);

end;

procedure TFrmBelShop.Ckb_CalculoCurvaDClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_CalculoCurvaD);

  Ckb_CalculoCurvaAClick(Self);
end;

procedure TFrmBelShop.Ckb_CalculoCurvaDKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_CalculoCurvaDClick(Self);

end;

procedure TFrmBelShop.Ckb_CalculoCurvaEClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_CalculoCurvaE);

  Ckb_CalculoCurvaAClick(Self);
end;

procedure TFrmBelShop.Ckb_CalculoCurvaEKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_CalculoCurvaEClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaTodasClick(Sender: TObject);
begin 
  If Ckb_EstFisFinanCurvaTodas.Checked Then
   Begin
     Ckb_EstFisFinanCurvaA.Checked:=True;
     Ckb_EstFisFinanCurvaB.Checked:=True;
     Ckb_EstFisFinanCurvaC.Checked:=True;
     Ckb_EstFisFinanCurvaD.Checked:=True;
     Ckb_EstFisFinanCurvaE.Checked:=True;

     Ckb_EstFisFinanCurvaA.Enabled:=False;
     Ckb_EstFisFinanCurvaB.Enabled:=False;
     Ckb_EstFisFinanCurvaC.Enabled:=False;
     Ckb_EstFisFinanCurvaD.Enabled:=False;
     Ckb_EstFisFinanCurvaE.Enabled:=False;
   End
  Else
   Begin
     Ckb_EstFisFinanCurvaA.Checked:=True;
     Ckb_EstFisFinanCurvaB.Checked:=False;
     Ckb_EstFisFinanCurvaC.Checked:=False;
     Ckb_EstFisFinanCurvaD.Checked:=False;
     Ckb_EstFisFinanCurvaE.Checked:=False;

     Ckb_EstFisFinanCurvaA.Enabled:=True;
     Ckb_EstFisFinanCurvaB.Enabled:=True;
     Ckb_EstFisFinanCurvaC.Enabled:=True;
     Ckb_EstFisFinanCurvaD.Enabled:=True;
     Ckb_EstFisFinanCurvaE.Enabled:=True;
   End;

   AcertaCkb_Style(Ckb_EstFisFinanCurvaTodas);
   AcertaCkb_Style(Ckb_EstFisFinanCurvaA);
   AcertaCkb_Style(Ckb_EstFisFinanCurvaB);
   AcertaCkb_Style(Ckb_EstFisFinanCurvaC);
   AcertaCkb_Style(Ckb_EstFisFinanCurvaD);
   AcertaCkb_Style(Ckb_EstFisFinanCurvaE);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaTodasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanCurvaTodasClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaAClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_EstFisFinanCurvaA);

  If (Not Ckb_EstFisFinanCurvaA.Checked) and (Not Ckb_EstFisFinanCurvaB.Checked) and
     (Not Ckb_EstFisFinanCurvaC.Checked) and (Not Ckb_EstFisFinanCurvaD.Checked) and 
     (Not Ckb_EstFisFinanCurvaE.Checked) Then
  Begin
    Ckb_EstFisFinanCurvaTodas.Checked:=True;
    Ckb_EstFisFinanCurvaTodasClick(Self);
  End;

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaAKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanCurvaAClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaBClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_EstFisFinanCurvaB);

  Ckb_EstFisFinanCurvaAClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaBKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanCurvaBClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaCClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_EstFisFinanCurvaC);

  Ckb_EstFisFinanCurvaAClick(Self);
end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaCKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanCurvaCClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaDClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_EstFisFinanCurvaD);

  Ckb_EstFisFinanCurvaAClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaDKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanCurvaDClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaEClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_EstFisFinanCurvaE);

  Ckb_EstFisFinanCurvaAClick(Self);

end;

procedure TFrmBelShop.Ckb_EstFisFinanCurvaEKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanCurvaEClick(Self);

end;

procedure TFrmBelShop.Bt_EstFisFinanGiroEstoquesClick(Sender: TObject);
Var
  i, iOrdem: Integer;
  sLojasProc: String;
  bDados, bLoja: Boolean;
  c, cTotEstI, cTotEstF, cTotSaidas,
  cTotEstIG, cTotEstFG, cTotSaidasG: Currency;
begin

  If Cbx_EstFisFinanSituacaoProd.ItemIndex=-1 Then
  Begin
    msg('Favor Informar a Situaes dos Produtos !!','A');
    Cbx_EstFisFinanSituacaoProd.SetFocus;
    Exit;
  End; // If (Trim(DtEdt_ConsultaOCDtInicio.Text)<>'') Or (Trim(DtEdt_ConsultaOCDtFim.Text)='') Then

  If msg('Deseja Realmente Calcular o'+cr+'Giro de Estoque ??','C')=2 Then
   Exit;

  Screen.Cursor:=crAppStart;

  // Produtos Selecionados =====================================================
  SelecionaProdutos(True, True);

  // Grupos e SubGrupos Selecionados ===========================================
  sgGrupos:='';
  sgSubGrupos:='';
  If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then
  Begin

    DMVirtual.CDS_V_GruposProdutos.First;
    While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    Begin
      Refresh;

      If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
       Begin
         While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
         Begin
           Refresh;

           If sgSubGrupos='' Then
            sgSubGrupos:=QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString)
           Else
            sgSubGrupos:=sgSubGrupos+', '+
              QuotedStr(DMVirtual.CDS_V_SubGruposProdutosCod_GrupoSub.AsString);

           DMVirtual.CDS_V_SubGruposProdutos.Next;
         End; // While Not DMVirtual.CDS_V_SubGruposProdutos.Eof do
         DMVirtual.CDS_V_SubGruposProdutos.First;
       End // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then
      Else
       Begin
         If sgGrupos='' Then
          sgGrupos:='(p.codgruposub BetWeen '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'0000')+
                ' AND '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'9999')+')'
         Else
          sgGrupos:=sgGrupos+' Or (p.codgruposub BetWeen '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'0000')+
                ' AND '+
                QuotedStr(DMVirtual.CDS_V_GruposProdutosCod_Grupo.AsString+'9999')+')';
       End; // If Not DMVirtual.CDS_V_SubGruposProdutos.IsEmpty Then

      If sgSubGrupos<>'' Then
      Begin
        If sgGrupos='' Then
         sgGrupos:='(p.codgruposub in ('+sgSubGrupos+'))'
        Else
         sgGrupos:=sgGrupos+' OR (p.codgruposub in ('+sgSubGrupos+'))';
      End;

      sgSubGrupos:='';

      DMVirtual.CDS_V_GruposProdutos.Next;
    End; // While Not DMVirtual.CDS_V_GruposProdutos.Eof do
    DMVirtual.CDS_V_GruposProdutos.First;

    If sgGrupos<>'' Then
     sgGrupos:='('+sgGrupos+')';

  End; // If Not DMVirtual.CDS_V_GruposProdutos.IsEmpty Then

  // Curva ABC dos Produtos ----------------------------------
  sgCurvas:='';
  If Not Ckb_EstFisFinanCurvaTodas.Checked Then
  Begin
    If Ckb_EstFisFinanCurvaA.Checked Then
     sgCurvas:=QuotedStr('A');

    If Ckb_EstFisFinanCurvaB.Checked Then
    Begin
      If sgCurvas='' Then
       sgCurvas:=QuotedStr('B')
      Else
       sgCurvas:=sgCurvas+', '+QuotedStr('B');
    End;

    If Ckb_EstFisFinanCurvaC.Checked Then
    Begin
      If sgCurvas='' Then
       sgCurvas:=QuotedStr('C')
      Else
       sgCurvas:=sgCurvas+', '+QuotedStr('C');
    End;

    If Ckb_EstFisFinanCurvaD.Checked Then
    Begin
      If sgCurvas='' Then
       sgCurvas:=QuotedStr('D')
      Else
       sgCurvas:=sgCurvas+', '+QuotedStr('D');
    End;

    If Ckb_EstFisFinanCurvaE.Checked Then
    Begin
      If sgCurvas='' Then
       sgCurvas:=QuotedStr('E')
      Else
       sgCurvas:=sgCurvas+', '+QuotedStr('E');
    End;
  End; // If Not Ckb_EstFisFinanCurvaTodas.Checked Then

  // Seleciona Empresa =========================================================
  sgOutrasEmpresa:='';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;

  FrmSelectEmpProcessamento.ShowModal;
  sLojasProc:=FrmSelectEmpProcessamento.sEmpProc;
  iNrConexoes:=FrmSelectEmpProcessamento.iNrEmpProc;
  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Existe Empresa a Processar ====================================
  If DMBelShop.CDS_EmpProcessa.Eof Then
  Begin
    PC_EstoqueFisicoFinan.TabIndex:=0;
    EdtEstFisFinanCodListaPreco.SetFocus;
    Screen.Cursor:=crDefault;
    Exit;
  End;

  // Posiciona no Grid de Resultados da Empresa ================================
  PC_EstoqueFisicoFinan.TabIndex:=2;
  PC_EstoqueFisicoFinanChange(Self);
  Dbg_EstFisFinanGiroEstoque.SetFocus;

  // Monta Perodo de 12 Meses =================================================
  DecodeDate(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), wgAnoH, wgMesH, wgDiaH);
  sgDtaInicio:=DateToStr(EncodeDate(wgAnoH-1, wgMesH, 1));
  sgDtaFim:=DateToStr((EncodeDate(wgAnoH, wgMesH, 1)-1));

  // Cria DataSet's ============================================================
  If DMVirtual.CDS_V_GiroEstoque.Active Then
   DMVirtual.CDS_V_GiroEstoque.Close;

  DMVirtual.CDS_V_GiroEstoque.CreateDataSet;
  DMVirtual.CDS_V_GiroEstoque.Open;
  DMVirtual.CDS_V_GiroEstoque.Filtered:=False;
  DMVirtual.CDS_V_GiroEstoque.Filter:='';

  // Cria Cabecalho Empresa ====================================================
  Inc(iOrdem);
  DMVirtual.CDS_V_GiroEstoque.Append;
  DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:='GIRO DE ESTOQUE ';
  DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_GiroEstoque.Post;

  // Linha em Branco ------------------------------------------------
  Inc(iOrdem);
  DMVirtual.CDS_V_GiroEstoque.Append;
  DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:=' ';
  DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_GiroEstoque.Post;

  // Periodo ---------------------------------------------------------
  Inc(iOrdem);
  DMVirtual.CDS_V_GiroEstoque.Append;
  DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:='Periodo de: '+sgDtaInicio+' a '+sgDtaFim;
  DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_GiroEstoque.Post;

  // Linha em Branco ------------------------------------------------
  Inc(iOrdem);
  DMVirtual.CDS_V_GiroEstoque.Append;
  DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:=' ';
  DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_GiroEstoque.Post;

  // Cria Cabecalho Lojas ======================================================
  Inc(iOrdem);
  DMVirtual.CDS_V_GiroEstoque.Append;
  DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:='Loja(s): '+sLojasProc;
  DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_GiroEstoque.Post;

  // Linha em Branco ------------------------------------------------
  Inc(iOrdem);
  DMVirtual.CDS_V_GiroEstoque.Append;
  DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:=' ';
  DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_GiroEstoque.Post;

  // Busca Produtos da Empresa MPMS ============================================
  MySqlSelect:=' SELECT p.codproduto, p.apresentacao,'+
               ' p.principalfor,  f.nomefornecedor'+

               ' FROM PRODUTO p, FORNECED f';

               // Situacao dos Produtos -----------------------------
               If Cbx_EstFisFinanSituacaoProd.ItemIndex=0 Then
                MySqlSelect:=MySqlSelect+' Where Coalesce(p.situacaopro,0)=0';

               If Cbx_EstFisFinanSituacaoProd.ItemIndex=1 Then
                MySqlSelect:=MySqlSelect+' Where Coalesce(p.situacaopro,3)=3';

               If Cbx_EstFisFinanSituacaoProd.ItemIndex=2 Then
                MySqlSelect:=MySqlSelect+' Where Coalesce(p.situacaopro,0) in (0,3)';

               // Curva ABC dos Produtos ----------------------------------
               If Trim(sgCurvas)<>'' Then
                MySqlSelect:=MySqlSelect+' and p.classeabc in ('+sgCurvas+')';

               // Produtos Codigos e/ou Produtos Like ---------------------
               If (Trim(sgProdutos)<>'') And (Trim(sgLikeProdutos)<>'') Then
                MySqlSelect:=
                 MySqlSelect+' AND (p.CodProduto in ('+sgProdutos+') Or '+f_Troca('pr.','p.',sgLikeProdutos)+')'
               Else If Trim(sgProdutos)<>'' Then
                MySqlSelect:=
                 MySqlSelect+' AND p.CodProduto in ('+sgProdutos+')'
               Else If Trim(sgLikeProdutos)<>'' Then
                MySqlSelect:=
                 MySqlSelect+' AND '+f_Troca('pr.','p.',sgLikeProdutos);

               // Fornecedores -------------------------------------
               If Trim(sgFornecedores)<>'' Then
                MySqlSelect:=MySqlSelect+' and p.principalfor in ('+sgFornecedores+')';

               // Grupos e SubGrupos --------------------------------
               If Trim(sgGrupos)<>'' Then
                MySqlSelect:=MySqlSelect+' and '+sgGrupos;

               MySqlSelect:=MySqlSelect+' and p.principalfor=f.codfornecedor';
               MySqlOrderGrup:=' Order By p.apresentacao';
  IBQ_MPMS.Close;
  IBQ_MPMS.SQL.Clear;
  IBQ_MPMS.SQL.Add(MySqlSelect+MySqlOrderGrup);
  IBQ_MPMS.Open;

  If IBQ_MPMS.IsEmpty Then
  Begin
    Screen.Cursor:=crDefault;    
    IBQ_MPMS.Close;
    msg('SEM Produto a Calcular...','A');
    Exit;
  End;

  // Apresentacao ==============================================================
  OdirPanApres.Caption:='AGUARDE !! Localizando Produtos Empresa: MPMS';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Monta Planilha ============================================================
  bLoja:=True;
  While Not IBQ_MPMS.Eof do
  Begin
    Refresh;

    bDados:=True;
    DMBelShop.CDS_EmpProcessa.First;
    While Not DMBelShop.CDS_EmpProcessa.Eof do
    Begin
      Refresh;

      if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
      Begin
        // Produtos -------------------------------------------------
        Inc(iOrdem);
        DMVirtual.CDS_V_GiroEstoque.Append;

        DMVirtual.CDS_V_GiroEstoqueLOJA_PESQUISA.AsString:=
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
        DMVirtual.CDS_V_GiroEstoquePROD_PESQUISA.AsString:=
                                  IBQ_MPMS.FieldByName('CodProduto').AsString;

        If (iNrConexoes>1) Or ((iNrConexoes=1) and (bLoja)) Then
        Begin
          DMVirtual.CDS_V_GiroEstoqueCOD_LOJA.AsString:='Bel_'+
                                   DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
          bLoja:=False;
        End;

        If bDados Then
        Begin
         DMVirtual.CDS_V_GiroEstoqueCOD_PRODUTO.AsString:=
                                  IBQ_MPMS.FieldByName('CodProduto').AsString;
         DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:=
                                IBQ_MPMS.FieldByName('Apresentacao').AsString;
        End; // If b Then

        DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency:=0;
        DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency:=0;
        DMVirtual.CDS_V_GiroEstoqueMEDIA_ESTOQUE.AsCurrency:=0;
        DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency:=0;
        DMVirtual.CDS_V_GiroEstoqueGIRO_ESTOQUE.AsCurrency:=0;
        DMVirtual.CDS_V_GiroEstoqueTEMPO_MEDIO.AsCurrency:=0;

        If bDados Then
        Begin
          DMVirtual.CDS_V_GiroEstoqueCOD_FORNECEDOR.AsString:=
                                IBQ_MPMS.FieldByName('PrincipalFor').AsString;
          DMVirtual.CDS_V_GiroEstoqueDES_FORNECEDOR.AsString:=
                              IBQ_MPMS.FieldByName('NomeFornecedor').AsString;
        End; // If b Then

        DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
        DMVirtual.CDS_V_GiroEstoque.Post;

        bDados:=False;
      End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

      DMBelShop.CDS_EmpProcessa.Next;
    End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

    // Total da Empresa ---------------------------------------------
    If iNrConexoes > 1 Then
    Begin
      Inc(iOrdem);
      DMVirtual.CDS_V_GiroEstoque.Append;
      DMVirtual.CDS_V_GiroEstoqueCOD_LOJA.AsString:='Empresa';
      DMVirtual.CDS_V_GiroEstoqueCOD_PRODUTO.AsString:=
                                    IBQ_MPMS.FieldByName('CodProduto').AsString;
      DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:=
                                  IBQ_MPMS.FieldByName('Apresentacao').AsString;
      DMVirtual.CDS_V_GiroEstoqueCOD_FORNECEDOR.AsString:=
                                  IBQ_MPMS.FieldByName('PrincipalFor').AsString;
      DMVirtual.CDS_V_GiroEstoqueDES_FORNECEDOR.AsString:=
                                IBQ_MPMS.FieldByName('NomeFornecedor').AsString;
      DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency:=0;
      DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency:=0;
      DMVirtual.CDS_V_GiroEstoqueMEDIA_ESTOQUE.AsCurrency:=0;
      DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency:=0;
      DMVirtual.CDS_V_GiroEstoqueGIRO_ESTOQUE.AsCurrency:=0;
      DMVirtual.CDS_V_GiroEstoqueTEMPO_MEDIO.AsCurrency:=0;
      DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
      DMVirtual.CDS_V_GiroEstoque.Post;

      // Linha em Branco ------------------------------------------------
      Inc(iOrdem);
      DMVirtual.CDS_V_GiroEstoque.Append;
      DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:=' ';
      DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
      DMVirtual.CDS_V_GiroEstoque.Post;
    End; // If iNrConexoes > 1 Then

    IBQ_MPMS.Next
  End; // While Not IBQ_MPMS.Eof
  IBQ_MPMS.Close;

  // Linha em Branco ------------------------------------------------
  If iNrConexoes = 1 Then
  Begin
    Inc(iOrdem);
    DMVirtual.CDS_V_GiroEstoque.Append;
    DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:=' ';
    DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
    DMVirtual.CDS_V_GiroEstoque.Post;
  End; // If iNrConexoes > 1 Then

  // Total Geral da Empresa ====================================================
  Inc(iOrdem);
  DMVirtual.CDS_V_GiroEstoque.Append;
  DMVirtual.CDS_V_GiroEstoqueCOD_LOJA.AsString:='Empresa';
  DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString:='Total Geral';
  DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency:=0;
  DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency:=0;
  DMVirtual.CDS_V_GiroEstoqueMEDIA_ESTOQUE.AsCurrency:=0;
  DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency:=0;
  DMVirtual.CDS_V_GiroEstoqueGIRO_ESTOQUE.AsCurrency:=0;
  DMVirtual.CDS_V_GiroEstoqueTEMPO_MEDIO.AsCurrency:=0;
  DMVirtual.CDS_V_GiroEstoqueORDEM.AsInteger:=iOrdem;
  DMVirtual.CDS_V_GiroEstoque.Post;

  DMVirtual.CDS_V_GiroEstoque.First;

  // Busca Dados da Empresas para Giro de Estoque ==============================
  DadosEmpGiroEstoque;

  // Calcula Totais da Empresa =================================================
  cTotEstI:=0;
  cTotEstF:=0;
  cTotSaidas:=0;
  cTotEstIG:=0;
  cTotEstFG:=0;
  cTotSaidasG:=0;

  DMVirtual.CDS_V_GiroEstoque.First;
  While Not DMVirtual.CDS_V_GiroEstoque.Eof do
  Begin

    // Acumula Valores =========================================================
    If Trim(DMVirtual.CDS_V_GiroEstoquePROD_PESQUISA.AsString)<>'' Then
    Begin
      cTotEstI:=cTotEstI+DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency;
      cTotEstF:=cTotEstF+DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency;
      cTotSaidas:=cTotSaidas+DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency;

      cTotEstIG:=cTotEstIG+DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency;
      cTotEstFG:=cTotEstFG+DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency;
      cTotSaidasG:=cTotSaidasG+DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency;
    End; // If Trim(DMVirtual.CDS_V_GiroEstoqueCOD_FORNECEDOR.AsString)<>'' Then

    // Atualiza Total da Empresa ===============================================
    If (Trim(DMVirtual.CDS_V_GiroEstoqueCOD_LOJA.AsString)='Empresa') and
       (Trim(DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString)<>'Total Geral') Then
    Begin
      DMVirtual.CDS_V_GiroEstoque.Edit;
      DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency:=cTotEstI;
      DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency:=cTotEstF;

      c:=RoundTo((cTotEstI+cTotEstF)/2,-2);
      DMVirtual.CDS_V_GiroEstoqueMEDIA_ESTOQUE.AsCurrency:=c;

      DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency:=cTotSaidas;

      // Calcula Giro de Estoque ================================
      If c<>0 Then
       Begin
         c:=RoundTo((cTotSaidas/c),-2);
         DMVirtual.CDS_V_GiroEstoqueGIRO_ESTOQUE.AsCurrency:=c;
       End
      Else
       Begin
         c:=0;
       End;

      // Calcula Tempo Medio do Giro de Estoque =================
      If c<>0 Then
      Begin
        i:=DaysBetween(StrToDate(sgDtaInicio), StrToDate(sgDtaFim));
        DMVirtual.CDS_V_GiroEstoqueTEMPO_MEDIO.AsCurrency:=RoundTo((i/c),-2);
      End;

      DMVirtual.CDS_V_GiroEstoque.Post;
      cTotEstI:=0;
      cTotEstF:=0;
      cTotSaidas:=0;
    End; // If Trim(DMVirtual.CDS_V_GiroEstoqueCOD_FORNECEDOR.AsString)<>'' Then

    // Atualiza Total Geral da Empresa =========================================
    If (Trim(DMVirtual.CDS_V_GiroEstoqueCOD_LOJA.AsString)='Empresa') and
       (Trim(DMVirtual.CDS_V_GiroEstoqueDES_PRODUTO.AsString)='Total Geral') Then
    Begin
      DMVirtual.CDS_V_GiroEstoque.Edit;
      DMVirtual.CDS_V_GiroEstoqueQTD_EST_INICIAL.AsCurrency:=cTotEstIG;
      DMVirtual.CDS_V_GiroEstoqueQTD_EST_FINAL.AsCurrency:=cTotEstFG;

      c:=RoundTo((cTotEstIG+cTotEstFG)/2,-2);
      DMVirtual.CDS_V_GiroEstoqueMEDIA_ESTOQUE.AsCurrency:=c;

      DMVirtual.CDS_V_GiroEstoqueQTD_VENDAS.AsCurrency:=cTotSaidasG;
      
      // Calcula Giro de Estoque ================================
      If c<>0 Then
       Begin
         c:=RoundTo((cTotSaidasG/c),-2);
         DMVirtual.CDS_V_GiroEstoqueGIRO_ESTOQUE.AsCurrency:=c;
       End
      Else
       Begin
         c:=0;
       End;
                      
      // Calcula Tempo Medio do Giro de Estoque =================
      If c<>0 Then
      Begin
        i:=DaysBetween(StrToDate(sgDtaInicio), StrToDate(sgDtaFim));
        DMVirtual.CDS_V_GiroEstoqueTEMPO_MEDIO.AsCurrency:=RoundTo((i/c),-2);
      End;

      DMVirtual.CDS_V_GiroEstoque.Post;
    End; // If Trim(DMVirtual.CDS_V_GiroEstoqueCOD_FORNECEDOR.AsString)<>'' Then

    DMVirtual.CDS_V_GiroEstoque.Next;
  End;// While Not DMVirtual.CDS_V_GiroEstoque.Eof do

  Screen.Cursor:=crDefault;    
  OdirPanApres.Visible:=False;
  DMVirtual.CDS_V_GiroEstoque.First;

  msg('Processamento Efetuado com SUCESSO !!','A');

end;

procedure TFrmBelShop.Dbg_EstFisFinanGiroEstoqueDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
    if not (gdSelected in State) Then
    Begin
      If iNrConexoes>1 Then
      Begin
        if (DMVirtual.CDS_V_GiroEstoqueCOD_PRODUTO.AsString<>'') Then
        Begin
          Dbg_EstFisFinanGiroEstoque.Canvas.Brush.Color:=$00BBFFFF;
        End;

        if (DMVirtual.CDS_V_GiroEstoqueCOD_LOJA.AsString='Empresa') Then
        Begin
          Dbg_EstFisFinanGiroEstoque.Canvas.Font.Style:=[fsBold];
          Dbg_EstFisFinanGiroEstoque.Canvas.Brush.Color:=clSkyBlue;
        End;
      End; // If iNrConexoes>1 Then

      if (DMVirtual.CDS_V_GiroEstoqueDes_PRODUTO.AsString='Total Gereal') Then
      Begin
        Dbg_EstFisFinanGiroEstoque.Canvas.Font.Style:=[fsBold];
        Dbg_EstFisFinanGiroEstoque.Canvas.Brush.Color:=clSkyBlue;
      End;

      Dbg_EstFisFinanGiroEstoque.Canvas.FillRect(Rect);
      Dbg_EstFisFinanGiroEstoque.DefaultDrawDataCell(Rect,Column.Field,state);
    End; // if not (gdSelected in State) Then

end;                               

procedure TFrmBelShop.Bt_EstFisFinanGiroEstoqueSalvarClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_GiroEstoque.IsEmpty Then
  Begin
    Dbg_EstFisFinanGiroEstoque.SetFocus;
    SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_GiroEstoque,Dbg_EstFisFinanGiroEstoque,Mem_Salvar);
  End;

end;

procedure TFrmBelShop.Rb_EstFisFinanSaldoTodosClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_EstFisFinanSaldoTodos);
  AcertaRb_Style(Rb_EstFisFinanSaldoSem);
  AcertaRb_Style(Rb_EstFisFinanSaldoCom);

  If Rb_EstFisFinanSaldoTodos.Checked Then
  Begin
    DMVirtual.CDS_V_EstFisFinanEmp.Filtered:=False;
    DMVirtual.CDS_V_EstFisFinanEmp.Filter:='';
  End;

  If Rb_EstFisFinanSaldoCom.Checked Then
  Begin
    DMVirtual.CDS_V_EstFisFinanEmp.Filtered:=False;
    DMVirtual.CDS_V_EstFisFinanEmp.Filter:='QTD_ESTOQUE>0';
    DMVirtual.CDS_V_EstFisFinanEmp.Filtered:=True
  End;

  If Rb_EstFisFinanSaldoSem.Checked Then
  Begin
    DMVirtual.CDS_V_EstFisFinanEmp.Filtered:=False;
    DMVirtual.CDS_V_EstFisFinanEmp.Filter:='QTD_ESTOQUE=0';
    DMVirtual.CDS_V_EstFisFinanEmp.Filtered:=True
  End;
end;

procedure TFrmBelShop.Rb_EstFisFinanSqlSaldoTodosClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_EstFisFinanSqlSaldoTodos);
  AcertaRb_Style(Rb_EstFisFinanSqlSaldoSem);
  AcertaRb_Style(Rb_EstFisFinanSqlSaldoCom);
end;

procedure TFrmBelShop.Ckb_EstFisFinanGiroTransfClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_EstFisFinanGiroTransf);
end;

procedure TFrmBelShop.Ckb_EstFisFinanGiroTransfKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanGiroTransfClick(Self);
end;

procedure TFrmBelShop.Rb_EstFisFinanSqlSaldoTodosKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_EstFisFinanSqlSaldoTodosClick(Self);

end;

procedure TFrmBelShop.Dbg_CurvaABCMixProdDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    If (Column.FieldName='IND_CURVA_A') Then
    Begin
      if (DMVirtual.CDS_V_Mix_ProdIND_CURVA_A.AsString='SIM') Then
      Begin
        Dbg_CurvaABCMixProd.Canvas.Font.Style:=[fsBold];
        Dbg_CurvaABCMixProd.Canvas.Font.Color:=clBlue;
      End;
    End;

    If (Column.FieldName='IND_CURVA_B') Then
    Begin
      if (DMVirtual.CDS_V_Mix_ProdIND_CURVA_B.AsString='SIM') Then
      Begin
        Dbg_CurvaABCMixProd.Canvas.Font.Style:=[fsBold];
        Dbg_CurvaABCMixProd.Canvas.Font.Color:=clBlue;
      End;
    End;

    If (Column.FieldName='IND_CURVA_C') Then
    Begin
      if (DMVirtual.CDS_V_Mix_ProdIND_CURVA_C.AsString='SIM') Then
      Begin
        Dbg_CurvaABCMixProd.Canvas.Font.Style:=[fsBold];
        Dbg_CurvaABCMixProd.Canvas.Font.Color:=clBlue;
      End;
    End;
      
    If (Column.FieldName='IND_CURVA_D') Then
    Begin
      if (DMVirtual.CDS_V_Mix_ProdIND_CURVA_D.AsString='SIM') Then
      Begin
        Dbg_CurvaABCMixProd.Canvas.Font.Style:=[fsBold];
        Dbg_CurvaABCMixProd.Canvas.Font.Color:=clBlue;
      End;
    End;

    If (Column.FieldName='IND_CURVA_E') Then
    Begin
      if (DMVirtual.CDS_V_Mix_ProdIND_CURVA_E.AsString='SIM') Then
      Begin
        Dbg_CurvaABCMixProd.Canvas.Font.Style:=[fsBold];
        Dbg_CurvaABCMixProd.Canvas.Font.Color:=clBlue;
      End;          
    End;

    Dbg_CurvaABCMixProd.Canvas.FillRect(Rect);
    Dbg_CurvaABCMixProd.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then
end;

procedure TFrmBelShop.Dbg_CurvaABCMixProdKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  MySql, sCampo, sCurva: String;
begin
  sCampo:='';

  // Mix Curva A ===============================================================
  If Key=65 Then
  Begin
    sCampo:='IND_CURVA_A';
    sCurva:='SIM';
    If DMVirtual.CDS_V_Mix_ProdIND_CURVA_A.AsVariant='SIM' Then
     sCurva:='NAO';
  End; // If Key=65 Then

  // Mix Curva B ===============================================================
  If Key=66 Then
  Begin
    sCampo:='IND_CURVA_B';
    sCurva:='SIM';
    If DMVirtual.CDS_V_Mix_ProdIND_CURVA_B.AsVariant='SIM' Then
    sCurva:='NAO';
  End; // If Key=66 Then

  // Mix Curva C ===============================================================
  If Key=67 Then
  Begin
    sCampo:='IND_CURVA_C';
    sCurva:='SIM';
    If DMVirtual.CDS_V_Mix_ProdIND_CURVA_C.AsVariant='SIM' Then
    sCurva:='NAO';
  End; // If Key=67 Then

  // Mix Curva D ===============================================================
  If Key=68 Then
  Begin
    sCampo:='IND_CURVA_D';
    sCurva:='SIM';
    If DMVirtual.CDS_V_Mix_ProdIND_CURVA_D.AsVariant='SIM' Then
    sCurva:='NAO';
  End; // If Key=68 Then

  // Mix Curva E ===============================================================
  If Key=69 Then
  Begin
    sCampo:='IND_CURVA_E';
    sCurva:='SIM';
    If DMVirtual.CDS_V_Mix_ProdIND_CURVA_E.AsVariant='SIM' Then
    sCurva:='NAO';
  End; // If Key=69 Then

  // Grava no Banco de Dados ===================================================
  If sCampo<> '' Then
  Begin
    DMVirtual.CDS_V_Mix_Prod.Edit;
    DMVirtual.CDS_V_Mix_Prod.FieldByName(sCampo).AsString:=sCurva;
    DMVirtual.CDS_V_Mix_Prod.Post;

    MySql:=' UpDate EMP_MIX_PRODUTOS'+
           ' Set '+sCampo+'='+QuotedStr(sCurva)+
           ' Where COD_LOJA='+QuotedStr(DMVirtual.CDS_V_Mix_ProdCOD_LOJA.AsString);
    DMBelShop.SQLC.Execute(MySql, nil, nil);
  End; // If sCampo<> '' Then         
end;

procedure TFrmBelShop.SubMenuComprasMovtoComprovFornecedorClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Inicializa Tudo ===========================================================
  DtEdt_ConsultaNFeDtInicio.Date:=PrimeiroUltimoDia(Now,'P');
  DtEdt_ConsultaNFeDtFim.Date:=StrToDateTime(DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)));

  Rb_ConsultaNFeApresAnalitica.Checked:=True;
  Rb_ConsultaNFeApresAnaliticaClick(Self);

  Rb_ConsultaNFeTpMovtoAmbos.Checked:=True;
  Rb_ConsultaNFeTpMovtoAmbosClick(Self);

  Ckb_ConsultaNFeParticipacao.Checked:=False;

  DMVirtual.CDS_V_NFe.Close;
  Dbg_ConsultaNFeEmpresa.Align:=alNone;
  Dbg_ConsultaNFeLojas.Align:=alNone;
  Dbg_ConsultaNFeNotasLojas.Align:=alNone;

  Dbg_ConsultaNFeEmpresa.Visible:=False;
  Dbg_ConsultaNFeLojas.Visible:=False;
  Dbg_ConsultaNFeNotasLojas.Visible:=False;

  // Inicializa Tabelas Virtuais para Filtros ==================================
  If DMVirtual.CDS_V_Produtos.Active Then
   DMVirtual.CDS_V_Produtos.Close;
  DMVirtual.CDS_V_Produtos.CreateDataSet;
  DMVirtual.CDS_V_Produtos.Open;

  If DMVirtual.CDS_V_Comprovantes.Active Then
   DMVirtual.CDS_V_Comprovantes.Close;
  DMVirtual.CDS_V_Comprovantes.CreateDataSet;
  DMVirtual.CDS_V_Comprovantes.Open;

  If DMVirtual.CDS_V_Fornecedores.Active Then
   DMVirtual.CDS_V_Fornecedores.Close;
  DMVirtual.CDS_V_Fornecedores.CreateDataSet;
  DMVirtual.CDS_V_Fornecedores.Open;

  try
    DMVirtual.CDS_V_GruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  Except
    DMVirtual.CDS_V_GruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_SubGruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  Except
    DMVirtual.CDS_V_SubGruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_Aplicacao.CreateDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  Except
    DMVirtual.CDS_V_Aplicacao.EmptyDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  End;

  //============================================================================
  // PageControl de Filtros - INICIO ===========================================
  //============================================================================
  //-----------------------------------------------------------------
  // Filtro de Fornecedores -----------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFornecedor.Visible:=True;
  // Curva ABC no Fornecedor
  Painel_FiltroOC.Visible:=False;
  // Obs para Utilizao no Movto de Comprovantes
  Label_MovtoComprovForn.Visible:=True;
  Label_MovtoComprovForn.Top:=Painel_FiltroOC.Top;

  //-----------------------------------------------------------------
  // Filtro de Produtos ---------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroProdutos.TabVisible:=True;
  // Filtor nao Produtos de No Compra
  Painel_FiltroNaoCompra.Visible:=False;
  // Filtro para Busca Pelo Nome
  Gb_CalculoFiltroNome.Visible:=True;
  EdtCalculoFiltroNome1.Clear;
  EdtCalculoFiltroNome2.Clear;
  EdtCalculoFiltroNome3.Clear;
  EdtCalculoFiltroNome4.Clear;

  //-----------------------------------------------------------------
  // Filtro de Grupos e SubGrupos -----------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupos.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Aplicaes dos Produtos ------------------------------
  //-----------------------------------------------------------------
  TS_FiltroAplicacao.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Familia de Preos ------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFamiliaPreco.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Grupos ST --------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupoST.TabVisible:=False;

  //-----------------------------------------------------------------
  // Grupo de Comprovantes ------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroComprovantes.TabVisible:=True;

  //-----------------------------------------------------------------
  // Posiciona o PC_Filtros em seu Parent ---------------------------
  //-----------------------------------------------------------------
  PC_Filtros.Parent:=TS_ConsultaNFeFiltros;
  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);
  //============================================================================
  // PageControl de Filtros - FIM ==============================================
  //============================================================================

  // Apresenta TabSheet ========================================================
  PC_ConsultaMovtoCompr.ActivePage:=TS_ConsultaNFeFiltros;
  PC_ConsultaMovtoComprChange(Self);

  SelecionaTabSheet(Ts_MovtoComprovForn);
  CorSelecaoTabSheet(PC_Principal);

  DtEdt_ConsultaNFeDtInicio.SetFocus;

end;

procedure TFrmBelShop.Rb_CalculoTpCurvaABCLojaClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_CalculoTpCurvaABCLoja);
  AcertaRb_Style(Rb_CalculoTpCurvaABCMix);
  AcertaRb_Style(Rb_CalculoTpCurvaABCMpms);
  Gb_CalculoCurvaABC.Visible:=True;

  Gb_CalculoApresCurva.Visible:=True;
  If Ckb_CalculoCurvaTodas.Checked Then
   Gb_CalculoApresCurva.Visible:=False;

end;

procedure TFrmBelShop.Rb_CalculoTpCurvaABCMixClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_CalculoTpCurvaABCLoja);
  AcertaRb_Style(Rb_CalculoTpCurvaABCMix);
  AcertaRb_Style(Rb_CalculoTpCurvaABCMpms);
  Gb_CalculoCurvaABC.Visible:=False;
  Gb_CalculoApresCurva.Visible:=True;
end;

procedure TFrmBelShop.Ckb_CalculoApresCurvaForaClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_CalculoApresCurvaFora);

  Lb_CalculoApresCurva.Visible:=True;
  Rb_CalculoApresCurvaEstCom.Visible:=True;
  Rb_CalculoApresCurvaEstSem.Visible:=True;
  Rb_CalculoApresCurvaEstAmbos.Visible:=True;
  If Not Ckb_CalculoApresCurvaFora.Checked Then
  Begin
    Lb_CalculoApresCurva.Visible:=False;
    Rb_CalculoApresCurvaEstCom.Visible:=False;
    Rb_CalculoApresCurvaEstSem.Visible:=False;
    Rb_CalculoApresCurvaEstAmbos.Visible:=False;
  End;
end;

procedure TFrmBelShop.Dbg_GeraOCEditaGridDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If (Column.FieldName='QTD_SALDO') Or (Column.FieldName='IND_QTD_ACIMA')Then
  Begin
    If DMBelShop.IBQ_AComprarEditaIND_QTD_ACIMA.AsCurrency>0 Then
     Begin
       Dbg_GeraOCEditaGrid.Canvas.Font.Color:=clRed;
       Dbg_GeraOCEditaGrid.Canvas.Font.Style:=[fsBold];
     End
    Else
     Begin
       Dbg_GeraOCEditaGrid.Canvas.Font.Color:=clWindowText;
       Dbg_GeraOCEditaGrid.Canvas.Font.Style:=[];
     End; // If DMBelShop.IBQ_AComprarEditaIND_QTD_ACIMA.AsCurrency>0 Then
  End; // If (Column.FieldName='QTD_SALDO') Or (Column.FieldName='IND_QTD_ACIMA')Then

  If (Column.FieldName='QTD_ACOMPRAR') Then
  Begin
    If DMBelShop.IBQ_AComprarEditaQTD_ACOMPRAR.AsCurrency=0 Then
     Dbg_GeraOCEditaGrid.Canvas.Font.Style:=[]
    Else
     Dbg_GeraOCEditaGrid.Canvas.Font.Style:=[fsBold];
  End; // If (Column.FieldName='QTD_ACOMPRAR') Then

  If (Column.FieldName='VLR_UNI_COMPRA') Then
  Begin
    If DMBelShop.IBQ_AComprarEditaVLR_UNI_COMPRA.AsCurrency=0 Then
     Dbg_GeraOCEditaGrid.Canvas.Font.Style:=[]
    Else
     Dbg_GeraOCEditaGrid.Canvas.Font.Style:=[fsBold];
  End; // If (Column.FieldName='VLR_UNI_COMPRA') Then

  if not (gdSelected in State) Then
  Begin
    if DMBelShop.IBQ_AComprarEditaCOD_EMPRESA.AsString='99' Then
      Dbg_GeraOCEditaGrid.Canvas.Brush.Color:=$0080FFFF; //$00DDFFDD;

    If DMBelShop.IBQ_AComprarEditaIND_USAR.AsString='NAO'  Then
     Dbg_GeraOCEditaGrid.Canvas.Brush.Color:=$00C6FFC6;

    if DMBelShop.IBQ_AComprarEditaIND_OC_GERADA.AsString='S' Then
      Dbg_GeraOCEditaGrid.Canvas.Brush.Color:=clSkyBlue;

  End;   

  Dbg_GeraOCEditaGrid.Canvas.FillRect(Rect);
  Dbg_GeraOCEditaGrid.DefaultDrawDataCell(Rect,Column.Field,state);

end;

procedure TFrmBelShop.EdtFiltroCodComprovExit(Sender: TObject);
Var
  MySql: String;
begin

  If EdtFiltroCodComprov.Value<>0 Then
  Begin

    Screen.Cursor:=crAppStart;

    // Busca Comprovante =======================================================
    MySql:=' select c.codcomprovante Cod, c.nomecomprovante Descr,'+
           ' Case'+
           '   When c.compdesativado=''N'' then ''SIM'''+
           '   else'+
           '   ''NAO'''+
           ' End Ativo'+

           ' from comprv c'+
           ' Where c.codcomprovante='+VarToStr(EdtFiltroCodComprov.Value);
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_MPMS.FieldByName('Cod').AsString)='' Then
    Begin
       msg('Comprovante NO Encontrado !!!', 'A');
       IBQ_MPMS.Close;
       EdtFiltroCodComprov.Clear;
       EdtFiltroCodComprov.SetFocus;
       Exit;
    End;

    If DMVirtual.CDS_V_Comprovantes.Locate('COD_COMPROV',IBQ_MPMS.FieldByName('Cod').AsString,[]) Then
    Begin
      msg('Comprovante J Informado !!','A');
      IBQ_MPMS.Close;
      EdtFiltroCodComprov.Clear;
      EdtFiltroCodComprov.SetFocus;
      Exit;
    End;

    DMVirtual.CDS_V_Comprovantes.Insert;
    DMVirtual.CDS_V_ComprovantesCOD_COMPROV.AsString:=IBQ_MPMS.FieldByName('Cod').AsString;
    DMVirtual.CDS_V_ComprovantesDES_COMPROV.AsString:=IBQ_MPMS.FieldByName('Descr').AsString;
    DMVirtual.CDS_V_ComprovantesIND_ATIVO.AsString:=IBQ_MPMS.FieldByName('Ativo').AsString;
    DMVirtual.CDS_V_Comprovantes.Post;

    IBQ_MPMS.Close;
    EdtFiltroCodComprov.Text:='0';
    EdtFiltroCodComprov.SetFocus;
  End;
end;

procedure TFrmBelShop.Bt_FiltroBuscaComprovClick(Sender: TObject);
Var
  MySql: String;
begin
                           
  Dbg_FiltroComprov.SetFocus;

  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);

  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' select c.nomecomprovante Descricao, c.codcomprovante Codigo,'+
         ' Case'+
         '   When c.compdesativado=''N'' then ''SIM'''+
         '   else'+
         '   ''NAO'''+
         ' End Ativo'+

         ' from comprv c'+
         ' Order by 1';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('Codigo').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtFiltroCodComprov.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtFiltroCodComprov.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='Descricao';
  FrmPesquisaIB.Campo_Codigo:='Codigo';
  FrmPesquisaIB.Campo_Descricao:='Descricao';
  FrmPesquisaIB.Campo_Retorno1:='Ativo';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  Begin
    If DMVirtual.CDS_V_Comprovantes.Locate('Cod_Comprov',FrmPesquisaIB.EdtCodigo.Text,[]) Then
    Begin
      Begin
        msg('Comprovante J Informado !!','A');
        EdtFiltroCodComprov.Clear;
        FreeAndNil(FrmPesquisaIB);
        EdtFiltroCodComprov.SetFocus;
        Exit;
      End;
    End;

    DMVirtual.CDS_V_Comprovantes.Insert;
    DMVirtual.CDS_V_ComprovantesCOD_COMPROV.AsString:=FrmPesquisaIB.EdtCodigo.Text;
    DMVirtual.CDS_V_ComprovantesDES_COMPROV.AsString:=FrmPesquisaIB.EdtDescricao.Text;
    DMVirtual.CDS_V_ComprovantesIND_ATIVO.AsString:=FrmPesquisaIB.Retorno1;
    DMVirtual.CDS_V_Comprovantes.Post;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0')Then
  EdtFiltroCodComprov.SetFocus;
  
  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Dbg_FiltroComprovKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If Key=VK_Delete Then
  Begin
   If Not DMVirtual.CDS_V_Comprovantes.IsEmpty Then
     DMVirtual.CDS_V_Comprovantes.Delete;
  End; // If Key=VK_Delete Then

  Dbg_FiltroComprov.SetFocus;
end;

procedure TFrmBelShop.Rb_ConsultaNFeApresAnaliticaClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_ConsultaNFeApresAnalitica);
  AcertaRb_Style(Rb_ConsultaNFeApresSintetica);

  Bt_ConsultaNFeNotasClick(Self);
end;

procedure TFrmBelShop.Rb_ConsultaNFeTpMovtoAmbosClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_ConsultaNFeTpMovtoAmbos);
  AcertaRb_Style(Rb_ConsultaNFeTpMovtoEnt);
  AcertaRb_Style(Rb_ConsultaNFeTpMovtoSai);

end;

procedure TFrmBelShop.Ckb_ConsultaNFeParticipacaoClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_ConsultaNFeParticipacao);

end;

procedure TFrmBelShop.Ckb_ConsultaNFeParticipacaoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_ConsultaNFeParticipacaoClick(Self);
end;

procedure TFrmBelShop.SubMenuFinanFechamentoCaixaClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  EdtFinanFechaCaixaCodLoja.Clear;
  EdtFinanFechaCaixaDesLoja.Clear;
  DtEdtFinanFechaCaixaData.Clear;
  EdtFinanFechaCaixaCodDocto.Clear;
  EdtFinanFechaCaixaDesDocto.Clear;
  EdtFinanFechaCaixaVlrDocto.Clear;
  
  Pan_FinanFechaCaixa.Enabled:=False;

  Pan_FinanFechaCaixaSituacao.Caption:='';
  Pan_FinanFechaCaixaSituacao.Color:=clBtnFace;
  Pan_FinanFechaCaixaSituacao.Font.Color:=clWindowText;
  
  Bt_FinanFechaCaixaSituacao.Enabled:=False;
  Bt_FinanFechaCaixaSituacao.Caption:='';

  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.CDS_FechaCaixaTotais.Close;
  
  Ckb_FinanFechaCaixaSomar.Checked:=True;
  Ckb_FinanFechaCaixaSomar.Caption:='Somar Vlr Informado';
  Ckb_FinanFechaCaixaSomarClick(Self);

  Pan_CklbFinanFechaCaixa.Visible:=False;

  SelecionaTabSheet(Ts_FinanFechaCaixa);
  CorSelecaoTabSheet(PC_Principal);
  
  EdtFinanFechaCaixaCodLoja.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanFechaCaixaFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.EdtFinanFechaCaixaCodLojaChange(Sender: TObject);
begin
  EdtFinanFechaCaixaDesLoja.Clear;
  EdtFinanFechaCaixaCodDocto.Clear;
  EdtFinanFechaCaixaDesDocto.Clear;
  EdtFinanFechaCaixaVlrDocto.Clear;

  Pan_FinanFechaCaixa.Enabled:=False;

  Pan_FinanFechaCaixaSituacao.Caption:='';
  Pan_FinanFechaCaixaSituacao.Color:=clBtnFace;
  Pan_FinanFechaCaixaSituacao.Font.Color:=clWindowText;

  Bt_FinanFechaCaixaSituacao.Enabled:=False;
  Bt_FinanFechaCaixaSituacao.Caption:='';

  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.CDS_FechaCaixaTotais.Close;

end;

procedure TFrmBelShop.EdtFinanFechaCaixaCodLojaExit(Sender: TObject);
Var
  MySql: String;
begin

  EdtFinanFechaCaixaDesLoja.Clear;
  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.CDS_FechaCaixaTotais.Close;

  If EdtFinanFechaCaixaCodLoja.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Lojas =============================================================
    MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
           ' From EMP_CONEXOES'+
           ' Where Ind_Ativo=''SIM'''+
           ' And COD_FILIAL='+QuotedStr(FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger));
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('RAZAO_SOCIAL').AsString)='' Then
    Begin
      msg('Loja NO Encontrada !!!', 'A');
      Screen.Cursor:=crDefault;
      EdtFinanFechaCaixaCodLoja.Clear;
      EdtFinanFechaCaixaCodLoja.SetFocus;
      DMBelShop.CDS_BuscaRapida.Close;
      Exit;
    End;

    EdtFinanFechaCaixaDesLoja.Text:=DMBelShop.CDS_BuscaRapida.FieldByName('Razao_Social').AsString;
    DtEdtFinanFechaCaixaData.SetFocus;

    DMBelShop.CDS_BuscaRapida.Close;

    Screen.Cursor:=crDefault;
  End;
end;

procedure TFrmBelShop.Bt_FinanFechaCaixaBuscaLojaClick(Sender: TObject);
Var
  MySql: String;
begin

  FrmPesquisa:=TFrmPesquisa.Create(Self);

  EdtFinanFechaCaixaCodLoja.Clear;
  EdtFinanFechaCaixaDesLoja.Clear;

  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.CDS_FechaCaixaTotais.Close;

  EdtFinanFechaCaixaCodLoja.SetFocus;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
         ' From EMP_CONEXOES'+
         ' Where IND_ATIVO=''SIM'''+
         ' Order by RAZAO_SOCIAL';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('RAZAO_SOCIAL').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Sem Loja a Listar !!','A');
    EdtFinanFechaCaixaCodLoja.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Razao_Social';
  FrmPesquisa.Campo_Codigo:='Cod_Filial';
  FrmPesquisa.Campo_Descricao:='Razao_Social';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtFinanFechaCaixaCodLoja.Text:=FrmPesquisa.EdtCodigo.Text;
     EdtFinanFechaCaixaDesLoja.Text:=FrmPesquisa.EdtDescricao.Text;
     DtEdtFinanFechaCaixaData.SetFocus;
   End
  Else
   Begin
     EdtFinanFechaCaixaCodLoja.Clear;
     EdtFinanFechaCaixaDesLoja.Clear;
     EdtFinanFechaCaixaCodLoja.SetFocus;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.DtEdtFinanFechaCaixaDataExit(Sender: TObject);
Var
  sDta: String;
  MySql: String;
  bFechado: Boolean;
begin
  If Trim(DtEdtFinanFechaCaixaData.Text)='' Then
  Begin
    EdtFinanFechaCaixaCodLoja.Clear;
    EdtFinanFechaCaixaDesLoja.Clear;
    EdtFinanFechaCaixaCodLoja.SetFocus;
    Exit;
  End;

  If DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)<DtEdtFinanFechaCaixaData.Date Then
  Begin
    msg('Data Invlida !!'+cr+cr+'Maior que Hoje !!','A');
    DtEdtFinanFechaCaixaData.SetFocus;
    Exit;
  End;

  // Busca Doctos da Loja ======================================================
  sDta:=f_Troca('/','.',DtEdtFinanFechaCaixaData.Text);
  sDta:=f_Troca('-','.',sDta);

  sCodFilial:=FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger);

  // Verifica Fechamento do Caixa ==============================================
  MySql:=' select c.ind_fechado'+
         ' from fin_fechamento_caixa c'+
         ' where c.cod_credito=9999'+
         ' and c.cod_loja='+QuotedStr(sCodFilial)+
         ' and c.dta_caixa='+QuotedStr(sDta);
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  If DMBelShop.CDS_BuscaRapida.FieldByName('Ind_Fechado').AsString='SIM' Then
   bFechado:=True
  Else
   bFechado:=False;
  DMBelShop.CDS_BuscaRapida.Close;

  FechaCaixaDiaHabilita(bFechado);

  // Busca Dados da Loja =======================================================
  If Not bFechado Then
  Begin
    If msg('Deseja Buscar Movimento do'+cr+cr+'CAIXA no SIDICOM ???','C')=1 Then
    Begin
      If Not FechaCaixaBuscaMovtoCaixaDia(EdtFinanFechaCaixaCodLoja.Text, EdtFinanFechaCaixaDesLoja.Text, 'C') Then
      Begin
        EdtFinanFechaCaixaDesLoja.SetFocus;
        Exit;
      End;
    End;
  End; // If Not bFechado Then

  // Apresenta Movimentos ======================================================
  MySql:=' SELECT CX.cod_credito, CX.des_credito, CX.num_docto,'+
         ' CX.vlr_credito, CX.vlr_informado, CX.vlr_diferenca,'+
         ' CASE'+
         '   when cx.ind_informado=''SIM'' and cx.vlr_diferenca>0 and cx.cod_credito<>9998 Then'+
         '     ''Valor Informado MENOR que Valor de Crdito'''+
         '   when CX.ind_informado=''SIM'' and cx.vlr_diferenca<0 and cx.cod_credito<>9998 Then'+
         '     ''Valor Informado MAIOR que Valor de Crdito'''+
         '   when CX.ind_informado=''SIM'' and cx.cod_credito<>9998 Then'+
         '     ''Valores Informados e de Crditos FECHADOS'''+
         '   When cx.cod_credito<>9998 Then'+
         '     ''Valor NO Informado'''+
         '   when cx.vlr_diferenca>0 and cx.cod_credito=9998 Then'+
         '     ''Valor Informado MENOR que Valor de Crdito'''+
         '   when cx.vlr_diferenca<0 and cx.cod_credito=9998 Then'+
         '     ''Valor Informado MAIOR que Valor de Crdito'''+
         '   when cx.cod_credito=9998 Then'+
         '     ''Valores Informados e de Crditos FECHADOS'''+
         ' END obs,'+
         ' cx.IND_INFORMADO, cx.USU_INCLUI'+

         ' FROM fin_fechamento_caixa cx'+
         ' Where cx.cod_credito<9999'+
         ' and cx.Cod_Loja ='+FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger)+
         ' and cx.dta_caixa='+QuotedStr(sDta)+

         ' Order by cx.ind_informado desc, cx.vlr_informado desc, cx.cod_credito';
  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.SDS_FechaCaixa.CommandText:=MySql;
  DMBelShop.CDS_FechaCaixa.Open;

  MySql:=' SELECT CX.cod_credito, CX.des_credito, CX.num_docto,'+
         ' cx.vlr_credito, CX.vlr_informado, CX.vlr_diferenca,'+
         ' CASE'+
         '   when cx.vlr_diferenca>0 Then'+
         '     ''Vlr Dbito MENOR que Vlr Crdito'''+
         '   when cx.vlr_diferenca<0 Then'+
         '     ''Vlr Dbito MAIOR que Vlr Crdito'''+
         ' ELSE'+
         '     ''Vlr Dbitos e Crditos FECHADOS'''+
         ' END obs,'+
         ' cx.IND_INFORMADO, cx.USU_INCLUI'+

         ' FROM fin_fechamento_caixa cx'+
         ' Where cx.cod_credito=9999'+
         ' and cx.Cod_Loja ='+FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger)+
         ' and cx.dta_caixa='+QuotedStr(sDta)+

         ' Order by cx.IND_INFORMADO desc, cx.DES_CREDITO';
  DMBelShop.CDS_FechaCaixaTotais.Close;
  DMBelShop.SDS_FechaCaixaTotais.CommandText:=MySql;
  DMBelShop.CDS_FechaCaixaTotais.Open;

  If DMBelShop.CDS_FechaCaixa.IsEmpty Then
  Begin
    msg('Caixa Sem Movimento !!','A');
    Exit;
  End;

  Dbg_FinanFechaCaixaTotal.SetFocus;
  Dbg_FinanFechaCaixaDoctos.SetFocus;

end;

procedure TFrmBelShop.DtEdtFinanFechaCaixaDataKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If Key=VK_F9 Then
   Bt_FinanFechaCaixaBuscaLojaClick(Self);

end;

procedure TFrmBelShop.DtEdtFinanFechaCaixaDataEnter(Sender: TObject);
begin
  If Trim(EdtFinanFechaCaixaDesLoja.Text)='' Then
  Begin
    msg('Favor Informar a Loja !!','A');
    EdtFinanFechaCaixaCodLoja.SetFocus;
    Exit;
  End;

end;

procedure TFrmBelShop.EdtFinanFechaCaixaCodDoctoExit(Sender: TObject);
Var
  sDta: String;
  MySql: String;
begin

  EdtFinanFechaCaixaDesDocto.Clear;

  If EdtFinanFechaCaixaCodDocto.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Docto de Credito ===================================================
    sDta:=f_Troca('/','.',DtEdtFinanFechaCaixaData.Text);
    sDta:=f_Troca('-','.',sDta);
    MySql:=' select cx.des_credito, cx.cod_credito'+
           ' from fin_fechamento_caixa cx'+
           ' where cx.cod_loja='+QuotedStr(FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger))+
           ' and cx.dta_caixa='+QuotedStr(sDta)+
           ' and cx.cod_credito='+VarToStr(EdtFinanFechaCaixaCodDocto.Value);
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('cod_credito').AsString)='' Then
    Begin
      msg('Documento de Crdito NO Encontrado !!!', 'A');
      Screen.Cursor:=crDefault;
      EdtFinanFechaCaixaCodDocto.Clear;
      EdtFinanFechaCaixaCodDocto.SetFocus;
      DMBelShop.CDS_BuscaRapida.Close;
      Exit;
    End;

    EdtFinanFechaCaixaDesDocto.Text:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Credito').AsString;

    If Not DMBelShop.CDS_FechaCaixa.Locate('Cod_Credito', EdtFinanFechaCaixaCodDocto.AsInteger,[]) Then
    Begin
      msg('Docto de Crdito NO Encontrado !!','A');
      EdtFinanFechaCaixaCodDocto.SetFocus;
      Exit;
    End;

    EdtFinanFechaCaixaVlrDocto.Value:=DMBelShop.CDS_FechaCaixaVLR_INFORMADO.AsCurrency;
    Ckb_FinanFechaCaixaSomar.SetFocus;

    DMBelShop.CDS_BuscaRapida.Close;

    Screen.Cursor:=crDefault;
  End; // If EdtFinanFechaCaixaCodDocto.Value<>0 Then
end;

procedure TFrmBelShop.Bt_FinanFechaCaixaBuscaDoctoClick(Sender: TObject);
Var
  sDta: String;
  MySql: String;
begin
   
  FrmPesquisa:=TFrmPesquisa.Create(Self);

  EdtFinanFechaCaixaCodDocto.Clear;
  EdtFinanFechaCaixaDesDocto.Clear;
                      
  EdtFinanFechaCaixaCodDocto.SetFocus;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  // Busca Docto de Credito ===================================================
  sDta:=f_Troca('/','.',DtEdtFinanFechaCaixaData.Text);
  sDta:=f_Troca('-','.',sDta);
  MySql:=' select cx.des_credito, cx.cod_credito'+
         ' from fin_fechamento_caixa cx'+
         ' where cx.cod_loja='+QuotedStr(FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger))+
         ' and cx.dta_caixa='+QuotedStr(sDta)+
         ' And cx.cod_credito<9990';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('cod_credito').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Sem Doco de Crdito a Listar !!','A');
    EdtFinanFechaCaixaCodDocto.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Des_Credito';
  FrmPesquisa.Campo_Codigo:='Cod_Credito';
  FrmPesquisa.Campo_Descricao:='Des_Credito';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtFinanFechaCaixaCodDocto.Text:=FrmPesquisa.EdtCodigo.Text;
     EdtFinanFechaCaixaDesDocto.Text:=FrmPesquisa.EdtDescricao.Text;
     EdtFinanFechaCaixaCodDoctoExit(Self);
   End
  Else
   Begin
     EdtFinanFechaCaixaCodDocto.Clear;
     EdtFinanFechaCaixaDesDocto.Clear;
     EdtFinanFechaCaixaCodDocto.SetFocus;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.Dbg_FinanFechaCaixaDoctosDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    if DMBelShop.CDS_FechaCaixaIND_INFORMADO.AsString='NAO' then
     Dbg_FinanFechaCaixaDoctos.Canvas.Brush.Color:=clYellow;

    if DMBelShop.CDS_FechaCaixaCOD_CREDITO.AsString='9998' then
     Dbg_FinanFechaCaixaDoctos.Canvas.Brush.Color:=clSkyBlue;
  End;

  If (Column.FieldName='VLR_DIFERENCA') Then
  Begin
    if DMBelShop.CDS_FechaCaixaVLR_DIFERENCA.AsCurrency<>0 then
     Dbg_FinanFechaCaixaDoctos.Canvas.Brush.Color:=clRed;
  End;

  Dbg_FinanFechaCaixaDoctos.Canvas.FillRect(Rect);
  Dbg_FinanFechaCaixaDoctos.DefaultDrawDataCell(Rect,Column.Field,state);

end;

procedure TFrmBelShop.EdtFinanFechaCaixaVlrDoctoExit(Sender: TObject);
begin
  // Atualiza Caixa do Dia =====================================================
  If Trim(EdtFinanFechaCaixaDesDocto.Text)<>'' Then
   FechaCaixaAtualizaCaixaDia;

  EdtFinanFechaCaixaCodDocto.Clear;
  EdtFinanFechaCaixaDesDocto.Clear;
  EdtFinanFechaCaixaVlrDocto.Clear;
  EdtFinanFechaCaixaCodDocto.SetFocus;
end;

procedure TFrmBelShop.EdtFinanFechaCaixaCodDoctoChange(Sender: TObject);
begin
  If EdtFinanFechaCaixaCodDocto.Value>9989 Then
  Begin
    msg('Cdigo Invlido !!','A');
    EdtFinanFechaCaixaCodDocto.Clear;
    EdtFinanFechaCaixaCodDocto.SetFocus;
    Exit;
  End; 
end;

procedure TFrmBelShop.Dbg_FinanFechaCaixaDoctosDblClick(Sender: TObject);
begin
  If (Not DMBelShop.CDS_FechaCaixa.IsEmpty) And (Dbg_FinanFechaCaixaDoctos.ReadOnly) Then
  Begin
    EdtFinanFechaCaixaCodDocto.Text:=DMBelShop.CDS_FechaCaixaCOD_CREDITO.AsString;
    EdtFinanFechaCaixaCodDoctoExit(Self);
  End;
end;

procedure TFrmBelShop.Dbg_FinanFechaCaixaTotalDrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If (Column.FieldName='VLR_DIFERENCA') Then
  Begin
    if DMBelShop.CDS_FechaCaixaVLR_DIFERENCA.AsCurrency<>0 then
     Dbg_FinanFechaCaixaTotal.Canvas.Brush.Color:=clRed;
  End;

  Dbg_FinanFechaCaixaTotal.Canvas.FillRect(Rect);
  Dbg_FinanFechaCaixaTotal.DefaultDrawDataCell(Rect,Column.Field,state);

end;

procedure TFrmBelShop.DtEdtFinanFechaCaixaDataPropertiesChange(Sender: TObject);
begin
  EdtFinanFechaCaixaCodDocto.Clear;
  EdtFinanFechaCaixaDesDocto.Clear;
  EdtFinanFechaCaixaVlrDocto.Clear;
  
  Pan_FinanFechaCaixa.Enabled:=False;

  Pan_FinanFechaCaixaSituacao.Caption:='';
  Pan_FinanFechaCaixaSituacao.Color:=clBtnFace;
  Pan_FinanFechaCaixaSituacao.Font.Color:=clWindowText;
  
  Bt_FinanFechaCaixaSituacao.Enabled:=False;
  Bt_FinanFechaCaixaSituacao.Caption:='';

  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.CDS_FechaCaixaTotais.Close;

end;

procedure TFrmBelShop.SubMenuFinanFechamentoDiarioLojasClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin); 

  // Permisses de Visualizao ================================================
  PermissaoVisual(Ts_FinanFechaDiario);

  SelecionaTabSheet(Ts_FinanFechaDiario);
  CorSelecaoTabSheet(PC_Principal);

  PC_FinanFechaDiario.ActivePage:=Ts_FinanFechaDiarioLancto;
  
  FechaDiarioComponentes('');
  FechaDiarioHabilita(False);
  EdtFinanFechaDiarioVlrRealizado.Enabled:=False;
  Ckb_FinanFechaDiarioRealizadoClick(Self);

  EdtFinanFechaDiarioCodLoja.Clear;
  EdtFinanFechaDiarioDesLoja.Clear;
  DtEdtFinanFechaDiarioData.Clear;
  
  EdtFinanFechaDiarioCodLoja.SetFocus;

end;

procedure TFrmBelShop.PC_FinanFechaDiarioChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_FinanFechaDiario);

  If (PC_FinanFechaDiario.ActivePage=Ts_FinanFechaDiarioLancto) And (Ts_FinanFechaDiarioLancto.CanFocus) Then
  Begin
    Pan_FinanFechaDiarioSolic.Visible:=True;
    EdtFinanFechaDiarioCodLoja.SetFocus;
  End;

end;

procedure TFrmBelShop.Bt_FinanFechaDiarioFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.EdtFinanFechaDiarioCodLojaExit(Sender: TObject);
Var
  MySql: String;
begin
  
  EdtFinanFechaDiarioDesLoja.Clear;
  DMBelShop.CDS_FechaDiarioMov.Close;
     
  If EdtFinanFechaDiarioCodLoja.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Lojas =============================================================
    MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
           ' From EMP_CONEXOES'+
           ' Where Ind_Ativo=''SIM'''+
           ' And COD_FILIAL='+QuotedStr(FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger));
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;

    If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('RAZAO_SOCIAL').AsString)='' Then
    Begin
      msg('Loja NO Encontrada !!!', 'A');
      Screen.Cursor:=crDefault;
      EdtFinanFechaDiarioCodLoja.Clear;
      EdtFinanFechaDiarioCodLoja.SetFocus;
      DMBelShop.CDS_BuscaRapida.Close;
      Exit;
    End;
    
    EdtFinanFechaDiarioDesLoja.Text:=DMBelShop.CDS_BuscaRapida.FieldByName('Razao_Social').AsString;
    DtEdtFinanFechaDiarioData.SetFocus;

    DMBelShop.CDS_BuscaRapida.Close;

   Screen.Cursor:=crDefault;
  End;
end;

procedure TFrmBelShop.EdtFinanFechaDiarioCodLojaChange(Sender: TObject);
begin
  DMBelShop.CDS_FechaDiarioMov.Close;
  DMBelShop.CDS_FechaDiarioTot.Close;

  EdtFinanFechaDiarioDesLoja.Clear;
  DtEdtFinanFechaDiarioData.Clear;

  FechaDiarioHabilita(False);

end;

procedure TFrmBelShop.Bt_FinanFechaDiarioBuscaLojaClick(Sender: TObject);
Var
  MySql: String;
begin
   
  FrmPesquisa:=TFrmPesquisa.Create(Self);
  
  EdtFinanFechaDiarioCodLoja.Clear;
  EdtFinanFechaDiarioDesLoja.Clear;
                      
  DMBelShop.CDS_FechaDiarioMov.Close;

  EdtFinanFechaDiarioCodLoja.SetFocus;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:=' Select COD_FILIAL, RAZAO_SOCIAL'+
         ' From EMP_CONEXOES'+
         ' Where IND_ATIVO=''SIM'''+
         ' Order by RAZAO_SOCIAL';
  DMBelShop.CDS_Pesquisa.Close;
  DMBelShop.CDS_Pesquisa.Filtered:=False;
  DMBelShop.SDS_Pesquisa.CommandText:=MySql;
  DMBelShop.CDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(DMBelShop.CDS_Pesquisa.FieldByName('RAZAO_SOCIAL').AsString)='' Then
  Begin
    DMBelShop.CDS_Pesquisa.Close;
    msg('Sem Loja a Listar !!','A');
    EdtFinanFechaDiarioCodLoja.SetFocus;
    FreeAndNil(FrmPesquisa);
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisa.Campo_pesquisa:='Razao_Social';
  FrmPesquisa.Campo_Codigo:='Cod_Filial';
  FrmPesquisa.Campo_Descricao:='Razao_Social';
  //FrmPesquisa.EdtDescricao.Text:=FrmAcessos.EdtDescPessoa.Text;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisa.ShowModal;
  DMBelShop.CDS_Pesquisa.Close;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then
   Begin
     EdtFinanFechaDiarioCodLoja.Text:=FrmPesquisa.EdtCodigo.Text;
     EdtFinanFechaDiarioDesLoja.Text:=FrmPesquisa.EdtDescricao.Text;
     DtEdtFinanFechaDiarioData.SetFocus;
   End
  Else
   Begin
     EdtFinanFechaDiarioCodLoja.Clear;
     EdtFinanFechaDiarioDesLoja.Clear;
     EdtFinanFechaDiarioCodLoja.SetFocus;
   End; // If (Trim(FrmPesquisa.EdtCodigo.Text)<>'') and (Trim(FrmPesquisa.EdtDescricao.Text)<>'') Then

  FreeAndNil(FrmPesquisa);
end;

procedure TFrmBelShop.DtEdtFinanFechaDiarioDataPropertiesChange(Sender: TObject);
begin
  
  DMBelShop.CDS_FechaDiarioMov.Close;
  DMBelShop.CDS_FechaDiarioTot.Close;

  FechaDiarioHabilita(False);

end;

procedure TFrmBelShop.DtEdtFinanFechaDiarioDataPropertiesCloseUp(Sender: TObject);
begin
//  EdtFinanFechadiCaixaCodDocto.SetFocus;

end;

procedure TFrmBelShop.DtEdtFinanFechaDiarioDataEnter(Sender: TObject);
begin
  If Trim(EdtFinanFechaDiarioDesLoja.Text)='' Then
  Begin
    msg('Favor Informar a Loja !!','A');
    EdtFinanFechaDiarioCodLoja.SetFocus;
    Exit;
  End;

end;

procedure TFrmBelShop.DtEdtFinanFechaDiarioDataExit(Sender: TObject);
Var
  sDta: String;
begin
  If Trim(DtEdtFinanFechaDiarioData.Text)='' Then
  Begin
    EdtFinanFechaDiarioCodLoja.Clear;
    EdtFinanFechaDiarioDesLoja.Clear;
    EdtFinanFechaDiarioCodLoja.SetFocus;
    Exit;
  End;

  If DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)<DtEdtFinanFechaDiarioData.Date Then
  Begin
    msg('Data Invlida !!'+cr+cr+'Maior que Hoje !!','A');
    DtEdtFinanFechaDiarioData.SetFocus;
    Exit;
  End;

  // Busca Dados da Loja =======================================================
  sCodFilial:=FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger);
  If msg('Deseja Buscar Plano de Contas do'+cr+cr+'SIDICOM ???','C')=1 Then
  Begin
    If Not FechaCaixaBuscaMovtoCaixaDia(EdtFinanFechaDiarioCodLoja.Text, EdtFinanFechaDiarioDesLoja.Text, 'D') Then
    Begin
      EdtFinanFechaDiarioDesLoja.SetFocus;
      Exit;
    End;
  End; // If msg('Deseja Buscar Plano de Contas do'+cr+cr+'SIDICOM ???','C')=1 Then

  // Acerta Data ===============================================================
  sDta:=f_Troca('/','.',DtEdtFinanFechaDiarioData.Text);
  sDta:=f_Troca('-','.',sDta);


  // Atualiza Movtos ===========================================================
  FechaDiarioTotais(sDta);
  
  // Apresenta Movtos ==========================================================
  DMBelShop.CDS_FechaDiarioMov.Close;
  DMBelShop.SDS_FechaDiarioMov.Params.ParamByName('CodLoja').AsString:=FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger);
  DMBelShop.SDS_FechaDiarioMov.Params.ParamByName('Dia').AsString:=sDta;
  DMBelShop.CDS_FechaDiarioMov.Open;

  DMBelShop.CDS_FechaDiarioTot.Close;
  DMBelShop.SDS_FechaDiarioTot.Params.ParamByName('CodLoja').AsString:=FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger);
  DMBelShop.SDS_FechaDiarioTot.Params.ParamByName('Dia').AsString:=sDta;
  DMBelShop.CDS_FechaDiarioTot.Open;

  // Habilita
  FechaDiarioHabilita(True);

  Dbg_FinanFechaDiarioMovtos.SetFocus;

end;

procedure TFrmBelShop.DtEdtFinanFechaDiarioDataKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  If Key=VK_F9 Then
   Bt_FinanFechaDiarioBuscaLojaClick(Self);

end;

procedure TFrmBelShop.Dbg_FinanFechaDiarioTotaisDrawColumnCell(Sender: TObject;
  const Rect: TRect; DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    if DMBelShop.CDS_FechaDiarioTotTIP_DOCTO.AsInteger=90 then
     Dbg_FinanFechaDiarioTotais.Canvas.Brush.Color:=clYellow;

    if DMBelShop.CDS_FechaDiarioTotTIP_DOCTO.AsInteger=99 then
     Dbg_FinanFechaDiarioTotais.Canvas.Brush.Color:=clSkyBlue;
  End;

  If (Column.FieldName='VLR_DOCTO') Then
  Begin
    if (DMBelShop.CDS_FechaDiarioTotTIP_DOCTO.AsInteger=99) and (DMBelShop.CDS_FechaDiarioTotVLR_DOCTO.AsCurrency<>0) then
    Begin
      Dbg_FinanFechaDiarioTotais.Canvas.Brush.Color:=clRed;
      Dbg_FinanFechaDiarioTotais.Canvas.Font.Color:=clWhite;
    End;
  End;

  Dbg_FinanFechaDiarioTotais.Canvas.FillRect(Rect);
  Dbg_FinanFechaDiarioTotais.DefaultDrawDataCell(Rect,Column.Field,state);

end;

procedure TFrmBelShop.Bt_FinanFechaDiarioPagtoClick(Sender: TObject);
begin
  Gb_FinanFechaDiarioDML.Caption:=' Inserir Pagamentos ';
  Gb_FinanFechaDiarioTipoMovto.Caption:=' Inserir ';
  Lb_FinanFechaDiarioTipoMovto.Caption:='Pagamentos';
  Lb_FinanFechaDiarioTipoMovto.Tag:=1;

  FechaDiarioComponentes(Lb_FinanFechaDiarioTipoMovto.Caption);
end;

procedure TFrmBelShop.Bt_FinanFechaDiarioDepositoClick(Sender: TObject);
begin

  If DMBelShop.CDS_FechaDiarioMov.Locate('TIP_DOCTO', 2,[]) Then
  Begin
    Bt_FinanFechaDiarioAlterarClick(Self);
    Exit;
  End;

  Gb_FinanFechaDiarioDML.Caption:=' Inserir Depsito ';
  Gb_FinanFechaDiarioTipoMovto.Caption:=' Inserir ';
  Lb_FinanFechaDiarioTipoMovto.Caption:='Depsito';
  Lb_FinanFechaDiarioTipoMovto.Tag:=2;

  FechaDiarioComponentes(Lb_FinanFechaDiarioTipoMovto.Caption);

end;

procedure TFrmBelShop.Bt_FinanFechaDiarioVlrRecebidoClick(Sender: TObject);
begin
  If DMBelShop.CDS_FechaDiarioMov.Locate('TIP_DOCTO', 3,[]) Then
  Begin
    Bt_FinanFechaDiarioAlterarClick(Self);
    Exit;
  End;

  Gb_FinanFechaDiarioDML.Caption:=' Inserir Vlr Recebido ';
  Gb_FinanFechaDiarioTipoMovto.Caption:=' Inserir ';
  Lb_FinanFechaDiarioTipoMovto.Caption:='Vlr Recebido';
  Lb_FinanFechaDiarioTipoMovto.Tag:=3;

  FechaDiarioComponentes(Lb_FinanFechaDiarioTipoMovto.Caption);
  
end;

procedure TFrmBelShop.BT_FinanFechaDiarioConfirmarClick(Sender: TObject);
Var
  sDta: String;
begin

  sgNumSeq:='0';
  
  // Se Poder Salvar ===========================================================
  If (Ckb_FinanFechaDiarioRealizado.Checked) and (EdtFinanFechaDiarioVlrRealizado.Value=0) Then
  Begin
    msg('Favor Informar o Valor Realizado !!','A');
    EdtFinanFechaDiarioVlrRealizado.SetFocus;
    Exit;
  End;
  
  If (Lb_FinanFechaDiarioTipoMovto.Caption='Depsito') Or (Lb_FinanFechaDiarioTipoMovto.Caption='Pagamentos') Then
  Begin
    If EdtFinanFechaDiarioNumDocto.AsInteger=0 Then
    Begin
      msg('Favor Informar o Nmero do Docto !!','A');
      EdtFinanFechaDiarioNumDocto.SetFocus;
      Exit;
    End;

    If Trim(EdtFinanFechaDiarioDesDocto.Text)='' Then
    Begin
      msg('Favor Informar a Descrio do Documento !!','A');
      EdtFinanFechaDiarioDesDocto.SetFocus;
      Exit;
    End;
  End;

  If (Lb_FinanFechaDiarioTipoMovto.Caption='Pagamentos') and (Trim(DtEdtFinanFechaDiarioDtaVenc.Text)='') Then
  Begin
    msg('Favor Informar a Data do Vencimento !!','A');
    DtEdtFinanFechaDiarioDtaVenc.SetFocus;
    Exit;
  End; // If Lb_FinanFechaDiarioTipoMovto.Caption='Pagamentos' Then
  
  // Inserir ===================================================================
  If Gb_FinanFechaDiarioTipoMovto.Caption=' Inserir ' Then
  Begin
    If Not FechaDiarioExecutaDML(Lb_FinanFechaDiarioTipoMovto.Caption, 'I') Then
    Begin
      msg('ERRO na INCLUSO do '+Lb_FinanFechaDiarioTipoMovto.Caption+' !!','A');
      Exit;
    End; // If Not FechaDiarioExecutaDML(Lb_FinanFechaDiarioTipoMovto.Caption, 'I') Then
  End; // If Gb_FinanFechaDiarioTipoMovto.Caption=' Inserir ' Then

  // Alterar ===================================================================
  If Gb_FinanFechaDiarioTipoMovto.Caption=' Alterar ' Then
  Begin
    sgNumSeq:=DMBelShop.CDS_FechaDiarioMovNUM_SEQ.AsString;
    
    If Not FechaDiarioExecutaDML(Lb_FinanFechaDiarioTipoMovto.Caption, 'A') Then
    Begin
      msg('ERRO na ALTERAO do '+Lb_FinanFechaDiarioTipoMovto.Caption+' !!','A');
      Exit;
    End; // If Not FechaDiarioExecutaDML(Lb_FinanFechaDiarioTipoMovto.Caption, 'I') Then
  End; // If Gb_FinanFechaDiarioTipoMovto.Caption=' Inserir ' Then

  // Acerta Data ===============================================================
  sDta:=f_Troca('/','.',DtEdtFinanFechaDiarioData.Text);
  sDta:=f_Troca('-','.',sDta);

  // Atualiza Movtos ===========================================================
  FechaDiarioTotais(sDta);
  
  // Apresenta Movtos ==========================================================
  DMBelShop.CDS_FechaDiarioMov.Close;
  DMBelShop.SDS_FechaDiarioMov.Params.ParamByName('CodLoja').AsString:=FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger);
  DMBelShop.SDS_FechaDiarioMov.Params.ParamByName('Dia').AsString:=sDta;
  DMBelShop.CDS_FechaDiarioMov.Open;

  DMBelShop.CDS_FechaDiarioTot.Close;
  DMBelShop.SDS_FechaDiarioTot.Params.ParamByName('CodLoja').AsString:=FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger);
  DMBelShop.SDS_FechaDiarioTot.Params.ParamByName('Dia').AsString:=sDta;
  DMBelShop.CDS_FechaDiarioTot.Open;

  DMBelShop.CDS_FechaDiarioMov.Locate('Num_Seq', sgNumSeq,[]);

  FechaDiarioComponentes('');

  Dbg_FinanFechaDiarioMovtos.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanFechaDiarioAbandonarClick(Sender: TObject);
begin
  FechaDiarioComponentes('');

end;

procedure TFrmBelShop.Bt_FinanFechaDiarioExcluirClick(Sender: TObject);
Var
 sDta: String;
 MySql: String;
begin
  If DMBelShop.CDS_FechaDiarioMov.IsEmpty Then
   Exit;

  If msg('Deseja Realmente EXCLUIR'+cr+cr+'o Movto Selecionado ??','C')=2 Then
   Exit;

   // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart; 
    DateSeparator:='.';
    DecimalSeparator:='.';

    MySql:=' Delete From FIN_FECHAMENTO_DIARIO'+
           ' Where Num_Seq='+DMBelShop.CDS_FechaDiarioMovNUM_SEQ.AsString;
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      exit;
    End; // on e : Exception do
  End; // Try 

  // Acerta Data ===============================================================
  sDta:=f_Troca('/','.',DtEdtFinanFechaDiarioData.Text);
  sDta:=f_Troca('-','.',sDta);

  // Atualiza Movtos ===========================================================
  FechaDiarioTotais(sDta);
  
  // Apresenta Movtos ==========================================================
  DMBelShop.CDS_FechaDiarioMov.Close;
  DMBelShop.SDS_FechaDiarioMov.Params.ParamByName('CodLoja').AsString:=FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger);
  DMBelShop.SDS_FechaDiarioMov.Params.ParamByName('Dia').AsString:=sDta;
  DMBelShop.CDS_FechaDiarioMov.Open;

  DMBelShop.CDS_FechaDiarioTot.Close;
  DMBelShop.SDS_FechaDiarioTot.Params.ParamByName('CodLoja').AsString:=FormatFloat('00',EdtFinanFechaDiarioCodLoja.AsInteger);
  DMBelShop.SDS_FechaDiarioTot.Params.ParamByName('Dia').AsString:=sDta;
  DMBelShop.CDS_FechaDiarioTot.Open;

  Dbg_FinanFechaDiarioMovtos.SetFocus;

  FechaDiarioComponentes('');
 
end;

procedure TFrmBelShop.Bt_FinanFechaDiarioAlterarClick(Sender: TObject);
begin
  If DMBelShop.CDS_FechaDiarioMov.IsEmpty Then
   Exit;

  // Pagamento 
  If DMBelShop.CDS_FechaDiarioMovTIP_DOCTO.AsInteger=1 Then
  Begin
    Gb_FinanFechaDiarioDML.Caption:=' Alterar Pagamentos ';
    Gb_FinanFechaDiarioTipoMovto.Caption:=' Alterar ';
    Lb_FinanFechaDiarioTipoMovto.Caption:='Pagamentos';
    Lb_FinanFechaDiarioTipoMovto.Tag:=1;

    FechaDiarioComponentes(Lb_FinanFechaDiarioTipoMovto.Caption);

    EdtFinanFechaDiarioNumDocto.Text     :=DMBelShop.CDS_FechaDiarioMovNUM_DOCTO.AsString;
    EdtFinanFechaDiarioDesDocto.Text     :=DMBelShop.CDS_FechaDiarioMovDES_DOCTO.AsString;
    EdtFinanFechaDiarioNumNota.AsInteger:=DMBelShop.CDS_FechaDiarioMovNUM_NOTA.AsInteger;
    DtEdtFinanFechaDiarioDtaVenc.Date    :=DMBelShop.CDS_FechaDiarioMovDTA_VENCIMENTO.AsDateTime;
    EdtFinanFechaDiarioVlrDocto.Value    :=DMBelShop.CDS_FechaDiarioMovVLR_DOCTO.AsCurrency;

    Ckb_FinanFechaDiarioRealizado.Checked:=DMBelShop.CDS_FechaDiarioMovIND_REALIZADO.AsString='SIM';
    Ckb_FinanFechaDiarioRealizadoClick(Self);

    EdtFinanFechaDiarioVlrRealizado.Value:=DMBelShop.CDS_FechaDiarioMovVLR_REALIZADO.AsCurrency;

    EdtFinanFechaDiarioNumDocto.SetFocus;
  End; // If DMBelShop.CDS_FechaDiarioMovTIP_DOCTO=1 Then

  // Depsito
  If DMBelShop.CDS_FechaDiarioMovTIP_DOCTO.AsInteger=2 Then
  Begin
    Gb_FinanFechaDiarioDML.Caption:=' Alterar Depsito ';
    Gb_FinanFechaDiarioTipoMovto.Caption:=' Alterar ';
    Lb_FinanFechaDiarioTipoMovto.Caption:='Depsito';
    Lb_FinanFechaDiarioTipoMovto.Tag:=2;

    FechaDiarioComponentes(Lb_FinanFechaDiarioTipoMovto.Caption);

    EdtFinanFechaDiarioNumDocto.Text     :=DMBelShop.CDS_FechaDiarioMovNUM_DOCTO.AsString;
    EdtFinanFechaDiarioDesDocto.Text     :=DMBelShop.CDS_FechaDiarioMovDES_DOCTO.AsString;

    Ckb_FinanFechaDiarioRealizado.Checked:=DMBelShop.CDS_FechaDiarioMovIND_REALIZADO.AsString='SIM';
    Ckb_FinanFechaDiarioRealizadoClick(Self);

    EdtFinanFechaDiarioVlrRealizado.Value:=DMBelShop.CDS_FechaDiarioMovVLR_REALIZADO.AsCurrency;

    EdtFinanFechaDiarioNumDocto.SetFocus;
  End; // If DMBelShop.CDS_FechaDiarioMovTIP_DOCTO=2 Then

  // Valor Recebido
  If DMBelShop.CDS_FechaDiarioMovTIP_DOCTO.AsInteger=3 Then
  Begin
    Gb_FinanFechaDiarioDML.Caption:=' Alterar Vlr Recebido ';
    Gb_FinanFechaDiarioTipoMovto.Caption:=' Alterar ';
    Lb_FinanFechaDiarioTipoMovto.Caption:='Vlr Recebido';
    Lb_FinanFechaDiarioTipoMovto.Tag:=3;

    FechaDiarioComponentes(Lb_FinanFechaDiarioTipoMovto.Caption);

    EdtFinanFechaDiarioVlrRealizado.Value:=DMBelShop.CDS_FechaDiarioMovVLR_REALIZADO.AsCurrency;

    Ckb_FinanFechaDiarioRealizado.Checked:=DMBelShop.CDS_FechaDiarioMovIND_REALIZADO.AsString='SIM';
    Ckb_FinanFechaDiarioRealizadoClick(Self);
  End; // If DMBelShop.CDS_FechaDiarioMovTIP_DOCTO=3 Then
end;

procedure TFrmBelShop.Ckb_FinanFechaDiarioRealizadoClick(Sender: TObject);
begin
  AcertaCkb_SN(Ckb_FinanFechaDiarioRealizado);

  If Ckb_FinanFechaDiarioRealizado.Checked Then
   Begin
     EdtFinanFechaDiarioVlrRealizado.Enabled:=True;
   End
  Else
   Begin
     EdtFinanFechaDiarioVlrRealizado.Enabled:=False;
     EdtFinanFechaDiarioVlrRealizado.Clear;
   End;

  If EdtFinanFechaDiarioVlrRealizado.Enabled Then
   EdtFinanFechaDiarioVlrRealizado.SetFocus

end;

procedure TFrmBelShop.SBt_SairClick(Sender: TObject);
begin
  SubMenuEmpConexoesSairClick(Self);

end;

procedure TFrmBelShop.Ckb_FinanFechaDiarioRealizadoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanFechaDiarioRealizadoClick(Self);
end;

procedure TFrmBelShop.Gb_FinanFechaDiarioManutExit(Sender: TObject);
begin
  If BT_FinanFechaDiarioConfirmar.Enabled Then
   BT_FinanFechaDiarioConfirmar.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanFechaCaixaVerificaClick(Sender: TObject);
begin

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  If EdtFinanFechaCaixaCodLoja.AsInteger=0 Then
  Begin
    msg('Informe a Loja a Verificar'+cr+cr+'os Movtos de Caixa','A');
    EdtFinanFechaCaixaCodLoja.SetFocus;
    Exit;
  End;

  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  FrmSolicitacoes.Caption:='FECHAMENTO DE CAIXA DIA';
  FrmSolicitacoes.sgCodLoja:=FormatFloat('00',EdtFinanFechaCaixaCodLoja.AsInteger);
  FrmSolicitacoes.sgTpFechaCaixa:='D';
  AbreSolicitacoes(5);

  FrmSolicitacoes.ShowModal;
  FreeAndNil(FrmSolicitacoes);
end;

procedure TFrmBelShop.Ckb_FinanFechaCaixaSomarClick(Sender: TObject);
begin
  If Ckb_FinanFechaCaixaSomar.Checked Then
   Ckb_FinanFechaCaixaSomar.Caption:='Somar Vlr Informado'
  Else
   Ckb_FinanFechaCaixaSomar.Caption:='No Somar Vlr Informado';
end;

procedure TFrmBelShop.Bt_FinanFechaCaixaSituacaoClick(Sender: TObject);
Var
  MySql: String;
  sDta, s: String;
begin

  // Verifica Fechamento do Caixa ==============================================
  If Bt_FinanFechaCaixaSituacao.Caption='Fechar Caixa' Then
   Begin
     s:='NAO';
     DMBelShop.CDS_FechaCaixa.First;
     While Not DMBelShop.CDS_FechaCaixa.Eof do
     Begin
       If DMBelShop.CDS_FechaCaixaIND_INFORMADO.AsString='SIM' Then
       Begin
         s:='SIM';
         Break;
       End;
       DMBelShop.CDS_FechaCaixa.Next;
     End;
     DMBelShop.CDS_FechaCaixa.First;

     If s='NAO' Then
     Begin
       msg('Impossvel Fechar Caixa do Dia'+cr+cr+'SEM Lanamento Informado !!','A');
       Exit;
     End;

     s:='SIM'
   End
  Else
   Begin
     s:='NAO';
   End;

  EdtFinanFechaCaixaCodDocto.Clear;
  EdtFinanFechaCaixaDesDocto.Clear;
  EdtFinanFechaCaixaVlrDocto.Clear;

  sDta:=f_Troca('/','.',DtEdtFinanFechaCaixaData.Text);
  sDta:=f_Troca('-','.',sDta);

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    MySql:=' Update fin_fechamento_caixa c'+
           ' Set c.ind_fechado='+QuotedStr(s)+
           ' where c.cod_loja='+QuotedStr(sCodFilial)+
           ' and c.dta_caixa='+QuotedStr(sDta);
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      exit;
    End; // on e : Exception do
  End; // Try

  FechaCaixaDiaHabilita(s='SIM');

end;

procedure TFrmBelShop.Bt_FinanFechaCaixaAnaliseClick(Sender: TObject);
Var
  i: Integer;
  MySql: String;
begin
  If Bt_FinanFechaCaixaAnalise.Caption='Fechar Analise Lojas' Then
  Begin
    Pan_FinanFechaCaixa.Enabled:=False;
    Pan_CklbFinanFechaCaixa.Visible:=False;
    Bt_FinanFechaCaixaAnalise.Caption:='Abrir Analise Lojas';
    Pan_FinanFechaCaixaSolic.Visible:=True;
    Bt_FinanFechaCaixaVerifica.Enabled:=True;
    Gb_FinanFechaCaixaDocto.Visible:=True;

//    Dbg_FinanFechaCaixaDoctos.Enabled:=False;
    Dbg_FinanFechaCaixaDoctos.ReadOnly:=True;

    DMBelShop.CDS_FechaCaixa.Close;
    DMBelShop.CDS_FechaCaixaTotais.Close;

    Bt_FinanFechaCaixaFechar.Enabled:=True;

    EdtFinanFechaCaixaCodLoja.SetFocus;
    
    Exit;
  End;

  // Limpa =====================================================================
  EdtFinanFechaCaixaCodLoja.Clear;
  EdtFinanFechaCaixaDesLoja.Clear;
  DtEdtFinanFechaCaixaData.Clear;
  EdtFinanFechaCaixaCodDocto.Clear;
  EdtFinanFechaCaixaDesDocto.Clear;
  EdtFinanFechaCaixaVlrDocto.Clear;
  
  Pan_FinanFechaCaixa.Enabled:=False;

  Pan_FinanFechaCaixaSituacao.Caption:='';
  Pan_FinanFechaCaixaSituacao.Color:=clBtnFace;
  Pan_FinanFechaCaixaSituacao.Font.Color:=clWindowText;
  
  Bt_FinanFechaCaixaSituacao.Enabled:=False;
  Bt_FinanFechaCaixaSituacao.Caption:='';

  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.CDS_FechaCaixaTotais.Close;
  
  Ckb_FinanFechaCaixaSomar.Checked:=True;
  Ckb_FinanFechaCaixaSomar.Caption:='Somar Vlr Informado';
  Ckb_FinanFechaCaixaSomarClick(Self);

  // Apresenta Lojas ===========================================================
//  // Inclui Outras Empresas
//  sgOutrasEmpresa:='(50,99)'; ou '(50)';
  sgOutrasEmpresa:='';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;
  FrmSelectEmpProcessamento.ShowModal;

  // Verifica se Existe Empresa a Processar ====================================
  If FrmSelectEmpProcessamento.iNrEmpProc=0 Then
  Begin
    FreeAndNil(FrmSelectEmpProcessamento);
    Exit;
  End; // If FrmSelectEmpProcessamento.iNrEmpProc=1 Then
  FreeAndNil(FrmSelectEmpProcessamento);

  // Solicita o Perodo ========================================================
  bgSiga:=False;
  FrmPeriodoApropriacao:=TFrmPeriodoApropriacao.Create(Self);
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Date:=PrimeiroUltimoDia(
                          DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor),'P');
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Text   :=
                    DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmPeriodoApropriacao.ShowModal;

  If not bgSiga Then
   Exit;
   
  sgDtaInicio:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Date);
  sgDtaFim:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Date);
  sgDtaInicio:=f_Troca('/','.',sgDtaInicio);
  sgDtaInicio:=f_Troca('-','.',sgDtaInicio);
  sgDtaFim:=f_Troca('/','.',sgDtaFim);
  sgDtaFim:=f_Troca('-','.',sgDtaFim);

  FreeAndNil(FrmPeriodoApropriacao);

  Cklb_FinanFechaCaixa.Items.Clear;
  Cklb_FinanFechaCaixa.Items.Add('Analise de Caixa');
  Cklb_FinanFechaCaixa.Items.Add('de '+f_Troca('.','/',sgDtaInicio));
  Cklb_FinanFechaCaixa.Items.Add(' a  '+f_Troca('.','/',sgDtaFim));

  // Verifica se Processa Todas as Empresas ====================================
  sgCodLojas:='';
  bgTodasEmpresas:=True;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       // Atualiza sEmpresa para Sql ---------------------------------
       If sgCodLojas='' Then
        Begin
          sgCodLojas:=QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);
          Cklb_FinanFechaCaixa.Items.Add('Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);
        End
       Else
        Begin
          sgCodLojas:=sgCodLojas+', '+QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);
          Cklb_FinanFechaCaixa.Items.Add('Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);
        End;
     End
    Else // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       bgTodasEmpresas:=False;
     End; // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; //   While Not DMBelShop.CDS_EmpProcessa.Eof do

  If bgTodasEmpresas Then
  Begin
    Cklb_FinanFechaCaixa.Items.Clear;
    Cklb_FinanFechaCaixa.Items.Add('Analise de Caixa');
    Cklb_FinanFechaCaixa.Items.Add('de '+f_Troca('.','/',sgDtaInicio));
    Cklb_FinanFechaCaixa.Items.Add(' a  '+f_Troca('.','/',sgDtaFim));
    Cklb_FinanFechaCaixa.Items.Add('TODAS AS LOJAS');
  End; // If bgTodasEmpresas Then

  // Verifica se Prossegue Processamento =======================================
  If bgSiga Then
  Begin
    // Apresenta lojas Processadas ----------------------------------
    For i:=0 to Cklb_FinanFechaCaixa.Items.Count-1 do
    Begin
      If i<3 Then
       Cklb_FinanFechaCaixa.Checked[i]:=False
      Else
       Cklb_FinanFechaCaixa.Checked[i]:=True;
    End;
    Pan_CklbFinanFechaCaixa.Height:=45;
    Pan_CklbFinanFechaCaixa.Visible:=True;

    Pan_FinanFechaCaixaSolic.Visible:=False;
    Bt_FinanFechaCaixaAnalise.Caption:='Fechar Analise Lojas';
    Bt_FinanFechaCaixaVerifica.Enabled:=False;
//    Dbg_FinanFechaCaixaDoctos.Enabled:=True;

    // Apresenta Movtos e Total -------------------------------------
    MySql:=' SELECT'+
           ' Case'+
           '   When cx.cod_credito<>9998 Then 0'+
           '   Else'+
           '   cx.cod_credito'+
           ' End cod_credito,'+
           ' Case'+
           '   When cx.cod_credito<>9998 Then'+
           '      substring(CX.des_credito from 4 for 40)'+
           '   Else'+
           '    ''Totais Fechamento de Caxia do Perodo'''+
           ' End des_credito,'+
           ' ''000000'' num_docto,'+
           ' Sum(CX.vlr_credito) vlr_credito,'+
           ' Sum(cx.vlr_informado) vlr_informado,'+
           ' Sum(CX.vlr_diferenca) vlr_diferenca,'+
           '''                                          '' obs,'+
           ' cx.IND_INFORMADO, 0 USU_INCLUI'+

           ' FROM fin_fechamento_caixa cx'+
           ' Where cx.cod_credito<9999'+
           ' and (cx.ind_informado=''SIM'' or (cx.ind_informado=''NAO'' and cx.cod_credito=9998))'+
           ' and cx.ind_fechado=''SIM'''+
           ' and cx.Cod_Loja in ('+sgCodLojas+')'+
           ' and cx.dta_caixa Between '+QuotedStr(sgDtaInicio)+' and '+QuotedStr(sgDtaFim)+

           ' group By 1, 2, 3, 7, 8'+
           ' Order by Cod_credito';
    DMBelShop.CDS_FechaCaixa.Close;
    DMBelShop.SDS_FechaCaixa.CommandText:=MySql;
    DMBelShop.CDS_FechaCaixa.Open;

    If DMBelShop.CDS_FechaCaixa.IsEmpty Then
    Begin
      msg('No Existe Caixa FECHADO no Perodo Solicitado !!','A');
      Exit;
    End;
   
    MySql:=' SELECT CX.cod_credito,'+
           ' ''Dbitos/Crditos do Perodo                '' des_credito, CX.num_docto,'+
           ' SUM(cx.vlr_credito) vlr_credito,'+
           ' SUM(CX.vlr_informado) vlr_informado,'+
           ' SUM(CX.vlr_diferenca) vlr_diferenca,'+
           ' CASE'+
           '   WHEN SUM(cx.vlr_diferenca)>0 THEN'+
           '        ''Vlr Dbito MENOR que Vlr Crdito'''+
           '   WHEN SUM(cx.vlr_diferenca)<0 THEN'+
           '        ''Vlr Dbito MAIOR que Vlr Crdito'''+
           '   ELSE'+
           '        ''Vlr Dbitos e Crditos FECHADOS'''+
           ' END obs,'+
           ' cx.IND_INFORMADO, 0 USU_INCLUI'+

           ' FROM fin_fechamento_caixa cx'+
           ' WHERE cx.cod_credito=9999'+
           ' AND cx.Cod_Loja in ('+sgCodLojas+')'+
           ' AND Cx.dta_caixa Between '+QuotedStr(sgDtaInicio)+' and '+QuotedStr(sgDtaFim)+
           ' AND cx.ind_fechado=''SIM'''+
           ' GROUP BY 1, 2, 3, 8, 9';
    DMBelShop.CDS_FechaCaixaTotais.Close;
    DMBelShop.SDS_FechaCaixaTotais.CommandText:=MySql;
    DMBelShop.CDS_FechaCaixaTotais.Open;

    Bt_FinanFechaCaixaFechar.Enabled:=False;
    Gb_FinanFechaCaixaDocto.Visible:=False;
    Pan_FinanFechaCaixa.Enabled:=True;
//    Dbg_FinanFechaCaixaDoctos.Enabled:=True;
    Dbg_FinanFechaCaixaDoctos.ReadOnly:=True;
  End; // If bgSiga Then

end;

procedure TFrmBelShop.EdtCurvaABCEndCodListaExit(Sender: TObject);
Var
  MySql: String;
begin
     
  EdtCurvaABCEndDesLista.Clear;
  If EdtCurvaABCEndCodLista.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    // Busca Fornecedores =======================================================
    MySql:='select lp.nomelista, lp.codlista'+
           ' from lista lp'+
           ' where lp.desativada=''N'''+
           ' and lp.CodLista='+QuotedStr(FormatFloat('0000',EdtCurvaABCEndCodLista.AsInteger));
    IBQ_Matriz.Close;
    IBQ_Matriz.SQL.Clear;
    IBQ_Matriz.SQL.Add(MySql);
    IBQ_Matriz.Open;

    Screen.Cursor:=crDefault;

    If Trim(IBQ_Matriz.FieldByName('codlista').AsString)='' Then
    Begin
     msg('Lista de Preo NO Encontrada !!!', 'A');
     EdtCurvaABCEndCodLista.Clear;
     EdtCurvaABCEndCodLista.SetFocus;
     Exit;
    End;

    EdtCurvaABCEndDesLista.Text:=IBQ_Matriz.FieldByName('NomeLista').AsString;
  End;
end;

procedure TFrmBelShop.Bt_CurvaABCEndBuscaListaClick(Sender: TObject);
Var
  MySql: String;
begin

  EdtCurvaABCEndDesLista.Clear;
  
  // ========== EFETUA A CONEXO ===============================================
  FrmPesquisaIB:=TFrmPesquisaIB.Create(Self);
  FrmPesquisaIB.IBCDS_Pesquisa.DBConnection:=IBQ_Matriz.Database;
  FrmPesquisaIB.IBCDS_Pesquisa.DBTransaction:=IBQ_Matriz.Transaction;

  // ========== EXECUTA QUERY PARA PESQUISA ====================================
  Screen.Cursor:=crAppStart;

  MySql:='select lp.nomelista, lp.codlista'+
         ' from lista lp'+
         ' where lp.desativada=''N'''+
         ' order by lp.nomelista';
  FrmPesquisaIB.IBCDS_Pesquisa.Close;
  FrmPesquisaIB.IBCDS_Pesquisa.CommandText:=MySql;
  FrmPesquisaIB.IBCDS_Pesquisa.Open;

  Screen.Cursor:=crDefault;

  // ============== Verifica Existencia de Dados ===============================
  If Trim(FrmPesquisaIB.IBCDS_Pesquisa.FieldByName('codlista').AsString)='' Then
  Begin
    msg('Sem Registro a Listar !!','A');
    EdtCurvaABCEndCodLista.Clear;
    FreeAndNil(FrmPesquisaIB);
    EdtCurvaABCEndCodLista.SetFocus;
    Exit;
  End;

  // ============= INFORMA O CAMPOS PARA PESQUISA E RETORNO ====================
  FrmPesquisaIB.Campo_pesquisa:='NomeLista';
  FrmPesquisaIB.Campo_Codigo:='CodLista';
  FrmPesquisaIB.Campo_Descricao:='NomeLista';
  FrmPesquisaIB.EdtDescricao.Clear;

  // ============= ABRE FORM DE PESQUISA =======================================
  FrmPesquisaIB.ShowModal;

  // ============= RETORNO =====================================================
  If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0') Then
  Begin
    EdtCurvaABCEndDesLista.Text:=FrmPesquisaIB.EdtDescricao.Text;
    EdtCurvaABCEndCodLista.Text:=FrmPesquisaIB.EdtCodigo.Text;
  End; // If (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'') and (Trim(FrmPesquisaIB.EdtCodigo.Text)<>'0') Then

  FreeAndNil(FrmPesquisaIB);
end;

procedure TFrmBelShop.Dbg_CurvaABCEndCurvaABCDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if DMVirtual.CDS_V_CurvaABCEnderecoQTD_ESTOQUE.AsCurrency<>0 Then
  Begin
    If (Column.FieldName='QTD_ESTOQUE')     Or(Column.FieldName='VLR_MARGEM')       Or
       (Column.FieldName='VLR_PC_CUSTO')    Or (Column.FieldName='VLR_PC_VENDA')    Or
       (Column.FieldName='VLR_TOTAL_CUSTO') Or (Column.FieldName='VLR_TOTAL_VENDA') Or
       (Column.FieldName='PER_MARGEM')      Or (Column.FieldName='EST_IDEAL')       Or
       (Column.FieldName='EST_MAXIMO')      Or (Column.FieldName='VLR_CUSTO_MEDIO') Or
       (Column.FieldName='VLR_TOTAL_CUSTO_MEDIO') Then
     Dbg_CurvaABCEndCurvaABC.Canvas.Font.Style:=[fsBold];

    Dbg_CurvaABCEndCurvaABC.Canvas.FillRect(Rect);
    Dbg_CurvaABCEndCurvaABC.DefaultDrawDataCell(Rect,Column.Field,state);

    DMVirtual.CDS_V_CurvaABCEnderecoCOD_PRODUTO.Alignment:=taRightJustify;
    DMVirtual.CDS_V_CurvaABCEnderecoDTA_INCLUSAO.Alignment:=taCenter;
    DMVirtual.CDS_V_CurvaABCEnderecoIND_SITUACAO.Alignment:=taCenter;

  End; // If (Column.FieldName='QTD_ESTOQUE') Then
end;

procedure TFrmBelShop.Bt_OCsLojasClick(Sender: TObject);
begin

  Lb_EmpAprocessar.Caption:='0';
  Lb_EmpProcessadas.Caption:='0';

  Ckb_CalculoCurvaTodas.Checked:=True;
  Ckb_CalculoCurvaTodasClick(Sender);

  Rb_CalculoTpCurvaABCMpms.Checked:=True;
  Rb_CalculoTpCurvaABCLojaClick(Sender);

  Ckb_FiltroProdNaoCompra.Checked:=False;
  Ckb_FiltroProdNaoCompraClick(Sender);

  // Seleciona Lojas ===========================================================
  // Inclui Outras Empresas
  // sgOutrasEmpresa:='(99)';
  sgOutrasEmpresa:='';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;

  FrmSelectEmpProcessamento.ShowModal;

  // Verifica se Existe Empresa a Processar ====================================
  If FrmSelectEmpProcessamento.iNrEmpProc=0 Then
  Begin
    FreeAndNil(FrmSelectEmpProcessamento);
    Exit;
  End; // If FrmSelectEmpProcessamento.iNrEmpProc=1 Then
  Lb_EmpAprocessar.Caption:=IntToStr(FrmSelectEmpProcessamento.iNrEmpProc);

  FreeAndNil(FrmSelectEmpProcessamento);

  CB_Mes1.SetFocus;

  bgSiga:=False;
  FrmPeriodoApropriacao:=TFrmPeriodoApropriacao.Create(Self);
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Text:=
                      DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Text   :=
                      DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmPeriodoApropriacao.ShowModal;

  sgDtaInicio:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Date);
  sgDtaFim:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Date);
  FreeAndNil(FrmPeriodoApropriacao);

  sgDtaInicio:=f_Troca('/','.',sgDtaInicio);
  sgDtaInicio:=f_Troca('-','.',sgDtaInicio);
  sgDtaFim:=f_Troca('/','.',sgDtaFim);
  sgDtaFim:=f_Troca('-','.',sgDtaFim);

  // Verifica se Prossegue Processamento =======================================
  If Not bgSiga Then
   Exit;

  If msg('Deseja Realmente Buscar'+cr+'Ordens de Compra das Lojas ??'+cr+sgDtaInicio+' a '+sgDtaFim,'C')=2 Then
  Begin
    CB_Mes1.SetFocus;
    Exit;
  End;

  // Busca OC nas Lojas ========================================================
  BuscaOCLojas;
  
end;

procedure TFrmBelShop.SubMenuFinanMargemLucroClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Inicializa Tabelas Virtuais para Filtros ==================================
  try
    DMVirtual.CDS_V_Produtos.CreateDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  Except
    DMVirtual.CDS_V_Produtos.EmptyDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  End;

  try
    DMVirtual.CDS_V_Fornecedores.CreateDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  Except
    DMVirtual.CDS_V_Fornecedores.EmptyDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  End;
  MontaSelectFornecedores;

  try
    DMVirtual.CDS_V_GruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  Except
    DMVirtual.CDS_V_GruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_SubGruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  Except
    DMVirtual.CDS_V_SubGruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  End;

  //============================================================================
  // PageControl de Filtros - INICIO ===========================================
  //============================================================================
  //-----------------------------------------------------------------
  // Filtro de Fornecedores -----------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFornecedor.Visible:=True;
  // Curva ABC no Fornecedor
  Painel_FiltroOC.Visible:=False;
  // Obs para Utilizao no Movto de Comprovantes
  Label_MovtoComprovForn.Visible:=False;
  Label_MovtoComprovForn.Top:=Painel_FiltroOC.Top;

  //-----------------------------------------------------------------
  // Filtro de Produtos ---------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroProdutos.TabVisible:=True;
  // Filtor nao Produtos de No Compra
  Painel_FiltroNaoCompra.Visible:=False;
  // Filtro para Busca Pelo Nome
  Gb_CalculoFiltroNome.Visible:=False;
  EdtCalculoFiltroNome1.Clear;
  EdtCalculoFiltroNome2.Clear;
  EdtCalculoFiltroNome3.Clear;
  EdtCalculoFiltroNome4.Clear;

  //-----------------------------------------------------------------
  // Filtro de Grupos e SubGrupos -----------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupos.TabVisible:=True;

  //-----------------------------------------------------------------
  // Filtro de Aplicaes dos Produtos ------------------------------
  //-----------------------------------------------------------------
  TS_FiltroAplicacao.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Familia de Preos ------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFamiliaPreco.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Grupos ST --------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupoST.TabVisible:=False;

  //-----------------------------------------------------------------
  // Grupo de Comprovantes ------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroComprovantes.TabVisible:=False;

  //-----------------------------------------------------------------
  // Posiciona o PC_Filtros em seu Parent ---------------------------
  //-----------------------------------------------------------------
  PC_Filtros.Parent:=Ts_FinanMLFiltros;
  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);
  //============================================================================
  // PageControl de Filtros - FIM ==============================================
  //============================================================================

  // Seleciona TabSheet ========================================================
  Pan_FinanMLPeriodo.Caption:='';
  Pan_FinanMLLojas.Caption:='';
  
  SelecionaTabSheet(Ts_FinanMargemLucro);
  PC_FinanMargemLucro.TabIndex:=0;
  PC_Filtros.TabIndex:=0;

  PC_Filtros.ActivePage:=TS_FiltroFornecedor;
  PC_FinanMargemLucro.ActivePage:=Ts_FinanMLFiltros;
  EdtFiltroCodForn.SetFocus;

end;

procedure TFrmBelShop.Bt_FinanMLVoltarClick(Sender: TObject);
begin
  PC_FinanMargemLucro.TabIndex:=0;
  PC_FinanMargemLucroChange(Self);
end;

procedure TFrmBelShop.Bt_FinanMLBuscarClick(Sender: TObject);
Var
  bUsarPcMedioTE: Boolean;
begin
  // Solicita Empresas =========================================================
  Pan_FinanMLLojas.Caption:='';
  sgOutrasEmpresa:='(99)'; //ou '(50)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;
  FrmSelectEmpProcessamento.iNrEmpProc:=0;

  FrmSelectEmpProcessamento.ShowModal;

  igNrEmpProc:=FrmSelectEmpProcessamento.iNrEmpProc;
  
  FreeAndNil(FrmSelectEmpProcessamento);

  // Verifica se Existe Empresa a Processar ====================================
  If DMBelShop.CDS_EmpProcessa.Eof Then
  Begin
    PC_Filtros.TabIndex:=0;
    PC_FiltrosChange(Self);
    EdtFiltroCodForn.SetFocus;
    Exit;
  End;

  // Verifica se Processa Todas as Empresas ====================================
  sgEmpresas:='';
  bgTodasEmpresas:=True;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       // Atualiza sgEmpresa para Sql ---------------------------------
       If sgEmpresas='' Then
        sgEmpresas:=QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString)
       Else
        sgEmpresas:=sgEmpresas+', '+QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);
     End
    Else // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
     Begin
       bgTodasEmpresas:=False;
     End; // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; //   While Not DMBelShop.CDS_EmpProcessa.Eof do

  PC_FinanMargemLucro.TabIndex:=1;
  Dbg_FinanMargemLucro.SetFocus;

  If DMVirtual.CDS_V_MargemLucro.Active Then
   DMVirtual.CDS_V_MargemLucro.EmptyDataSet;

  // Apresenta Lojas a Processar ===============================================
  Pan_FinanMLLojas.Caption:='  Todas as Lojas';
  If Not bgTodasEmpresas Then
  Begin
    Pan_FinanMLLojas.Caption:=f_Troca('''','',sgEmpresas);
    Pan_FinanMLLojas.Caption:=f_Troca(',',';',Pan_FinanMLLojas.Caption);
    Pan_FinanMLLojas.Caption:=' '+Pan_FinanMLLojas.Caption+';';
  End;

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(6);

  bgProcessar:=False;
  FrmSolicitacoes.ShowModal;

  If Not bgProcessar Then
  Begin
    Pan_FinanMLLojas.Caption:='';
    Pan_FinanMLPeriodo.Caption:='';
    FreeAndNil(FrmSolicitacoes);
    Bt_FinanMLVoltarClick(Self);
    Exit;
  End; // If bgProcessar Then

  // Periodo Vendas ============================================================
  sgDtaInicio:=DateToStr(FrmSolicitacoes.DtEdt_MargemLucroDtaInicioVen.Date);
  sgDtaFim   :=DateToStr(FrmSolicitacoes.DtEdt_MargemLucroDtaFimVen.Date);

  // Periodo Entradas ==========================================================
  sgDtaI     :=DateToStr(FrmSolicitacoes.DtEdt_MargemLucroDtaInicioEnt.Date);
  sgDtaF     :=DateToStr(FrmSolicitacoes.DtEdt_MargemLucroDtaFimEnt.Date);

  // Tipo de Apresentao ======================================================
  igTpApres:=FrmSolicitacoes.Cbx_MargemLucroApres.ItemIndex;
  sgTitulo:=FrmSolicitacoes.Cbx_MargemLucroApres.Text;

  // Se Utiliza Preco de Custo Medio na Transferencia ==========================
  bUsarPcMedioTE:=False;
  If (igTpApres in [0,1,4,5]) Then
   bUsarPcMedioTE:=(FrmSolicitacoes.Ckb_MargemLucroPcCustoTE.Checked);

  FreeAndNil(FrmSolicitacoes);

  // Apresenta o Perodo =======================================================
  Pan_FinanMLPeriodo.Caption:=sgDtaInicio+' a '+sgDtaFim;

  // Acerta Data para Separador <.>
  sgDtaInicio :=f_Troca('/','.',sgDtaInicio);
  sgDtaInicio :=f_Troca('-','.',sgDtaInicio);
  sgDtaFim:=f_Troca('/','.',sgDtaFim);
  sgDtaFim:=f_Troca('-','.',sgDtaFim);

  sgDtaI:=f_Troca('/','.',sgDtaI);
  sgDtaI:=f_Troca('-','.',sgDtaI);
  sgDtaF:=f_Troca('/','.',sgDtaF);
  sgDtaF:=f_Troca('-','.',sgDtaF);

  // Painel de Apresentacao de Processamento ===================================
  OdirPanApres.Caption:='AGUARDE !! Calculando Margens...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Cria Clients Virtuais =====================================================
  // CDS_V_MargemLucro ----------------------------
  try
    If DMVirtual.CDS_V_MargemLucro.Active Then
     DMVirtual.CDS_V_MargemLucro.Close;

    DMVirtual.CDS_V_MargemLucro.IndexFieldNames:='';
    DMVirtual.CDS_V_MargemLucro.CreateDataSet;
    DMVirtual.CDS_V_MargemLucro.Open;
  Except
    DMVirtual.CDS_V_MargemLucro.EmptyDataSet;
    DMVirtual.CDS_V_MargemLucro.Open;
  End;

  // CDS_V_MargLucroBonif -------------------------
  If DMVirtual.CDS_V_MargLucroBonif.Active Then
   DMVirtual.CDS_V_MargLucroBonif.Close;

  DMVirtual.CDS_V_MargLucroBonif.IndexFieldNames:='';
  DMVirtual.CDS_V_MargLucroBonif.CreateDataSet;
  DMVirtual.CDS_V_MargLucroBonif.IndexFieldNames:='CODFILIAL;APRESENTACAO';
  DMVirtual.CDS_V_MargLucroBonif.Open;

  // CDS_V_MargLucroBonifRes ----------------------
  If DMVirtual.CDS_V_MargLucroBonifRes.Active Then
   DMVirtual.CDS_V_MargLucroBonifRes.Close;

  DMVirtual.CDS_V_MargLucroBonifRes.CreateDataSet;
  DMVirtual.CDS_V_MargLucroBonifRes.IndexFieldNames:='SINALESTOQUE;DESCOMPROVANTE';
  DMVirtual.CDS_V_MargLucroBonifRes.Open;

  // CDS_V_MargLucroFinal -------------------------
  If DMVirtual.CDS_V_MargLucroFinal.Active Then
   DMVirtual.CDS_V_MargLucroFinal.Close;

  DMVirtual.CDS_V_MargLucroFinal.IndexFieldNames:='';
  DMVirtual.CDS_V_MargLucroFinal.CreateDataSet;
  DMVirtual.CDS_V_MargLucroFinal.Open;

  // CDS_V_MargemLucroForn ------------------------
  If DMVirtual.CDS_V_MargemLucroForn.Active Then
   DMVirtual.CDS_V_MargemLucroForn.Close;

  DMVirtual.CDS_V_MargemLucroForn.IndexFieldNames:='';
  DMVirtual.CDS_V_MargemLucroForn.CreateDataSet;
  DMVirtual.CDS_V_MargemLucroForn.Open;

  // CDS_V_MargLucroScroll ------------------------
  If DMVirtual.CDS_V_MargemLucroScroll.Active Then
   DMVirtual.CDS_V_MargemLucroScroll.Close;

  DMVirtual.CDS_V_MargemLucroScroll.IndexFieldNames:='';
  DMVirtual.CDS_V_MargemLucroScroll.CreateDataSet;
  DMVirtual.CDS_V_MargemLucroScroll.Open;

  // Busca os Produtos =========================================================
  If Not CalculaMargemLucro(sgEmpresas, igTpApres, bUsarPcMedioTE) Then
  Begin
    OdirPanApres.Visible:=False;
    msg('SEM Produto para Analisar !!','A');

    PC_Filtros.ActivePage:=TS_FiltroFornecedor;
    PC_FiltrosChange(Self);
    PC_FinanMargemLucro.ActivePage:=Ts_FinanMLFiltros;
    PC_FinanMargemLucroChange(Self);
    EdtFiltroCodForn.SetFocus;
    Exit;
  End;
  OdirPanApres.Visible:=False;

  // Acerta Nome da Coluna =====================================================
  If igTpApres=0 Then
  Begin
    DMVirtual.CDS_V_MargemLucroPRECOCUSTO.DisplayLabel:='Custo Mdio';
    DMVirtual.CDS_V_MargemLucroPRECOVENDA.DisplayLabel:='Venda Mdia';
  End;

  If igTpApres=1 Then
  Begin
    DMVirtual.CDS_V_MargemLucroPRECOCUSTO.DisplayLabel:='Custo Mdio';
    DMVirtual.CDS_V_MargemLucroPRECOVENDA.DisplayLabel:='Venda Lista';
  End;

  If igTpApres=2 Then
  Begin
    DMVirtual.CDS_V_MargemLucroPRECOCUSTO.DisplayLabel:='Custo Lista';
    DMVirtual.CDS_V_MargemLucroPRECOVENDA.DisplayLabel:='Venda Mdia';
  End;

  If igTpApres=3 Then
  Begin
    DMVirtual.CDS_V_MargemLucroPRECOCUSTO.DisplayLabel:='Custo Lista';
    DMVirtual.CDS_V_MargemLucroPRECOVENDA.DisplayLabel:='Venda Lista';
  End;

  If igTpApres=4 Then
  Begin
    DMVirtual.CDS_V_MargemLucroPRECOCUSTO.DisplayLabel:='Ult Compra';
    DMVirtual.CDS_V_MargemLucroPRECOVENDA.DisplayLabel:='Venda Mdia';
  End;

  If igTpApres=5 Then
  Begin
    DMVirtual.CDS_V_MargemLucroPRECOCUSTO.DisplayLabel:='Ult Compra';
    DMVirtual.CDS_V_MargemLucroPRECOVENDA.DisplayLabel:='Venda Lista';
  End;

  // Fixa 4 Colunas no DBGrid ==================================================
  THackDBGrid(Dbg_FinanMargemLucroBonif).FixedCols:=4; // Considerar o Indicador
  THackDBGrid(Dbg_FinanMargemLucro).FixedCols:=4; // Considerar o Indicador
  THackDBGrid(Dbg_FinanMargemLucroScroll).FixedCols:=4; // Considerar o Indicador
  THackDBGrid(Dbg_FinanMLForn).FixedCols:=3; // Considerar o Indicador

  msg('Calculo de Margem de Lucro Finalizado !!','A');

  Dbg_FinanMargemLucro.SetFocus;

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex=2) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMargemLucro).LeftCol:=4; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex:=3; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMargemLucro.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanMargemLucroColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanMargemLucroColEnter(Self);

  If not (gdSelected in State) Then
  Begin                                                            
    if Copy(DMVirtual.CDS_V_MargemLucroAPRESENTACAO.AsString,1,6)='TOTAL-' Then
    Begin
      Dbg_FinanMargemLucro.Canvas.Font.Style:=[fsBold];
      Dbg_FinanMargemLucro.Canvas.Brush.Color:=clSkyBlue;
    end;

    If (Column.Field.FieldName='% Lucro') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroLucro.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.Field.FieldName='VLR_BAP') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroVLR_BAP.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.Field.FieldName='PER_LUCRO_FINAL') Then
    Begin
      Dbg_FinanMargemLucro.Canvas.Font.Style:=[fsBold];
      If DMVirtual.CDS_V_MargemLucroPER_LUCRO_FINAL.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='%_MARGEM_1=((PV-PC)/PV)*100') Then
    Begin
     If DMVirtual.CDS_V_MargemLucro_MARGEM_1.AsCurrency<0 Then
      Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='%_MARGEM_2=((PV/PC)*100)-100') Then
    Begin
      If DMVirtual.CDS_V_MargemLucro_MARGEM_2.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VALOR_MARGEM') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroVALOR_MARGEM.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='PER_MARKUP') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroPER_MARKUP.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VLR_MARGEM_TOTAL') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroVLR_MARGEM_TOTAL.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VLR_MARGEM_FINAL') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroVLR_MARGEM_FINAL.AsCurrency<0 Then
       Dbg_FinanMargemLucro.Canvas.Font.Color:=clRed;
    End;

    Dbg_FinanMargemLucro.Canvas.FillRect(Rect);
    Dbg_FinanMargemLucro.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroDrawDataCell(Sender: TObject; const Rect: TRect;
          Field: TField; State: TGridDrawState);
begin             
  if (THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex=2) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMargemLucro).FixedCols:=4;
    THackDBGrid(Dbg_FinanMargemLucro).LeftCol:=4; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex := 3; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMargemLucro.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  s: String;
begin

  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex=3) Then // Index da 1 Coluna No Fixada Sem Contar Indicador
  Begin
    Key := VK_Clear;
    Dbg_FinanMargemLucro.Refresh;
  End;

  // Localiza Produto ==========================================================
  If Key=VK_F4 Then
  Begin
    If DMVirtual.CDS_V_MargemLucro.IsEmpty Then
     Exit;
     
    s:='';
    If InputQuery('Localizar Produto','',s) Then
    Begin
      if Trim(s)<>'' then
      Begin
        If StrToIntDef(s,999999)=999999 Then
         DMVirtual.CDS_V_MargemLucro.Locate('APRESENTACAO',AnsiUpperCase(s),[loPartialKey])
        Else
         DMVirtual.CDS_V_MargemLucro.Locate('CODPRODUTO',s,[]);
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) Then
  End; // If Key=VK_F4 Then

end;

procedure TFrmBelShop.Bt_FinanMLSalvaClipboardClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_MargemLucro.IsEmpty Then
   Exit;

  DBGridClipboard(Dbg_FinanMargemLucro);

end;

procedure TFrmBelShop.Bt_FinanMLSalvaCSVClick(Sender: TObject);
begin

  If DMVirtual.CDS_V_MargemLucro.IsEmpty Then
   Exit;

  SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_MargemLucro,Dbg_FinanMargemLucro, Mem_Salvar);

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroTitleClick(Column: TColumn);
Var
  i: Integer;
begin
        
  If Not DMVirtual.CDS_V_MargemLucro.Active Then
   Exit;
   
  for i:=0 to DMVirtual.CDS_V_MargemLucro.IndexDefs.Count-1 do
   DMVirtual.CDS_V_MargemLucro.DeleteIndex(DMVirtual.CDS_V_MargemLucro.IndexDefs[i].Name);

  If OrderGrid='Descedente' Then
   Begin
     DMVirtual.CDS_V_MargemLucro.IndexFieldNames:='';
     DMVirtual.CDS_V_MargemLucro.AddIndex(Column.FieldName, 'CODFILIAL;'+Column.FieldName,[ixDescending], Column.FieldName);
     DMVirtual.CDS_V_MargemLucro.IndexName:=Column.FieldName;
     OrderGrid:='Crescente';
   End
  Else
   Begin         
     OrderGrid:='Descedente';
     DMVirtual.CDS_V_MargemLucro.IndexFieldNames:='CODFILIAL;'+Column.FieldName;
   End;

  DMVirtual.CDS_V_MargemLucro.First;

  for i:=0 to DMVirtual.CDS_V_MargemLucro.IndexDefs.Count-1 do
   DMVirtual.CDS_V_MargemLucro.DeleteIndex(DMVirtual.CDS_V_MargemLucro.IndexDefs[i].Name);

end;

procedure TFrmBelShop.PC_FinanMargemLucroChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_FinanMargemLucro);

  If (PC_FinanMargemLucro.ActivePage=Ts_FinanMLForn) And (Ts_FinanMLForn.CanFocus) Then
  Begin
     Dbg_FinanMLForn.SetFocus;
   Exit;
  End;

  If (PC_FinanMargemLucro.ActivePage=Ts_FinanMLFinal) And (Ts_FinanMLFinal.CanFocus) Then
  Begin
    Sbt_FinanMLResFinal.Top:=Dbg_FinanMLResFinal.Top-8;
    Sbt_FinanMLResFinal.Left:=Dbg_FinanMLResultado.Left;
    Dbg_FinanMLResultado.SetFocus;
    Exit;
  End;

  If (PC_FinanMargemLucro.ActivePage=Ts_FinanMLBonif) And (Ts_FinanMLBonif.CanFocus) Then
  Begin
    Dbg_FinanMargemLucroBonif.SetFocus;
    Exit;
  End;

  If (PC_FinanMargemLucro.ActivePage=Ts_FinanMLFat) And (Ts_FinanMLFat.CanFocus) Then
  Begin
    Dbg_FinanMargemLucro.SetFocus;
    Exit;
  End;

end;

procedure TFrmBelShop.Bt_FinanMLRFVoltarClick(Sender: TObject);
begin
  PC_FinanMargemLucro.TabIndex:=0;
  PC_FinanMargemLucroChange(Self);
end;

procedure TFrmBelShop.Bt_FinanMLBVoltarClick(Sender: TObject);
begin
  PC_FinanMargemLucro.TabIndex:=0;
  PC_FinanMargemLucroChange(Self);

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroBonifColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex=2) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMargemLucroBonif).LeftCol:=4; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex:=3; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMargemLucroBonif.Refresh;
  end;
end;

procedure TFrmBelShop.Dbg_FinanMargemLucroBonifColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanMargemLucroBonifColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroBonifDrawDataCell(Sender: TObject; const Rect: TRect;
          Field: TField; State: TGridDrawState);
begin
  if (THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex=2) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMargemLucroBonif).FixedCols:=4;
    THackDBGrid(Dbg_FinanMargemLucroBonif).LeftCol:=4; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex := 3; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMargemLucroBonif.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroBonifKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  s: String;
begin
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanMargemLucroBonif).SelectedIndex=3) Then // Index da 1 Coluna No Fixada Sem Contar Indicador
  Begin
    Key := VK_Clear;
    Dbg_FinanMargemLucroBonif.Refresh;
  End;

  // Localiza Produto ==========================================================
  If Key=VK_F4 Then
  Begin
    If DMVirtual.CDS_V_MargLucroBonif.IsEmpty Then
     Exit;
     
    s:='';
    If InputQuery('Localizar Produto','',s) Then
    Begin
      if Trim(s)<>'' then
      Begin
        If StrToIntDef(s,999999)=999999 Then
         DMVirtual.CDS_V_MargLucroBonif.Locate('APRESENTACAO',AnsiUpperCase(s),[loPartialKey])
        Else
         DMVirtual.CDS_V_MargLucroBonif.Locate('CODPRODUTO',s,[]);
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) Then
  End; // If Key=VK_F4 Then

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroBonifDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If not (gdSelected in State) Then
  Begin             
    If (Column.FieldName='ENT_SAI') Then   
    Begin
      if DMVirtual.CDS_V_MargLucroBonifENT_SAI.AsString='E' Then
       Dbg_FinanMargemLucroBonif.Canvas.Font.Color:=clBlue
      Else
       Dbg_FinanMargemLucroBonif.Canvas.Font.Color:=clRed;
    End; // If (Column.FieldName='ENT_SAI') Then   
    
    If (Column.FieldName='TOT_VALTOTAL') Then   
    Begin
      if DMVirtual.CDS_V_MargLucroBonifENT_SAI.AsString='E' Then
       Dbg_FinanMargemLucroBonif.Canvas.Font.Color:=clBlue
      Else
       Dbg_FinanMargemLucroBonif.Canvas.Font.Color:=clRed;
    End; // If (Column.FieldName='TOT_VALTOTAL') Then   

    Dbg_FinanMargemLucroBonif.Canvas.FillRect(Rect);
    Dbg_FinanMargemLucroBonif.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Bt_FinanMLBSalvaClipboardClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_MargLucroBonif.IsEmpty Then
   Exit;

  DBGridClipboard(Dbg_FinanMargemLucroBonif);

end;

procedure TFrmBelShop.Bt_FinanMLBSalvaCSVClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_MargLucroBonif.IsEmpty Then
   Exit;

  SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_MargLucroBonif,Dbg_FinanMargemLucroBonif, Mem_Salvar);
  
end;

procedure TFrmBelShop.Bt_FinanMLRSalvaClipboardClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_MargLucroBonifRes.IsEmpty Then
   Exit;

  Dbg_FinanMLResultado.SetFocus;
  DBGridClipboard(Dbg_FinanMLResultado);
end;

procedure TFrmBelShop.Bt_FinanMLRFSalvaCSVClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_MargLucroBonifRes.IsEmpty Then
   SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_MargLucroBonifRes,Dbg_FinanMLResultado, Mem_Salvar);

  If Not DMVirtual.CDS_V_MargLucroBonifRes.IsEmpty Then
   SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_MargLucroFinal,Dbg_FinanMLResFinal, Mem_Salvar);

end;

procedure TFrmBelShop.Dbe_ConEmpresasCodLPExit(Sender: TObject);
begin
  DMBelShop.CDS_EmpresaCOD_LISTAPRE.AsString:=FormatFloat('0000',StrToInt(DMBelShop.CDS_EmpresaCOD_LISTAPRE.AsString));
end;

procedure TFrmBelShop.Dbg_FinanMLResultadoDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If not (gdSelected in State) Then
  Begin
    If (Column.FieldName='SINALESTOQUE') Then
    Begin
      if DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString='Entrada' Then
       Dbg_FinanMLResultado.Canvas.Font.Color:=clBlue
      Else
       Dbg_FinanMLResultado.Canvas.Font.Color:=clRed;
    End; // If (Column.FieldName='SINALESTOQUE') Then

    If (Column.FieldName='TOT_VALTOTAL') Then
    Begin
      if DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString='Entrada' Then
       Dbg_FinanMLResultado.Canvas.Font.Color:=clBlue
      Else
       Dbg_FinanMLResultado.Canvas.Font.Color:=clRed;
    End; // If (Column.FieldName='TOT_VALTOTAL') Then


    Dbg_FinanMLResultado.Canvas.FillRect(Rect);
    Dbg_FinanMLResultado.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Dbg_FinanMLResFinalDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  If not (gdSelected in State) Then
  Begin
    If (Column.FieldName='Per_Margem') Then
    Begin
     if DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency<0 Then
      Dbg_FinanMLResFinal.Canvas.Font.Color:=clRed
     Else
      Dbg_FinanMLResFinal.Canvas.Font.Color:=clBlue;
    End;

    If (Column.FieldName='Tot_Custos') and (DMVirtual.CDS_V_MargLucroFinalDesc_Tipo.AsString='Total Bonif/Ajustes/Perdas') Then
    Begin
     if DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency<0 Then
      Dbg_FinanMLResFinal.Canvas.Font.Color:=clRed
     Else
      Dbg_FinanMLResFinal.Canvas.Font.Color:=clBlue;
    End;
    
    Dbg_FinanMLResFinal.Canvas.FillRect(Rect);
    Dbg_FinanMLResFinal.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Bt_FinanMLFiltrosFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);
end;

procedure TFrmBelShop.Bt_FinanMLRFSalvaClipboardClick(Sender: TObject);
begin

  If DMVirtual.CDS_V_MargLucroFinal.IsEmpty Then
   Exit;

  DBGridClipboard(Dbg_FinanMLResFinal);
end;

procedure TFrmBelShop.Bt_FOSomaClick(Sender: TObject);
Var
  sCodObjtivos, sCodObj: String;
  MySql: String;
begin
  If msg('Deseja Realmente Somar os Objetos Marcados'+cr+cr+'Para o Selecionado','C')=2 Then
   Exit;

  sCodObj:=DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
  DMBelShop.CDS_Objetivos.First;
  While Not DMBelShop.CDS_Objetivos.Eof do
  Begin
    If DMBelShop.CDS_ObjetivosPROC.AsString='SIM' Then
    Begin
      If Trim(sCodObjtivos)='' Then
       sCodObjtivos:=DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString
      Else
       sCodObjtivos:=sCodObjtivos+', '+DMBelShop.CDS_ObjetivosCOD_OBJETIVO.AsString;
    End; // If DMBelShop.CDS_ObjetivosPROC.AsString='SIM' Then
  
    DMBelShop.CDS_Objetivos.Next;
  End; // While Not DMBelShop.CDS_Objetivos.Eof do
  DMBelShop.CDS_Objetivos.Locate('COD_OBJETIVO',sCodObj,[]);
  
  If Trim(sCodObjtivos)='' Then
  Begin
    msg('Sem Objetivo Marcado ','A');
    Exit;
  End;

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart; 
    DateSeparator:='.';
    DecimalSeparator:='.';

    DMBelShop.CDS_ObjetivosEmpresas.First;
    While Not DMBelShop.CDS_ObjetivosEmpresas.Eof do
    Begin
      // Exclui Antigos Totais de Objetivos ====================================
      MySql:=' DELETE FROM FIN_OBJETIVOS_METAS e'+
             ' wHERE e.cod_filial='+DMBelShop.CDS_ObjetivosEmpresas.FieldByName('Cod_Filial').AsString+
             ' AND e.cod_objetivo='+sCodObj+
             ' AND e.des_ano='+QuotedStr(EdtFinanObjetivosAno.Text);
      DMBelShop.SQLC.Execute(MySql,nil,nil);

      // Inclui Novos Totais de Objetivos ======================================
      MySql:=' INSERT INTO FIN_OBJETIVOS_METAS'+
             ' SELECT e.COD_FILIAL,'+
             sCodObj+' COD_OBJETIVO, e.DES_ANO,'+
             ' sum(Coalesce(e.OBJ_MES01,0)) OBJ_MES01,'+
             ' sum(Coalesce(e.OBJ_MES02,0)) OBJ_MES02,'+
             ' sum(Coalesce(e.OBJ_MES03,0)) OBJ_MES03,'+
             ' sum(Coalesce(e.OBJ_MES04,0)) OBJ_MES04,'+
             ' sum(Coalesce(e.OBJ_MES05,0)) OBJ_MES05,'+
             ' sum(Coalesce(e.OBJ_MES06,0)) OBJ_MES06,'+
             ' sum(Coalesce(e.OBJ_MES07,0)) OBJ_MES07,'+
             ' sum(Coalesce(e.OBJ_MES08,0)) OBJ_MES08,'+
             ' sum(Coalesce(e.OBJ_MES09,0)) OBJ_MES09,'+
             ' sum(Coalesce(e.OBJ_MES10,0)) OBJ_MES10,'+
             ' sum(Coalesce(e.OBJ_MES11,0)) OBJ_MES11,'+
             ' sum(Coalesce(e.OBJ_MES12,0)) OBJ_MES12,'+
             Cod_Usuario+' USU_INCLUI,'+
             ' current_timestamp DTA_INCLUI,'+
             ' null USU_ALTERA,'+
             ' null DTA_ALTERA'+

             ' FROM FIN_OBJETIVOS_METAS e'+
             ' WHERE e.cod_filial='+QuotedStr(
             DMBelShop.CDS_ObjetivosEmpresas.FieldByName('Cod_Filial').AsString)+
             ' And e.cod_objetivo in ('+sCodObjtivos+')'+
             ' And e.des_ano='+QuotedStr(EdtFinanObjetivosAno.Text)+
             ' group by 1,2,3,16,17,18,19';
      DMBelShop.SQLC.Execute(MySql,nil,nil);
  
      DMBelShop.CDS_ObjetivosEmpresas.Next;
    End; // While Not DMBelShop.CDS_ObjetivosEmpresas.Eof do
    DMBelShop.CDS_ObjetivosEmpresas.First;

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try 

  Bt_FinanObjetivosManutAbandonarClick(Self);
end;

procedure TFrmBelShop.Rb_MLTpCalculoMarkUpClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_MLTpCalculoMarkUp);
  AcertaRb_Style(Rb_MLTpCalculoMargem);
end;

procedure TFrmBelShop.Rb_MLTpCalculoMarkUpKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_MLTpCalculoMarkUpClick(Self);
end;

procedure TFrmBelShop.Bt_FinanMLFValtarClick(Sender: TObject);
begin
  PC_FinanMargemLucro.TabIndex:=0;
  PC_FinanMargemLucroChange(Self);

end;

procedure TFrmBelShop.Dbg_FinanMLFornCellClick(Column: TColumn);
begin
  Dbg_FinanMLForn.Refresh;

end;

procedure TFrmBelShop.Dbg_FinanMLFornColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanMLForn).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMLForn).SelectedIndex=1) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMLForn).LeftCol:=3; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMLForn).SelectedIndex:=2; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMLForn.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanMLFornColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanMLFornColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanMLFornDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanMargemLucroColEnter(Self);

  If not (gdSelected in State) Then
  Begin

    If (Column.Field.FieldName='% Lucro') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroFornLUCRO.AsCurrency<0 Then
       Dbg_FinanMLForn.Canvas.Font.Color:=clRed;
    End;

    If (Column.Field.FieldName='VLR_BAP') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroFornVLR_BAP.AsCurrency<0 Then
       Dbg_FinanMLForn.Canvas.Font.Color:=clRed;
    End;

    If (Column.Field.FieldName='PER_LUCRO_FINAL') Then
    Begin
      Dbg_FinanMLForn.Canvas.Font.Style:=[fsBold];
      If DMVirtual.CDS_V_MargemLucroFornPER_LUCRO_FINAL.AsCurrency<0 Then
       Dbg_FinanMLForn.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VALOR_MARGEM') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroFornVALOR_MARGEM.AsCurrency<0 Then
       Dbg_FinanMLForn.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VLR_MARGEM_TOTAL') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroFornVLR_MARGEM_TOTAL.AsCurrency<0 Then
       Dbg_FinanMLForn.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VLR_MARGEM_FINAL') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroFornVLR_MARGEM_FINAL.AsCurrency<0 Then
       Dbg_FinanMLForn.Canvas.Font.Color:=clRed;
    End;

    Dbg_FinanMLForn.Canvas.FillRect(Rect);
    Dbg_FinanMLForn.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then

end;

procedure TFrmBelShop.Dbg_FinanMLFornDrawDataCell(Sender: TObject; const Rect: TRect;
          Field: TField; State: TGridDrawState);
begin
  
  if (THackDBGrid(Dbg_FinanMLForn).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMLForn).SelectedIndex=1) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMLForn).FixedCols:=3;
    THackDBGrid(Dbg_FinanMLForn).LeftCol:=3; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMLForn).SelectedIndex := 2; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMLForn.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanMLFornKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  s: String;
begin
  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanMLForn).SelectedIndex=2) Then // Index da 1 Coluna No Fixada Sem Contar Indicador
  Begin
    Key := VK_Clear;
    Dbg_FinanMLForn.Refresh;
  End;

  // Localiza Produto ==========================================================
  If Key=VK_F4 Then
  Begin
    If DMVirtual.CDS_V_MargemLucroForn.IsEmpty Then
     Exit;
     
    s:='';
    If InputQuery('Localizar Fornecedor','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          DMVirtual.CDS_V_MargemLucroForn.Locate('CODFORNECEDOR',FormatFloat('000000',StrToInt(s)),[]);
        Except
          s:=AnsiUpperCase(s);
          DMVirtual.CDS_V_MargemLucroForn.Locate('NOMEFORNECEDOR',s,[loPartialKey]);
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Fornecedor','',s) then
  End; // If Key=VK_F4 Then
end;

procedure TFrmBelShop.Dbg_FinanMLFornTitleClick(Column: TColumn);
Var
  i: Integer;
  bOrderOutroGrid: Boolean;
begin
        
  If DMVirtual.CDS_V_MargemLucroForn.IsEmpty Then
   Exit;

  // Guarda Coluna a Apresentar no Grfico ===================================== 
  sgResultado:=Column.Title.Caption;

  // Ordena Dbg_FinanMargemLucroScroll =========================================
  bOrderOutroGrid:=False;
  For i:=0 to Dbg_FinanMargemLucroScroll.Columns.Count-1 do
  Begin
    If Dbg_FinanMargemLucroScroll.Columns[i].FieldName=Column.FieldName Then
    Begin
      bOrderOutroGrid:=True;
      Break;
    End;
  End; // For i:=0 to Dbg_FinanMargemLucroScroll.Columns.Count-1 do

  // Ordena Grid Dbg_FinanMLForn e Dbg_FinanMargemLucroScroll ================== 
  for i:=0 to DMVirtual.CDS_V_MargemLucroForn.IndexDefs.Count-1 do
   DMVirtual.CDS_V_MargemLucroForn.DeleteIndex(DMVirtual.CDS_V_MargemLucroForn.IndexDefs[i].Name);

  // Dbg_FinanMargemLucroScroll 
  If bOrderOutroGrid Then
  Begin
    for i:=0 to DMVirtual.CDS_V_MargemLucroScroll.IndexDefs.Count-1 do
     DMVirtual.CDS_V_MargemLucroScroll.DeleteIndex(DMVirtual.CDS_V_MargemLucroScroll.IndexDefs[i].Name);
  End;

  If OrderGrid='Descedente' Then
   Begin
     DMVirtual.CDS_V_MargemLucroForn.IndexFieldNames:='';
     DMVirtual.CDS_V_MargemLucroForn.AddIndex(Column.FieldName, Column.FieldName,[ixDescending], Column.FieldName);
     DMVirtual.CDS_V_MargemLucroForn.IndexName:=Column.FieldName;

     // Dbg_FinanMargemLucroScroll 
     If bOrderOutroGrid Then
     Begin
       DMVirtual.CDS_V_MargemLucroScroll.IndexFieldNames:='';
       DMVirtual.CDS_V_MargemLucroScroll.AddIndex(Column.FieldName, Column.FieldName,[ixDescending], Column.FieldName);
       DMVirtual.CDS_V_MargemLucroScroll.IndexName:=Column.FieldName;
     End;
     
     OrderGrid:='Crescente';
   End
  Else
   Begin         
     OrderGrid:='Descedente';
     DMVirtual.CDS_V_MargemLucroForn.IndexFieldNames:=Column.FieldName;

     // Dbg_FinanMargemLucroScroll 
     If bOrderOutroGrid Then
     Begin
       DMVirtual.CDS_V_MargemLucroScroll.IndexFieldNames:=Column.FieldName;
     End;
   End;

  DMVirtual.CDS_V_MargemLucroForn.First;

  for i:=0 to DMVirtual.CDS_V_MargemLucroForn.IndexDefs.Count-1 do
   DMVirtual.CDS_V_MargemLucroForn.DeleteIndex(DMVirtual.CDS_V_MargemLucroForn.IndexDefs[i].Name);

  // Dbg_FinanMargemLucroScroll 
  If bOrderOutroGrid Then
  Begin
    for i:=0 to DMVirtual.CDS_V_MargemLucroScroll.IndexDefs.Count-1 do
     DMVirtual.CDS_V_MargemLucroScroll.DeleteIndex(DMVirtual.CDS_V_MargemLucroScroll.IndexDefs[i].Name);
  End;
   
end;

procedure TFrmBelShop.Bt_FinanMLFSinteticoClick(Sender: TObject);
begin
  Dbg_FinanMLForn.SetFocus;
  
  If DMVirtual.CDS_V_MargemLucro.IsEmpty Then
   Exit;

  If Not DMVirtual.CDS_V_MargemLucroForn.IsEmpty Then
  Begin
    If msg('Deseja Realmente ReCalcular'+cr+'Sinttico de Fornecedores ?','C')=2 Then
     Exit;
  End;
   
  // CDS_V_MargemLucroForn ------------------------   
  If DMVirtual.CDS_V_MargemLucroForn.Active Then
   DMVirtual.CDS_V_MargemLucroForn.Close;
     
  DMVirtual.CDS_V_MargemLucroForn.CreateDataSet;
  DMVirtual.CDS_V_MargemLucroForn.Open;
  THackDBGrid(Dbg_FinanMLForn).FixedCols:=3;
  
  // CDS_V_MargemLucroForn ------------------------
  If DMVirtual.CDS_V_MargemLucroScroll.Active Then
   DMVirtual.CDS_V_MargemLucroScroll.Close;
     
  DMVirtual.CDS_V_MargemLucroScroll.CreateDataSet;
  DMVirtual.CDS_V_MargemLucroScroll.Open;
  THackDBGrid(Dbg_FinanMargemLucroScroll).FixedCols:=4; // Considerar o Indicador
  
  Screen.Cursor:=crAppStart;

  // Calcula Sintetico de Fornecedores
  MargemLucroSinteticoFornecedores;
  THackDBGrid(Dbg_FinanMLForn).FixedCols:=3;

  // Apresenta Valores de Faturamento do Fornecedor
  DMVirtual.CDS_V_MargemLucroScroll.Data:=DMVirtual.CDS_V_MargemLucro.Data;
  DMVirtual.CDS_V_MargemLucroFornAfterScroll(DMVirtual.CDS_V_MargemLucroForn);
  THackDBGrid(Dbg_FinanMargemLucroScroll).FixedCols:=4; // Considerar o Indicador
  
  Screen.Cursor:=crDefault;

  msg('Sinttico de Fornecedores'+cr+'Efetuado com Sucesso !!','A');
end;

procedure TFrmBelShop.Bt_FinanMLFSalvaClipboardClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_MargemLucroForn.IsEmpty Then
   Exit;

  Dbg_FinanMLForn.SetFocus;
  DBGridClipboard(Dbg_FinanMLForn);

end;

procedure TFrmBelShop.Bt_FinanMLScrollSalvaClipboardClick(Sender: TObject);   
begin
  If DMVirtual.CDS_V_MargemLucroScroll.IsEmpty Then
   Exit;

  Dbg_FinanMargemLucroScroll.SetFocus;
  DBGridClipboard(Dbg_FinanMargemLucroScroll);

end;

procedure TFrmBelShop.Bt_FinanMLFSalvaCSVClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_MargemLucroForn.IsEmpty Then
   SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_MargemLucroForn,Dbg_FinanMLForn, Mem_Salvar);

  If Not DMVirtual.CDS_V_MargemLucroScroll.IsEmpty Then
   SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_MargemLucroScroll,Dbg_FinanMargemLucroScroll, Mem_Salvar);

end;

procedure TFrmBelShop.Bt_FinanMLFormulasClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_MargemLucro.IsEmpty Then
   Exit;

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  FrmSolicitacoes.Caption:='Margem de Lucro - Valores Faturamento';
  AbreSolicitacoes(7);

  FrmSolicitacoes.EditorMargemLucro.Lines.Clear;

  // Coluna % Margem
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[7].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       Tipo de Margem a Calcular');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se MarkUp Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMargemLucro.Columns[6].Title.Caption+' - '+
                                                              Dbg_FinanMargemLucro.Columns[4].Title.Caption+') / '+
                                                              Dbg_FinanMargemLucro.Columns[4].Title.Caption+') * 100)');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se Valor Lucro Sobre Venda Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMargemLucro.Columns[6].Title.Caption+' - '+
                                                              Dbg_FinanMargemLucro.Columns[4].Title.Caption+') / '+
                                                              Dbg_FinanMargemLucro.Columns[6].Title.Caption+') * 100)');

  // Coluna Valor Margem
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[9].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMargemLucro.Columns[6].Title.Caption+' - '+
                                                        Dbg_FinanMargemLucro.Columns[4].Title.Caption);

  // Coluna % MarkUp
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[10].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       (('+Dbg_FinanMargemLucro.Columns[6].Title.Caption+' - '+
                                                          Dbg_FinanMargemLucro.Columns[4].Title.Caption+') / '+
                                                          Dbg_FinanMargemLucro.Columns[4].Title.Caption+') * 100)');

  // Coluna VLR_VENDA_PV
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[11].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMargemLucro.Columns[5].Title.Caption+' * '+
                                                        Dbg_FinanMargemLucro.Columns[6].Title.Caption);

  // Coluna VLR_VENDA_PC
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[12].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMargemLucro.Columns[5].Title.Caption+' * '+
                                                        Dbg_FinanMargemLucro.Columns[4].Title.Caption);

  // Coluna % Part Custo
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[13].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       (('+Dbg_FinanMargemLucro.Columns[4].Title.Caption+' * 100 ) / '+
                                                       'Total da Coluna '+Dbg_FinanMargemLucro.Columns[4].Title.Caption+')');

  // Coluna % Part Venda
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[14].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       (('+Dbg_FinanMargemLucro.Columns[6].Title.Caption+' * 100 ) / '+
                                                       'Total da Coluna '+Dbg_FinanMargemLucro.Columns[6].Title.Caption+')');

  // Coluna VLR_MARGEM_TOTAL
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[15].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMargemLucro.Columns[11].Title.Caption+' - '+
                                                        Dbg_FinanMargemLucro.Columns[12].Title.Caption);

  // Coluna % Lucro
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[16].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       Tipo de Margem a Calcular');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se MarkUp Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMargemLucro.Columns[11].Title.Caption+' - '+
                                                              Dbg_FinanMargemLucro.Columns[12].Title.Caption+') / '+
                                                              Dbg_FinanMargemLucro.Columns[12].Title.Caption+') * 100)');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se Valor Lucro Sobre Venda Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMargemLucro.Columns[11].Title.Caption+' - '+
                                                              Dbg_FinanMargemLucro.Columns[12].Title.Caption+') / '+
                                                              Dbg_FinanMargemLucro.Columns[11].Title.Caption+') * 100)');

  // Coluna PER_BAP_VENDA
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[18].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       (('+Dbg_FinanMargemLucro.Columns[17].Title.Caption+' * 100 ) / '+
                                                          Dbg_FinanMargemLucro.Columns[11].Title.Caption+')');

  // Coluna VLR_VENDA_PC_BAP
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[19].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMargemLucro.Columns[12].Title.Caption+' - '+
                                                        Dbg_FinanMargemLucro.Columns[17].Title.Caption);

  // Coluna VLR_MARGEM_FINAL
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[20].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMargemLucro.Columns[11].Title.Caption+' - '+
                                                        Dbg_FinanMargemLucro.Columns[19].Title.Caption);

  // Coluna PER_LUCRO_FINAL
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMargemLucro.Columns[21].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       Tipo de Margem a Calcular');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se MarkUp Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMargemLucro.Columns[11].Title.Caption+' - '+
                                                              Dbg_FinanMargemLucro.Columns[19].Title.Caption+') / '+
                                                              Dbg_FinanMargemLucro.Columns[19].Title.Caption+') * 100)');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se Valor Lucro Sobre Venda Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMargemLucro.Columns[11].Title.Caption+' - '+
                                                              Dbg_FinanMargemLucro.Columns[19].Title.Caption+') / '+
                                                              Dbg_FinanMargemLucro.Columns[11].Title.Caption+') * 100)');

  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');

  FrmSolicitacoes.ShowModal;

  FreeAndNil(FrmSolicitacoes);
end;

procedure TFrmBelShop.Bt_FinanMLFFormulasClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_MargemLucroForn.IsEmpty Then
   Exit;

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  FrmSolicitacoes.Caption:='Margem de Lucro - Sinttico Fornecedores';
  AbreSolicitacoes(7);

  FrmSolicitacoes.EditorMargemLucro.Lines.Clear;

  // Coluna % Part Custo
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[7].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       (('+Dbg_FinanMLForn.Columns[6].Title.Caption+' * 100 ) / '+
                                                       'Total da Coluna '+Dbg_FinanMLForn.Columns[6].Title.Caption+')');

  // Coluna % Part Venda
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[8].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       (('+Dbg_FinanMLForn.Columns[5].Title.Caption+' * 100 ) / '+
                                                       'Total da Coluna '+Dbg_FinanMLForn.Columns[5].Title.Caption+')');

  // Coluna VLR_MARGEM_TOTAL
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[9].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMLForn.Columns[5].Title.Caption+' - '+
                                                        Dbg_FinanMLForn.Columns[6].Title.Caption);
                                                        
  // Coluna % Lucro
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[10].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       Tipo de Margem a Calcular');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se MarkUp Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMLForn.Columns[5].Title.Caption+' - '+
                                                              Dbg_FinanMLForn.Columns[6].Title.Caption+') / '+
                                                              Dbg_FinanMLForn.Columns[6].Title.Caption+') * 100)');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se Valor Lucro Sobre Venda Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMLForn.Columns[5].Title.Caption+' - '+
                                                              Dbg_FinanMLForn.Columns[6].Title.Caption+') / '+
                                                              Dbg_FinanMLForn.Columns[5].Title.Caption+') * 100)');

  // Coluna PER_BAP_VENDA
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[12].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       (('+Dbg_FinanMLForn.Columns[11].Title.Caption+' * 100 ) / '+
                                                          Dbg_FinanMLForn.Columns[5].Title.Caption+')');

  // Coluna VLR_VENDA_PC_BAP
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[13].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMLForn.Columns[6].Title.Caption+' - '+
                                                        Dbg_FinanMLForn.Columns[11].Title.Caption);

  // Coluna VLR_MARGEM_FINAL
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('');    
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[14].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       '+Dbg_FinanMLForn.Columns[5].Title.Caption+' - '+
                                                        Dbg_FinanMLForn.Columns[13].Title.Caption);

  // Coluna PER_LUCRO_FINAL
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('==>> Coluna: '+Dbg_FinanMLForn.Columns[15].Title.Caption);
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('       Tipo de Margem a Calcular');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se MarkUp Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMLForn.Columns[5].Title.Caption+' - '+
                                                              Dbg_FinanMLForn.Columns[13].Title.Caption+') / '+
                                                              Dbg_FinanMLForn.Columns[13].Title.Caption+') * 100)');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('         Se Valor Lucro Sobre Venda Ento');
  FrmSolicitacoes.EditorMargemLucro.Lines.Add('           (('+Dbg_FinanMLForn.Columns[5].Title.Caption+' - '+
                                                              Dbg_FinanMLForn.Columns[13].Title.Caption+') / '+
                                                              Dbg_FinanMLForn.Columns[5].Title.Caption+') * 100)');

  FrmSolicitacoes.EditorMargemLucro.Lines.Add('============================');

  FrmSolicitacoes.ShowModal;

  FreeAndNil(FrmSolicitacoes);
end;

procedure TFrmBelShop.Bt_FinanMLFGraficosClick(Sender: TObject);
Var
  iNumSeq, i: Integer;
begin
  If DMVirtual.CDS_V_MargemLucroForn.IsEmpty Then
   Exit;

  // Cria Form do Grafico ====================================================== 
  FrmGrafico:=TFrmGrafico.Create(Self);

  // Monta Solicitaes Fornecedores ===========================================
  FrmGrafico.CLbx_ItensApres.Items.Clear;

  iNumSeq:=DMVirtual.CDS_V_MargemLucroForn.RecNo;
  DMVirtual.CDS_V_MargemLucroForn.First;
  While Not DMVirtual.CDS_V_MargemLucroForn.Eof do
  Begin
    FrmGrafico.CLbx_ItensApres.Items.Add(DMVirtual.CDS_V_MargemLucroFornNOMEFORNECEDOR.AsString+
                                         ' -> '+DMVirtual.CDS_V_MargemLucroFornCODFORNECEDOR.AsString);
      
    DMVirtual.CDS_V_MargemLucroForn.Next;
  End; // While Not DMVirtual.CDS_V_MargemLucroForn.Eof do
  DMVirtual.CDS_V_MargemLucroForn.RecNo:=iNumSeq;

  // Monta Solicitaes Resultados =============================================
  FrmGrafico.CLbx_Resultados.Items.Clear;
                                        
  For i:=0 to DMVirtual.CDS_V_MargemLucroForn.Fields.Count-1 do
  Begin 
    If DMVirtual.CDS_V_MargemLucroForn.Fields[i].Visible Then
    Begin
      If DMVirtual.CDS_V_MargemLucroForn.Fields[i].Size=2 Then
      Begin
        FrmGrafico.CLbx_Resultados.Items.Add(DMVirtual.CDS_V_MargemLucroForn.Fields[i].DisplayLabel);
      End; // If DMVirtual.CDS_V_MargemLucroForn.Fields[i].DisplayLabel='0,.00' Then
    End; // If DMVirtual.CDS_V_MargemLucroForn.Fields[i].Visible:=True Then
  End; // For i:=0 to DMVirtual.CDS_V_ObjetivosMovtos.Fields.Count-1 do

  // Seleciona Campo de Resultado ==============================================
  FrmGrafico.CLbx_Resultados.Color:=clWindow;
  FrmGrafico.CLbx_Resultados.Enabled:=True;
  If Trim(sgResultado)<>'' Then
  Begin
    For i:=0 to FrmGrafico.CLbx_Resultados.Items.Count-1 do
    Begin
      if FrmGrafico.CLbx_Resultados.Items[i]=sgResultado Then
      Begin
        FrmGrafico.CLbx_Resultados.Color:=cl3DLight;
        FrmGrafico.CLbx_Resultados.Checked[i]:=True;
        FrmGrafico.CLbx_Resultados.Enabled:=False;
        Break;
      End;
    End; // For i:=0 to CLbx_Resultados.Items.Count-1 do
  End; // If Trim(sgResultado)<>'' Then
  
  // Apresenta Form do Grafico =================================================
  FrmGrafico.Gb_ItensApres.Caption:=' Fornecedores a Apresentar ';

  FrmGrafico.ShowModal;
  FreeAndNil(FrmGrafico);
 
end;

procedure TFrmBelShop.Rb_FinanObjetivosGraficoTpBarrasKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_FinanObjetivosGraficoTpBarrasClick(Self);
end;

procedure TFrmBelShop.Ckb_FinanObjetivosGraficoValorVerticalKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosGraficoValorVerticalClick(Self);
end;

procedure TFrmBelShop.Ckb_FinanObjetivosGraficoMouseKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosGraficoMouseClick(self);
end;

procedure TFrmBelShop.Ckb_FinanObjetivosGrafico3DKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosGrafico3DClick(Self);
end;

procedure TFrmBelShop.Rb_FinanObjetivosGraficoTpBMPClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_FinanObjetivosGraficoTpBMP);
  AcertaRb_Style(Rb_FinanObjetivosGraficoTpWMF);
  AcertaRb_Style(Rb_FinanObjetivosGraficoTpClipboard);

end;

procedure TFrmBelShop.Rb_FinanObjetivosGraficoTpBMPKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_FinanObjetivosGraficoTpBMPClick(Self);
end;

procedure TFrmBelShop.Dbg_FinanMargemLucroScrollCellClick(Column: TColumn);
begin
  Dbg_FinanMargemLucroScroll.Refresh;

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroScrollColEnter(Sender: TObject);
begin
  if (THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex=2) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMargemLucroScroll).LeftCol:=4; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex:=3; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMargemLucroScroll.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroScrollColumnMoved(Sender: TObject; FromIndex, ToIndex: Integer);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanMargemLucroScrollColEnter(Self);

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroScrollDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  // Acerta Colunas Fixadas -----------------------------------------
  Dbg_FinanMargemLucroScrollColEnter(Self);

  If not (gdSelected in State) Then
  Begin
    If (Column.Field.FieldName='% Lucro') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroScrollLucro.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.Field.FieldName='VLR_BAP') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroScrollVLR_BAP.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.Field.FieldName='PER_LUCRO_FINAL') Then
    Begin
      Dbg_FinanMargemLucroScroll.Canvas.Font.Style:=[fsBold];
      If DMVirtual.CDS_V_MargemLucroScrollPER_LUCRO_FINAL.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='%_MARGEM_1=((PV-PC)/PV)*100') Then
    Begin                 
     If DMVirtual.CDS_V_MargemLucroScroll_MARGEM_1.AsCurrency<0 Then
      Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='%_MARGEM_2=((PV/PC)*100)-100') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroScroll_MARGEM_2.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VALOR_MARGEM') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroScrollVALOR_MARGEM.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='PER_MARKUP') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroScrollPER_MARKUP.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VLR_MARGEM_TOTAL') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroScrollVLR_MARGEM_TOTAL.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    If (Column.FieldName='VLR_MARGEM_FINAL') Then
    Begin
      If DMVirtual.CDS_V_MargemLucroScrollVLR_MARGEM_FINAL.AsCurrency<0 Then
       Dbg_FinanMargemLucroScroll.Canvas.Font.Color:=clRed;
    End;

    Dbg_FinanMargemLucroScroll.Canvas.FillRect(Rect);
    Dbg_FinanMargemLucroScroll.DefaultDrawDataCell(Rect,Column.Field,state);
  End; // if not (gdSelected in State) Then


end;

procedure TFrmBelShop.Dbg_FinanMargemLucroScrollDrawDataCell(Sender: TObject; const Rect: TRect;
          Field: TField; State: TGridDrawState);
begin
  
  if (THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex=0) Or
     (THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex=1) Or
     (THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex=2) Then // Index das Colunas Fixadas Sem Indicador
  begin
    THackDBGrid(Dbg_FinanMargemLucroScroll).FixedCols:=4;
    THackDBGrid(Dbg_FinanMargemLucroScroll).LeftCol:=4; // Index da 1 Coluna No Fixada Contando Indicador
    THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex := 3; // Index da 1 Coluna No Fixada Sem Contar Indicador
    Dbg_FinanMargemLucroScroll.Refresh;
  end;

end;

procedure TFrmBelShop.Dbg_FinanMargemLucroScrollKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  s: String;
begin

  if (Key = VK_Left) and (THackDBGrid(Dbg_FinanMargemLucroScroll).SelectedIndex=3) Then // Index da 1 Coluna No Fixada Sem Contar Indicador
  Begin
    Key := VK_Clear;
    Dbg_FinanMargemLucroScroll.Refresh;
  End;

  // Localiza Produto ==========================================================
  If Key=VK_F4 Then
  Begin
    If DMVirtual.CDS_V_MargemLucroScroll.IsEmpty Then
     Exit;
     
    s:='';
    If InputQuery('Localizar Produto','',s) Then
    Begin
      if Trim(s)<>'' then
      Begin
        If StrToIntDef(s,999999)=999999 Then
         DMVirtual.CDS_V_MargemLucroScroll.Locate('APRESENTACAO',AnsiUpperCase(s),[loPartialKey])
        Else
         DMVirtual.CDS_V_MargemLucroScroll.Locate('CODPRODUTO',s,[]);
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Produto','',s) Then
  End; // If Key=VK_F4 Then


end;

procedure TFrmBelShop.Dbg_FinanMargemLucroScrollTitleClick(Column: TColumn);
Var
  i: Integer;
begin
        
  If DMVirtual.CDS_V_MargemLucroScroll.IsEmpty Then
   Exit;

  for i:=0 to DMVirtual.CDS_V_MargemLucroScroll.IndexDefs.Count-1 do
   DMVirtual.CDS_V_MargemLucroScroll.DeleteIndex(DMVirtual.CDS_V_MargemLucroScroll.IndexDefs[i].Name);

  If OrderGrid='Descedente' Then
   Begin
     DMVirtual.CDS_V_MargemLucroScroll.IndexFieldNames:='';
     DMVirtual.CDS_V_MargemLucroScroll.AddIndex(Column.FieldName, 'CODFILIAL;'+Column.FieldName,[ixDescending], Column.FieldName);
     DMVirtual.CDS_V_MargemLucroScroll.IndexName:=Column.FieldName;
     OrderGrid:='Crescente';
   End
  Else
   Begin         
     OrderGrid:='Descedente';
     DMVirtual.CDS_V_MargemLucroScroll.IndexFieldNames:='CODFILIAL;'+Column.FieldName;
   End;

  DMVirtual.CDS_V_MargemLucroScroll.First;

  for i:=0 to DMVirtual.CDS_V_MargemLucroScroll.IndexDefs.Count-1 do
   DMVirtual.CDS_V_MargemLucroScroll.DeleteIndex(DMVirtual.CDS_V_MargemLucroScroll.IndexDefs[i].Name);

end;

procedure TFrmBelShop.FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Key=44) and (Not bgInd_Admin) Then
   Clipboard.AsText:='';

end;

procedure TFrmBelShop.Bt_FinanMLTamColClick(Sender: TObject);
Var
  sNomeCol, sTamColuna: String;
  iTamAtual, iIndexCol: Integer;
  iLinha: Integer;
begin

  If DMVirtual.CDS_V_MargemLucro.IsEmpty Then
   Exit;

  Dbg_FinanMargemLucro.SetFocus;

  iIndexCol:=THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex;
  iLinha:=DMVirtual.CDS_V_MargemLucro.RecNo;

  sNomeCol:=Dbg_FinanMargemLucro.Columns[Dbg_FinanMargemLucro.SelectedIndex].Title.Caption;
  iTamAtual:=Dbg_FinanMargemLucro.Columns[Dbg_FinanMargemLucro.SelectedIndex].Width;
  sTamColuna:=IntToStr(iTamAtual);
  If InputQuery('Tamanho da Coluna '+sNomeCol,'',sTamColuna) Then
  Begin
    Try
      StrToInt(sTamColuna);
      If StrToInt(sTamColuna)<5 Then
      Begin
        msg('Tamanho Invlido !!','A');
        Exit;
      End;
    Except
      msg('Nmero Invlido !!','A');
      Exit;
    End;


    Dbg_FinanMargemLucro.Columns[Dbg_FinanMargemLucro.SelectedIndex].Width:=StrToInt(sTamColuna);
    THackDBGrid(Dbg_FinanMargemLucro).FixedCols:=4;

    DMVirtual.CDS_V_MargemLucro.RecNo:=iLinha;
    THackDBGrid(Dbg_FinanMargemLucro).SelectedIndex:=iIndexCol;
    Dbg_FinanMargemLucro.SetFocus;

  End; // If InputQuery('Tamanho da Coluna '+sNomeCol,'',sTamColuna) Then

end;

procedure TFrmBelShop.Rb_CalculoApresCurvaEstComClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_CalculoApresCurvaEstCom);
  AcertaRb_Style(Rb_CalculoApresCurvaEstSem);
  AcertaRb_Style(Rb_CalculoApresCurvaEstAmbos);

end;

procedure TFrmBelShop.Rb_CalculoApresCurvaEstComKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_CalculoApresCurvaEstComClick(Self);
end;

procedure TFrmBelShop.Rb_CalculoTpCurvaABCMixKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_CalculoTpCurvaABCMixClick(Self);
end;

procedure TFrmBelShop.Bt_AudCompVendFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.SubMenuFinanAuditoriaCompVendasClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;
   
  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Inicializa Tabelas Virtuais para Filtros ==================================
  try
    DMVirtual.CDS_V_Produtos.CreateDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  Except
    DMVirtual.CDS_V_Produtos.EmptyDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  End;

  try
    DMVirtual.CDS_V_Fornecedores.CreateDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  Except
    DMVirtual.CDS_V_Fornecedores.EmptyDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  End;
  MontaSelectFornecedores;

  try
    DMVirtual.CDS_V_GruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  Except
    DMVirtual.CDS_V_GruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_SubGruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  Except
    DMVirtual.CDS_V_SubGruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  End;

  //============================================================================
  // PageControl de Filtros - INICIO ===========================================
  //============================================================================
  //-----------------------------------------------------------------
  // Filtro de Fornecedores -----------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFornecedor.Visible:=True;
  // Curva ABC no Fornecedor
  Painel_FiltroOC.Visible:=False;
  // Obs para Utilizao no Movto de Comprovantes
  Label_MovtoComprovForn.Visible:=False;
  Label_MovtoComprovForn.Top:=Painel_FiltroOC.Top;

  //-----------------------------------------------------------------
  // Filtro de Produtos ---------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroProdutos.TabVisible:=True;
  // Filtor nao Produtos de No Compra
  Painel_FiltroNaoCompra.Visible:=False;
  // Filtro para Busca Pelo Nome
  Gb_CalculoFiltroNome.Visible:=False;
  EdtCalculoFiltroNome1.Clear;
  EdtCalculoFiltroNome2.Clear;
  EdtCalculoFiltroNome3.Clear;
  EdtCalculoFiltroNome4.Clear;

  //-----------------------------------------------------------------
  // Filtro de Grupos e SubGrupos -----------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupos.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Aplicaes dos Produtos ------------------------------
  //-----------------------------------------------------------------
  TS_FiltroAplicacao.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Familia de Preos ------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFamiliaPreco.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Grupos ST --------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupoST.TabVisible:=False;

  //-----------------------------------------------------------------
  // Grupo de Comprovantes ------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroComprovantes.TabVisible:=False;

  //-----------------------------------------------------------------
  // Posiciona o PC_Filtros em seu Parent ---------------------------
  //-----------------------------------------------------------------
  PC_Filtros.Parent:=Ts_AudCompVendFiltros;
  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);
  //============================================================================
  // PageControl de Filtros - FIM ==============================================
  //============================================================================

  Lb_AudAprocessar.Caption:='0';
  Lb_AudProcessados.Caption:='0';
  Ts_AudCompVendMovtos.TabVisible:=False;
  SelecionaTabSheet(Ts_AudComprasVendas);
  CorSelecaoTabSheet(PC_Principal);

  PC_AudCompVend.ActivePage:=Ts_AudCompVendFiltros;

  EdtFiltroCodForn.SetFocus;

end;

procedure TFrmBelShop.Bt_AudCompVendBuscaMovtoClick(Sender: TObject);
Var
  bSiga, bProcOK: Boolean;
  ii, i: Integer;
begin
  PC_Filtros.TabIndex:=0;
  EdtFiltroCodForn.SetFocus;

  // Seleciona Lojas ===========================================================
  sgOutrasEmpresa:='(99)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;
  FrmSelectEmpProcessamento.ShowModal;

  // Verifica se Existe Empresa a Processar ====================================
  If FrmSelectEmpProcessamento.iNrEmpProc=0 Then
  Begin
    FreeAndNil(FrmSelectEmpProcessamento);
    Exit;
  End; // If FrmSelectEmpProcessamento.iNrEmpProc=1 Then
  FreeAndNil(FrmSelectEmpProcessamento);

  // ===========================================================================
  // Gaurda Lojas a Processar ==================================================
  // ===========================================================================
  sgCodLojas:='';
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      // Ataluza sEmpresa para Sql ---------------------------------
      If sgCodLojas='' Then
       sgCodLojas:=QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString)
      Else
       sgCodLojas:=sgCodLojas+', '+QuotedStr(DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString);
    End; // If DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; //   While Not DMBelShop.CDS_EmpProcessa.Eof do
  
  bgSiga:=False;
  FrmPeriodoApropriacao:=TFrmPeriodoApropriacao.Create(Self);
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Text:=DateToStr(
              PrimUltDia(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor),'P'));
  FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Text   :=DateToStr(
              PrimUltDia(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor),'U'));
  FrmPeriodoApropriacao.ShowModal;

  sgDtaInicio:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaInicio.Date);
  sgDtaFim:=DateToStr(FrmPeriodoApropriacao.DtEdt_PeriodoAproprDtaFim.Date);
  FreeAndNil(FrmPeriodoApropriacao);

  If not bgSiga Then
   Exit;
  
  // Acerta Periodo =============================================================
  sgDtaInicio:=f_Troca('/','.',sgDtaInicio);
  sgDtaInicio:=f_Troca('-','.',sgDtaInicio);
  sgDtaFim:=f_Troca('/','.',sgDtaFim);
  sgDtaFim:=f_Troca('-','.',sgDtaFim);

  // ClientDataSet Virtual
  DMVirtual.CDS_V_AudCompVend.IndexFieldNames:='';
  try
     DMVirtual.CDS_V_AudCompVend.CreateDataSet;
     DMVirtual.CDS_V_AudCompVend.Open;
  Except
     DMVirtual.CDS_V_AudCompVend.EmptyDataSet;
     DMVirtual.CDS_V_AudCompVend.Open;
  End;

  // Cabecalho =================================================================
  DMVirtual.CDS_V_AudCompVend.Append;
  DMVirtual.CDS_V_AudCompVendDESC_PRODUTO.AsString:='Compras/Vendas';
  DMVirtual.CDS_V_AudCompVendNum_Seq.AsInteger:=1;
  DMVirtual.CDS_V_AudCompVend.Post;

  DMVirtual.CDS_V_AudCompVend.Append;
  DMVirtual.CDS_V_AudCompVendDESC_PRODUTO.AsString:='Perodo de '+sgDtaInicio+' a '+sgDtaFim;
  DMVirtual.CDS_V_AudCompVendNum_Seq.AsInteger:=2;
  DMVirtual.CDS_V_AudCompVend.Post;

  DMVirtual.CDS_V_AudCompVend.Append;
  DMVirtual.CDS_V_AudCompVendDESC_PRODUTO.AsString:='Lojas: '+sgCodLojas;
  DMVirtual.CDS_V_AudCompVendNum_Seq.AsInteger:=3;
  DMVirtual.CDS_V_AudCompVend.Post;

  DMVirtual.CDS_V_AudCompVend.Append;
  DMVirtual.CDS_V_AudCompVendDESC_PRODUTO.AsString:='';
  DMVirtual.CDS_V_AudCompVendNum_Seq.AsInteger:=4;
  DMVirtual.CDS_V_AudCompVend.Post;

  // Inicia Processamento ======================================================
  sgLojasNConectadas:='';
  bProcOK:=False;

  Screen.Cursor:=crAppStart;

  // Apresentacao ==========================================================
  OdirPanApres.Caption:='AGUARDE !! Iniciando Processamento !!';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin
    Refresh;

    // Apresentacao ==========================================================
    OdirPanApres.Caption:='AGUARDE !! Analisando Loja: Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
    OdirPanApres.Visible:=True;
    Refresh;

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      sgDesLoja:=DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;

      // Conecta Empresa =======================================================
      If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then
       Begin
         bSiga:=True;
       End
      Else
       Begin
         Refresh;
         bSiga:=False;
         
         If sgLojasNConectadas='' Then
          sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
         Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
          sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
       End; // If ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'A') Then

      // Inicia Processamento ==================================================
      If bSiga Then // Empresa Conectada
      Begin
        // Cria Query da Empresa ------------------------------------
        CriaQueryIB('IBDB_'+sgCodEmp,'IBT_'+sgCodEmp,IBQ_ConsultaFilial, True, True);

        For ii:=1 to 2 do
        Begin
          // Apresentacao ==========================================================
          If ii=1 Then
           OdirPanApres.Caption:='AGUARDE !! Buscando 1/2 (Compras) Loja: Bel_'+sgCodEmp+' - '+sgDesLoja
          Else
           OdirPanApres.Caption:='AGUARDE !! Buscando 2/2 (Vendas) Loja: Bel_'+sgCodEmp+' - '+sgDesLoja;

          OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
          OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
          OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
          OdirPanApres.Visible:=True;
          Refresh;

          // Monta Sql de Compras -------------------------------------
          If ii=1 Then
           AuditoriaMontaSQLCompVend('C', IBQ_ConsultaFilial)
          Else
           AuditoriaMontaSQLCompVend('V', IBQ_ConsultaFilial);

          // Abre Query -----------------------------------------------
          i:=0;
          bSiga:=False;
          While Not bSiga do
          Begin
            Try
              IBQ_ConsultaFilial.Open;
              bSiga:=True;
            Except
              Inc(i);
            End; // Try

            If i>10 Then
            Begin
              If sgLojasNConectadas='' Then
               sgLojasNConectadas:='Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString
              Else If Not AnsiContainsStr(sgLojasNConectadas, 'Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString) then
               sgLojasNConectadas:=sgLojasNConectadas+', Bel_'+DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;

              Break;
            End; // If i>10 Then
          End; // While Not bSiga do

          // Processamento =======================================================
          If bSiga Then // Query Executada
          Begin
            IBQ_ConsultaFilial.DisableControls;
            Lb_AudAprocessar.Caption:=IntToStr(iNrRegistros);
            Lb_AudProcessados.Caption:='0';

            // Apresentacao ==========================================================
            If ii=1 Then
             OdirPanApres.Caption:='AGUARDE !! Processando 1/2 (Compras) Loja: Bel_'+sgCodEmp+' - '+sgDesLoja
            Else
             OdirPanApres.Caption:='AGUARDE !! Processando 2/2 (Vendas) Loja: Bel_'+sgCodEmp+' - '+sgDesLoja;

            OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
            OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
            OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
            OdirPanApres.Visible:=True;
            Refresh;

            While Not IBQ_ConsultaFilial.Eof do
            Begin
              Application.ProcessMessages;
              bProcOK:=True;
              
              // Efetua o Processamento ...........
              DMVirtual.CDS_V_AudCompVend.Append;
              DMVirtual.CDS_V_AudCompVendCOD_LOJA.Asstring:=  
                            Trim(IBQ_ConsultaFilial.FieldByName('COD_LOJA').Asstring);
              DMVirtual.CDS_V_AudCompVendCODPRODUTO.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('CODPRODUTO').Asstring);
              DMVirtual.CDS_V_AudCompVendDESC_PRODUTO.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('DESC_PRODUTO').Asstring);
              DMVirtual.CDS_V_AudCompVendSITUACAOPRO.Asstring:=
                         Trim(IBQ_ConsultaFilial.FieldByName('SITUACAOPRO').Asstring);
              DMVirtual.CDS_V_AudCompVendNCM.Asstring:=
                                 Trim(IBQ_ConsultaFilial.FieldByName('NCM').Asstring);
              DMVirtual.CDS_V_AudCompVendCODFISCAL.Asstring:=
                           Trim(IBQ_ConsultaFilial.FieldByName('CODFISCAL').Asstring);
              DMVirtual.CDS_V_AudCompVendCODFISCALPRO.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('CODFISCALPRO').Asstring);
              DMVirtual.CDS_V_AudCompVendCOMPRA_VENDA.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('COMPRA_VENDA').Asstring);
              DMVirtual.CDS_V_AudCompVendNAOSOMAESTOQUE.Asstring:=
                      Trim(IBQ_ConsultaFilial.FieldByName('NAOSOMAESTOQUE').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMOUESTOQUE.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('SOMOUESTOQUE').Asstring);
              DMVirtual.CDS_V_AudCompVendQUANTIDADE.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('QUANTIDADE').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BRUTO.Asstring:=
                           Trim(IBQ_ConsultaFilial.FieldByName('VLR_BRUTO').Asstring);
              DMVirtual.CDS_V_AudCompVendPER_DESCONTO.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('PER_DESCONTO').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_DESC_ITEM.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_DESC_ITEM').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_DESCONTO_RS.Asstring:=
                     Trim(IBQ_ConsultaFilial.FieldByName('VLR_DESCONTO_RS').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMADESPESABASEICM.Asstring:=
                  Trim(IBQ_ConsultaFilial.FieldByName('SOMADESPESABASEICM').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMADESPESABASEIPI.Asstring:=
                  Trim(IBQ_ConsultaFilial.FieldByName('SOMADESPESABASEIPI').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMADESPESABASEST.Asstring:=
                   Trim(IBQ_ConsultaFilial.FieldByName('SOMADESPESABASEST').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_DESPESAS.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('VLR_DESPESAS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_TOTAL.Asstring:=
                           Trim(IBQ_ConsultaFilial.FieldByName('VLR_TOTAL').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_ARREDONDA.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_ARREDONDA').Asstring);
              DMVirtual.CDS_V_AudCompVendRS_ICM_SN.Asstring:=
                           Trim(IBQ_ConsultaFilial.FieldByName('RS_ICM_SN').Asstring);
              DMVirtual.CDS_V_AudCompVendISENTO_ICM.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('ISENTO_ICM').Asstring);
              DMVirtual.CDS_V_AudCompVendCST_ICMS.Asstring:=
                            Trim(IBQ_ConsultaFilial.FieldByName('CST_ICMS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BASEICM.Asstring:=
                         Trim(IBQ_ConsultaFilial.FieldByName('VLR_BASEICM').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQICMORIGEM.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('ALIQICMORIGEM').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQICM.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('ALIQICM').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_ICM.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('VLR_ICM').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQICMREDUCAO.Asstring:=
                      Trim(IBQ_ConsultaFilial.FieldByName('ALIQICMREDUCAO').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_REDUCAOICM.Asstring:=
                      Trim(IBQ_ConsultaFilial.FieldByName('VLR_REDUCAOICM').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_ISENTOICM.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_ISENTOICM').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_OUTROSICM.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_OUTROSICM').Asstring);
              DMVirtual.CDS_V_AudCompVendISENTO_IPI.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('ISENTO_IPI').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMAIPIBASEICM.Asstring:=
                      Trim(IBQ_ConsultaFilial.FieldByName('SOMAIPIBASEICM').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMAIPIBASESUBST.Asstring:=
                    Trim(IBQ_ConsultaFilial.FieldByName('SOMAIPIBASESUBST').Asstring);
              DMVirtual.CDS_V_AudCompVendIPI_PERC_OU_VALOR.Asstring:=
                   Trim(IBQ_ConsultaFilial.FieldByName('IPI_PERC_OU_VALOR').Asstring);
              DMVirtual.CDS_V_AudCompVendIPISOMATOTAL_SN.Asstring:=
                     Trim(IBQ_ConsultaFilial.FieldByName('IPISOMATOTAL_SN').Asstring);
              DMVirtual.CDS_V_AudCompVendCST_IPI.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('CST_IPI').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BASEIPI.Asstring:=
                         Trim(IBQ_ConsultaFilial.FieldByName('VLR_BASEIPI').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQIPI.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('ALIQIPI').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_IPI.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('VLR_IPI').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_ISENTOIPI.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_ISENTOIPI').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_OUTROSIPI.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_OUTROSIPI').Asstring);
              DMVirtual.CDS_V_AudCompVendIPIREDUCAO.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('IPIREDUCAO').Asstring);
              DMVirtual.CDS_V_AudCompVendSUBSTITUICAO_S_N.Asstring:=
                    Trim(IBQ_ConsultaFilial.FieldByName('SUBSTITUICAO_S_N').Asstring);
              DMVirtual.CDS_V_AudCompVendISENTO_SUBST.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('ISENTO_SUBST').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMASTBASEPISCOFINS.Asstring:=
                 Trim(IBQ_ConsultaFilial.FieldByName('SOMASTBASEPISCOFINS').Asstring);
              DMVirtual.CDS_V_AudCompVendSUBST_VAL_PER.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('SUBST_VAL_PER').Asstring);
              DMVirtual.CDS_V_AudCompVendSUBSTMARGEM.Asstring:=
                         Trim(IBQ_ConsultaFilial.FieldByName('SUBSTMARGEM').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BASESUBST.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_BASESUBST').Asstring);
              DMVirtual.CDS_V_AudCompVendSUBSTALIQ.Asstring:=
                           Trim(IBQ_ConsultaFilial.FieldByName('SUBSTALIQ').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_SUBSTITUICAO.Asstring:=
                    Trim(IBQ_ConsultaFilial.FieldByName('VLR_SUBSTITUICAO').Asstring);
              DMVirtual.CDS_V_AudCompVendSUBSTDESCONTO.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('SUBSTDESCONTO').Asstring);
              DMVirtual.CDS_V_AudCompVendISENTO_PISCOFINS.Asstring:=
                    Trim(IBQ_ConsultaFilial.FieldByName('ISENTO_PISCOFINS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BASEPISCOFINS.Asstring:=
                   Trim(IBQ_ConsultaFilial.FieldByName('VLR_BASEPISCOFINS').Asstring);
              DMVirtual.CDS_V_AudCompVendCST_PIS.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('CST_PIS').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQPIS.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('ALIQPIS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_PIS.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('VLR_PIS').Asstring);
              DMVirtual.CDS_V_AudCompVendCST_COFINS.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('CST_COFINS').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQCOFINS.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('ALIQCOFINS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_COFINS.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('VLR_COFINS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BASEPIS_ST.Asstring:=
                      Trim(IBQ_ConsultaFilial.FieldByName('VLR_BASEPIS_ST').Asstring);
              DMVirtual.CDS_V_AudCompVendMARGEM_PIS.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('MARGEM_PIS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_PIS_ST.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('VLR_PIS_ST').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BASECOFINS_ST.Asstring:=
                   Trim(IBQ_ConsultaFilial.FieldByName('VLR_BASECOFINS_ST').Asstring);
              DMVirtual.CDS_V_AudCompVendMARGEM_COFINS.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('MARGEM_COFINS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_COFINS_ST.Asstring:=
                       Trim(IBQ_ConsultaFilial.FieldByName('VLR_COFINS_ST').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQREPASSE.Asstring:=
                         Trim(IBQ_ConsultaFilial.FieldByName('ALIQREPASSE').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_REPASSE.Asstring:=
                         Trim(IBQ_ConsultaFilial.FieldByName('VLR_REPASSE').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMAFRETEBASEICM.Asstring:=
                    Trim(IBQ_ConsultaFilial.FieldByName('SOMAFRETEBASEICM').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMAFRETEBASEIPI.Asstring:=
                    Trim(IBQ_ConsultaFilial.FieldByName('SOMAFRETEBASEIPI').Asstring);
              DMVirtual.CDS_V_AudCompVendSOMAFRETEBASEST.Asstring:=
                     Trim(IBQ_ConsultaFilial.FieldByName('SOMAFRETEBASEST').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_FRETE.Asstring:=
                           Trim(IBQ_ConsultaFilial.FieldByName('VLR_FRETE').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_FRETE_INCLUSO.Asstring:=
                   Trim(IBQ_ConsultaFilial.FieldByName('VLR_FRETE_INCLUSO').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_FRETENAO.Asstring:=
                        Trim(IBQ_ConsultaFilial.FieldByName('VLR_FRETENAO').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_SEGURO.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('VLR_SEGURO').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQISS.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('ALIQISS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_ISS.Asstring:=
                             Trim(IBQ_ConsultaFilial.FieldByName('VLR_ISS').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BASEII.Asstring:=
                          Trim(IBQ_ConsultaFilial.FieldByName('VLR_BASEII').Asstring);
              DMVirtual.CDS_V_AudCompVendALIQII.Asstring:=
                              Trim(IBQ_ConsultaFilial.FieldByName('ALIQII').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_II.Asstring:=
                              Trim(IBQ_ConsultaFilial.FieldByName('VLR_II').Asstring);
              DMVirtual.CDS_V_AudCompVendVLR_BONIFICADO.Asstring:=
                      Trim(IBQ_ConsultaFilial.FieldByName('VLR_BONIFICADO').Asstring);
              DMVirtual.CDS_V_AudCompVendCOMP_VALTOTBONIFICADO.Asstring:=
               Trim(IBQ_ConsultaFilial.FieldByName('COMP_VALTOTBONIFICADO').Asstring);
              DMVirtual.CDS_V_AudCompVendSIMPLESESTADUAL.Asstring:=
                     Trim(IBQ_ConsultaFilial.FieldByName('SIMPLESESTADUAL').Asstring);
              DMVirtual.CDS_V_AudCompVendNum_Seq.AsInteger:=9999;

              DMVirtual.CDS_V_AudCompVend.Post;

              Lb_AudProcessados.Caption:=IntToStr(IBQ_ConsultaFilial.RecNo);

              IBQ_ConsultaFilial.Next;
            End; // While Not IBQ_ConsultaFilial.Eof do
            IBQ_ConsultaFilial.EnableControls;
            IBQ_ConsultaFilial.Close;

          End; // If bSiga Then // Query Executada

          Lb_AudAprocessar.Caption:='0';
          Lb_AudProcessados.Caption:='0';

        End; // For ii:=1 to 2 do
      End; // If bSiga Then // Empresa Conectada

      // Fecha Conexo =========================================================
      ConexaoEmpIndividual('IBDB_'+sgCodEmp, 'IBT_'+sgCodEmp, 'F');
      Lb_AudAprocessar.Caption:='0';
      Lb_AudProcessados.Caption:='0';
    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  Screen.Cursor:=crDefault;

  OdirPanApres.Visible:=False;
  Refresh;

  If bProcOK Then
   Begin
     msg('Busca de Movtos '+cr+'Efetuada com SUCESSO !!','A');

     DMVirtual.CDS_V_AudCompVend.IndexFieldNames:='NUM_SEQ;DESC_PRODUTO;COD_LOJA';

     // Efetua Qualquer Coisa
     Ts_AudCompVendMovtos.TabVisible:=True;
     Ts_AudCompVendFiltros.TabVisible:=False;
     PC_AudCompVend.ActivePage:=Ts_AudCompVendMovtos;

     DMVirtual.CDS_V_AudCompVend.First;
     Dbg_AudCompVend.SetFocus;
   End // If bProcOK Then
  Else
   Begin
     Screen.Cursor:=crDefault;
     msg('Nenhum Movto Foi Encontrado !!','A');
   End; //  // If bProcOK Then

  If sgLojasNConectadas<>'' Then
   msg('Lojas No Conectadas: '+cr+cr+sgLojasNConectadas,'A');
end;

procedure TFrmBelShop.Bt_AudCompVendVoltarClick(Sender: TObject);
begin
  Ts_AudCompVendFiltros.TabVisible:=True;
  Ts_AudCompVendMovtos.TabVisible:=False;

  PC_AudCompVend.ActivePage:=Ts_AudCompVendFiltros;
  EdtFiltroCodForn.SetFocus;
  
end;

procedure TFrmBelShop.Bt_AudCompVendSalvaClipboardClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_AudCompVend.IsEmpty Then
   Exit;

  DBGridClipboard(Dbg_AudCompVend);
end;

procedure TFrmBelShop.Bt_AudCompVendSalvaCSVClick(Sender: TObject);
begin
  If DMVirtual.CDS_V_AudCompVend.IsEmpty Then
   Exit;

  SalvaResultado_CLI_DisplayName(DMVirtual.CDS_V_AudCompVend,Dbg_AudCompVend, Mem_Salvar);
end;

procedure TFrmBelShop.Bt_FinanConciliacaoFecharClick(Sender: TObject);
begin
  FechaTudo;
  AbreFechaTabSheet(False, True);

end;

procedure TFrmBelShop.SubMenuFinanBancosClick(Sender: TObject);
begin
  FrmBancoExtratos.Caption:='Bancos';

  // Acerta Apresentao das TabSheets =========================================
  FrmBancoExtratos.DesabilitaTabSheet(FrmBancoExtratos.Ts_BancosManut);

  // Desabilida Menu de Conciliao ============================================
  FrmBancoExtratos.LiberaMenu(False);

  FrmBancoExtratos.Pan_Opcoes.Visible:=True;
  FrmBancoExtratos.Pan_Concilicao.Visible:=False;

  FrmBancoExtratos.sgCodUsuario:=Cod_Usuario;

  FrmBancoExtratos.ShowModal;

end;

procedure TFrmBelShop.SubMenuFinanConciliaPagtosClick(Sender: TObject);
begin
  FrmBancoExtratos.Caption:='Conciliaes de Pagamentos';

  // Acerta Apresentao das TabSheets =========================================
  FrmBancoExtratos.DesabilitaTabSheet(nil);

  // Desabilida Menu de Conciliao ============================================
  FrmBancoExtratos.LiberaMenu(True);

  // Habilida Menu de Conciliao ==============================================
  FrmBancoExtratos.MenuConcilicao.Visible:=True;
  FrmBancoExtratos.MenuManutConcilicao.Visible:=True;
  FrmBancoExtratos.MenuParametros.Visible:=True;
  FrmBancoExtratos.MenuTipoConcilciao.Visible:=True;

  FrmBancoExtratos.Pan_Opcoes.Parent:=FrmBancoExtratos.PC_Principal;
  FrmBancoExtratos.Pan_Opcoes.Visible:=True;
  FrmBancoExtratos.Pan_Concilicao.Visible:=False;

  FrmBancoExtratos.PC_ConcConciliar.TabIndex:=0;

  FrmBancoExtratos.Pan_ConcLoja.Visible:=False;
  FrmBancoExtratos.sgCodUsuario:=Cod_Usuario;

  if Not bgInd_Admin Then
   FrmBancoExtratos.MenuParametros.Visible:=False;

  // Executa Permisses de Menu ================================================
  BloqueioMenu(FrmBancoExtratos, DMBelShop.CDS_Seguranca, DMBelShop.SDS_Busca, Des_Login, bgInd_Admin);

  FrmBancoExtratos.ShowModal;

end;

procedure TFrmBelShop.SubMenuFinanExtratosClick(Sender: TObject);
begin
  FrmBancoExtratos.Caption:='Extratos Bancrios';

  // Acerta Apresentao das TabSheets =========================================
  FrmBancoExtratos.DesabilitaTabSheet(FrmBancoExtratos.Ts_ExtratosManut);

  // Desabilida Menu de Conciliao ============================================
  FrmBancoExtratos.LiberaMenu(False);

  FrmBancoExtratos.Pan_Opcoes.Visible:=True;
  FrmBancoExtratos.Pan_Concilicao.Visible:=False;

  FrmBancoExtratos.sgCodUsuario:=Cod_Usuario;

  FrmBancoExtratos.EdtExtNumAgencia.Clear;
  FrmBancoExtratos.EdtExtDesAgencia.Clear;
  FrmBancoExtratos.EdtExtNumConta.Clear;
  FrmBancoExtratos.EdtExtCodBanco.Clear;
  FrmBancoExtratos.EdtExtNumBanco.Clear;
  FrmBancoExtratos.EdtExtDesBanco.Clear;
  FrmBancoExtratos.EdtBanrisulPastaArquivo.Clear;
  FrmBancoExtratos.EdtSantanderPastaArquivo.Clear;

  FrmBancoExtratos.ShowModal;
end;

procedure TFrmBelShop.SubMenuFaltasReposicoesCDLojasClick(Sender: TObject);
begin
  If AnsiUpperCase(Des_Usuario)<>'ODIR' Then
  Begin
    msg('Opo em Desenvolvimento !!','A');
    Exit;
  End;

  FrmFaltasCDLojas:=TFrmFaltasCDLojas.Create(Self);

  // Coloca Data de Hoje =======================================================
  FrmFaltasCDLojas.DtEdt_FaltasCDLojasDtaInicio.Text:=
                   DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
  FrmFaltasCDLojas.DtEdt_FaltasCDLojasDtaFim.Text   :=
                   DateToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));

  FrmFaltasCDLojas.ShowModal;

  FreeAndNil(FrmFaltasCDLojas);

end;

procedure TFrmBelShop.SubMenuSalaoProfissionaisClick(Sender: TObject);
begin
  FrmSalao:=TFrmSalao.Create(Self);
  FrmSalao.CorCaptionForm.FormCaption:='Cadastro de Profissionais de Salo';

  TabSheetInvisivel(FrmSalao);
  FrmSalao.Ts_Profissionais.TabVisible:=True;
  FrmSalao.Bt_CodViculados.Visible:=False;

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmSalao, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Permisses de Visualizao ================================================
  PermissaoVisual(FrmSalao.Ts_Profissionais);

  FrmSalao.ShowModal;

  FreeAndNil(FrmSalao);
end;

procedure TFrmBelShop.SubMenuSalaoHabilidadesServicosClick(Sender: TObject);
Var
  MySql: String;
begin
  FrmSalao:=TFrmSalao.Create(Self);
  FrmSalao.CorCaptionForm.FormCaption:='Cadastro de Habilidades';

  TabSheetInvisivel(FrmSalao);
  FrmSalao.Ts_Habilidades.TabVisible:=True;
  FrmSalao.Pan_Profissionais.Visible:=False;

  //============================================================================
  // Atualiza Comisses da Habilidades Por Cidade - INICIO =====================
  //============================================================================
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;

    MySql:=' INSERT INTO TAB_AUXILIAR (tip_aux, cod_aux, des_aux)'+
           ' SELECT 18 tip_aux, h.cod_habserv cod_aux, ''000.00;000.00;000.00;000.00;'' des_aux'+
           ' FROM SAL_HAB_SERV h'+
           ' WHERE h.tip_habserv = ''H'''+
           ' AND NOT EXISTS(SELECT 1'+
           '                FROM tab_auxiliar c'+
           '                WHERE c.tip_aux = 18'+
           '                AND   c.cod_aux = h.cod_habserv)';
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Transacao ======================================================
    DMBelShop.SQLC.Commit(TD);

    OdirPanApres.Visible:=False;

    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao ====================================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';

      Screen.Cursor:=crDefault;
      MessageBox(Handle, pChar('Erro na Comisso da Habilidade:'+#13+e.message), 'Erro', MB_ICONERROR);

      FreeAndNil(FrmSalao);

      Exit;
    End; // on e : Exception do
  End; // Try
  //============================================================================
  // Atualiza Comisses da Habilidades Por Cidade - INICIO =====================
  //============================================================================

  // Posiciona Painel Rodape
  FrmSalao.Pan_Profissionais.Visible:=False;
  FrmSalao.Pan_Rodape.Parent:=FrmSalao.Pan_HabilidadesServicos;

  PermissaoVisual(FrmSalao.Ts_Habilidades);
  FrmSalao.ShowModal;

  FreeAndNil(FrmSalao);
end;

procedure TFrmBelShop.SubMenuSalaoMetasClick(Sender: TObject);
begin
  msg('Opo em Desenvolvimento !!','A');
  Exit;

  FrmSalao:=TFrmSalao.Create(Self);
  FrmSalao.CorCaptionForm.FormCaption:='Metas de Profissionais de Salo';

  TabSheetInvisivel(FrmSalao);
  FrmSalao.Ts_ProfMetas.TabVisible:=True;
  FrmSalao.EdtMetasAno.AsInteger:=YearOf(Now);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmSalao, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Posiciona Painel Rodape
  FrmSalao.Bt_Fechar.Parent:=FrmSalao.Pan_MetasRodape;

  FrmSalao.ShowModal;

  FreeAndNil(FrmSalao);
end;

procedure TFrmBelShop.SubMenuPlanilhaPagtosClick(Sender: TObject);
begin

  FrmSalao:=TFrmSalao.Create(Self);
  FrmSalao.CorCaptionForm.FormCaption:='Pagamento a Profissionais';

  FrmSalao.Bt_PagtoDebCredImprime.Visible:=True;
  FrmSalao.Bt_PagtoDebCredImprime.Caption:='Planilha Conferncia';
  FrmSalao.Bt_PagtoDebCredImprime.Parent:=FrmSalao.Pan_DebCredBottom;
  FrmSalao.Bt_PagtoGeraPlanilha.Parent:=FrmSalao.Pan_DebCredBottom;

  TabSheetInvisivel(FrmSalao);
  FrmSalao.Ts_ProfPagtos.TabVisible:=True;

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmSalao, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Permisses de Visualizao ================================================
  PermissaoVisual(FrmSalao.Ts_ProfPagtos);

  FrmSalao.ShowModal;

  FreeAndNil(FrmSalao);
end;

procedure TFrmBelShop.Rb_UsuAtivoSimKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_UsuAtivoSimClick(Self);
end;

procedure TFrmBelShop.Rb_UsuAtivoNaoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_UsuAtivoSimClick(Self);

end;

procedure TFrmBelShop.Rb_UsuAtivoAmbosKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_UsuAtivoSimClick(Self);

end;

procedure TFrmBelShop.Bt_OCsImportadasClick(Sender: TObject);
begin
  // Apresenta Ordens de Compra de Origem (Importadas) =========================
  ApresOCsImportadas;

end;

procedure TFrmBelShop.SubMenuParametrosClick(Sender: TObject);
Var
  s, MySql: String;
begin
  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(11);

  FrmSolicitacoes.Caption:='SISTEMA';
  FrmSolicitacoes.PC_Parametros.TabIndex:=0;
  FrmSolicitacoes.Ts_ParamLojaReposFornec.TabVisible:=False;

  // Tabela de Parametros ======================================================
  DMBelShop.CDS_ParametrosSIS.Open;
  DMBelShop.CDS_ParametrosSIS.Edit;

  FrmSolicitacoes.Ckb_ParamConsNfeOCSolic.Checked:=
                   (DMBelShop.CDS_ParametrosSisIND_CONSISTE_NFE.AsString='SIM');

  s:=DMBelShop.CDS_ParametrosSisDIA_INI_COMISSAO_PROF.AsString;
  FrmSolicitacoes.Cbx_ParamComProfDiaIni.ItemIndex:=
                        FrmSolicitacoes.Cbx_ParamComProfDiaIni.Items.IndexOf(s);

  s:=DMBelShop.CDS_ParametrosSisDIA_FIM_COMISSAO_PROF.AsString;
  FrmSolicitacoes.Cbx_ParamComProfDiaFim.ItemIndex:=
                        FrmSolicitacoes.Cbx_ParamComProfDiaFim.Items.IndexOf(s);

  // TAXA SINDICATO ============================================================
  FrmSolicitacoes.DBCBx_ParamTaxaSindMes.ItemIndex:=FrmSolicitacoes.DBCBx_ParamTaxaSindMes.Items.IndexOf(
                                                    DMBelShop.CDS_ParametrosSisMES_COBRANCA_SINDICATO.AsString);
  FrmSolicitacoes.DBCBx_ParamTaxaSindPosicao.ItemIndex:=FrmSolicitacoes.DBCBx_ParamTaxaSindPosicao.Items.IndexOf(
                                                        DMBelShop.CDS_ParametrosSisPOS_COBRANCA_SINDICATO.AsString);
  FrmSolicitacoes.DBCBx_ParamTaxaSindDia.ItemIndex:=FrmSolicitacoes.DBCBx_ParamTaxaSindDia.Items.IndexOf(
                                                    DMBelShop.CDS_ParametrosSisDIA_COBRANCA_SINDICATO.AsString);

  // Tabela de Salario Mnimo ==================================================
  MySql:=' SELECT ''NORMAL  '' IND_SIT, c.*'+
         ' FROM FIN_CONTRIBUICOES c'+
         ' WHERE c.tp_registro=1'+
         ' ORDER BY c.dta_vigencia_inicio DESC';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  // Cria Tabela de Salario Mnimo =============================================
  If DMVirtual.CDS_V_ParamSalMinimo.Active Then
   DMVirtual.CDS_V_ParamSalMinimo.Close;

  DMVirtual.CDS_V_ParamSalMinimo.CreateDataSet;
  DMVirtual.CDS_V_ParamSalMinimo.Open;

  DMVirtual.CDS_V_ParamSalMinimo.Data:=DMBelShop.CDS_BuscaRapida.Data;
  DMBelShop.CDS_BuscaRapida.Close;

  // Busca Valores da Curva ABC ================================================
  MySql:=' SELECT t.cod_aux Cod_Curva,'+
         ' Coalesce(t.des_aux,0)  Per_Curva,'+
         ' Coalesce(t.vlr_aux,0)  Qtd_Dias,'+
         ' Coalesce(t.vlr_aux1,0) Qtd_Min,'+
         ' Coalesce(t.des_aux1,0) Per_Corte'+
         ' FROM TAB_AUXILIAR t'+
         ' WHERE t.tip_aux=2'+
         ' ORDER BY t.cod_aux';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    // Curva A ------------------------------------------------------
    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Curva').AsString='1' Then
    Begin
      FrmSolicitacoes.EdtParamCurvaALimite.Value   :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Curva').AsInteger;
      FrmSolicitacoes.EdtParamCurvaADiasEst.Value  :=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Dias').AsInteger;
      FrmSolicitacoes.EdtParamCurvaAEstMinino.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Min').AsInteger;
      FrmSolicitacoes.EdtParamCurvaACorte.Value    :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Corte').AsInteger;
    End;

    // Curva B ------------------------------------------------------
    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Curva').AsString='2' Then
    Begin
      FrmSolicitacoes.EdtParamCurvaBLimite.Value   :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Curva').AsInteger;
      FrmSolicitacoes.EdtParamCurvaBDiasEst.Value  :=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Dias').AsInteger;
      FrmSolicitacoes.EdtParamCurvaBEstMinino.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Min').AsInteger;
      FrmSolicitacoes.EdtParamCurvaBCorte.Value    :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Corte').AsInteger;
    End;

    // Curva C ------------------------------------------------------
    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Curva').AsString='3' Then
    Begin
      FrmSolicitacoes.EdtParamCurvaCLimite.Value   :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Curva').AsInteger;
      FrmSolicitacoes.EdtParamCurvaCDiasEst.Value  :=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Dias').AsInteger;
      FrmSolicitacoes.EdtParamCurvaCEstMinino.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Min').AsInteger;
      FrmSolicitacoes.EdtParamCurvaCCorte.Value    :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Corte').AsInteger;
    End;

    // Curva D ------------------------------------------------------
    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Curva').AsString='4' Then
    Begin
      FrmSolicitacoes.EdtParamCurvaDLimite.Value   :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Curva').AsInteger;
      FrmSolicitacoes.EdtParamCurvaDDiasEst.Value  :=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Dias').AsInteger;
      FrmSolicitacoes.EdtParamCurvaDEstMinino.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Min').AsInteger;
      FrmSolicitacoes.EdtParamCurvaDCorte.Value    :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Corte').AsInteger;
    End;

    // Curva E ------------------------------------------------------
    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Curva').AsString='5' Then
    Begin
      FrmSolicitacoes.EdtParamCurvaELimite.Value   :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Curva').AsInteger;
      FrmSolicitacoes.EdtParamCurvaEDiasEst.Value  :=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Dias').AsInteger;
      FrmSolicitacoes.EdtParamCurvaEEstMinino.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Qtd_Min').AsInteger;
      FrmSolicitacoes.EdtParamCurvaECorte.Value    :=DMBelShop.CDS_BuscaRapida.FieldByName('Per_Corte').AsInteger;
    End;

    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;

  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmSolicitacoes, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

//  FrmSolicitacoes.Ts_ParamIRRF.TabVisible:=False;
//  FrmSolicitacoes.Ts_ParamINSS.TabVisible:=False;
//  FrmSolicitacoes.Ts_ParamConsisNFeOC.TabVisible:=False;

  //============================================================================
  // Libera Somente Parametro de Lojas para Reposio ==========================
  //============================================================================
  MySql:=' SELECT v.des_componente'+
         ' FROM PS_VISUAL_OBJETOS v'+
         ' WHERE v.des_modulo='+QuotedStr('FrmSolicitacoes')+
         ' AND   v.cod_usuario='+Cod_Usuario;
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;
  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    If DMBelShop.CDS_BuscaRapida.RecNo=1 Then
     TabSheetInvisivel(FrmSolicitacoes);

    TabSheetVisivel(FrmSolicitacoes, DMBelShop.CDS_BuscaRapida.FieldByName('des_componente').AsString);

    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;
  // Libera Somente Parametro de Lojas para Reposio ==========================
  //============================================================================

  // Apresenta Parametros (Direto em Reposies Automticas) ===================
  FrmSolicitacoes.Cbx_ParamLojaNecesChange(Self);
  bgProcessar:=False;
  FrmSolicitacoes.ShowModal;

  // Limpa Lojas Necessidades ==================================================
  DMVirtual.CDS_V_ParamLojaNeces.Close;
  DMVirtual.CDS_V_Produtos.Close;
  DMVirtual.CDS_V_Fornecedores.Close;
  DMVirtual.CDS_V_EstoqueLojas.Close;

  If bgProcessar Then
  Begin
    // Verifica se Transao esta Ativa
    If DMBelShop.SQLC.InTransaction Then
     DMBelShop.SQLC.Rollback(TD);

    // Monta Transacao =========================================================
    TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
    TD.IsolationLevel:=xilREADCOMMITTED;
    DMBelShop.SQLC.StartTransaction(TD);
    Try
      Screen.Cursor:=crAppStart;
      DateSeparator:='.';
      DecimalSeparator:='.';

      // Acerta Periodo de Calculo de Comisso de Profissionais ================
      MySql:=' UPDATE SAL_PROFISSIONAIS'+
             ' Set dia_periodo_ini_com='+QuotedStr(FrmSolicitacoes.Cbx_ParamComProfDiaIni.Text)+
             ' , dia_periodo_fim_com='+QuotedStr(FrmSolicitacoes.Cbx_ParamComProfDiaFim.Text)+
             ' Where Tip_Pessoa=''P''';
      DMBelShop.SQLC.Execute(MySql,nil,nil);

      // Grava Parametros ======================================================
      sgValor:='0';
      If Trim(DMBelShop.CDS_ParametrosSisVLR_TAXASINDICATO.AsString)<>'' Then
       sgValor:=DMBelShop.CDS_ParametrosSisVLR_TAXASINDICATO.AsString;

      MySql:=' UPDATE PARAMETROS'+
             ' Set NUM_DIAS_CONCILIA='+
             QuotedStr(DMBelShop.CDS_ParametrosSisNUM_DIAS_CONCILIA.AsString)+
             ', IND_CONSISTE_NFE='+
             QuotedStr(FrmSolicitacoes.Ckb_ParamConsNfeOCSolic.Caption)+
             ', HR_IN_CONS_NFE_OC='+
             QuotedStr(DMBelShop.CDS_ParametrosSisHR_IN_CONS_NFE_OC.AsString)+
             ', DIA_INI_COMISSAO_PROF='+
             QuotedStr(FrmSolicitacoes.Cbx_ParamComProfDiaIni.Text)+
             ', DIA_FIM_COMISSAO_PROF='+
             QuotedStr(FrmSolicitacoes.Cbx_ParamComProfDiaFim.Text)+
             ', MES_COBRANCA_SINDICATO='+
             QuotedStr(DMBelShop.CDS_ParametrosSisMES_COBRANCA_SINDICATO.AsString)+
             ', POS_COBRANCA_SINDICATO='+
             QuotedStr(DMBelShop.CDS_ParametrosSisPOS_COBRANCA_SINDICATO.AsString)+
             ', DIA_COBRANCA_SINDICATO='+
             QuotedStr(DMBelShop.CDS_ParametrosSisDIA_COBRANCA_SINDICATO.AsString)+
             ', VLR_TAXASINDICATO='+QuotedStr(sgValor);
      DMBelShop.SQLC.Execute(MySql,nil,nil);

      If FrmSolicitacoes.Ckb_ParamTaxaSindVlrTaxa.Checked Then
      Begin
        If msg('Deseja Realmente Alterar os Valores'+cr+'de Taxa de Sindicato Para'+cr+'Todos os Profissionais ??','C')=1 Then
        Begin
          MySql:=' UPDATE sal_profissionais p'+
                 ' SET p.vlr_taxa_sindicato='+QuotedStr(sgValor)+
                 ' WHERE p.tip_pessoa='+QuotedStr('P')+
                 ' AND   TRIM(p.num_sindicato)<>'''''+
                 ' AND p.ind_taxa_sindicato='+QuotedStr('SIM');
          DMBelShop.SQLC.Execute(MySql,nil,nil);
        End; // If msg('Deseja Realmente Alterar Os Valores de Taxa de Sindicato Para Todos os Profissinais ??','C')=1 Then
      End; // If FrmSolicitacoes.Ckb_ParamTaxaSindVlrTaxa.Checked Then

      // Grava Salario Minino ==================================================
      DMVirtual.CDS_V_ParamSalMinimo.First;
      While Not DMVirtual.CDS_V_ParamSalMinimo.Eof do
      Begin
        If Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)='Incluido' Then
        Begin
          MySql:=' Insert into FIN_CONTRIBUICOES ('+
                 ' NUM_SEQ, TP_REGISTRO, SEQ_REG, VLR_INICIAL,'+
                 ' DTA_VIGENCIA_INICIO, DTA_VIGENCIA_FINAL, USU_INCLUI)'+
                 ' Values ('+
                 ' (select Coalesce(max(c.num_seq)+1 ,1) from fin_contribuicoes c),'+
                 QuotedStr('1')+', '+
                 QuotedStr('1')+', '+
                 ' :VLR_INICIAL,'+
                 ' :DTA_VIGENCIA_INICIO, :DTA_VIGENCIA_FINAL,'+
                 QuotedStr(Cod_Usuario)+')'
        End; // Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)='Incluido' Then

        If Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)='Alterado' Then
        Begin
          MySql:=' Update FIN_CONTRIBUICOES Set'+
                 ' VLR_INICIAL=:VLR_INICIAL,'+
                 ' DTA_VIGENCIA_INICIO=:DTA_VIGENCIA_INICIO,'+
                 ' DTA_VIGENCIA_FINAL=:DTA_VIGENCIA_FINAL,'+
                 ' USU_ALTERA='+QuotedStr(Cod_Usuario)+', '+
                 ' DTA_ALTERA=current_date'+

                 ' Where NUM_SEQ='+DMVirtual.CDS_V_ParamSalMinimoNUM_SEQ.AsString;
        End; // Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)='Alterado' Then

        If (Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)<>'Excluido') and
           (Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)<>'NORMAL')   Then
        Begin
          DMBelShop.SQLQuery1.Close;
          DMBelShop.SQLQuery1.SQL.Clear;
          DMBelShop.SQLQuery1.SQL.Add(MySql);
          DMBelShop.SQLQuery1.Params.ParamByName('VLR_INICIAL').AsCurrency:=
                           DMVirtual.CDS_V_ParamSalMinimoVLR_INICIAL.AsCurrency;
          DMBelShop.SQLQuery1.Params.ParamByName('DTA_VIGENCIA_INICIO').AsDate:=
                   DMVirtual.CDS_V_ParamSalMinimoDTA_VIGENCIA_INICIO.AsDateTime;
          DMBelShop.SQLQuery1.Params.ParamByName('DTA_VIGENCIA_FINAL').AsDate:=
                    DMVirtual.CDS_V_ParamSalMinimoDTA_VIGENCIA_FINAL.AsDateTime;

          DMBelShop.SQLQuery1.ExecSQL;

        End; // If (Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)='Excluido') and...

        If Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)='Excluido' Then
        Begin
          MySql:=' Delete From FIN_CONTRIBUICOES'+
                 ' Where Num_Seq='+DMVirtual.CDS_V_ParamSalMinimoNUM_SEQ.AsString;
          DMBelShop.SQLC.Execute(MySql,nil,nil);
        End; // Trim(DMVirtual.CDS_V_ParamSalMinimoIND_SIT.AsString)='Excluido' Then

        DMVirtual.CDS_V_ParamSalMinimo.Next;
      End; // While Not DMVirtual.CDS_V_ParamSalMinimo.Eof do
      DMVirtual.CDS_V_ParamSalMinimo.Close;

      // Salva Valores da Curva ABC ============================================
      MySql:=' DELETE From TAB_AUXILIAR'+
             ' WHERE tip_aux=2';
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      // Curva A ----------------------------------------------------
      MySql:=' INSERT into TAB_AUXILIAR (TIP_AUX, COD_AUX, DES_AUX, VLR_AUX, VLR_AUX1, DES_AUX1)'+
             ' VALUES (2, 1, '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaALimite.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaADiasEst.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaAEstMinino.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaACorte.AsInteger))+')';
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      // Curva B ----------------------------------------------------
      MySql:=' INSERT into TAB_AUXILIAR (TIP_AUX, COD_AUX, DES_AUX, VLR_AUX, VLR_AUX1, DES_AUX1)'+
             ' Values (2, 2, '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaBLimite.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaBDiasEst.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaBEstMinino.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaBCorte.AsInteger))+')';
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      // Curva C ----------------------------------------------------
      MySql:=' INSERT into TAB_AUXILIAR (TIP_AUX, COD_AUX, DES_AUX, VLR_AUX, VLR_AUX1, DES_AUX1)'+
             ' Values (2, 3, '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaCLimite.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaCDiasEst.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaCEstMinino.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaCCorte.AsInteger))+')';
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      // Curva D ----------------------------------------------------
      MySql:=' INSERT into TAB_AUXILIAR (TIP_AUX, COD_AUX, DES_AUX, VLR_AUX, VLR_AUX1, DES_AUX1)'+
             ' Values (2, 4, '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaDLimite.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaDDiasEst.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaDEstMinino.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaDCorte.AsInteger))+')';
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      // Curva E ----------------------------------------------------
      MySql:=' INSERT into TAB_AUXILIAR (TIP_AUX, COD_AUX, DES_AUX, VLR_AUX, VLR_AUX1, DES_AUX1)'+
             ' Values (2, 5, '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaELimite.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaEDiasEst.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaEEstMinino.AsInteger))+', '+
             QuotedStr(IntToStr(FrmSolicitacoes.EdtParamCurvaECorte.AsInteger))+')';
      DMBelShop.SQLC.Execute(MySql, nil, nil);

      // Atualiza Transacao ====================================================
      DMBelShop.SQLC.Commit(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

    Except
      on e : Exception do
      Begin
        // Abandona Transacao =====================================
        DMBelShop.SQLC.Rollback(TD);

        DateSeparator:='/';
        DecimalSeparator:=',';
        Screen.Cursor:=crDefault;

        MessageBox(Handle, pChar('PARAMETROS No Foram Salvos !!'+cr+cr+'Erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
        exit;
      End; // on e : Exception do
    End; // Try
  End; // If bgProcessar Then
  DMBelShop.CDS_ParametrosSIS.CancelUpdates;
  DMBelShop.CDS_ParametrosSIS.Close;

  FreeAndNil(FrmSolicitacoes);
end;

procedure TFrmBelShop.Dbg_ConEmpresasEnter(Sender: TObject);
begin
 // Desabilita Mouse No Grid ===================================================
 Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_ConEmpresasExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_GeraOCProdutosExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_GeraOCProdutosEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_GeraOCEditaProdutosExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_GeraOCEditaProdutosEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_EstFisFinanEmpresaEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_EstFisFinanEmpresaExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanGrFinanceiroExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanGrFinanceiroEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanDemonsResultadoEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanDemonsResultadoExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutEmpresasEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutEmpresasExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanMLFornEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FinanMLFornExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FiltroGruposProdutosExit(Sender: TObject);
begin
  // Habilita Mouse No Grid ===================================================
  Application.OnMessage:=HabilitaScrollMouse;

end;

procedure TFrmBelShop.Dbg_FiltroGruposProdutosEnter(Sender: TObject);
begin
  // Desabilita Mouse No Grid ===================================================
  Application.OnMessage:=DesabilitaScrollMouse;

end;

procedure TFrmBelShop.SubMenuEmpConexoesSairClick(Sender: TObject);
begin
  If Not MandaFechar Then
   Exit;

  bgSair:=False;
//  If msg('Deseja Realmente Sair do SISTEMA ???','C')=2 Then
  If Application.MessageBox('Deseja Realmente Sair do SISTEMA ???', 'ATENO !!', 36) = IdNo Then
   Begin
     Exit;
   End
  Else
   Begin
     Close;
   End;
//     bgSair:=True;
//
//     Screen.Cursor:=crAppStart;
//
//     // Painel de Processamento em Tempo de Execuo ==============================
//     Try
//       OdirPanApres.Caption:='AGUARDE !! Desconectando Empresas...';
//       OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
//       OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
//       OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
//       OdirPanApres.Visible:=True;
//       Refresh;
//     Except
//     End;
//
//     // Desconecta Bancos e Encerra Programa ===================================
//     DMBelShop.Desconecta;
//
//     OdirPanApres.Visible:=False;
//
//     Screen.Cursor:=crDefault;
//
//     Close;
//   End;


end;

procedure TFrmBelShop.SubMenuEmpresasConexoesClick(Sender: TObject);
begin
  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  Bt_ConEmpresasUsuWindows.Visible:=(AnsiUpperCase(Des_Login)='ODIR');
  Button1.Visible:=(AnsiUpperCase(Des_Login)='ODIR');
  Button3.Visible:=(AnsiUpperCase(Des_Login)='ODIR');
  Button4.Visible:=(AnsiUpperCase(Des_Login)='ODIR');
  Bt_AcertaPromocao.Visible:=(AnsiUpperCase(Des_Login)='ODIR');

  OrderGrid:='';
  SelecionaTabSheet(Ts_ConexaoEmpresas);
  DMBelShop.CDS_Empresa.IndexFieldNames:='';
  DMBelShop.CDS_Empresa.Open;
  Dbg_ConEmpresas.SetFocus;

end;

procedure TFrmBelShop.SubMenuSalaoMovimentosDebitosRHClick(Sender: TObject);
begin
  FrmSalao:=TFrmSalao.Create(Self);
  FrmSalao.CorCaptionForm.FormCaption:='Movimentos (RH) Dbitos/Crditos';

  TabSheetInvisivel(FrmSalao);
  FrmSalao.Ts_ProfMovtosRH.TabVisible:=True;
  FrmSalao.PC_SalaoChange(Self);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmSalao, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Permisses de Visualizao ================================================
  PermissaoVisual(FrmSalao.Ts_ProfMovtosRH);

  FrmSalao.OutLook_ProfMovtosRH.ActivePageIndex:=0;
  FrmSalao.ShowModal;

  FreeAndNil(FrmSalao);
end;

procedure TFrmBelShop.SubMenuControledeKitzClick(Sender: TObject);
begin
  FrmControleKits:=TFrmControleKits.Create(Self);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmControleKits, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  FrmControleKits.ShowModal;

  FreeAndNil(FrmControleKits);
end;

procedure TFrmBelShop.SubMenuSolicitacaoCompraLojaClick(Sender: TObject);
Var
  i: Integer;
  MySql, s: String;
begin
  FechaTudo;

  If Trim(sgCodLojaUnica)='' Then
  Begin
    msg('Opo Disponvel Somente para Lojas !!','A');
    Exit;
  End;

  OrderGrid:='';

  // Acerta Meses de Calculo ===================================================
  InicializaMeses;
  FrmGeraPedidosComprasLojas.CB_Mes1.ItemIndex:=CB_Mes1.ItemIndex;
  FrmGeraPedidosComprasLojas.ME_Ano1.Text:=ME_Ano1.Text;
  FrmGeraPedidosComprasLojas.CB_Mes2.ItemIndex:=CB_Mes2.ItemIndex;
  FrmGeraPedidosComprasLojas.ME_Ano2.Text:=ME_Ano2.Text;
  FrmGeraPedidosComprasLojas.CB_Mes3.ItemIndex:=CB_Mes3.ItemIndex;
  FrmGeraPedidosComprasLojas.ME_Ano3.Text:=ME_Ano3.Text;
  FrmGeraPedidosComprasLojas.CB_Mes4.ItemIndex:=CB_Mes4.ItemIndex;
  FrmGeraPedidosComprasLojas.ME_Ano4.Text:=ME_Ano4.Text;

  // Inicializa Tabelas Virtuais para Filtros ==================================
  try
    DMVirtual.CDS_V_Produtos.CreateDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  Except
    DMVirtual.CDS_V_Produtos.EmptyDataSet;
    DMVirtual.CDS_V_Produtos.Open;
  End;

  try
    DMVirtual.CDS_V_Fornecedores.CreateDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  Except
    DMVirtual.CDS_V_Fornecedores.EmptyDataSet;
    DMVirtual.CDS_V_Fornecedores.Open;
  End;
  MontaSelectFornecedores;

  try
    DMVirtual.CDS_V_GruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  Except
    DMVirtual.CDS_V_GruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_GruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_SubGruposProdutos.CreateDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  Except
    DMVirtual.CDS_V_SubGruposProdutos.EmptyDataSet;
    DMVirtual.CDS_V_SubGruposProdutos.Open;
  End;

  try
    DMVirtual.CDS_V_Aplicacao.CreateDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  Except
    DMVirtual.CDS_V_Aplicacao.EmptyDataSet;
    DMVirtual.CDS_V_Aplicacao.Open;
  End;

  try
    DMVirtual.CDS_V_FamiliaPrecos.CreateDataSet;
    DMVirtual.CDS_V_FamiliaPrecos.Open;
  Except
    DMVirtual.CDS_V_FamiliaPrecos.EmptyDataSet;
    DMVirtual.CDS_V_FamiliaPrecos.Open;
  End;

  try
    DMVirtual.CDS_V_GrupoST.CreateDataSet;
    DMVirtual.CDS_V_GrupoST.Open;
  Except
    DMVirtual.CDS_V_GrupoST.EmptyDataSet;
    DMVirtual.CDS_V_GrupoST.Open;
  End;

  // Cadastro de Grupos ST =====================================================
  try
    DMVirtual.CDS_GruposST.CreateDataSet;
    DMVirtual.CDS_GruposST.Open;
  Except
    DMVirtual.CDS_GruposST.EmptyDataSet;
    DMVirtual.CDS_GruposST.Open;
  End;

  For i:=0 to 20 do
  Begin
    If i= 0 Then s:='No usa';
    If i= 1 Then s:='Autopeas';
    If i= 2 Then s:='Rao';
    If i= 3 Then s:='Colches';
    If i= 4 Then s:='Cosmticos';
    If i= 5 Then s:='Arroz beneficiado';
    If i= 6 Then s:='Correias de Transmisso e Rolamentos';
    If i= 7 Then s:='Tintas e Vernizes';
    If i= 8 Then s:='Sucos de Frutas e Bebidas no Alcolicas';
    If i= 9 Then s:='Ferramentas';
    If i=10 Then s:='Materiais Eltricos';
    If i=11 Then s:='Mat. Construo, Acabamento, Bricolagem ou Adorno';
    If i=12 Then s:='Bicicletas';
    If i=13 Then s:='Brinquedos';
    If i=14 Then s:='Material de Limpeza';
    If i=15 Then s:='Produtos Alimentcios';
    If i=16 Then s:='Artefatos de Uso Domstico';
    If i=17 Then s:='Bebidas Quentes';
    If i=18 Then s:='Artigos de Papelaria';
    If i=19 Then s:='Instrumentos Musicais';
    If i=20 Then s:='Prod. Eletronicos, Eletroeletronicos, Eletrodomsticos';

    DMVirtual.CDS_GruposST.Insert;
    DMVirtual.CDS_GruposSTCod_GrupoST.AsInteger:=i;
    DMVirtual.CDS_GruposSTDes_GrupoST.AsString:=AnsiUpperCase(s);
    DMVirtual.CDS_GruposST.Post;
  End; // For i:=1 to 20 do

  // Inicializa Variaveis ======================================================
  FrmGeraPedidosComprasLojas.Edt_OCTotProdutos.Value:=0;

  // Inicializa Data de Pesquisa ===============================================
  FrmGeraPedidosComprasLojas.DtEdt_GeraOCDataDocto.Date:=DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);

  // Limite para Produtos Novos ================================================
  FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date:=PrimUltDia(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor),'P');
  FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date:=FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date-1;
  FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date:=PrimUltDia(FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date,'P');
  FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date:=FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date-1;
  FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date:=PrimUltDia(FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date,'P');
  FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date:=FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date-1;
  FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date:=PrimUltDia(FrmGeraPedidosComprasLojas.DtEdt_CalculoProdNovos.Date,'P');

  //============================================================================
  // PageControl de Filtros - INICIO ===========================================
  //============================================================================
  //-----------------------------------------------------------------
  // Filtro de Fornecedores -----------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFornecedor.Visible:=True;
  EdtFiltroCodForn.Enabled:=False;
  Bt_FiltroBuscaForn.Enabled:=False;
  // Curva ABC no Fornecedor
  Painel_FiltroOC.Visible:=True;
  // Obs para Utilizao no Movto de Comprovantes
  Label_MovtoComprovForn.Visible:=False;
  Label_MovtoComprovForn.Top:=Painel_FiltroOC.Top;

  //-----------------------------------------------------------------
  // Filtro de Produtos ---------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroProdutos.TabVisible:=False;
  // Filtor nao Produtos de No Compra
  Painel_FiltroNaoCompra.Parent:=Gb_FiltroFornecedor;
  Painel_FiltroNaoCompra.Visible:=True;
  // Filtro para Busca Pelo Nome
  Gb_CalculoFiltroNome.Visible:=False;
  EdtCalculoFiltroNome1.Clear;
  EdtCalculoFiltroNome2.Clear;
  EdtCalculoFiltroNome3.Clear;
  EdtCalculoFiltroNome4.Clear;

  //-----------------------------------------------------------------
  // Filtro de Grupos e SubGrupos -----------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupos.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Aplicaes dos Produtos ------------------------------
  //-----------------------------------------------------------------
  TS_FiltroAplicacao.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Familia de Preos ------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroFamiliaPreco.TabVisible:=False;

  //-----------------------------------------------------------------
  // Filtro de Grupos ST --------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroGrupoST.TabVisible:=False;

  //-----------------------------------------------------------------
  // Grupo de Comprovantes ------------------------------------------
  //-----------------------------------------------------------------
  TS_FiltroComprovantes.TabVisible:=False;

  //-----------------------------------------------------------------
  // Posiciona o PC_Filtros em seu Parent ---------------------------
  //-----------------------------------------------------------------
  PC_Filtros.Parent:=FrmGeraPedidosComprasLojas.Pan_OC;
  PC_Filtros.TabIndex:=0;
  PC_FiltrosChange(Self);
  //============================================================================
  // PageControl de Filtros - FIM ==============================================
  //============================================================================

  // Posiciona TabSheet ========================================================
  FrmGeraPedidosComprasLojas.PC_GeraOCApresentacao.TabIndex:=0;
  FrmGeraPedidosComprasLojas.PC_GeraOCApresentacaoChange(Self);

  FrmGeraPedidosComprasLojas.PC_OrdemCompra.TabIndex:=0;
  FrmGeraPedidosComprasLojas.PC_OrdemCompraChange(Self);

  FrmGeraPedidosComprasLojas.PC_GeraOCApresentacao.TabIndex:=0;
  FrmGeraPedidosComprasLojas.PC_GeraOCApresentacaoChange(Self);

  PC_Filtros.TabIndex:=0;

  // Curva ABC =================================================================
  Ckb_CalculoCurvaTodas.Checked:=True;
  Ckb_CalculoCurvaTodasClick(Self);

  // Tipo de Curva a Utilizar ==================================================
  Rb_CalculoTpCurvaABCLoja.Checked:=True;
  Rb_CalculoTpCurvaABCLojaClick(Self);

  // Apresentar Curvas Fora da Faixa Selecionada ===============================
  Ckb_CalculoApresCurvaFora.Checked:=True;
  Ckb_CalculoApresCurvaForaClick(Self);
  Rb_CalculoApresCurvaEstCom.Checked:=True;
  Rb_CalculoApresCurvaEstComClick(Self);
  Painel_FiltroOC.Visible:=False;

  // Abre TabSheet =============================================================
  FrmGeraPedidosComprasLojas.EdtGeraOCBuscaDocto.Value:=0;
  FrmGeraPedidosComprasLojas.Ts_ParametrosLojas.TabVisible:=False;

  // Lista de Preos
  MySql:=' SELECT l.codlista, l.nomelista'+
         ' FROM lista l'+
         ' WHERE EXISTS ('+
         '               SELECT first 1 lt.codlista, lt.nomelista, count(lp.codlista) Reg'+
         '               FROM lista lt, listapre lp'+
         '               WHERE lt.codlista=lp.codlista'+
         '               AND   Upper(lt.nomelista) not like ''%DESC%'''+
         '               AND   lt.codlista=l.codlista'+
         '               GROUP BY 1,2'+
         '               ORDER BY 3 desc)';
  IBQ_Matriz.Close;
  IBQ_Matriz.SQL.Clear;
  IBQ_Matriz.SQL.Add(MySql);
  IBQ_Matriz.Open;
  FrmGeraPedidosComprasLojas.EdtOCListaPreco.Text:=IBQ_Matriz.FieldByName('NomeLista').AsString;
  FrmGeraPedidosComprasLojas.EdtOCCodListaPreco.Text:=IBQ_Matriz.FieldByName('CodLista').AsString;

  sgCodListaPreco    :=IBQ_Matriz.FieldByName('CodLista').AsString;
  sgCodListaPrePadrao:=IBQ_Matriz.FieldByName('CodLista').AsString;
  sgDesListaPreco    :=IBQ_Matriz.FieldByName('nomelista').AsString;
  sgDesListaPrePadrao:=IBQ_Matriz.FieldByName('nomelista').AsString;

  IBQ_MPMS.Close;

  FrmGeraPedidosComprasLojas.Caption:=FrmGeraPedidosComprasLojas.Caption+' Bel_'+sgCodLojaUnica;
  FrmGeraPedidosComprasLojas.Lb_CalculoFTP.Caption:='FTP: '+sgFTPUsar;
  FrmGeraPedidosComprasLojas.ShowModal;

end;

procedure TFrmBelShop.Ckb_CalculoApresCurvaForaKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_CalculoApresCurvaForaClick(Self);
end;

procedure TFrmBelShop.SubMenuParmetrosdeLojasClick(Sender: TObject);
begin
  FechaTudo;

  bgSiga:=True;
  If Des_Usuario='ODIR' Then
  Begin
    If msg('Deseja Atualizar Parmetros da LOJA ??','C')=2 Then
     bgSiga:=False;
  End;

  If (Trim(sgCodLojaUnica)<>'') And (bgSiga) Then
  Begin
    If msg('Deseja Atualizar Parmetros da LOJA ??','C')=2 Then
     Exit;

    LiberaMenu(False);
    OdirPanApres.Caption:='AGUARDE !! Atualizando Parmetros Enviados Pela MATRIZ ...';
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
    OdirPanApres.Visible:=True;
    Refresh;

    If Not FrmGeraPedidosComprasLojas.LojaBuscaParametros Then
     msg(sgMensagem,'A');

    OdirPanApres.Visible:=False;
    LiberaMenu(True);

    Exit;
  End;

  // Inicializa Parametros das lojas ===========================================
  OdirPanApres.Caption:='AGUARDE !! Localizando Parmetros das Lojas...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Screen.Cursor:=crAppStart;
  Refresh;

  If Not FrmGeraPedidosComprasLojas.ParametrosEntrada Then
  Begin
    OdirPanApres.Visible:=False;
    Screen.Cursor:=crDefault;
    Refresh;

    msg('Erro ao Localizar Parmetros das Lolas !!'+cr+cr+'Favor Entrar em Contato com o Odir !!','A');

    FreeAndNil(DMVirtual.gCDS_V1);
    FreeAndNil(DMVirtual.gDS_V1);
    FreeAndNil(DMVirtual.gCDS_V2);
    FreeAndNil(DMVirtual.gDS_V2);

    Exit;
  End;
  OdirPanApres.Visible:=False;
  Screen.Cursor:=crDefault;
  Refresh;

  // Show no Form ==============================================================
  FrmGeraPedidosComprasLojas.ShowModal;

  FreeAndNil(DMVirtual.gCDS_V1);
  FreeAndNil(DMVirtual.gDS_V1);

  FreeAndNil(DMVirtual.gCDS_V2);
  FreeAndNil(DMVirtual.gDS_V2);

end;

procedure TFrmBelShop.FormActivate(Sender: TObject);
begin
  If Not bgOnActivate Then
  Begin
    If Application.Terminated Then
    Begin
      Exit;
    End;

    If sgCodLojaUnica<>'' Then
    Begin
      LiberaMenu(False);
      OdirPanApres.Caption:='AGUARDE !! Atualizando Parmetros Enviados Pela MATRIZ ...';
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
      OdirPanApres.Visible:=True;
      Refresh;

      CorCaptionForm.FormCaption:=CorCaptionForm.FormCaption+' - Bel_'+sgCodLojaUnica;

      // Busca Parametros de Lojas =================================================
      If Des_Usuario='ODIR' Then
       Begin
         If msg('Busca Parametros ??','C')=1 Then
         Begin
           If Not FrmGeraPedidosComprasLojas.LojaBuscaParametros Then
           Begin
             OdirPanApres.Visible:=False;
             msg(sgMensagem,'A');
             Application.Terminate;
             Exit;
           End;
         End; // If msg('Busca Parametros ??','C')=1 Then
       End
      Else // If Des_Usuario='ODIR' Then
       Begin
         If Not FrmGeraPedidosComprasLojas.LojaBuscaParametros Then
         Begin
           OdirPanApres.Visible:=False;
           msg(sgMensagem,'A');
           Application.Terminate;
           Exit;
         End;
       End; // If Des_Usuario='ODIR' Then

      OdirPanApres.Visible:=False;
      LiberaMenu(True);
    End; // If sgCodLojaUnica<>'' Then

    bgOnActivate:=True;
  End; // If Not bgOnActivate Then
end;

procedure TFrmBelShop.Panel5DblClick(Sender: TObject);
begin

  If bgInd_Admin Then
  Begin
    If Mem_Conexoes.Visible Then
     Mem_Conexoes.Visible:=False
    Else
     Mem_Conexoes.Visible:=True;
  End; // If bgInd_Admin Then
end;

procedure TFrmBelShop.SubMenuSalaoPlanoSaudeClick(Sender: TObject);
begin
  FrmSalao:=TFrmSalao.Create(Self);
  FrmSalao.CorCaptionForm.FormCaption:='Cadastro de Plano de Sade';

  TabSheetInvisivel(FrmSalao);
  FrmSalao.Ts_PlanoSaude.TabVisible:=True;

  FrmSalao.ShowModal;

  FreeAndNil(FrmSalao);
end;

procedure TFrmBelShop.Sbt_FinanMLResFinalClick(Sender: TObject);
begin
  msg('No Grid Acima, Selecione o Item'+cr+cr+'e Tecle <Duplo Clik> !!','A');
  Dbg_FinanMLResultado.SetFocus;
end;

procedure TFrmBelShop.Dbg_FinanMLResultadoDblClick(Sender: TObject);
Var
  i: Integer;
begin
 If Not DMVirtual.CDS_V_MargLucroBonifRes.IsEmpty Then
 Begin
   If (Trim(DMVirtual.CDS_V_MargLucroBonifResLOJA.AsString)<>'') And (Trim(DMVirtual.CDS_V_MargLucroBonifResCODCOMPROVANTE.AsString)<>'') Then
   Begin
     i:=DMVirtual.CDS_V_MargLucroBonifRes.RecNo;
     // Atualiza Valor Total e Retido para no Calculo =========================
     DMVirtual.CDS_V_MargLucroBonifRes.Edit;

     If DMVirtual.CDS_V_MargLucroBonifResTOT_VALRETIDO.AsCurrency=0 Then
      Begin
        DMVirtual.CDS_V_MargLucroBonifResTOT_VALRETIDO.AsCurrency:=
                       DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency;
        DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency:=0;
      End
     Else
      Begin
        DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency:=
                      DMVirtual.CDS_V_MargLucroBonifResTOT_VALRETIDO.AsCurrency;
        DMVirtual.CDS_V_MargLucroBonifResTOT_VALRETIDO.AsCurrency:=0;
      End; // If DMVirtual.CDS_V_MargLucroBonifResTOT_VALRETIDO.AsCurrency<>0 Then
     DMVirtual.CDS_V_MargLucroBonifRes.Edit;

     // Recalcula ==============================================================
     cgVlrAcumulado1:=0;
     DMVirtual.CDS_V_MargLucroBonifRes.First;
     DMVirtual.CDS_V_MargLucroBonifRes.DisableControls;
     While Not DMVirtual.CDS_V_MargLucroBonifRes.Eof do
     Begin
       If Trim(DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString)='Entrada' Then
        cgVlrAcumulado1:=cgVlrAcumulado1+DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency;

       If Trim(DMVirtual.CDS_V_MargLucroBonifResSINALESTOQUE.AsString)='Sada' Then
        cgVlrAcumulado1:=cgVlrAcumulado1-DMVirtual.CDS_V_MargLucroBonifResTOT_VALTOTAL.AsCurrency;

       DMVirtual.CDS_V_MargLucroBonifRes.Next;
     End; // While Not DMVirtual.CDS_V_MargLucroBonifRes.Eof do
     DMVirtual.CDS_V_MargLucroBonifRes.EnableControls;
     DMVirtual.CDS_V_MargLucroBonifRes.RecNo:=i;

     DMVirtual.CDS_V_MargLucroFinal.Locate('Desc_Tipo','Total Faturamento',[]);
     cgVlrAcumulado2:=DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency;

     DMVirtual.CDS_V_MargLucroFinal.Locate('Desc_Tipo','Total Bonif/Ajustes/Perdas',[]);
     DMVirtual.CDS_V_MargLucroFinal.Edit;
     DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency:=cgVlrAcumulado1;
     DMVirtual.CDS_V_MargLucroFinal.Post;

     DMVirtual.CDS_V_MargLucroFinal.Locate('Desc_Tipo','Total Final',[]);
     DMVirtual.CDS_V_MargLucroFinal.Edit;
     DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency:=cgVlrAcumulado2-cgVlrAcumulado1;

     If Rb_MLTpCalculoMargem.Checked Then
      Begin
        DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency:=((
                            DMVirtual.CDS_V_MargLucroFinalTot_Vendas.AsCurrency-
                           DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency)/
                       DMVirtual.CDS_V_MargLucroFinalTot_Vendas.AsCurrency)*100;
     End
    Else
     Begin
       If DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency<>0 Then
        DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency:=(((
                       DMVirtual.CDS_V_MargLucroFinalTot_Vendas.AsCurrency*100)/
                       DMVirtual.CDS_V_MargLucroFinalTot_Custos.AsCurrency)-100)
       Else
        DMVirtual.CDS_V_MargLucroFinalPer_Margem.AsCurrency:=100.00;
     End;
     DMVirtual.CDS_V_MargLucroFinal.Post;

   End; //    If (Trim(DMVirtual.CDS_V_MargLucroBonifResLOJA.AsString)<>'') And (Trim(DMVirtual.CDS_V_MargLucroBonifResCODCOMPROVANTE.AsString)<>'') Then
 End; // If Not DMVirtual.CDS_V_MargLucroBonifRes.IsEmpty Then
end;

procedure TFrmBelShop.ApplicationEvents1Message(var Msg: tagMSG; var Handled: Boolean);
var
  Sentido: SmallInt;
begin
  // primeiramente verificamos se  o evento a ser tratado...
  If Msg.message = WM_MOUSEWHEEL then
  Begin
//    If ActiveControl is TDBGrid then // If Somente DBGRID *** Testa se Classe  TDBGRID
//    Begin
      Msg.message := WM_KEYDOWN;
      Msg.lParam := 0;
      Sentido := HiWord(Msg.wParam);
      if Sentido > 0 then
       Msg.wParam := VK_UP
      else
       Msg.wParam := VK_DOWN;
//    End; // If ActiveControl is TDBGrid then // If Somente DBGRID *** Testa se Classe  TDBGRID
  End; // if Msg.message = WM_MOUSEWHEEL then
end;

procedure TFrmBelShop.Dbg_FinanMargemLucroEnter(Sender: TObject);
begin
  ApplicationEvents1.OnActivate:=Dbg_FinanMargemLucroEnter;
  Application.OnMessage := ApplicationEvents1Message;
  ApplicationEvents1.Activate;
end;

procedure TFrmBelShop.Bt_GeraOCDocSeparacaoClick(Sender: TObject);
Var
  sNrDocto: String;
  MySql: String;
  i: Integer;
  bOBS, bSiga: Boolean;
  sDtaGeracao, sCodLoja: String;
  dDta: TDate;
Begin
  If not (PC_GeraOCApresentacao.ActivePage=Ts_GeraOCOrdensCompra) Then
   Exit;

  Dbg_GeraOCTotalGeral.SetFocus;

  If DMBelShop.CDS_AComprarOCs.IsEmpty Then
   Exit;

  bSiga:=True;
  DMBelShop.CDS_AComprarOCs.First;
  While Not DMBelShop.CDS_AComprarOCs.Eof do
  Begin
    If (DMBelShop.CDS_AComprarOCsGERAR.AsString='S') And (Trim(DMBelShop.CDS_AComprarOCsNUM_OC_GERADA.AsString)<>'') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='TR') Then
    Begin
      bSiga:=False;
      DMRelatorio.ImpressaoRomaneioSeparacao(DMBelShop.CDS_AComprarOCsNUM_DOCUMENTO.AsString,
                                             DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString,
                                             DMBelShop.CDS_AComprarOCsNUM_OC_GERADA.AsString);
    End; // If (Trim(DMBelShop.CDS_AComprarOCsNUM_OC_GERADA.AsString)<>'') And (DMBelShop.CDS_AComprarOCsTIPO.AsString='TR') Then

    DMBelShop.CDS_AComprarOCs.Next;
  End; // While Not DMBelShop.CDS_AComprarOCs.Eof do
  DMBelShop.CDS_AComprarOCs.First;
  sgTipoImpressao:='';

  If Not bSiga Then
   Exit;

  // Verifica se Existe Docs Para Gerar ========================================
  i:=0;
  DMBelShop.CDS_AComprarOCs.First;
  While Not DMBelShop.CDS_AComprarOCs.Eof do
  Begin
    If (DMBelShop.CDS_AComprarOCsGERAR.AsString='S') and (DMBelShop.CDS_AComprarOCsTIPO.AsString='TR')Then
    Begin
      i:=1;
      Break;
    End;

    DMBelShop.CDS_AComprarOCs.Next;
  End;
  DMBelShop.CDS_AComprarOCs.First;

  If i=0 Then
  Begin
    msg('Favor Selecionar a Empresa/Filial'+cr+'para o Romaneio de Separao !!','A');
    Dbg_GeraOCTotalGeral.SetFocus;
    Exit;
  End;

  MessageBox(Handle, pChar('Romaneios Gerados da Mesma Loja'+cr+cr+'Ficaram Todos no Mesmo Documento !!'), 'ATENO !!', MB_ICONINFORMATION);

  If msg('Deseja Realmente GERAR'+cr+cr+'Romaneio para Separao no CD  ??','C')=2 Then
   Exit;

  // Observao e Gerao de Romaneio ==========================================
  bOBS:=False;
  If msg('Deseja Informar OBSERVAES'+cr+cr+'No(s) ROMANEIO(S) ??','C')=1 Then
   bOBS:=True;

  While Not DMBelShop.CDS_AComprarOCs.Eof do
  Begin
    Refresh;

    If DMBelShop.CDS_AComprarOCsGERAR.AsString='S' Then
    Begin
      bgProcessar:=True;

      // Solicita Observao ===================================================
      If bOBS Then
      Begin
        bgProcessar:=False;

        MySql:=' Select First 1 oc.OBS_OC'+
               ' From OC_COMPRAR oc'+
               ' Where oc.qtd_acomprar>0'+
               ' And   oc.qtd_transf>0'+
               ' And   oc.ind_oc_gerada=''N'''+
               ' And   oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
               ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
               ' And   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
               ' And   oc.cod_fornecedor='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString);
        DMBelShop.CDS_Busca.Close;
        DMBelShop.SDS_Busca.CommandText:=MySql;
        DMBelShop.CDS_Busca.Open;

        // Apresenta Observao ---------------------------------------
        FrmOCObservacao:=TFrmOCObservacao.Create(Self);
        FrmOCObservacao.Caption:='Observao no Romaneio de Separao';
        FrmOCObservacao.Gb_OCObsApresenta.Caption:='Romaneio de Separao';
        FrmOCObservacao.Lab_Vlr_OC.Caption:='Valor Romaneio';
        FrmOCObservacao.Mem_OCObsObservacao.Lines.Add(Trim(DMBelShop.CDS_Busca.FieldByName('OBS_OC').AsString));
        DMBelShop.CDS_Busca.Close;

        FrmOCObservacao.ShowModal;
      End; // If bOBS Then

      // Atualiza Observao ===================================================
      If bgProcessar Then
       Begin
         // Verifica se Transao esta Ativa
         If DMBelShop.SQLC.InTransaction Then
          DMBelShop.SQLC.Rollback(TD);

         // Monta Transacao ====================================================
         TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
         TD.IsolationLevel:=xilREADCOMMITTED;
         DMBelShop.SQLC.StartTransaction(TD);
         Try // Try Atualiza
           Screen.Cursor:=crAppStart;
           DateSeparator:='.';
           DecimalSeparator:='.';

           // Conecta MPMS
           ConectaMPMS;

           // Busca Numero do Romaneio
           dDta:=DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);
           sNrDocto:=IntToStr(YearOf(dDta));

           If MonthOf(dDta)<10 Then
            sNrDocto:=sNrDocto+'0'+IntToStr(MonthOf(dDta))
           Else
            sNrDocto:=sNrDocto+IntToStr(MonthOf(dDta));

           If DayOf(dDta)<10 Then
            sNrDocto:=sNrDocto+'0'+IntToStr(DayOf(dDta))
           Else
            sNrDocto:=sNrDocto+IntToStr(DayOf(dDta));

           MySql:=' SELECT oc.Num_Seq, oc.Cod_Item'+
                  ' FROM OC_COMPRAR oc'+
                  ' WHERE oc.qtd_acomprar>0'+
                  ' AND   oc.qtd_transf>0'+
                  ' AND   oc.ind_oc_gerada=''N'''+
                  ' AND   oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
                  ' AND   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
                  ' And   oc.cod_empresa='+ QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
                  ' And   oc.cod_fornecedor='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString);
           DMBelShop.CDS_Busca.Close;
           DMBelShop.SDS_Busca.CommandText:=MySql;
           DMBelShop.CDS_Busca.Open;

           sDtaGeracao:=DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor));
           While Not DMBelShop.CDS_Busca.Eof do
           Begin
             MySql:=' UPDATE OC_COMPRAR dc'+
                    ' SET dc.IND_OC_GERADA='+QuotedStr('S')+
                    ', dc.DTA_OC_GERADA='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateTimeToStr(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor)))))+
                    ', dc.NUM_OC_GERADA='+QuotedStr(sNrDocto);

                    If bOBS Then
                     MySql:=
                      MySql+', dc.OBS_OC='+QuotedStr(FrmOCObservacao.Mem_OCObsObservacao.Text)+
                            '||ascii_char(13)||'+QuotedStr('Romaneio de Separao CD Gerado em '+sDtaGeracao+
                            ' Pelo Usurio: '+Des_Usuario)
                    Else
                     MySql:=
                      MySql+', dc.OBS_OC='+QuotedStr('Romaneio de Separao CD Gerado em '+sDtaGeracao+
                            ' Pelo Usurio: '+Des_Usuario);

             MySql:=
              MySql+' WHERE dc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
                    ' And   Cast(dc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
                    ' AND   dc.cod_empresa='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
                    ' AND   dc.cod_fornecedor='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_FORNECEDOR.AsString)+
                    ' AND   dc.Num_Seq='+DMBelShop.CDS_Busca.FieldBYName('Num_Seq').AsString;
             DMBelShop.SQLC.Execute(MySql,nil,nil);

             // Atualiza Enderecamento (MPMS)
             DMBelShop.AtualizaEnderecamentoProduto(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString,
                                                    DMBelShop.CDS_Busca.FieldBYName('Cod_Item').AsString, 'SQLC');

             DMBelShop.CDS_Busca.Next;
           End; // While Not DMBelShop.CDS_Busca.Eof do
           DMBelShop.CDS_Busca.Close;

           sCodLoja:=DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString;

           // Atualiza Mesma Obs no Documento ==================================
           MySql:=' SELECT oc.obs_oc'+
                  ' FROM OC_COMPRAR oc'+
                  ' WHERE oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
                  ' AND   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
                  ' AND   oc.num_oc_gerada='+QuotedStr(sNrDocto)+
                  ' ORDER BY oc.dta_oc_gerada desc';
           DMBelShop.CDS_BuscaRapida.Close;
           DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
           DMBelShop.CDS_BuscaRapida.Open;

           MySql:=' UPDATE OC_COMPRAR oc'+
                  ' SET oc.obs_oc='+QuotedStr(DMBelShop.CDS_BuscaRapida.FieldBYName('Obs_OC').AsString)+
                  ' WHERE oc.num_documento='+QuotedStr(IntToStr(EdtGeraOCBuscaDocto.AsInteger))+
                  ' AND   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.AsString)+
                  ' AND   oc.num_oc_gerada='+QuotedStr(sNrDocto);
           DMBelShop.SQLC.Execute(MySql,nil,nil);

           DMBelShop.CDS_BuscaRapida.Close;

           // Atualiza Transacao ===============================================
           DMBelShop.SQLC.Commit(TD);

           DateSeparator:='/';
           DecimalSeparator:=',';
           Screen.Cursor:=crDefault;
         Except
           on e : Exception do
           Begin
             // Abandona Transacao =====================================
             DMBelShop.SQLC.Rollback(TD);

             DateSeparator:='/';
             DecimalSeparator:=',';
             Screen.Cursor:=crDefault;

             MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
             Exit;
           End; // on e : Exception do
         End; // // Try Atualiza
       End
      Else // If bgProcessar Then
       Begin
         If FrmOCObservacao<>nil then
          FreeAndNil(FrmOCObservacao);
         Exit;
       End; // If bgProcessar Then

      If FrmOCObservacao<>nil then
       FreeAndNil(FrmOCObservacao);

      bgProcessar:=False;
    End; // If DMBelShop.CDS_AComprarOCsGERAR.AsString='S' Then

    DMBelShop.CDS_AComprarOCs.Next;
  End; // While Not DMBelShop.CDS_AComprarOCs.Eof do

  msg('Gerao de Romaneios de Separao CD'+cr+cr+'Efetuada com SUCESSO !!','A');

  // Busca Ordem de Compra =====================================================
  EdtGeraOCBuscaDoctoExit(Self);

  TotaisOC(IntToStr(EdtGeraOCBuscaDocto.AsInteger));

  DMBelShop.CDS_AComprarOCs.First;

  DMBelShop.CDS_AComprarOCs.Locate('COD_EMP_FIL; NUM_OC_GERADA',VarArrayOf([sCodLoja, sNrDocto]),[]);

  Screen.Cursor:=crDefault;
end;

procedure TFrmBelShop.Dbg_GeraOCTotalGeralDrawColumnCell(Sender: TObject; const Rect: TRect;
          DataCol: Integer; Column: TColumn;  State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    if Trim(DMBelShop.CDS_AComprarOCsIND_OC_GERADA.AsString)='S' Then
     Dbg_GeraOCTotalGeral.Canvas.Brush.Color:=clSkyBlue;

    If DMBelShop.CDS_AComprarOCsGERAR.AsString='S' Then
     Dbg_GeraOCTotalGeral.Canvas.Brush.Color:=clAqua;
  End;

  If (Column.FieldName='NUM_OC_GERADA') or (Column.FieldName='DTA_OC_GERADA') Then
   Dbg_GeraOCTotalGeral.Canvas.Font.Color:=clBlue;

  If (Column.FieldName='TIPO') Then
  Begin
    If DMBelShop.CDS_AComprarOCsTIPO.AsString='TR' Then
     Begin
       Dbg_GeraOCTotalGeral.Canvas.Brush.Color:=clRed;
       Dbg_GeraOCTotalGeral.Canvas.Font.Color:=clWhite;
     End
    Else If DMBelShop.CDS_AComprarOCsTIPO.AsString='OC' Then
     Begin
       Dbg_GeraOCTotalGeral.Canvas.Font.Style:=[fsBold];
     End
  End;

  // Funciona Somente com Isto
  Dbg_GeraOCTotalGeral.Canvas.FillRect(Rect);
  Dbg_GeraOCTotalGeral.DefaultDrawDataCell(Rect,Column.Field,state);

  // Alinhamento
  DMBelShop.CDS_AComprarOCsGERAR.Alignment:=taCenter;
  DMBelShop.CDS_AComprarOCsCOD_EMP_FIL.Alignment:=taCenter;
  DMBelShop.CDS_AComprarOCsCOD_LINX.Alignment:=taCenter;
  DMBelShop.CDS_AComprarOCsDTA_OC_GERADA.Alignment:=taCenter;
end;

procedure TFrmBelShop.PopM_OCRomaneioMarcarOCsAbertasClick(Sender: TObject);
begin
  DMBelShop.SelecionaOCRomaneiro('OC', True, True);
//                              (sTipo: String; bMarcar, bAberto: Boolean);
end;

procedure TFrmBelShop.PopM_OCRomaneioMarcarRomaneiosAbertosClick(Sender: TObject);
begin
  DMBelShop.SelecionaOCRomaneiro('TR', True, True);
//                              (sTipo: String; bMarcar, bAberto: Boolean);
end;

procedure TFrmBelShop.PopM_OCRomaneioMarcarRomaneiosFechadosClick(Sender: TObject);
begin
  DMBelShop.SelecionaOCRomaneiro('TR', True, False);
//                              (sTipo: String; bMarcar, bAberto: Boolean);

end;

procedure TFrmBelShop.PopM_OCRomaneioDesmarcarRomaneiosDesmarcarClick(Sender: TObject);
begin
  DMBelShop.SelecionaOCRomaneiro('TR', False, False);
//                              (sTipo; bMarcar, bAberto);

end;

procedure TFrmBelShop.SubMenuFinanConciliacaoCaixaClick(Sender: TObject);
begin
  FrmConciliacaoCaixa:=TFrmConciliacaoCaixa.Create(Self);

  TabSheetInvisivel(FrmConciliacaoCaixa);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmConciliacaoCaixa, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  FrmConciliacaoCaixa.EdtConcFechaCaixaCodLoja.Clear;
  FrmConciliacaoCaixa.EdtConcFechaCaixaDesLoja.Clear;
  FrmConciliacaoCaixa.DtEdtConcFechaCaixaData.Clear;

  FrmConciliacaoCaixa.Pan_ConcFechaCaixaSituacao.Caption:='';
  FrmConciliacaoCaixa.Pan_ConcFechaCaixaSituacao.Color:=clBtnFace;
  FrmConciliacaoCaixa.Pan_ConcFechaCaixaSituacao.Font.Color:=clWindowText;

  FrmConciliacaoCaixa.Bt_ConcFechaCaixaSituacao.Enabled:=False;
  FrmConciliacaoCaixa.Bt_ConcFechaCaixaSituacao.Caption:='';

  DMBelShop.CDS_FechaCaixa.Close;
  DMBelShop.CDS_FechaCaixaTotais.Close;

  FrmConciliacaoCaixa.PC_ConcFechaCaixa.TabIndex:=0;
  FrmConciliacaoCaixa.PC_ApresResultado.TabIndex:=0;

  FrmConciliacaoCaixa.ShowModal;

  FreeAndNil(FrmConciliacaoCaixa);
end;

procedure TFrmBelShop.Button2Click(Sender: TObject);
Var
  sPastaPrinc, sPastaNome,
  sPasta,
  MySql: String;
begin
  sPastaPrinc:='C:\GERENCIADOR\';

  MySql:=' select p.des_profissional||'' == Bel_''||p.cod_loja Pasta' +
         ' from sal_profissionais p'+
         ' where p.ind_ativo=''SIM'''+
         ' and p.tip_pessoa=''P'''+
         ' Order by 1';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  While not DMBelShop.CDS_Busca.Eof do
  Begin
    // Pasta do Nome
    sPastaNome:=IncludeTrailingPathDelimiter(sPastaPrinc+DMBelShop.CDS_Busca.FieldByName('Pasta').AsString);
    sPasta:=sPastaNome;
    ForceDirectories(sPasta);

    // Pasta CONTRATO
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'CONTRATO');
    ForceDirectories(sPasta);

    // Pasta REGULAMENTO
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'REGULAMENTO');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / INSS / REC-2014
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\INSS\REC-2014');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / INSS / REC-2015
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\INSS\REC-2015');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / ENDERECO
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\ENDERECO');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / RG-CPF
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\RG-CPF');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / IMPOSTO SINDICAL
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\IMPOSTO SINDICAL');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / TECBIZ / AUTOR DESC
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\TECBIZ\AUTOR DESC');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / TECBIZ / N PROMISSORIA
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\TECBIZ\N PROMISSORIA');
    ForceDirectories(sPasta);

    // Pasta DOCUMENTOS / CERTIFICADOS
    sPasta:=IncludeTrailingPathDelimiter(sPastaNome+'DOCUMENTOS\CERTIFICADOS');
    ForceDirectories(sPasta);

    DMBelShop.CDS_Busca.Next;
  End;
  DMBelShop.CDS_Busca.Close;

  Showmessage('FIM');

end;

procedure TFrmBelShop.DtEdt_ConsultaNFeDtInicioEditing(Sender: TObject; var CanEdit: Boolean);
begin

  If DMVirtual.CDS_V_NFe.Active Then
   DMVirtual.CDS_V_NFe.Close;

  Dbg_ConsultaNFeEmpresa.Align:=alNone;
  Dbg_ConsultaNFeLojas.Align:=alNone;
  Dbg_ConsultaNFeNotasLojas.Align:=alNone;

  Dbg_ConsultaNFeEmpresa.Visible:=False;
  Dbg_ConsultaNFeLojas.Visible:=False;
  Dbg_ConsultaNFeNotasLojas.Visible:=False;


end;

procedure TFrmBelShop.Dbg_ConsultaNFeNotasLojasKeyDown(Sender: TObject; var Key: Word; Shift: TShiftState);
Var
  s: String;
begin
  // Localiza Documento ========================================================
  If (Key=VK_F4) and (SBar_ConsultaNFeNotasLojas.Visible) Then
  Begin
    s:='';
    If InputQuery('Localizar Docto','',s) then
    Begin
      if Trim(s)<>'' then
      Begin
        Try
          StrToInt(s);
          If Not DMVirtual.CDS_V_NFe.Locate('NUM_NOTA',FormatFloat('000000',StrToInt(s)),[]) Then
           msg('Doumento NO Encontrado !!','A');
        Except
          msg('Nmero do Docto  Invlido !!', 'A');
        End;
      End; // if Trim(s)<>'' then
    End; // If InputQuery('Localizar Docto','',s) then
  End; // If Key=VK_F4 Then
end;

procedure TFrmBelShop.PC_ConsultaMovtoComprChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_ConsultaMovtoCompr);

  Bt_ConsultaNFeBuscaOCs.Visible:=True;
  Pan_ConsultaNFeOpcoes.Visible:=False;
  Pan_ConsultaNFePrincpal.Visible:=True;
  Bt_ConsultaNFeFechar.Parent:=Pan_ConsultaNFe;

  If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeMovtoCompr) And (Ts_ConsultaNFeMovtoCompr.CanFocus) Then
  Begin
    Bt_ConsultaNFeBuscaOCs.Visible:=False;
    Pan_ConsultaNFeOpcoes.Visible:=True;

    Bt_ConsultaNFeEmpresa.SetFocus;
  End;

  If (PC_ConsultaMovtoCompr.ActivePage=Ts_ConsultaNFeProdutos) And (Ts_ConsultaNFeProdutos.CanFocus) Then
  Begin
    Pan_ConsultaNFePrincpal.Visible:=False;
    Bt_ConsultaNFeFechar.Parent:=Pan_ConsultaNFeProdutos;

    Dbg_ConsultaNFeProdLojas.SetFocus;

    If Not DMVirtual.CDS_SelectLoja.IsEmpty Then
    Begin
      DMVirtual.CDS_SelectLoja.Next;
      DMVirtual.CDS_SelectLoja.First;
    End;
  End;

end;

procedure TFrmBelShop.PC_AudCompVendChange(Sender: TObject);
begin
  CorSelecaoTabSheet(PC_AudCompVend);

end;

procedure TFrmBelShop.SubMenuFinanVerificaExtratosClick(Sender: TObject);
begin
  FrmBancoExtratos.Caption:='Verificar Extratos Bancrios';

  // Acerta Apresentao das TabSheets =========================================
  FrmBancoExtratos.DesabilitaTabSheet(FrmBancoExtratos.Ts_VerificaExtrato);

  // Desabilida Menu de Conciliao ============================================
  FrmBancoExtratos.LiberaMenu(False);;

  FrmBancoExtratos.Pan_Opcoes.Visible:=True;
  FrmBancoExtratos.Pan_Concilicao.Visible:=False;
  FrmBancoExtratos.Bt_VerifExtratoDtSemMovto.Visible:=False;

  FrmBancoExtratos.sgCodUsuario:=Cod_Usuario;

  FrmBancoExtratos.ShowModal;

end;

procedure TFrmBelShop.SubMenuFinanExpImpArquivosProSoft1Click(Sender: TObject);
begin
  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(2);

  FrmSolicitacoes.DtEdt_ProSoftImpDtaLimite.Text:='01/05/2015';
  FrmSolicitacoes.ShowModal;

  FreeAndNil(FrmSolicitacoes);
end;

procedure TFrmBelShop.PopM_PlanFinanceiraMemoriaClick(Sender: TObject);
begin
  If Not DMVirtual.CDS_V_PlanFinanceira.IsEmpty Then
  Begin
    Dbg_FinanPlanFinanceira.SetFocus;

    DBGridClipboard(Dbg_FinanPlanFinanceira);
  End;
end;

procedure TFrmBelShop.SubMenuProtUsuariosPermAcessoSIDICOMClick(Sender: TObject);
begin
  msg('Opo em Desenvolvimento !!','A');
  Exit;

  // Cria Form Permissoes ======================================================
  FrmAcessosUsuario:=TFrmAcessosUsuario.Create(Self);

  TabSheetInvisivel(FrmAcessosUsuario);
  FrmAcessosUsuario.Ts_AcessoSidicom.TabVisible:=True;

  // Executa Permisses de Botes ==============================================
  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmBelShop, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  FrmAcessosUsuario.PC_Principal.TabIndex:=0;
  FrmAcessosUsuario.PC_SidicomPermissoes.TabIndex:=0;

  FrmAcessosUsuario.ShowModal;
  FreeAndNil(FrmAcessosUsuario);
end;

procedure TFrmBelShop.Rb_ConsultaNFeTpMovtoAmbosKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_ConsultaNFeTpMovtoAmbosClick(Self);
end;

procedure TFrmBelShop.Rb_CurvaABCEndTipoCalculoUnidadesKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_CurvaABCEndTipoCalculoUnidadesClick(Self);

end;

procedure TFrmBelShop.Bt_CurvaABCEndSalvaProdClipboardClick(Sender: TObject);
begin

  If (Sender is TJvXPButton) Then
  Begin
    If Trim((Sender as TJvXPButton).Name)='Bt_CurvaABCEndSalvaProdClipboard' Then
    Begin
      If Not DMVirtual.CDS_V_CurvaABCEndereco.IsEmpty Then
      Begin
        Dbg_CurvaABCEndCurvaABC.SetFocus;
        Screen.Cursor:=crAppStart;

        DBGridClipboard(Dbg_CurvaABCEndCurvaABC);

        Screen.Cursor:=crDefault;
      End;
    End; // If Trim((Sender as TJvXPButton).Name)='Bt_CurvaABCEndSalvaProdClipboard' Then

    If Trim((Sender as TJvXPButton).Name)='Bt_CurvaABCEndSalvaFornClipboard' Then
    Begin
      If (gCDS_V_Geral<>nil) and (Not gCDS_V_Geral.IsEmpty) Then
      Begin
        Screen.Cursor:=crAppStart;

        Dbg_CurvaABCEndCurvaABCForn.SetFocus;
        DBGridClipboard(Dbg_CurvaABCEndCurvaABCForn);

        Screen.Cursor:=crDefault;
      End;
    End; // If Trim((Sender as TJvXPButton).Name)='Bt_CurvaABCEndSalvaFornClipboard' Then
  End; // If (Sender is TJvXPButton) Then

end;

procedure TFrmBelShop.SubMenuComprasEstoquesMinimoDemadasClick(Sender: TObject);
Var
  MySql: String;
begin
  FrmEstoques:=TFrmEstoques.Create(Self);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmEstoques, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Posiciona TabSheet ========================================================
  FrmEstoques.Cbx_EstoquesSituacaoProd.ItemIndex:=0;
  FrmEstoques.PC_EstoquesPrincipal.TabIndex:=0;

  // Busca Valores da Curva ABC ================================================
  MySql:=' select t.des_aux, t.cod_aux'+
         ' from tab_auxiliar t'+
         ' where t.tip_aux=2'+
         ' order by t.des_aux';
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  While Not DMBelShop.CDS_BuscaRapida.Eof do
  Begin
    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='1' Then
     FrmEstoques.EdtEstoquesLimiteCurvaA.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='2' Then
     FrmEstoques.EdtEstoquesLimiteCurvaB.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='3' Then
     FrmEstoques.EdtEstoquesLimiteCurvaC.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='4' Then
     FrmEstoques.EdtEstoquesLimiteCurvaD.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    If DMBelShop.CDS_BuscaRapida.FieldByName('Cod_Aux').AsString='5' Then
     FrmEstoques.EdtEstoquesLimiteCurvaE.Value:=DMBelShop.CDS_BuscaRapida.FieldByName('Des_Aux').AsInteger;

    DMBelShop.CDS_BuscaRapida.Next;
  End; // While Not DMBelShop.CDS_BuscaRapida.Eof do
  DMBelShop.CDS_BuscaRapida.Close;

  // Inicializa Datas ==========================================================
  DecodeDate(DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor), wgAnoH, wgMesH, wgDiaH);

//  // Permisses de Visualizao ================================================
//  PermissaoVisual(FrmSalao.Ts_Profissionais);

  sgFiltros:='';

  If AnsiUpperCase(Des_Login)='ODIR' Then
   FrmEstoques.Bt_Odir.Visible:=True;

  FrmEstoques.ShowModal;

  FreeAndNil(FrmEstoques);
end;

procedure TFrmBelShop.Rb_GeraOCEditaTodosItensKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_GeraOCEditaTodosItensClick(Self);

end;

procedure TFrmBelShop.CkB_CalculoTransitoClick(Sender: TObject);
begin
  AcertaCkb_SN(CkB_CalculoTransito);
  DtEdt_CalculoTransito.Enabled:=(CkB_CalculoTransito.Checked);
end;

procedure TFrmBelShop.CkB_CalculoTransitoKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  CkB_CalculoTransitoClick(Self);
end;

procedure TFrmBelShop.Dbg_FinanDemonsResultadoDblClick(Sender: TObject);
begin
  Bt_FinanDemonsResultAlterarClick(Self);
end;

procedure TFrmBelShop.Bt_GeraOCExcluirClick(Sender: TObject);
Var
  MySql: String;
begin
  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.IBQ_AComprar.IsEmpty Then
   Exit;

  // Verifica se Existe OC Gerada ==============================================
  MySql:=' SELECT FIRST 1 o.num_oc_gerada'+
         ' FROM OC_COMPRAR o, OC_COMPRAR_DOCS d'+
         ' WHERE o.num_documento=d.num_docto'+
         ' AND   o.num_oc_gerada is not null'+
         ' AND   d.origem<>'+QuotedStr('Linx')+
         ' and   o.num_documento='+VarToStr(EdtGeraOCBuscaDocto.Value);
  DMBelShop.CDS_BuscaRapida.Close;
  DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
  DMBelShop.CDS_BuscaRapida.Open;

  If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('num_oc_gerada').AsString)<>'' Then
  Begin
    msg('Impossvel Excluir Este Docto !!'+cr+cr+'Contm Transferncia/Ordem Compra'+cr+'j Gerada(s) !!','A');
    DMBelShop.CDS_BuscaRapida.Close;
    Dbg_GeraOCGrid.SetFocus;
    Exit;
  end;
  DMBelShop.CDS_BuscaRapida.Close;

  If msg('Deseja Realmente Excluir o'+cr+cr+'Documento Selecionado ??','C')=2 Then
  Begin
    Dbg_GeraOCGrid.SetFocus;
    Exit;
  End;

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    // Exclui Docto ============================================================
    MySql:=' DELETE FROM OC_COMPRAR o'+
           ' WHERE o.num_documento='+VarToStr(EdtGeraOCBuscaDocto.Value)+
           ' AND   EXISTS (SELECT 1'+
           '               FROM OC_COMPRAR_DOCS d'+
           '               WHERE d.num_docto=o.num_documento'+
           '               AND   d.origem<>'+QuotedStr('Linx')+')';
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Exclui Docto de OC Importada ============================================
    MySql:=' DELETE FROM OC_IMPORTADAS i'+
           ' WHERE i.num_documento='+VarToStr(EdtGeraOCBuscaDocto.Value);
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    MySql:=' DELETE FROM OC_COMPRAR_MESES m'+
           ' WHERE m.num_documento='+VarToStr(EdtGeraOCBuscaDocto.Value)+
           ' AND   EXISTS (SELECT 1'+
           '               FROM OC_COMPRAR_DOCS d'+
           '               WHERE d.num_docto=m.num_documento'+
           '               AND   d.origem<>'+QuotedStr('Linx')+')';
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Retorna OC_COMPRAR_LOJAS ================================================
    MySql:=' UPDATE OC_COMPRAR_LOJAS ol'+
           ' SET ol.ind_oc_gerada='+QuotedStr('N')+
           ', ol.dta_oc_gerada=NULL'+
           ', ol.num_oc_gerada=NULL'+
           ' WHERE ol.ind_oc_gerada='+QuotedStr('S')+
           ' AND   num_oc_gerada='+VarToStr(EdtGeraOCBuscaDocto.Value);
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Deleta OC_COMPRAR_DOCS ==================================================
    OC_COMPRAR_DOCS('D', VarToStr(EdtGeraOCBuscaDocto.Value), '<>''Linx''');

    // Atualiza Transacao =======================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao =====================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      exit;
    End; // on e : Exception do
  End; // Try

  EdtGeraOCBuscaDocto.Value:=0;
  EdtGeraOCBuscaDocto.SetFocus;

  msg('Documento Excluido com SUCESSO !!','A');
end;

procedure TFrmBelShop.PopM_GeraOCVoltar1Click(Sender: TObject);
begin
  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);

  PC_OrdemCompra.TabIndex:=0;
  PC_OrdemCompraChange(Sender);
  
  PC_Filtros.ActivePage:=TS_FiltroFornecedor;
  PC_FiltrosChange(Sender);
  EdtFiltroCodForn.SetFocus;

end;

procedure TFrmBelShop.PopM_GeraOCLegendaCoresClick(Sender: TObject);
begin
  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(4);

  FrmSolicitacoes.ShowModal;
  FreeAndNil(FrmSolicitacoes);

end;

procedure TFrmBelShop.PopM_GeraOCCalculaTransfernciasCDClick(Sender: TObject);
Var
  MySql: String;
  iNumSeq: Integer;
begin

  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.IBQ_AComprar.IsEmpty Then
   Exit;

  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);

  // Gaurda Numero do Documento ================================================
  sNumDoc:=EdtGeraOCBuscaDocto.Text;
  sgDtaDoc:=DateToStr(DtEdt_GeraOCDataDocto.Date);
  Try
    sgDtaDoc:=DateToStr(StrToDateTime(sgDtaDoc));
  Except
    Try
      sgDtaDoc:=DateToStr(StrToDateTime(f_Troca('.','/',f_Troca('-','/',sgDtaDoc))));
    Except
      sgDtaDoc:=DateToStr(StrToDateTime(f_Troca('/','.',f_Troca('-','.',sgDtaDoc))));
    End;
  End;

  // ClientDataSet Virtual de Sados Disponiveis ================================
  Try
    DMVirtual.CDS_V_SaldoTransf.CreateDataSet;
    DMVirtual.CDS_V_SaldoTransf.Open;
  Except
    DMVirtual.CDS_V_SaldoTransf.EmptyDataSet;
    DMVirtual.CDS_V_SaldoTransf.Open;
  End;

  // Busca Fornecedores a Analisar =============================================
  MySql:=' SELECT DISTINCT oc.cod_fornecedor'+
         ' FROM OC_COMPRAR oc'+
         ' WHERE oc.qtd_transf=0'+
         ' AND   oc.qtd_acomprar<>0'+
         ' AND   oc.Cod_Empresa<>''99'''+
         ' AND   oc.ind_oc_gerada='+QuotedStr('N')+
         ' AND   oc.num_documento='+sNumDoc+
         ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)));
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  sgFornecedores:='';
  If Not DMBelShop.CDS_Busca.IsEmpty Then
  Begin
    DMBelShop.CDS_Busca.First;
    While Not DMBelShop.CDS_Busca.Eof do
    Begin
      If sgFornecedores='' Then
       sgFornecedores:=QuotedStr(DMBelShop.CDS_Busca.FieldByName('Cod_Fornecedor').AsString)
      Else
       sgFornecedores:=sgFornecedores+', '+QuotedStr(DMBelShop.CDS_Busca.FieldByName('Cod_Fornecedor').AsString);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
  End; // If Not DMBelShop.CDS_Busca.IsEmpty Then
  DMBelShop.CDS_Busca.Close;

  If Trim(sgFornecedores)='' Then
  Begin
    msg('SEM Produto a Analisar Transferncia !!','A');
    Exit;
  End;

  If msg('Deseja Realmente Efetuar a ANALISE de TRANSFERNCIAS ??','C')=2 Then
   Exit;

  // Fecha o Documento =========================================================
  EdtGeraOCBuscaDocto.Text:='0';

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    OdirPanApres.Caption:='AGUARDE !! FASE: 1/3 - Analisando Tansferncias do Docto: '+sNumDoc;
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
    OdirPanApres.Visible:=True;
    Refresh;

    DMBelShop.AcertaCompraCD(sNumDoc, sgDtaDoc, False, False);

    // Busca Num_Seq OC_COMPRAR ================================================
    MySql:=' SELECT COALESCE(MAX(o.num_seq) ,0) Num_seq'+
           ' FROM OC_COMPRAR o'+
           ' WHERE o.num_documento='+sNumDoc+
           ' And   Cast(o.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)));
    DMBelShop.CDS_BuscaRapida.Close;
    DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
    DMBelShop.CDS_BuscaRapida.Open;
    iNumSeq:=DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsInteger;
    DMBelShop.CDS_BuscaRapida.Close;

    // FASE 1/3 - Exclui Transferencia Existentes no Docto ================================
    MySql:=' SELECT oc.num_seq, oc.cod_empresa, oc.cod_item, oc.qtd_transf'+
           ' FROM  OC_COMPRAR oc'+
           ' Where oc.qtd_transf<>0'+
           ' AND   oc.ind_oc_gerada='+QuotedStr('N')+
           ' AND   oc.num_documento='+sNumDoc+
           ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)))+
           ' ORDER BY oc.cod_item, oc.cod_empresa';
    DMBelShop.CDS_Busca.Close;
    DMBelShop.SDS_Busca.CommandText:=MySql;
    DMBelShop.CDS_Busca.Open;

    MontaProgressBar(True, FrmBelShop);
    pgProgBar.Properties.Max:=DMBelShop.CDS_Busca.RecordCount;
    pgProgBar.Position:=0;

    While Not DMBelShop.CDS_Busca.Eof do
    Begin
      Application.ProcessMessages;
      pgProgBar.Position:=DMBelShop.CDS_Busca.RecNo;

      // Busca Produtos Comprar ================================================
      MySql:=' SELECT oc.num_seq'+
             ' FROM OC_COMPRAR oc'+
             ' WHERE oc.qtd_transf=0'+
             ' AND   oc.ind_oc_gerada='+QuotedStr('N')+
             ' AND   oc.cod_item='+QuotedStr(DMBelShop.CDS_Busca.FieldByName('cod_item').AsString)+
             ' AND   oc.cod_empresa='+QuotedStr(DMBelShop.CDS_Busca.FieldByName('cod_empresa').AsString)+
             ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)))+
             ' AND   oc.num_documento='+sNumDoc;
      DMBelShop.CDS_BuscaRapida.Close;
      DMBelShop.SDS_BuscaRapida.CommandText:=MySql;
      DMBelShop.CDS_BuscaRapida.Open;

      // Altera Compra
      If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsString)<>'' Then
      Begin
        MySql:=' Update OC_COMPRAR oc'+
               ' Set oc.qtd_acomprar=oc.qtd_acomprar+'+f_Troca(',','.',DMBelShop.CDS_Busca.FieldByName('qtd_transf').AsString)+
               ' WHERE oc.Num_Seq='+DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsString+
               ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)))+
               ' AND   oc.num_documento='+sNumDoc;
        DMBelShop.SQLC.Execute(MySql,nil,nil);
      End;

      // Gera Compra
      If Trim(DMBelShop.CDS_BuscaRapida.FieldByName('Num_Seq').AsString)='' Then
      Begin
        Inc(iNumSeq);
        MySql:=' INSERT INTO OC_COMPRAR'+
               ' SELECT'+
               ' '+IntToStr(iNumSeq)+' NUM_SEQ, o.NUM_DOCUMENTO, o.DTA_DOCUMENTO, o.IND_OC_GERADA, o.DTA_OC_GERADA,'+
               ' o.NUM_OC_GERADA, o.OBS_OC, o.COD_EMPRESA, o.DES_EMPRESA, o.COD_ITEM, o.DES_ITEM, o.QTD_SUGERIDA,'+
               ' o.QTD_TRANSF QTD_ACOMPRAR,'+
               ' o.QTD_SALDO, o.QTD_TRANSITO, o.QTD_DISPONIVEL,'+
               ' o.QTD_MEDIA_MES, o.QTD_MEDIA_DIA, o.QTD_DEM_MES1, o.QTD_DEM_MES2, o.QTD_DEM_MES3,'+
               ' o.QTD_DEM_MES4, o.QTD_DEM_MES5, o.QTD_DEM_MES6, o.QTD_DEM_MES7, o.QTD_DEM_MES8,'+
               ' o.UNI_COMPRA, o.UNI_VENDA, o.COD_BARRAS, o.COD_GRUPO, o.DES_GRUPO, o.COD_SUBGRUPO,'+
               ' o.DES_SUBGRUPO, o.DES_GENERICO, o.COD_APLICACAO, o.DES_APLICACAO, o.COD_REFERENCIA,'+
               ' o.CLA_CURVA_ABC, o.COD_FAMILIA_PRECO, o.DES_FAMILIA_PRECO, o.DTA_ULT_COMPRA,'+
               ' o.COD_FOR_ULT_COMPRA, o.DES_FOR_ULT_COMPRA, o.QTD_ULT_COMPRA, o.VLR_UNI_ULT_COMPRA,'+
               ' o.VLR_TOT_ULT_COMPRA, o.VLR_UNI_COMPRA, o.PER_DESCONTO, o.DTA_ULT_VENDA, o.COD_CLI_ULT_VENDA,'+
               ' o.DES_CLI_ULT_VENDA, o.QTD_ULT_VENDA, o.VLR_UNI_ULT_VENDA, o.VLR_TOT_ULT_VENDA, o.VLR_UNI_VENDA,'+
               ' o.COD_LISTA_VENDA, o.DES_LISTA_VENDA, o.COD_LISTA_COMPRA, o.DES_LISTA_COMPRA,'+
               ' o.VLR_CUSTO_MEDIO, o.VLR_TOT_VENDA, o.VLR_TOT_COMPRA, o.VLR_BRUTO, o.VLR_DESCONTOS,'+
               ' o.VLR_DESPESAS, o.VLR_FRETE, o.IND_SOMA_IPI_BASE_ICMS, o.IND_SOMA_FRETE_BASE_ICMS,'+
               ' o.IND_SOMA_DESPESA_BASE_ICMS, o.IND_SOMA_IPI_BASE_ST, o.IND_SOMA_FRETE_BASE_ST,'+
               ' o.IND_SOMA_DESPESA_BASE_ST, o.COD_SIT_TRIBUTARIA, o.COD_IPI, o.IND_IPI, o.PER_IPI,'+
               ' o.VLR_IPI, o.COD_ICMS, o.PER_REDUCAO_ICMS, o.VLR_REDUCAO_ICMS, o.VLR_BASE_ICMS,'+
               ' o.PER_ICMS, o.VLR_ICMS, o.COD_GRUPO_ST, o.DES_GRUPO_ST, o.PER_MARGEM_ST, o.IND_ST,'+
               ' o.VLR_BASE_ST, o.PER_ST, o.VLR_ST, o.PER_REPASSE, o.VLR_REPASSE, o.COD_COMPROVANTE_ICMS,'+
               ' o.COD_REFERENCIA_FORN, o.COD_FORNECEDOR, o.DES_FORNECEDOR, o.TIP_PESSOA, o.DES_EMAIL,'+
               ' o.QTD_NR_DIAS, o.QTD_NR_MESES, o.QTD_TOT_MESES, o.COD_COMPRADOR, o.BLOB_TEXTO, o.IND_TRANSF,'+
               ' o.DTA_LIM_TRANSF, '+QuotedStr('0')+' QTD_TRANSF, o.IND_USAR, '+QuotedStr('0')+' IND_QTD_ACIMA,'+
               ' o.QTD_SUGERIDA_ANO, o.QTD_TRANSF_PERIODO, o.QTD_TRANSF_ANO, o.EST_MINIMO,'+
               ' o.DIAS_ESTOCAGEM, o.QTD_DEMANDA_DIA, o.QTD_DEMANDA_ANO, o.QTD_DIAS_ANO,'+
               ' o.DATAINCLUSAO, o.ESTADO, o.DATAALTERACAO, o.IND_TRANSF_CD, o.DOC_TRANSF_CD'+

               ' FROM OC_COMPRAR o'+

               ' WHERE o.num_documento='+sNumDoc+
               ' And   Cast(o.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)))+
               ' AND   o.NUM_SEQ='+DMBelShop.CDS_Busca.FieldByName('Num_Seq').AsString;
        DMBelShop.SQLC.Execute(MySql,nil,nil);
      End; // If Not bgSiga Then
      DMBelShop.CDS_BuscaRapida.Close;

      // Deleta Transferencia
      MySql:=' DELETE FROM OC_COMPRAR oc'+
             ' WHERE oc.Num_Seq='+DMBelShop.CDS_Busca.FieldByName('Num_Seq').AsString+
             ' And   Cast(oc.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',sgDtaDoc)))+
             ' AND   oc.num_documento='+sNumDoc;
      DMBelShop.SQLC.Execute(MySql,nil,nil);

      DMBelShop.CDS_Busca.Next;
    End; // While Not DMBelShop.CDS_Busca.Eof do
    DMBelShop.CDS_Busca.Close;

    MontaProgressBar(False, FrmBelShop);

    // FASE 2/3 - Busca Quantidades de Transferencia ===========================
    OdirPanApres.Caption:='AGUARDE !! FASE: 2/3 - Analisando Tansferncias do CD';
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
    OdirPanApres.Visible:=True;
    Refresh;

    // Busca Saldos ============================================================
    If Not ConectaMPMS Then
    Begin
      msg('Problema de Conexo com Banco de Dados do CD (MPMS)','A');
      Exit;
    End;

    MySql:=' SELECT s.codfilial Cod_loja, s.codproduto Cod_Produto, p.principalfor Cod_Fornecedor,'+
           '        s.saldoatual Qtd_Saldo'+
           ' FROM ESTOQUE s, PRODUTO p'+
           ' WHERE s.codproduto=p.codproduto'+
           ' AND   s.saldoatual>0'+
           ' AND   s.codfilial='+QuotedStr('99')+
           ' AND   P.principalfor in ('+sgFornecedores+')';
    IBQ_MPMS.Close;
    IBQ_MPMS.SQL.Clear;
    IBQ_MPMS.SQL.Add(MySql);
    IBQ_MPMS.Open;

    // Gera Movtos para Transferencias =========================================
    If Not IBQ_MPMS.IsEmpty Then
    Begin
      IBQ_MPMS.Last;
      MontaProgressBar(True, FrmBelShop);
      pgProgBar.Properties.Max:=IBQ_MPMS.RecordCount;
      pgProgBar.Position:=0;

      IBQ_MPMS.First;
      While Not IBQ_MPMS.Eof do
      Begin
        Application.ProcessMessages;
        pgProgBar.Position:=IBQ_MPMS.RecNo;

        DMVirtual.CDS_V_SaldoTransf.Insert;
        DMVirtual.CDS_V_SaldoTransfCOD_LOJA.AsString:=IBQ_MPMS.FieldByName('Cod_loja').AsString;
        DMVirtual.CDS_V_SaldoTransfCOD_PRODUTO.AsString:=IBQ_MPMS.FieldByName('Cod_Produto').AsString;
        DMVirtual.CDS_V_SaldoTransfCOD_FORNECEDOR.AsString:=IBQ_MPMS.FieldByName('Cod_Fornecedor').AsString;
        DMVirtual.CDS_V_SaldoTransfQTD_SALDO.AsString:=IBQ_MPMS.FieldByName('Qtd_Saldo').AsString;
        DMVirtual.CDS_V_SaldoTransfQTD_UTILIZADA.AsString:='0';
        DMVirtual.CDS_V_SaldoTransfQTD_DISPONIVEL.AsString:=IBQ_MPMS.FieldByName('Qtd_Saldo').AsString;
        DMVirtual.CDS_V_SaldoTransf.Post;

        IBQ_MPMS.Next;
      End; // While Not IBQ_MPMS.Eof do
    End; // If Not IBQ_MPMS.IsEmpty Then
    MontaProgressBar(False, FrmBelShop);

    IBQ_MPMS.Close;

    // FASE 3/3 - Atualizando Tansferncias do CD ===========================
    OdirPanApres.Caption:='AGUARDE !! FASE: 3/3 - Atualizando Tansferncias do CD';
    OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
    OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
    OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
    OdirPanApres.Visible:=True;
    Refresh;

    // Acerta Valores da OC ====================================================
    DMBelShop.AtualizaTransfCD(sNumDoc, sgDtaDoc);

    // Acerta Quantidade de compra para CD =====================================
    DMBelShop.AcertaCompraCD(sNumDoc, sgDtaDoc, True, False);

    // Atualiza Transacao ======================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';
    Screen.Cursor:=crDefault;

    // Atualiza Valores
    DMBelShop.Doc_CalculaValores(sNumDoc, sgDtaDoc);

    // Apresenta Docto =========================================================
    DMBelShop.IBDB_BelShop.Close;
    DMBelShop.IBDB_BelShop.Open;
    EdtGeraOCBuscaDocto.Text:=sNumDoc;
    EdtGeraOCBuscaDoctoExit(Self);

  Except
    on e : Exception do
    Begin
      // Abandona Transacao ====================================================
      DMBelShop.SQLC.Rollback(TD);

      MontaProgressBar(False, FrmBelShop);

      DateSeparator:='/';
      DecimalSeparator:=',';
      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
    End; // on e : Exception do
  End; // Try

  OdirPanApres.Visible:=False;
end;

procedure TFrmBelShop.PopM_GeraOCExportaParaOutroDoctoClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.IBQ_AComprar.IsEmpty Then
   Exit;

  If msg('A Empresa Selecionda Esta CORRETA ???','C')=2 Then
  Begin
    Dbg_GeraOCFiliais.SetFocus;
    Exit;
  End;

  PC_GeraOCApresentacao.TabIndex:=0;
  PC_GeraOCApresentacaoChange(Self);

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  bgLinxChamada:=False;
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(0);

  FrmSolicitacoes.EdtSolicExpDoctoOrigem.Value:=EdtGeraOCBuscaDocto.Value;
  FrmSolicitacoes.EdtSolicExpLoja.Text:=DMBelShop.IBQ_AComprarCOD_EMPRESA.AsString+' - '+
                                        DMBelShop.IBQ_AComprarDES_EMPRESA.AsString;

  FrmSolicitacoes.EdtSolicExpDoctoDestino.Value:=0;
  FrmSolicitacoes.EdtSolicExpTpExportacao.Text:='TODOS OS PRODUTOS';
  FrmSolicitacoes.EdtSolicExpTpExportacao.Color:=clRed;

  FrmSolicitacoes.Ckb_SolicExpExcProduto.Checked:=True;
  FrmSolicitacoes.Ckb_SolicExpExcProdutoClick(Self);

  FrmSolicitacoes.Ckb_SolicExpSoProduto.Checked:=False;
  FrmSolicitacoes.Ckb_SolicExpSoProdutoClick(Self);

  bgProcessar:=False;
  FrmSolicitacoes.ShowModal;

  FreeAndNil(FrmSolicitacoes);
  bgLinxChamada:=False;

  If bgProcessar Then
  Begin
    EdtGeraOCBuscaDoctoExit(Self);
  End; // If bgProcessar Then

end;

procedure TFrmBelShop.PopM_GeraOCImportaSolicitcoesLojasClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  EdtGeraOCBuscaDocto.Value:=0;
  EdtGeraOCBuscaDoctoExit(Self);

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(14);

  // Busca Fornecedores de Lojas Unicas a Importar =============================
  If Not LojaUnicaFornecedorImportar Then
  Begin
    msg(sgMensagem,'A');
    sgMensagem:='';
    If EdtGeraOCBuscaDocto.AsInteger=0 Then
      EdtGeraOCBuscaDocto.SetFocus
    Else
     PC_GeraOCApresentacaoChange(Self);
    Exit;
  End;
  sgMensagem:='';

  // Apresenta Fornecedores de Lojas Unicas a Importar =========================
  bgProcessar:=False;

  FrmSolicitacoes.AutoSize:=False;
  FrmSolicitacoes.Width:=1000;
  FrmSolicitacoes.Dbg_SolicitFornLojas.Columns[4].Visible:=False;
  FrmSolicitacoes.ShowModal;

  If bgProcessar Then
  Begin
    If Not GeraDoctoLojasUnicas Then
     Exit;

    EdtGeraOCBuscaDocto.AsInteger:=StrToInt(sNumDoc);
    EdtGeraOCBuscaDoctoExit(Self);
    sgFornLojas:='';
  End; // If bgProcessar Then

  FreeAndNil(FrmSolicitacoes);

end;

procedure TFrmBelShop.PopM_GeraOCComparaPedidosClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  Screen.Cursor:=crAppStart;

  // Monta Comprao de Pedidos ================================================
  DMBelShop.CDS_OCComparaPedidos.Close;
  DMBelShop.SDS_OCComparaPedidos.Params.ParamByName('NumDoc').AsInteger:=EdtGeraOCBuscaDocto.AsInteger;
  DMBelShop.SDS_OCComparaPedidos.Params.ParamByName('DtaDoc').AsDate   :=DtEdt_GeraOCDataDocto.Date;
  DMBelShop.CDS_OCComparaPedidos.Open;

  If DMBelShop.CDS_OCComparaPedidos.IsEmpty Then
  Begin
    DMBelShop.CDS_OCComparaPedidos.Close;
    msg('Sem Pedido para Comparao !!','A');
    Exit;
  End; // If DMBelShop.CDS_OCComparaPedidos.IsEmpty Then

  Screen.Cursor:=crDefault;

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(19);

  bgProcessar:=False;
  FrmSolicitacoes.GridNewCriar(DMBelShop.DS_OCComparaPedidos, 'PopM_GeraOC', False);
  FrmSolicitacoes.Caption:='C O M P R A S';
  FrmSolicitacoes.Ts_QualquerCoisa.Caption:='Comparativo de Pedidos de Compra';

  FrmSolicitacoes.AutoSize:=False;
  FrmSolicitacoes.Width:=1000;
  FrmSolicitacoes.AutoSize:=True;
  FrmSolicitacoes.ShowModal;

  DMBelShop.CDS_OCComparaPedidos.Close;
  FreeAndNil(FrmSolicitacoes);

end;

procedure TFrmBelShop.PopM_GeraOCValorUnitarioClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  // Altera Preco Unitrio =====================================================
  AlteraAComprar(DMBelShop.IBQ_AComprar, 'P', VarToStr(EdtGeraOCBuscaDocto.Value), DateToStr(DtEdt_GeraOCDataDocto.Date));

end;

procedure TFrmBelShop.PopM_GeraOCPercDescontoClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  // Altera Desconto Individual ================================================
  AlteraAComprar(DMBelShop.IBQ_AComprar, 'DI', VarToStr(EdtGeraOCBuscaDocto.Value), DateToStr(DtEdt_GeraOCDataDocto.Date));
end;

procedure TFrmBelShop.PopM_GeraOCPercelDescMIXClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  // Altera Desconto no Mix ====================================================
  AlteraAComprar(DMBelShop.IBQ_AComprar, 'DM', VarToStr(EdtGeraOCBuscaDocto.Value), DateToStr(DtEdt_GeraOCDataDocto.Date));

end;

procedure TFrmBelShop.PopM_GeraOCVerTransitoClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  // Apresenta Transito ========================================================
  VerTransito(DMBelShop.IBQ_AComprar, DMBelShop.DS_AComprar, True);
end;

procedure TFrmBelShop.PopM_GeraOCOCsOrigemClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  // Ordens de Compra de Origem (Importadas) ===================================
  OCOrigemImportadas;
end;

procedure TFrmBelShop.Bt_ConEmpresasUsuWindowsClick(Sender: TObject);
var
 sUsu, sComp: String;
begin
 UsuarioComputadorWindows(sUsu, sComp);

 ShowMessage('Usurio Windows: '+sUsu+cr+cr+'Nome Computador: '+sComp);
end;

procedure TFrmBelShop.SubMenuMenuGerenciaContasPagarClick(Sender: TObject);
begin
  msg('Opo em Desenvolvimento !!','A');
  Exit;
end;

procedure TFrmBelShop.SubMenuMenuGerenciaContasReceberClick(Sender: TObject);
begin
  msg('Opo em Desenvolvimento !!','A');
  Exit;

end;

procedure TFrmBelShop.SubMenuCentroDistrReposicoesLojasClick(Sender: TObject);
Var
  Arq: TextFile;
  sArq, sLinha: String;
  b: Boolean;
begin

  sArq:=AnsiUpperCase(IncludeTrailingPathDelimiter(sgPastaExecutavelServer)+'Arquivo Status Transf\Odir.Txt');
  While b do
  Begin
    If FileExists(sArq) Then
    Begin
      AssignFile(Arq,sArq);
      Reset(Arq);
      Readln(Arq,sLinha);
      CloseFile(Arq);

      msg(sLinha,'A');
      Exit;
    End;

    sArq:=f_Troca('E:\','',sArq);
    If FileExists(sArq) Then
    Begin
      AssignFile(Arq,sArq);
      Reset(Arq);
      Readln(Arq,sLinha);
      CloseFile(Arq);

      msg(sLinha,'A');
      Exit;
    End;

    sArq:=f_Troca('C:\','',sArq);
    If FileExists(sArq) Then
    Begin
      AssignFile(Arq,sArq);
      Reset(Arq);
      Readln(Arq,sLinha);
      CloseFile(Arq);

      msg(sLinha,'A');
      Exit;
    End;

    Break;
  End; // While b do

  If Not ConectaMPMS Then
  Begin
    msg('Impossvel Continuar...'+cr+'Banco de Dados SIDICOM'+cr+cr+'No CONECTADO !!','A');
    Close;
    Exit;
  End;

//  FrmCentralTrocas:=TFrmCentralTrocas.Create(Self);
//  DMCentralTrocas:=TDMCentralTrocas.Create(Self);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmCentralTrocas, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Apresenta TabSheet ========================================================
  TabSheetInvisivel(FrmCentralTrocas);
  FrmCentralTrocas.Ts_ReposLojas.TabVisible:=True;

  FrmCentralTrocas.ShowModal;

//  FreeAndNil(FrmCentralTrocas);
//  FreeAndNil(DMCentralTrocas);

end;

procedure TFrmBelShop.SubMenuCentralTrocasNotasEntradaDevolucaoClick(Sender: TObject);
begin
  If Not ConectaMPMS Then
  Begin
    msg('Impossvel Continuar...'+cr+'Banco de Dados SIDICOM'+cr+cr+'No CONECTADO !!','A');
    Close;
    Exit;
  End;

  FrmCentralTrocas:=TFrmCentralTrocas.Create(Self);
  DMCentralTrocas:=TDMCentralTrocas.Create(Self);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmCentralTrocas, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

//  // Permisses de Visualizao ================================================
//  PermissaoVisual(FrmSalao.Ts_Profissionais);

  // Apresenta TabSheet ========================================================
  TabSheetInvisivel(FrmCentralTrocas);
  FrmCentralTrocas.Ts_NotasEntDev.TabVisible:=True;

  // Limpa Componetes ==========================================================
  FrmCentralTrocas.EdtNotasEntDevCodProduto.Clear;
  FrmCentralTrocas.EdtNotasEntDevDesProduto.Clear;
  FrmCentralTrocas.EdtNotasEntDevContaBarras.Clear;
  FrmCentralTrocas.EdtNotasEntDevQtdDevulocao.Clear;
  FrmCentralTrocas.EdtNotasEntDevNumSolicitacao.Clear;
  FrmCentralTrocas.DtaEdtNotasEntDev.Date:=DataHoraServidorFI(DMBelShop.SDS_DtaHoraServidor);

  FrmCentralTrocas.CorCaptionForm.FormCaption:='CENTRAL DE TROCAS';
  FrmCentralTrocas.ShowModal;

  FreeAndNil(FrmCentralTrocas);
  FreeAndNil(DMCentralTrocas);

end;

procedure TFrmBelShop.SubMenuAtualizaTabelasSPEDClick(Sender: TObject);
Var
  MySql: String;
  ii, i: Integer;
  bErros: Boolean;
begin

  msg('Opo no Disponivel !!','A');
  Exit;
  
  If msg('Deseja REALMENTE Efetuar a'+cr+'Atualizao de Tabelas SPED nas Lojas ??','C')=2 Then
   Exit;

  If msg('Esta Opo Requer Conhecimento da Mesma !!'+cr+cr+'Deseja Continuar Assim MESMO ????','C')=2 Then
   Exit;

  bErros:=False;
  Screen.Cursor:=crAppStart;
  ControleMenu(False);

  ii:=Mem_Salvar.Width;
  Mem_Salvar.Lines.Clear;
  Mem_Salvar.Visible:=False;
  Mem_Salvar.Width:=500;
  Mem_Salvar.Lines.Clear;

  // Conecta MPMS ==============================================================
  If Not ConectaMPMS Then
  Begin
    msg('Impossvel Continuar...'+cr+'Banco de Dados BelShop_CD (Administrao)'+cr+cr+'No CONECTADO !!','A');
    Screen.Cursor:=crDefault;
    ControleMenu(True);
    Exit;
  End;

  // Busca Tabelas a Atualizar nas Lojas =======================================
  MySql:=' SELECT TRIM(t.des_aux) Tabela'+
         ' FROM TAB_AUXILIAR t'+
         ' WHERE t.tip_aux=12'+
         ' ORDER BY 1';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  If Trim(DMBelShop.CDS_Busca.FieldBYName('Tabela').AsString)='' Then
  Begin
    msg('Sem Tabela a Transferir para as Lojas !!','A');
    Screen.Cursor:=crDefault;
    ControleMenu(True);
    DMBelShop.CDS_Busca.Close;
    Exit;
  End;

  // Transfere Tabelas para Lojas ==============================================
  sgLojasNConectadas:='';

  // Seleciona Lojas ===========================================================
  sgOutrasEmpresa:='(50)';
  FrmSelectEmpProcessamento:=TFrmSelectEmpProcessamento.Create(Self);
  FrmSelectEmpProcessamento.bUsarMatriz:=False;
  FrmSelectEmpProcessamento.ShowModal;

  // Verifica se Existe Empresa a Processar ====================================
  If FrmSelectEmpProcessamento.iNrEmpProc=0 Then
  Begin
    ControleMenu(True);
    FrmSelectEmpProcessamento.Free;
    Exit;
  End; // If FrmSelectEmpProcessamento.iNrEmpProc=1 Then
  FrmSelectEmpProcessamento.Free;

  DMBelShop.CDS_EmpProcessa.First;
  While Not DMBelShop.CDS_EmpProcessa.Eof do
  Begin

    if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then
    Begin
      sgCodEmp:=DMBelShop.CDS_EmpProcessaCOD_FILIAL.AsString;
      sgDesLoja:=DMBelShop.CDS_EmpProcessaRAZAO_SOCIAL.AsString;

      // Apresentacao ==========================================================
      OdirPanApres.Caption:='AGUARDE !! Processando Empresa: '+sgCodEmp+' - '+sgDesLoja;
      OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
      OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
      OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
      OdirPanApres.Font.Style:=[fsBold];
      OdirPanApres.Parent:=FrmBelShop;
      OdirPanApres.Visible:=True;
      Application.ProcessMessages;

      DMSidicom.SidicomTransfereTabelas;

    End; // if DMBelShop.CDS_EmpProcessaPROC.AsString='SIM' Then

    OdirPanApres.Visible:=False;

    DMBelShop.CDS_EmpProcessa.Next;
  End; // While Not DMBelShop.CDS_EmpProcessa.Eof do

  Screen.Cursor:=crDefault;
  DMBelShop.CDS_Busca.Close;
  ControleMenu(True);

  // Apresentas Erros ==========================================================
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(7);
  FrmSolicitacoes.EditorMargemLucro.Lines.Clear;

  If sgLojasNConectadas<>'' Then
  Begin
    bErros:=True;
    FrmSolicitacoes.EditorMargemLucro.Lines.Add('=======================================================');
    FrmSolicitacoes.EditorMargemLucro.Lines.Add('LOJAS NO PROCESSADAS');
    FrmSolicitacoes.EditorMargemLucro.Lines.Add(sgLojasNConectadas);
    FrmSolicitacoes.EditorMargemLucro.Lines.Add('=======================================================');
  End; // If sgLojasNConectadas<>'' Then

  If Mem_Salvar.Lines.Count>0 Then
  Begin
    bErros:=True;
    FrmSolicitacoes.EditorMargemLucro.Lines.Add('=======================================================');
    For i:=0 to Mem_Salvar.Lines.Count-1 do
    Begin
      FrmSolicitacoes.EditorMargemLucro.Lines.Add(Mem_Salvar.Lines[i]);
    End; // For i:=0 to mMemo.Lines.Count-1 do
    FrmSolicitacoes.EditorMargemLucro.Lines.Add('=======================================================');
  End; // If Mem_Salvar.Lines.Count>0 Then

  If bErros Then
  Begin
    FrmSolicitacoes.Caption:='TRANSFERNCAS DE TABELAS';
    FrmSolicitacoes.Ts_MargemLucroFormulas.Caption:='Relao de Problemas Encontrados';

    FrmSolicitacoes.ShowModal;
    FreeAndNil(FrmSolicitacoes);
  End; // If bErros Then

  Mem_Salvar.Lines.Clear;
  Mem_Salvar.Width:=ii;

end;

procedure TFrmBelShop.SubMenuVerificaImportacaoEstoquesClick(Sender: TObject);
Var
  MySql: String;
begin

  If msg('VERIFIQUE se Algum j esta'+cr+'Efetuando Atualizao !!'+cr+cr+'Deseja Continuar ??','C')=2 Then
   Exit;

  OdirPanApres.Caption:='AGUARDE !! Localizando ltimas Atualizaes de Estoques...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
  OdirPanApres.Visible:=True;
  Refresh;

  Screen.Cursor:=crAppStart;

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(18);
  FrmSolicitacoes.Caption:='VERIFICA POSIO DE ESTOQUES DAS LOJAS';
  FrmSolicitacoes.Ts_Selecionar.Caption:='Data da ltima Importao de Saldo de Estoques';
  FrmSolicitacoes.Bt_SelecionarOK.Caption:='Atualizar';
  FrmSolicitacoes.Lab_Conta.Caption:='0';
  FrmSolicitacoes.Lab_Conta.Visible:=True;

  MySql:=' SELECT DISTINCT'+
         ' ''NAO'' PROC,'+
         ' em.COD_FILIAL,'+
         ' em.RAZAO_SOCIAL,'+
         ' es.dta_atualizacao,'+
         ' es.hra_atualizacao'+
         ' FROM EMP_CONEXOES em'+
         '     LEFT JOIN ESTOQUE es ON em.cod_filial=es.codfilial'+
         ' WHERE (em.Ind_Ativo=''SIM'' OR em.Cod_Filial IN (''99'') OR em.Cod_Filial IN (''50''))'+
         ' ORDER BY em.Cod_Filial';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySql;
  DMBelShop.CDS_Busca.Open;

  FrmSolicitacoes.Dbg_Selecionar.Columns.Add;
  FrmSolicitacoes.Dbg_Selecionar.Columns[0].FieldName :='PROC';
  FrmSolicitacoes.Dbg_Selecionar.Columns[0].Alignment :=taLeftJustify;
  FrmSolicitacoes.Dbg_Selecionar.Columns[0].Width :=80;
  FrmSolicitacoes.Dbg_Selecionar.Columns[0].Title.Caption := 'Atualizar ?';
  FrmSolicitacoes.Dbg_Selecionar.Columns[0].Title.Alignment :=taLeftJustify;

  FrmSolicitacoes.Dbg_Selecionar.Columns.Add;
  FrmSolicitacoes.Dbg_Selecionar.Columns[1].FieldName :='COD_FILIAL';
  FrmSolicitacoes.Dbg_Selecionar.Columns[1].Alignment := taCenter;
  FrmSolicitacoes.Dbg_Selecionar.Columns[1].Title.Caption := 'Loja';
  FrmSolicitacoes.Dbg_Selecionar.Columns[1].Width :=40;
  FrmSolicitacoes.Dbg_Selecionar.Columns[1].Title.Alignment :=taCenter;

  FrmSolicitacoes.Dbg_Selecionar.Columns.Add;
  FrmSolicitacoes.Dbg_Selecionar.Columns[2].FieldName :='RAZAO_SOCIAL';
  FrmSolicitacoes.Dbg_Selecionar.Columns[2].Alignment := taLeftJustify;
  FrmSolicitacoes.Dbg_Selecionar.Columns[2].Title.Caption := 'Razo Social';
  FrmSolicitacoes.Dbg_Selecionar.Columns[2].Width :=300;
  FrmSolicitacoes.Dbg_Selecionar.Columns[2].Title.Alignment :=taLeftJustify;

  FrmSolicitacoes.Dbg_Selecionar.Columns.Add;
  FrmSolicitacoes.Dbg_Selecionar.Columns[3].FieldName :='dta_atualizacao';
  FrmSolicitacoes.Dbg_Selecionar.Columns[3].Alignment := taCenter;
  FrmSolicitacoes.Dbg_Selecionar.Columns[3].Title.Caption := 'Data Ult.Atual.';
  FrmSolicitacoes.Dbg_Selecionar.Columns[3].Width :=90;
  FrmSolicitacoes.Dbg_Selecionar.Columns[3].Title.Alignment :=taCenter;

  FrmSolicitacoes.Dbg_Selecionar.Columns.Add;
  FrmSolicitacoes.Dbg_Selecionar.Columns[4].FieldName :='hra_atualizacao';
  FrmSolicitacoes.Dbg_Selecionar.Columns[4].Alignment := taCenter;
  FrmSolicitacoes.Dbg_Selecionar.Columns[4].Title.Caption := 'Hora Ult.Atual.';
  FrmSolicitacoes.Dbg_Selecionar.Columns[4].Width :=90;
  FrmSolicitacoes.Dbg_Selecionar.Columns[4].Title.Alignment :=taCenter;

  FrmSolicitacoes.Dbg_Selecionar.Options:=[dgTitles,dgColumnResize,dgColLines,dgRowLines,dgTabs,dgAlwaysShowSelection];

  Screen.Cursor:=crDefault;

  OdirPanApres.Visible:=False;
  
  FrmSolicitacoes.ShowModal;

  DMBelShop.CDS_Busca.Close;
  FreeAndNil(FrmSolicitacoes);

end;

procedure TFrmBelShop.DiasInformadosClick(Sender: TObject);
begin
  If Not Gb_GeraOCCalculaCompra.Visible Then
   Begin
     Gb_GeraOCCalculaCompra.Visible:=True;
     Gb_GeraOCEstoqueTransito.Visible:=True;

     PC_GeraOCApresentacao.TabIndex:=0;
     PC_GeraOCApresentacaoChange(Self);

     Dbg_GeraOCGrid.SelectedIndex:=0;
     Dbg_GeraOCGrid.SelectedIndex:=3;
     EdtGeraOCDias.SetFocus;
   End
  Else
   Begin
     Gb_GeraOCCalculaCompra.Visible:=False;
     Gb_GeraOCEstoqueTransito.Visible:=False;

     Dbg_GeraOCGrid.SetFocus;;
   End
end;

procedure TFrmBelShop.DiasEstocagemParametroClick(Sender: TObject);
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  If msg('Deseja Realmente Recalcular'+cr+cr+'a Necessidade de Compra ??','C')=2 Then
   Exit;

  sNumDoc:=EdtGeraOCBuscaDocto.Text;

  // Calcula Sugestes / Transferencias / Estoque Excedente ====================
  OCCalculaSugTransfExc(sNumDoc, DateToStr(DtEdt_GeraOCDataDocto.Date));

  // Busca Totais das OCs ======================================================
  TotaisOC(sNumDoc);

  Edt_OCTotProdutos.Value:=0;

  msg('Calculo Efetuado com SUCESSO !!','A');

  Lb_EmpAprocessar.Caption:='0';
  Lb_EmpProcessadas.Caption:='0';

  PC_OrdemCompra.TabIndex:=1;
  PC_OrdemCompraChange(Self);

  EdtGeraOCBuscaDocto.Value:=StrToInt(sNumDoc);
  EdtGeraOCBuscaDoctoExit(Sender);

end;

procedure TFrmBelShop.Bt_GeraOCPreVisualizaOCClick(Sender: TObject);
Var
  MySql, dir_relat: String;
begin
  Screen.Cursor:=crAppStart;

  OdirPanApres.Caption:='AGUARDE !! Montando Pr-Visualizao...';
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2));
  OdirPanApres.Visible:=True;
  Refresh;

  // Busca OC -----------------------------------------------------
  If Bt_GeraOCPreVisualizaOC.Caption=' Pr-Visualizao OC' Then
   MySql:=' SELECT oc.des_empresa, oc.num_oc_gerada,';

  If Bt_GeraOCPreVisualizaOC.Caption=' Pr-Visualizao TR' Then
   MySql:=' SELECT ''TR-''||oc.des_empresa des_empresa, oc.num_oc_gerada,';

  MySql:=
   MySql+' Case co.compl_endereco'+
         '   when '''' Then'+
         '      co.des_endereco ||'', ''|| co.num_endereco'+
         '   Else'+
         '      co.des_endereco ||'', ''|| co.num_endereco ||'' - ''|| co.compl_endereco'+
         ' End Endereco,'+
         ' co.des_bairro, co.des_cidade, co.cod_uf,'+

         ' cast((substring(co.cod_cep from 1 for 5) ||''-''|| substring(co.cod_cep from 6 for 3)) as varchar(9)) cod_cep,'+

         ' CAST(('+
         ' substring(co.num_cnpj from 1 for 2) ||''.''||'+
         ' substring(co.num_cnpj from 3 for 3) ||''.''||'+
         ' substring(co.num_cnpj from 6 for 3) ||''/''||'+
         ' substring(co.num_cnpj from 9 for 4) ||''-''||'+
         ' substring(co.num_cnpj from 13 for 2'+
         ' )) AS VARCHAR(18)) num_cnpj,'+

         ' co.inscr_estadual,'+
         ' case oc.ind_oc_gerada'+
         '   When ''N'' Then'+
         '      ''ABERTA'''+
         '   Else'+
         '      ''ABERTA - PENDENTE FORNECEDOR'''+
         ' End Situacao,'+
         ' Cast(oc.dta_oc_gerada as Date) Dta_Pedido,'+
         ' Cast(oc.dta_oc_gerada as Date) Dta_Entrega,'+
         ' oc.cod_fornecedor, oc.des_fornecedor,'+
         ' oc.cod_item, oc.cod_barras, oc.cod_referencia_forn,'+
         ' oc.des_item, oc.uni_compra, oc.uni_venda,'+
         ' oc.qtd_acomprar, oc.vlr_uni_compra, oc.per_desconto,'+
         ' oc.vlr_tot_compra,'+
         ' lpad(''=====>> ORDEM DE COMPRA PARA SIMPLES CONFERNCIA <<====='',2000,'''') obs_oc,'+
         ' oc.cod_comprador, us.des_usuario,'+
         ' ''000.000.000.0000'' Enderecamento'+

         ' FROM OC_COMPRAR oc'+
         '    LEFT JOIN EMP_CONEXOES co ON oc.cod_empresa=co.cod_filial'+
         '    LEFT JOIN PS_USUARIOS  us ON oc.cod_comprador=us.cod_usuario'+

         ' where oc.num_documento='+VarToStr(EdtGeraOCEditaDocto.Value)+
         ' And   oc.cod_empresa='+QuotedStr(DMBelShop.IBQ_AComprarEditaCOD_EMPRESA.AsString)+
         ' And   oc.ind_oc_gerada='+QuotedStr('N')+
         ' And   oc.cod_fornecedor='+QuotedStr(DMBelShop.IBQ_AComprarEditaCOD_FORNECEDOR.AsString);

         If Bt_GeraOCPreVisualizaOC.Caption=' Pr-Visualizao OC' Then
         Begin
           MySql:=
            MySql+' And   oc.qtd_transf=0';

          If Rb_GeraOCEditaComQtd.Checked Then
           MySql:=
            MySql+' And oc.qtd_acomprar<>0';

          If Rb_GeraOCEditaSemQtd.Checked Then
           MySql:=
            MySql+' And oc.qtd_acomprar=0';
         End; // If Bt_GeraOCPreVisualizaOC.Caption=' Pr-Visualizao OC' Then

         If Bt_GeraOCPreVisualizaOC.Caption=' Pr-Visualizao TR' Then
         Begin
           MySql:=
            MySql+' And   oc.qtd_transf>0';
         End; // If Bt_GeraOCPreVisualizaOC.Caption=' Pr-Visualizao TR' Then

         MySql:=
          MySql+' AND   EXISTS (SELECT 1'+
                '               FROM OC_COMPRAR_DOCS d'+
                '               WHERE d.num_docto=oc.num_documento'+
                '               AND   d.origem<>'+QuotedStr('Linx')+')'+

                ' order by oc.des_item';
  DMBelShop.IBQ_OrdemCompra.Close;
  DMBelShop.IBQ_OrdemCompra.SQL.Clear;
  DMBelShop.IBQ_OrdemCompra.SQL.Add(MySql);
  DMBelShop.IBQ_OrdemCompra.Open;

  // Dados da Filial ----------------------------------------------
  MySql:=' select cl.telefone, cl.contato, cl.email'+
         ' from clientefone cl, filial fi'+
         ' where cl.codcliente = fi.codnocliente'+
         ' and fi.codfilial='+QuotedStr(DMBelShop.IBQ_AComprarEditaCOD_EMPRESA.AsString)+
         ' order by cl.email desc';
  IBQ_Matriz.Close;
  IBQ_Matriz.SQL.Clear;
  IBQ_Matriz.SQL.Add(MySql);
  IBQ_Matriz.Open;

  sEmpTelefone  :=Trim(IBQ_Matriz.FieldByName('Telefone').AsString);
  sEmpCcontato  :=Trim(IBQ_Matriz.FieldByName('Contato').AsString);
  sEmpEmail     :=Trim(IBQ_Matriz.FieldByName('Email').AsString);

  // Dados do Fornecedor ------------------------------------------
  MySql:=' select fo.endereco, fo.cidade, fo.estado,'+
         ' (substring(fo.codigopostal from 1 for 5) ||''-''||'+
         '  substring(fo.codigopostal from 6 for 3)) cod_cep,'+
         ' fo.fone1, fo.fonefax, fo.email, fo.contato'+
         ' from forneced fo'+
         ' where fo.codfornecedor='+QuotedStr(DMBelShop.IBQ_AComprarEditaCOD_FORNECEDOR.AsString);
  IBQ_Matriz.Close;
  IBQ_Matriz.SQL.Clear;
  IBQ_Matriz.SQL.Add(MySql);
  IBQ_Matriz.Open;

  sFornEndereco :=Trim(IBQ_Matriz.FieldByName('Endereco').AsString);
  sFornCidade   :=Trim(IBQ_Matriz.FieldByName('Cidade').AsString);
  sFornEstado   :=Trim(IBQ_Matriz.FieldByName('Estado').AsString);
  sFornCodCep   :=Trim(IBQ_Matriz.FieldByName('Cod_Cep').AsString);
  sFornFone1    :=Trim(IBQ_Matriz.FieldByName('Fone1').AsString);
  sFornFoneFax  :=Trim(IBQ_Matriz.FieldByName('FoneFax').AsString);
  sFornEmail    :=Trim(IBQ_Matriz.FieldByName('EMail').AsString);
  sFornContato  :=Trim(IBQ_Matriz.FieldByName('Contato').AsString);
  IBQ_Matriz.Close;

  // Imprime Ordem de Compra --------------------------------------
  sgTipoImpressao:='ImpOC';

  // Diretorio dos Relatrios -------------------------------------
  {$IFDEF MSWINDOWS}
    dir_relat       :=  ExtractFilePath(Application.ExeName)+'Relatorios\';
  {$ENDIF}

  DMRelatorio.frDBDataSet1.DataSet:=DMBelShop.IBQ_OrdemCompra;
  DMRelatorio.frReport1.LoadFromFile(Dir_Relat+'OrdemCompra.frf');

  // Atualiza Variaveis -------------------------------------------
  DMRelatorio.frReport1.Dictionary.Variables.Variable['Telefone']:=#39+sEmpTelefone+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['Contato']:=#39+sEmpCcontato+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['EMail']:=#39+sEmpEmail+#39;

  DMRelatorio.frReport1.Dictionary.Variables.Variable['EnderecoForn']:=#39+sFornEndereco+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['CidadeForn']:=#39+sFornCidade+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['EstadoForn']:=#39+sFornEstado+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['CepForn']:=#39+sFornCodCep+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['FoneForn']:=#39+sFornFone1+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['FoneFaxForn']:=#39+sFornFonefax+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['EmailForn']:=#39+sFornEmail+#39;
  DMRelatorio.frReport1.Dictionary.Variables.Variable['ContatoForn']:=#39+sFornContato+#39;

  DMRelatorio.frReport1.PrepareReport;
  DMRelatorio.frReport1.ShowReport;

  Screen.Cursor:=crDefault;
  OdirPanApres.Visible:=False;
  Refresh;

end;

procedure TFrmBelShop.ZeraQuantidadeAComprarClick(Sender: TObject);
Var
  MySql: String;
begin
  Dbg_GeraOCGrid.SetFocus;

  If DMBelShop.CDS_AComprarItens.IsEmpty Then
   Exit;

  If msg('Deseja Realmente ZERAR '+cr+cr+'as Quantidade A Comnpar ??','C')=2 Then
   Exit;

  sNumDoc:=EdtGeraOCBuscaDocto.Text;

  OdirPanApres.Caption:='AGUARDE !! ReCalculando Ordem de Compra Nmero: '+sNumDoc;
  OdirPanApres.Width:=Length(OdirPanApres.Caption)*10;
  OdirPanApres.Left:=ParteInteiro(FloatToStr((FrmBelShop.Width-OdirPanApres.Width)/2));
  OdirPanApres.Top:=ParteInteiro(FloatToStr((FrmBelShop.Height-OdirPanApres.Height)/2))-20;
  OdirPanApres.BringToFront();
  OdirPanApres.Visible:=True;
  Refresh;

  // Verifica se Transao esta Ativa
  If DMBelShop.SQLC.InTransaction Then
   DMBelShop.SQLC.Rollback(TD);

  // Monta Transacao ===========================================================
  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    MySql:=' Update OC_COMPRAR o'+
           ' SET o.qtd_acomprar=0'+
           ', o.vlr_descontos=0'+
           ', o.vlr_bruto=0'+
           ', o.vlr_base_icms=0'+
           ', o.vlr_icms=0'+
           ', o.vlr_ipi=0'+
           ', o.vlr_base_st=0'+
           ', o.vlr_st=0'+
           ', o.vlr_tot_compra=0'+
           ', o.vlr_tot_venda=0'+

           ' WHERE Ind_OC_Gerada=''N'''+
           ' AND   o.qtd_transf=0'+
           ' AND   o.qtd_acomprar<>0'+
           ' And   Cast(o.dta_documento as Date)='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DateToStr(DtEdt_GeraOCDataDocto.Date))))+
           ' AND   o.Num_Documento='+sNumDoc;
    DMBelShop.SQLC.Execute(MySql,nil,nil);

    // Atualiza Transacao ======================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';

    OdirPanApres.Visible:=False;

    Screen.Cursor:=crDefault;

  Except
    on e : Exception do
    Begin
      // Abandona Transacao ====================================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';

      OdirPanApres.Visible:=False;

      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      Exit;
    End; // on e : Exception do
  End; // Try

  // Busca Totais das OCs ======================================================
  TotaisOC(sNumDoc);

  Edt_OCTotProdutos.Value:=0;

  Lb_EmpAprocessar.Caption:='0';
  Lb_EmpProcessadas.Caption:='0';

  EdtGeraOCBuscaDocto.Value:=StrToInt(sNumDoc);
  EdtGeraOCBuscaDoctoExit(Sender);

  msg('Calculo Efetuado com SUCESSO !!','A');

end;

procedure TFrmBelShop.Rb_CalculoTpProcLocalKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Rb_CalculoTpProcLocalClick(Self);

end;

procedure TFrmBelShop.Rb_CalculoTpProcLocalClick(Sender: TObject);
begin
  AcertaRb_Style(Rb_CalculoTpProcLocal);
  AcertaRb_Style(Rb_CalculoTpProcLoja);
end;

procedure TFrmBelShop.SubMenuSalaoRelatoriosClick(Sender: TObject);
begin

  // Abre Form de Solicitaes (Enviar o TabIndex a Manter Ativo) ==============
  FrmSolicitacoes:=TFrmSolicitacoes.Create(Self);
  AbreSolicitacoes(23);

  bgProcessar:=False;
  FrmSolicitacoes.ShowModal;

  FreeAndNil(FrmSolicitacoes);
end;

procedure TFrmBelShop.Ckb_EstFisFinanGiroEstoqueEmpClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckb_EstFisFinanGiroEstoqueEmp);

  If Ckb_EstFisFinanGiroEstoqueEmp.Checked Then
   Begin
     DMVirtual.CDS_V_GiroEstoque.Filtered:=False;
     DMVirtual.CDS_V_GiroEstoque.Filter:='(COD_LOJA=''Empresa'' OR ORDEM<7)';
     DMVirtual.CDS_V_GiroEstoque.Filtered:=True;
   End
  Else
   Begin
     DMVirtual.CDS_V_GiroEstoque.Filtered:=False;
     DMVirtual.CDS_V_GiroEstoque.Filter:='';
   End;
end;

procedure TFrmBelShop.Ckb_EstFisFinanGiroEstoqueEmpKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_EstFisFinanGiroEstoqueEmpClick(Self);
end;

procedure TFrmBelShop.MenuEstoquesSimuladorEstoquesClick(Sender: TObject);
begin
  FrmControleEstoques:=TFrmControleEstoques.Create(Self);

//  TabSheetInvisivel(FrmControleEstoques);
//  FrmControleEstoques.Ts_ContEstSolic.TabVisible:=True;

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmControleEstoques, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Permisses de Visualizao ================================================
//  PermissaoVisual(FrmcSalao.Ts_Profissionais);

  FrmControleEstoques.Ts_ContEstFornecedores.TabVisible:=False;
  FrmControleEstoques.Ts_ContEstProdutos.TabVisible:=False;

  FrmControleEstoques.PC_ContEstPrincipal.TabIndex:=0;
  FrmControleEstoques.ShowModal;

  FreeAndNil(FrmControleEstoques);

end;

procedure TFrmBelShop.SubMenuCentroDistAnaliseReposicoesClick(Sender: TObject);
begin
  FrmCentralTrocas:=TFrmCentralTrocas.Create(Self);
  DMCentralTrocas:=TDMCentralTrocas.Create(Self);

  FrmCentralTrocas.Bt_NotasEntDevFechar.Parent:=FrmCentralTrocas.Pan_AnaliseRepos;

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmCentralTrocas, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Apresenta TabSheet ========================================================
  TabSheetInvisivel(FrmCentralTrocas);
  FrmCentralTrocas.Ts_AnaliseReposicoes.TabVisible:=True;

  FrmCentralTrocas.ShowModal;

  FreeAndNil(FrmCentralTrocas);
  FreeAndNil(DMCentralTrocas);

end;

procedure TFrmBelShop.Ckbx_ConsultaNFeApresParcelaClick(Sender: TObject);
begin
  AcertaCkb_Style(Ckbx_ConsultaNFeApresParcela);
  AcertaCkb_Style(Ckbx_ConsultaNFeApresProduto);

  Ts_ConsultaNFeProdutos.TabVisible:=False;

  // Inicial TabSheet -----------------------------------------------
  If Ckbx_ConsultaNFeApresProduto.Checked Then
  Begin
    Ts_ConsultaNFeProdutos.TabVisible:=True;
  End;

  PC_ConsultaMovtoComprChange(Self);

end;

procedure TFrmBelShop.Ckbx_ConsultaNFeApresParcelaKeyUp(Sender: TObject;var Key: Word; Shift: TShiftState);
begin
   Ckbx_ConsultaNFeApresParcelaClick(Self);
end;

procedure TFrmBelShop.SubMenuComisVendedoresClick(Sender: TObject);
begin

  sgDescricao:='Comissao';

  FrmComissaoVendedor:=TFrmComissaoVendedor.Create(Self);
  FrmComissaoVendedor.Ts_ParametrosVendedores.TabVisible:=False;
  FrmComissaoVendedor.PC_ComissaoVendedor.TabIndex:=0;
  FrmComissaoVendedor.Bt_Clipboard.Visible:=False;
  FrmComissaoVendedor.Rb_ComisVendSintetico.Visible:=False;
  FrmComissaoVendedor.Rb_ComisVendAnalitico.Visible:=False;

  FrmComissaoVendedor.ShowModal;

  FreeAndNil(FrmComissaoVendedor);

end;

procedure TFrmBelShop.ParametrosVendedores1Click(Sender: TObject);
begin

  sgDescricao:='Parametros';

  FrmComissaoVendedor:=TFrmComissaoVendedor.Create(Self);

  FrmComissaoVendedor.Ts_Comissoes.TabVisible:=False;
  FrmComissaoVendedor.Ts_Produtos.TabVisible:=False;

  FrmComissaoVendedor.Bt_ImportaProdutos.Visible:=True;
  FrmComissaoVendedor.Bt_Clipboard.Visible:=False;
  FrmComissaoVendedor.Rb_ComisVendSintetico.Visible:=False;
  FrmComissaoVendedor.Rb_ComisVendAnalitico.Visible:=False;

  FrmComissaoVendedor.PC_ComissaoVendedor.TabIndex:=0;
  FrmComissaoVendedor.ShowModal;

  FreeAndNil(FrmComissaoVendedor);

end;

procedure TFrmBelShop.Dbg_ConsultaNFeProdutosDrawColumnCell(Sender: TObject; const Rect: TRect;
              DataCol: Integer; Column: TColumn; State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    if DMVirtual.CDS_V_NFeProdutosCOD_PROD.AsString='TOTAIS' Then
    Begin
      Dbg_ConsultaNFeProdutos.Canvas.Font.Style:=[fsBold];
      Dbg_ConsultaNFeProdutos.Canvas.Font.Color:=clWhite;  //-->> Cor da Fonte
      Dbg_ConsultaNFeProdutos.Canvas.Brush.Color:=clRed; // -->> Cor das Celulas
    end;
  End; // if not (gdSelected in State) Then

  Dbg_ConsultaNFeProdutos.Canvas.FillRect(Rect);
  Dbg_ConsultaNFeProdutos.DefaultDrawDataCell(Rect,Column.Field,state);

  // Alinhamento
  DMVirtual.CDS_V_NFeProdutosCOD_LOJA.Alignment:=taCenter;
  DMVirtual.CDS_V_NFeProdutosCOD_PROD.Alignment:=taRightJustify;
  DMVirtual.CDS_V_NFeProdutosCOD_COMPRV.Alignment:=taRightJustify;
end;

procedure TFrmBelShop.Ckbx_ConsultaNFeApresTotaisClick(Sender: TObject);
begin

  AcertaCkb_Style(Ckbx_ConsultaNFeApresTotais);

  If DMVirtual.CDS_V_NFeProdutos.IsEmpty Then
  Begin
    Ckbx_ConsultaNFeApresTotais.Checked:=False;
    AcertaCkb_Style(Ckbx_ConsultaNFeApresTotais);
    Exit;
  End;

  If Ckbx_ConsultaNFeApresTotais.Checked  Then
   Begin
     DMVirtual.CDS_V_NFeProdutos.DisableControls;
     DMVirtual.CDS_V_NFeProdutos.Close;
     DMVirtual.CDS_V_NFeProdutos.Filtered:=False;
     DMVirtual.CDS_V_NFeProdutos.Filter:='COD_PROD='+QuotedStr('TOTAIS');
     DMVirtual.CDS_V_NFeProdutos.Filtered:=True;
     DMVirtual.CDS_V_NFeProdutos.Open;
     DMVirtual.CDS_V_NFeProdutos.EnableControls;

     DMVirtual.bgNFeProdutos:=False; // Se Executa o Evento: TDMVirtual.CDS_V_NFeProdutosAfterScroll(DataSet: TDataSet);
     Dbg_ConsultaNFeProdutos.SetFocus;
   End
  Else // If Ckbx_ConsultaNFeApresTotais.Checked Then
   Begin
     DMVirtual.bgNFeProdutos:=True; // Se Executa o Evento: TDMVirtual.CDS_V_NFeProdutosAfterScroll(DataSet: TDataSet);
     DMVirtual.CDS_SelectLojaAfterScroll(DMVirtual.CDS_V_NFeProdutos);
   End; // If Ckbx_ConsultaNFeApresTotais.Checked Then

end;

procedure TFrmBelShop.Ckbx_ConsultaNFeApresTotaisKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckbx_ConsultaNFeApresTotaisClick(Self);
end;

procedure TFrmBelShop.SubMenuCentroDistQtdCaixaCDClick(Sender: TObject);
begin

//  msg('Opo em Desenvolvimento !!','A');
 // Exit;

  FrmCentralTrocas:=TFrmCentralTrocas.Create(Self);
  DMCentralTrocas:=TDMCentralTrocas.Create(Self);

  FrmCentralTrocas.Bt_NotasEntDevFechar.Parent:=FrmCentralTrocas.Pan_QtdCaixaCD;

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmCentralTrocas, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Apresenta TabSheet ========================================================
  TabSheetInvisivel(FrmCentralTrocas);
  FrmCentralTrocas.Ts_QtdCaixaCD.TabVisible:=True;

  FrmCentralTrocas.ShowModal;

  FreeAndNil(FrmCentralTrocas);
  FreeAndNil(DMCentralTrocas);
end;

procedure TFrmBelShop.Dbe_ConEmpresasCodLojaLinxKeyPress(Sender: TObject;
  var Key: Char);
begin
  If not (key in ['0'..'9']) Then
  Begin
    Key := #0;
    Exit;
  End;

end;

procedure TFrmBelShop.EdtDta_ConEmpresasInicioLinxPropertiesChange(Sender: TObject);
begin
  If (Trim(Dbe_ConEmpresasCodLojaLinx.Text)='') or (Trim(Dbe_ConEmpresasCodLojaLinx.Text)='0') Then
  Begin
    EdtDta_ConEmpresasInicioLinx.Clear;
    EdtDta_ConEmpresasInventLinx.Clear;
  End;
end;

procedure TFrmBelShop.Dbe_ConEmpresasCodLojaLinxExit(Sender: TObject);
begin
  If (Trim(Dbe_ConEmpresasCodLojaLinx.Text)='') or (Trim(Dbe_ConEmpresasCodLojaLinx.Text)='0') Then
  Begin
    Dbe_ConEmpresasCodLojaLinx.Text:='0';
    EdtDta_ConEmpresasInicioLinx.Clear;
    EdtDta_ConEmpresasInventLinx.Clear;
  End;

end;

procedure TFrmBelShop.Button1Click(Sender: TObject);
begin
//  MySqlSelect:=' select *'+
//               ' from odir1 pl'+
//               ' order by pl.cod_loja, pl.num_planilha, pl."INDEX" desc';
//  DMBelShop.CDS_Busca.Close;
//  DMBelShop.SDS_Busca.CommandText:=MySqlSelect;
//  DMBelShop.CDS_Busca.Open;
//
//  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
//  TD.IsolationLevel:=xilREADCOMMITTED;
//  DMBelShop.SQLC.StartTransaction(TD);
//  Try // Try da Transao
//    Screen.Cursor:=crAppStart;
//    DateSeparator:='.';
//    DecimalSeparator:='.';
//
//    MontaProgressBar(True, FrmBelShop);
//    pgProgBar.Properties.Max:=DMBelShop.CDS_Busca.RecordCount;
//    pgProgBar.Position:=0;
//
//    While not DMBelShop.CDS_Busca.Eof do
//    Begin
//      Application.ProcessMessages;
//      pgProgBar.Position:=DMBelShop.CDS_Busca.RecNo;
//
//      If (Trim(DMBelShop.CDS_Busca.FieldByName('COD_PROFISSIONAL').AsString)='') and
//         (DMBelShop.CDS_Busca.FieldByName('INDEX').AsInteger=igNrDias-1) And
//         (igNrEmpProc=DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsInteger) Then
//      Begin
//         MySqlClausula1:=' update  odir1 pl'+
//                         ' set pl.cod_profissional='+QuotedStr(sgCodProd)+
//                         ' , pl.des_profissional='+QuotedStr(sgDescricao)+
//                         ' where pl.cod_loja='+QuotedStr(DMBelShop.CDS_Busca.FieldByName('COD_LOJA').AsString)+
//                         ' and pl.num_planilha='+DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsString+
//                         ' and pl."INDEX"='+DMBelShop.CDS_Busca.FieldByName('INDEX').AsString;
//         DMBelShop.SQLC.Execute(MySqlClausula1,nil,nil);
//
//
//      End;
//
//      igNrEmpProc:=DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsInteger;
//      igNrDias   :=DMBelShop.CDS_Busca.FieldByName('INDEX').AsInteger;
//      sgCodProd  :=DMBelShop.CDS_Busca.FieldByName('COD_PROFISSIONAL').AsString;
//      sgDescricao:=DMBelShop.CDS_Busca.FieldByName('DES_PROFISSIONAL').AsString;
//
//      DMBelShop.CDS_Busca.Next
//    End;
//    DMBelShop.CDS_Busca.Close;
//    MontaProgressBar(False, FrmBelShop);
//
//    // Atualiza Transacao ======================================================
//    DMBelShop.SQLC.Commit(TD);
//
//    DateSeparator:='/';
//    DecimalSeparator:=',';
//
//    Screen.Cursor:=crDefault;
//  Except // Except da Transao
//    on e : Exception do
//    Begin
//      // Abandona Transacao ====================================================
//      DMBelShop.SQLC.Rollback(TD);
//
//      DateSeparator:='/';
//      DecimalSeparator:=',';
//
//      MontaProgressBar(False, FrmBelShop);
//
//      Screen.Cursor:=crDefault;
//
//      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
//      Exit;
//    End; // on e : Exception do
//  End; // Try da Transao
//
//  msg('fim','A');
end;

procedure TFrmBelShop.Button3Click(Sender: TObject);
begin
{
  MySqlClausula1:=' select e.cod_banco, e.dta_extrato, e.vlr_docto'+
                  ' from fin_bancos_extratos e, fin_bancos b'+
                  ' where e.cod_banco=b.cod_banco'+
                  ' and b.num_banco=33'+
                  ' and e.num_seq=999999'+
                  ' and e.vlr_docto=0'+
                  ' order by e.dta_extrato';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySqlClausula1;
  DMBelShop.CDS_Busca.Open;

  While not DMBelShop.CDS_Busca.Eof do
  Begin
    MySqlClausula1:=' select e.num_docto, e.vlr_docto'+
                    ' from fin_bancos_extratos e'+
                    ' where e.cod_banco='+DMBelShop.CDS_Busca.FieldByName('Cod_Banco').AsString+
                    ' and e.dta_extrato='+QuotedStr(f_Troca('/','.',f_Troca('-','.',DMBelShop.CDS_Busca.FieldByName('Dta_Extrato').AsString)))+
                    ' and e.num_seq<>999999'+
                    ' order by e.num_docto, e.vlr_docto';
    DMBelShop.CDS_Busca1.Close;
    DMBelShop.SDS_Busca1.CommandText:=MySqlClausula1;
    DMBelShop.CDS_Busca1.Open;

    sgNumSeq:=''; //Docto
    sgValor:='';
    While Not DMBelShop.CDS_Busca1.Eof do
    Begin
      If (sgNumSeq=DMBelShop.CDS_Busca1.FieldByName('Num_Docto').AsString) and
         (sgValor =DMBelShop.CDS_Busca1.FieldByName('Vlr_Docto').AsString) Then
      Begin
        Memo1.Lines.Add('Banco: '+DMBelShop.CDS_Busca.FieldByName('Cod_Banco').AsString+' - '+DMBelShop.CDS_Busca.FieldByName('Dta_Extrato').AsString);
        Break;
      end;

      sgNumSeq:=DMBelShop.CDS_Busca1.FieldByName('Num_Docto').AsString;
      sgValor :=DMBelShop.CDS_Busca1.FieldByName('Vlr_Docto').AsString;

      DMBelShop.CDS_Busca1.Next;
    End;

    DMBelShop.CDS_Busca1.Close;

    DMBelShop.CDS_Busca.Next;
  End;
  DMBelShop.CDS_Busca.Close;

  msg('FIM','A');
 }
end;

procedure TFrmBelShop.Dbg_FinanObjetivosManutEmpresasDrawColumnCell(
  Sender: TObject; const Rect: TRect; DataCol: Integer; Column: TColumn;
  State: TGridDrawState);
begin
  if not (gdSelected in State) Then
  Begin
    if DMBelShop.CDS_ObjetivosEmpresas.FieldByName('Cod_Linx').AsInteger<>0 then
     Dbg_FinanObjetivosManutEmpresas.Canvas.Brush.Color:=clLime;

    Dbg_FinanObjetivosManutEmpresas.Canvas.FillRect(Rect);
    Dbg_FinanObjetivosManutEmpresas.DefaultDrawDataCell(Rect,Column.Field,state);
  End;

  DMBelShop.CDS_ObjetivosEmpresasCOD_FILIAL.Alignment:=taCenter;
  DMBelShop.CDS_ObjetivosEmpresasCOD_LINX.Alignment:=taCenter;

end;

procedure TFrmBelShop.Ckb_FinanObjetivosManutNaoCompraKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  Ckb_FinanObjetivosManutNaoCompraClick(Self);
end;

procedure TFrmBelShop.Bt_AcertaPromocaoClick(Sender: TObject);
Var
  iNumPlan: Integer; // NUM_PLANILHA
  iIndex  : Integer; // INDEX
  sCodProf: String;  // COD_PROFISSIONAL
begin
  MySqlSelect:=' SELECT pl.cod_loja, pl.cod_profissional, pl.num_planilha, pl."INDEX"'+
               ' FROM ODIR_PROMOCAO pl'+
               ' order by pl.cod_loja, pl.num_planilha, pl."INDEX" desc';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySqlSelect;
  DMBelShop.CDS_Busca.Open;

  iNumPlan:=0; // NUM_PLANILHA
  iIndex  :=0; // INDEX
  sCodProf:=''; // COD_PROFISSIONAL

  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try // Try da Transao
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    MontaProgressBar(True, FrmBelShop);
    pgProgBar.Properties.Max:=DMBelShop.CDS_Busca.RecordCount;
    pgProgBar.Position:=0;

    While not DMBelShop.CDS_Busca.Eof do
    Begin
      Application.ProcessMessages;
      pgProgBar.Position:=DMBelShop.CDS_Busca.RecNo;

      If (Trim(DMBelShop.CDS_Busca.FieldByName('COD_PROFISSIONAL').AsString)='') and
         (DMBelShop.CDS_Busca.FieldByName('INDEX').AsInteger       =iIndex-1) And
         (DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsInteger=iNumPlan) Then
      Begin
        MySqlClausula1:=' update ODIR_PROMOCAO pl'+
                        ' set pl.cod_profissional='+QuotedStr(sCodProf)+
                        ' where pl.cod_loja='+QuotedStr(DMBelShop.CDS_Busca.FieldByName('COD_LOJA').AsString)+
                        ' and pl.num_planilha='+DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsString+
                        ' and pl."INDEX"='+DMBelShop.CDS_Busca.FieldByName('INDEX').AsString;
        DMBelShop.SQLC.Execute(MySqlClausula1,nil,nil);
      End
      Else
      If (Trim(DMBelShop.CDS_Busca.FieldByName('COD_PROFISSIONAL').AsString)='') and
         (DMBelShop.CDS_Busca.FieldByName('INDEX').AsInteger       <>iIndex-1) Then
      Begin
        MySqlSelect:=' SELECT v.cod_profissional'+
                     ' FROM SAL_PLAN_VENDAS v'+
                     ' WHERE v.num_planilha='+DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsString+
                     ' AND   v.cod_loja='+QuotedStr(DMBelShop.CDS_Busca.FieldByName('COD_LOJA').AsString)+
                     ' and   v."INDEX" BETWEEN '+IntToStr(DMBelShop.CDS_Busca.FieldByName('INDEX').AsInteger-2)+' and '+
                                                 IntToStr(DMBelShop.CDS_Busca.FieldByName('INDEX').AsInteger+2)+
                     ' ORDER BY v."INDEX"';
        DMBelShop.CDS_Busca1.Close;
        DMBelShop.SDS_Busca1.CommandText:=MySqlSelect;
        DMBelShop.CDS_Busca1.Open;

        If Trim(DMBelShop.CDS_Busca1.FieldByName('cod_profissional').AsString)<>'' Then
        Begin
          MySqlClausula1:=' update ODIR_PROMOCAO pl'+
                          ' set pl.cod_profissional='+QuotedStr(DMBelShop.CDS_Busca1.FieldByName('cod_profissional').AsString)+
                          ' where pl.cod_loja='+QuotedStr(DMBelShop.CDS_Busca.FieldByName('COD_LOJA').AsString)+
                          ' and pl.num_planilha='+DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsString+
                          ' and pl."INDEX"='+DMBelShop.CDS_Busca.FieldByName('INDEX').AsString;
          DMBelShop.SQLC.Execute(MySqlClausula1,nil,nil);
        End;
        DMBelShop.CDS_Busca1.Close;
      End;

      iNumPlan:=DMBelShop.CDS_Busca.FieldByName('NUM_PLANILHA').AsInteger;
      iIndex  :=DMBelShop.CDS_Busca.FieldByName('INDEX').AsInteger;
      sCodProf:=DMBelShop.CDS_Busca.FieldByName('COD_PROFISSIONAL').AsString;

      DMBelShop.CDS_Busca.Next
    End;
    DMBelShop.CDS_Busca.Close;
    MontaProgressBar(False, FrmBelShop);

    // Atualiza Transacao ======================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';

    Screen.Cursor:=crDefault;
  Except // Except da Transao
    on e : Exception do
    Begin
      // Abandona Transacao ====================================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';

      MontaProgressBar(False, FrmBelShop);

      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      Exit;
    End; // on e : Exception do
  End; // Try da Transao

  msg('fim','A');

end;

procedure TFrmBelShop.Button4Click(Sender: TObject);
begin
  MySqlSelect:=' SELECT d.empresa, d.cod_produto, d.dta_atualizacao'+
               ' FROM LINXPRODUTOSDETALHES d'+
               ' WHERE EXISTS (SELECT dt.empresa, dt.cod_produto, count(dt.cod_produto) tot'+
               ' FROM LINXPRODUTOSDETALHES dt'+
               ' WHERE dt.empresa=d.empresa'+
               ' AND dt.cod_produto=d.cod_produto'+
               ' GROUP BY dt.empresa, dt.cod_produto'+
               ' HAVING COUNT(dt.cod_produto) >1'+
               ' )'+
               ' ORDER BY d.empresa, d.cod_produto, d.dta_atualizacao desc';
  DMBelShop.CDS_Busca.Close;
  DMBelShop.SDS_Busca.CommandText:=MySqlSelect;
  DMBelShop.CDS_Busca.Open;

  TD.TransactionID:=Cardinal('10'+FormatDateTime('ddmmyyyy',date)+FormatDateTime('hhnnss',time));
  TD.IsolationLevel:=xilREADCOMMITTED;
  DMBelShop.SQLC.StartTransaction(TD);
  Try // Try da Transao
    Screen.Cursor:=crAppStart;
    DateSeparator:='.';
    DecimalSeparator:='.';

    MontaProgressBar(True, FrmBelShop);
    pgProgBar.Properties.Max:=DMBelShop.CDS_Busca.RecordCount;
    pgProgBar.Position:=0;

    sgCodEmp:='';
    sgCodProd:='';

    While not DMBelShop.CDS_Busca.Eof do
    Begin
      Application.ProcessMessages;
      pgProgBar.Position:=DMBelShop.CDS_Busca.RecNo;

      sgDta:=f_Troca('/','.',f_Troca('-','.',DMBelShop.CDS_Busca.FieldByName('dta_atualizacao').AsString));

      If (sgCodEmp=DMBelShop.CDS_Busca.FieldByName('empresa').AsString) and
         (sgCodProd=DMBelShop.CDS_Busca.FieldByName('cod_produto').AsString) Then
      Begin
         MySqlClausula1:=' DELETE FROM LINXPRODUTOSDETALHES pd'+
                         ' WHERE pd.empresa='+sgCodEmp+
                         ' AND pd.cod_produto='+sgCodProd+
                         ' AND pd.dta_atualizacao='+QuotedStr(sgDta);
         DMBelShop.SQLC.Execute(MySqlClausula1,nil,nil);
      End;

      sgCodEmp:=DMBelShop.CDS_Busca.FieldByName('empresa').AsString;
      sgCodProd:=DMBelShop.CDS_Busca.FieldByName('cod_produto').AsString;

      DMBelShop.CDS_Busca.Next
    End;
    DMBelShop.CDS_Busca.Close;
    MontaProgressBar(False, FrmBelShop);

    // Atualiza Transacao ======================================================
    DMBelShop.SQLC.Commit(TD);

    DateSeparator:='/';
    DecimalSeparator:=',';

    Screen.Cursor:=crDefault;
  Except // Except da Transao
    on e : Exception do
    Begin
      // Abandona Transacao ====================================================
      DMBelShop.SQLC.Rollback(TD);

      DateSeparator:='/';
      DecimalSeparator:=',';

      MontaProgressBar(False, FrmBelShop);

      Screen.Cursor:=crDefault;

      MessageBox(Handle, pChar('Mensagem de erro do sistema:'+#13+e.message), 'Erro', MB_ICONERROR);
      Exit;
    End; // on e : Exception do
  End; // Try da Transao

  msg('fim','A');

end;

procedure TFrmBelShop.SubMenuComprasGeraOCLinxClick(Sender: TObject);
begin
  FrmOCLinx:=TFrmOCLinx.Create(Self);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmOCLinx, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  // Permisses de Visualizao ================================================
//  PermissaoVisual(FrmoSalao.Ts_Profissionais);

  FrmOCLinx.ShowModal;

  FreeAndNil(FrmOCLinx);

end;

procedure TFrmBelShop.EdtFiltroCodProdLinxExit(Sender: TObject);
Var
  s: String;
begin

  If EdtFiltroCodProdLinx.Value<>0 Then
  Begin
    Screen.Cursor:=crAppStart;

    s:=DMBelShop.LINX_BuscaCodigoSIDICOM(IntToStr(EdtFiltroCodProdLinx.AsInteger));

    If Trim(s)='' Then
    Begin
      msg('Produto (Linx) NO Encontrado !!!', 'A');
      EdtFiltroCodProdLinx.Clear;
      EdtFiltroCodProdLinx.SetFocus;
      Exit;
    End;

    EdtFiltroCodProduto.SetFocus;
    EdtFiltroCodProduto.Text:=Trim(s);

    EdtFiltroCodProdLinx.Clear;

    EdtFiltroCodProdutoExit(Self);
    EdtFiltroCodProdLinx.SetFocus;
  End; // If EdtFiltroCodProdLinx.Value<>0 Then
end;

procedure TFrmBelShop.PrioridadesdeReposio1Click(Sender: TObject);
begin
  FrmPrioridadesReposicao:=TFrmPrioridadesReposicao.Create(Self);

  If (Sender is TMenuItem) Then
   igTagPermissao:=(Sender as TMenuItem).Tag;

  BloqueioBotoes(FrmPrioridadesReposicao, DMBelShop.CDS_Seguranca, igTagPermissao, Des_Login, bgInd_Admin);

  FrmPrioridadesReposicao.ShowModal;

  FreeAndNil(FrmPrioridadesReposicao);

end;

procedure TFrmBelShop.Dbg_GeraOCProdutosKeyUp(Sender: TObject;
  var Key: Word; Shift: TShiftState);
begin
  // BLOQUEAR TECLA Ctrl+Del ===================================================
  if ((Shift=[ssCtrl]) and (key=vk_delete)) THEN
   Abort;

end;

procedure TFrmBelShop.SubMenuFinanConciliaDepositosClick(Sender: TObject);
begin
  FrmBancoExtratos.Caption:='Depsitos Bancrios';

  // Acerta Apresentao das TabSheets =========================================
  FrmBancoExtratos.DesabilitaTabSheet(nil);

  // Desabilida Menu de Conciliao ============================================
  FrmBancoExtratos.VisivelMenusConciliacoes(False);

  FrmBancoExtratos.Pan_Opcoes.Visible:=False;
  FrmBancoExtratos.Pan_Concilicao.Visible:=False;

  FrmBancoExtratos.PC_ConcConciliar.TabIndex:=0;

  FrmBancoExtratos.Pan_ConcLoja.Visible:=False;
  FrmBancoExtratos.sgCodUsuario:=Cod_Usuario;

  // Executa Permisses de Menu ================================================
  BloqueioMenu(FrmBancoExtratos, DMBelShop.CDS_Seguranca, DMBelShop.SDS_Busca, Des_Login, bgInd_Admin);

  FrmBancoExtratos.Ts_ConciliacoesManutDepositos.TabVisible:=True;
  FrmBancoExtratos.ShowModal;
end;

End.
// 42296 - Record
// 45983 - 05/08/2015 +
// 44887 - 06/08/2015 -
// 44967 - 11/09/2015 +
// 44994 - 12/09/2015 +
// 44943 - 23/09/2015 -
// 45483 - 23/05/2016
// 45100 = 11/08/2016
// unit cxSchedulerCustomControls;




{

- Novas Tabelas
  - FIN_PAGTOS_MOVTOS
  - FIN_PAGTOS_SALDO
  - SIDICOM_AJUSTES

-----------------------------------
- Boto Sair do Sistema = SBt_Sair
-----------------------------------

LojaBel_17 - Altera para Loja 17 para Loja 09

CorTelaForm:
  - EndColor = $00737373
  - StartColor = $00FFFF80

CorCaptionForm:
  - EndColor = $00008C00
  - FonrInactiveColor = $00FFFFD2
  - StartColor = $00FFFF80

 Form.ClientHeigth = 564
 Form.ClientWidth  = 979
 Cor Componente Disabilitado = $00E0E0E0
}

